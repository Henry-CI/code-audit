# Audit Pass 2 — Agent A38
**Audit run:** 2026-02-26-01
**Agent:** A38
**Files assigned:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/results/JoinCompanyResult.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/results/LoginResultArray.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/results/ManufactureResultArray.java`

---

## Project-Wide Finding

### A38-1 — Zero automated test coverage across app/ and LibCommon/ modules [HIGH]

The `app/` module and `LibCommon/` module contain no `test/` or `androidTest/` directories. A glob across the entire repository for `**/test/**/*.java` returns only two files, both residing in the third-party `LibImageloader` library module. No JUnit, Espresso, Mockito, or any other test framework artefact exists for any production code in the main application modules.

All three files assigned to this agent are therefore entirely untested. Every finding below is a direct consequence of this project-wide absence of test coverage.

**Impact:** Regressions in any production code path — including authentication — are undetectable by automated means. Any refactor or API change can silently break the login flow, company join flow, or manufacturer list without any safety net.

---

## File 1 — JoinCompanyResult.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.results.JoinCompanyResult`

**Superclass chain:**
`JoinCompanyResult` → `WebServiceResultPacket` → `WebServicePacket` → (implements `Serializable`)

**Fields defined (lines 14–15):**
| Line | Field | Type |
|------|-------|------|
| 14 | `driver_id` | `public int` |
| 15 | `comp_id` | `public int` |

**Methods defined:**
| Line | Signature |
|------|-----------|
| 17 | `public JoinCompanyResult()` — default no-arg constructor |
| 20 | `public JoinCompanyResult(JSONObject jsonObject) throws JSONException` — JSON-parsing constructor |

**Parse logic (lines 20–37):**
- Delegates to `super(jsonObject)` (WebServiceResultPacket → WebServicePacket, both no-ops).
- Guards outer `jsonObject != null`.
- Conditionally reads `"driver_id"` if not JSON-null (line 27–30).
- Conditionally reads `"comp_id"` if not JSON-null (line 32–35).
- Both fields are primitive `int`; they default to `0` if the JSON key is absent or null.

---

### Findings for JoinCompanyResult.java

#### A38-2 — No test file for JoinCompanyResult [LOW]

There is no test class for `JoinCompanyResult`. The class is a simple two-field DTO but its parsing constructor exercises real JSON parsing logic.

**Untested methods:**
- `JoinCompanyResult(JSONObject)` — JSON-parsing constructor

**Untested paths:**
- `jsonObject` is `null` → both fields stay at primitive default `0`; caller cannot distinguish this from a valid server response of `{driver_id:0, comp_id:0}`.
- `"driver_id"` key is absent from the JSON object entirely (as opposed to being present with a JSON-null value) — `isNull()` returns `true` for a missing key on Android's `org.json`, so the field silently stays `0`, which is also valid. This ambiguity is untested.
- `"comp_id"` key is absent — same silent-zero ambiguity.
- Malformed value type (e.g., `"driver_id"` is a string) → `JSONException` propagates to caller; no test verifies the caller handles this.

**Severity:** LOW — The class is a simple DTO with no security-sensitive data. The untested silent-zero default for a missing company or driver ID is a correctness concern but low risk in isolation.

---

## File 2 — LoginResultArray.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.results.LoginResultArray`

**Superclass chain:**
`LoginResultArray` → `WebServiceResultPacket` → `WebServicePacket` → (implements `Serializable`)

**Fields defined (line 14):**
| Line | Field | Type |
|------|-------|------|
| 14 | `arrayList` | `public ArrayList<LoginItem>` |

**Methods defined:**
| Line | Signature |
|------|-----------|
| 16 | `public LoginResultArray()` — default no-arg constructor |
| 19 | `public LoginResultArray(JSONArray jsonArray) throws JSONException` — JSON-parsing constructor |

**Parse logic (lines 19–30):**
- Initialises `arrayList` to a new empty `ArrayList` unconditionally (line 22).
- Guards `jsonArray != null`.
- Iterates array elements, constructing a `LoginItem` from each `JSONObject` (lines 25–28).
- Each `LoginItem` constructed from `jsonArray.getJSONObject(i)` — will throw `JSONException` if the element at position `i` is not a JSON object (e.g., it is a primitive or null entry in the array).

**`LoginItem` fields (from `LoginItem.java` lines 14–33):**
`id`, `comp_id`, `first_name`, `last_name`, `email`, `password`, `phone`, `licno`, `expirydt`, `addr`, `securityno`, `photo_url`, `contactperson`, `date_format`, `max_session_length`, `compliance_date`, `gps_frequency`, plus nested `drivers` list and `arrDriverTrainings` list.

**Production usage (from `CurrentUser.java` lines 85–111):**
`LoginResultArray` is the direct return type of the login API call. The caller treats a non-empty `arrayList` as a successful authentication, takes `arrayList.get(0)` as the authenticated user, and stores their session. A null or empty list is treated as incorrect credentials.

---

### Findings for LoginResultArray.java

#### A38-3 — No test for successful login response parsing [HIGH]

There is no test that constructs a `LoginResultArray` from a well-formed JSON array representing a valid server login response. `LoginResultArray` is the direct carrier of authenticated user data (including `password`, `securityno`, `licno`). The absence of a success-path test means a regression in field mapping (e.g., a key rename by the backend) would not be caught before reaching production users.

**Untested path:** `LoginResultArray(JSONArray)` with a valid single-element or multi-element array containing all expected `LoginItem` fields.

**Severity:** HIGH — Authentication credential parsing is untested. A silent parse failure (wrong field mapped, field silently set to `0` or `null`) would cause login to succeed at the network level while producing a corrupt user session, or cause the empty-list path to fire, locking out legitimate users.

#### A38-4 — No test for empty array login response [HIGH]

The production caller (`CurrentUser.login`) treats an empty `arrayList` as failed authentication (line 88–93 of `CurrentUser.java`). The `LoginResultArray` constructor initialises `arrayList` to an empty list and then conditionally populates it. No test verifies that an empty JSON array `[]` produces an empty `arrayList` and that a `null` JSON array argument also produces an empty (not null) `arrayList`.

**Untested paths:**
- `new LoginResultArray(new JSONArray("[]"))` → `arrayList` should be non-null and empty.
- `new LoginResultArray(null)` → `arrayList` should be non-null and empty (default constructor path is also uncovered).

**Severity:** HIGH — Incorrect handling of an empty or null array during login could produce a `NullPointerException` at the caller (`result.arrayList.size()`) or silently allow/deny authentication incorrectly.

#### A38-5 — No test for failed login response (null token / missing credential fields) [HIGH]

The server may return a login response where optional credential fields are absent or null. `LoginItem` uses `JSONObjectParser`, which silently converts null/absent string fields to Java `null` and null/absent int fields to `0`. No test verifies that:
- A `LoginItem` with a null `password` field does not produce downstream NPEs when the session stores it.
- A `LoginItem` with `id = 0` (field absent) is correctly identified as invalid by the application.
- A `LoginItem` with null `securityno` or `licno` does not break security checks elsewhere.

**Severity:** HIGH — Null credential fields arriving from the server are parsed silently and stored in the user session without validation. No test guards against this being misinterpreted as a valid authenticated session.

#### A38-6 — No test for malformed array element in login response [MEDIUM]

In `LoginResultArray(JSONArray)` at line 26, `jsonArray.getJSONObject(i)` is called without first checking that the element at index `i` is actually a `JSONObject`. If the server returns a mixed array or a null element in the array, a `JSONException` is thrown and propagates to the caller. The `onFailed` handler in `CurrentUser.login` is designed for network failures, not parse exceptions, and the `JSONException` is not caught there. No test verifies the parse-error propagation path.

**Untested path:** `jsonArray` contains a null element or a non-object element (e.g., `[null]` or `[42]`).

**Severity:** MEDIUM — A malformed server response or a network-layer injection that produces a non-object array element would cause an uncaught `JSONException`, resulting in a crash rather than a graceful login failure.

#### A38-7 — No test for multi-element login array response [MEDIUM]

The production code at `CurrentUser.java` line 89 takes only `arrayList.get(0)`, ignoring any additional elements. No test verifies that a multi-element response:
- Does not throw during construction (all elements are parsed).
- Produces a correctly sized `arrayList`.
- Does not trigger unexpected side effects if later code iterates the full list.

**Untested path:** `LoginResultArray(JSONArray)` with a JSON array containing two or more `LoginItem` objects.

**Severity:** MEDIUM — If the server begins returning multiple login items (e.g., for multi-account scenarios), the silent discard of all but the first element is unverified behaviour.

#### A38-8 — `contactperson`-gated `drivers` list has no test coverage [MEDIUM]

`LoginItem` (line 69–76) conditionally populates a recursive `List<LoginItem> drivers` only when `contactperson == true`. This conditional recursive parse path is exercised during `LoginResultArray` construction and is entirely untested. A regression in the `drivers` array parsing (e.g., null driver entry, missing `id` field) would not be detected until a contact-person user logs in at runtime.

**Untested paths:**
- `LoginItem` constructed with `contactperson = true` and a non-empty `drivers` JSON array.
- `LoginItem` constructed with `contactperson = true` and an empty or absent `drivers` JSON array.
- `LoginItem` constructed with `contactperson = false` — `drivers` list should remain empty.

**Severity:** MEDIUM — A contact-person user login with a malformed nested `drivers` array would cause a runtime `JSONException` with no automated detection.

#### A38-9 — No test for `arrDriverTrainings` parse path [LOW]

`LoginItem` (lines 60–67) conditionally parses `arrDriverTrainings` from a nested JSON array. No test covers this path. The `TrainingItem` constructor is also untested. A missing or malformed training entry would propagate a `JSONException` to the login response handler.

**Severity:** LOW — The `arrDriverTrainings` field appears supplementary. A parse failure here would manifest as a login crash for users with training records, which, while serious in production, is a correctness rather than security finding.

---

## File 3 — ManufactureResultArray.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.results.ManufactureResultArray`

**Superclass chain:**
`ManufactureResultArray` → `WebServiceResultPacket` → `WebServicePacket` → (implements `Serializable`)

**Fields defined (line 14):**
| Line | Field | Type |
|------|-------|------|
| 14 | `arrayList` | `public ArrayList<ManufactureItem>` |

**Methods defined:**
| Line | Signature |
|------|-----------|
| 17 | `public ManufactureResultArray()` — default no-arg constructor |
| 19 | `public ManufactureResultArray(JSONArray jsonArray) throws JSONException` — JSON-parsing constructor |

**Parse logic (lines 19–30) — structural duplicate of LoginResultArray:**
- Initialises `arrayList` to a new empty `ArrayList` unconditionally (line 22).
- Guards `jsonArray != null`.
- Iterates array elements, constructing a `ManufactureItem` from each `JSONObject` (lines 25–28).
- `ManufactureItem` reads `"id"` (int) and `"name"` (String), each guarded by `isNull()`.

---

### Findings for ManufactureResultArray.java

#### A38-10 — No test file for ManufactureResultArray [LOW]

There is no test class for `ManufactureResultArray`. The class is a collection DTO whose parsing constructor exercises real JSON logic.

**Untested methods:**
- `ManufactureResultArray(JSONArray)` — JSON-parsing constructor

**Untested paths:**
- `null` argument → `arrayList` is initialised but the loop body never executes; no test confirms the returned object is safe to use.
- Empty JSON array `[]` → `arrayList` should be non-null and empty.
- Valid array with one or more `ManufactureItem` objects — basic success path entirely untested.
- Array element is not a `JSONObject` (e.g., a primitive) → `JSONException` thrown without a test confirming the caller handles this.
- `ManufactureItem` with `"id"` absent → field silently defaults to `0`; no test guards the caller against interpreting a zero ID as a valid manufacturer.
- `ManufactureItem` with `"name"` absent → field silently defaults to `null`; no test confirms the UI layer handles a null manufacturer name without an NPE.

**Severity:** LOW — Manufacturer list data is non-sensitive and the failure mode is a UI display error rather than an authentication bypass. However, an NPE from a null `name` field in the list adapter would crash the equipment-add screen.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A38-1 | HIGH | Project-wide | Zero automated test coverage in app/ and LibCommon/ modules |
| A38-2 | LOW | JoinCompanyResult.java | No test for JSON-parsing constructor; silent-zero default for missing driver_id/comp_id |
| A38-3 | HIGH | LoginResultArray.java | No test for successful login response parsing (credential field mapping) |
| A38-4 | HIGH | LoginResultArray.java | No test for empty or null JSON array login response |
| A38-5 | HIGH | LoginResultArray.java | No test for null/missing credential fields in LoginItem (password, securityno, id) |
| A38-6 | MEDIUM | LoginResultArray.java | No test for malformed/non-object array element causing uncaught JSONException |
| A38-7 | MEDIUM | LoginResultArray.java | No test for multi-element login response; silent discard of all-but-first item |
| A38-8 | MEDIUM | LoginResultArray.java | No test for contactperson-gated recursive drivers list parse path |
| A38-9 | LOW | LoginResultArray.java | No test for arrDriverTrainings conditional parse path |
| A38-10 | LOW | ManufactureResultArray.java | No test for JSON-parsing constructor; null name and zero-id silent defaults |
