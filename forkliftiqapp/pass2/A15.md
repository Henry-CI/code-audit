# Audit Pass 2 – Test Coverage
## Agent: A15
## Files Assigned:
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/BLE/ShockEventsItem.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/DriverStatsItem.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/FakeX509TrustManager.java`

---

## Project-Wide Finding: Zero Automated Test Coverage

**Finding ID:** A15-0
**Severity:** HIGH
**Scope:** Project-wide (`app/` and `LibCommon/` modules)

The `app/` module and the `LibCommon/` module contain no test directories whatsoever. No `src/test/`, `src/androidTest/`, or any equivalent structure exists under either module root. The only test files found in the entire repository are two tests inside the third-party `LibImageloader/` module, which cover image loader internals and provide no coverage for any application code.

This means:
- Every class in `app/src/main/java/` is completely untested.
- Every class in `LibCommon/src/main/java/` is completely untested.
- No regression safety net exists for any business logic, data parsing, network handling, or security-sensitive code.
- Defects introduced by any future change, refactor, or dependency update will not be caught automatically.

All file-specific findings below are consequences of this project-wide gap. Even if tests are added later, the absence of any testing infrastructure means there is currently no process to verify correctness or detect regressions.

---

## File 1: ShockEventsItem.java

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.WebService.BLE.ShockEventsItem`

**Methods:**

| Line | Signature |
|------|-----------|
| 13 | `void calculateImpactLevel(int threshold)` |
| 19 | `public double gForce()` |

**Constants / Types:**

| Element | Kind | Value / Description |
|---------|------|---------------------|
| `GFORCE_COEFFICIENT` | `private static final double` | `0.00388` |
| `mac_address` | `public String` field | MAC address of the BLE device |
| `time` | `public Date` field | Timestamp of the event |
| `magnitude` | `long` (package-private) field | Raw magnitude reading |
| `level` | `public ImpactLevel` field | Computed impact level |
| `ImpactLevel` | `public enum` | Values: `RED`, `AMBER`, `BLUE` |

**Enum `ImpactLevel` values:** `RED`, `AMBER`, `BLUE`

**No corresponding test file found.** A search across the repository for `ShockEventsItem` found only production code references (BLE parsing and display logic). No test exercises any method of this class.

---

### Findings for ShockEventsItem.java

---

**A15-1**
**Severity:** LOW
**Method:** `calculateImpactLevel(int threshold)` (line 13)
**Finding:** No test exercises this method. The threshold-bucketing logic uses multipliers of 5 and 10 on the `threshold` parameter to assign `AMBER` versus `RED` versus `BLUE` levels. There is no test verifying:
- That `magnitude == threshold * 10` produces `AMBER` (not `RED`), confirming the boundary is exclusive, not inclusive.
- That `magnitude == threshold * 10 + 1` produces `RED`.
- That `magnitude == threshold * 5` produces `BLUE` (not `AMBER`).
- That `magnitude == 0` or `magnitude < 0` (negative magnitudes from corrupted sensor data) produce the expected level.
- That `threshold == 0` does not cause division-by-zero or unintended branching (with `magnitude == 0`, both `0 > 0` comparisons are false, yielding `BLUE` — this may or may not be intentional).

The off-by-one boundary behaviour between `AMBER` and `BLUE` at `threshold * 5` and between `AMBER` and `RED` at `threshold * 10` is entirely unverified.

---

**A15-2**
**Severity:** LOW
**Method:** `gForce()` (line 19)
**Finding:** No test exercises this method. `gForce()` returns `GFORCE_COEFFICIENT * Math.sqrt(magnitude)`. There is no test verifying:
- That `magnitude == 0` returns `0.0` (valid edge case for a stationary reading).
- That a known `magnitude` value produces the expected g-force within acceptable floating-point tolerance, confirming the coefficient `0.00388` is correct.
- That a negative `magnitude` (possible if the field is set from a malformed BLE packet before `calculateImpactLevel` validates it) does not silently return `NaN` via `Math.sqrt()` of a negative number. `Math.sqrt(-1)` returns `Double.NaN` in Java; this would propagate silently into any display or comparison downstream.

---

**A15-3**
**Severity:** INFO
**Field:** `magnitude` (line 10, package-private)
**Finding:** The `magnitude` field has package-private (default) visibility. It is written directly by BLE parsing code in the same package and then read by `calculateImpactLevel` and `gForce()`. No test verifies the contract between the setter side (BLE parsing) and the consumer side (these two methods). If the field is ever made private or access changes, the coupling will silently break. A test at the class boundary would document the expected input range.

---

## File 2: DriverStatsItem.java

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.WebService.DriverStatsItem`

**Implements:** `java.io.Serializable`

**Methods:**

| Line | Signature |
|------|-----------|
| 14 | `public DriverStatsItem()` (no-arg constructor) |
| 17 | `public DriverStatsItem(JSONObject jsonObject) throws JSONException` |

**Fields:**

| Name | Type | Visibility |
|------|------|------------|
| `field` | `String` | `public` |
| `object` | `String` | `public` |
| `value` | `String` | `public` |

**Constants / Types:** None beyond the class-level `serialVersionUID` (absent — no explicit `serialVersionUID` is declared despite implementing `Serializable`).

**No corresponding test file found.** A search across the repository for `DriverStatsItem` found only production code references (API response parsing and adapter binding). No test exercises any constructor or field of this class.

---

### Findings for DriverStatsItem.java

---

**A15-4**
**Severity:** LOW
**Method:** `DriverStatsItem(JSONObject jsonObject)` (line 17) — null JSON object path
**Finding:** When `jsonObject` is `null`, the constructor silently returns with all three fields (`field`, `object`, `value`) left as `null`. There is no test verifying that a null-JSON-constructed item behaves predictably when subsequently used by callers. Downstream code consuming a `DriverStatsItem` with all-null fields could throw a `NullPointerException` or display empty/broken UI without any error surfacing.

---

**A15-5**
**Severity:** LOW
**Method:** `DriverStatsItem(JSONObject jsonObject)` (line 17) — partial JSON (missing keys)
**Finding:** Each of the three JSON keys (`"field"`, `"object"`, `"value"`) is guarded by `isNull()`, which means the corresponding Java field is left as `null` if the key is absent from the JSON. There is no test verifying:
- That a JSON object containing only `"field"` leaves `object` and `value` as `null`.
- That a completely empty `JSONObject` (`{}`) leaves all three fields as `null`.
- That callers handle partially-populated items correctly.

---

**A15-6**
**Severity:** LOW
**Method:** `DriverStatsItem(JSONObject jsonObject)` (line 17) — JSONException propagation
**Finding:** The constructor declares `throws JSONException`. If `jsonObject.getString()` throws (e.g., for a type mismatch where a key exists but holds a non-string value), the exception propagates to the caller. There is no test verifying:
- That the exception is thrown, caught, and handled correctly by the caller.
- That a partial parse does not leave the object in an inconsistent half-initialized state that is then silently used.

---

**A15-7**
**Severity:** INFO
**Class-level:** `DriverStatsItem implements Serializable`
**Finding:** The class implements `Serializable` but declares no `serialVersionUID`. Java will auto-generate one based on the class structure at compile time. Any change to the class (add/remove/rename a field or method) will silently change the auto-generated UID, breaking deserialization of any previously serialized `DriverStatsItem` (e.g., from `Bundle` extras, `Intent` extras, or persisted state). There is no test verifying round-trip serialization/deserialization produces an equal object.

---

## File 3: FakeX509TrustManager.java

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.WebService.FakeX509TrustManager`

**Implements:** `javax.net.ssl.X509TrustManager`

**Methods:**

| Line | Signature |
|------|-----------|
| 26 | `public void checkClientTrusted(X509Certificate[] x509Certificates, String s) throws CertificateException` (override) |
| 31 | `public void checkServerTrusted(X509Certificate[] x509Certificates, String s) throws CertificateException` (override) |
| 35 | `public boolean isClientTrusted(X509Certificate[] chain)` |
| 39 | `public boolean isServerTrusted(X509Certificate[] chain)` |
| 44 | `public X509Certificate[] getAcceptedIssuers()` (override) |
| 48 | `public static SSLContext getUnsafeSSLContext()` |
| 67 | `public static void allowAllSSL()` |

**Constants / Fields:**

| Element | Kind | Value / Description |
|---------|------|---------------------|
| `trustManagers` | `private static TrustManager[]` | Lazily initialized singleton array holding one `FakeX509TrustManager` instance |
| `_AcceptedIssuers` | `private static final X509Certificate[]` | Empty array `{}` — signals to the SSL engine that no issuers are accepted/trusted |

**No corresponding test file found.** The class is referenced in three production call sites:
- `HttpClient.addRequest()` (line 122) — calls `allowAllSSL()` on every outbound HTTP request.
- `OkHttpClientFactory.getOkHttpClient()` (lines 16–17) — installs `FakeX509TrustManager` as the `sslSocketFactory` trust manager and sets an always-true hostname verifier.
- `TokenAuthenticator.getAccessToken()` (line 39) — calls `allowAllSSL()` before each token refresh request.

---

### Findings for FakeX509TrustManager.java

---

**A15-8**
**Severity:** CRITICAL
**Method:** `checkServerTrusted(X509Certificate[], String)` (line 31)
**Finding:** The `checkServerTrusted` override is completely empty — it contains only a comment left from IDE boilerplate and performs no certificate validation whatsoever. The `X509TrustManager` contract requires this method to throw `CertificateException` if the server's certificate chain is untrusted. By leaving the body empty, the implementation unconditionally accepts every server certificate, including self-signed certificates, expired certificates, certificates issued by unknown or malicious CAs, and certificates for entirely different domains.

There is no test verifying that this method is never installed on production network connections, no test that a valid certificate is required before a network call succeeds, and no test that a connection to a server presenting an invalid certificate is rejected. The method is confirmed to be installed on all production HTTP traffic via `HttpClient`, `OkHttpClientFactory`, and `TokenAuthenticator` (see call-site evidence above). An attacker positioned on the network (e.g., on the same Wi-Fi segment as a forklift operator) can present any certificate and perform a full man-in-the-middle attack, intercepting or tampering with all API traffic including authentication tokens.

---

**A15-9**
**Severity:** CRITICAL
**Method:** `checkClientTrusted(X509Certificate[], String)` (line 26)
**Finding:** The `checkClientTrusted` override is also completely empty. While client certificate validation is less commonly the attack surface than server validation, the empty body means any client certificate presented during mutual TLS is unconditionally accepted without inspection. There is no test verifying the expected behavior of this method, no test verifying it is not called in unexpected contexts, and no test verifying that mutual TLS (if ever configured) would actually validate client identity.

---

**A15-10**
**Severity:** CRITICAL
**Method:** `allowAllSSL()` (line 67)
**Finding:** `allowAllSSL()` sets two JVM-wide global defaults via `HttpsURLConnection.setDefaultHostnameVerifier()` and `HttpsURLConnection.setDefaultSSLSocketFactory()`. The installed hostname verifier always returns `true` for any hostname, and the installed socket factory uses the trust-nothing `FakeX509TrustManager`. These defaults are process-global and affect every subsequent `HttpsURLConnection` opened anywhere in the application, not just the call site.

This method is called unconditionally on every HTTP request dispatched through `HttpClient.addRequest()` and on every token refresh in `TokenAuthenticator.getAccessToken()` — meaning SSL validation is disabled globally for the lifetime of the application process. There is no test verifying:
- That `allowAllSSL()` is not called in production builds.
- That the process-wide defaults are not set when a production `BuildConfig` is active.
- That connection to a server with an invalid hostname is rejected.
- That any clean-up or restoration of safe defaults ever occurs after `allowAllSSL()` is called.

The combination of an always-true hostname verifier and an always-accepting trust manager applied globally to `HttpsURLConnection` makes every HTTPS connection in the app equivalent to unencrypted HTTP from a security perspective.

---

**A15-11**
**Severity:** CRITICAL
**Method:** `getUnsafeSSLContext()` (line 48)
**Finding:** `getUnsafeSSLContext()` constructs and returns a `TLS` `SSLContext` initialized with a singleton `FakeX509TrustManager[]` as the sole trust manager. This context is used directly by `OkHttpClientFactory` to configure the OkHttpClient used for all Retrofit/OkHttp API calls. The method name explicitly advertises it is unsafe, yet it is unconditionally installed in production.

There is no test verifying:
- That `getUnsafeSSLContext()` is gated by a debug or test flag and is never reachable in a production build.
- That the returned context is not installed as the socket factory on any connection that carries credentials or sensitive data.
- That the static `trustManagers` field is not permanently poisoned for the process lifetime after a single call (it is, due to the `if (trustManagers == null)` lazy-init with no reset path).

Additionally, `NoSuchAlgorithmException` and `KeyManagementException` are caught, printed via `e.printStackTrace()`, and silently swallowed, causing the method to return `null`. The caller in `allowAllSSL()` at line 77 calls `.getSocketFactory()` on the returned value without a null check, which would produce a `NullPointerException` in the unlikely event TLS is unavailable on the device. There is no test verifying this error path.

---

**A15-12**
**Severity:** LOW
**Methods:** `isClientTrusted(X509Certificate[])` (line 35) and `isServerTrusted(X509Certificate[])` (line 39)
**Finding:** These methods unconditionally return `true` and are not part of the `X509TrustManager` interface contract (they are holdovers from an older `com.sun.net.ssl.TrustManager` API). They are effectively dead code in a modern Android runtime but are present and public, adding to the misleading surface area of this class. There is no test documenting their behavior or verifying they are not accidentally invoked.

---

**A15-13**
**Severity:** INFO
**Class:** `FakeX509TrustManager`
**Finding:** The class name explicitly flags itself as fake/unsafe (created 7 June 2017 per the class comment). This is a development/debug aid that was never removed or gated behind a `BuildConfig.DEBUG` check before shipping. A test (or a lint rule enforced by a test) that asserts `FakeX509TrustManager` is not referenced from any non-test source path in a production build would catch accidental inclusion. No such gate exists.

---

## Summary Table

| ID | Severity | File | Subject |
|----|----------|------|---------|
| A15-0 | HIGH | Project-wide | No test directories exist in `app/` or `LibCommon/`; zero automated test coverage |
| A15-1 | LOW | ShockEventsItem.java | `calculateImpactLevel()` untested; boundary conditions at `threshold*5` and `threshold*10` unverified |
| A15-2 | LOW | ShockEventsItem.java | `gForce()` untested; `Math.sqrt(negative)` returns `NaN` silently; coefficient unverified |
| A15-3 | INFO | ShockEventsItem.java | Package-private `magnitude` field coupling unverified by any test |
| A15-4 | LOW | DriverStatsItem.java | Null `JSONObject` constructor path leaves all fields null; callers unverified |
| A15-5 | LOW | DriverStatsItem.java | Partial JSON leaves subset of fields null; no test verifies downstream handling |
| A15-6 | LOW | DriverStatsItem.java | `JSONException` propagation from constructor not tested; half-initialized object risk |
| A15-7 | INFO | DriverStatsItem.java | No explicit `serialVersionUID`; serialization round-trip untested |
| A15-8 | CRITICAL | FakeX509TrustManager.java | `checkServerTrusted()` is empty; installed on all production connections; enables MITM |
| A15-9 | CRITICAL | FakeX509TrustManager.java | `checkClientTrusted()` is empty; any client certificate unconditionally accepted |
| A15-10 | CRITICAL | FakeX509TrustManager.java | `allowAllSSL()` sets process-wide always-true hostname verifier and trust manager on every request |
| A15-11 | CRITICAL | FakeX509TrustManager.java | `getUnsafeSSLContext()` installed on all OkHttp traffic; null-return error path unchecked |
| A15-12 | LOW | FakeX509TrustManager.java | `isClientTrusted()`/`isServerTrusted()` always return `true`; dead code, no test documents intent |
| A15-13 | INFO | FakeX509TrustManager.java | No `BuildConfig.DEBUG` gate prevents `FakeX509TrustManager` from shipping in production builds |
