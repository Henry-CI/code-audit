# Audit Pass 2 — Agent A33
**Audit run:** 2026-02-26-01
**Agent:** A33
**Files assigned:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/parameters/SaveShockEventParameter.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/parameters/SaveSingleGPSParameter.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/parameters/SessionEndParameter.java`

---

## Project-Wide Finding

### A33-1 — HIGH — Zero automated test coverage across app/ and LibCommon/ modules

Neither the `app/` module nor the `LibCommon/` module contains a `test/` or `androidTest/` directory. No JUnit, Espresso, or Robolectric test suite exists for any production code in those modules. The only test directories found in the entire repository are in third-party library modules (`LibImageloader/src/test`, `LibImagePicker/src/androidTest`, `LibPercentProgress/src/androidTest`) which are external dependencies, not application code.

This means every class examined in this audit — including safety-critical shock event handling and GPS coordinate transmission — has zero automated test coverage. All findings below are therefore gaps in a completely untested codebase.

**Evidence:**
```
find result: no test/ or androidTest/ directory under app/src/ or LibCommon/src/
```

---

## File 1: SaveShockEventParameter.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.parameters.SaveShockEventParameter`

**Supertype chain:**
`SaveShockEventParameter` → `WebServiceParameterPacket` → `WebServicePacket` (implements `Serializable`)

**Fields defined:**
| Field | Type | Line | Access |
|---|---|---|---|
| `impactList` | `ArrayList<SaveShockEventItem>` | 11 | `public` |

**Methods defined:**
| Method | Line | Signature |
|---|---|---|
| Constructor (default) | 13 | `public SaveShockEventParameter()` |

**Constants defined:** none

**Inherited fields of note (from `SaveShockEventItem`, the element type):**
- `impact_time` — `String`
- `impact_value` — `long` (raw magnitude from BLE sensor, no unit defined, stored as-is)
- `mac_address` — `String`

---

### Findings

#### A33-2 — HIGH — No test file exists for SaveShockEventParameter

There is no test file for this class anywhere in the repository. A comprehensive search for any test referencing `SaveShockEventParameter` across the codebase found zero results.

This class is the payload used to transmit shock/impact events to the backend server via `WebApi.saveShockEvent()`. It is populated by `ShockEventService` from BLE sensor readings and directly drives fleet safety alerting logic. Untested serialization or list-population behaviour in this class could silently drop or corrupt impact records.

---

#### A33-3 — HIGH — No test for impact_value boundary conditions or unit validation

`SaveShockEventItem.impact_value` (type `long`) is the raw magnitude from the BLE sensor. It is read from a 4-byte `UINT32` BLE characteristic with no upper-bound clamping, no minimum threshold, and no unit annotation. The field is placed directly into `SaveShockEventParameter.impactList` and transmitted to the server.

In `ShockEventService.saveShockEvent()` (line 118-122):
```java
Integer mm = BleUtil.getIntValue(data, BluetoothGattCharacteristic.FORMAT_UINT32, 4);
long magnitude = mm != null ? mm : 0;
```

There is no test covering:
- `magnitude == 0` (null BLE read, substituted silently to zero — a zero-g event that may incorrectly trigger or suppress alerts)
- `magnitude == Long.MAX_VALUE` or maximum `UINT32` value (`4294967295`) — sensor noise or malfunction producing an astronomically large g-force value that will be stored and uploaded as a legitimate shock event
- Negative coercion: `Integer mm` is signed; a BLE value with bit 31 set will yield a negative `Integer` that, when assigned to `long magnitude`, becomes a large negative value after sign extension is implicit in the `mm != null ? mm : 0` ternary (auto-widening from `int` to `long` preserves sign)

The threshold comparison in `showShockAlertIfNeeded()` (line 156):
```java
shockEventsItem.magnitude <= equipmentItem.impact_threshold
```
This means a negative magnitude (from a sign-extended BLE value) will always be `<=` any positive threshold, so the alert is silently suppressed. This is a safety-critical failure mode with no test coverage.

**Severity: HIGH** — the consequence is missed impact alerts on safety-critical forklift equipment.

---

#### A33-4 — HIGH — No test for empty impactList serialisation to server

`SaveShockEventParameter` is instantiated and populated in `ShockEventService.uploadEvent()`. If `ShockEventsDb.readData()` returns results but all `SaveShockEventItem` constructions fail silently (e.g. corrupt Realm data), an empty `impactList` is sent to the server. There is no test verifying server-side behaviour or local cleanup when the list is empty, nor any guard in `SaveShockEventParameter` itself.

---

#### A33-5 — MEDIUM — No test for null mac_address in SaveShockEventItem constructor

`SaveShockEventItem(ShockEventsDb event)` (line 20-24 of `SaveShockEventItem.java`) assigns `this.mac_address = event.mac_address` without null-checking. If a `ShockEventsDb` Realm record has a null `mac_address`, the field is stored as `null` in the parameter object. The impact list removal path in `ShockEventsDb.removeData()` then calls:
```java
getMatchingEvents(realm, ..., item.mac_address)
```
which issues a Realm query with a null parameter — untested behaviour.

---

## File 2: SaveSingleGPSParameter.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.parameters.SaveSingleGPSParameter`

**Supertype chain:**
`SaveSingleGPSParameter` → `WebServiceParameterPacket` → `WebServicePacket` (implements `Serializable`)

**Fields defined:**
| Field | Type | Line | Access |
|---|---|---|---|
| `unit_id` | `int` | 9 | `public` |
| `longitude` | `Double` (boxed) | 10 | `public` |
| `latitude` | `Double` (boxed) | 11 | `public` |
| `gps_time` | `String` | 12 | `public` |

**Methods defined:**
| Method | Line | Signature |
|---|---|---|
| Constructor (default) | 14 | `public SaveSingleGPSParameter()` |

**Constants defined:** none

---

### Findings

#### A33-6 — HIGH — No test file exists for SaveSingleGPSParameter

There is no test file for this class anywhere in the repository. A comprehensive search for any test referencing `SaveSingleGPSParameter` found zero results. This class is used by `LocationDb.saveNewLocation()`, `LocationDb.removeData()`, `FleetActivity`, `MyApplication`, and `WebApi.saveSingleGPSLocation()`.

---

#### A33-7 — MEDIUM — No test for invalid coordinate ranges (lat > 90, lon > 180)

`latitude` and `longitude` are raw `Double` fields with no range validation anywhere in the call chain. The class itself performs no validation; neither does `LocationDb.saveNewLocation()` (which copies the values directly into a Realm record and transmits them). The `WebApi.saveSingleGPSLocation()` call sends them directly to the server.

There is no test verifying that:
- `latitude > 90` or `latitude < -90` is rejected or flagged
- `longitude > 180` or `longitude < -180` is rejected or flagged
- `latitude == 90.0` and `latitude == -90.0` (boundary values) are handled correctly
- `latitude == 0.0` and `longitude == 0.0` (Null Island — a common default when GPS is unavailable) is not silently stored and uploaded as a valid location

Invalid coordinates would be persisted to the Realm database and submitted to the server, producing corrupt fleet-location records that could misdirect equipment tracking.

---

#### A33-8 — MEDIUM — No test for null latitude/longitude (boxed Double fields)

Both `latitude` and `longitude` are declared as boxed `Double` (not primitive `double`), meaning they can hold `null`. The default constructor initialises nothing, leaving both fields as `null` if the caller forgets to set them. In `LocationDb.saveNewLocation()` (lines 126-127):
```java
dbObject.latitude = saveSingleGPSParameter.latitude;
dbObject.longitude = saveSingleGPSParameter.longitude;
```
A null value is assigned directly to the Realm object's `Double` field. Depending on the Realm schema configuration, this either silently stores null or throws a `NullPointerException` at runtime. Neither path has test coverage.

---

#### A33-9 — MEDIUM — No test for null or zero unit_id

`unit_id` is an `int` defaulting to `0`. In `LocationDb.removeData(SaveSingleGPSParameter)` (line 53):
```java
getMatchingRecord(realm, saveSingleGPSParameter.unit_id)
```
A `unit_id` of `0` would match all Realm records where `unit_id == 0`, potentially deleting GPS records for unrelated units or the entire unassigned pool. There is no test verifying that a zero/invalid `unit_id` is rejected before reaching this deletion path.

---

#### A33-10 — MEDIUM — No test for null or empty gps_time string

`gps_time` is a `String` with no validation. It defaults to `null` from the default constructor. A null `gps_time` stored in Realm and subsequently uploaded to the server has undefined server-side behaviour. There is no test for the null, empty-string, or malformed-timestamp cases.

---

## File 3: SessionEndParameter.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.parameters.SessionEndParameter`

**Supertype chain:**
`SessionEndParameter` → `WebServiceParameterPacket` → `WebServicePacket` (implements `Serializable`)

**Fields defined:**
| Field | Type | Line | Access |
|---|---|---|---|
| `id` | `int` | 10 | `public` |
| `finish_time` | `String` | 11 | `public` |
| `prestart_required` | `boolean` | 12 | `public` |

**Methods defined:**
| Method | Line | Signature |
|---|---|---|
| Default constructor | 14 | `public SessionEndParameter()` |
| Copy constructor from SessionResult | 17 | `public SessionEndParameter(SessionResult result)` |

**Constants defined:** none

---

### Findings

#### A33-11 — HIGH — No test file exists for SessionEndParameter

There is no test file for this class anywhere in the repository. A comprehensive search found zero test references to `SessionEndParameter`. This class is used at six distinct call sites across `FleetActivity`, `DashboardFragment`, `JobsFragment`, `JobsPresenter`, `EquipmentDriverAccessPresenter`, and `SessionTimeouter` — every one of which ends an active forklift operator session.

---

#### A33-12 — HIGH — No test for SessionEndParameter(SessionResult) when result fields are null

The copy constructor (lines 17-21):
```java
public SessionEndParameter(SessionResult result) {
    id = result.id;
    finish_time = result.finish_time;
    prestart_required = result.prestart_required;
}
```
There is no null-guard on `result` itself. If `result` is `null`, the constructor throws `NullPointerException` at line 18. The caller in `SessionTimeouter` (line 58 and line 69) passes `result` directly with no prior null-check at that call site. There is no test verifying the null-result path.

Additionally, `result.finish_time` may be `null` if `SessionResult` was constructed via the no-arg constructor and `end()` or `preEnd()` was never called. A null `finish_time` is then serialised and sent to the server with undefined consequences. There is no test for this path.

---

#### A33-13 — HIGH — No test for session end with id == 0 (default constructor path)

Multiple call sites use the no-arg constructor and then manually assign `parameter.id = sessionResult.id`. If `sessionResult` is null or its `id` is `0` (e.g. an offline session whose server ID was never set), `parameter.id` is `0`. In `WebApi.saveSessionEnd()` (line 308):
```java
SessionDb.setSessionFinished(parameter.id, parameter.finish_time, false);
```
A `parameter.id == 0` passed to `SessionDb.setSessionFinished()` may update the wrong record or silently no-op, leaving the session permanently open in the local database. No test covers the `id == 0` case.

---

#### A33-14 — MEDIUM — No test verifying prestart_required propagation through copy constructor

`prestart_required` controls whether a pre-start safety check is enforced for the next session. The copy constructor copies `result.prestart_required` directly. There is no test verifying that:
- `prestart_required == true` is correctly preserved end-to-end through serialisation and the API call
- `prestart_required == false` is not inadvertently flipped to `true` or vice versa by any serialisation layer

Given that this flag governs a physical safety check on forklift equipment, its correctness is safety-critical, but it has no test coverage.

---

#### A33-15 — LOW — No test for Serializable contract consistency

All three parameter classes implement `Serializable` without declaring a `serialVersionUID`. If the class structure changes (fields added or removed), Java's default `serialVersionUID` computation will change, and any in-flight serialised object (e.g. one stored in an `Intent` extra or a pending retry queue) will throw `InvalidClassException` on deserialisation. There is no test exercising round-trip serialisation for any of these three classes.

---

## Summary Table

| ID | Severity | File | Description |
|---|---|---|---|
| A33-1 | HIGH | Project-wide | Zero automated test coverage in app/ and LibCommon/ modules |
| A33-2 | HIGH | SaveShockEventParameter | No test file exists |
| A33-3 | HIGH | SaveShockEventParameter / SaveShockEventItem | No test for impact_value boundary conditions; negative magnitude from UINT32 sign extension silently suppresses safety alerts |
| A33-4 | HIGH | SaveShockEventParameter | No test for empty impactList transmitted to server |
| A33-5 | MEDIUM | SaveShockEventParameter | No test for null mac_address in SaveShockEventItem constructor |
| A33-6 | HIGH | SaveSingleGPSParameter | No test file exists |
| A33-7 | MEDIUM | SaveSingleGPSParameter | No test for invalid coordinate ranges (lat > 90, lon > 180) or Null Island (0, 0) |
| A33-8 | MEDIUM | SaveSingleGPSParameter | No test for null latitude/longitude (boxed Double, can be null) |
| A33-9 | MEDIUM | SaveSingleGPSParameter | No test for zero/invalid unit_id causing broad Realm record deletion |
| A33-10 | MEDIUM | SaveSingleGPSParameter | No test for null or empty gps_time |
| A33-11 | HIGH | SessionEndParameter | No test file exists |
| A33-12 | HIGH | SessionEndParameter | No test for copy constructor with null SessionResult or null finish_time |
| A33-13 | HIGH | SessionEndParameter | No test for id == 0 in session-end flow |
| A33-14 | MEDIUM | SessionEndParameter | No test verifying prestart_required propagation (safety flag) |
| A33-15 | LOW | All three files | No serialVersionUID declared; no round-trip Serializable test |
