# Audit Pass 2 — Agent A63
**Audit run:** 2026-02-26-01
**Agent:** A63
**Assigned files:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/IncidentPart2Fragment.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/JobsFragment.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/LoginFragment.java`

---

## PROJECT-WIDE FINDING

### A63-1 — HIGH — Zero Automated Test Coverage in `app/` and `LibCommon/` Modules

The `app/` module and `LibCommon/` module contain no test directories at all. Glob searches for `app/src/test/**`, `app/src/androidTest/**`, and `LibCommon/src/test/**` returned zero results. The only test files in the entire repository are confined to third-party library modules (`LibImageloader`, `LibImagePicker`, `LibPercentProgress`) and exercise none of the application's own code.

Every method documented below for the three assigned files, and by extension every method in the entire `app/` module, has zero automated test coverage. All findings below therefore apply against a backdrop of total absence of testing infrastructure. No test runner configuration, no mocking setup, no instrumented test scaffolding, and no unit test scaffolding exists for application code.

**Impact:** Any regression, security issue, or data-integrity defect introduced into production code will not be detected before release. The findings below call out specific high-risk gaps; they are a subset of the broader problem described here.

---

## File 1: IncidentPart2Fragment.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.ui.fragment.IncidentPart2Fragment`

**Superclass:** `au.com.collectiveintelligence.fleetiq360.ui.common.FleetFragment`

**Fields defined:**
| Field | Type | Line |
|---|---|---|
| `location` | `EditText` | 28 |
| `injury` | `ToggleImageButton` | 29 |
| `injury_type` | `TextView` | 30 |
| `witness` | `EditText` | 31 |
| `injury_photo` | `ImageView` | 32 |
| `signature_image` | `ImageView` | 33 |
| `incidentActivity` | `IncidentActivity` | 34 |

**Methods defined (with line numbers and signatures):**

| Line | Signature |
|---|---|
| 38 | `public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)` |
| 43 | `public void initViews()` |
| 91 | `private void initValues()` |
| 101 | `private void choosePhoto()` |
| 126 | `private void updateSignature()` |
| 136 | `private void updatePhoto()` |
| 147 | `public void onRightButton(View view)` |
| 188 | `private void setParameter()` |
| 197 | `private void uploadImages(final int impactId)` |
| 215 | `private void uploadSignature(int impactId)` |
| 239 | `private void close()` |
| 243 | `private void showInjuryTypeDialog()` |
| 260 | `public void onMiddleButton(View view)` |
| 270 | `private void setInjuryType(String type)` |

**Constants/types defined:** None (class relies on constants from `R`, `WebData`, `URLBuilder`).

---

### Findings for IncidentPart2Fragment.java

#### A63-2 — HIGH — No test for photo upload failure leaving incident record in incomplete state

**Location:** `uploadImages()` lines 197–213, `onRightButton()` lines 163–186

When `onRightButton()` is triggered and all pre-conditions are met, the flow is:
1. `WebApi.async().saveImpact()` → on success, `incidentActivity.impactResult` is set (line 174).
2. `uploadImages(result.id)` is called — if the image upload fails (lines 206–210), the user is shown an error dialog offering retry, but `incidentActivity.impactResult` is now non-null and the incident record exists on the server without a photo.
3. If the user dismisses the error dialog without retrying, or the app is killed, the incident record is permanently saved with no photo and no signature. There is no mechanism to detect or remediate this incomplete state on subsequent app launches.

No test exercises the scenario: `saveImpact` succeeds → `uploadImages` fails. Without a test, the partial-save behaviour has never been verified under controlled conditions, the retry path from a fresh `onRightButton()` call after partial failure has not been confirmed to succeed, and there is no assertion that the server record is flagged or that the UI communicates the data-integrity risk clearly.

**Additional gap:** `uploadSignature()` (lines 215–237) has the same incompleteness risk: photo uploaded successfully but signature upload fails. No test covers this second partial-failure case.

#### A63-3 — HIGH — No test for `onRightButton()` when `location` field is empty

**Location:** `onRightButton()` lines 148–151

The guard `if (location.getText().length() == 0)` blocks save when location is blank. No test verifies:
- The toast message is shown and the method returns early.
- The save API is not called.
- Whitespace-only input (e.g., `"   "`) is not blocked — the current guard only checks `.length() == 0`, so a location of `"   "` passes validation and would be saved as the incident location. This is a data-quality defect that a unit test would reveal.

#### A63-4 — MEDIUM — No test for `onRightButton()` when photo or signature is missing

**Location:** `onRightButton()` lines 153–161

Guards exist for missing photo (line 153) and missing signature (line 158). No test verifies:
- Toast is shown and return is taken for the null-photo path.
- Toast is shown and return is taken for the null-signature path.
- The order of guard evaluation (photo checked before signature); if the product requirement changes the priority, there is no test to catch a regression.

#### A63-5 — MEDIUM — No test for `setInjuryType()` with null argument

**Location:** `setInjuryType()` lines 270–276

The null guard at line 271 silently returns when `type` is null. No test verifies this guard fires correctly, nor that calling `setInjuryType(null)` leaves `injury_type` text and `incidentActivity.impactParameter.injury_type` unchanged.

#### A63-6 — MEDIUM — No test for `initValues()` when `impactParameter` fields are null

**Location:** `initValues()` lines 91–99

`location.setText(incidentActivity.impactParameter.location)` and similar calls at lines 92–95 are called with fields that may be null if the incident activity was freshly created. `EditText.setText(null)` on Android throws a `NullPointerException` in some API levels. No test exercises the freshly-initialised state (all fields null).

#### A63-7 — MEDIUM — No test for `uploadImages()` / `uploadSignature()` retry flow when `impactResult` is already set

**Location:** `onRightButton()` lines 163–167

When `incidentActivity.impactResult != null` (i.e., prior partial save succeeded), `onRightButton()` skips `saveImpact` and calls `uploadImages` directly. No test verifies this re-entry path functions correctly after a prior partial failure.

#### A63-8 — LOW — No test for `choosePhoto()` when image picker returns empty list

**Location:** `choosePhoto()` lines 101–124, inner callback lines 113–118

The callback checks `if (items != null && items.size() > 0)` before using the result. The else branch is a silent no-op (no feedback to the user). No test covers user cancellation (empty list returned) to confirm `mCurrentPhotoPath` is not mutated and no crash occurs.

#### A63-9 — LOW — No test for `onMiddleButton()` back-navigation branches

**Location:** `onMiddleButton()` lines 260–268

Two branches exist: finish the activity if `impactResult != null`, or call `onBackPressed()` if not. No test exercises either path, and the `setParameter()` call at line 261 is executed unconditionally before navigation — meaning partial state is written to `incidentActivity.impactParameter` even when navigating back.

#### A63-10 — LOW — No test for `updatePhoto()` and `updateSignature()` null-path visibility toggling

**Location:** `updatePhoto()` lines 136–144, `updateSignature()` lines 126–134

Both methods toggle `setVisibility(VISIBLE/GONE)` based on null checks. No test verifies the ImageView visibility states. If either method inadvertently keeps an image visible after the path is cleared, a stale image would appear, but this would go undetected.

---

## File 2: JobsFragment.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.ui.fragment.JobsFragment`

**Superclass:** `au.com.collectiveintelligence.fleetiq360.ui.common.FleetFragment`

**Interfaces implemented:** `AbsRecyclerAdapter.OnItemClickListener`, `View.OnClickListener`

**Fields defined:**
| Field | Type | Line |
|---|---|---|
| `activity` | `JobsActivity` | 44 |
| `timerText` | `TextView` (public) | 45 |
| `textViewSecondText` | `TextView` (public) | 45 |
| `finishBtn` | `ImageView` (private) | 46 |
| `presenter` | `JobsPresenter` (public) | 47 |
| `companyDateFormatter` | `CompanyDateFormatter` (private) | 48 |
| `serverDateFormatter` | `ServerDateFormatter` (private) | 49 |

**Methods defined (with line numbers and signatures):**

| Line | Signature |
|---|---|
| 53 | `public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)` |
| 59 | `public void onActivityCreated(Bundle savedInstanceState)` |
| 65 | `private void setDriverInfoHeader()` |
| 78 | `public void logout()` |
| 113 | `public void initViews()` |
| 140 | `private void setInfo()` |
| 150 | `public void onSessionSaved()` |
| 155 | `public void onItemClick(View v, int position)` |
| 159 | `public void onClick(View v)` |
| 172 | `public void onSessionEnded()` |

**Constants/types defined:** None.

---

### Findings for JobsFragment.java

#### A63-11 — HIGH — No test for `logout()` when network fails and `SessionDb.hasOfflineData()` returns false

**Location:** `logout()` lines 78–110

The `onFailed` callback at lines 94–103 calls `SessionDb.hasOfflineData(parameter.id)`. If this returns `false`, the method exits the `if` block silently — there is no `else` branch. The user remains logged in and on the Jobs screen with no feedback that logout failed. This is a functional defect and a potential security concern (the session is not terminated). No test exercises this failure path.

#### A63-12 — HIGH — No test for `logout()` when `sessionResult` is null

**Location:** `logout()` lines 80–109

When `sessionResult == null` (line 105 branch), `WebData.instance().logout()` is called directly and `LoginActivity` is launched. No test verifies that the null branch executes correctly and that the correct activity is started without a prior network call being made.

#### A63-13 — MEDIUM — No test for `initViews()` when `WebData.getSessionResult()` returns null

**Location:** `initViews()` lines 120–128

When `getSessionResult()` returns null, the method calls `getBaseActivity().finish()` after showing a toast. No test verifies: the toast fires, the correct views are made visible/invisible, and `finish()` is called. There is also no test to confirm execution stops (no NPE follows from `setInfo()` being called after the early return).

#### A63-14 — MEDIUM — No test for `setDriverInfoHeader()` timezone branching

**Location:** `setDriverInfoHeader()` lines 65–76

The `training` visibility is conditioned on `tz.getID().contains("America")`. This region-specific logic has two branches with different UI outcomes. No test exercises either timezone branch. The `INVISIBLE` vs `GONE` distinction also means layout space is handled differently; a test would catch any accidental regression of this behaviour.

#### A63-15 — MEDIUM — No test for `onClick()` when `presenter` is null

**Location:** `onClick()` lines 159–169

The guard `if (presenter != null)` at line 163 is present. No test verifies that pressing the finish button when `presenter` is null does not crash, and that `SessionTimeouter.getInstance().cancel()` is still called before the null check is reached.

#### A63-16 — MEDIUM — No test for `onSessionEnded()` when `presenter` is null

**Location:** `onSessionEnded()` lines 172–175

`onSessionEnded()` calls `presenter.stopTimer()` at line 174 without a null check, unlike `onClick()` which guards its own `presenter` usage. If `onSessionEnded()` is called before `initViews()` completes (i.e., before the `presenter` is assigned at line 137), a `NullPointerException` will occur. No test exercises this lifecycle ordering.

#### A63-17 — LOW — No test for `setInfo()` when `SessionDb.readRunningEquipmentItem()` returns null

**Location:** `setInfo()` lines 140–148

The null check at line 144 (`if (equipmentItem != null)`) correctly skips the `setText()` calls. No test verifies that the equipment name and type TextViews retain their default/empty state when no equipment item is found in the database.

#### A63-18 — LOW — No test for `onItemClick()` — method is a stub

**Location:** `onItemClick()` lines 155–157

The method is empty. While trivially correct now, there is no test to detect when a future implementation is added without corresponding test coverage. This should be flagged so any addition to the method body triggers a test requirement.

---

## File 3: LoginFragment.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.ui.fragment.LoginFragment`

**Superclass:** `au.com.collectiveintelligence.fleetiq360.ui.common.FleetFragment`

**Interfaces implemented:** `View.OnClickListener`

**Fields defined:**
| Field | Type | Line |
|---|---|---|
| `nameText` | `EditText` (private) | 29 |
| `passwordText` | `EditText` (private) | 29 |

**Methods defined (with line numbers and signatures):**

| Line | Signature |
|---|---|
| 33 | `public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)` |
| 38 | `public void initViews()` |
| 67 | `private void login()` |
| 79 | `public void onStop()` |
| 83 | `public void onDestroy()` |
| 89 | `public void onClick(View view)` |

**Constants/types defined:** None. References `BuildConfig.VERSION_NAME`.

---

### Findings for LoginFragment.java

#### A63-19 — HIGH — No test for `login()` with empty username

**Location:** `login()` lines 67–76

`login()` validates only that the password is at least 4 characters (line 68). There is no guard against an empty or whitespace-only username. `nameText.getText().toString()` is passed directly to `CurrentUser.setTemporaryLoginInformation()` (line 74) which then passes it into `CommonFunc.MD5_Hash(loginEmail)` in `CurrentUser.login()`. An empty string is MD5-hashed and sent to the server as the email, which is meaningless but will trigger a server round-trip. No test verifies that an empty username is rejected before the network call is made.

#### A63-20 — HIGH — No test for `login()` with empty password

**Location:** `login()` lines 67–76

The password validation at line 68 checks `passwordText.getText().length() < 4`. A password of exactly 0 length (empty field) passes the `< 4` guard and correctly shows the toast. However, a password of exactly 4 characters (e.g., `"0000"`) passes through with no further validation. No test verifies:
- Empty password (0 chars) — toast is shown, `setTemporaryLoginInformation` is not called.
- Password of exactly 3 chars — boundary condition, toast is shown.
- Password of exactly 4 chars — boundary condition, login proceeds.
- Password of 9+ chars — no upper-bound guard exists in `login()` (the toast text says "Max: 8"), so a 9-char password is silently accepted. This is a functional defect: the displayed constraint `Max: 8` is not enforced. No test exposes this discrepancy.

#### A63-21 — HIGH — No test for offline login fallback authenticating a revoked account

**Location:** `CurrentUser.login()` (cross-referenced from `SignupLoadingFragment.loadingLoginHandle()` which is triggered by `LoginFragment.login()`)

When the server call in `CurrentUser.login()` fails with any non-502 HTTP error (including network timeout, DNS failure, or connectivity loss), the fallback at lines 103–108 of `CurrentUser.java` queries `UserDb.get(loginEmail, loginPassword)`. This query matches on stored email and MD5 password. If a user's account has been suspended, terminated, or had its password reset by an administrator on the server, but the old credentials remain cached in the local Realm database, the user will still be granted access to the application during network outages.

`LoginFragment.login()` initiates this entire flow. No test exercises the scenario:
- User's account is revoked on the server.
- Device is offline.
- User enters the old (now-revoked) credentials.
- Expected result: login should fail.
- Actual result: login succeeds via the offline fallback.

This is a security control bypass. There is no test to verify that revoked credentials are rejected in the offline path.

#### A63-22 — HIGH — No test for network failure during login (non-revoked account)

**Location:** `login()` line 75 → `SignupLoadingFragment.loadingLoginHandle()` → `CurrentUser.login()` `onFailed` callback

When the network fails during a normal (non-revoked) user's login attempt, the fallback to `UserDb.get()` is the intended recovery path. No test verifies:
- A valid cached user is found and `HandleSuccess()` is called.
- The correct `User` object is set as `CurrentUser`.
- `HandleIncorrectCredentials()` is not incorrectly called.
- The loading animation is terminated correctly (`loginFinished = true`).

The `loginFinished` and `runTime` fields in `SignupLoadingFragment` are `static` (lines 51–52), which means state from a previous login attempt leaks into the next. No test verifies that these static fields are reset correctly when `loadingLoginHandle()` is called on a second login attempt within the same process lifecycle.

#### A63-23 — MEDIUM — No test for `initViews()` — "other users" button disabled when no stored users

**Location:** `initViews()` lines 52–55

When `UserDb.userEmails()` returns an empty list, the other-users button is made non-clickable and set to 30% opacity. No test verifies:
- The button is disabled when no users are stored.
- The button is enabled and fully opaque when at least one user is stored.
- Clicking a disabled button does not trigger the dialog (the `onClick` guard at line 96 does check `emails.isEmpty()` again, but this double-guard is not tested for consistency).

#### A63-24 — MEDIUM — No test for `onClick()` — "other users" dialog populates username field

**Location:** `onClick()` lines 94–107

The dialog callback at lines 101–105 sets `nameText` to the selected email and clears `passwordText`. No test verifies:
- The selected email appears correctly in `nameText`.
- `passwordText` is cleared (not merely empty from a prior state).
- The correct `email` parameter is passed to the callback.

#### A63-25 — MEDIUM — No test for password IME action triggering login

**Location:** `initViews()` lines 57–64

The `OnEditorActionListener` calls `login()` when `IME_ACTION_DONE` is received. No test verifies this keyboard shortcut path triggers the same validation logic as the button click path, and that other IME action codes (e.g., `IME_ACTION_NEXT`) do not inadvertently trigger login.

#### A63-26 — LOW — No test for `login()` — password max-length constraint not enforced in code

**Location:** `login()` lines 68–71

The toast at line 69 states "Min: 4 and Max: 8" but the code only checks `< 4`. No upper bound of 8 is checked. A password of 9, 20, or 100 characters will pass validation. No test documents or enforces the maximum length, leaving the stated UI contract untested and unimplemented.

#### A63-27 — LOW — No test for `onStop()` and `onDestroy()` — lifecycle stubs

**Location:** `onStop()` lines 79–81, `onDestroy()` lines 83–86

Both methods call `super` and do nothing else. While correct as stubs, there is no test to detect if a future contributor adds logic to these methods without adding corresponding tests.

#### A63-28 — INFO — Static fields in `SignupLoadingFragment` create test isolation problems

**Location:** `SignupLoadingFragment` lines 51–52 (cross-referenced via `login()` flow)

`loginFinished` and `runTime` are `static` fields. Any test of the login flow that does not properly reset these fields between test runs will observe stale state from previous test cases. The absence of any test infrastructure means this problem has not yet materialized, but it will be an obstacle when tests are eventually written.

---

## Summary Table

| ID | Severity | File | Description |
|---|---|---|---|
| A63-1 | HIGH | Project-wide | Zero automated test coverage in `app/` and `LibCommon/` modules |
| A63-2 | HIGH | IncidentPart2Fragment | No test for photo upload failure leaving incident record incomplete |
| A63-3 | HIGH | IncidentPart2Fragment | No test for `onRightButton()` with empty location; whitespace bypasses guard |
| A63-4 | MEDIUM | IncidentPart2Fragment | No test for `onRightButton()` when photo or signature is missing |
| A63-5 | MEDIUM | IncidentPart2Fragment | No test for `setInjuryType()` null-guard behaviour |
| A63-6 | MEDIUM | IncidentPart2Fragment | No test for `initValues()` with null `impactParameter` fields |
| A63-7 | MEDIUM | IncidentPart2Fragment | No test for retry path when `impactResult` already set (partial prior save) |
| A63-8 | LOW | IncidentPart2Fragment | No test for `choosePhoto()` when image picker returns empty list |
| A63-9 | LOW | IncidentPart2Fragment | No test for `onMiddleButton()` navigation branches |
| A63-10 | LOW | IncidentPart2Fragment | No test for `updatePhoto()`/`updateSignature()` visibility toggling |
| A63-11 | HIGH | JobsFragment | No test for `logout()` when network fails and no offline data exists |
| A63-12 | HIGH | JobsFragment | No test for `logout()` null `sessionResult` branch |
| A63-13 | MEDIUM | JobsFragment | No test for `initViews()` when session result is null |
| A63-14 | MEDIUM | JobsFragment | No test for timezone-conditional training visibility in `setDriverInfoHeader()` |
| A63-15 | MEDIUM | JobsFragment | No test for `onClick()` when `presenter` is null |
| A63-16 | MEDIUM | JobsFragment | No test for `onSessionEnded()` called before `presenter` is assigned (NPE risk) |
| A63-17 | LOW | JobsFragment | No test for `setInfo()` when equipment item is null |
| A63-18 | LOW | JobsFragment | No test for `onItemClick()` stub — future additions will be uncovered |
| A63-19 | HIGH | LoginFragment | No test for `login()` with empty username |
| A63-20 | HIGH | LoginFragment | No test for `login()` password boundary conditions; max-8 constraint not enforced |
| A63-21 | HIGH | LoginFragment | No test for offline fallback authenticating revoked account |
| A63-22 | HIGH | LoginFragment | No test for network failure during login (non-revoked account path) |
| A63-23 | MEDIUM | LoginFragment | No test for other-users button enabled/disabled state |
| A63-24 | MEDIUM | LoginFragment | No test for other-users dialog username population |
| A63-25 | MEDIUM | LoginFragment | No test for IME action triggering `login()` |
| A63-26 | LOW | LoginFragment | No test for unimplemented max-length password constraint |
| A63-27 | LOW | LoginFragment | No test for `onStop()`/`onDestroy()` lifecycle stubs |
| A63-28 | INFO | LoginFragment | Static fields in `SignupLoadingFragment` will cause test isolation issues |
