# Audit Pass 2 — Agent A26
**Audit run:** 2026-02-26-01
**Agent:** A26
**Files assigned:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/SavePreStartItem.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/SaveSessionItem.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/SaveShockEventItem.java`

---

## Project-Wide Finding: Zero Automated Test Coverage

### A26-1 — HIGH: No automated tests exist in the app/ or LibCommon/ modules

The `app/` and `LibCommon/` modules contain no test directories whatsoever. A search across the repository for `test/**/*.java` and `androidTest/**/*.java` confirms that the only test files present are in third-party library modules (`LibImageloader`, `LibImagePicker`, `LibPercentProgress`) and are not project-authored tests. The `app/` module — which contains all application logic, safety-critical pre-start inspection flows, workplace shock-event capture, and session management — has zero test coverage at the unit or instrumented test level.

**Impact:** There is no automated verification that any business logic, data validation, serialisation, or safety-critical field population is correct. Regressions in any of these areas are undetectable by CI. Given that two of the three classes assigned to this agent represent physical safety domains (pre-start equipment inspection and forklift impact/shock events), the complete absence of tests is a significant risk that applies project-wide to every class in `app/`.

---

## File 1: SavePreStartItem.java

**Full path:** `/c/Projects/cig-audit/repos/forkliftiqapp/app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/SavePreStartItem.java`

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.SavePreStartItem`

**Implements:** `java.io.Serializable`

**Fields defined:**
| Field | Type | Line |
|---|---|---|
| `start_time` | `String` | 14 |
| `finish_time` | `String` | 15 |
| `comment` | `String` | 16 |
| `session_id` | `int` | 17 |
| `arrAnswers` | `ArrayList<AnswerItem>` | 18 |

**Methods defined:**
| Method | Line | Signature |
|---|---|---|
| Default constructor | 20 | `public SavePreStartItem()` |
| JSON-deserialising constructor | 23 | `public SavePreStartItem(JSONObject jsonObject) throws JSONException` |

**No constants defined.**

**Imports of note:**
- `org.json.JSONObject`, `org.json.JSONArray`
- `au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.AnswerItem` (via wildcard)

### Findings

#### A26-2 — HIGH: No test file exists for SavePreStartItem; safety-critical pre-start data is never validated

There is no test file for `SavePreStartItem` anywhere in the repository. A glob search for `SavePreStartItem*` returns only the production source file. A cross-reference of all test directories in the project confirms there is no indirect coverage either.

`SavePreStartItem` is the data transfer object submitted to the server when a driver completes a forklift pre-start inspection. The field `arrAnswers` carries the driver's responses to every inspection question (e.g., confirmation that brakes, lights, horn, and load management devices are functional). `session_id` links the inspection to the operating session. `start_time` and `finish_time` establish the time window in which the inspection was performed.

No test verifies any of the following:
- That the no-arg constructor leaves all fields in a defined state (all reference fields are `null`, `session_id` is `0`, `arrAnswers` is `null`).
- That the JSON-deserialising constructor correctly populates all five fields when all keys are present.
- That individual keys absent or `null` in the JSON payload leave the corresponding field at its Java default rather than throwing.
- That `arrAnswers` is populated correctly when the JSON array contains multiple `AnswerItem` entries, including that each `AnswerItem` is constructed and appended in order.
- That `arrAnswers` remains `null` (not an empty list) when the `arrAnswers` key is absent from the JSON — this affects downstream null-checks in callers.
- That a completely empty JSON object `{}` does not throw and produces a fully default-initialised object.
- That a `null` JSON object passed to the deserialising constructor is handled without NPE (the constructor body begins `if (jsonObject != null)` but this branch is never exercised by any test).
- That `session_id` is correctly read as an `int` rather than silently truncated from a larger server-supplied value.

**Safety context:** `SessionDb.getPreStartResultsParameter()` (line 78–99 of `SessionDb.java`) constructs a `SavePreStartItem` using the no-arg constructor and populates it manually before it is sent to the server by `SyncService.syncSessionItems()`. If any field is omitted or incorrectly set, the server receives an incomplete pre-start record. Because pre-start inspections are a workplace safety control (a failed inspection is supposed to prevent forklift operation), silent data loss in this DTO means the server may record a successful inspection that did not actually occur, or may record an inspection with no answers attached. No test currently catches this scenario.

#### A26-3 — MEDIUM: JSON-deserialising constructor does not validate field formats or ranges; no test covers malformed input

The `SavePreStartItem(JSONObject)` constructor reads `start_time` and `finish_time` as raw strings without parsing or validating date format. `session_id` is read as an `int` without range checking. No test exercises:
- An out-of-range or negative `session_id`.
- A `start_time` or `finish_time` string that is non-empty but is not a valid date.
- A `start_time` that is chronologically later than `finish_time`.
- A `JSONArray` for `arrAnswers` that contains a non-object element (e.g., a string or `null` element), which would cause `getJSONObject(i)` to throw `JSONException` partway through array iteration, leaving `arrAnswers` in a partially populated state.

**Severity rationale:** Partially populated `arrAnswers` on a JSONException mid-loop is a real data integrity risk, but it requires a malformed server response to trigger, which is a less common path than ordinary usage.

#### A26-4 — LOW: Wildcard import hides the dependency on AnswerItem; no test documents the expected contract

Line 9 imports `au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.*` via wildcard. This means that if `AnswerItem` is moved, renamed, or its constructor signature changes, the compiler error surfaces in `SavePreStartItem` but there is no test to make the breakage visible at test-run time. This is a minor maintainability concern; the wildcard import itself does not introduce a runtime bug.

---

## File 2: SaveSessionItem.java

**Full path:** `/c/Projects/cig-audit/repos/forkliftiqapp/app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/SaveSessionItem.java`

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.SaveSessionItem`

**Implements:** `java.io.Serializable`

**Fields defined:**
| Field | Type | Line |
|---|---|---|
| `id` | `int` | 14 |
| `driver_id` | `int` | 15 |
| `unit_id` | `int` | 16 |
| `start_time` | `String` | 17 |
| `finish_time` | `String` | 18 |
| `prestart_required` | `boolean` | 19 |

**Methods defined:**
| Method | Line | Signature |
|---|---|---|
| Default constructor | 21 | `public SaveSessionItem()` |
| JSON-deserialising constructor | 24 | `public SaveSessionItem(JSONObject jsonObject) throws JSONException` |

**No constants defined.**

### Findings

#### A26-5 — MEDIUM: No test file exists for SaveSessionItem; session linkage fields are never validated

There is no test file for `SaveSessionItem` anywhere in the repository. The class is the DTO for a forklift operating session submitted to the server. It carries `driver_id`, `unit_id`, `id`, `start_time`, `finish_time`, and the `prestart_required` flag.

In `SyncService.syncSessionItems()` (lines 126–132), a `SaveSessionItem` is constructed via the no-arg constructor and populated manually field-by-field from a `SessionResult`. The JSON-deserialising constructor is also available (for symmetry with other DTOs and server response parsing). No test covers:
- That the no-arg constructor leaves all reference fields as `null` and all primitive fields as `0`/`false`.
- That the JSON-deserialising constructor correctly reads all six fields.
- That a `null` JSON object is handled without NPE (the constructor begins with a null guard but this is never tested).
- That missing individual keys leave the corresponding primitives at their Java default values (`0` for `int`, `false` for `boolean`) rather than throwing.
- That `prestart_required` defaulting to `false` on a missing key is correct and intentional (a false negative here means a driver bypasses a required inspection).
- That the `id` field — which correlates sessions on the server — is correctly propagated and not silently left as `0`.

**Severity rationale:** Rated MEDIUM rather than HIGH because `SaveSessionItem` carries operational session metadata rather than safety inspection answers. A data error here leads to a misattributed or orphaned session record, which is a data integrity problem but less immediately safety-critical than missing inspection responses.

#### A26-6 — LOW: prestart_required boolean defaults to false when key is absent; this default is unverified by any test

When `prestart_required` is absent from the JSON payload, the JSON-deserialising constructor leaves it as the Java primitive default `false`. This means if the server ever omits this field, the app will silently treat the session as not requiring a pre-start inspection. No test asserts this behaviour is intentional. This is the same gap noted in A26-5 but is called out separately because the boolean default has a specific operational meaning that should be explicitly documented and verified.

---

## File 3: SaveShockEventItem.java

**Full path:** `/c/Projects/cig-audit/repos/forkliftiqapp/app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/SaveShockEventItem.java`

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.SaveShockEventItem`

**Implements:** `java.io.Serializable`

**Fields defined:**
| Field | Type | Line |
|---|---|---|
| `impact_time` | `String` | 13 |
| `impact_value` | `long` | 14 |
| `mac_address` | `String` | 15 |

**Methods defined:**
| Method | Line | Signature |
|---|---|---|
| Default constructor | 17 | `public SaveShockEventItem()` |
| ShockEventsDb-mapping constructor | 20 | `public SaveShockEventItem(ShockEventsDb event)` |
| JSON-deserialising constructor | 26 | `public SaveShockEventItem(JSONObject jsonObject) throws JSONException` |

**No constants defined.**

**Imports of note:**
- `au.com.collectiveintelligence.fleetiq360.WebService.BLE.ShockEventsDb`
- `au.com.collectiveintelligence.fleetiq360.WebService.JSONObjectParser`
- `au.com.collectiveintelligence.fleetiq360.util.ServerDateFormatter`

### Findings

#### A26-7 — HIGH: No test file exists for SaveShockEventItem; workplace safety impact event data is never validated

There is no test file for `SaveShockEventItem` anywhere in the repository. This class captures the data submitted to the server for a forklift impact (shock) event: `impact_time`, `impact_value` (magnitude), and `mac_address` (identifying the BLE-connected device that recorded the event).

Shock events represent potential workplace incidents. An impact at or above a configured threshold is a safety signal that may require management review, incident reporting, or equipment withdrawal from service. The data in this DTO forms the basis of that record.

No test covers any of the following:

**ShockEventsDb-mapping constructor (lines 20–24):**
- That `impact_time` is correctly formatted by `ServerDateFormatter.formatDateTime()` for the GMT timezone expected by the server.
- That a `null` `event.time` field passed to `ServerDateFormatter.formatDateTime()` produces a `NullPointerException` (line 21 calls `formatDateTime(event.time)` without a null guard; `SimpleDateFormat.format(null)` throws NPE).
- That `impact_value` correctly captures the magnitude from `ShockEventsDb.magnitude` (a `long`).
- That `mac_address` is correctly copied from `ShockEventsDb.mac_address`.
- That a `null` `ShockEventsDb` argument causes NPE (there is no null guard on the `event` parameter; the no-arg guard is on the JSON constructor only).

**JSON-deserialising constructor (lines 26–34):**
- That a `null` JSON object causes an early return with all fields at their Java defaults (`null`, `0L`, `null`).
- That all three fields are correctly populated from a complete JSON object.
- That a JSON object missing individual keys leaves those fields at `null`/`0L` via `JSONObjectParser`'s null-safe accessors.
- That `impact_value` is correctly read as `long` and not truncated to `int`.

**Cross-cutting concern — round-trip integrity:**
- `ShockEventsDb.removeData()` (in `ShockEventsDb.java`, lines 23–34) parses `item.impact_time` back from a string using `ServerDateFormatter.parseDateTime()` to match and delete the Realm record after successful upload. If `formatDateTime` and `parseDateTime` are not exact inverses for the same `Date` value, the Realm record is never deleted and the event is re-submitted on every subsequent sync. No test verifies this round-trip property.

#### A26-8 — HIGH: NullPointerException risk in ShockEventsDb-mapping constructor when event.time is null; no test covers this path

Line 21 of `SaveShockEventItem.java`:
```java
this.impact_time = new ServerDateFormatter().formatDateTime(event.time);
```

`ServerDateFormatter.formatDateTime()` delegates directly to `SimpleDateFormat.format(Date)`, which throws `NullPointerException` when passed `null`. `ShockEventsDb.time` is a `Date` field on a Realm object; if the BLE layer records an event without populating `time`, the constructor throws unchecked and the impact event is silently dropped at the call site in `ShockEventsDb` (where this constructor is invoked). There is no null guard and no test that triggers this path.

**Severity rationale:** A missing impact event record due to a silent NPE means a potentially safety-significant forklift impact goes unreported to management. This is HIGH because the precondition (`event.time == null`) is plausible given that BLE event recording involves hardware timing and the Realm `Date` field has no `@Required` annotation enforcing non-null at the persistence layer.

#### A26-9 — MEDIUM: format/parse round-trip for impact_time is untested; silent re-submission of shock events is possible

As described in A26-7, `SaveShockEventItem(ShockEventsDb)` formats `event.time` to a string, and `ShockEventsDb.removeData()` later parses that string back to a `Date` to match the Realm record for deletion. `ServerDateFormatter` uses `SimpleDateFormat` with pattern `"yyyy-MM-dd HH:mm:ss"` and GMT timezone. Java `Date` stores milliseconds. If `event.time` has sub-second precision (milliseconds != 0), the formatted string truncates the milliseconds. When parsed back, the resulting `Date` differs by up to 999 milliseconds from the original. The Realm query in `getMatchingEvents()` uses `.equalTo("time", time)` which performs exact `Date` equality, so if the times differ by even one millisecond, the record is not matched and is not deleted. This causes the event to be re-submitted on the next sync cycle. No test exercises this scenario.

#### A26-10 — INFO: Three constructors with different null-handling conventions are inconsistent and undocumented

`SaveShockEventItem` exposes three constructors with inconsistent null-safety behaviour:
- The no-arg constructor performs no initialisation (all fields remain at Java defaults).
- The `ShockEventsDb`-mapping constructor has no null guard on its parameter and will NPE on a null argument or a null `event.time`.
- The JSON-deserialising constructor has an early-return null guard (`if (jsonObject == null) return;`).

This inconsistency in defensive programming style makes the class harder to use correctly. No test documents the expected null-safety contract for each constructor, leaving callers to discover the behaviour empirically or from reading the source.

---

## Summary Table

| ID | Severity | File | Summary |
|---|---|---|---|
| A26-1 | HIGH | Project-wide | Zero automated tests in app/ and LibCommon/ modules |
| A26-2 | HIGH | SavePreStartItem | No tests; safety-critical pre-start inspection data unvalidated |
| A26-3 | MEDIUM | SavePreStartItem | Malformed JSON input paths untested; partial arrAnswers population risk |
| A26-4 | LOW | SavePreStartItem | Wildcard import obscures AnswerItem dependency; no test documents contract |
| A26-5 | MEDIUM | SaveSessionItem | No tests; session linkage fields and prestart_required flag unvalidated |
| A26-6 | LOW | SaveSessionItem | prestart_required silently defaults to false on missing key; unverified |
| A26-7 | HIGH | SaveShockEventItem | No tests; workplace safety impact event data unvalidated across all three constructors |
| A26-8 | HIGH | SaveShockEventItem | NPE in ShockEventsDb-mapping constructor when event.time is null; silent event loss |
| A26-9 | MEDIUM | SaveShockEventItem | impact_time format/parse round-trip untested; millisecond truncation causes silent re-submission |
| A26-10 | INFO | SaveShockEventItem | Three constructors with inconsistent null-handling conventions; no documented contract |
