# Audit Pass 2 – Agent A06
**Audit run:** 2026-02-26-01
**Agent:** A06
**Assigned files:**
1. `LibCommon/src/main/java/com/yy/libcommon/Font/FontCache.java`
2. `LibCommon/src/main/java/com/yy/libcommon/FragmentInterface.java`
3. `LibCommon/src/main/java/com/yy/libcommon/IDialogGenericCallback.java`

---

## Project-Wide Finding

### A06-1 [HIGH] – Zero automated test coverage across app/ and LibCommon/ modules

No `test/` or `androidTest/` directory exists under either the `app/` module or the `LibCommon/` module. Confirmed by directory search: only `LibImageloader/src/test`, `LibImagePicker/src/androidTest`, and `LibPercentProgress/src/androidTest` exist in the repo, all in third-party library modules. The two first-party modules (`app/` and `LibCommon/`) that contain all business logic, UI components, and data handling have zero automated test coverage.

All three files assigned to this agent reside in `LibCommon/` and therefore inherit this project-wide gap. No indirect test coverage of any of the three files was found by searching all `*Test*.java` files in the repo.

**Risk:** Regressions, logic errors, and null-pointer conditions in production code are undetected until a user encounters them in the field.

---

## File 1: `FontCache.java`

### Reading Evidence

**Fully qualified class name:** `com.yy.libcommon.Font.FontCache`

**Fields:**
| Line | Signature |
|------|-----------|
| 14 | `private static HashMap<String, Typeface> fontCache = new HashMap<>()` |

**Methods:**
| Line | Signature |
|------|-----------|
| 16 | `public static Typeface getTypeface(String fontname, Context context)` |
| 32 | `public static Typeface getTypeFace(Context context, String ttf)` |

**Constants/types defined:** None explicitly. Font filename literals used inline:
- `"HelveticaNeueLt.ttf"` (lines 36, 60)
- `"HelveticaNeu_Bold.ttf"` (line 41)
- `"HelveticaNeue_Light.ttf"` (line 44)
- `"HelveticaNeue_Medium.ttf"` (line 48)
- `"HelveticaNeue_Thin.ttf"` (line 52)
- `"HelveticaNeueUt.ttf"` (line 56)

---

### Findings

#### A06-2 [HIGH] – `getTypeface` has no test coverage

`getTypeface(String fontname, Context context)` (line 16) is the low-level cache-read-or-load method used by all callers transitively via `getTypeFace`. It has no test of any kind.

Untested behaviours include:
- Cache hit path (font already in `fontCache`): returns cached value without re-loading.
- Cache miss path: calls `Typeface.createFromAsset`, stores result, returns it.
- Exception path (line 22–24): any `Exception` during asset loading silently returns `null`, but the caller `getTypeFace` does not check for `null` before returning to its own callers. Callers such as `AMTextView.applyCustomFont` do check for `null` on the final result, but intermediate `null` propagation is untested.
- `fontname` is `null`: `fontCache.get(null)` is legal in `HashMap` and will return `null`, then `Typeface.createFromAsset(context.getAssets(), "fonts/null")` will be attempted. This path is entirely untested.
- `context` is `null`: `context.getAssets()` throws `NullPointerException` (not caught by the `catch (Exception e)` block because the NPE occurs before the try, if `context` is `null` when passed to the method). Actually, at line 21 the NPE on `context.getAssets()` would occur inside the try block and would be caught, returning `null`. Nevertheless this untested silent failure path is a concern.

#### A06-3 [HIGH] – `getTypeFace` has no test coverage

`getTypeFace(Context context, String ttf)` (line 32) is the public dispatch method used by all `AM*` custom view classes. It has no test of any kind.

Untested paths:
- `ttf == null` (line 34): falls through to the default font. No test verifies correct font is returned.
- `ttf.length() == 0` (line 34): empty string falls through to the default font. No test.
- `ttf.equals("bold")` (line 40): bold branch. No test.
- `ttf.equals("light")` (line 43): light branch. No test.
- `ttf.equals("medium")` (line 47): medium branch. No test.
- `ttf.equals("thin")` (line 51): thin branch. No test.
- `ttf.equals("untrathin")` (line 55): ultra-thin branch (note: the string `"untrathin"` appears to be a misspelling of `"ultrathin"`; if calling code passes `"ultrathin"` the branch is never matched and the default font is silently used instead).
- Unrecognised `ttf` value (line 59): falls through to default font. No test.
- Return value is not checked to be non-null before being returned to the caller; if `getTypeface` returns `null` (on asset-load failure) the null propagates up silently.

#### A06-4 [MEDIUM] – Typo in `"untrathin"` branch key produces silent wrong-font selection

Line 55: `ttf.equals("untrathin")` — the string is missing the letter `l` compared to the apparent intent `"ultrathin"`. If any caller uses the canonical spelling `"ultrathin"`, no branch matches and the default `HelveticaNeueLt.ttf` is substituted silently. Because there are no tests for this branch, this defect cannot be detected by automation.

This is both a correctness defect and a test coverage gap: a test asserting that `getTypeFace(ctx, "ultrathin")` returns the ultra-thin typeface would have caught this at development time.

#### A06-5 [MEDIUM] – Static `HashMap` cache is not thread-safe and has no concurrent-access test

`fontCache` (line 14) is a `private static HashMap<String, Typeface>`. `HashMap` is not thread-safe. The check-then-put sequence at lines 17–26 is a classic TOCTOU race: two threads can both observe `typeface == null` for the same key, both call `Typeface.createFromAsset`, and both call `fontCache.put`. While the end result of the put is benign (both write the same value), the unsynchronised concurrent writes to `HashMap` can cause internal corruption (`HashMap` resizing is not thread-safe). No test exercises concurrent access to `getTypeface`.

#### A06-6 [LOW] – No test for cache isolation / cache-clearing behaviour

The static `fontCache` field is shared across the entire process lifetime. There is no way to clear or reset the cache (no `clear()` method, no test hooks), and no test verifies that a stale or corrupted cache entry does not persist across test cases. This makes test isolation difficult in any future test suite.

---

## File 2: `FragmentInterface.java`

### Reading Evidence

**Fully qualified class name:** `com.yy.libcommon.FragmentInterface` (outer class)
**Nested interface:** `com.yy.libcommon.FragmentInterface.FragmentHandle`

**Methods (interface abstract methods):**
| Line | Signature |
|------|-----------|
| 11 | `void addFragment(@IdRes int containerViewId, Fragment fragment, String tag)` |
| 12 | `void hideFragment(String tag)` |
| 13 | `void removeFragment(String tag)` |
| 14 | `Fragment findFramentByTag(String tag)` |
| 15 | `Fragment showFragment(@IdRes int containerViewId, String tag, String className)` |

**Constants/types defined:** None.

**Note:** The method name `findFramentByTag` (line 14) is a typo; the standard Android method is `findFragmentByTag`. This is part of the public API contract of the interface.

---

### Findings

#### A06-7 [HIGH] – Interface `FragmentHandle` has no test coverage of any implementing class

`FragmentInterface.FragmentHandle` is a contract interface with five methods. There are no tests anywhere in the project that exercise any implementation of this interface. All five methods are untested:
- `addFragment` – no test for valid addition, duplicate tag, invalid container ID, or null fragment/tag.
- `hideFragment` – no test for a tag that exists, a tag that does not exist, or a null tag.
- `removeFragment` – no test for a tag that exists, a tag that does not exist, or a null tag.
- `findFramentByTag` – no test for found, not-found, or null-tag cases; return value of `null` (not found) is unverified.
- `showFragment` – no test for valid show, non-existent tag, non-existent `className`, or null arguments.

#### A06-8 [LOW] – Typo in interface method name `findFramentByTag` locks misspelling into public API

Line 14: `findFramentByTag` is missing the second `g` in `Fragment`. The misspelling is now part of the public interface contract and all implementing classes must match it. Because there are no tests, this has never been caught automatically. Renaming it is a breaking change to all implementations.

---

## File 3: `IDialogGenericCallback.java`

### Reading Evidence

**Fully qualified class name:** `com.yy.libcommon.IDialogGenericCallback`
**Kind:** `interface`

**Methods:**
| Line | Signature |
|------|-----------|
| 10 | `public void callBack()` |

**Constants/types defined:** None.

---

### Findings

#### A06-9 [MEDIUM] – Interface `IDialogGenericCallback` has no test coverage of invocation contract

`IDialogGenericCallback.callBack()` (line 10) is a callback interface whose contract is: implementations are invoked from `BaseDialog.onDismiss()` (confirmed by reading `BaseDialog.java`, line 83–85). There are no tests that verify:
- That `callBack()` is invoked exactly once when a dialog is dismissed.
- That `callBack()` is not invoked when `mGenericCallback` is `null` (the null-guard at `BaseDialog` line 83 is untested).
- That `callBack()` is not invoked if the dialog is dismissed without having had a callback registered.
- That multiple rapid dismissals do not cause multiple `callBack()` invocations.

#### A06-10 [INFO] – `public` modifier on interface method is redundant (style)

Line 10: `public void callBack()` — all interface methods are implicitly `public abstract`. The explicit `public` modifier is redundant. While not a defect, it is inconsistent with Java conventions and the `FragmentHandle` methods (which omit `public`). No test impact, but a linter or style check would flag this.

---

## Summary Table

| ID | Severity | File | Finding |
|----|----------|------|---------|
| A06-1 | HIGH | Project-wide | Zero automated test coverage in `app/` and `LibCommon/` modules |
| A06-2 | HIGH | FontCache.java | `getTypeface` entirely untested including null inputs and exception path |
| A06-3 | HIGH | FontCache.java | `getTypeFace` entirely untested including all dispatch branches |
| A06-4 | MEDIUM | FontCache.java | Typo `"untrathin"` causes silent wrong-font selection; untested |
| A06-5 | MEDIUM | FontCache.java | Static `HashMap` cache not thread-safe; no concurrent-access test |
| A06-6 | LOW | FontCache.java | No test for cache isolation or cache-clearing behaviour |
| A06-7 | HIGH | FragmentInterface.java | All five `FragmentHandle` methods untested across all implementations |
| A06-8 | LOW | FragmentInterface.java | Typo `findFramentByTag` locked into public API; undetected without tests |
| A06-9 | MEDIUM | IDialogGenericCallback.java | `callBack()` invocation contract untested (when called, null-guard, frequency) |
| A06-10 | INFO | IDialogGenericCallback.java | Redundant `public` modifier on interface method |
