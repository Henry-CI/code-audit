# Audit Pass 2 — Agent A54
**Audit run:** 2026-02-26-01
**Assigned files:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/activity/DriversActivity.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/activity/EquipmentActivity.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/activity/EquipmentStatsActivity.java`

---

## PROJECT-WIDE FINDING

### A54-1 — HIGH: Zero automated test coverage across app/ and LibCommon/ modules

No `test/` or `androidTest/` directories exist under either the `app/` module or the `LibCommon/` module. The only test directories found in the repository are in unrelated third-party library modules (`LibImageloader`, `LibImagePicker`, `LibPercentProgress`), and those are stub/placeholder directories.

Every class in the core application — all Activities, Fragments, Presenters, WebService classes, model classes, and utility classes — has zero automated test coverage. There is no unit test suite and no instrumented test suite.

**Impact:** Regressions cannot be detected automatically. Business-critical paths (session management, BLE reconnection, equipment selection, training expiry enforcement, GPS saving, authentication routing) are exercised only by manual QA. Any refactor, dependency upgrade, or bug fix carries unchecked regression risk across the entire codebase.

**Severity:** HIGH
**Scope:** Project-wide; applies to every finding below and to every finding from all other Pass 2 agents.

---

## File 1: DriversActivity.java

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.ui.activity.DriversActivity`

**Extends:** `FleetActivity` (which extends `BaseActivity` which extends `AppCompatActivity`)

**Methods defined in this file:**

| Line | Signature |
|------|-----------|
| 13 | `protected void onCreate(Bundle savedInstanceState)` |

**Fields/constants defined in this file:** None.

**Imports used:**
- `android.os.Bundle`
- `au.com.collectiveintelligence.fleetiq360.R`
- `au.com.collectiveintelligence.fleetiq360.ui.common.FleetActivity`
- `au.com.collectiveintelligence.fleetiq360.ui.fragment.DriverListFragment`
- `au.com.collectiveintelligence.fleetiq360.ui.fragment.EquipmentListFragment` (imported but not used)

**Behaviour summary:** On creation, sets layout `activity_drivers`, then calls `showFragmentWithoutStack` to host a `DriverListFragment`. No Intent extras are read; no instance state is saved or restored.

---

### Findings for DriversActivity.java

### A54-2 — LOW: `onCreate` is entirely untested

`DriversActivity.onCreate` (line 13) is never exercised by any test. Although the method is thin (two statements plus the super call), the combined execution path is not trivial:

- `FleetActivity.onCreate` calls `SyncService.startService()` and `checkEquipmentConnected()`, which reads from `SessionDb` and `BleController`.
- `showFragmentWithoutStack` commits a `FragmentTransaction`; if the Fragment tag collision or back-stack state is malformed, the FragmentManager throws `IllegalStateException`.
- `DriverListFragment` performs a network call (`SelectDriverPresenter.getCompanyDriversList()`) in `initViews`.

None of these execution paths — success, BLE already connected, BLE not connected, empty driver list, network failure — are covered by any test.

**Severity:** LOW (activity itself is thin; risk lives in the called components, but those too are untested)

### A54-3 — INFO: Unused import `EquipmentListFragment`

Line 8 imports `EquipmentListFragment`, which is never referenced in this file. This is dead code that adds noise and may confuse future maintainers. It also suggests the file was copied from `EquipmentActivity` without cleanup.

**Severity:** INFO

### A54-4 — MEDIUM: No test for `savedInstanceState` non-null path on rotation/restore

`DriversActivity.onCreate` passes `savedInstanceState` to `super.onCreate`. `BaseActivity.onCreate` calls `onRecover(savedInstanceState)` when the bundle is non-null. `showFragmentWithoutStack` checks whether the fragment already exists by tag before adding — but if Android restores a fragment from the back-stack automatically and `showFragmentWithoutStack` finds it, it calls `transaction.show(pFragment)` on the restored instance. There is no test confirming that activity recreation (e.g., after rotation or process death) does not produce a duplicate fragment or a stale fragment in a detached state.

**Severity:** MEDIUM

---

## File 2: EquipmentActivity.java

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.ui.activity.EquipmentActivity`

**Extends:** `FleetActivity`

**Methods defined in this file:**

| Line | Signature |
|------|-----------|
| 15 | `protected void onCreate(Bundle savedInstanceState)` |

**Fields/constants defined in this file:** None declared locally. The class inherits the static `LOCATION_SETTINGS_REQUEST_GPS = 200` from `FleetActivity`, which is referenced and imported by `EquipmentListFragment` and `FleetFragment` via a static import.

**Imports used:**
- `android.content.Intent` (imported but not directly used within this file)
- `android.os.Bundle`
- `android.support.v4.app.Fragment` (imported but not directly used within this file)
- `au.com.collectiveintelligence.fleetiq360.R`
- `au.com.collectiveintelligence.fleetiq360.model.TakePhotoPathPrefs`
- `au.com.collectiveintelligence.fleetiq360.ui.common.FleetActivity`
- `au.com.collectiveintelligence.fleetiq360.ui.fragment.EquipmentListFragment`

**Behaviour summary:** On creation, sets layout `activity_equipment`, hosts an `EquipmentListFragment`, then calls `TakePhotoPathPrefs.clearImages()` which removes all four shared-preference image-path keys via four separate `commit()` calls.

---

### Findings for EquipmentActivity.java

### A54-5 — MEDIUM: `TakePhotoPathPrefs.clearImages()` called unconditionally on every `onCreate` — no test for data loss on rotation

`TakePhotoPathPrefs.clearImages()` (line 20) deletes all four persisted photo paths from `SharedPreferences` every time `onCreate` is called. `onCreate` is called not only on first launch but also on activity recreation triggered by:
- Screen rotation
- System-initiated process death and restore
- Theme change

If a user has partially filled in photo slots and then rotates the device — or if Android recreates the activity during a low-memory kill — all previously staged photo paths are silently wiped. No test exists to verify:
- That `clearImages` is intentionally guarded against the recreation case (e.g., only called when `savedInstanceState == null`).
- That the clearing is safe under all `onCreate` invocations.
- The interaction between `savedInstanceState` non-null and photo-path state.

**Severity:** MEDIUM (potential silent data loss for users in the middle of equipment photo workflows)

### A54-6 — LOW: `onCreate` is entirely untested

`EquipmentActivity.onCreate` has the same coverage gap as DriversActivity (see A54-2), with the additional complexity that `TakePhotoPathPrefs.clearImages()` performs real SharedPreferences I/O. The fragment hosted (`EquipmentListFragment`) contains significant business logic: training expiry checks, session-already-running guards, network calls to `EquipmentSelectForkPresenter`, and type-cast of the parent activity to `EquipmentActivity`.

No test exercises any path through this activity's lifecycle.

**Severity:** LOW (activity shell is thin; but see A54-5 for the higher-risk issue within it)

### A54-7 — INFO: Unused imports `Intent` and `Fragment`

Lines 4 and 5 import `android.content.Intent` and `android.support.v4.app.Fragment`, neither of which is referenced in this file. Dead imports inherited from a copy-paste base.

**Severity:** INFO

### A54-8 — MEDIUM: No test for `savedInstanceState` non-null path on recreation

Same structural issue as A54-4. `EquipmentListFragment` uses a static field `getEquipmentResultArray` (line 46 of `EquipmentListFragment.java`) and `equipmentChanged` (line 47) to cache network results across instances. On activity recreation, `showFragmentWithoutStack` may reuse the old fragment instance (found by tag) or create a new one. The interaction between Android's automatic fragment restoration and the manually cached static state is untested — especially the case where `getEquipmentResultArray` is non-null from a previous instance while the new fragment assumes a fresh state.

**Severity:** MEDIUM

---

## File 3: EquipmentStatsActivity.java

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.ui.activity.EquipmentStatsActivity`

**Extends:** `FleetActivity`

**Methods defined in this file:**

| Line | Signature |
|------|-----------|
| 10 | `protected void onCreate(Bundle savedInstanceState)` |

**Fields/constants defined in this file:** None.

**Imports used:**
- `android.os.Bundle`
- `au.com.collectiveintelligence.fleetiq360.R`
- `au.com.collectiveintelligence.fleetiq360.ui.common.FleetActivity`
- `au.com.collectiveintelligence.fleetiq360.ui.fragment.DriverStatsFragment3`

**Behaviour summary:** On creation, sets layout `activity_common`, calls `initKeyboard()` (sets soft-input mode to always-hidden + adjust-pan), then hosts `DriverStatsFragment3` via `showFragmentWithoutStack`.

**Note on naming:** The class is named `EquipmentStatsActivity` and it is launched from `DashboardFragment` under the "equipment statistics" button, but it hosts `DriverStatsFragment3` — a fragment whose name implies driver statistics. The fragment fetches equipment stats via `WebApi.getEquipmentStats` using the current user's ID. The naming mismatch is significant and documented under A54-10.

---

### Findings for EquipmentStatsActivity.java

### A54-9 — LOW: `onCreate` is entirely untested

`EquipmentStatsActivity.onCreate` is not covered by any test. The hosted fragment `DriverStatsFragment3` contains substantial logic:
- Three radio-button-driven data fetch paths (weekly/monthly/yearly), each triggering `WebApi.getEquipmentStats`.
- Chart population (`initChartData`) with `NullPointerException` risk if `equipmentStatsResultArray.arrayList` is null (line 260 of `DriverStatsFragment3`: no null guard before iterating `equipmentStatsResultArray.arrayList`).
- User photo display via `UserPhotoFragment.showUserPhoto`.
- `CurrentUser.get()` called without a null guard in `setUserData` (lines 148-153: the outer `if (user != null)` guard exists, but `mRootView.findViewById(R.id.user_name).setText(...)` at line 146 is called unconditionally before it).

None of these paths are tested.

**Severity:** LOW (activity shell is thin; risks are in the hosted fragment)

### A54-10 — MEDIUM: Misleading class/fragment naming — `EquipmentStatsActivity` hosts `DriverStatsFragment3`

`EquipmentStatsActivity` (which handles equipment statistics) unconditionally instantiates `DriverStatsFragment3`. The fragment's name strongly implies it is for driver statistics, not equipment statistics. Investigation confirms that `DriverStatsActivity` exists separately and hosts a different fragment. This naming confusion:

- Creates ambiguity about which fragment contains the canonical equipment-stats logic.
- Makes it impossible to tell from the class name alone what a test should be verifying.
- Risks future developers placing equipment-stats changes in the wrong fragment or duplicating logic.

No test exists to document or pin the expected host-fragment relationship, so this mismatch could silently drift further.

**Severity:** MEDIUM

### A54-11 — MEDIUM: `initKeyboard()` called in `EquipmentStatsActivity.onCreate` but not in `DriversActivity` or `EquipmentActivity`

`BaseActivity.onCreate` already calls `initKeyboard()` as part of its own `onCreate` sequence (line 247 of `BaseActivity.java`). `EquipmentStatsActivity.onCreate` calls `initKeyboard()` a second time (line 14), resulting in a redundant double call for this activity only. This is inconsistent with `DriversActivity` and `EquipmentActivity`, which rely on the single call from `BaseActivity`. The double call has no negative effect on the current `WindowManager.LayoutParams` flag-setting implementation, but:

- It is an undocumented asymmetry with no test to verify the intended behaviour.
- If `initKeyboard()` is ever changed to have side effects (e.g., hiding an already-visible keyboard, resetting state), the double invocation in `EquipmentStatsActivity` will behave differently from sibling activities.

**Severity:** MEDIUM

### A54-12 — MEDIUM: No test for `savedInstanceState` non-null path on recreation

Same structural gap as A54-4 and A54-8. `DriverStatsFragment3` holds the mutable fields `driverStatsResultArray` and `arrayList` as instance state. On activity recreation, these are not persisted to `savedInstanceState` and will be null/empty in the new instance, causing a fresh network fetch. No test confirms this is the intended behaviour (as opposed to restoring from a cache), and no test verifies the chart is correctly cleared and re-populated after recreation.

**Severity:** MEDIUM

---

## Summary Table

| ID | File | Severity | Description |
|----|------|----------|-------------|
| A54-1 | Project-wide | HIGH | Zero automated test coverage in app/ and LibCommon/ |
| A54-2 | DriversActivity | LOW | `onCreate` entirely untested |
| A54-3 | DriversActivity | INFO | Unused import `EquipmentListFragment` |
| A54-4 | DriversActivity | MEDIUM | No test for `savedInstanceState` non-null / recreation path |
| A54-5 | EquipmentActivity | MEDIUM | `TakePhotoPathPrefs.clearImages()` called unconditionally on every `onCreate`; silently destroys staged photo paths on rotation/recreation |
| A54-6 | EquipmentActivity | LOW | `onCreate` entirely untested |
| A54-7 | EquipmentActivity | INFO | Unused imports `Intent` and `Fragment` |
| A54-8 | EquipmentActivity | MEDIUM | No test for static fragment cache interaction with activity recreation |
| A54-9 | EquipmentStatsActivity | LOW | `onCreate` entirely untested |
| A54-10 | EquipmentStatsActivity | MEDIUM | `EquipmentStatsActivity` hosts `DriverStatsFragment3` — misleading naming with no test pinning the relationship |
| A54-11 | EquipmentStatsActivity | MEDIUM | `initKeyboard()` called twice (once by `BaseActivity.onCreate`, once explicitly); inconsistent with sibling activities; no test |
| A54-12 | EquipmentStatsActivity | MEDIUM | No test for `savedInstanceState` non-null / recreation path in stats fragment |
