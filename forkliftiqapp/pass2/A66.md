# Audit Pass 2 – Agent A66
**Audit run:** 2026-02-26-01
**Agent:** A66
**Files assigned:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/ServiceStatsListAdapter.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/SetUserPhotoFragment.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/SetupEmailFragment.java`

---

## PROJECT-WIDE FINDING

### A66-0 — No Automated Test Coverage Exists (HIGH)

**Severity:** HIGH

The `app/` and `LibCommon/` modules contain no test directories of any kind. Confirmed by filesystem inspection:

- `app/src/` contains only a `main/` subdirectory — no `test/` or `androidTest/` directory exists.
- `LibCommon/src/` contains only a `main/` subdirectory — no `test/` or `androidTest/` directory exists.

Third-party library modules (`LibImageloader`, `LibImagePicker`, `LibPercentProgress`) do contain test stubs but these cover library code only, not application logic.

Zero automated test coverage exists for all application and common library source files. Every finding in this report describes a gap in a codebase with no test infrastructure at all. Any regression, edge-case failure, or behavioural defect in the application code can only be detected by manual testing.

---

## File 1: ServiceStatsListAdapter.java

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.ui.fragment.ServiceStatsListAdapter`

**Superclass:** `ArrayAdapter<DriverStatsItem>`

**Fields / constants defined:**
| Name | Type | Declared at |
|------|------|-------------|
| `context` | `Context` (private) | Line 20 |
| `mData` | `ArrayList<DriverStatsItem>` (private) | Line 21 |

**Inner class:** `ListHolder` (static, package-private) — Line 76
- Fields: `name` (TextView), `status_bar` (View), `status_text` (TextView)

**Methods with line numbers and signatures:**
| Line | Signature |
|------|-----------|
| 23 | `ServiceStatsListAdapter(Context context, ArrayList<DriverStatsItem> data)` (package-private constructor) |
| 31 | `@NonNull @Override public View getView(int position, View convertView, @NonNull ViewGroup parent)` |
| 67 | `@Override public int getCount()` |
| 72 | `@Override public DriverStatsItem getItem(int i)` |

**Supporting type read:** `DriverStatsItem` — fields: `String field`, `String object`, `String value` (all populated from JSON as raw strings; `value` is always a `String` regardless of server content).

---

### Findings for ServiceStatsListAdapter.java

#### A66-1 — Silent parse exception swallows non-integer server data and displays misleading "0 Services" (MEDIUM)

**Severity:** MEDIUM
**Location:** `getView()`, lines 54–60

**Code:**
```java
String s = recordItem.value;
int v = 0;
try {
    v = Integer.valueOf(s);
} catch (Exception ignored) {
}
String text = v + " Services";
holder.status_text.setText(text);
```

`DriverStatsItem.value` is a raw `String` populated directly from a JSON string field (see `DriverStatsItem.java` line 34: `value = jsonObject.getString("value")`). The server can return any string content in this field — null, empty string, a decimal such as `"1.5"`, a string like `"N/A"`, or a formatted number like `"1,234"`. When parsing fails, the exception is silently swallowed via `catch (Exception ignored)` and `v` remains `0`, causing the UI to display `"0 Services"` for every row where the value is not a plain integer string.

This is a data fidelity problem: a user sees `0 Services` when the actual server-returned value might be meaningful (e.g., `"N/A"`, a float, or a formatted number). There is no test covering any of these non-integer input cases.

Additionally, `Integer.valueOf(String)` is used here where `Integer.parseInt(String)` is the conventional method for parsing a primitive `int` from a string. `Integer.valueOf` boxes to `Integer` first and is then unboxed back to `int`. While functionally equivalent in this context, the use of the deprecated-style boxing call rather than `parseInt` is a code quality concern.

**Untested paths:**
- `recordItem.value` is null → `Integer.valueOf(null)` throws `NumberFormatException`; result silently shown as `"0 Services"`.
- `recordItem.value` is empty string `""` → throws `NumberFormatException`; silently shown as `"0 Services"`.
- `recordItem.value` is a decimal string `"1.5"` → throws `NumberFormatException`; silently shown as `"0 Services"`.
- `recordItem.value` is a non-numeric string `"N/A"` → throws `NumberFormatException`; silently shown as `"0 Services"`.
- `recordItem.value` is a large number exceeding `Integer.MAX_VALUE` → throws `NumberFormatException`; silently shown as `"0 Services"`.
- `recordItem.value` is a valid integer string → happy path, works correctly.

#### A66-2 — No test for getView() when convertView is non-null (view recycling path) (LOW)

**Severity:** LOW
**Location:** `getView()`, lines 33–49

`getView()` has two branches: when `convertView` is null (inflate + create holder) and when `convertView` is non-null (retrieve existing holder via `getTag()`). The recycling branch is never exercised by any test. A `ClassCastException` from a mismatched tag type or a `NullPointerException` from a null tag would only manifest in this branch during actual list scrolling.

#### A66-3 — No test for getCount() returning mData.size() (LOW)

**Severity:** LOW
**Location:** `getCount()`, line 68

`getCount()` returns `mData.size()` directly. No test covers the empty-list case (where `getCount()` should return 0) or a list with many items. This is a trivial method but is part of the untested surface area of a completely untested class.

#### A66-4 — No test for getItem() bounds behaviour (LOW)

**Severity:** LOW
**Location:** `getItem(int i)`, line 73

`getItem()` delegates directly to `mData.get(i)` with no bounds check. Passing an out-of-bounds index throws `IndexOutOfBoundsException`. Because `ArrayAdapter` calls this method with the position from `getView()`, there is an implicit assumption that the adapter's internal count is always consistent with `mData`. No test verifies this assumption or the out-of-bounds path.

#### A66-5 — Constructor does not make a defensive copy of the data list (INFO)

**Severity:** INFO
**Location:** Constructor, lines 23–27

The constructor stores a direct reference to the caller-supplied `ArrayList<DriverStatsItem>`. If the caller mutates the list after construction without calling `notifyDataSetChanged()`, the adapter's internal state becomes inconsistent. No test covers this scenario. This is an INFO-level suggestion; the current usage may be intentional.

---

## File 2: SetUserPhotoFragment.java

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.ui.fragment.SetUserPhotoFragment`

**Implements:** `View.OnClickListener`
**Superclass:** `FleetFragment`

**Fields defined:**
| Name | Type | Access | Line |
|------|------|--------|------|
| `activity` | `Activity` | package-private | 24 |
| `mBitmap` | `Bitmap` | private | 25 |
| `user_photo` | `ImageView` | private | 26 |
| `user_photo_none` | `ImageView` | private | 27 |
| `fromDashboard` | `boolean` | package-private | 28 |

**Methods with line numbers and signatures:**
| Line | Signature |
|------|-----------|
| 31 | `@Override public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)` |
| 37 | `@Override public void onActivityCreated(Bundle savedInstanceState)` |
| 45 | `public void initViews()` |
| 98 | `private void getUserDetail()` |
| 102 | `private void onPhotoSaved()` |
| 115 | `private void uploadUserPhoto()` |
| 148 | `private void choosePhoto()` |
| 180 | `@Override public void onResume()` |
| 185 | `@Override public void onStop()` |
| 190 | `@Override public void onDestroy()` |
| 195 | `@Override public void onClick(View view)` |

---

### Findings for SetUserPhotoFragment.java

#### A66-6 — No test coverage for any method in SetUserPhotoFragment (HIGH)

**Severity:** HIGH
**Location:** Entire class

No test file exists for this fragment. The entire class is untested. All methods listed above have zero test coverage.

#### A66-7 — No test for uploadUserPhoto() when mBitmap is null in fromDashboard=false mode (MEDIUM)

**Severity:** MEDIUM
**Location:** `uploadUserPhoto()`, lines 115–145

When `mBitmap` is null and `fromDashboard` is false, the method calls `showToast("Take or select your photo first")` and returns early. This is the guard preventing a user from submitting without a photo. No test verifies this guard fires, meaning a regression that removes it would go undetected. There is also no test that the guard does not fire when `mBitmap` is non-null.

#### A66-8 — No test for uploadUserPhoto() network failure callback (MEDIUM)

**Severity:** MEDIUM
**Location:** `uploadUserPhoto()`, lines 132–144

The upload callback has two branches: success (line 136–139) and failure (line 139–142). The failure branch calls `hideProgress()` and `showToast("Failed to save...")`. No test exercises this failure path to verify the UI recovers correctly (progress hidden, error shown) without the activity being left in an unresponsive state.

#### A66-9 — No test for onPhotoSaved() navigation when activity is null (MEDIUM)

**Severity:** MEDIUM
**Location:** `onPhotoSaved()`, lines 102–113

When `fromDashboard` is false, `onPhotoSaved()` checks `if (activity != null)` before navigating to `SetupEmailFragment`. If `activity` is null (e.g., the fragment was not attached to a `SignupActivity`), the navigation silently does nothing. There is no test verifying whether this is the intended fallback or a silent failure. The complementary `fromDashboard=true` branch calls `getBaseActivity().onBackPressed()` with no null check on `getBaseActivity()`.

#### A66-10 — No test for choosePhoto() permission flow (LOW)

**Severity:** LOW
**Location:** `choosePhoto()`, lines 148–177

The method chains file permission → camera permission → image picker. No test covers any of these permission grant/deny outcomes: permission denied for file storage, permission denied for camera, or the image crop completing with a null bitmap.

#### A66-11 — No test for initViews() branch when fromDashboard=true (LOW)

**Severity:** LOW
**Location:** `initViews()`, lines 45–96

`initViews()` has three conditional branches depending on `mBitmap` (non-null vs null) and `fromDashboard` (true vs false). No test exercises the `fromDashboard=true` branch which hides the skip button and calls `UserPhotoFragment.showUserPhoto()`.

#### A66-12 — onClick() is an empty stub (INFO)

**Severity:** INFO
**Location:** `onClick()`, line 195–196

The class implements `View.OnClickListener` but `onClick()` is an empty method body. The click listener interface is satisfied by dedicated anonymous inner classes in `initViews()` instead. The empty `onClick()` stub is dead code. No test verifies it is intentionally empty, and future developers may mistakenly route clicks to it.

---

## File 3: SetupEmailFragment.java

### Reading Evidence

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.ui.fragment.SetupEmailFragment`

**Implements:** `View.OnClickListener`
**Superclass:** `FleetFragment`

**Fields defined:**
| Name | Type | Access | Line |
|------|------|--------|------|
| `activity` | `SignupActivity` | package-private | 32 |
| `mFromDashboard` | `boolean` | private | 33 |
| `getEmailResult` | `GetEmailResult` | private | 91 |

**Methods with line numbers and signatures:**
| Line | Signature |
|------|-----------|
| 35 | `public static SetupEmailFragment createInstance(boolean fromDashboard)` |
| 42 | `@Override public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)` |
| 49 | `@Override public void onActivityCreated(Bundle savedInstanceState)` |
| 57 | `@SuppressLint("SetTextI18n") public void initViews()` |
| 93 | `private void loadData()` |
| 112 | `private void onEmailLoaded()` |
| 124 | `private void saveEmail()` |
| 195 | `private void onSaved()` |
| 207 | `@Override public void onResume()` |
| 211 | `@Override public void onStop()` |
| 215 | `@Override public void onDestroy()` |
| 222 | `@Override public void onClick(View view)` |

**Supporting types read:**
- `GetEmailResult`: fields `int id`, `int driver_id`, `String email_addr1`–`email_addr4`
- `SetEmailsParameter`: fields `int driver_id`, `String email_addr1`–`email_addr4`

---

### Findings for SetupEmailFragment.java

#### A66-13 — No email format validation before submission; CommonFunc.isEmailInvalid() exists but is never called (MEDIUM)

**Severity:** MEDIUM
**Location:** `saveEmail()`, lines 124–193

`saveEmail()` constructs a `SetEmailsParameter` and submits it to the server with no validation of the email address strings entered by the user. The utility method `CommonFunc.isEmailInvalid(String)` exists in `au.com.collectiveintelligence.fleetiq360.util.CommonFunc` (line 85) and uses `android.util.Patterns.EMAIL_ADDRESS` to validate email format, but it is never called within `SetupEmailFragment`.

A user can therefore submit any arbitrary string — including empty strings, strings with no `@`, malformed addresses such as `"not-an-email"` — as an email address and the server API call will be made. The only current check is whether any checkbox is ticked (lines 130–159); the content of the email fields is never validated.

No test covers the case of a checked checkbox with an invalid email address string in the corresponding field.

**Untested paths:**
- Checkbox 1 checked, field 1 contains an empty string → sends `""` to server with no warning.
- Checkbox 1 checked, field 1 contains `"notanemail"` (no `@`) → sends invalid address to server with no warning.
- Checkbox 1 checked, field 1 contains `"user@"` (incomplete domain) → sends invalid address to server.
- Multiple checkboxes checked with mixed valid/invalid addresses.

#### A66-14 — No test for saveEmail() network failure path (MEDIUM)

**Severity:** MEDIUM
**Location:** `saveEmail()`, lines 168–193, specifically `onFailed()` callback at line 183

The failure callback calls `updateProgress("Failed to save...")` then uses `runLater()` to call `hideProgress()`. No test verifies that the fragment remains functional after a network failure (progress hidden, user can retry). A regression leaving the progress view visible indefinitely would not be caught.

#### A66-15 — No test for loadData() failure causing activity.finish() with null activity (MEDIUM)

**Severity:** MEDIUM
**Location:** `loadData()`, line 107

On failure, `loadData()` calls `Objects.requireNonNull(getActivity()).finish()`. If `getActivity()` returns null (fragment detached before the network response arrives), this throws `NullPointerException` from `requireNonNull`, crashing the app. No test exercises the detached-fragment failure path.

#### A66-16 — No test for createInstance() factory method (LOW)

**Severity:** LOW
**Location:** `createInstance()`, lines 35–39

`createInstance(boolean fromDashboard)` is the intended instantiation path for the fragment. No test verifies that calling `createInstance(true)` or `createInstance(false)` produces a fragment with the correct `mFromDashboard` state, or that the field is correctly used in `initViews()` and `saveEmail()`.

#### A66-17 — No test for initViews() branch differences between fromDashboard true and false (LOW)

**Severity:** LOW
**Location:** `initViews()`, lines 57–89

When `mFromDashboard` is true, `initViews()` sets the button label to "Save", hides the help text, and calls `loadData()`. When false, it sets the label to "Next", shows help text, and initialises `getEmailResult` with null fields. No test covers either branch, meaning a regression in label text, visibility logic, or the initiation of the load call would go undetected.

#### A66-18 — No test for onSaved() navigation when activity is null in non-dashboard mode (LOW)

**Severity:** LOW
**Location:** `onSaved()`, lines 195–204

When `mFromDashboard` is false, `onSaved()` checks `if (activity != null)` before starting `DashboardActivity` and calling `activity.finish()`. If `activity` is null, navigation silently fails with no feedback to the user. No test verifies this silent failure or confirms whether it is the intended behaviour.

#### A66-19 — Dialog typo in warning message is untested and user-visible (INFO)

**Severity:** INFO
**Location:** `saveEmail()`, line 137

The warning dialog message reads: `"No email confirmed. Are you you want sure to skip?"` — this is a grammatical error containing `"you you want sure"` where the intended text is presumably `"Are you sure you want to skip?"`. No test asserts the dialog message content, so this typo has been undetected. This is a user-facing display defect.

#### A66-20 — onClick() is an empty stub (INFO)

**Severity:** INFO
**Location:** `onClick()`, lines 222–223

Same pattern as `SetUserPhotoFragment`: the class declares `implements View.OnClickListener` but the `onClick()` method is empty. Actual click handling is done through anonymous inner classes. The stub is dead code with no test verifying it is intentionally empty.

---

## Summary Table

| ID | File | Severity | Description |
|----|------|----------|-------------|
| A66-0 | Project-wide | HIGH | No test directories exist in app/ or LibCommon/ modules |
| A66-1 | ServiceStatsListAdapter | MEDIUM | Silent `Integer.valueOf()` exception swallows non-integer server data; displays misleading "0 Services" |
| A66-2 | ServiceStatsListAdapter | LOW | No test for `getView()` view-recycling (non-null convertView) path |
| A66-3 | ServiceStatsListAdapter | LOW | No test for `getCount()` with empty list |
| A66-4 | ServiceStatsListAdapter | LOW | No test for `getItem()` out-of-bounds path |
| A66-5 | ServiceStatsListAdapter | INFO | Constructor stores direct reference to caller's list; no defensive copy |
| A66-6 | SetUserPhotoFragment | HIGH | Entire class has zero test coverage |
| A66-7 | SetUserPhotoFragment | MEDIUM | No test for `uploadUserPhoto()` null-bitmap guard in non-dashboard mode |
| A66-8 | SetUserPhotoFragment | MEDIUM | No test for `uploadUserPhoto()` network failure callback |
| A66-9 | SetUserPhotoFragment | MEDIUM | No test for `onPhotoSaved()` null activity silent failure |
| A66-10 | SetUserPhotoFragment | LOW | No test for `choosePhoto()` permission grant/deny outcomes |
| A66-11 | SetUserPhotoFragment | LOW | No test for `initViews()` `fromDashboard=true` branch |
| A66-12 | SetUserPhotoFragment | INFO | `onClick()` is an empty stub; dead code |
| A66-13 | SetupEmailFragment | MEDIUM | No email format validation before submission; `CommonFunc.isEmailInvalid()` exists but is never called |
| A66-14 | SetupEmailFragment | MEDIUM | No test for `saveEmail()` network failure path |
| A66-15 | SetupEmailFragment | MEDIUM | No test for `loadData()` failure with detached fragment; `requireNonNull` will crash if `getActivity()` returns null |
| A66-16 | SetupEmailFragment | LOW | No test for `createInstance()` factory method |
| A66-17 | SetupEmailFragment | LOW | No test for `initViews()` branching on `mFromDashboard` |
| A66-18 | SetupEmailFragment | LOW | No test for `onSaved()` null activity silent failure |
| A66-19 | SetupEmailFragment | INFO | User-visible typo in warning dialog message; no test asserts dialog content |
| A66-20 | SetupEmailFragment | INFO | `onClick()` is an empty stub; dead code |
