# Audit Pass 2 — Agent A44
**Audit run:** 2026-02-26-01
**Assigned files:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/autoupdate/service/APKUpdateServiceFactory.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/autoupdate/util/OkHttpClientFactory.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/autoupdate/util/TokenAuthenticator.java`

---

## Project-Wide Finding: Zero Automated Test Coverage (app/ and LibCommon/)

**Finding ID:** A44-0
**Severity:** HIGH

The `app/` module and the `LibCommon/` module contain no test directories whatsoever — no `src/test/`, no `src/androidTest/` source sets exist under either module. The only test files found in the entire repository are in third-party library modules (`LibImageloader`, `LibImagePicker`, `LibPercentProgress`) and are boilerplate stubs unrelated to application logic.

This means every class in `app/` — including all security-critical networking, authentication, SSL configuration, session management, and business logic — runs entirely without automated verification. All findings below describe gaps where tests would normally exist; in this project, there is no test infrastructure at all to fill those gaps.

---

## Reading Evidence

### File 1: APKUpdateServiceFactory.java

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.autoupdate.service.APKUpdateServiceFactory`

**Methods (with line numbers and signatures):**

| Line | Signature |
|------|-----------|
| 10 | `public static APKUpdateService getService()` |

**Fields / Constants:** None declared.

**Imports / dependencies noted:**
- `BuildConfig` — `BASE_URL` field consumed at line 14; value varies by product flavor (all HTTPS in dev/uat/prod; local flavor derives from machine IP at build time).
- `OkHttpClientFactory.getOkHttpClient()` — called at line 11; this is the trust-all SSL factory (see File 2).
- `Retrofit.Builder` — constructs a Retrofit client at lines 13–17.
- `GsonConverterFactory` — JSON deserializer.
- Returns a Retrofit proxy implementing `APKUpdateService` (interface with `getLatestAvailableUpdate` and `downloadPackage`).

**Behavior summary:**
`getService()` is a static factory. It delegates all HTTP configuration — including SSL and authentication — to `OkHttpClientFactory`. It also performs a trailing-slash normalisation on `BASE_URL`. There is no error handling; any exception thrown by `OkHttpClientFactory` propagates as an unchecked `RuntimeException` (thrown inside that factory).

---

### File 2: OkHttpClientFactory.java

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.autoupdate.util.OkHttpClientFactory`

**Methods (with line numbers and signatures):**

| Line | Signature |
|------|-----------|
| 13 | `public static OkHttpClient getOkHttpClient()` |

**Fields / Constants:** None declared.

**Anonymous / inner types defined:**
- Anonymous `HostnameVerifier` at lines 18–24: `verify(String hostname, SSLSession session)` unconditionally returns `true`. Suppressed with `@SuppressLint("BadHostnameVerifier")`.

**Imports / dependencies noted:**
- `FakeX509TrustManager.getUnsafeSSLContext()` — returns an `SSLContext` backed by a no-op `X509TrustManager` that accepts every certificate.
- `FakeX509TrustManager` instance — installed as the `X509TrustManager` argument to `sslSocketFactory()`.
- `Dispatcher` — max concurrent requests set to 1 (line 27).
- `TokenAuthenticator` — installed as the OkHttp `Authenticator` (line 29); handles 401 responses.

**Behavior summary:**
`getOkHttpClient()` builds an `OkHttpClient` that:
1. Accepts every TLS certificate without validation (trust-all via `FakeX509TrustManager`).
2. Accepts every hostname without validation (anonymous `HostnameVerifier` always returning `true`).
3. Limits concurrency to one request at a time.
4. Installs `TokenAuthenticator` for 401 retry.
Any exception during SSL context construction is re-thrown as a `RuntimeException`.

---

### File 3: TokenAuthenticator.java

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.autoupdate.util.TokenAuthenticator`
(Package-private class; not accessible outside the `autoupdate.util` package.)

**Methods (with line numbers and signatures):**

| Line | Signature |
|------|-----------|
| 27 | `public Request authenticate(@Nullable Route route, @NonNull Response response) throws IOException` |
| 36 | `private GetTokenResult getAccessToken() throws IOException` |

**Fields / Constants:** None declared.

**Imports / dependencies noted:**
- `FakeX509TrustManager.allowAllSSL()` — called at line 39 inside `getAccessToken()`. This calls `HttpsURLConnection.setDefaultHostnameVerifier(...)` and `HttpsURLConnection.setDefaultSSLSocketFactory(...)` as **JVM-global** side-effects, affecting all `HttpsURLConnection` instances in the process.
- `WebData.instance().getTokenFormData()` — produces URL-encoded credentials (`grant_type=password`, hardcoded `client_id=987654321`, hardcoded `client_secret=8752361E593A573E86CA558FFD39E`, hardcoded `username=gas`, hardcoded `password=ciiadmin`) — confirmed by reading `WebData.java`.
- `BuildConfig.BASE_URL` — token endpoint is `BASE_URL + "/oauth/token"` (line 37).
- `Gson` — deserialises the token response into `GetTokenResult`.
- `HttpsURLConnection` — used for the raw token fetch (not OkHttp).

**Behavior summary:**
On each 401 response received by OkHttp, `authenticate()` is called. It invokes `getAccessToken()`, which:
1. Globally disables SSL certificate validation and hostname verification for the JVM process via `FakeX509TrustManager.allowAllSSL()`.
2. Opens a raw `HttpsURLConnection` to `BASE_URL/oauth/token`.
3. POSTs hardcoded credentials.
4. On HTTP 200 returns a parsed `GetTokenResult`.
5. On any non-200 response returns `null`, causing OkHttp to abort the request.
If `getAccessToken()` returns a non-null result, `authenticate()` rebuilds the request with a fresh `Authorization` header (token type + value). OkHttp will retry — there is no per-request retry count guard internal to this class; OkHttp's built-in limit applies (max 20 by default, but that is OkHttp internal behaviour, not enforced here).

---

## Findings

### A44-1 — No test file exists for APKUpdateServiceFactory

**Severity:** HIGH
**File:** `APKUpdateServiceFactory.java`
**Lines:** 10–20 (entire class)

There is no test file for `APKUpdateServiceFactory` anywhere in the repository. The class has one method, `getService()`, that is entirely untested:

- No test verifies that `getService()` returns a non-null proxy.
- No test verifies that the Retrofit instance is configured with the correct base URL (including trailing-slash normalisation logic at line 14).
- No test verifies that the returned service is an implementation of `APKUpdateService`.
- No test verifies that `getService()` propagates a `RuntimeException` when `OkHttpClientFactory.getOkHttpClient()` throws.
- No test verifies that the Gson converter factory is installed.

The trailing-slash normalisation (`BASE_URL.endsWith("/") ? BASE_URL : BASE_URL + "/"`) contains a conditional branch at line 14 that is completely untested. Both the "already has slash" and "missing slash" branches need independent verification.

---

### A44-2 — No test file exists for OkHttpClientFactory; trust-all SSL is installed with no test boundary

**Severity:** CRITICAL
**File:** `OkHttpClientFactory.java`
**Lines:** 13–34 (entire method)

`OkHttpClientFactory.getOkHttpClient()` unconditionally installs a trust-all TLS configuration on every `OkHttpClient` it produces:

- `FakeX509TrustManager.getUnsafeSSLContext()` (line 16) returns an `SSLContext` where `checkServerTrusted()` is a no-op — it accepts every certificate, including self-signed, expired, and maliciously substituted certificates.
- `new FakeX509TrustManager()` (line 17) is installed as the `X509TrustManager`, making the trust-all behaviour explicit to OkHttp's internal certificate pinner.
- The anonymous `HostnameVerifier` at lines 18–24 unconditionally returns `true`, suppressed with `@SuppressLint("BadHostnameVerifier")`.

There are no tests whatsoever for this class:

- No test verifies that this client is never used with a production `BASE_URL` in a release build.
- No test verifies that a safe (system-trust-store) client is used instead when `BuildConfig.DEBUG` is false.
- No test verifies that a MITM-substituted certificate causes a connection failure (it does not — the code deliberately prevents this).
- No test documents or guards the intent: is this trust-all configuration intentional for all environments including production, or is it a leftover development bypass?

The class name (`OkHttpClientFactory`, not `UnsafeOkHttpClientFactory`) gives no indication that it produces a security-disabled client. Any caller that obtains a client from this factory for production network traffic receives one that cannot detect MITM attacks. No automated test constrains this behaviour or verifies it is scoped to non-production environments.

---

### A44-3 — No test file exists for TokenAuthenticator; allowAllSSL() is a process-global side-effect with no test

**Severity:** CRITICAL
**File:** `TokenAuthenticator.java`
**Lines:** 39 (within `getAccessToken()`), 36–61 (full method)

`TokenAuthenticator.getAccessToken()` calls `FakeX509TrustManager.allowAllSSL()` at line 39 on every invocation. `allowAllSSL()` calls `HttpsURLConnection.setDefaultHostnameVerifier(...)` and `HttpsURLConnection.setDefaultSSLSocketFactory(...)`. These are **static, JVM-process-global setters** — they replace the default SSL configuration for every subsequent `HttpsURLConnection` opened anywhere in the application process, including those opened by other threads or other components that did not intend to disable SSL validation.

No tests exist for any aspect of this class:

- No test verifies that after `authenticate()` completes, the JVM-global `HttpsURLConnection` defaults are restored to the pre-call values (they are not restored — the side-effect is permanent for the process lifetime).
- No test verifies that `authenticate()` correctly attaches the refreshed token to the rebuilt request (lines 31–33).
- No test verifies that `authenticate()` returns `null` when `getAccessToken()` fails (i.e., when the token server returns non-200), causing OkHttp to give up.
- No test verifies that `authenticate()` returns `null` when `getAccessToken()` throws an `IOException`.
- No test verifies the infinite-refresh-loop risk (see A44-4).
- No test verifies that the `Authorization` header is formatted correctly (`tokenType + " " + value` at line 32) when `tokenType` is null, or when `value` is null — both are nullable fields on `GetTokenResult`.
- No test verifies the response-body parsing at lines 55–60 for malformed JSON, empty body, or partial JSON from `GetTokenResult`.

---

### A44-4 — No test guards against infinite token-refresh loop

**Severity:** HIGH
**File:** `TokenAuthenticator.java`
**Lines:** 27–34 (`authenticate()` method)

OkHttp calls `Authenticator.authenticate()` on every 401 response. `TokenAuthenticator.authenticate()` always attempts to fetch a new token and rebuild the request. If the token server consistently returns 200 but the new token is still rejected by the API server (returning 401 again), OkHttp will call `authenticate()` up to its internal retry limit (20 retries by default in OkHttp 3.x). This results in up to 20 repeated token fetches and 20 repeated requests before OkHttp gives up.

There is no guard in `TokenAuthenticator` that:
- Checks whether the response already used a token (i.e., the `Authorization` header is already present on the request).
- Returns `null` immediately if the request already carried a fresh token (the standard OkHttp pattern to prevent retry loops).

No test exercises this scenario. The standard defensive pattern is:
```java
if (response.request().header("Authorization") != null) return null;
```
This is absent. Without a test that sends multiple 401 responses in sequence, this loop behaviour is invisible.

---

### A44-5 — No test verifies Gson deserialisation of null or partial token response

**Severity:** MEDIUM
**File:** `TokenAuthenticator.java`
**Lines:** 59 (`new Gson().fromJson(response.toString(), GetTokenResult.class)`)

`getAccessToken()` uses `new Gson().fromJson(...)` to parse the token server response. Gson's `fromJson` will:
- Return `null` if the JSON string is `"null"`.
- Return an object with all fields at their Java defaults (null strings, 0 ints, false booleans) if the JSON is `{}`.
- Throw `JsonSyntaxException` (unchecked) if the response body is not valid JSON.

`authenticate()` only null-checks the result of `getAccessToken()` at line 29. If Gson returns a non-null `GetTokenResult` with `null` tokenType and `null` value, `authenticate()` still constructs an `Authorization` header with value `"null null"` (or `"null "`, depending on null coercion). No test verifies these cases:

- Token server returns `"null"` as body.
- Token server returns `{}` (empty object).
- Token server returns malformed JSON (e.g., HTML error page).
- `GetTokenResult.tokenType` is null.
- `GetTokenResult.value` is null.

---

### A44-6 — No test verifies trailing-slash normalisation in APKUpdateServiceFactory

**Severity:** MEDIUM
**File:** `APKUpdateServiceFactory.java`
**Line:** 14

The expression:
```java
BuildConfig.BASE_URL.endsWith("/") ? BuildConfig.BASE_URL : BuildConfig.BASE_URL + "/"
```
has two branches. No test exercises the branch where `BASE_URL` already ends with `/` (normalised form), and no test exercises the branch where it does not (requiring appending). Retrofit requires an absolute base URL with a trailing slash; if `BASE_URL` is an empty string or null (which could occur in certain build configurations), this line will throw a `NullPointerException` or produce an invalid URL silently accepted by Retrofit until the first actual request fails at runtime.

---

### A44-7 — No test verifies OkHttpClientFactory exception path produces RuntimeException

**Severity:** MEDIUM
**File:** `OkHttpClientFactory.java`
**Lines:** 31–33

```java
} catch (Exception e) {
    throw new RuntimeException(e);
}
```

The catch block wraps all exceptions from the SSL context setup in a `RuntimeException`. No test verifies:
- That this exception is thrown when `FakeX509TrustManager.getUnsafeSSLContext()` fails (e.g., "TLS" algorithm not found).
- That the calling code in `APKUpdateServiceFactory.getService()` handles or propagates this exception.
- That any UI layer survives the `RuntimeException` without crashing the process silently at the point of first network use.

---

### A44-8 — No test verifies TokenAuthenticator handles IOException from getAccessToken

**Severity:** MEDIUM
**File:** `TokenAuthenticator.java`
**Lines:** 27 (`authenticate()` signature declares `throws IOException`)

`authenticate()` propagates `IOException` from `getAccessToken()` (network failure, connection timeout, DNS failure). OkHttp handles a thrown `IOException` from the authenticator by failing the original request. No test verifies:

- That a network failure during token refresh causes the original call to fail with an `IOException` (not a hang or silent drop).
- That the `DataOutputStream` at lines 48–51 and the `BufferedReader` at lines 55–60 are properly closed on exception. The `wr` stream at lines 48–51 is not inside a try-with-resources block; if `wr.writeBytes()` throws, `wr` is not closed.

---

### A44-9 — DataOutputStream not closed on exception path

**Severity:** MEDIUM
**File:** `TokenAuthenticator.java`
**Lines:** 48–51

```java
DataOutputStream wr = new DataOutputStream(urlConnection.getOutputStream());
wr.writeBytes(WebData.instance().getTokenFormData());
wr.flush();
wr.close();
```

`wr` is declared outside any try-with-resources or finally block. If `wr.writeBytes(...)` or `wr.flush()` throws an `IOException`, `wr.close()` is never called. This leaks the output stream. No test exercises the write-failure path. By contrast, the `BufferedReader` at lines 55–60 correctly uses try-with-resources. The inconsistency is undetected because there are no tests.

---

### A44-10 — No test verifies that trust-all SSL is scoped to non-production builds

**Severity:** HIGH
**File:** `OkHttpClientFactory.java` and `TokenAuthenticator.java`
**Lines:** OkHttpClientFactory 16–24; TokenAuthenticator 39

All production `BASE_URL` values are HTTPS endpoints on real servers (`pandora.fleetiq360.com`, `ec2-54-86-82-22.compute-1.amazonaws.com:8443`, `forklift360.canadaeast.cloudapp.azure.com:8443`). The trust-all SSL client created by `OkHttpClientFactory` is used for all APK update checks and token refreshes, including production builds. The `allowAllSSL()` call in `TokenAuthenticator` similarly applies to production.

There is no conditional on `BuildConfig.DEBUG` or on the product flavor. No test asserts that a production/release build uses a properly validated SSL client. The behaviour in production is identical to the behaviour in development: all TLS certificates are accepted without validation. This cannot be detected at runtime and would not be caught without a test that inspects the installed `SSLSocketFactory` and `HostnameVerifier` per build type.

---

### A44-11 — APKUpdateServiceFactory returns a Retrofit service wrapping a trust-all client, but the Retrofit service interface is also untested

**Severity:** LOW
**File:** `APKUpdateServiceFactory.java`
**Lines:** 10–20 (entire factory)

`APKUpdateService` defines two endpoints: `getLatestAvailableUpdate` and `downloadPackage`. Neither endpoint is tested through the service layer:

- No test verifies that `getLatestAvailableUpdate` constructs the correct URL path (`rest/apk/{pkgname}/update` with the `version` query parameter).
- No test verifies that `downloadPackage` correctly passes through an arbitrary `@Url`.
- No mock-server (e.g., OkHttp `MockWebServer`) integration test exercises either endpoint.

---

### A44-12 — TokenAuthenticator uses hardcoded credentials sourced from WebData with no test isolation

**Severity:** INFO
**File:** `TokenAuthenticator.java`
**Line:** 49 (`WebData.instance().getTokenFormData()`)

`WebData.getTokenFormData()` returns a URL-encoded string containing hardcoded values: `client_id=987654321`, `client_secret=8752361E593A573E86CA558FFD39E`, `username=gas`, `password=ciiadmin`. These are embedded in `WebData.java` as local string literals.

`TokenAuthenticator` calls this via the singleton `WebData.instance()`. Because `WebData` is a singleton with no injection seam, it cannot be replaced in a test without modifying production code. There is no interface behind `WebData`, no way to supply a test double, and no existing test that verifies what credentials are actually sent during token refresh. This design prevents unit testing of the authenticator in isolation and is noted as an architecture-level testability gap.
