# Audit Pass 2 – Test Coverage
**Agent:** A65
**Audit run:** 2026-02-26-01
**Assigned files:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/ServiceEditFragment.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/ServiceRecordFragment.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/ServiceRecordListAdapter.java`

---

## Project-Wide Finding

### A65-1 — HIGH: Zero automated test coverage in `app/` and `LibCommon/` modules

The `app/` module and the `LibCommon/` module contain no test directories whatsoever — neither `src/test/` (JVM unit tests) nor `src/androidTest/` (instrumented tests). The only test files found in the entire repository belong to third-party library modules (`LibImageloader`, `LibImagePicker`, `LibPercentProgress`) and are not authored by the project team.

All production logic across the application — UI fragments, web service calls, data parsing, business rules — is entirely untested. Every finding below describes specific coverage gaps within this context of zero overall coverage.

---

## Reading Evidence

### File 1: `ServiceEditFragment.java`

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.ui.fragment.ServiceEditFragment`
**Superclass:** `FleetFragment` (which extends `Fragment`)

**Fields/constants defined:**

| Name | Type | Line |
|------|------|------|
| `TAG` | `private static String` | 39 |
| `mRecordItems` | `ArrayList<ServiceRecordItem>` | 41 |
| `mCurrentIndex` | `int` | 42 |
| `mServiceRecordItem` | `ServiceRecordItem` | 43 |
| `status_text` | `TextView` | 45 |
| `hours_to_next_service` | `TextView` | 46 |
| `accumulate_hour` | `TextView` | 47 |
| `toggle_by_hours` | `RadioImageButton` | 48 |
| `toggle_by_interval` | `RadioImageButton` | 49 |
| `service_at` | `EditText` | 50 |
| `service_interval` | `EditText` | 51 |
| `service_title` | `TextView` | 52 |
| `previous_record` | `View` | 53 |
| `next_record` | `View` | 54 |
| `equipment_name` | `TextView` | 55 |
| `fromProfile` | `public boolean` | 56 |

**Methods defined:**

| Line | Signature |
|------|-----------|
| 58 | `public static ServiceEditFragment createInstance(ArrayList<ServiceRecordItem> recordItems, int currentIndex)` |
| 67 | `public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)` |
| 73 | `public void initViews()` |
| 137 | `void setData()` |
| 177 | `void initNaviButton()` |
| 197 | `void onNext()` |
| 208 | `void onPrevious()` |
| 218 | `void updateServiceTitle()` |
| 231 | `ServiceRecordItem getCurrentRecordItem()` |
| 241 | `public void onMiddleButton(View view)` |
| 248 | `public void onRightButton(View view)` |
| 345 | `void onServiceEdited()` |

---

### File 2: `ServiceRecordFragment.java`

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.ui.fragment.ServiceRecordFragment`
**Superclass:** `FleetFragment`

**Fields/constants defined:**

| Name | Type | Line |
|------|------|------|
| `listAdapter` | `private ServiceRecordListAdapter` | 32 |
| `listData` | `private ArrayList<ServiceRecordItem>` | 33 |
| `TYPE_SET_HOURS` | `final static String` = `"setHrs"` | 35 |
| `TYPE_SET_INTERVAL` | `final static String` = `"setDur"` | 36 |
| `mChart` | `private PieChart` | 37 |
| `STATUS_NORMAL` | `private static final int` = `0` | 39 |
| `STATUS_DUE` | `private static final int` = `1` | 40 |
| `STATUS_OVERDUE` | `private static final int` = `2` | 41 |
| `STATUS_NOT_SET` | `private static final int` = `3` | 42 |
| `SERVICE_DUE_HOURS` | `private static final int` = `25` | 43 |
| `fromProfile` | `boolean` = `true` | 45 |
| `serviceRecordResultArray` | `private ServiceRecordResultArray` | 46 |

**Methods defined:**

| Line | Signature |
|------|-----------|
| 48 | `static int getStatus(ServiceRecordItem recordItem)` |
| 76 | `static int getColorForStatus(int status)` |
| 95 | `static String getTextForStatus(Context context, int status)` |
| 115 | `private static String getLabelForStatus(int status)` |
| 137 | `public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)` |
| 142 | `public void initViews()` |
| 170 | `private void showServiceDetail(int position)` |
| 176 | `private void loadData()` |
| 199 | `public void onMiddleButton(View view)` |
| 205 | `private void onData(ServiceRecordResultArray result)` |
| 225 | `private void initServiceChart()` |
| 231 | `private ArrayList<Integer> getColorForPieEntry(ArrayList<PieEntry> pieEntries)` |
| 247 | `private ArrayList<PieEntry> getServicePieData()` |
| 304 | `private void setData()` |

---

### File 3: `ServiceRecordListAdapter.java`

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.ui.fragment.ServiceRecordListAdapter`
**Superclass:** `ArrayAdapter<ServiceRecordItem>`

**Fields/constants defined:**

| Name | Type | Line |
|------|------|------|
| `context` | `private Context` | 18 |
| `mData` | `private ArrayList<ServiceRecordItem>` | 19 |

**Inner types defined:**

| Name | Type | Line |
|------|------|------|
| `ListHolder` | `static class` | 71 |
| `ListHolder.name` | `TextView` | 72 |
| `ListHolder.status_bar` | `View` | 73 |
| `ListHolder.status_text` | `TextView` | 74 |

**Methods defined:**

| Line | Signature |
|------|-----------|
| 21 | `ServiceRecordListAdapter(Context context, ArrayList<ServiceRecordItem> data)` |
| 29 | `public View getView(int position, View convertView, @NonNull ViewGroup parent)` |
| 62 | `public int getCount()` |
| 67 | `public ServiceRecordItem getItem(int i)` |

---

## File-Specific Findings

---

### ServiceEditFragment.java

#### A65-2 — HIGH: `onRightButton()` calls `Integer.valueOf()` on raw user input with no exception handling — guaranteed crash on non-integer input

**Location:** `ServiceEditFragment.java`, lines 254 and 261

`Integer.valueOf(String)` throws `NumberFormatException` (an unchecked `RuntimeException`) when the supplied string cannot be parsed as an integer. The code calls it twice on strings obtained directly from `EditText` fields:

```java
// Line 253-254
String sa = service_at.getText().toString();
Integer lastService = Integer.valueOf(sa);    // throws NumberFormatException if sa is "", "abc", "1.5", etc.

// Line 260-261
sa = service_interval.getText().toString();
Integer serviceInterval = Integer.valueOf(sa); // same issue
```

The `null` checks immediately following (lines 255–257, 262–269) are dead code: `Integer.valueOf()` never returns `null` — it either returns a boxed integer or throws. Therefore if a user submits an empty field, a decimal value (e.g. `"12.5"`), letters, or any non-integer string, an unhandled `NumberFormatException` propagates through the call stack and crashes the application. There is no `try/catch` anywhere in the method or its callers.

No test exercises this path. A single test submitting an empty string, a decimal, or alphabetic characters in either field would expose the crash immediately.

#### A65-3 — HIGH: No test for null return from `getCurrentRecordItem()` in `onRightButton()` and `setData()`

**Location:** `ServiceEditFragment.java`, lines 231–238, and callers at lines 248–342, 137–175

`getCurrentRecordItem()` returns `null` when `mCurrentIndex >= mRecordItems.size()`. Both `onRightButton()` and `setData()` call this method and immediately dereference the result without a null check:

- `onRightButton()` line 272: `if(lastService > mServiceRecordItem.acc_hours)` — `mServiceRecordItem` is set at line 139 from `getCurrentRecordItem()` inside `setData()`; if `getCurrentRecordItem()` returns null, the dereference at line 141 (`mServiceRecordItem.unit_name`) in `setData()` crashes.
- `onRightButton()` lines 312–316 and 320–324: `getCurrentRecordItem()` is called again and the result is immediately chained (e.g. `getCurrentRecordItem().service_type = ...`). If navigation state has changed between the initial load and the save callback, this can return null and crash.

No test covers the scenario where `mCurrentIndex` equals or exceeds `mRecordItems.size()`.

#### A65-4 — MEDIUM: No test for `onNext()` at upper boundary — index not advancing past size-1

**Location:** `ServiceEditFragment.java`, lines 197–206

`onNext()` guards against advancing past the last item (`mCurrentIndex < mRecordItems.size()-1`), but no test verifies that pressing Next when already at the last item is a no-op and does not corrupt state or trigger a crash via the subsequent `setData()` call. The `setData()` → `getCurrentRecordItem()` path described in A65-3 is reachable here if the guard ever fails.

#### A65-5 — MEDIUM: No test for `onPrevious()` at lower boundary

**Location:** `ServiceEditFragment.java`, lines 208–215

`onPrevious()` guards against decrementing below zero, but no test verifies the boundary behaviour when `mCurrentIndex` is already 0.

#### A65-6 — MEDIUM: No test for `setData()` when `service_type` is `null`

**Location:** `ServiceEditFragment.java`, lines 151–174

`setData()` has four branches based on `mServiceRecordItem.service_type`. The `null` branch (lines 151–156) is reached when no service type has been configured. No test exercises this branch. Per `ServiceRecordItem.java` lines 61–64, `service_type` is only set when the JSON field is non-null, so newly provisioned units or units without service configuration will hit this path on every render.

#### A65-7 — MEDIUM: No test for `setData()` when `service_type` is an unexpected/unknown string value

**Location:** `ServiceEditFragment.java`, lines 169–174

The final `else` branch handles any `service_type` value that is neither `null`, `"setHrs"`, nor `"setDur"`. If the server introduces a new type value or sends a malformed value, this branch silently degrades by treating the record as if it has no service type. No test verifies this fallback behaviour produces a sensible UI state.

#### A65-8 — MEDIUM: No test for `initViews()` with `fromProfile = false`

**Location:** `ServiceEditFragment.java`, lines 73–135

`initViews()` branches on `fromProfile` to configure the bottom bar (lines 76–85). The `fromProfile = false` branch omits the MAINTENANCE button (passing `-1` as the icon resource). No test verifies this configuration path, including whether passing `-1` as a drawable resource ID causes a crash in `initBottomBar()`.

#### A65-9 — MEDIUM: `onRightButton()` does not validate that `lastService` is non-negative

**Location:** `ServiceEditFragment.java`, lines 253–275

The validation at line 272 only checks `lastService > mServiceRecordItem.acc_hours`. A negative integer (e.g. user enters `-1`) passes `Integer.valueOf()` successfully, passes the null check (which is dead code anyway), and passes the `> acc_hours` check if `acc_hours` is 0 or negative. A negative `last_serv` value would be sent to the server. No test covers negative numeric input.

#### A65-10 — MEDIUM: `onRightButton()` does not validate that `serviceInterval` is positive

**Location:** `ServiceEditFragment.java`, lines 277–300

When `toggle_by_hours` is checked, the validation at line 279 checks `serviceInterval < mServiceRecordItem.acc_hours`. A zero or negative `serviceInterval` passes this check if `acc_hours` is 0. No test covers zero or negative values for service interval.

#### A65-11 — MEDIUM: No test for `onRightButton()` network failure path (`onFailed`)

**Location:** `ServiceEditFragment.java`, lines 338–342

The `WebListener.onFailed()` callback calls `hideProgress()` and `showErrDialog()`. No test exercises this error path to verify that progress UI is correctly hidden and that the error dialog is displayed with the correct message.

#### A65-12 — LOW: `onServiceEdited()` is an empty method — never called and never tested

**Location:** `ServiceEditFragment.java`, lines 345–347

`onServiceEdited()` has an empty body and is never called from within this file or (based on the confirmed absence of test directories) from anywhere under test. It appears to be scaffolding left incomplete. No test documents its intended contract.

#### A65-13 — LOW: No test for `createInstance()` with empty list or out-of-range `currentIndex`

**Location:** `ServiceEditFragment.java`, lines 58–63

`createInstance()` assigns `mRecordItems` and `mCurrentIndex` without bounds checking. Passing an empty list with `currentIndex = 0` will cause `getCurrentRecordItem()` to return `null` on first use, which propagates to a crash in `setData()`. No test covers this construction path.

#### A65-14 — LOW: No test for `updateServiceTitle()` when neither toggle is checked

**Location:** `ServiceEditFragment.java`, lines 218–228

`updateServiceTitle()` branches on `toggle_by_hours.isChecked()`. When neither toggle is checked (the `else` branch), the title defaults to "Perform Service Every:" using `mServiceRecordItem.serv_duration`. No test verifies this state, nor verifies that both toggles being simultaneously checked is prevented by the mutual-exclusion logic in `initViews()`.

---

### ServiceRecordFragment.java

#### A65-15 — HIGH: No test for `getStatus()` — the primary business logic method used across three classes

**Location:** `ServiceRecordFragment.java`, lines 48–74

`getStatus()` is the central decision function. It is consumed by `ServiceEditFragment.setData()`, `ServiceRecordListAdapter.getView()`, and `ServiceRecordFragment.getServicePieData()`. It contains multiple conditional branches with boundary logic around `SERVICE_DUE_HOURS = 25`. Zero tests cover:

- `recordItem == null` → returns `STATUS_NOT_SET`
- `recordItem.service_type == null` → returns `STATUS_NOT_SET`
- `service_due == 0` AND `acc_hours == 0` → returns `STATUS_NOT_SET`
- `service_due > 25` → returns `STATUS_NORMAL`
- `service_due == 25` (boundary: `> 0` and `<= 25`) → returns `STATUS_DUE`
- `service_due == 1` (lower bound of DUE range) → returns `STATUS_DUE`
- `service_due == 0` with non-zero `acc_hours` → returns `STATUS_OVERDUE`
- `service_due < 0` (negative) → returns `STATUS_OVERDUE`
- `service_due == 26` (one above the `SERVICE_DUE_HOURS` threshold) → returns `STATUS_NORMAL`

The boundary at exactly `service_due = 25` is particularly noteworthy: the `STATUS_NORMAL` check is `> SERVICE_DUE_HOURS` (strictly greater) so `service_due = 25` falls into the `STATUS_DUE` branch, not `STATUS_NORMAL`. This off-by-one boundary is untested.

Additionally, the case `service_due == 0` with `acc_hours > 0` is not caught by the early `STATUS_NOT_SET` guard (line 57 requires both to be 0), so it falls through to the `service_due <= 0` check (line 69) and returns `STATUS_OVERDUE`. This is a subtle behaviour with no test to document or verify it as intentional.

#### A65-16 — MEDIUM: No test for `getColorForStatus()` with all four status values

**Location:** `ServiceRecordFragment.java`, lines 76–93

`getColorForStatus()` maps each integer status constant to a color resource ID. No test verifies any of the four branches, including the fallback at line 92 which returns `service_status_not_set` for any unrecognised integer. Since the method returns resource IDs (ints), this function is easily unit-testable with no Android framework dependency.

#### A65-17 — MEDIUM: No test for `getTextForStatus()` with all four status values and fallback

**Location:** `ServiceRecordFragment.java`, lines 95–113

`getTextForStatus()` maps each status to a localised string. No test covers any branch. The fallback at line 112 silently returns `service_status_not_set` for unknown status codes.

#### A65-18 — MEDIUM: No test for `getLabelForStatus()` — label strings are derived dynamically from `SERVICE_DUE_HOURS`

**Location:** `ServiceRecordFragment.java`, lines 115–133

`getLabelForStatus()` builds label strings like `"Due > 25h"` using `SERVICE_DUE_HOURS` at runtime. If `SERVICE_DUE_HOURS` is changed, the pie chart labels change but `getColorForPieEntry()` compares against labels produced by `getLabelForStatus()` using string equality. No test verifies this coupling, and the fallback returns `"None"` for unknown status codes silently.

#### A65-19 — MEDIUM: No test for `getServicePieData()` — multiple edge cases untested

**Location:** `ServiceRecordFragment.java`, lines 247–302

`getServicePieData()` aggregates status counts and builds `PieEntry` objects. Untested scenarios include:

- Empty `listData` (returns empty list — line 269 guard)
- All items in one status category (e.g. all overdue)
- A single item in each category
- Mixed distribution across all four categories
- Floating-point percentage arithmetic: `(none * 100.0f) / total` — not validated for rounding consistency

#### A65-20 — MEDIUM: No test for `onData()` when `result.arrayList` is empty

**Location:** `ServiceRecordFragment.java`, lines 205–223

When the server returns an empty list, `onData()` shows a "no service" tips view and hides the chart. When the list is non-empty, it hides the tips view and shows the chart. No test exercises either branch, nor verifies the `Objects.requireNonNull(listData)` at line 212 (which throws `NullPointerException` — not caught — if `listData` was somehow set to null between lines 207 and 212).

#### A65-21 — MEDIUM: No test for `loadData()` when `serviceRecordResultArray` is already cached

**Location:** `ServiceRecordFragment.java`, lines 176–196

`loadData()` has an early-return path at lines 177–180 that uses a cached result to avoid a network call. No test verifies that this cache path populates the UI correctly, nor that the network path (`WebApi.async().getServiceRecord()`) error callback (`onFailed`) hides the loading layout before showing the error dialog.

#### A65-22 — LOW: No test for `getColorForPieEntry()` — label string matching is fragile

**Location:** `ServiceRecordFragment.java`, lines 231–245

`getColorForPieEntry()` matches `PieEntry` label strings using `.equals()`. The label strings are dynamically constructed by `getLabelForStatus()`. The `else` fallback at line 240 silently returns `service_status_not_set` for any label that does not match. No test verifies correct colour assignment, and any change to the label format in `getLabelForStatus()` would silently break colour mapping.

---

### ServiceRecordListAdapter.java

#### A65-23 — HIGH: No test for `getView()` — `Objects.requireNonNull()` crash on null item

**Location:** `ServiceRecordListAdapter.java`, line 50

`getView()` calls `getItem(position)` which delegates to `mData.get(i)` (line 68). `ArrayList.get()` returns `null` only for null elements. However, `Objects.requireNonNull(recordItem)` at line 50 throws `NullPointerException` if `recordItem` is null (e.g. if a null was inserted into the data list). No test covers this path. Additionally, `getItem()` does not guard against out-of-bounds `position` values, which would throw `IndexOutOfBoundsException`.

#### A65-24 — MEDIUM: No test for `getView()` view recycling path (non-null `convertView`)

**Location:** `ServiceRecordListAdapter.java`, lines 30–47

`getView()` implements the standard ViewHolder pattern with two paths: inflating a new row (lines 33–44) and recycling an existing row (lines 45–47). No test exercises the recycling path to verify that stale `ListHolder` references from a previous position are correctly overwritten with new item data.

#### A65-25 — MEDIUM: No test for `getCount()` — delegates to `mData.size()`

**Location:** `ServiceRecordListAdapter.java`, lines 62–64

`getCount()` delegates to `mData.size()`. Since `mData` is provided by reference from `ServiceRecordFragment.listData`, external mutations to that list between adapter construction and `getCount()` calls are not tested. No test verifies consistency between `getCount()` and the actual data accessible via `getItem()`.

#### A65-26 — LOW: No test for adapter constructor with empty data list

**Location:** `ServiceRecordListAdapter.java`, lines 21–25

The adapter constructor accepts an empty `ArrayList`. No test verifies that `getCount()` returns 0 and that `getView()` is never called in this state, nor that the adapter does not crash if `notifyDataSetChanged()` is called on an empty list.

#### A65-27 — LOW: `context` cast to `Activity` in `getView()` will crash if context is not an Activity

**Location:** `ServiceRecordListAdapter.java`, line 35

`getView()` casts `context` (stored as `Context`) to `Activity` to obtain a `LayoutInflater`:
```java
LayoutInflater inflater = ((Activity) context).getLayoutInflater();
```
If the adapter is ever constructed with a non-Activity `Context` (e.g. an application context or a wrapper context), this cast throws `ClassCastException`. No test verifies this assumption or that only Activity contexts are supplied.

---

## Summary Table

| ID | File | Severity | Description |
|----|------|----------|-------------|
| A65-1 | Project-wide | HIGH | Zero automated test coverage in `app/` and `LibCommon/` modules |
| A65-2 | ServiceEditFragment | HIGH | `Integer.valueOf()` on raw user input without try/catch — crash on non-integer |
| A65-3 | ServiceEditFragment | HIGH | No null check on `getCurrentRecordItem()` return in `onRightButton()` and `setData()` |
| A65-4 | ServiceEditFragment | MEDIUM | No test for `onNext()` at upper index boundary |
| A65-5 | ServiceEditFragment | MEDIUM | No test for `onPrevious()` at lower index boundary |
| A65-6 | ServiceEditFragment | MEDIUM | No test for `setData()` when `service_type` is null |
| A65-7 | ServiceEditFragment | MEDIUM | No test for `setData()` when `service_type` is an unknown string |
| A65-8 | ServiceEditFragment | MEDIUM | No test for `initViews()` with `fromProfile = false` |
| A65-9 | ServiceEditFragment | MEDIUM | No validation or test for negative `lastService` value |
| A65-10 | ServiceEditFragment | MEDIUM | No validation or test for zero/negative `serviceInterval` value |
| A65-11 | ServiceEditFragment | MEDIUM | No test for `onRightButton()` network failure (`onFailed`) path |
| A65-12 | ServiceEditFragment | LOW | `onServiceEdited()` is empty, never called, never tested |
| A65-13 | ServiceEditFragment | LOW | No test for `createInstance()` with empty list or out-of-range index |
| A65-14 | ServiceEditFragment | LOW | No test for `updateServiceTitle()` with neither toggle checked |
| A65-15 | ServiceRecordFragment | HIGH | No test for `getStatus()` — boundary logic and all branches untested |
| A65-16 | ServiceRecordFragment | MEDIUM | No test for `getColorForStatus()` with any status value |
| A65-17 | ServiceRecordFragment | MEDIUM | No test for `getTextForStatus()` with any status value or fallback |
| A65-18 | ServiceRecordFragment | MEDIUM | No test for `getLabelForStatus()` — dynamic label construction untested |
| A65-19 | ServiceRecordFragment | MEDIUM | No test for `getServicePieData()` edge cases |
| A65-20 | ServiceRecordFragment | MEDIUM | No test for `onData()` with empty or non-empty result |
| A65-21 | ServiceRecordFragment | MEDIUM | No test for `loadData()` cache hit path or network error path |
| A65-22 | ServiceRecordFragment | LOW | No test for `getColorForPieEntry()` — fragile label string matching untested |
| A65-23 | ServiceRecordListAdapter | HIGH | No test for `getView()` — `Objects.requireNonNull()` crash path untested |
| A65-24 | ServiceRecordListAdapter | MEDIUM | No test for `getView()` view recycling path |
| A65-25 | ServiceRecordListAdapter | MEDIUM | No test for `getCount()` consistency with external list mutations |
| A65-26 | ServiceRecordListAdapter | LOW | No test for adapter constructor with empty data list |
| A65-27 | ServiceRecordListAdapter | LOW | `context` cast to `Activity` in `getView()` — no test for non-Activity context |
