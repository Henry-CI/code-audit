# Pass 2 Audit – Agent A42
**Audit run:** 2026-02-26-01
**Agent:** A42
**Files assigned:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/results/SessionEndResult.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/results/SessionResult.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/webserviceclasses/results/UserRegisterResult.java`

---

## Project-Wide Finding

### A42-1 [HIGH] Zero automated test coverage in app/ and LibCommon/ modules

No test directories exist under `app/src/` or `LibCommon/src/`. The only test files in the entire repository are in the third-party `LibImageloader` module:

- `LibImageloader/src/test/java/com/nostra13/universalimageloader/core/assist/ImageSizeTest.java`
- `LibImageloader/src/test/java/com/nostra13/universalimageloader/core/download/BaseImageDownloaderTest.java`

These test files cover a bundled image-loading library, not any application code. All production source files in `app/` and `LibCommon/` have zero test coverage. Every finding below in this report is a direct consequence of this project-wide gap. No test has ever verified parsing logic, business rules, credential handling, or error paths for any class in the application.

**Affected modules:** `app/`, `LibCommon/`
**Severity:** HIGH — the absence of tests means regressions in security-sensitive code (credential handling, session management) cannot be detected automatically.

---

## File 1: SessionEndResult.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.results.SessionEndResult`

**Inheritance:**
Extends `WebServicePacket` (which extends nothing meaningful — its constructor body is empty). Implements `Serializable`.

**Fields defined:**
| Field | Type | Line |
|---|---|---|
| `message_id` | `String` | 11 |
| `error` | `String` | 12 |

**Methods defined:**
| Method | Line | Signature |
|---|---|---|
| Default constructor | 14 | `public SessionEndResult()` |
| JSON constructor | 17 | `public SessionEndResult(JSONObject jsonObject) throws JSONException` |

**Constants:** None.

**Parsing logic (JSON constructor, lines 17–34):**
- Calls `super(jsonObject)` — the parent body is empty, so no inherited fields are parsed.
- Guards the outer block with `if (jsonObject != null)`.
- Conditionally reads `"message_id"` (line 24–27) and `"error"` (line 29–32) using `jsonObject.isNull()` guard before `getString()`.
- No other fields are parsed.

---

### Findings for SessionEndResult.java

#### A42-2 [LOW] No test file exists for SessionEndResult

There is no test class corresponding to `SessionEndResult`. The class is consumed in three call sites within production code:
- `WebApi.saveSessionPreEnd()` — the offline branch synthesises `new SessionEndResult()` (no-arg constructor) and passes it directly to the listener without touching either field.
- `WebApi.saveSessionEnd()` — network success path passes the server-deserialized result to listeners; `SessionTimeouter.endSession()` logs on failure but never inspects `result.error` or `result.message_id`.
- `SessionTimeouter.preEndSession()` — uses an anonymous `new WebListener<SessionEndResult>()` with no overrides, so both success and failure outcomes are silently discarded.

No test verifies:
- That `message_id` is populated correctly when the JSON key is present.
- That `error` is populated correctly when the JSON key is present.
- That both fields remain `null` when the respective JSON key is absent or null.
- That the no-arg constructor leaves both fields as `null` (the offline-synthesis path).
- That a `null` `JSONObject` argument does not throw.

#### A42-3 [MEDIUM] SessionEndResult.error field is never inspected by callers — no test detects this silent-discard bug

The `error` field is populated from the server response but no caller in the codebase ever reads `SessionEndResult.error` or `SessionEndResult.message_id` after receiving the object. In `SessionTimeouter.endSession()`, the `onFailed` branch logs a static string ("Save Session End Failed") rather than forwarding the server error description. The `onSucceed` branch calls `onSessionEnded()` without checking whether `error` is set (the server could return HTTP 200 with an error payload). This means session-end errors are silently swallowed from the user's perspective. No test exists to assert that an error-bearing response triggers any observable behaviour.

**Severity:** MEDIUM — the server error signal is structurally reachable but systematically ignored; a test could have caught this design gap.

---

## File 2: SessionResult.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.results.SessionResult`

**Inheritance:**
Extends `WebServiceResultPacket` (which extends `WebServicePacket`; both constructors have empty bodies). Implements `Serializable`.

**Constants defined:**
| Constant | Type | Line | Value |
|---|---|---|---|
| `WARNING_MINUTES` | `public static final int` | 15 | `5` |

**Fields defined:**
| Field | Type | Line |
|---|---|---|
| `id` | `int` | 17 |
| `driver_id` | `int` | 18 |
| `unit_id` | `int` | 19 |
| `prestart_required` | `boolean` | 20 |
| `start_time` | `String` | 21 |
| `finish_time` | `String` | 22 |

**Methods defined:**
| Method | Line | Signature |
|---|---|---|
| Default constructor | 24 | `public SessionResult()` |
| JSON constructor | 27 | `public SessionResult(JSONObject jsonObject) throws JSONException` |
| `preEnd` | 40 | `public void preEnd()` |
| `end` | 48 | `public void end()` |
| `shouldShowWarning` | 53 | `public boolean shouldShowWarning()` |
| `isFinished` | 60 | `public boolean isFinished()` |

**Parsing (JSON constructor, lines 27–38):**
Uses `JSONObjectParser` helper, which returns `null` / `0` / `false` for absent keys rather than throwing. `null` JSONObject causes immediate return after `this()`.

---

### Findings for SessionResult.java

#### A42-4 [LOW] No test file exists for SessionResult

There is no test class for `SessionResult`. The class has six production methods with non-trivial logic. None is exercised by any automated test.

#### A42-5 [MEDIUM] shouldShowWarning() and isFinished() are untested with null or malformed finish_time

`shouldShowWarning()` (line 53) and `isFinished()` (line 60) both call `new ServerDateFormatter().parseDateTime(finish_time)`. `ServerDateFormatter.parseDateTime()` uses `SimpleDateFormat.parse(date, new ParsePosition(0))`, which returns `null` when parsing fails rather than throwing. If `finish_time` is `null`, `dateTimeFormat.parse(null, ...)` throws a `NullPointerException`. If `finish_time` is present but not in the expected format `"yyyy-MM-dd HH:mm:ss"`, the method returns `null`, and the subsequent `Calendar.getInstance().getTime().after(null)` call throws a `NullPointerException`.

Both call sites in production (`SessionTimeoutJobService`, line 22 and 27) call these methods without guarding `finish_time` for null or malformed input. No test covers:
- `shouldShowWarning()` when `finish_time` is `null`.
- `shouldShowWarning()` when `finish_time` is malformed.
- `isFinished()` when `finish_time` is `null`.
- `isFinished()` when `finish_time` is malformed.
- `shouldShowWarning()` boundary: finish time is exactly `WARNING_MINUTES` minutes in the future.
- `isFinished()` boundary: finish time equals the current instant.

**Severity:** MEDIUM — a null or server-malformed `finish_time` in a live session causes an unhandled `NullPointerException` in the session timeout job, potentially crashing the background service silently.

#### A42-6 [MEDIUM] preEnd() and end() are untested for dependency on CurrentUser state

`preEnd()` (line 40) calls `CurrentUser.get().getMaxSessionLength()`. If `CurrentUser.get()` returns `null` (e.g., after logout, or on first install before any login), this throws a `NullPointerException`. `end()` (line 48) does not carry this risk. No test covers:
- `preEnd()` when no current user is logged in.
- `preEnd()` when `getMaxSessionLength()` is zero or negative (resulting in a finish time in the past, causing an immediate session expiry).
- `end()` for correct `finish_time` formatting.

**Severity:** MEDIUM — `preEnd()` is called from `SessionTimeouter.preEndSession()` at session start; a null current user crashes the timer thread.

#### A42-7 [LOW] JSON constructor untested for default-value behaviour on missing fields

When `JSONObjectParser.getInt()` is called for a missing key it returns `0`. For `id` and `driver_id` and `unit_id`, zero is a plausible but incorrect value that could be silently accepted and persisted. No test verifies:
- That missing `id` in the JSON results in `id == 0` and not some other default.
- That missing `prestart_required` results in `false`, not `true`.
- That `start_time` and `finish_time` remain `null` when absent.

---

## File 3: UserRegisterResult.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.WebService.webserviceclasses.results.UserRegisterResult`

**Inheritance:**
Extends `WebServiceResultPacket` (which extends `WebServicePacket`). Implements `Serializable`.

**Fields defined:**
| Field | Type | Line |
|---|---|---|
| `id` | `int` | 14 |
| `first_name` | `String` | 15 |
| `last_name` | `String` | 16 |
| `email` | `String` | 17 |
| `password` | `String` | 18 |
| `phone` | `String` | 19 |
| `licno` | `String` | 20 |
| `expirydt` | `String` | 21 |
| `addr` | `String` | 22 |
| `securityno` | `String` | 23 |
| `photo` | `String` | 24 |
| `createdat` | `String` | 25 |
| `updatedat` | `String` | 26 |
| `active` | `String` | 27 |
| `contactperson` | `boolean` | 28 |
| `ranking` | `String` | 29 |

**Methods defined:**
| Method | Line | Signature |
|---|---|---|
| Default constructor | 31 | `public UserRegisterResult()` |
| JSON constructor | 34 | `public UserRegisterResult(JSONObject jsonObject) throws JSONException` |

**Constants:** None.

**All fields are `public` with no access modifiers restricting read or write.**

**Parsing (JSON constructor, lines 34–121):**
Each of the 16 non-id fields is conditionally read with `jsonObject.isNull(key)` guard followed by the appropriate getter. `id` (line 41–44) uses `getInt`. `contactperson` (line 111–113) uses `getBoolean`. All others use `getString`. The class implements `Serializable`, so all fields — including `password` — are included in Java serialization output by default; none are marked `transient`.

**Cross-reference — how the class is used:**
`UserRegisterResult` is defined but examination of `WebApi.register()` (lines 150–185) reveals that the registration endpoint is actually typed as returning `LoginItem`, not `UserRegisterResult`. The `UserRegisterResult` class is declared, parsed, and its `password` field is populated from the JSON response, but `WebApi.register()` deserializes the response into a `LoginItem` object, not a `UserRegisterResult`. The class definition in the file under audit exists and is compilable, and the `password` field is present and would be populated if the class were ever used via its JSON constructor — but no caller currently instantiates it with a JSON payload. This does not mitigate the finding: the class is a live artifact, it compiles and is Serializable, and there is no test or annotation preventing it from being used with a real JSON response in a future code path.

---

### Findings for UserRegisterResult.java

#### A42-8 [CRITICAL] UserRegisterResult.password is a server-populated plaintext credential field with no test verifying it is not persisted or logged

`UserRegisterResult` declares a `public String password` field (line 18). The JSON constructor reads it from the server response at lines 61–64:

```java
if (!jsonObject.isNull("password"))
{
    password = jsonObject.getString("password");
}
```

The class implements `java.io.Serializable` and does not mark `password` as `transient`. This means if any `UserRegisterResult` instance is serialized (e.g., via `Intent` extras, `Bundle`, object caching, or `ModelPrefs.saveObject()`), the plaintext password is included in the serialized byte stream and written to storage or transmitted.

All 16 fields are `public`, so `password` is directly readable by any code that holds a reference to this object with no access-control barrier.

No test exists that asserts:
- That `UserRegisterResult.password` is null after parsing a JSON response (i.e., that the server does not send passwords in registration responses, or that the field is intentionally suppressed).
- That a serialized `UserRegisterResult` does not contain the password value.
- That no logging statement anywhere reads `userRegisterResult.password` or calls `userRegisterResult.toString()` (which would include the field via default `Object.toString()`).
- That after the registration flow completes, `password` is zeroed or cleared before the object goes out of scope.

**Additional aggravating factor — related plaintext password storage:**
Cross-referencing the broader password handling in the codebase: `UserRealmObject` (the Realm persistence model) stores `password` as a plain `String` field (line 15 of `UserRealmObject.java`) with no encryption annotation. `UserDb.get(email, password)` (line 55 of `UserDb.java`) queries the Realm database by matching the plaintext password string directly. This confirms that passwords are persisted to the on-device Realm database in plaintext. While `UserRealmObject` is a separate class, `UserRegisterResult.password` feeds the same pipeline: if a server registration response includes the user's password and the result object is passed through the existing user-creation flow, it will land in the Realm database unencrypted. No test intercepts or validates this pipeline.

**Severity:** CRITICAL — a server-populated plaintext password field with no `transient` guard, no test verifying non-persistence, no test verifying non-logging, on a `Serializable` object with all-public fields, in an app that is confirmed to persist passwords to a local unencrypted database.

#### A42-9 [LOW] No test file exists for UserRegisterResult

There is no test class for `UserRegisterResult`. Beyond the CRITICAL finding above, no test covers:
- That all 15 non-password fields are correctly parsed from a valid JSON object.
- That fields remain at their Java defaults when the corresponding JSON key is absent or null.
- That a `null` JSONObject argument does not throw and leaves all fields at defaults.
- That `id` defaults to `0` (not some other sentinel) when absent.
- That `contactperson` defaults to `false` when absent.

#### A42-10 [INFO] UserRegisterResult is Serializable but password is not marked transient

Even if the CRITICAL finding (A42-8) is resolved by removing the server-side password echo, the structural risk persists: all `public` fields on a `Serializable` DTO are included in serialization by default. A future developer adding a sensitive field (token, PIN, security number expansion) to this class would need to explicitly mark it `transient` to prevent accidental serialization. There is no test or annotation convention in this codebase (e.g., a custom serialization hook, a `writeObject` override, or a `@SerializedName` exclusion strategy) to enforce this. A code review or test would catch a new sensitive field being serialized.

**Suggestion:** Define a `writeObject` method that explicitly excludes sensitive fields, or adopt a convention of marking all credential-adjacent fields `transient` and adding a test that serializes the object and asserts no password bytes appear in the output.

---

## Summary Table

| ID | File | Severity | Description |
|---|---|---|---|
| A42-1 | Project-wide | HIGH | Zero automated test coverage in app/ and LibCommon/ modules |
| A42-2 | SessionEndResult | LOW | No test file exists for SessionEndResult |
| A42-3 | SessionEndResult | MEDIUM | SessionEndResult.error is never inspected by callers; silent discard of server errors |
| A42-4 | SessionResult | LOW | No test file exists for SessionResult |
| A42-5 | SessionResult | MEDIUM | shouldShowWarning() and isFinished() throw NPE on null/malformed finish_time |
| A42-6 | SessionResult | MEDIUM | preEnd() throws NPE when CurrentUser.get() returns null |
| A42-7 | SessionResult | LOW | JSON constructor untested for default-value behaviour on missing fields |
| A42-8 | UserRegisterResult | CRITICAL | Server-populated plaintext password field; no transient guard; no test verifying non-persistence or non-logging |
| A42-9 | UserRegisterResult | LOW | No test file exists for UserRegisterResult |
| A42-10 | UserRegisterResult | INFO | All Serializable fields are public with no transient/exclusion discipline for credentials |
