# Audit Pass 2 — Agent A18
**Audit run:** 2026-02-26-01
**Agent:** A18
**Files assigned:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/JSONObjectParser.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/URLBuilder.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/UrlItem.java`

---

## PROJECT-WIDE FINDING

### A18-1 — HIGH — Zero Automated Test Coverage Across app/ and LibCommon/ Modules

The `app/src/` directory tree contains only a `main/` subtree. There is no `test/` or `androidTest/` directory anywhere under `app/src/`. The same is true for `LibCommon/src/`, which likewise contains only `main/`. Confirmed by exhaustive directory listing:

```
app/src/
  main/   <-- only subtree present; test/ and androidTest/ are absent

LibCommon/src/
  main/   <-- only subtree present; test/ and androidTest/ are absent
```

The only test files found in the entire repository are in third-party library modules (`LibImageloader` and `LibImagePicker`/`LibPercentProgress`); these are library-vendor tests and cover none of the application's own code.

`app/build.gradle` declares `testImplementation 'junit:junit:4.12'`, confirming the intent to write unit tests exists, but no test sources have ever been created.

**Impact:** Every class in `app/` and `LibCommon/` — including all network communication, URL construction, JSON parsing, session management, authentication, and data persistence — operates with zero automated verification. Regressions cannot be detected programmatically. This is a systemic quality and reliability deficiency affecting the entire codebase.

---

## Reading Evidence

### File 1 — JSONObjectParser.java

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.WebService.JSONObjectParser`

**Fields:**
| Field | Type | Line |
|-------|------|------|
| `object` | `JSONObject` (private) | 8 |

**Constructor:**
| Line | Signature |
|------|-----------|
| 10 | `JSONObjectParser(JSONObject object)` |

**Methods:**
| Line | Signature | Return type |
|------|-----------|-------------|
| 14 | `getString(String propertyName) throws JSONException` | `String` |
| 18 | `getInt(String propertyName) throws JSONException` | `int` |
| 22 | `getLong(String propertyName) throws JSONException` | `long` |
| 26 | `getBoolean(String propertyName) throws JSONException` | `Boolean` |
| 30 | `getJSONArray(String propertyName) throws JSONException` | `JSONArray` |

**Constants/Types defined:** None.

**Callers confirmed by cross-reference:**
- `LoginItem.java` — constructs parser, calls `getInt`, `getString`, `getBoolean`, `getJSONArray`
- `SessionResult.java` — constructs parser, calls `getInt`, `getBoolean`, `getString`
- `EquipmentItem.java` — uses parser
- `SaveShockEventItem.java` — uses parser

---

### File 2 — URLBuilder.java

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.WebService.URLBuilder`

**Constants:**
| Name | Type | Value | Line |
|------|------|-------|------|
| `EQUIPMENT_FRONT` | `public final static int` | `1` | 17 |
| `EQUIPMENT_LEFT` | `public final static int` | `2` | 18 |
| `EQUIPMENT_RIGHT` | `public final static int` | `3` | 19 |
| `EQUIPMENT_BACK` | `public final static int` | `4` | 20 |

**Package-private fields:**
| Name | Type | Initialiser | Line |
|------|------|-------------|------|
| `baseUrl` | `final static String` | `BuildConfig.BASE_URL` | 22 |
| `baseDataUrl` | `final static String` | `baseUrl + "/rest"` | 24 |
| `baseUrlForPreStartHelp` | `final static String` | `"https://pandora.fleetiq360.com/pandora"` (hard-coded) | 26 |

**Methods (all `public static`, all return `UrlItem` unless noted):**
| Line | Signature |
|------|-----------|
| 29 | `urlSaveSession()` |
| 36 | `urlAbortSession(int sessionId)` |
| 44 | `urlUploadImpactImage(int impactId)` |
| 55 | `urlUploadImpactSignature(int impactId)` |
| 66 | `urlResendReport(int uid, int rid)` |
| 78 | `urlSaveShockEvent()` |
| 86 | `urlUpdateUser(int uid)` |
| 95 | `urlDeleteCompany(int permissionId)` |
| 104 | `urlGetUserDetail(int uid)` |
| 113 | `urlAddEquipment()` |
| 122 | `urlGetEmails(int uid)` |
| 132 | `urlGetEquipmentStatsYearly(int uid)` |
| 143 | `urlGetEquipmentStatsMonthly(int uid)` |
| 155 | `urlGetEquipmentStatsWeekly(int uid)` |
| 167 | `urlSaveImpactPhoto(int impid)` |
| 179 | `urlGetReports(int uid)` |
| 189 | `urlGetDriverStats(int uid)` |
| 199 | `urlSaveService()` |
| 208 | `urlSaveImpact()` |
| 217 | `urlResetPassword()` |
| 226 | `urlGetServiceRecord(int uid)` |
| 236 | `urlGetDiagnosis(int eid)` — uses `baseUrlForPreStartHelp` |
| 244 | `urlGetUniversity(int eid)` — uses `baseUrlForPreStartHelp` |
| 253 | `urlGetFuelType(int mtype, int etype)` |
| 265 | `urlGetEquipmentType(int mtype)` |
| 275 | `urlGetManufacture()` |
| 284 | `urlSaveLicense()` |
| 294 | `urlUserRegister()` |
| 303 | `urlSaveSingleGPSLocation()` |
| 312 | `urlSaveMultipleGPSLocation()` |
| 322 | `urlLogin()` |
| 331 | `urlSetEmails()` |
| 340 | `urlUploadUserPhoto(int userId)` |
| 352 | `urlUploadEquipmentPhoto(int sid, int imageno)` |
| 366 | `urlJoinCompany()` |
| 376 | `urlSearchCompany(String search)` |
| 388 | `urlGetCompanyList(int userId)` |
| 398 | `urlGetEquipmentList(int userId)` |
| 408 | `urlGetCompanyDriversList(int userId)` |
| 419 | `urlGetPreStartQuestions(int equipmentId)` |
| 429 | `urlSavePreStartResult()` |
| 439 | `urlSessionStart()` |
| 448 | `urlSessionEnd()` |
| 457 | `urlGetToken()` — constructs URL directly as `baseUrl + "/oauth/token"` |
| 462 | `getUrl()` — returns `String` (`baseDataUrl`) |

---

### File 3 — UrlItem.java

**Fully qualified class name:** `au.com.collectiveintelligence.fleetiq360.WebService.UrlItem`

**Fields:**
| Name | Type | Visibility | Line |
|------|------|------------|------|
| `method` | `int` | `public` | 9 |
| `url` | `String` | `public` | 10 |

**Constructor:**
| Line | Signature |
|------|-----------|
| 12 | `UrlItem(int httpMethod, String webUrl)` |

**Methods:** None beyond the constructor.
**Constants/Types defined:** None.

---

## Findings

### A18-2 — MEDIUM — JSONObjectParser: No test for missing key (key not present in JSONObject)

**File:** `JSONObjectParser.java`, all five getter methods (lines 14–32)

`JSONObjectParser` delegates directly to `org.json.JSONObject`. When `isNull(key)` is called for a key that does not exist in the object, `JSONObject.isNull()` returns `true`, so the parser will silently return the default value (`null`, `0`, or `false`) rather than throwing a `JSONException`. This means a silently missing key is indistinguishable from an explicit JSON `null` value. No test exercises this path to confirm the intended contract, and callers (e.g., `LoginItem`, `SessionResult`) have no way to detect that a required field was simply absent from the server response.

**Untested paths:**
- All five getters: key present with value, key present as null, key absent entirely — three distinct states with only the middle one intentional.

---

### A18-3 — MEDIUM — JSONObjectParser: No test for type mismatch (wrong JSON type for key)

**File:** `JSONObjectParser.java`, lines 14–32

If the server returns a value of the wrong type (e.g., a string `"abc"` for a key fetched via `getInt`), the underlying `JSONObject.getInt()` call will throw a `JSONException`. No test verifies that this exception propagates correctly (rather than being silently swallowed by a caller), and no test confirms that callers handle it gracefully. The lack of tests means type mismatch is a latent crash risk in production under unexpected server responses.

---

### A18-4 — MEDIUM — JSONObjectParser: No test for null JSONObject passed to constructor

**File:** `JSONObjectParser.java`, line 10 (constructor)

The constructor unconditionally assigns the supplied `JSONObject` to `this.object`. If a caller passes `null`, every subsequent getter call will throw a `NullPointerException` rather than a `JSONException`. Callers such as `LoginItem` (line 37–38) guard against a null object before constructing the parser, but `SessionResult` (line 29) does the same. However, there are no tests confirming this guard-then-construct pattern is enforced everywhere, and there is no null-guard inside the parser itself. A test for `new JSONObjectParser(null)` would clarify the intended contract.

---

### A18-5 — MEDIUM — JSONObjectParser.getBoolean: Asymmetric null/missing-key behaviour compared to other getters

**File:** `JSONObjectParser.java`, lines 26–28

`getString`, `getInt`, `getLong`, and `getJSONArray` all explicitly check `isNull(propertyName)` and branch on it. `getBoolean` does the same but the default-on-null return value is `false` (a Boolean primitive wrapped in the `Boolean` return type), whereas the method signature returns `Boolean` (boxed). The expression `!this.object.isNull(propertyName) && this.object.getBoolean(propertyName)` returns a primitive `false` both when the key is null/absent AND when the stored value is genuinely `false`. This makes it impossible for callers to distinguish "server sent false" from "server omitted the field". No test covers this semantic edge case.

---

### A18-6 — HIGH — URLBuilder: No tests verifying that production builds use production URLs

**File:** `URLBuilder.java`, lines 22–26; `app/build.gradle`, lines 71–87

`BASE_URL` is injected at compile time from `BuildConfig.BASE_URL`, which varies by product flavor:

| Flavor | URL |
|--------|-----|
| `local` | `https://<host-IP>:8443/fleetiq360ws` (dynamic, derived from `InetAddress.localHost`) |
| `dev` | `https://forklift360.canadaeast.cloudapp.azure.com:8443/fleetiq360ws` |
| `uat` | `https://ec2-54-86-82-22.compute-1.amazonaws.com:8443/fleetiq360ws` |
| `prod` | `https://pandora.fleetiq360.com/fleetiq360ws` |

There are no tests that assert that a release/prod build variant has a `BASE_URL` that matches the expected production hostname, or that non-prod hostnames are absent from a prod build. Without such a test, a production APK accidentally built from the `dev` or `uat` flavor would send real user credentials and operational data to a non-production server, with no automated gate to catch it.

---

### A18-7 — HIGH — URLBuilder: No tests for URL path construction correctness

**File:** `URLBuilder.java`, all 44 methods

Every method appends path segments using `Uri.Builder.appendPath()`. None of the 44 URL-building methods has a single unit test verifying:
- That the produced URL string contains the expected path segments in the correct order.
- That integer IDs are correctly embedded (e.g., negative IDs, zero, `Integer.MAX_VALUE`).
- That the correct HTTP method is assigned to each `UrlItem` (e.g., `urlUploadImpactImage` at line 52 uses `Request.Method.GET` for an upload operation — this appears incorrect; it is at minimum unverified).
- That `urlGetToken()` (line 457–459) concatenates `baseUrl + "/oauth/token"` with string concatenation rather than `Uri.Builder`, which could produce a malformed URL if `baseUrl` has a trailing slash.

---

### A18-8 — HIGH — URLBuilder: urlUploadImpactImage and urlUploadImpactSignature use GET for upload operations

**File:** `URLBuilder.java`, lines 52 and 63

`urlUploadImpactImage` (line 52) and `urlUploadImpactSignature` (line 63) both return a `UrlItem` with `Request.Method.GET`. The method names ("Upload", "save impact image", "save impact signature") and their usage context (sending binary data to the server) strongly indicate these should be `POST` or `PUT`. No test exists to validate the intended HTTP verb. If GET is genuinely intentional, a test with an explicit comment would document the rationale; without a test, this is an undetected logic error.

---

### A18-9 — MEDIUM — URLBuilder: urlGetToken uses string concatenation instead of Uri.Builder

**File:** `URLBuilder.java`, line 459

```java
return (new UrlItem(Request.Method.POST, baseUrl + "/oauth/token"));
```

All other methods use `Uri.Builder.appendPath()` for safe, encoded URL construction. `urlGetToken` uses raw string concatenation. If `baseUrl` were ever set to a value with a trailing slash (e.g., `"https://example.com/"`) — which is possible in the `local` flavor where the URL is dynamically constructed — the result would be `"https://example.com//oauth/token"`, a malformed URL. No test verifies the constructed URL string is well-formed across all flavor configurations.

---

### A18-10 — MEDIUM — URLBuilder: urlSearchCompany appends empty string path segment

**File:** `URLBuilder.java`, lines 382–383

```java
builder.appendPath(search);
builder.appendPath("");
```

An empty string passed to `appendPath` appends a trailing slash to the URL (e.g., `.../company/search/<term>/`). Whether this trailing slash is required by the server API is undocumented, and no test verifies this behaviour. Additionally, the `search` parameter is passed directly into `appendPath` without any sanitisation or encoding verification. `Uri.Builder.appendPath` does percent-encode the segment, but no test confirms behaviour for edge-case inputs: empty string, null, strings containing path separators (`/`), or strings containing query-string characters (`?`, `&`, `=`).

---

### A18-11 — LOW — URLBuilder: Hard-coded production hostname in baseUrlForPreStartHelp

**File:** `URLBuilder.java`, line 26

```java
final static String baseUrlForPreStartHelp = "https://pandora.fleetiq360.com/pandora";
```

This constant is hard-coded to the production hostname for the "pre-start help" feature (`urlGetDiagnosis`, `urlGetUniversity`). Unlike `baseUrl`, it is not controlled by the `BuildConfig` flavor mechanism. As a result:
- The `local` and `dev` flavors will call the production endpoint for these two features, which may pollute production analytics or expose a production dependency to development builds.
- There is no way to point these URLs at a staging or mock server for testing.
- No test asserts that the URL under the expected flavor points to the expected host.

---

### A18-12 — LOW — URLBuilder: Typo "frequencey" baked into production API paths

**File:** `URLBuilder.java`, lines 138, 150, 162

```java
builder.appendPath("frequencey");  // lines 138, 150, 162
```

The misspelling `"frequencey"` (should be `"frequency"`) appears in `urlGetEquipmentStatsYearly`, `urlGetEquipmentStatsMonthly`, and `urlGetEquipmentStatsWeekly`. This typo is now part of the server API contract. No test asserts the exact path string, so a future "fix" to the spelling would silently break all three endpoints. A test that asserts the literal URL string would both document the intentional typo and guard against inadvertent correction.

---

### A18-13 — LOW — URLBuilder: Endpoint constants EQUIPMENT_FRONT/LEFT/RIGHT/BACK are defined but never used

**File:** `URLBuilder.java`, lines 17–20

```java
public final static int EQUIPMENT_FRONT = 1;
public final static int EQUIPMENT_LEFT  = 2;
public final static int EQUIPMENT_RIGHT = 3;
public final static int EQUIPMENT_BACK  = 4;
```

These four constants are declared public and appear to be intended for identifying equipment photo positions, but they are not used within `URLBuilder` itself. A cross-reference search across the codebase would confirm whether they are used by callers; however, no test verifies that the values remain stable (i.e., that they match server-side enum values). If the server API changes these codes, there is no automated guard.

---

### A18-14 — LOW — UrlItem: Public mutable fields with no validation

**File:** `UrlItem.java`, lines 9–10

```java
public int method;
public String url;
```

Both fields are `public` and non-final, allowing any code that holds a `UrlItem` reference to mutate the HTTP method or URL after construction. No test verifies that constructed `UrlItem` instances retain their intended values when passed through the request pipeline. The lack of encapsulation (no getters, no immutability) means accidental mutation is undetectable.

---

### A18-15 — INFO — URLBuilder: urlAbortSession embeds "session" path segment twice

**File:** `URLBuilder.java`, lines 39–41

```java
builder.appendPath("session").appendPath("abort").appendPath("session")
       .appendPath(String.valueOf(sessionId));
```

The path is `.../session/abort/session/<id>`. The double `"session"` segment may be intentional (matching a server API design), but it is unusual enough that a test asserting the exact URL string would document the intent and prevent accidental removal of the duplicate segment.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A18-1 | HIGH | Project-wide | Zero automated test coverage in `app/` and `LibCommon/` modules |
| A18-2 | MEDIUM | JSONObjectParser.java | No test for missing key — silently returns default, indistinguishable from explicit null |
| A18-3 | MEDIUM | JSONObjectParser.java | No test for type mismatch — JSONException propagation unverified |
| A18-4 | MEDIUM | JSONObjectParser.java | No test for null JSONObject passed to constructor — NPE risk |
| A18-5 | MEDIUM | JSONObjectParser.java | getBoolean null/absent semantics collapse to same false — untested edge case |
| A18-6 | HIGH | URLBuilder.java | No test verifying prod builds target production URLs; wrong flavor could silently point to dev/uat |
| A18-7 | HIGH | URLBuilder.java | No tests for URL path construction correctness across any of the 44 builder methods |
| A18-8 | HIGH | URLBuilder.java | urlUploadImpactImage and urlUploadImpactSignature use GET for upload operations |
| A18-9 | MEDIUM | URLBuilder.java | urlGetToken uses string concatenation instead of Uri.Builder — trailing slash risk |
| A18-10 | MEDIUM | URLBuilder.java | urlSearchCompany appends empty path segment and passes unsanitised search string |
| A18-11 | LOW | URLBuilder.java | baseUrlForPreStartHelp hard-coded to production host, ignores flavor configuration |
| A18-12 | LOW | URLBuilder.java | Typo "frequencey" baked into three API paths with no test to guard against correction |
| A18-13 | LOW | URLBuilder.java | EQUIPMENT_FRONT/LEFT/RIGHT/BACK constants appear unused, server-value alignment untested |
| A18-14 | LOW | UrlItem.java | Public mutable fields allow post-construction mutation with no validation or test coverage |
| A18-15 | INFO | URLBuilder.java | urlAbortSession embeds "session" segment twice — may be intentional but is undocumented |
