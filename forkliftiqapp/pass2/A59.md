# Audit Pass 2 — Agent A59
**Audit run:** 2026-02-26-01
**Agent:** A59
**Files assigned:**
1. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/common/FleetFragment.java`
2. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/AddEquipmentFragment.java`
3. `app/src/main/java/au/com/collectiveintelligence/fleetiq360/ui/fragment/DashboardFragment.java`

---

## Project-Wide Finding: Zero Automated Test Coverage

### A59-1 — No test directories exist anywhere in the project
**Severity: HIGH**

Neither the `app/` module nor the `LibCommon/` module contains any `src/test/` or `src/androidTest/` directories. Glob searches for `**/test/**/*.java` and `**/androidTest/**/*.java` across the entire repository returned zero results. There is no unit test suite, no instrumented test suite, and no test runner configuration of any kind.

Every finding listed below in the file-specific sections describes behavior that is entirely unvalidated by automated tests. Any regression in any path—including authentication, logout, session management, and equipment submission—would require manual discovery.

---

## File 1: FleetFragment.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.ui.common.FleetFragment`
extends `com.yy.libcommon.BaseFragment`

**Fields / constants defined:**
| Name | Type | Line |
|---|---|---|
| `runnableAfterPermission` | `Runnable` (instance field) | 263 |

**Methods (with line numbers and signatures):**
| Line | Signature |
|---|---|
| 39 | `protected void showPreStartOrJobFragment()` |
| 65 | `public static void checkUsePreviousPreStart(BaseActivity activity, final SessionResult sessionResult, final Runnable runnableToJob, final Runnable runnableToPreStart)` |
| 106 | `protected void initChart()` |
| 127 | `protected void initChartExtra(PieChart mChart)` |
| 137 | `public void initBottomBar(int[] imageArray, String[] textArray, View rootView)` |
| 177 | `public void onLeftButton(View view)` |
| 181 | `public void onMiddleButton(View view)` |
| 184 | `public void onRightButton(View view)` |
| 187 | `public void showLoadingLayout()` |
| 194 | `public void hideLoadingLayout()` |
| 202 | `public void onActivityCreated(Bundle savedInstanceState)` |
| 213 | `private void startConnect()` |
| 251 | `private void checkLocationPermission(Runnable runnable)` |
| 265 | `public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults)` |
| 282 | `public void initViews()` |
| 285 | `public void onSessionEnded()` |

---

### Findings for FleetFragment.java

### A59-2 — No test for `checkUsePreviousPreStart`: null `equipmentItem` path
**Severity: MEDIUM**

`checkUsePreviousPreStart` (line 65) calls `SessionDb.readRunningEquipmentItem()` and returns early via toast if null (line 69-71). There is no test verifying that a null equipment item causes an early return without proceeding to either runnable. A bug here could silently advance the user to a session state with invalid data.

### A59-3 — No test for `checkUsePreviousPreStart`: driver-based vs. non-driver-based branch
**Severity: MEDIUM**

At line 77, `equipmentItem.driver_based` controls whether the job runnable fires immediately (driver-based path) or a `YesNoDialog` is shown (non-driver-based path). Both branches — including accepting and declining the previous pre-op check — are untested. The accept path (lines 86-88) mutates session state by calling `setSessionPreStartFinished` and `setSessionResultWithPreStartRequired`; these mutations have no test coverage.

### A59-4 — No test for `checkUsePreviousPreStart`: `prestart_required == true` path
**Severity: LOW**

The else branch at line 101 runs `runnableToPreStart` directly when `sessionResult.prestart_required` is `true`. This path has no test.

### A59-5 — No test for `onActivityCreated`: `isCheckLocationPermissionDone` static guard behavior
**Severity: LOW**

`onActivityCreated` (line 202) checks the static boolean `MyCommonValue.isCheckLocationPermissionDone` and, when false, sets it to true and calls `startConnect()`. Because this is a static field, re-creation of the fragment (e.g., after a configuration change) will skip `startConnect()` in the same process. There is no test verifying this guard prevents double-invocation, nor that it resets correctly across process boundaries.

### A59-6 — No test for `onRequestPermissionsResult`: permission denied path
**Severity: LOW**

At line 273, the permission-denied branch is entirely commented out (`//permissionNotGranted = true; //onLocationNotGranted();`). The dead code indicates a deliberately removed handler. There is no test confirming that permission denial results in graceful degradation (currently a no-op), and no test confirming a future re-enablement of this path would be caught by regression.

### A59-7 — No test for `checkLocationPermission`: pre-Marshmallow branch
**Severity: LOW**

`checkLocationPermission` (line 251) has an SDK version branch: on API < 23, `runnable.run()` is called unconditionally without any permission check. This path is untested.

### A59-8 — No test for `startConnect`: GPS disabled dialog interaction
**Severity: LOW**

Inside the `runnableAfterPermission` defined in `startConnect()` (line 215), if `MyApplication.getGPSProviderStatus()` returns false a `YesNoDialog` is shown. The "Yes" branch triggers an intent to `ACTION_LOCATION_SOURCE_SETTINGS`; the "No" and timeout branches are no-ops. None of these dialog callback paths are tested.

### A59-9 — No test for `initBottomBar`: null `rootView` guard
**Severity: LOW**

`initBottomBar` (line 137) returns early if `rootView == null` (line 138). The general case (non-null root with fewer than three buttons present, or a null text entry causing `INVISIBLE`) is also untested.

### A59-10 — No test for `initChart` or `initChartExtra`
**Severity: INFO**

`initChart()` (line 106) and `initChartExtra()` (line 127) configure a `PieChart` widget with specific visual constants. There is no test verifying these constants are applied correctly, meaning layout regressions from library upgrades would not be caught.

---

## File 2: AddEquipmentFragment.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.ui.fragment.AddEquipmentFragment`
extends `au.com.collectiveintelligence.fleetiq360.ui.common.FleetFragment`

**Fields / constants defined:**
| Name | Type | Line |
|---|---|---|
| `manufactureResultArray` | `ManufactureResultArray` | 39 |
| `mapEquipmentTypesForManu` | `HashMap<Integer, EquipmentTypeResultArray>` | 42 |
| `mapFuelTypesForEquipmentType` | `HashMap<String, FuelTypeResultArray>` | 43 |
| `TYPE_TITLE` | `final String` = `"--Type--"` | 45 |
| `FUEL_TITLE` | `final String` = `"--Power--"` | 46 |
| `equipment_name` | `EditText` | 55 |
| `equipment_no` | `EditText` | 56 |
| `equipment_mac_address` | `EditText` | 57 |
| `equipment_manufacture` | `TextView` | 58 |
| `equipment_type` | `TextView` | 59 |
| `equipment_fuel_type` | `TextView` | 60 |
| `expansion_module_checkbox` | `CheckBox` | 61 |
| `manufactureItem` | `ManufactureItem` | 63 |
| `equipmentTypeItem` | `EquipmentTypeItem` | 64 |
| `fuelTypeItem` | `FuelTypeItem` | 65 |

**Methods (with line numbers and signatures):**
| Line | Signature |
|---|---|
| 50 | `public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)` |
| 67 | `public void initViews()` |
| 110 | `private void updateMacAddressVisible()` |
| 114 | `private void registerAfterMacTextChangedCallback(final EditText mMacEdit)` |
| 139 | (inner) `private String clearNonMacCharacters(String mac)` |
| 143 | (inner) `private String formatMacAddress(String cleanMac)` |
| 163 | (inner) `private String handleColonDeletion(String enteredMac, String formattedMac, int selectionStart)` |
| 177 | (inner) `private int colonCount(String formattedMac)` |
| 181 | (inner) `private void setMacEdit(String cleanMac, String formattedMac, int selectionStart, int lengthDiff)` |
| 196 | `private void showManu()` |
| 231 | `private void showType()` |
| 270 | `private String getKeyForFuelType(int mid, int tid)` |
| 274 | `private void showFuelType()` |
| 317 | `private void loadManu(final Runnable runnable)` |
| 337 | `private void loadType(final Runnable runnable)` |
| 362 | `private void loadFuelType(final Runnable runnable)` |
| 388 | `public void onMiddleButton(View view)` (Save button) |
| 420 | `public void onRightButton(View view)` (Back button) |
| 424 | `private void saveEquipment()` |

---

### Findings for AddEquipmentFragment.java

### A59-11 — HTTP 502 used as duplicate-name discriminator with no test
**Severity: MEDIUM**

In `saveEquipment()` at line 469, `onFailed` inspects the HTTP status code:

```java
if (webResult.getStatusCode() == HttpsURLConnection.HTTP_BAD_GATEWAY) {
    showErrDialog("Equipment with the same name or serial number already saved.");
} else {
    showErrDialog("Failed to save this equipment, please check your internet connection and retry.");
}
```

HTTP 502 Bad Gateway is a proxy/infrastructure error code. Using it as the server's signal for a duplicate-name or duplicate-serial-number business rule is a semantic misuse of the status code. If the server is genuinely behind a gateway that returns 502 due to upstream failure, this code will display the misleading "already saved" message to the user when in fact their equipment was not a duplicate and may need retrying. Conversely, if a genuine duplicate is signalled by any other code (e.g., 409 Conflict), the user sees only the connectivity error. There is no test covering:
- HTTP 502 received → correct "duplicate" dialog shown
- Any other error code received → correct "connectivity" dialog shown
- HTTP 502 received due to real gateway failure → incorrect "duplicate" dialog exposed to user

### A59-12 — No test for `onMiddleButton` (Save): validation guard conditions
**Severity: MEDIUM**

`onMiddleButton` (line 388) contains five sequential validation guards before calling `saveEquipment()`:
1. Empty equipment name
2. MAC address checked only when `expansion_module_checkbox` is checked
3. Null `manufactureItem`
4. Null `equipmentTypeItem`
5. Null `fuelTypeItem`

There is no test for any guard returning early via toast. In particular, the MAC address validation at line 395 checks `equipment_mac_address.length() != 17` only when the checkbox is checked — the case where the checkbox is unchecked but a partial MAC has been entered is never validated and is untested.

### A59-13 — No test for MAC address formatter: boundary and edge cases
**Severity: MEDIUM**

The MAC address `TextWatcher` logic implemented inline in `registerAfterMacTextChangedCallback` (lines 114-193) contains non-trivial logic:

- `clearNonMacCharacters`: strips characters outside `[A-Fa-f0-9]`
- `formatMacAddress`: inserts colons every two hex digits, strips trailing colon at length 12
- `handleColonDeletion`: detects a colon deletion and removes the preceding character
- `setMacEdit`: enforces max length at 12 clean chars, manages cursor position

None of these inner helpers are tested. Specific untested edge cases include:
- Empty string input
- Exactly 12 hex characters (full MAC, trailing colon must be stripped)
- Exactly 13 hex characters (one over limit — must revert to `mPreviousMac`)
- Deletion of a colon character (colon count delta path in `handleColonDeletion`)
- Mixed-case input (`a-f` vs `A-F`) normalised to uppercase
- Pasting a fully-formatted MAC string (e.g., `88:6B:0F:00:18:48`) directly
- `selectionStart` at 0 when `handleColonDeletion` attempts `substring(0, selectionStart - 1)` — this would produce a negative index

The `selectionStart - 1` at line 169 is the most significant concern: if the user deletes a colon at cursor position 0 (which should be impossible due to auto-formatting but may occur through edge-case paste/cut operations), `formattedMac.substring(0, -1)` throws `StringIndexOutOfBoundsException`. There is no test covering cursor-at-zero deletion.

### A59-14 — No test for `loadManu` failure path
**Severity: LOW**

`loadManu` (line 317) calls the network and on failure shows a toast. There is no test verifying the loading spinner is hidden after a failure response, nor that the toast message is correct.

### A59-15 — No test for `loadType` cache bypass logic
**Severity: LOW**

`loadType` (line 337) has a cache-skip guard at line 340:

```java
if (mapFuelTypesForEquipmentType.get(Integer.toString(manufactureItem.id)) != null)
    return;
```

This guard uses the wrong map — `mapFuelTypesForEquipmentType` maps fuel types keyed by `"<mid>_<tid>"` strings, not manufacturer IDs. The intent was clearly to check `mapEquipmentTypesForManu`, which maps `Integer` manufacturer IDs to `EquipmentTypeResultArray`. Because the key type (`String` vs `Integer`) and map are both wrong, this guard will never match and a network request is always issued for equipment types even when the result is already cached. There is no test for the cache-hit path in `loadType`, which would have caught this bug.

### A59-16 — No test for `showType` with null `equipmentTypeResultArray` after cache miss
**Severity: LOW**

In `showType` (line 231), if `mapEquipmentTypesForManu.get(manufactureItem.id)` returns null, `loadType(runnable)` is called. However, the `Runnable` passed as `runnable` at line 238 dereferences `equipmentTypeResultArray` (captured via the `final` local) without null-checking. If `loadType` fails the network call, the runnable is never invoked; but if `equipmentTypeResultArray` were somehow null at runnable execution time, a `NullPointerException` would result. No test covers this interaction.

### A59-17 — No test for `saveEquipment` success: `getEquipmentList` failure branch
**Severity: LOW**

In the `onSucceed` handler of `saveEquipment` (line 437), a second network call is made to `getEquipmentList`. If that call fails (line 459), `CacheService.startService()` is called and the runnable still executes. There is no test verifying that on a successful equipment add followed by a failed equipment-list refresh, the UI progresses correctly and `CacheService` is triggered.

### A59-18 — No test for `showFuelType`: guard ordering
**Severity: LOW**

`showFuelType` (line 274) checks `manufactureItem == null` at line 275 before checking `equipmentTypeItem == null` at line 280. The error messages differ. There is no test confirming that when both are null, only the manufacturer error is shown, and that when only `equipmentTypeItem` is null the correct message is shown.

---

## File 3: DashboardFragment.java

### Reading Evidence

**Fully qualified class name:**
`au.com.collectiveintelligence.fleetiq360.ui.fragment.DashboardFragment`
extends `au.com.collectiveintelligence.fleetiq360.ui.common.FleetFragment`
implements `android.view.View.OnClickListener`

**Fields / constants defined:**
| Name | Type | Modifier | Line |
|---|---|---|---|
| `userPhotoBitmap` | `Bitmap` | `static` (package-private) | 35 |

**Methods (with line numbers and signatures):**
| Line | Signature |
|---|---|
| 39 | `public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)` |
| 44 | `private void setUserPhoto()` |
| 54 | `private void showUserName()` |
| 58 | `public void initViews()` |
| 89 | `private void initMonitorSession()` |
| 98 | `private void updateRunning()` |
| 104 | `public void onSessionEnded()` |
| 108 | `private void getUserDetail()` |
| 114 | `public void onResume()` |
| 122 | `public void onStop()` |
| 128 | `public void onDestroy()` |
| 133 | `public void onClick(View view)` |
| 154 | `private void showEquipmentList()` |
| 168 | `private void showProfile()` |
| 175 | `public void onLeftButton(View view)` |
| 182 | `public void onMiddleButton(View view)` |
| 189 | `public void onRightButton(View view)` (Logout button) |

---

### Findings for DashboardFragment.java

### A59-19 — `static userPhotoBitmap` never cleared on logout; no test
**Severity: HIGH**

`DashboardFragment.userPhotoBitmap` is declared `static` at line 35. It is set by `SetUserPhotoFragment` (confirmed at `SetUserPhotoFragment.java:166`) and consumed in `setUserPhoto()` at line 47-49, where it is applied to the `ImageView` and then nulled.

The problem is that the field is `static` and class-level. When one user logs out and a second user logs in in the same process (the `LoginActivity` is started without finishing the application process), a new `DashboardFragment` instance is created. If the previous user's photo was set but not yet consumed (i.e., `setUserPhoto()` was not called before logout), `userPhotoBitmap` retains the first user's bitmap across the login boundary and the second user's dashboard will display the first user's photo until it is overwritten.

`WebData.instance().logout()` delegates to `CurrentUser.logout()`, which sets `user = null` and deletes `CURRENT_USER_ID_KEY` from `ModelPrefs`. Neither `logout()` path (lines 108-110 in `WebData`, lines 125-128 in `CurrentUser`) touches `DashboardFragment.userPhotoBitmap`. There is no test verifying that `userPhotoBitmap` is null after logout.

### A59-20 — Logout does not clear the OAuth token from persistent storage; no test
**Severity: HIGH**

`WebData.logout()` (line 108) calls `CurrentUser.logout()`, which removes only `CURRENT_USER_ID_KEY` from `ModelPrefs`. The OAuth token stored under key `"token_result"` (`TOKEN_ITEM_KEY` in `WebData`, line 27) is **not removed** by any logout path.

Evidence from `WebData.java`:
- Token is written to `ModelPrefs` at line 93 via `ModelPrefs.saveObject(TOKEN_ITEM_KEY, result)`.
- Token is read back from `ModelPrefs` at line 119 whenever `getTokenResult` is null.
- `logout()` at line 108 only calls `CurrentUser.logout()`, which removes `CURRENT_USER_ID_KEY` only.

After logout, the next call to `getTokenString()` will re-hydrate `getTokenResult` from `ModelPrefs` because the key was never deleted. The token therefore remains valid and readable from storage after logout. If a subsequent user obtains physical access to the device, extracts `SharedPreferences`, or if the token is reused by background services, the prior user's credentials remain active. Additionally, `getTokenResult` as an in-memory field on the `WebData` singleton (which lives for the process lifetime) is also never nulled. There is no test verifying that after logout, `getTokenString()` returns null and `isAppInitialized()` returns false.

### A59-21 — Logout `onFailed` branch silently drops logout if no offline data; no test
**Severity: HIGH**

In `onRightButton` (line 189), when `sessionResult != null`, a `saveSessionEnd` API call is made. The `onFailed` handler at line 204 only proceeds with logout if `SessionDb.hasOfflineData(parameter.id)` is true. If the session has no offline data and the network call fails, **neither logout nor any user-visible error occurs**: the dialog closes, the user is left on the dashboard with no indication that their session could not be ended and no path to retry.

```java
public void onFailed(WebResult result) {
    if (SessionDb.hasOfflineData(parameter.id)) {
        // ... logout proceeds
    }
    // No else: silent failure
}
```

There is no test for:
- Session end network failure + no offline data = silent no-op (the user is stuck)
- Session end network failure + offline data present = offline logout proceeds

### A59-22 — No test for `onRightButton` (Logout): no active session path
**Severity: MEDIUM**

When `WebData.instance().getSessionResult()` returns null (line 190), the code at line 214-217 calls `WebData.instance().logout()` and navigates to `LoginActivity` directly. There is no test verifying this path executes correctly, that the `LoginActivity` intent is constructed and started, or that logout is actually called.

### A59-23 — No test for `onClick` dispatch: `dashboard_incident_report` missing break
**Severity: MEDIUM**

In `onClick` (line 133), the `case R.id.dashboard_incident_report:` block at line 147 is missing a `break` statement before the `default:` case at line 149. Java `switch` fall-through means `IncidentActivity` is started and then the `default` case also executes. In this particular layout the `default` case is a no-op `break`, so the current impact is zero — but the missing `break` is a latent defect that would become a bug if any code is added to `default`. There is no test exercising this case that would catch a future regression.

### A59-24 — No test for `updateRunning` / `initMonitorSession` Realm listener
**Severity: MEDIUM**

`initMonitorSession` (line 89) attaches a `RealmChangeListener` that calls `updateRunning()` on any change to running session records. `updateRunning` (line 98) reads from `SessionDb` and toggles a `View` visibility flag. There is no test verifying the listener is registered, that `updateRunning` correctly sets `VISIBLE` vs `GONE`, or that the listener survives fragment recreation.

### A59-25 — No test for `setUserPhoto`: mRootView null guard
**Severity: LOW**

`setUserPhoto()` (line 44) returns early if `mRootView == null` at line 45. There is no test verifying this guard prevents a NPE when `setUserPhoto` is called before the view hierarchy is established.

### A59-26 — No test for `onResume`: duplicate session dot visibility logic
**Severity: LOW**

`onResume` (line 114) duplicates the session-dot visibility check already present in `updateRunning` (line 98) and calls `getUserDetail()` to refresh the name and photo. There is no test verifying that `onResume` correctly updates the UI when the session state changes between pause and resume. The duplication means a future change to the session dot logic must be applied in two places.

### A59-27 — No test for `showEquipmentList`: active session vs. no session routing
**Severity: LOW**

`showEquipmentList` (line 154) routes the user to `SessionActivity` if a running session exists, or `EquipmentActivity` if not. There is no test for either routing decision, nor for the population of `MyCommonValue.currentEquipmentItem` on the active-session path.

### A59-28 — `onStop` and `onDestroy` are empty overrides; no cleanup coverage
**Severity: INFO**

`onStop` (line 122) and `onDestroy` (line 128) both call `super` and do nothing else. The Realm change listener registered in `initMonitorSession` is never removed. In a Realm-backed application, failing to remove listeners before the fragment is destroyed can cause callbacks to fire on destroyed views or to prevent garbage collection of the fragment. There is no test confirming listener teardown. This is an INFO finding because Realm's own lifecycle management may handle this, but the intent to clean up is absent from the code.

---

## Summary Table

| ID | File | Severity | Description |
|---|---|---|---|
| A59-1 | Project-wide | HIGH | Zero automated test coverage in app/ and LibCommon/ modules |
| A59-2 | FleetFragment | MEDIUM | No test: null equipmentItem early return in checkUsePreviousPreStart |
| A59-3 | FleetFragment | MEDIUM | No test: driver-based vs. non-driver-based pre-start branch |
| A59-4 | FleetFragment | LOW | No test: prestart_required true path in checkUsePreviousPreStart |
| A59-5 | FleetFragment | LOW | No test: static isCheckLocationPermissionDone guard in onActivityCreated |
| A59-6 | FleetFragment | LOW | No test: location permission denied (dead code) path |
| A59-7 | FleetFragment | LOW | No test: pre-Marshmallow branch in checkLocationPermission |
| A59-8 | FleetFragment | LOW | No test: GPS disabled dialog interactions in startConnect |
| A59-9 | FleetFragment | LOW | No test: null rootView guard and button-null path in initBottomBar |
| A59-10 | FleetFragment | INFO | No test: chart configuration constants in initChart/initChartExtra |
| A59-11 | AddEquipmentFragment | MEDIUM | HTTP 502 used as duplicate-name discriminator with no test |
| A59-12 | AddEquipmentFragment | MEDIUM | No test: five validation guards in onMiddleButton (Save) |
| A59-13 | AddEquipmentFragment | MEDIUM | No test: MAC address formatter boundary/edge cases; potential negative index |
| A59-14 | AddEquipmentFragment | LOW | No test: loadManu failure path (spinner hide + toast) |
| A59-15 | AddEquipmentFragment | LOW | No test: loadType cache bypass uses wrong map (always misses cache) |
| A59-16 | AddEquipmentFragment | LOW | No test: showType null equipmentTypeResultArray after cache miss |
| A59-17 | AddEquipmentFragment | LOW | No test: saveEquipment success + getEquipmentList failure branch |
| A59-18 | AddEquipmentFragment | LOW | No test: showFuelType guard ordering for double-null state |
| A59-19 | DashboardFragment | HIGH | Static userPhotoBitmap never cleared on logout; cross-user photo leak |
| A59-20 | DashboardFragment | HIGH | Logout does not clear OAuth token from SharedPreferences |
| A59-21 | DashboardFragment | HIGH | Logout silently drops if session end fails and no offline data exists |
| A59-22 | DashboardFragment | MEDIUM | No test: logout path when no active session (null sessionResult) |
| A59-23 | DashboardFragment | MEDIUM | No test: missing break after dashboard_incident_report case in onClick |
| A59-24 | DashboardFragment | MEDIUM | No test: Realm change listener in initMonitorSession / updateRunning |
| A59-25 | DashboardFragment | LOW | No test: mRootView null guard in setUserPhoto |
| A59-26 | DashboardFragment | LOW | No test: onResume duplicates session dot logic; both sites unvalidated |
| A59-27 | DashboardFragment | LOW | No test: showEquipmentList session vs. no-session routing |
| A59-28 | DashboardFragment | INFO | Realm listener never removed in onStop/onDestroy |
