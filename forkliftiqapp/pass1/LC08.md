# Pass 1 Security Audit — Agent LC08
**Date:** 2026-02-27
**Repo:** forkliftiqapp
**Stack:** Android/Java

---

## Step 1 — Branch Verification

Command run: `git -C /c/Projects/cig-audit/repos/forkliftiqapp branch --show-current`
Result: `master`

DISCREPANCY: Checklist specifies Branch: `main`. Actual branch is `master`. Proceeding on `master` as directed.

---

## Step 2 — Checklist Confirmed

Full checklist read. Sections reviewed:
1. Signing and Keystores
2. Network Security
3. Data Storage
4. Input and Intent Handling
5. Authentication and Session
6. Third-Party Libraries
7. Google Play and Android Platform

---

## Step 3 — Files Audited

1. `LibCommon/src/main/java/com/yy/libcommon/SignatureDialog.java`
2. `LibCommon/src/main/java/com/yy/libcommon/SquareImageView.java`
3. `LibCommon/src/main/java/com/yy/libcommon/SubFragPermission.java`

---

## Step 4 — Reading Evidence

### File 1: SignatureDialog.java

**Fully qualified class name:** `com.yy.libcommon.SignatureDialog`
**Extends:** `BaseDialog` (which extends `DialogFragment`)

**Public methods (signature and line number):**

| Line | Signature |
|------|-----------|
| 40 | `public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)` |
| 55 | `public static SignatureDialog newInstance(String path)` |
| 63 | `public void setCallback(SignatureCallback signatureCallback)` |
| 68 | `public void onActivityCreated(Bundle savedInstanceState)` |
| 76 | `public void init()` |
| 80 | `public void findViews()` |
| 87 | `public void setupViews()` |

**Public fields:** None declared public.

**Package-private fields:**
- Line 36: `String filePath` — package-private (no access modifier)

**Public nested interface:**
- Line 207: `public interface SignatureCallback` with method `public void callBack(String filePath)`

**Component type:** `DialogFragment` (via `BaseDialog`). Not an Activity, Service, BroadcastReceiver, or ContentProvider.

---

### File 2: SquareImageView.java

**Fully qualified class name:** `com.yy.libcommon.SquareImageView`
**Extends:** `android.widget.ImageView`

**Public methods (signature and line number):**

| Line | Signature |
|------|-----------|
| 13 | `public SquareImageView(Context context)` |
| 17 | `public SquareImageView(Context context, AttributeSet attrs)` |
| 21 | `public SquareImageView(Context context, AttributeSet attrs, int defStyle)` |

**Protected methods:**

| Line | Signature |
|------|-----------|
| 25 | `protected void onDraw(Canvas canvas)` |
| 30 | `protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec)` |

**Public fields:** None.

**Component type:** Custom `View`. Not an Activity, Service, BroadcastReceiver, or ContentProvider.

---

### File 3: SubFragPermission.java

**Fully qualified class name:** `com.yy.libcommon.SubFragPermission`
**Extends:** `BaseSubFragment`

**Public methods (signature and line number):**

| Line | Signature |
|------|-----------|
| 32 | `public SubFragPermission(BaseActivity baseActivity, BaseController baseController)` |
| 37 | `public void onCameraFeatureEnabled()` |
| 50 | `public void onCameraFeatureDisabled()` |
| 61 | `public void onFileFeatureEnabled()` |
| 74 | `public void onFileFeatureDisabled()` |
| 114 | `public void onActive()` |
| 123 | `public void onHidden()` |
| 128 | `public void onDestroy()` |
| 132 | `public boolean checkCameraPermissionWithRun(Runnable runnable)` |
| 150 | `public static boolean isFilePermissionEnabled(Context context)` |
| 159 | `public boolean checkFilePermissionWithRun(Runnable runnable)` |
| 180 | `public void requestFilePermission()` |
| 191 | `public void requestCameraPermission()` |
| 202 | `public void onRequestPermissionsResult(int requestCode, String permissions[], int[] grantResults)` |

**Public fields:**

| Line | Field |
|------|-------|
| 28 | `public Runnable cameraPendingRunnable` |
| 29 | `public Runnable filePendingRunnable` |
| 178 | `final public static int REQUEST_FILE_PERMISSION = 100` |
| 179 | `final public static int REQUEST_CAMERA_PERMISSION = 200` |

**Package-private fields:**
- Line 25: `final String FILE_EDIT_NOTIFY = "com.fleetiq.fleetiq360.file"` — package-private
- Line 26: `final String CAMERA_NOTIFY = "com.fleetiq.fleetiq360.file"` — package-private

**Component type:** Fragment helper class. Not a registered Activity, Service, BroadcastReceiver, or ContentProvider.

---

## Step 5 — Security Review Findings

### Section 1 — Signing and Keystores

No signing configs, keystore references, gradle files, or pipeline files present in the audited files. This section is not applicable to these source files.

No issues found — Signing and Keystores (not applicable to these files).

---

### Section 2 — Network Security

No HTTP clients, URL construction, OkHttp, Retrofit, HttpURLConnection, TrustManager overrides, or hostname verifier overrides are present in any of the three files.

`SignatureDialog.java` writes a signature bitmap to local file storage only. No network I/O.

No issues found — Network Security.

---

### Section 3 — Data Storage

**FINDING — LOW: Signature written to local file without path validation (SignatureDialog.java)**

`SignatureDialog.saveSignature()` (line 161) writes a JPEG bitmap to a file. When `filePath` is non-null, it constructs a `File` directly from the caller-supplied path (line 171: `file = new File(filePath)`). The `filePath` value originates from `Bundle` arguments passed at construction time via `newInstance(String path)` (line 55). No canonicalization or path traversal check is performed on this value before constructing the `FileOutputStream` (line 177). If a malicious or malformed path is supplied (e.g., `../../data/data/com.yy.libcommon/files/token`), the signature JPEG could be written to an arbitrary location on internal storage.

**Severity:** Low — requires a caller within the same process to supply a crafted path. No external surface in these files.

**FINDING — LOW: Signature image stored as plain JPEG on device storage (SignatureDialog.java)**

`saveSignature()` (lines 161–190) writes the operator's handwritten signature to disk as a plain JPEG (quality 75). If `filePath` resolves to external storage or a world-readable location (determined by the `FileManager.createLocalImageFile()` call or the supplied path), the signature image could be accessible to other applications. The `FileManager` implementation is not in scope for this review but should be verified.

**FINDING — INFO: `filePath` field has package-private visibility (SignatureDialog.java)**

Line 36: `String filePath` is declared without an access modifier, giving it package-private visibility. This is not a direct security vulnerability but is a code quality concern — it allows any class in the same package to read or overwrite the file path used for signature persistence without going through the public API.

No issues found — Data Storage (SquareImageView.java, SubFragPermission.java).

---

### Section 4 — Input and Intent Handling

**FINDING — LOW: Duplicate broadcast action string for CAMERA_NOTIFY and FILE_EDIT_NOTIFY (SubFragPermission.java)**

Lines 25–26:
```java
final String FILE_EDIT_NOTIFY = "com.fleetiq.fleetiq360.file";
final String CAMERA_NOTIFY = "com.fleetiq.fleetiq360.file";
```

Both `FILE_EDIT_NOTIFY` and `CAMERA_NOTIFY` are assigned the identical string value `"com.fleetiq.fleetiq360.file"`. In `onReceive()` (lines 89–111), the receiver checks `intent.getAction().equals(CAMERA_NOTIFY)` and then `intent.getAction().equals(FILE_EDIT_NOTIFY)` in sequence. Because both strings are equal, every matching broadcast will trigger both the camera branch (lines 95–101) and the file branch (lines 103–109) on the same intent. This means:

- A camera permission result broadcast will also invoke `onFileFeatureEnabled()` or `onFileFeatureDisabled()`.
- A file permission result broadcast will also invoke `onCameraFeatureEnabled()` or `onCameraFeatureDisabled()`.

This is a logic error with a potential security dimension: granting camera permission incorrectly also triggers the file-enabled callback, and vice versa, which could grant access to a feature that the user did not actually authorize.

**Severity:** Low — confined to LocalBroadcastManager (app-internal), so no external app can exploit the confusion. However, it creates an incorrect permission model within the app.

**FINDING — INFO: Public `Runnable` fields for pending permission callbacks (SubFragPermission.java)**

Lines 28–29:
```java
public Runnable cameraPendingRunnable;
public Runnable filePendingRunnable;
```

These fields are `public` and not `final`. Any code holding a reference to the `SubFragPermission` instance can replace the pending runnable before the permission callback fires, substituting a different action to be executed upon permission grant. The risk is low given the internal nature of these references, but the fields should be package-private or private with accessor methods.

**FINDING — INFO: Implicit LocalBroadcast action not unique to app package (SubFragPermission.java)**

The action string `"com.fleetiq.fleetiq360.file"` uses the `fleetiq360` namespace, not the app's own package namespace (`com.yy`). While `LocalBroadcastManager` confines these broadcasts to within the process, the mismatch with the declared package name is a consistency concern and may cause confusion or collision if the library is used in multiple contexts.

No issues found — Input and Intent Handling (SignatureDialog.java, SquareImageView.java) — no exported components, no WebView, no deep links.

---

### Section 5 — Authentication and Session

No authentication tokens, session management logic, or credential handling is present in any of the three files.

`SubFragPermission.java` manages runtime permissions (CAMERA, WRITE_EXTERNAL_STORAGE) only; it does not handle credentials or session tokens.

No issues found — Authentication and Session.

---

### Section 6 — Third-Party Libraries

No third-party library imports are present in any of the three files. All imports are from `android.*`, `java.*`, and `com.yy.libcommon.*`.

No issues found — Third-Party Libraries.

---

### Section 7 — Google Play and Android Platform

**FINDING — MEDIUM: Use of deprecated `WRITE_EXTERNAL_STORAGE` permission (SubFragPermission.java)**

`SubFragPermission` requests and checks `Manifest.permission.WRITE_EXTERNAL_STORAGE` (lines 151, 162, 181, 184). On Android 10 (API 29) and above, apps targeting API 29+ are subject to scoped storage. `WRITE_EXTERNAL_STORAGE` is deprecated as of API 29 and has no effect on API 33+. Apps still relying on this permission for storage operations will fail silently on modern devices. The correct approach for API 29+ is to use the MediaStore API or `ACTION_OPEN_DOCUMENT` / `ACTION_CREATE_DOCUMENT`.

**Severity:** Medium — this is a functional and correctness issue that affects runtime behavior on modern Android versions. On devices running Android 13+ (API 33), this permission is entirely ignored, meaning `isFilePermissionEnabled()` will always return `false` (the permission check will never be granted), potentially blocking legitimate file operations.

**FINDING — INFO: Use of deprecated `onActivityCreated()` (SignatureDialog.java)**

Line 68: `public void onActivityCreated(Bundle savedInstanceState)` — this `Fragment` lifecycle callback is deprecated as of API 28 (AndroidX). It should be replaced with `onViewCreated()` for view setup operations.

**FINDING — INFO: Use of `setDrawingCacheEnabled(true)` (SignatureDialog.java)**

Line 118: `mDrawingView.setDrawingCacheEnabled(true)` followed by `getDrawingCache()` at line 120. The drawing cache API (`setDrawingCacheEnabled`, `getDrawingCache`) was deprecated in API 28. The recommended replacement is `Bitmap.createBitmap(view.getWidth(), view.getHeight(), Bitmap.Config.ARGB_8888)` with `Canvas` drawing.

**FINDING — INFO: Old-style `android.support.v4` imports instead of AndroidX (SubFragPermission.java)**

Lines 9–11 use `android.support.v4.*` (support library), not `androidx.*`. The Android support library received its last update in 2018 and is superseded by AndroidX. Continued use of the support library prevents adoption of newer Jetpack APIs (including `EncryptedSharedPreferences`).

---

## Summary Table

| # | File | Severity | Section | Finding |
|---|------|----------|---------|---------|
| 1 | SignatureDialog.java | Low | Data Storage | Caller-supplied `filePath` used without path traversal validation before `FileOutputStream` write |
| 2 | SignatureDialog.java | Low | Data Storage | Signature image stored as plain JPEG; storage location security depends on `FileManager` implementation |
| 3 | SignatureDialog.java | Info | Data Storage | `filePath` field has package-private visibility |
| 4 | SubFragPermission.java | Low | Input/Intent | `FILE_EDIT_NOTIFY` and `CAMERA_NOTIFY` share identical action string, causing both callbacks to fire on any matching broadcast |
| 5 | SubFragPermission.java | Info | Input/Intent | `cameraPendingRunnable` and `filePendingRunnable` are `public` fields, externally mutable before callback fires |
| 6 | SubFragPermission.java | Info | Input/Intent | Broadcast action string namespace does not match app package |
| 7 | SubFragPermission.java | Medium | Platform/API | `WRITE_EXTERNAL_STORAGE` is deprecated (API 29+) and non-functional on API 33+; scoped storage required |
| 8 | SignatureDialog.java | Info | Platform/API | `onActivityCreated()` deprecated since API 28 |
| 9 | SignatureDialog.java | Info | Platform/API | `setDrawingCacheEnabled()` / `getDrawingCache()` deprecated since API 28 |
| 10 | SubFragPermission.java | Info | Platform/API | `android.support.v4` imports instead of AndroidX |

---

*End of report — Agent LC08*
