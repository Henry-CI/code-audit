# Pass 3 Findings: A51

## File: UrlItem.java
**Full path:** `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/UrlItem.java`

### Reading Evidence
- Class: `UrlItem`
- Public Methods: `UrlItem(int httpMethod, String webUrl)` (line 12)
- Public Fields: `method` (line 9), `url` (line 10)
- Constants/Types: none
- Class-level comment: `// Created by steveyang on 6/6/17.` (lines 3-5) — IDE-generated stub, not a Javadoc

### Findings

#### A51-1: `UrlItem` class has no Javadoc [INFO]
- File: `UrlItem.java`, Line: 7
- Description: The class has only an IDE-generated creation comment (`Created by steveyang on 6/6/17.`). There is no Javadoc describing the purpose of the class — i.e., that it is a simple data holder pairing an HTTP method integer with a URL string, used by `URLBuilder` and consumed by `GsonRequest`.

#### A51-2: `UrlItem(int, String)` constructor has no Javadoc [INFO]
- File: `UrlItem.java`, Line: 12
- Description: The public constructor has no Javadoc. The parameter names `httpMethod` and `webUrl` are reasonably descriptive, but there is no documentation of valid values for `httpMethod` (e.g., which integer constants are expected) or any constraint on `webUrl`.

#### A51-3: Public fields `method` and `url` have no documentation [INFO]
- File: `UrlItem.java`, Lines: 9-10
- Description: The public fields `method` and `url` carry no Javadoc or inline comments explaining what values are permissible or how they are used. `method` in particular is a raw `int` with no reference to the HTTP method constants it is expected to hold.

---

## File: WebApi.java
**Full path:** `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/WebApi.java`

### Reading Evidence
- Class: `WebApi`
- Public Methods (all lack Javadoc):
  - `sync()` (line 23)
  - `async()` (line 31)
  - `init(Context context)` (line 39)
  - `resendReport(int uid, int rid, WebListener<CommonResult>)` (line 47)
  - `saveShockEvent(SaveShockEventParameter, WebListener<CommonResult>)` (line 51)
  - `updateUser(int uid, UpdateUserParameter, WebListener<CommonResult>)` (line 55)
  - `addEquipment(AddEquipmentParameter, WebListener<CommonResult>)` (line 59)
  - `getEmails(int uid, WebListener<GetEmailResult>)` (line 63)
  - `getReports(int uid, WebListener<ReportResultArray>)` (line 67)
  - `getEquipmentStats(int uid, int frequency, WebListener<EquipmentStatsResultArray>)` (line 71)
  - `getDriverStats(int uid, WebListener<GetDriverStatsResultArray>)` (line 84)
  - `saveService(WebServiceParameterPacket, WebListener<WebServiceResultPacket>)` (line 88)
  - `getServiceRecord(int uid, WebListener<ServiceRecordResultArray>)` (line 92)
  - `resetPassword(ResetPasswordParameter, WebListener<WebServiceResultPacket>)` (line 112)
  - `login(LoginParameter, WebListener<LoginResultArray>)` (line 131)
  - `register(UserRegisterParameter, WebListener<LoginItem>)` (line 150)
  - `setupEmails(SetEmailsParameter, WebListener<WebServiceResultPacket>)` (line 187)
  - `getEquipmentList(int userId, WebListener<GetEquipmentResultArray>)` (line 192)
  - `getPreStartQuestionList(int eid, WebListener<PreStartQuestionResultArray>)` (line 210)
  - `savePreStartResult(SavePreStartParameter, WebListener<WebServiceResultPacket>)` (line 226)
  - `saveSessionStart(EquipmentItem, SessionStartParameter, WebListener<SessionResult>)` (line 243)
  - `syncSaveSession(SaveSessionsParameter, WebListener<SessionResult>)` (line 265)
  - `deleteSession(int sessionId, WebListener<WebServiceResultPacket>)` (line 269)
  - `saveSessionPreEnd(SessionResult, SessionEndParameter, WebListener<SessionEndResult>)` (line 286)
  - `saveSessionEnd(SessionResult, SessionEndParameter, WebListener<SessionEndResult>)` (line 300)
  - `getManufacture(WebListener<ManufactureResultArray>)` (line 321)
  - `getEquipmentType(int mid, WebListener<EquipmentTypeResultArray>)` (line 325)
  - `getFuelType(int mid, int etype, WebListener<FuelTypeResultArray>)` (line 329)
  - `saveLicense(SaveLicenseParameter, WebListener<SaveLicenseResult>)` (line 333)
  - `saveImpact(ImpactParameter, WebListener<SaveImpactResult>)` (line 337)
  - `saveSingleGPSLocation(SaveSingleGPSParameter, WebListener<SaveSingleGPSResult>)` (line 341)
  - `saveMultipleGPSLocation(SaveMultipleGPSParameter, WebListener<SaveMultipleGPSResult>)` (line 345)
- Package-private Methods (not public, excluded from public-method findings):
  - `authApp(WebListener<GetTokenResult>)` (line 96)
  - `enqueueRequest(GsonRequest<T>)` (line 43) — private
- Private Fields: `mContext` (static, line 19), `isSynchronous` (line 20), `httpClient` (line 21)
- Constants/Types: none

### Findings

#### A51-4: `WebApi` class has no Javadoc [INFO]
- File: `WebApi.java`, Line: 17
- Description: The class has no documentation describing its role as the application's primary HTTP API facade, how to obtain an instance (`sync()` vs `async()`), or the requirement to call `init(Context)` before use.

#### A51-5: `sync()` has no Javadoc [INFO]
- File: `WebApi.java`, Line: 23
- Description: No documentation explaining that this factory method returns a `WebApi` instance configured for synchronous execution, or any note about threading implications.

#### A51-6: `async()` has no Javadoc [INFO]
- File: `WebApi.java`, Line: 31
- Description: No documentation explaining that this factory method returns a `WebApi` instance configured for asynchronous (non-blocking) execution.

#### A51-7: `init(Context)` has no Javadoc [INFO]
- File: `WebApi.java`, Line: 39
- Description: No documentation stating that `init` must be called once (typically from `Application.onCreate`) before any other method on `WebApi` is used. Calling `sync()` or `async()` before `init()` will silently use a null `Context`, likely causing a `NullPointerException` at HTTP request time.

#### A51-8: `getEquipmentStats` inline comment is not Javadoc and is the only documentation in the file [INFO]
- File: `WebApi.java`, Line: 72
- Description: The comment `//frequency=0:weekly,1:monthly,2:yearly` (line 72) is a plain inline comment, not a Javadoc `@param` tag. It is also the sole documentation in the entire file. The valid range of `frequency` values (0, 1, 2) and the behaviour when an out-of-range value is supplied (a `null` `urlItem` is passed to `enqueueRequest`, which will likely produce a NullPointerException) are not formally documented.

#### A51-9: `login` and `resetPassword` undocumented conditional `authApp` behaviour [MEDIUM]
- File: `WebApi.java`, Lines: 112-148
- Description: Both `resetPassword` and `login` silently call `authApp` to obtain an application token when `WebData.isAppInitialized()` returns false, before dispatching the actual request. This non-trivial conditional flow — which adds a network round-trip and can fail independently — is completely undocumented. A caller has no indication that the method may perform two sequential network requests, that authentication failure will propagate as `onFailed`, or that success in authentication is required before the primary request fires.

#### A51-10: `register` undocumented side effect of setting `CurrentUser` [MEDIUM]
- File: `WebApi.java`, Lines: 150-185
- Description: On a successful response, `register` calls `CurrentUser.setUser(result)` (line 159), which sets the application's global current user state. This is a significant side effect not documented anywhere on the method. Callers who later call `register` in a non-login flow (e.g., admin provisioning) will unintentionally overwrite the active session's current user. The `authApp` conditional flow (lines 174-184) is also undocumented, as with `login`.

#### A51-11: `getEquipmentList` undocumented side effect of persisting to local database [MEDIUM]
- File: `WebApi.java`, Lines: 192-207
- Description: On success, `getEquipmentList` calls `EquipmentDb.saveEquipmentResultArray(userId, result)` (line 198) to persist the result to the local database before passing it to the caller's listener. This cache-write side effect is not documented on the method signature, so callers cannot reason about local database state changes triggered by this call.

#### A51-12: `getPreStartQuestionList` undocumented side effect of persisting to local database [MEDIUM]
- File: `WebApi.java`, Lines: 210-224
- Description: On success, `getPreStartQuestionList` calls `PreStartQuestionDb.saveQuestions(eid, result)` (line 215) to persist questions locally. This side effect is undocumented.

#### A51-13: `savePreStartResult` undocumented side effect of updating session state in local database [MEDIUM]
- File: `WebApi.java`, Lines: 226-241
- Description: On success, `savePreStartResult` calls `SessionDb.setSessionPreStartFinished(parameter.session_id, parameter, false)` (line 231) to update local session state. This database mutation is undocumented.

#### A51-14: `saveSessionStart` undocumented side effects: `prestart_required` mutation and local database write [MEDIUM]
- File: `WebApi.java`, Lines: 243-263
- Description: On success, `saveSessionStart` conditionally overrides `result.prestart_required` to `false` (line 252) if the driver has already completed a pre-start check today, then calls `SessionDb.saveData(result, equipmentItem, false)` (line 254) to persist the session locally. Both the field mutation and the database write are undocumented side effects that affect downstream behaviour.

#### A51-15: `deleteSession` undocumented side effect of marking session aborted in local database [MEDIUM]
- File: `WebApi.java`, Lines: 269-284
- Description: On success, `deleteSession` calls `SessionDb.setSessionAborted(sessionId, false)` (line 275) to update local session state. This side effect is undocumented.

#### A51-16: `saveSessionPreEnd` undocumented early-return for offline sessions [HIGH]
- File: `WebApi.java`, Lines: 286-298
- Description: `saveSessionPreEnd` contains a conditional early return (lines 292-295): if the session is offline and the `WebApi` instance is not synchronous and the listener is non-null, it immediately calls `resultListener.onSucceed(new SessionEndResult())` with an empty/default `SessionEndResult` without making any network request. The local database is updated (line 290) regardless. This behaviour — simulating success for offline sessions — is entirely undocumented. A caller receiving a `SessionEndResult` from this method cannot determine whether it reflects a real server response or a synthetic offline stub. The risk is HIGH because incorrect assumptions about the result could lead to data integrity errors in session handling.

#### A51-17: `saveSessionEnd` undocumented side effects: `SyncService` start and `onSessionEnded` callback [MEDIUM]
- File: `WebApi.java`, Lines: 300-319
- Description: On success, `saveSessionEnd` calls `SyncService.startService()` (line 309) and `WebData.instance().onSessionEnded()` (line 310) in addition to persisting session data via `SessionDb.setSessionFinished`. Starting a background service and triggering a BLE disconnection (via `onSessionEnded`) are non-trivial side effects that are entirely undocumented.

#### A51-18: All remaining public methods have no Javadoc [INFO]
- File: `WebApi.java`, Lines: 47, 51, 55, 59, 63, 67, 84, 88, 92, 187, 265, 321, 325, 329, 333, 337, 341, 345
- Description: The following public methods have no Javadoc at all: `resendReport`, `saveShockEvent`, `updateUser`, `addEquipment`, `getEmails`, `getReports`, `getDriverStats`, `saveService`, `getServiceRecord`, `setupEmails`, `syncSaveSession`, `getManufacture`, `getEquipmentType`, `getFuelType`, `saveLicense`, `saveImpact`, `saveSingleGPSLocation`, `saveMultipleGPSLocation`. While these methods have relatively straightforward names, they lack parameter semantics, return value descriptions, and notes on the callback contract.

---

## File: WebData.java
**Full path:** `app/src/main/java/au/com/collectiveintelligence/fleetiq360/WebService/WebData.java`

### Reading Evidence
- Class: `WebData` (singleton)
- Public Methods:
  - `getTempSessionId()` (line 29) — `public static`
  - `isSessionOffline(int sessionId)` (line 40) — `public static`
  - `getTempSessionResult(SessionStartParameter)` (line 46) — `public static`
  - `getTokenFormData()` (line 56) — instance
  - `instance()` (line 84) — `public static` singleton accessor
  - `getSessionResult()` (line 96) — instance
  - `onSessionEnded()` (line 100) — instance
  - `isValidMacAddress(String)` (line 104) — `public static`
  - `logout()` (line 108) — instance
  - `getUserId()` (line 112) — instance
- Package-private Methods (not public):
  - `setGetTokenResult(GetTokenResult)` (line 91)
  - `isAppInitialized()` (line 124)
  - `setHttpHeaderForConnection(HttpURLConnection)` (line 129)
  - `getAuthHeader()` (line 134)
  - `setHttpHeader(boolean, Map<String,String>)` (line 138)
- Private Methods:
  - `getTokenString()` (line 117)
- Private Fields: `ourInstance` (line 21), `getTokenResult` (line 25)
- Constants:
  - `authHeaderType` = `"Authorization"` (line 22) — `private static final String`
  - `MAC_ADDRESS_LENGTH` = `17` (line 23) — `private static final int`
  - `TOKEN_ITEM_KEY` = `"token_result"` (line 27) — `private static final String`

### Findings

#### A51-19: `WebData` class has no Javadoc [INFO]
- File: `WebData.java`, Line: 20
- Description: The class has no documentation describing its role as the central web-layer data and state manager, its singleton nature, its responsibility for token management, or its relationship to `WebApi`.

#### A51-20: `getTempSessionId()` has no Javadoc and has a misleading name relative to its implementation [MEDIUM]
- File: `WebData.java`, Lines: 29-34
- Description: The method name `getTempSessionId` implies a simple read accessor, but the implementation mutates persistent storage on every call: it reads the last saved session ID from `ModelPrefs`, decrements it (producing a new negative integer), writes the updated value back, and returns the new value. This is a stateful generator, not a getter. The lack of Javadoc means callers cannot know that (a) calling this method twice yields two different values, (b) it always returns a negative integer (used as a sentinel for locally-created offline sessions), or (c) there is an integer overflow risk if called enough times (no guard is present). Additionally, the method has a double-space in its declaration (`public  static`) at line 29, indicating a typographical issue, though this is syntactically harmless.

#### A51-21: `isSessionOffline(int sessionId)` has no Javadoc [INFO]
- File: `WebData.java`, Line: 40
- Description: No documentation explaining that a session is considered offline if either the device has no network connection OR if `SessionDb.hasOfflineData(sessionId)` returns true (i.e., local-only session data exists). The dual condition is non-obvious.

#### A51-22: `getTempSessionResult(SessionStartParameter)` has no Javadoc [INFO]
- File: `WebData.java`, Line: 46
- Description: No documentation explaining that this method constructs a synthetic `SessionResult` for use when offline, using a locally-generated negative session ID, and that `prestart_required` is determined by whether a pre-start check has already been completed today.

#### A51-23: `getTokenFormData()` contains hardcoded credentials with no documentation [HIGH]
- File: `WebData.java`, Lines: 56-82
- Description: The method assembles an OAuth2 `password`-grant form body containing hardcoded `client_id` (`987654321`), `client_secret` (`8752361E593A573E86CA558FFD39E`), `username` (`gas`), and `password` (`ciiadmin`). These are plaintext credentials embedded in source code. The method has no Javadoc, no comment acknowledging the sensitivity of the values, and no explanation of why this approach is used or what service these credentials authenticate against. The absence of any documentation amplifies the risk: there is no in-code indication that these values should ever be rotated, stored securely, or treated as sensitive. This finding is HIGH because the hardcoded credentials are undocumented and appear to be application-level OAuth credentials that could grant unauthorized API access if the source is exposed.

#### A51-24: `instance()` singleton accessor has no Javadoc [INFO]
- File: `WebData.java`, Line: 84
- Description: No documentation noting the singleton pattern, that the instance is lazily created on first call, or any thread-safety considerations (the lazy initialisation at lines 85-88 is not synchronized and is not thread-safe under concurrent access).

#### A51-25: `getSessionResult()` has no Javadoc [INFO]
- File: `WebData.java`, Line: 96
- Description: No documentation stating that this method reads the currently running session from the local database (`SessionDb.readRunningSession()`), or what is returned when no session is active (likely `null`, but not stated).

#### A51-26: `onSessionEnded()` has no Javadoc [INFO]
- File: `WebData.java`, Line: 100
- Description: The method name `onSessionEnded` resembles an event callback but is called imperatively from `WebApi.saveSessionEnd`. It stops the BLE connection via `BleController.instance().stopConnection()`. The coupling to BLE state is a non-obvious side effect that is entirely undocumented.

#### A51-27: `isValidMacAddress(String)` has no Javadoc and its validation logic is misleading [LOW]
- File: `WebData.java`, Line: 104
- Description: The method is named `isValidMacAddress` and documented by nothing. The implementation only checks that the string is non-null and exactly 17 characters long (`address.length() == MAC_ADDRESS_LENGTH`). It does not validate MAC address format (e.g., colon-separated hex pairs such as `AA:BB:CC:DD:EE:FF`). A string of 17 arbitrary characters would pass validation. Without documentation, callers cannot know the validation is length-only, and may incorrectly assume format validity is also enforced.

#### A51-28: `logout()` has no Javadoc [INFO]
- File: `WebData.java`, Line: 108
- Description: No documentation explaining what `logout` does, specifically that it delegates entirely to `CurrentUser.logout()` and does not clear the stored OAuth token, session data, or any other `WebData` state.

#### A51-29: `getUserId()` has no Javadoc [INFO]
- File: `WebData.java`, Line: 112
- Description: No documentation stating that this returns the ID of the currently logged-in user, or that it returns `-1` when no user is logged in (`CurrentUser.get()` returns `null`).
