# Pass 2: Test Coverage — A33
**Agent:** A33
**Branch verified:** master (confirmed via .git/HEAD: `ref: refs/heads/master`)
**Files reviewed:** src/gmtp/GMTPRouter.java, src/gmtp/GMTPServer.java, src/gmtp/XmlConfiguration.java
**Test file read:** test/TestDataMessageHandler.java

---

## Reading Evidence

### GMTPRouter.java

**Class name:** `gmtp.GMTPRouter`

**Fields and constants (all static):**

| Name | Type | Line |
|------|------|------|
| `config` | `Configuration` (private static) | 27 |
| `routingMap` | `RoutingMap` (private static) | 31 |
| `gmtpServer` | `Server` (private static) | 35 |
| `ftpServer` | `FTPServer` (public static) | 39 |
| `manageFtpConnections` | `Boolean` (public static) | 40 |
| `logger` | `Logger` (private static) | 44 |
| `gmtpConfigManager` | `ConfigurationManager` (public static) | 45 |
| `dbIsInit` | `boolean` (private static) | 46 |
| `configPath` | `String` (public static) | 47 |
| `deniedPrefixes` | `HashMap<Integer, String>` (public static) | 48 |
| `deniedPrefixesManager` | `DeniedPrefixesManager` (public static) | 49 |

**Methods and constructors:**

| Name | Modifier | Line |
|------|----------|------|
| `main(String[])` | public static | 51 |
| `loadConfiguration()` | private static | 128 |
| `loadRoutingMap(String)` | private static | 151 |
| `startServer(ConfigurationManager, HashMap<String,String>)` | private static | 161 |
| `createURI(String, int, String)` | private static | 178 |
| `initDatabases(Configuration)` | public static | 184 |
| `isEmpty(String)` | public static | 326 |
| `isNotEmpty(String)` | public static | 330 |
| `setDBInitialized()` | private synchronized static | 334 |
| `getDBInitialized()` | private synchronized static | 338 |
| `loadDeniedPrefixes()` | private static | 342 |
| `launchFTPServices()` | private static | 349 |

---

### GMTPServer.java

**Class name:** `gmtp.GMTPServer`

**Fields:**

| Name | Type | Line |
|------|------|------|
| `acceptor` | `SocketAcceptor` (private) | 34 |
| `port` | `int` (private final) | 35 |
| `routingMap` | `HashMap<String,String>` (private) | 36 |
| `outgoingMessageManager` | `OutgoingMessageManager` (private) | 37 |
| `outgoingMessageResendManager` | `OutgoingMessageManager` (private) | 38 |
| `telnetServer` | `TelnetServer` (private) | 39 |
| `logger` | `Logger` (private static) | 40 |
| `configManager` | `ConfigurationManager` (private final) | 41 |
| `WriteBufferSize` | `int` (private final) = 1024 | 43 |

**Methods and constructors:**

| Name | Modifier | Line |
|------|----------|------|
| `GMTPServer(ConfigurationManager, HashMap<String,String>)` | package-private constructor | 45 |
| `start()` | public | 92 |
| `startTelnetServer(Configuration)` | private | 133 |

---

### XmlConfiguration.java

**Class name:** `gmtp.XmlConfiguration` (implements `configuration.Configuration`)

**Fields (all private, bound via Simple XML annotations):**

| Name | Type | Line |
|------|------|------|
| `id` | `String` (@Attribute) | 12 |
| `port` | `int` (@Element) | 14 |
| `ioThreads` | `int` (@Element) | 16 |
| `maxWorkerThreads` | `int` (@Element) | 18 |
| `routesFolder` | `String` (@Element) | 20 |
| `deniedPrefixesFile` | `String` (@Element) | 22 |
| `tcpNoDelay` | `boolean` (@Element) | 24 |
| `outgoingDelay` | `int` (@Element) | 26 |
| `reloadConfigInterval` | `int` (@Element) | 28 |
| `outgoingInterval` | `int` (@Element) | 30 |
| `outgoingResendInterval` | `int` (@Element) | 32 |
| `dbHost` | `String` (@Element) | 34 |
| `dbName` | `String` (@Element) | 36 |
| `dbPort` | `int` (@Element) | 38 |
| `dbUser` | `String` (@Element) | 40 |
| `dbPass` | `String` (@Element) | 42 |
| `dbHostDefault` | `String` (@Element) | 44 |
| `dbNameDefault` | `String` (@Element) | 46 |
| `dbPortDefault` | `int` (@Element) | 48 |
| `dbUserDefault` | `String` (@Element) | 50 |
| `dbPassDefault` | `String` (@Element) | 52 |
| `telnetPort` | `int` (@Element) | 54 |
| `telnetUser` | `String` (@Element) | 56 |
| `telnetPassword` | `String` (@Element) | 58 |
| `manageFTP` | `Boolean` (@Element) | 60 |
| `ftpPort` | `Integer` (@Element) | 62 |
| `ftpUserFile` | `String` (@Element) | 64 |
| `ftpRoot` | `String` (@Element) | 66 |
| `ftpMaxConnection` | `Integer` (@Element) | 68 |
| `ftpServer` | `String` (@Element) | 70 |
| `ftpPassivePorts` | `String` (@Element) | 72 |
| `ftpExternalAddr` | `String` (@Element) | 74 |
| `ftpimagetype` | `String` (@Element) | 76 |
| `connectionPoolSize` | `int` (@Element) | 78 |

**Methods and constructors:**

| Name | Modifier | Line |
|------|----------|------|
| `XmlConfiguration()` | public constructor | 81 |
| `XmlConfiguration(String, int, int, String)` | public constructor | 85 |
| `getIoThreads()` | public | 92 |
| `getIdentity()` | public | 96 |
| `getMaxThreads()` | public | 100 |
| `getPort()` | public | 104 |
| `getRoutesFolder()` | public | 108 |
| `getDeniedPrefixesFile()` | public | 112 |
| `getTcpNoDelay()` | public | 116 |
| `getOutgoingDelay()` | public | 120 |
| `getReloadConfigInterval()` | public | 124 |
| `getOutgoingInterval()` | public | 128 |
| `getOutgoingResendInterval()` | public | 132 |
| `getDbHost()` | public | 136 |
| `getDbName()` | public | 140 |
| `getDbPass()` | public | 144 |
| `getDbPort()` | public | 148 |
| `getDbUser()` | public | 152 |
| `getTelnetPassword()` | public | 156 |
| `getTelnetPort()` | public | 160 |
| `getTelnetUser()` | public | 164 |
| `getDbHostDefault()` | public | 168 |
| `getDbNameDefault()` | public | 172 |
| `getDbPassDefault()` | public | 176 |
| `getDbPortDefault()` | public | 180 |
| `getDbUserDefault()` | public | 184 |
| `manageFTP()` | public | 188 |
| `getFtpPort()` | public | 192 |
| `getFtpUserFile()` | public | 196 |
| `getFtpRoot()` | public | 200 |
| `getFtpMaxConnection()` | public | 204 |
| `getFtpServer()` | public | 208 |
| `getFtpPassivePorts()` | public | 212 |
| `getFtpExternalAddr()` | public | 216 |
| `getFtpimagetype()` | public | 220 |
| `getConnectionPoolSize()` | public | 224 |

---

## Test Coverage Assessment

The only test file in `test/` is `TestDataMessageHandler.java`. A grep of the entire `test/` directory for class names `GMTPRouter`, `GMTPServer`, and `XmlConfiguration` returned zero matches. A further grep for every public method name from all three source files also returned zero matches. The test file imports only `gmtp.DataMessageHandler`, `gmtp.GMTPMessage`, and `gmtp.outgoing.OutgoingMessage`, and its single test method `testSendAuthResponse` exercises `DataMessageHandler.sendAuthResponse`.

**Coverage summary:**

| Class | Methods | Tested methods | Untested methods |
|-------|---------|----------------|-----------------|
| GMTPRouter | 12 | 0 | 12 (all) |
| GMTPServer | 3 | 0 | 3 (all) |
| XmlConfiguration | 38 | 0 | 38 (all) |

---

## Findings

## A33-1 — GMTPRouter entirely untested

**Severity:** HIGH
**File:** src/gmtp/GMTPRouter.java
**Description:** No test in `test/` exercises any method in `GMTPRouter`. The class is the application entry point and orchestrates configuration loading, routing map construction, database pool initialisation, FTP service startup, denied-prefix loading, and server startup. All twelve methods — including the two public utility methods `isEmpty` and `isNotEmpty` and the public `initDatabases` — are completely uncovered. Defects in any of these could cause silent misconfiguration or a failure to start without producing a meaningful error.
**Fix:** Add a dedicated `TestGMTPRouter` JUnit test class. At minimum: (1) unit-test `isEmpty` and `isNotEmpty` with null, empty-string, and non-empty inputs; (2) unit-test `createURI` via reflection or package-visibility to verify correct JDBC URL construction; (3) integration-test `initDatabases` against an in-memory or embedded PostgreSQL instance (e.g., `embedded-postgres`); (4) test that `main` throws `IllegalArgumentException` when the `gmtpConfig` system property is absent.

---

## A33-2 — GMTPRouter routing logic for unknown unitName not tested

**Severity:** HIGH
**File:** src/gmtp/GMTPRouter.java
**Description:** `loadRoutingMap` wraps `XmlRoutingMap` construction in a generic catch-all that silently returns `false`. There is no test that verifies behaviour when the routes folder is absent, contains invalid XML, or yields an empty map. More critically, the downstream path in `DataMessageHandler` (which uses the routing map) has no test demonstrating what happens when a lookup returns no matching route for a given unit name. Messages to unknown units could be silently discarded or misrouted.
**Fix:** Write tests that call `loadRoutingMap` (or the `XmlRoutingMap` constructor directly) with: (a) a valid routes folder, (b) a non-existent folder, (c) a folder containing malformed XML. Assert correct return values and exception/log output. Add a separate test that exercises routing lookup with an unregistered unit name and confirms the expected error response is sent to the client.

---

## A33-3 — deniedPrefixes reload logic not tested

**Severity:** HIGH
**File:** src/gmtp/GMTPRouter.java
**Description:** `loadDeniedPrefixes` creates a `DeniedPrefixesManager` configured with a reload interval (`config.getReloadConfigInterval()`), starts it as a background daemon, and stores the loaded map in the public static field `GMTPRouter.deniedPrefixes`. There are no tests that verify: (a) the map is populated correctly from a well-formed prefixes file; (b) an empty or malformed file produces an empty `HashMap` without throwing; (c) the map is refreshed after the configured interval elapses; (d) concurrent reads of `deniedPrefixes` during a reload do not cause race conditions (the field is not declared `volatile` and is accessed without synchronisation).
**Fix:** Write tests covering normal load, malformed-file fallback, and the reload path. Add a concurrency test using multiple threads reading `deniedPrefixes` while a reload is triggered. Declare `deniedPrefixes` `volatile` or guard it with the same `synchronized` pattern used for `dbIsInit`.

---

## A33-4 — GMTPServer lifecycle entirely untested

**Severity:** HIGH
**File:** src/gmtp/GMTPServer.java
**Description:** `GMTPServer` has three methods — the constructor, `start()`, and `startTelnetServer()` — none of which are exercised by any test. The constructor initialises the MINA `NioSocketAcceptor`, wires codec and executor filters, starts two `OutgoingMessageManager` daemons, and launches the telnet server; `start()` binds the listening socket and registers a JVM shutdown hook. No test verifies successful startup, port-in-use failure handling (the `IOException` path in `start()`), graceful shutdown hook behaviour, or that the shutdown hook correctly closes all managed sessions before halting the JVM.
**Fix:** Use a test double (mock or stub) for `ConfigurationManager` and `NioSocketAcceptor` to unit-test constructor wiring. Write an integration test that starts `GMTPServer` on an ephemeral port, verifies a TCP connection is accepted, then triggers the shutdown hook and confirms the acceptor is disposed. Test the `IOException` path by attempting to bind a port that is already in use and assert `start()` returns `false`.

---

## A33-5 — XmlConfiguration XML parsing entirely untested

**Severity:** HIGH
**File:** src/gmtp/XmlConfiguration.java
**Description:** `XmlConfiguration` uses Simple XML Framework annotations to deserialise configuration from XML. None of its 38 methods, two constructors, or the XML deserialisation path are covered by any test. The following scenarios are unverified: (a) a fully valid XML document produces correct field values from all 34 `@Element` and one `@Attribute` bindings; (b) a document with a missing required `@Element` (e.g., `<port>` absent) — the framework's behaviour (exception vs. default) is untested; (c) a malformed XML document does not crash the server silently; (d) extra unexpected XML elements are handled gracefully; (e) the four-argument convenience constructor correctly sets `id`, `port`, `maxWorkerThreads`, and `routesFolder` while leaving all other fields at their zero/null defaults.
**Fix:** Write a `TestXmlConfiguration` JUnit class that: (1) deserialises a complete valid XML fixture and asserts each getter returns the expected value; (2) attempts to deserialise XML with one required element removed and asserts the expected exception or fallback; (3) supplies malformed XML and asserts an exception is propagated rather than swallowed; (4) tests the four-argument constructor for correct field assignment.

---

## A33-6 — XXE risk in XML configuration parsing not tested

**Severity:** MEDIUM
**File:** src/gmtp/XmlConfiguration.java
**Description:** The Simple XML Framework uses a standard Java SAX or DOM parser internally. By default, these parsers may permit XML External Entity (XXE) references. If an attacker can write or influence the configuration file path (e.g., via the `gmtpConfig` system property), a crafted XML file containing a DOCTYPE with an external entity reference could read arbitrary local files or cause SSRF. There is no test that supplies an XXE payload and confirms it is rejected.
**Fix:** Confirm whether the version of Simple XML in use disables external entities by default. If not, configure the underlying `XMLInputFactory` or `SAXParserFactory` with `XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES = false` and `XMLConstants.FEATURE_SECURE_PROCESSING = true`. Add a test that passes an XML document containing a DOCTYPE external entity reference and asserts parsing either rejects it or strips the entity value.

---

## A33-7 — Route map edge cases (empty, single entry, duplicate entry) not tested

**Severity:** MEDIUM
**File:** src/gmtp/GMTPRouter.java
**Description:** `loadRoutingMap` passes the result of `routingMap.getMap()` directly to `GMTPServer` and ultimately to the codec factory. There is no test exercising: (a) an empty routing map (no route files in the folder) — the server would start but silently drop all messages; (b) a routing map with a single entry — the degenerate case; (c) a routing map with duplicate unit-name keys, which in Java's `HashMap` would silently overwrite the earlier entry, potentially routing traffic to the wrong destination.
**Fix:** Write parameterised tests for `XmlRoutingMap` covering zero routes, one route, and two routes with the same key. Assert that duplicate keys produce a logged warning or throw a configuration exception rather than silently overwriting.

---

## A33-8 — Concurrent access to static `deniedPrefixes` field not tested

**Severity:** MEDIUM
**File:** src/gmtp/GMTPRouter.java
**Description:** `GMTPRouter.deniedPrefixes` is a public, non-volatile static field. `DeniedPrefixesManager` writes a new `HashMap` reference to this field on each reload cycle while connection handler threads read it concurrently. There is no synchronisation guard and no test that exercises concurrent read/write. Under the Java Memory Model, a plain field write is not guaranteed to be visible to other threads without at least a `volatile` declaration, creating a data race.
**Fix:** Declare `deniedPrefixes` as `volatile`. Write a concurrent test using `CountDownLatch` or `CyclicBarrier` to have multiple reader threads observe the field while a writer thread replaces the map, and assert no `NullPointerException` or stale-read anomaly occurs.

---

## A33-9 — `isEmpty` / `isNotEmpty` utility methods not tested

**Severity:** LOW
**File:** src/gmtp/GMTPRouter.java
**Description:** `isEmpty` and `isNotEmpty` are public static utility methods used internally for null and empty-string guards throughout `initDatabases`. Neither method has a corresponding unit test. While the logic is simple (one-liners), an untested utility relied upon across database initialisation represents a latent coverage gap.
**Fix:** Add tests in a `TestGMTPRouter` class for `isEmpty(null)`, `isEmpty("")`, `isEmpty("x")`, and the symmetric `isNotEmpty` variants.

---

## A33-10 — `startServer` busy-wait on `dbIsInit` not tested

**Severity:** LOW
**File:** src/gmtp/GMTPRouter.java
**Description:** `startServer` contains an unbounded `while(true)` loop that sleeps 1 second per iteration until `getDBInitialized()` returns `true`. If `initDatabases` is never called or fails silently, the loop runs forever without any timeout or retry limit. There is no test that verifies `initDatabases` is called before `startServer`, nor any test that confirms the loop terminates within a bounded period.
**Fix:** Introduce a timeout or maximum-retry count to the busy-wait loop, logging a fatal error and returning `false` after the deadline is exceeded. Write a test that simulates `initDatabases` never completing and asserts the server does not block indefinitely.

---

## Summary

| ID | Severity | Description |
|----|----------|-------------|
| A33-1 | HIGH | GMTPRouter entirely untested — all 12 methods uncovered |
| A33-2 | HIGH | Routing logic for unknown unitName and bad routes folder not tested |
| A33-3 | HIGH | deniedPrefixes loading, reload, and concurrent-access not tested |
| A33-4 | HIGH | GMTPServer lifecycle (constructor, start, shutdown hook) entirely untested |
| A33-5 | HIGH | XmlConfiguration XML parsing entirely untested — all 38 methods uncovered |
| A33-6 | MEDIUM | XXE risk in XML configuration parsing not tested |
| A33-7 | MEDIUM | Route map edge cases (empty, single, duplicate) not tested |
| A33-8 | MEDIUM | Concurrent access to non-volatile static `deniedPrefixes` field not tested |
| A33-9 | LOW | `isEmpty` / `isNotEmpty` utility methods not tested |
| A33-10 | LOW | `startServer` unbounded busy-wait on `dbIsInit` not tested |
