# Pass 2: Test Coverage — A01 (Config/Deploy Files)

**Agent:** A01
**Branch verified:** master (confirmed via `.git/HEAD` → `ref: refs/heads/master`)
**Files reviewed:** gmtpRouter.xml, gmtpmina.xml, deniedPrefixes.xml, routes/all.xml, build.xml, startup.sh, install.sh (empty), installer/install.sh, nbproject/project.properties, nbproject/project.xml
**Test file read:** test/TestDataMessageHandler.java

---

## Reading Evidence

### 1. test/TestDataMessageHandler.java

**File type and purpose:** JUnit 3 test class (extends `TestCase`). The entire test suite for this repository consists of this single file.

**Coverage provided:**
- Line 15: `testSendAuthResponse()` — tests `DataMessageHandler.sendAuthResponse()` with a `true` (auth accepted) case and a `false` (auth denied) case, asserting message type `DATA` and message text `IDAUTH=<id>` / `IDDENY=<id>`.

**What is NOT covered:** Every configuration file, all deployment scripts, all XML config-loading code paths, database connectivity, FTP server setup, telnet server setup, routing, denied-prefix filtering, and the startup/install lifecycle.

---

### 2. gmtpRouter.xml

**File type and purpose:** Primary runtime XML configuration for the GMTP server. Parsed at startup via `XmlConfigurationLoader` / `ConfigurationManager`.

**Configurable parameters defined (with line numbers):**

| Line | Parameter | Value |
|------|-----------|-------|
| 3 | `configuration id` | `4321` |
| 11 | `port` | `4687` |
| 13 | `ioThreads` | `5` |
| 15 | `maxWorkerThreads` | `256` |
| 17 | `routesFolder` | `./routes` |
| 19 | `deniedPrefixesFile` | `deniedPrefixes.xml` |
| 21 | `connectionPoolSize` | `100` |
| 32 | `tcpNoDelay` | `true` (plus stray trailing text `th` — malformed XML content) |
| 34 | `outgoingDelay` | `1000` |
| 39 | `reloadConfigInterval` | `30` |
| 41 | `outgoingInterval` | `30` |
| 43 | `outgoingResendInterval` | `60` |
| 50 | `dbHost` | `127.0.0.1` |
| 51 | `dbName` | `GlobalSettings` |
| 52 | `dbPort` | `5432` |
| 53 | `dbUser` | `gmtp` |
| 54 | `dbPass` | `gmtp-postgres` (plaintext credential) |
| 58 | `dbHostDefault` | `127.0.0.1` |
| 59 | `dbNameDefault` | `fleetiq360_dup` |
| 60 | `dbPortDefault` | `5432` |
| 61 | `dbUserDefault` | `gmtp` |
| 62 | `dbPassDefault` | `gmtp-postgres` (plaintext credential) |
| 70 | `telnetPort` | `9494` |
| 72 | `telnetUser` | `gmtp` |
| 74 | `telnetPassword` | `gmtp!telnet` (plaintext credential) |
| 82 | `manageFTP` | `false` |
| 84 | `ftpServer` | `127.0.0.1` |
| 86 | `ftpPort` | `2221` |
| 88 | `ftpUserFile` | `ftpUsers.properties` |
| 90 | `ftpRoot` | `/home/gmtp/gmtpPublicFtp/` |
| 92 | `ftpMaxConnection` | `1000` |
| 94 | `ftpExternalAddr` | `203.35.168.201` (hardcoded public IP) |
| 96 | `ftpPassivePorts` | `2222-2229` |
| 98 | `ftpimagetype` | `jpg` |

**Test coverage search result:** Grep of `test/` for values `4687`, `9494`, `gmtp-postgres`, `GlobalSettings`, `deniedPrefixes`, `gmtpRouter`, `telnetPassword`, `ftpUsers` — zero matches. This file is entirely untested.

---

### 3. gmtpmina.xml

**File type and purpose:** IntelliJ IDEA Ant build descriptor for the GmtpMina module. Controls compilation, test compilation, artifact packaging, and deployment.

**Targets and properties defined (with line numbers):**

| Line | Item | Value/Purpose |
|------|------|---------------|
| 6 | `property file` | `gmtpmina.properties` — external property source |
| 7–9 | Commented-out `skip.tests` | Tests CAN be skipped by uncommenting |
| 13 | `compiler.debug` | `on` |
| 14 | `compiler.generate.no.warnings` | `off` |
| 16 | `compiler.max.memory` | `128m` |
| 85 | `project.jdk.home` | `${jdk.home.1.6}` |
| 143 | `gmtpmina.output.dir` | `out/production/GmtpMina` |
| 144 | `gmtpmina.testoutput.dir` | `out/test/GmtpMina` |
| 198 | Target: `compile.module.gmtpmina` | Compile production + test sources |
| 200 | Target: `compile.module.gmtpmina.production` | Compiles `src/` |
| 218 | Target: `compile.module.gmtpmina.tests` | Compiles `test/` (skipped if `skip.tests` set) |
| 236 | Target: `clean.module.gmtpmina` | Deletes output dirs |
| 241 | Target: `init` | Empty initialization hook |
| 245 | Target: `clean` | Calls clean module + clean artifact |
| 247 | Target: `build.modules` | init, clean, compile |
| 249 | Target: `init.artifacts` | Sets artifact temp/output dirs |
| 256 | Target: `clean.artifact.gmtpmina:jar` | Deletes artifact output |
| 260 | Target: `artifact.gmtpmina:jar` | Packages JAR and copies all dependency JARs |
| 295 | Target: `build.all.artifacts` | Calls artifact.gmtpmina:jar + cleanup |
| 300 | Target: `deploy` | Copies JAR and log4j.properties to `${deploy.path}` |
| 304 | Target: `all` (default) | build.modules + build.all.artifacts |

**Key observation:** `gmtpmina.xml` compiles test sources but defines no `<junit>` task and no test-execution target. Tests are compiled but never automatically run by this build file.

**Test coverage search result:** No test references config values from this file. No CI hook or test-runner target exists.

---

### 4. deniedPrefixes.xml

**File type and purpose:** XML data file listing network message prefixes to be blocked by `DeniedPrefixesManager`.

**Parameters defined:**

| Line | Parameter | Value |
|------|-----------|-------|
| 3 | `prefix id="0"` | `tms` |

**Test coverage search result:** Grep of `test/` for `tms`, `deniedPrefixes`, `DeniedPrefix` — zero matches. The denied-prefix filtering logic and this data file are entirely untested.

---

### 5. routes/all.xml

**File type and purpose:** XML routing rules file. Each `<trigger>` maps a message pattern to a shell script path. Loaded by `XmlRoutes` / `RoutingMap`.

**Parameters defined:**

| Line | Parameter | Value |
|------|-----------|-------|
| 2 | `trigger pattern="__EXAMPLE__"` | `/home/michel/test.sh` |

**Observations:** The sole entry is an example placeholder pointing to a developer's home directory (`/home/michel/test.sh`). This is a developer-local path that would fail on any other deployment. There is no production routing rule defined.

**Test coverage search result:** Grep of `test/` for `__EXAMPLE__`, `all.xml`, `routes`, `RoutingMap`, `XmlRoutes` — zero matches.

---

### 6. build.xml (NetBeans build.xml)

**File type and purpose:** NetBeans-generated top-level Ant build file for the GmtpMina project. Imports `nbproject/build-impl.xml` which provides the full NetBeans build lifecycle including `test` and `test-report` targets.

**Targets defined:**

| Line | Target | Purpose |
|------|--------|---------|
| 15 | `-post-jar` | Post-JAR hook: deletes `server/` dir, rebuilds it, copies JAR, config files, scripts, routes, libs, installer files |

**Key observations:**
- The `-post-jar` target copies `gmtpRouter.xml` and `deniedPrefixes.xml` into the `server/` staging directory but does NOT copy `gmtpmina.xml` or `routes/all.xml` into the JAR artifact.
- `build.xml` does not define or override any test-execution target. Test execution is delegated entirely to the imported `nbproject/build-impl.xml`.
- There is no smoke test, schema validation step, or config file sanity check in the post-jar phase.

**Test coverage search result:** No test invocation in `build.xml`. No CI wrapper or script invokes tests either.

---

### 7. startup.sh

**File type and purpose:** Linux SysV init script for the GMTP daemon process. Manages start/stop/restart/status lifecycle.

**Functions and variables defined (with line numbers):**

| Line | Item | Value/Purpose |
|------|------|---------------|
| 22 | `JAVA_HOME` | `/usr/java/latest` |
| 23 | `gmtpConfig` | `/etc/gmtp` |
| 25 | `serviceNameLo` | `gmtp` |
| 26 | `serviceName` | `gmtp` |
| 27 | `serviceUser` | `gmtp` |
| 28 | `serviceGroup` | `gmtp` |
| 29 | `applDir` | `/var/lib/gmtp` |
| 30 | `serviceUserHome` | `/home/gmtp` |
| 31 | `serviceLogFile` | `/var/log/gmtp.log` |
| 32 | `maxShutdownTime` | `15` |
| 33 | `pidFile` | `/var/run/gmtp.pid` |
| 34 | `javaCommand` | `java` |
| 35 | `javaExe` | `$JAVA_HOME/bin/java` |
| 36 | `javaArgs` | `-DgmtpConfig=${gmtpConfig} -jar $applDir/GmtpMina.jar` |
| 38 | `javaCommandLineKeyword` | `GmtpMina.jar` |
| 41–46 | Function: `makeFileWritable` | Sets group ownership and write permission on a file |
| 49–53 | Function: `checkProcessIsRunning` | Tests `/proc/<pid>` existence |
| 56–61 | Function: `checkProcessIsOurService` | Validates process name and cmdline keyword |
| 64–69 | Function: `getServicePID` | Reads PID file, validates running + owned service |
| 71–84 | Function: `startServiceProcess` | `su`-executes JVM as service user with `nohup` |
| 86–108 | Function: `stopServiceProcess` | SIGTERM then SIGKILL with polling |
| 110–118 | Function: `startService` | Guards against double-start |
| 120–128 | Function: `stopService` | Guards against stop-when-not-running |
| 130–139 | Function: `checkServiceStatus` | Reports running/stopped with PID |
| 141–162 | Function: `main` | Dispatches start/stop/restart/status |

**Test coverage search result:** No shell unit test framework (e.g., bats, shunit2) exists anywhere in the repository. No test harness for any of these functions.

---

### 8. install.sh (root-level)

**File type and purpose:** Empty file (0 bytes). No content.

**Test coverage:** Not applicable (empty file).

---

### 9. installer/install.sh

**File type and purpose:** Interactive bash installation script. Copies config/binary files to user-specified directories and mutates `startup.sh` in-place with `sed`.

**Functions and steps defined (with line numbers):**

| Line | Item | Purpose |
|------|------|---------|
| 2–6 | Variables: `serviceName`, `defaultConfig`, `processDir`, `defaultLog`, `defaultApp` | Default installation paths |
| 12–17 | Function: `checkRoot` | Exits with code 87 if not run as root |
| 20 | `checkRoot` call | Enforced at script top |
| 23–42 | Config-copy loop | Prompts for config path, copies `gmtpRouter.xml`, `log4j.properties`, `routes/*`, `deniedPrefixes.xml` |
| 45–60 | App-copy loop | Prompts for app path, copies `lib/` and `GmtpMina.jar` |
| 63–79 | Log-folder loop | Creates log dir, patches `log4j.properties` via `sed` |
| 82–127 | Launcher-install loop | Prompts for process dir, user, group, Java home; patches `startup.sh` via `sed` with six separate `sed -i` calls |
| 113 | `sed` on `<routesFolder>` | Patches `startup.sh` for routes — but `<routesFolder>` is an XML element, not a shell variable; patching the wrong file |
| 132–142 | Boot registration | `update-rc.d` call (Ubuntu-specific) |
| 145–155 | Service start | Optionally calls `service gmtpmina start` |

**Test coverage search result:** No shell unit test framework exists. No test harness for this script.

---

### 10. nbproject/project.properties

**File type and purpose:** NetBeans IDE project properties file. Defines build, test, javac, run, and artifact paths.

**Key properties (with line numbers):**

| Line | Property | Value |
|------|----------|-------|
| 6 | `application.title` | `GmtpMina` |
| 7 | `application.vendor` | `michel` |
| 11 | `build.dir` | `build` |
| 16 | `build.test.classes.dir` | `${build.dir}/test/classes` |
| 17 | `build.test.results.dir` | `${build.dir}/test/results` |
| 29 | `dist.dir` | `dist` |
| 30 | `dist.jar` | `dist/GmtpMina.jar` |
| 104 | `javac.compilerargs` | `-Xlint:unchecked` |
| 111 | `javac.source` | `1.8` |
| 112 | `javac.target` | `1.8` |
| 143 | `main.class` | `gmtp.GMTPRouter` |
| 154 | `run.jvmargs` | `-DgmtpConfig=.` (points to current dir, not `/etc/gmtp`) |
| 163 | `src.dir` | `src` |
| 164 | `test.src.dir` | `test` |

**Test coverage search result:** `build.test.results.dir` property exists confirming test infrastructure is wired in NetBeans, but no evidence tests are ever executed in CI or the alternate `gmtpmina.xml` build.

---

### 11. nbproject/project.xml

**File type and purpose:** NetBeans project metadata file. Declares project type (`j2seproject`) and source/test root directories.

**Parameters defined:**

| Line | Parameter | Value |
|------|-----------|-------|
| 3 | Project type | `org.netbeans.modules.java.j2seproject` |
| 6 | Name | `GmtpMina` |
| 8 | Source root id | `src.dir` |
| 11 | Test root id | `test.src.dir` |

No testable logic — metadata only.

---

## Findings

## A01-1 — No integration test exercises any XML configuration file

**Severity:** HIGH
**File:** gmtpRouter.xml, deniedPrefixes.xml, routes/all.xml
**Description:** The entire test suite consists of a single JUnit test class (`TestDataMessageHandler`) which tests one static method in isolation with no I/O, no database, and no configuration loading. No test loads, parses, or validates `gmtpRouter.xml`, `deniedPrefixes.xml`, or `routes/all.xml`. Configuration parsing classes (`XmlConfigurationLoader`, `ConfigurationManager`, `DeniedPrefixesManager`, `XmlRoutes`) are completely untested. A malformed or incorrect configuration file will only be detected at runtime during a live deployment.
**Fix:** Add integration tests that instantiate `XmlConfigurationLoader` (or equivalent) against a test copy of each XML file, assert that all required fields are present and within valid ranges, and verify that invalid files throw well-defined exceptions rather than silently failing.

---

## A01-2 — Hardcoded plaintext database passwords in configuration with no externalization test

**Severity:** HIGH
**File:** gmtpRouter.xml
**Description:** Lines 54 and 62 contain plaintext database passwords (`gmtp-postgres`) for both the primary and default database connections. Line 74 contains a plaintext telnet management password (`gmtp!telnet`). These credentials are committed to version control and shipped in the deployable artifact (copied by `build.xml` `-post-jar` at line 21). No test verifies that these values are intended to be replaced at deployment time, and the installer script (`installer/install.sh`) does not prompt for or substitute database credentials — it only patches filesystem paths. There is no mechanism (environment variable override, encrypted property file, secrets manager reference) to prevent the defaults from being used as-is in production.
**Fix:** Replace inline credentials with references to environment variables or an external secrets file (e.g., `${DB_PASS}` resolved at startup). Add a startup validation check that rejects well-known default passwords. Add a test that asserts the configuration loader raises an error when default placeholder values are detected.

---

## A01-3 — gmtpmina.xml compiles tests but has no test-execution target and has skip.tests commented-in as an option

**Severity:** MEDIUM
**File:** gmtpmina.xml
**Description:** The IntelliJ/Ant build file `gmtpmina.xml` compiles the test source directory (target `compile.module.gmtpmina.tests`, line 218) but defines no `<junit>` task, no `<batchtest>`, and no test-run target. Tests are only compiled, never executed. Additionally, lines 7–9 show a `skip.tests` property value of `true` in a commented block — the comment explicitly invites disabling test compilation entirely. The default `all` target (line 304) runs `build.modules` and `build.all.artifacts` but does not run tests.
**Fix:** Add a `test` target to `gmtpmina.xml` using a `<junit>` task with `<batchtest>` that scans `${gmtpmina.testoutput.dir}` for test classes. Wire this target into the `all` dependency chain so tests are automatically executed on every build.

---

## A01-4 — build.xml post-jar phase has no configuration validation or smoke test

**Severity:** MEDIUM
**File:** build.xml
**Description:** The `-post-jar` target (line 15) assembles the deployment artifact by copying `gmtpRouter.xml`, `deniedPrefixes.xml`, routes, scripts, and libraries into `server/`. It does not perform any schema validation, required-field checks, or smoke tests against the assembled artifact. A misconfigured or structurally invalid XML file will be packaged and deployed without any build-time warning.
**Fix:** Add an XML well-formedness check (e.g., using Ant's `<xmlvalidate>` task) for `gmtpRouter.xml` and `deniedPrefixes.xml` as part of the `-post-jar` target. Optionally add a schema (XSD) and validate against it during packaging.

---

## A01-5 — startup.sh and installer/install.sh have no shell test harness

**Severity:** MEDIUM
**File:** startup.sh, installer/install.sh
**Description:** `startup.sh` implements seven shell functions covering process detection, PID file management, graceful shutdown with SIGKILL fallback, and SysV init dispatch. `installer/install.sh` contains interactive prompts, filesystem creation, file copying, `sed`-based in-place patching of both `startup.sh` and `log4j.properties`, and service registration. Neither script has any associated test harness (no bats, shunit2, or equivalent framework is present anywhere in the repository). Logic errors in these scripts — such as the apparent `sed` on line 113 of `installer/install.sh` targeting an XML element inside `startup.sh` which contains no such element — will not be caught before deployment.
**Fix:** Introduce a shell testing framework (e.g., bats-core). Write unit tests for `startup.sh` functions (`checkProcessIsRunning`, `checkProcessIsOurService`, `getServicePID`, `stopServiceProcess`) using mock PID files and process stubs. Write integration tests for `installer/install.sh` that run against a temporary directory tree and verify the resulting file contents and structure.

---

## A01-6 — routes/all.xml contains only a developer-local placeholder path with no test verification

**Severity:** MEDIUM
**File:** routes/all.xml
**Description:** The only routing rule defined is `trigger pattern="__EXAMPLE__"` pointing to `/home/michel/test.sh` (line 2). This path is specific to a developer's local machine and will not exist on any other host. The pattern `__EXAMPLE__` is not a real message pattern. No test verifies that the routing configuration is valid, that referenced scripts exist, or that the routes directory is non-empty on startup. If this file is deployed as-is, the router will have no functional routes.
**Fix:** Replace the placeholder entry with a documented example that is clearly marked as commented-out, or validate at startup that at least one non-example route exists. Add a configuration validation test that asserts routes with placeholder patterns are rejected or flagged.

---

## A01-7 — installer/install.sh contains a sed command that targets the wrong file

**Severity:** LOW
**File:** installer/install.sh
**Description:** Line 113 of `installer/install.sh` runs `sed -i "s#<routesFolder>.*</routesFolder>#<routesFolder>${configPath}/routes</routesFolder>#1g" ../server/startup.sh`. The `<routesFolder>` element is an XML element defined in `gmtpRouter.xml`, not in `startup.sh` (which is a shell script containing no such XML). This `sed` command will silently match nothing and leave the `routesFolder` in the actual XML config unpatched. Because there is no test for the installer, this logic error is undetected.
**Fix:** Correct the target file to `../server/gmtpRouter.xml`. Add a shell test for the installer that validates the resulting `gmtpRouter.xml` content after a dry-run installation.

---

## A01-8 — No CI pipeline or automated test invocation exists anywhere in the repository

**Severity:** HIGH
**File:** build.xml, gmtpmina.xml
**Description:** There is no CI configuration file in the repository (no `.github/workflows/`, no `Jenkinsfile`, no `.travis.yml`, no `Makefile` with a `test` target, no `circle.yml`). The NetBeans `gmtpmina.xml` build file compiles tests but has no execution target. The `build.xml` default target does not run tests. The `nbproject/configs/test.properties` file is empty. The result is that the one existing test (`TestDataMessageHandler`) is never automatically executed; test failures would only be discovered if a developer manually runs tests inside the IDE.
**Fix:** Add a CI pipeline (e.g., GitHub Actions workflow) that runs `ant test` (using the NetBeans build-impl.xml `test` target) on every push and pull request. Ensure the `gmtpmina.xml` file also has an equivalent `run-tests` target. Failing tests should block merges.

---

## Summary

| ID | Severity | Description |
|----|----------|-------------|
| A01-1 | HIGH | No integration test exercises any XML configuration file |
| A01-2 | HIGH | Hardcoded plaintext database and telnet passwords with no externalization test |
| A01-3 | MEDIUM | gmtpmina.xml compiles tests but never executes them; skip.tests option present |
| A01-4 | MEDIUM | build.xml post-jar phase has no XML validation or smoke test |
| A01-5 | MEDIUM | startup.sh and installer/install.sh have no shell test harness |
| A01-6 | MEDIUM | routes/all.xml contains only a developer-local placeholder with no validation |
| A01-7 | LOW | installer/install.sh line 113 applies sed to wrong target file (startup.sh instead of gmtpRouter.xml) |
| A01-8 | HIGH | No CI pipeline exists; the single existing test is never automatically executed |
