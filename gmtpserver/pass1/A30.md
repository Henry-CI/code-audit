# Security Audit — Pass 1 (Agent A30)

**Date:** 2026-02-28
**Branch verified:** master
**Files audited:**
- `C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/DataMessageHandler.java`
- `C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessage.java`
- `C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessageHandler.java`

---

## Reading Evidence

### DataMessageHandler.java

**Fully qualified class name:** `gmtp.DataMessageHandler`

**Imports:**
- `gmtp.db.DbUtil`
- `java.io.FileInputStream`
- `java.io.InputStream`
- `java.io.UnsupportedEncodingException`
- `java.nio.charset.Charset`
- `java.nio.charset.CharsetEncoder`
- `java.sql.Connection`
- `java.sql.SQLException`
- `java.text.SimpleDateFormat`
- `java.util.Calendar`
- `java.util.GregorianCalendar`
- `java.util.List`
- `java.util.ArrayList`
- `java.util.TimeZone`
- `javax.sql.DataSource`
- `org.slf4j.Logger`
- `org.slf4j.LoggerFactory`

**Fields:**
- `private static Logger logger` — SLF4J logger

**Interfaces / superclasses:** None

**Public methods (with line numbers):**

| Return | Method | Parameters | Line |
|--------|--------|------------|------|
| `void` | `sendAuthResponse` | `String cardId, boolean accessGranted, String unitName, String unitAddress, GMTPMessage gmtpMsg` | 31 |
| `boolean` | `onCardExMessage` | `String unitName, String unitAddress, String msgStr, GMTPMessage gmtpMsg` | 48 |
| `boolean` | `onGenericMessage` | `GMTPMessage msg, String msgStr` | 80 |
| `boolean` | `onStartupMessage` | `GMTPMessage msg, String msgStr` | 96 |
| `boolean` | `onShockMessage` | `GMTPMessage msg, String msgStr, String driverId` | 113 |
| `boolean` | `onVersionMessage` | `GMTPMessage msg, String msgStr` | 146 |
| `boolean` | `onOperationalCheckMessage` | `GMTPMessage msg, String msgStr, String driverId` | 165 |
| `boolean` | `onOperationalCheckWithTimeMessage` | `GMTPMessage msg, String msgStr, String driverId` | 212 |
| `boolean` | `onGpsfMessage` | `GMTPMessage msg, String msgStr` | 263 |
| `boolean` | `onGpseMessage` | `GMTPMessage msg, String msgStr` | 289 |
| `boolean` | `onIoMessage` | `GMTPMessage msg, String msgStr, String driverId` | 319 |
| `boolean` | `onIoValuesMessage` | `GMTPMessage msg, String msgStr, String driverId` | 388 |
| `boolean` | `onStatMessage` | `GMTPMessage msg, String msgStr, String driverId` | 430 |
| `boolean` | `onStatMessage` | `GMTPMessage msg, String msgStr, String driverId, String mast` | 435 |
| `boolean` | `onEosMessage` | `GMTPMessage msg, String msgStr, String driverId, String mast` | 479 |
| `boolean` | `onPstatMessage` | `GMTPMessage msg, String msgStr, String driverId` | 543 |
| `boolean` | `onPosMessage` | `GMTPMessage msg, String msgStr, String driverId` | 610 |
| `boolean` | `onPos2Message` | `GMTPMessage msg, String msgStr, String driverId` | 685 |
| `boolean` | `onMastMessage` | `GMTPMessage msg, String msgStr, String driverId` | 729 |
| `boolean` | `onSsMessage` | `GMTPMessage msg, List<Byte> msgList` | 754 |
| `boolean` | `onDexMessage` | `GMTPMessage msg, String msgStr` | 762 |
| `boolean` | `onDexeMessage` | `GMTPMessage msg, String msgStr` | 774 |
| `boolean` | `onClockMessage` | `GMTPMessage msg, String msgStr` | 786 |
| `boolean` | `onCardQueryMessage` | `GMTPMessage msg, String msgStr` | 845 |
| `boolean` | `onConfMessage` | `GMTPMessage msg, String msgStr` | 858 |
| `boolean` | `onBeltMessage` | `GMTPMessage msg, String msgStr` | 889 |
| `boolean` | `onJobListMessage` | `GMTPMessage msg, String msgStr, String driverId` | 902 |
| `boolean` | `onAuthMessage` | `GMTPMessage msg, String msgStr` | 933 |
| `boolean` | `onImageMessage` | `BinaryfileBean msg` | 974 |

**Private methods:**
- `private static String checkCanbus(String msg)` — line 987

---

### GMTPMessage.java

**Fully qualified class name:** `gmtp.GMTPMessage`

**Imports:**
- `gmtp.db.DbUtil`
- `gmtp.outgoing.OutgoingMessage`
- `java.io.BufferedReader`
- `java.io.IOException`
- `java.io.InputStream`
- `java.io.InputStreamReader`
- `java.io.Reader`
- `java.io.StringWriter`
- `java.io.Writer`
- `java.sql.SQLException`
- `java.util.ArrayList`
- `java.util.HashMap`
- `java.util.Iterator`
- `java.util.List`
- `java.util.Map`
- `java.util.Set`
- `java.util.regex.Matcher`
- `java.util.regex.Pattern`
- `java.sql.Connection`
- `java.util.*`
- `org.slf4j.Logger`
- `org.slf4j.LoggerFactory`

**Fields:**

| Access | Type | Name | Line |
|--------|------|------|------|
| `public static final` | `String` | `CARD` | 36 |
| `public static final` | `String` | `STARTUP` | 37 |
| `public static final` | `String` | `SHOCK` | 38 |
| `public static final` | `String` | `GPSF` | 39 |
| `public static final` | `String` | `GPSE` | 40 |
| `public static final` | `String` | `IO` | 41 |
| `public static final` | `String` | `DEX` | 42 |
| `public static final` | `String` | `DEXE` | 43 |
| `public static final` | `String` | `DEBUG` | 44 |
| `public static final` | `String` | `AUTH` | 45 |
| `public static final` | `String` | `CCLK` | 46 |
| `public static final` | `String` | `CARD_QUERY` | 47 |
| `public static final` | `String` | `CONF` | 48 |
| `public static final` | `String` | `BELT` | 49 |
| `public static final` | `String` | `VRS` | 50 |
| `protected` | `String` | `gmtp_id` | 51 |
| `protected` | `Type` | `type` | 52 |
| `protected` | `int` | `dataId` | 53 |
| `protected` | `int` | `dataLen` | 54 |
| `protected` | `String` | `address` | 55 |
| `protected` | `String` | `msgStr` | 56 |
| `protected` | `LinkedList<OutgoingMessage>` | `outgoingMessages` | 57 |
| `private static` | `Logger` | `logger` | 58 |
| `private` | `HashMap<String, String>` | `routingMap` | 59 |
| `private` | `ArrayList<String>` | `filters` | 60 |

**Interfaces / superclasses:** None

**Constructors:**
- `GMTPMessage(Type type, int dataLen, String msgStr)` — line 62
- `GMTPMessage(Type type, int dataId, int dataLen, String msgStr)` — line 69
- `GMTPMessage(Type type, int dataId, int dataLen, String msgStr, HashMap<String,String> routingMap)` — line 76
- `GMTPMessage(Type type, int dataLen, String msgStr, HashMap<String,String> routingMap)` — line 85

**Public methods:**

| Return | Method | Parameters | Line |
|--------|--------|------------|------|
| `boolean` | `hasOutgoingMessage` | — | 92 |
| `OutgoingMessage` | `getNextOutgoingMessage` | — | 96 |
| `void` | `addOutgoingMessage` | `String msg` | 107 |
| `void` | `addOutgoingMessageExt` | `int dataId, String msg` | 115 |
| `void` | `addOutgoingMessageACK` | `int dataId, String msg` | 124 |
| `static String` | `convertStreamToStr` | `InputStream is` | 149 |
| `boolean` | `process` | — | 254 |
| `void` | `setGmtp_id` | `String gmtp_id` | 326 |
| `String` | `getOutgoingMessages` | — | 330 |
| `int` | `getDataLen` | — | 336 |
| `int` | `getDataId` | — | 340 |
| `void` | `setDataId` | `int dataId` | 344 |
| `void` | `setAddress` | `String address` | 348 |
| `String` | `getGmtp_id` | — | 352 |
| `String` | `getMessage` | — | 356 |
| `Type` | `getType` | — | 360 |
| `String` | `getAddress` | — | 364 |

**Private methods:**
- `private void addOutgoingMessage(Type type)` — line 133
- `private boolean hasFilter()` — line 140
- `private void callFilter()` — line 171
- `private void checkFilter()` — line 212
- `private void onDataMessage()` — line 368
- `private void onACKMessage()` — line 432
- `private void onIdMessage()` — line 438
- `private void onConnectionClosed()` — line 448
- `private void onAVL05Message()` — line 454
- `private void onGVT368Message()` — line 458

**Inner enum:** `Type` — line 243

---

### GMTPMessageHandler.java

**Fully qualified class name:** `gmtp.GMTPMessageHandler`

**Imports:**
- `gmtp.GMTPMessage.Type`
- `gmtp.outgoing.OutgoingMessage`
- `gmtp.outgoing.OutgoingMessageSender`
- `java.util.*`
- `org.apache.mina.core.service.IoHandlerAdapter`
- `org.apache.mina.core.session.IdleStatus`
- `org.apache.mina.core.session.IoSession`
- `org.slf4j.Logger`
- `org.slf4j.LoggerFactory`

**Fields:**

| Access | Type | Name | Line |
|--------|------|------|------|
| `public final` | `Set<IoSession>` | `sessions` | 24 |
| `private static` | `Logger` | `logger` | 25 |
| `private` | `int` | `IDLE_INTERVAL` | 27 |
| `private` | `int` | `MAX_IDLE_COUNT` | 29 |

**Interfaces / superclasses:** extends `IoHandlerAdapter`

**Public methods:**

| Return | Method | Parameters | Line |
|--------|--------|------------|------|
| `void` | `exceptionCaught` | `IoSession session, Throwable cause` | 57 |
| `void` | `sessionCreated` | `IoSession session` | 67 |
| `void` | `sessionClosed` | `IoSession session` | 75 |
| `void` | `messageReceived` | `IoSession session, Object message` | 111 |
| `void` | `messageSent` | `IoSession session, Object message` | 202 |
| `void` | `sessionIdle` | `IoSession session, IdleStatus status` | 221 |

**Private methods:**
- `private void removeSession(String gmtp_id)` — line 31

---

## Security Checklist Results

### Message Handling and Input Validation

- **Missing bounds checks on message parsing:** ISSUES FOUND (see A30-1, A30-2, A30-3)
- **Integer overflow on size calculations:** No integer overflow in size/offset arithmetic found.
- **Fields validated before use:** ISSUES FOUND — many fields are passed directly to stored procedures without any format or length validation (see A30-4).
- **Null pointer dereferences on malformed messages:** ISSUES FOUND (see A30-5, A30-6)
- **Message type / command allowlist:** Partial mitigation — `onDataMessage` uses `startsWith` string matching, which functions as an allowlist for known prefixes. Unrecognised messages fall through to `onGenericMessage`, which is a gap (see A30-7).

### Database Access

- **SQL injection via string concatenation:** Not directly visible in these files — all DB calls go through `DbUtil` stored-procedure wrappers; the risk depends on DbUtil implementation. No raw JDBC `Statement` string concatenation observed here.
- **Missing null checks on database results:** No results inspected in these files; `DbUtil` calls are void or return primitives.
- **Sensitive data logged from database operations:** ISSUES FOUND (see A30-8).

### Routing and Forwarding

- **Message content forwarded without sanitization:** CRITICAL ISSUE FOUND (see A30-9) — `callFilter()` in `GMTPMessage` executes an OS process constructed from routing-map values and raw message fields.
- **SSRF — destination from message content:** No direct SSRF; destinations are from the routing map config, not message payloads directly. However the process execution path (A30-9) is effectively the same class of risk.
- **Malicious message redirecting traffic:** Related to A30-9.

### Resource Management

- **Connection / resource leaks:** ISSUES FOUND (see A30-10) — `Connection` objects obtained from `DbUtil.getConnection()` are never closed in finally blocks throughout `DataMessageHandler`.
- **Unbounded message queuing:** The `outgoingMessages` `LinkedList` in `GMTPMessage` is unbounded; however queue entries are controlled by server-side logic rather than directly by untrusted message count, so risk is lower.

### Error Handling

- **Swallowed exceptions:** CRITICAL ISSUE FOUND (see A30-11) — `process()` in `GMTPMessage` catches `Exception` with an empty body.
- **Malformed messages cause silent continuation:** ISSUES FOUND — a number of malformed messages return `false` but the connection is not closed (see A30-12).
- **Error responses leaking internal state:** `exceptionCaught` calls `cause.printStackTrace()` which may expose stack traces (see A30-13).

### General Java Security

- **Command injection via Runtime.exec / ProcessBuilder:** CRITICAL ISSUE FOUND (see A30-9).
- **Path traversal in file operations:** `FileInputStream` is imported but not used in these files. No file path operations observed.
- **Deserialization of untrusted data (ObjectInputStream):** Not found.

---

## Findings

## A30-1

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/DataMessageHandler.java
**Line:** 937
**Severity:** High
**Category:** Security > Input Validation — Missing Bounds Check
**Description:** `onAuthMessage` unconditionally calls `msgStr.substring(5)` without first verifying that `msgStr` has at least 5 characters. If a message with the prefix `AUTH=` is received but contains fewer than 5 characters total (e.g. `AUTH=` with nothing after, which has exactly 5), the call succeeds but subsequent code operates on an empty string. More critically, any message whose length is between 0 and 4 that somehow reaches this method would throw a `StringIndexOutOfBoundsException`.
**Evidence:**
```java
public static boolean onAuthMessage(GMTPMessage msg, String msgStr) throws SQLException {
    boolean syntaxValid = false;

    String originalMsg = new String(msgStr);
    msgStr = msgStr.substring(5);   // line 937 — no length guard
```
**Recommendation:** Check `msgStr.length() >= 5` before calling `substring(5)` and return `false` (invalid syntax) immediately if the check fails.

---

## A30-2

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/DataMessageHandler.java
**Line:** 703–704
**Severity:** High
**Category:** Security > Input Validation — Missing Bounds Check
**Description:** In `onPos2Message`, for the first two elements of the split array the code calls `str.substring(0, 4)` and `str.substring(4, 8)` with no length check on `str`. A malicious or malformed message with a comma-delimited token shorter than 8 characters will throw a `StringIndexOutOfBoundsException`. The same pattern exists in `onPosMessage` at lines 625–626.
**Evidence:**
```java
int msb = Integer.parseInt(str.substring(0, 4), 16);   // line 703
int lsb = Integer.parseInt(str.substring(4, 8), 16);   // line 704
```
**Recommendation:** Validate that each token is exactly 8 hex characters (or at least 8 characters long) before calling `substring`. Return false on validation failure.

---

## A30-3

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessageHandler.java
**Line:** 121
**Severity:** High
**Category:** Security > Input Validation — Missing Bounds Check
**Description:** When an ID/ID_EXT message is received in `messageReceived`, the code searches for an underscore `_` in the message string and then calls `substring(0, pos)` to extract the prefix. If the message contains no underscore, `indexOf` returns -1 and `substring(0, -1)` throws a `StringIndexOutOfBoundsException`. The enclosing `!GMTPRouter.isEmpty` guard only ensures the message is non-empty, not that it contains an underscore.
**Evidence:**
```java
int pos = gmtpMsg.getMessage().indexOf('_');
String prefix = gmtpMsg.getMessage().substring(0, pos);  // line 121 — pos may be -1
```
**Recommendation:** Check `pos > 0` before calling `substring`. If no underscore is present, reject or log the malformed ID message and close the session.

---

## A30-4

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/DataMessageHandler.java
**Line:** 69–73, 89, 105–107, and throughout
**Severity:** Medium
**Category:** Security > Input Validation — No Field Length or Format Validation
**Description:** Raw string fields parsed from network messages (`cardId`, `time`, `msgStr`, `driverId`, `unitTimestamp`, etc.) are passed directly to `DbUtil` stored-procedure wrapper methods without any length or character-set validation. While the stored-procedure wrappers may use parameterised queries internally, excessively long strings or strings with special characters could still cause issues at the DBMS layer (truncation errors surfaced as exceptions, or unexpected behaviour in stored procedures that perform string operations).
**Evidence:**
```java
boolean accessGranted = DbUtil.callSpCardExMessage(con,
        unitName,
        cardId,      // raw from message, no length check
        unitAddress,
        time);       // raw from message, no format check
```
**Recommendation:** Define and enforce maximum lengths for each field (e.g. card IDs, driver IDs, timestamps) before passing them to database calls. Reject messages where fields exceed expected lengths.

---

## A30-5

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/DataMessageHandler.java
**Line:** 909
**Severity:** Medium
**Category:** Security > Null Pointer Dereference — Missing Exception Handling
**Description:** In `onJobListMessage`, `Integer.parseInt(token)` is called without a surrounding try-catch for `NumberFormatException`. If the first or second comma-delimited field in a job-list message is not a valid integer (e.g. a non-numeric string), an unchecked `NumberFormatException` will propagate. The same gap exists at line 916. Unlike `onOperationalCheckMessage` (which does have a try-catch), this method has none.
**Evidence:**
```java
String token = msgStr.substring(0, pos);
int jobNo = Integer.parseInt(token);   // line 909 — no NumberFormatException handling
...
int status = Integer.parseInt(token);  // line 916 — same
```
**Recommendation:** Wrap the integer parsing in a try-catch for `NumberFormatException` and return `false` (syntax invalid) on failure, consistent with the pattern used in `onOperationalCheckMessage`.

---

## A30-6

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessageHandler.java
**Line:** 43
**Severity:** Medium
**Category:** Security > Null Pointer Dereference
**Description:** Inside `removeSession`, `s.getAttribute("gmtp_id")` is called and then `.toString()` is invoked on the result without a null check. If a session was added to the set before the `gmtp_id` attribute was set (possible in a race condition between `sessionCreated` and `messageReceived`), `getAttribute` returns `null` and `toString()` throws a `NullPointerException`, which would break the session-removal loop.
**Evidence:**
```java
} else if (s.getAttribute("gmtp_id").toString().equalsIgnoreCase(gmtp_id)) {  // line 43
```
**Recommendation:** Null-check `s.getAttribute("gmtp_id")` before calling `.toString()`.

---

## A30-7

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessage.java
**Line:** 410
**Severity:** Low
**Category:** Security > Input Validation — No Message Type Allowlist for Unknown Messages
**Description:** In `onDataMessage`, any message that does not match a known prefix falls through to `DataMessageHandler.onGenericMessage`, which logs the full message content and passes it to the database. There is no explicit rejection of unrecognised message types. An attacker can send arbitrary data to the server and have it logged and forwarded to the database without triggering any alarm beyond a `warn` log for invalid syntax.
**Evidence:**
```java
} else {
    syntaxValid = DataMessageHandler.onGenericMessage(this, msgStr);  // line 410
}
```
**Recommendation:** Consider whether truly unknown messages should be passed to `onGenericMessage` or silently dropped with a warning. At minimum, rate-limit or flag connections that repeatedly send unrecognised message types.

---

## A30-8

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/DataMessageHandler.java
**Line:** 83–84, 977
**Severity:** Medium
**Category:** Security > Sensitive Data Exposure — Message Content Logged
**Description:** Full network message content is logged at INFO level in `onGenericMessage` and `onImageMessage`. This includes raw data from field units such as GPS coordinates, IO values, card IDs, and image metadata. Depending on log-retention policies and log-access controls, this constitutes a data exposure risk. The image message log at line 977 exposes the file name and unit ID of every image uploaded.
**Evidence:**
```java
// DataMessageHandler.java line 83-84
logger.info("Gmtp data message <" + msgStr + "> from "
        + msg.getGmtp_id());

// DataMessageHandler.java line 977
logger.info("FTP data message <" + msg.fname + "> from " + msg.getGmtp_id());
```
**Recommendation:** Reduce log verbosity for message payloads at INFO level; use DEBUG/TRACE for full content and ensure those levels are disabled in production. Avoid logging personal or location data without a specific need.

---

## A30-9

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessage.java
**Line:** 175–205
**Severity:** Critical
**Category:** Security > Command Injection via ProcessBuilder
**Description:** The `callFilter()` method constructs a `ProcessBuilder` from a combination of values sourced from the routing configuration map and — critically — from `gmtp_id`, `address`, and `msgStr`, all of which are derived from untrusted network input. The command array passed to `ProcessBuilder` is built by splitting the routing-map value on commas and then appending `gmtp_id`, `address`, and `msgStr` directly as process arguments. Even though `ProcessBuilder` (unlike `Runtime.exec(String)`) does not invoke a shell, passing unsanitised data as arguments to an arbitrary external process constitutes a severe command-injection / arbitrary-execution risk. An attacker who can influence the routing configuration or who can predict how `msgStr` maps to a filter would be able to cause the server to execute arbitrary OS-level programs.

Furthermore, the program to execute (`cds[i]`) itself comes from the routing map, which if misconfigured or injected could point to any executable on the system.
**Evidence:**
```java
params = new ArrayList<String>();
params.add(cds[i]);      // executable path from config
params.add(gmtp_id);     // from network: unit identifier
params.add(address);     // from network: remote address
params.add(msgStr);      // from network: full message payload
ProcessBuilder pb = new ProcessBuilder(params);
pb.redirectErrorStream(true);
Process process = pb.start();
```
**Recommendation:** Remove the ability to execute external processes based on message content entirely, or at minimum: (1) strictly allowlist permissible executable paths; (2) never pass raw message content as process arguments — if arguments are required, validate and sanitise each one against a strict pattern before use; (3) run the subprocess under a least-privilege OS account.

---

## A30-10

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/DataMessageHandler.java
**Line:** 66, 88, 104, 132, 159, 197, 246, 278, 313, 364, 421, 468, 536, 603, 679, 723, 769, 780, 852, 879, 896, 924 (and all other `DbUtil.getConnection` call sites)
**Severity:** High
**Category:** Security > Resource Management — JDBC Connection Leak
**Description:** Throughout `DataMessageHandler`, `Connection` objects are obtained via `DbUtil.getConnection()` and passed to `DbUtil` call methods, but they are never explicitly closed and there are no `finally` blocks or try-with-resources constructs to guarantee closure. If a `DbUtil` method throws a `SQLException`, or if an exception occurs after obtaining the connection but before returning, the connection is leaked. Over time this will exhaust the connection pool, causing denial of service.

The same pattern appears in `GMTPMessage.java` at lines 434, 440, 450.
**Evidence:**
```java
// Representative example (DataMessageHandler.java line 66-73)
Connection con = DbUtil.getConnection(unitName);
boolean accessGranted = DbUtil.callSpCardExMessage(con,
        unitName,
        cardId,
        unitAddress,
        time);
// con is never closed
```
**Recommendation:** Use try-with-resources (`try (Connection con = DbUtil.getConnection(...)) { ... }`) for every connection, or ensure the `DbUtil` wrappers themselves manage connection lifecycle. Connections must be closed in all exit paths, including exception paths.

---

## A30-11

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessage.java
**Line:** 307–309
**Severity:** Critical
**Category:** Security > Error Handling — Swallowed Exception
**Description:** The `process()` method wraps the entire message-dispatch logic in a `try` block that catches `Exception` with a completely empty body (the only content is a commented-out log statement). This means that any exception thrown during message processing — including `SQLException`, `RuntimeException`, `NullPointerException`, and any exception from `callFilter()`'s process execution — is silently discarded. The method then returns `true` regardless of whether processing succeeded or failed. This suppresses all error signals, making failures invisible and potentially allowing the system to continue in a corrupted state.
**Evidence:**
```java
} catch (Exception e) {
    //     logger.error(e.getMessage());
}
```
**Recommendation:** At minimum, log the exception at ERROR level. Depending on the exception type, consider closing the session for fatal errors. Never leave a catch block completely empty in production code.

---

## A30-12

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessage.java
**Line:** 412–415
**Severity:** Medium
**Category:** Security > Error Handling — Silent Continuation on Invalid Message
**Description:** When a message fails syntax validation (`syntaxValid == false`), `onDataMessage` logs a warning but does not close the session or take any corrective action. A peer that continuously sends malformed messages will continue to be processed indefinitely without any connection-level consequence, enabling low-effort resource exhaustion or fuzzing attacks.
**Evidence:**
```java
if (!syntaxValid) {
    logger.warn("Ignoring invalid message <" + msgStr + "> from "
            + gmtp_id);
    // session is NOT closed; processing continues normally
}
```
**Recommendation:** Implement a per-session counter of consecutive invalid messages. After exceeding a threshold, close the session and log the event at a higher severity level.

---

## A30-13

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessageHandler.java
**Line:** 61
**Severity:** Medium
**Category:** Security > Error Handling — Stack Trace Disclosure
**Description:** The `exceptionCaught` handler calls `cause.printStackTrace()`, which writes the full Java stack trace to standard error. In a server environment, this output may be captured in logs or visible to operators who should not see internal implementation details. More critically, if standard error is accessible to an attacker (e.g. via process monitoring or misconfigured log aggregation), stack traces reveal class names, method names, and line numbers that aid in further exploitation.
**Evidence:**
```java
cause.printStackTrace();  // line 61 — full stack trace to stderr
```
**Recommendation:** Replace `cause.printStackTrace()` with `logger.error("Session exception", cause)`, which directs the stack trace through the logging framework where it can be controlled by log-level configuration and access controls.

---

## A30-14

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessage.java
**Line:** 187–202
**Severity:** High
**Category:** Security > Command Injection — Unvalidated Message Content as Process Argument (Supplemental Detail to A30-9)
**Description:** The `msgStr` field, which contains the full raw payload of the incoming network message, is added directly as the fourth argument to `ProcessBuilder`. An attacker controlling a connected field unit can craft arbitrary message content that will be passed verbatim as an argument to an external process. Even though shell metacharacter injection is mitigated by `ProcessBuilder` not invoking a shell, the content of `msgStr` can still carry malicious data that the invoked program may interpret dangerously (path traversal components, format strings, or injection into any downstream interpreter the external program invokes).
**Evidence:**
```java
params.add(msgStr);   // raw message payload from network — line 186
ProcessBuilder pb = new ProcessBuilder(params);
...
Process process = pb.start();
```
**Recommendation:** See A30-9. The entire `callFilter` execution path should be reviewed for removal or strict input sanitisation.

---

## A30-15

**File:** C:/Projects/cig-audit/repos/gmtpserver/src/gmtp/GMTPMessageHandler.java
**Line:** 198
**Severity:** Low
**Category:** Security > Sensitive Data Exposure — Full Message Logged After Processing
**Description:** After every received message is processed, the full message content (`gmtpMsg.getMessage()`) and the remote address are logged at INFO level. This means every card swipe, GPS fix, shock event, and driver ID is written to the application log for every connected unit. Over time, logs become a high-value target containing movement histories, driver identities, and operational patterns.
**Evidence:**
```java
logger.info("PROCESSED Msg from (" + sessAddress + ") " + gmtpMsg.getGmtp_id() + ": " + gmtpMsg.getMessage());
```
**Recommendation:** Log at DEBUG or TRACE level, or log only message type and unit ID at INFO level, omitting full payload content.
