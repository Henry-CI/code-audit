# Pass 1 — A06 Security Audit
**Category:** A06 — BLE Expansion UUID and Input Handler
**Branch:** master
**Date:** 2026-02-28
**Auditor:** Pass 1 A06

---

## STEP 4 — READING EVIDENCE

### File pair 1: BleExpansionUuid

**Files:**
- `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansionuuid.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansionuuid.cpp`

**Class name and base classes:**
- `BleExpansionUuid` — no base class (plain C++ class, no QObject)

**Public methods:**
- Line 9 (`bleexpansionuuid.h`): `static inline bool equals128(const quint128 *v1, const quint128 *v2)` — pointer-based 128-bit UUID comparison

**Signals and slots:** none (no Q_OBJECT)

**Q_OBJECT macro:** not present

**#include directives:**
- `bleexpansionuuid.h`: `#include <QBluetoothUuid>`
- `bleexpansionuuid.cpp`: `#include "comm/bleexpansionuuid.h"`

**UUID constants defined (bleexpansionuuid.cpp):**
| Member | UUID value | Access comment |
|---|---|---|
| authUuid | `{6d1e95a3-12bf-1107-705e-16edf5954aba}` | (used as auth characteristic UUID) |
| deviceName | `{00002a00-0000-1000-8000-00805f9b34fb}` | RO, standard GATT |
| appearance | `{00002a01-0000-1000-8000-00805f9b34fb}` | RO, standard GATT |
| bleVersion | `{204b4a7c-8415-34a0-32d9-52c87a0fdf56}` | RO |
| mainVersion | `{b9642f66-c5f1-54d8-d7a5-1a299b9bdbd7}` | RO |
| manufactureName | `{00002a29-0000-1000-8000-00805f9b34fb}` | RO, standard GATT |
| modelNumber | `{00002a24-0000-1000-8000-00805f9b34fb}` | RO, standard GATT |
| currentRtc | `{00002a2b-0000-1000-8000-00805f9b34fb}` | RW, standard GATT |
| inputTimerReset | `{c97106be-ab79-1ebb-af52-a76f86ca09f8}` | WO |
| inputD0–inputD3 | (four proprietary UUIDs) | RO |
| inputPullUp0–inputPullUp3 | (four proprietary UUIDs) | RW |
| outputReset | `{78aea58a-90b6-e31e-3af7-abaa3def5cec}` | WO |
| outputRelay0–outputRelay1 | (two proprietary UUIDs) | RW |
| relay0Timeout–relay1Timeout | (two proprietary UUIDs) | RW |
| outputD0–outputD3 | (four proprietary UUIDs) | RW |
| openCollector0–openCollector3 | (four proprietary UUIDs) | RW |
| shockCount | `{69dfccac-59b7-ef3e-5309-db222d1c2d09}` | RW |
| shockPeek | `{53535322-e7fc-8229-b470-89d9fda99e46}` | RO |
| shockPop | `{1642fcc6-bcc9-63f5-039a-721e9acbfb93}` | WO |
| shockThreshold | `{6d3f3a08-06dd-4c11-6add-00c0c2443c77}` | RW |
| shockPeriod | `{8f0c111a-37f2-822f-d70e-b0354a848466}` | RW |
| shockMaxMagnitude | `{33f838fe-2047-1932-ccb0-d5e8d627b905}` | RO |
| shockCountNotifyDesc | `{00002902-0000-1000-8000-00805f9b34fb}` | standard GATT descriptor |

**Member variables (private static):**
All 37 UUID members listed above are private static `quint128`.

**Friend classes:** `BleExpansion`

---

### File pair 2: BleInputHandler

**Files:**
- `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleinputhandler.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleinputhandler.cpp`

**Class name and base classes:**
- `BleInputHandler : public QObject`

**Q_OBJECT macro:** line 16 (`bleinputhandler.h`)

**Public methods:**
- Line 20: `explicit BleInputHandler(CanExpansion *canExpansion)`
- Line 22: `void updateIgnition(CIGCONF::PowerState state)`
- Line 23: `void updateBleInput(CIGCONF::BleExpansionDI input, bool state)`
- Line 24: `void changeBleState(bool connected)`
- Line 26: `void updateIdleTimer()`
- Line 28: `QByteArray digitalInputs(DigitalFormat format, bool autoReset)`

**Signals:**
- Line 31: `void idleTimeout()`
- Line 32: `void sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra = QByteArray())`

**Private methods:**
- `void resetStates()`
- `void onTimerEvent()`
- `void sendSeenSafeReport(bool state)`

**#include directives:**
- `bleinputhandler.h`: `#include "app/cigconfigs.h"`, `#include <QObject>`
- `bleinputhandler.cpp`: `#include "bleinputhandler.h"`, `#include "comm/canexpansion.h"`, `#include "app/globalconfigs.h"`, `#include "platform/seriallogger.h"`, `#include <QTimer>`

**Member variables:**
- `CanExpansion *m_canExpansion` — raw pointer
- `QTimer *m_timer` — raw pointer (nullable, manually managed)
- `QTimer *m_digInputModeTimer` — raw pointer (parented)
- `InputState m_ignition` — struct
- `InputState m_bleInputs[4]` — fixed-size array of 4 elements
- `bool m_bypassReset`
- `bool m_bleConnected`
- `bool m_seenState`
- `quint64 m_lastSeenReport`
- `bool m_seenSecond`
- `quint32 m_seenTimestamp`

**Enum:**
- `DigitalFormat {SessionFormat, UsageFormat, OnDemandFormat}`

---

## STEP 5 — SECURITY REVIEW

### 1. Memory Safety

**A06-1** · HIGH · Memory Safety — Array Index Without Bounds Check
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleinputhandler.cpp:117`
**Description:** `updateBleInput` computes `int index = input - CIGCONF::BleExpDI1` and immediately dereferences `m_bleInputs[index]` at line 119 without any bounds check. `m_bleInputs` is a fixed array of 4 elements. `BleExpansionDI` is an unscoped enum (`BleExpDI1=0, BleExpDI2=1, BleExpDI3=2, BleExpDI4=3`). Although the signal is currently only emitted with well-known enum values, the parameter type is a plain `int`-sized enum. If a caller or a future code path passes a value outside the defined range (e.g., via a queued connection where the integer value comes from a deserialized or BLE-received message), `index` can be negative or >= 4, producing an out-of-bounds array access, undefined behaviour, and a potential crash or memory corruption on the embedded device. No assertion, range guard, or Q_ASSERT is present. The same arithmetic-then-immediate-access pattern appears without bounds checks in `bleexpansion.h:42` (`BleExpansion::digitalInput`) and `canexpansion.h:64` (`CanExpansion::digitalInput`), which are in scope because `BleExpansionUuid` is architecturally paired with these consumers.

**A06-2** · MEDIUM · Memory Safety — Manual QTimer Lifecycle
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleinputhandler.cpp:211-214`
**Description:** `m_timer` is a raw pointer that is `new`-allocated and `delete`-d manually inside `updateIdleTimer()`. Although the timer is parented to `this` via `new QTimer(this)` (line 219), `delete m_timer` at line 213 is also called explicitly, which is safe but redundant and fragile: it bypasses Qt's parent-child ownership model and could cause a double-free if the parent destructor also deletes it. More critically, no destructor is defined for `BleInputHandler`, so the case where `updateIdleTimer()` is never called with a condition that triggers deletion — but the object is destroyed — relies entirely on the Qt parent mechanism. The manual `delete` path at line 213 followed by `m_timer = nullptr` at line 214 is inconsistent with using Qt parent ownership and introduces maintenance risk of use-after-free if this pattern is extended.

### 2. Communication Security

**A06-3** · HIGH · Communication Security — Hardcoded BLE Authentication Credential
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansion.cpp:9`
**Description:** The BLE authentication code `AUTH_CODE` is hardcoded as the string literal `"uS8MgpklMx"` in source. This credential is written to the expansion module's `authUuid` characteristic (UUID `6d1e95a3-12bf-1107-705e-16edf5954aba`) during BLE connection setup (line 40 of `bleexpansion.cpp`). Any attacker with read access to the firmware binary or this repository can extract the authentication code and directly authenticate to any expansion module within BLE range. For a vehicle proximity detection device, an unauthenticated actor able to connect to the expansion module could manipulate digital outputs (relay0, relay1, outputD0-D3, openCollectors) or alter safety-critical parameters (shockThreshold, shockPeriod). The credential should be provisioned per-device and never embedded in source. This is in `bleexpansion.cpp` which is architecturally coupled to the UUID files under review.

**A06-4** · INFO · Communication Security — Proprietary BLE UUIDs Exposed in Source
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansionuuid.cpp:1-83`
**Description:** All 37 proprietary custom UUIDs for the expansion module GATT profile are defined in plaintext in source. These UUIDs serve as the complete enumeration of the device's BLE attack surface. An attacker can use them to enumerate, read, and write characteristics without needing to reverse-engineer firmware. This is an informational finding: UUID confidentiality is not a supported security control in Bluetooth, but the complete GATT profile being in the repository lowers the bar for targeted attacks.

### 3. Input Handling

**A06-5** · MEDIUM · Input Handling — Integer Overflow in Time Delta Accumulation
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleinputhandler.cpp:50`
**Description:** The delta between clock samples is computed as `quint32 delta = (clock - m_ignition.clock) / 100` where `clock` is `quint64`. The division result is then added to `quint32` accumulators (`sessionOnTime`, `sessionOffTime`, `usageOnTime`, `usageOffTime`) with no overflow check (lines 57, 58, 65, 66, 130-136, 185-192, 266-287). If the elapsed time between updates exceeds `~429496729.5` seconds (approximately 13.6 years) the `quint32` accumulator wraps silently. More practically, if the clock source is reset, rolls over, or is set to an attacker-controlled value via the `currentRtc` writable characteristic (UUID `00002a2b`), the subtraction `(clock - is.clock)` can produce a very large `quint64` value. After dividing by 100 and truncating to `quint32`, the resulting delta is a large but silent overflow value that corrupts the on-time/off-time accumulators, which are subsequently reported in GMTP messages.

**A06-6** · MEDIUM · Input Handling — Unvalidated BLE-Received Data Used in Time Calculations
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleinputhandler.cpp:75`
**Description:** `gCfg->idleTimeout()` is multiplied by 1000 and passed directly to `m_timer->start()` (line 75 and line 254). If `idleTimeout()` returns a value derived from a server-supplied or BLE-received configuration without range validation, the product `idleTimeout() * 1000` can overflow a 32-bit signed integer (Qt's `QTimer::start` takes `int` milliseconds). A value of `idleTimeout() >= 2147484` (approximately 2.1 million seconds) causes signed integer overflow and undefined behaviour. No range check on the configuration value is visible in this file.

**A06-7** · LOW · Input Handling — Debug Output Exposes Internal State
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleinputhandler.cpp:47`, `bleinputhandler.cpp:139`
**Description:** `SerialLogger::log()` is called unconditionally (not guarded by a debug build flag) on lines 47 and 139, logging ignition state changes and digital input state changes including the input index and boolean state. If the serial logger is active in production firmware, this leaks vehicle operational state (ignition on/off, digital input transitions) to anyone with physical access to the serial port. This finding is low severity because physical access is required, but it is inconsistent with production hardening.

### 4. Build Security

Build Security: no issues found in the files under review. (`.pro` file analysis is outside the assigned file set for this auditor.)

### 5. Device and Firmware

**A06-8** · HIGH · Device and Firmware — Hardcoded BLE Peripheral Credential in Firmware Image
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansion.cpp:9`
**Description:** As noted in A06-3, `AUTH_CODE "uS8MgpklMx"` is a shared static credential baked into every firmware image. Because it is identical across all deployed devices, extraction from any single unit compromises all units in the field. This is a firmware provisioning failure: the authentication code for the BLE expansion module should be unique per device pair and injected at manufacturing or provisioning time, not compiled into the firmware.

### 6. Qt-Specific Security

Qt-Specific Security: no issues found. No `QSslSocket`, `QProcess`, `QSettings`, or QML/QtScript usage is present in the four assigned files. `QTimer` usage is present but the security concern (integer overflow in `start()`) is captured under Input Handling (A06-6).

---

## Summary

| ID | Severity | Category | Location |
|---|---|---|---|
| A06-1 | HIGH | Memory Safety — array index without bounds check | `bleinputhandler.cpp:117` |
| A06-2 | MEDIUM | Memory Safety — manual QTimer lifecycle inconsistency | `bleinputhandler.cpp:211-214` |
| A06-3 | HIGH | Communication Security — hardcoded BLE auth credential | `bleexpansion.cpp:9` |
| A06-4 | INFO | Communication Security — proprietary UUIDs in source | `bleexpansionuuid.cpp:1-83` |
| A06-5 | MEDIUM | Input Handling — integer overflow in time delta accumulation | `bleinputhandler.cpp:50` |
| A06-6 | MEDIUM | Input Handling — unvalidated config used in timer start | `bleinputhandler.cpp:75,254` |
| A06-7 | LOW | Input Handling — unconditional serial debug output | `bleinputhandler.cpp:47,139` |
| A06-8 | HIGH | Device and Firmware — shared static BLE credential in firmware | `bleexpansion.cpp:9` |
