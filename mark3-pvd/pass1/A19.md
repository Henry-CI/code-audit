# Pass 1 Security Audit — A19
**Repository:** mark3-pvd
**Branch:** master
**Date:** 2026-02-28
**Auditor:** A19

---

## Step 4 — Reading Evidence

### File Set 1: checkstartdialog

**Files:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkstartdialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkstartdialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkstartdialog.ui`

**Class:** `CheckStartDialog : public QDialog`

**Q_OBJECT:** `checkstartdialog.h` line 12

**Public methods:**
- `explicit CheckStartDialog(QWidget *parent = 0)` — line 15 (.h), line 5 (.cpp)
- `~CheckStartDialog()` — line 16 (.h), line 18 (.cpp)
- `void setMandatory(bool mandatory)` — line 17 (.h), line 23 (.cpp)
- `void languageChanged(void)` — line 18 (.h), line 34 (.cpp)

**Signals:** none declared
**Slots:** none declared (btnStart connected directly to `accept()`)

**#include directives (.cpp):**
- `"checkstartdialog.h"`
- `"ui_checkstartdialog.h"`
- `<QDebug>`

**Member variables:**
- `Ui::CheckStartDialog *ui` (private, line 25 .h)

**Friend class (conditional):** `TestDialog` (when `UNIT_TEST` defined, line 21 .h)

**UI widgets (.ui):**
- `QLabel` name="label" — background fill
- `QLabel` name="label_2" — background fill
- `QLabel` name="label_3" — "Start check" label
- `QLabel` name="labelTip11" — "Press below to start your"
- `QLabel` name="labelTip12" — " optional" (red text, toggleable)
- `QLabel` name="labelTip21" — "mandatory " (red text, toggleable)
- `QLabel` name="labelTip22" — "pre-op safety check."
- `QPushButton` name="btnStart" — start button (icon only, connects to `accept()`)

---

### File Set 2: commentdialog

**Files:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/commentdialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/commentdialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/commentdialog.ui`

**Class:** `CommentDialog : public QDialog`

**Q_OBJECT:** `commentdialog.h` line 23

**Macros defined in header:**
- `NO_ACTIVITY_TIME 10000` (line 12)
- `MAX_CHARACTER 100` (line 13)

**Enum:** `CommentDialogType {Unlock, Preop}` (line 15)

**Public methods:**
- `explicit CommentDialog(CommentDialogType type, QWidget *parent = nullptr)` — line 26 (.h)
- `~CommentDialog()` — line 27 (.h)
- `void UpdateTextInput(QString str, onScreenKeyboard::CtrlButton ctrl)` — line 29 (.h), line 104 (.cpp)
- `void onkeyboardClosed()` — line 30 (.h), line 98 (.cpp)
- `void onUnlkReasonSelected()` — line 31 (.h), line 205 (.cpp)
- `void languageChanged()` — line 32 (.h), line 214 (.cpp)

**Private methods:**
- `bool debounce()` — line 37 (.h), line 188 (.cpp)
- `void reset()` — line 38 (.h), line 199 (.cpp)
- `void showWidgets()` — line 39 (.h), line 46 (.cpp)

**Private slots:**
- `void run_keyboard_lineEdit()` — line 51 (.h), line 121 (.cpp)
- `void onDone()` — line 52 (.h), line 134 (.cpp)
- `void onSkip()` — line 53 (.h), line 168 (.cpp)

**Protected methods:**
- `void showEvent(QShowEvent *event = 0)` — line 47 (.h), line 91 (.cpp)
- `void hideEvent(QHideEvent *)` — line 48 (.h), line 41 (.cpp)

**#include directives (.cpp):**
- `"commentdialog.h"`
- `"ui_commentdialog.h"`
- `"app/globalconfigs.h"`
- `<QtWidgets/QPlainTextEdit>`
- `<QtWidgets/QLineEdit>`
- `<QDebug>`
- `<QComboBox>`

**Member variables:**
- `Ui::CommentDialog *ui` (private, line 35 .h)
- `onScreenKeyboard *lineEditkeyboard` (private, line 36 .h)
- `QTimer *m_timer` (private, line 41 .h)
- `quint32 m_lastPress` (private, line 42 .h)
- `CommentDialogType m_dlgType` (private, line 43 .h)
- `UnlockReasonDialog *m_unlkReasonDlg` (private, line 44 .h)

**UI widgets (.ui):**
- `QLabel` name="lblHeaderText"
- `QLabel` name="lblWarning"
- `QLabel` name="lblRealImpact"
- `QLabel` name="label" — icon pixmap
- `QPlainTextEdit` name="pteMessageBox" — free-text comment input; no `maxLength` property set in .ui
- `QPushButton` name="btnDone"
- `QPushButton` name="btnSkipButton"
- `QPushButton` name="btnDropdown"
- `QRadioButton` name="btnYes"
- `QRadioButton` name="btnNo"
- `QRadioButton` name="btnUnconfirmed"

---

### File Set 3: dialog

**Files:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.ui`

**Class:** `Dialog : public QDialog`

**Q_OBJECT:** `dialog.h` line 41

**Public methods (dialog.h):**
- `explicit Dialog(QWidget *parent = 0)` — line 44
- `~Dialog()` — line 45
- `void onPowerChanged(CIGCONF::PowerState powerState)` — line 47
- `void onReboot()` — line 48
- `void onBleReady(bool yes)` — line 49
- `void onNetworkReady(bool yes)` — line 50
- `void onCardAuthorised(bool yes, quint64)` — line 51
- `void onCmdLogin(quint64 id)` — line 52
- `void onIdleTimeout()` — line 53
- `void lockScreen(CIGCONF::MaintLockedCode code, bool remote)` — line 54
- `void ambertImpactScreen()` — line 55
- `void updateLux(int lux)` — line 57
- `void updateStatus(...)` — line 58
- `void updateBatteryStatus(...)` — line 59
- `void updateExpModInfo(QByteArray mainVersion)` — line 60
- `void onBroadcastMsgReceived(CIGCONF::BroadcastMessage m)` — line 61
- `void showInformationScreen()` — line 62
- `void updateLoginImage()` — line 63
- `void quickPowerUpdate(bool on)` — line 64
- `void onDemandStarted(...)` — line 66
- `void onDemandExtended(...)` — line 67
- `void onDemandEnded(...)` — line 68
- `void onLanguageChanged(void)` — line 70
- `void updateCamera()` — line 72

**Signals (dialog.h):**
- `void driverChanged(quint64 id)` — line 79
- `void lastCheckDriverChanged(quint64 id)` — line 80
- `void screenLocked(CIGCONF::MaintLockedCode code)` — line 81
- `void setRelayOut(bool on1, bool on2)` — line 82
- `void setRelay2Out(bool on)` — line 83
- `void sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra = QByteArray())` — line 84
- `void resetCanStates(bool resetLast)` — line 85
- `void forceBroadcastUIClose()` — line 86
- `void log(QByteArray &msg)` — line 87
- `void updatePreopTimer(QString timeout)` — line 88
- `void amberDialogAboutToShow(bool isLocked)` — line 89

**Protected methods:**
- `void mouseReleaseEvent(QMouseEvent *)` — line 92
- `void showEvent(QShowEvent *event = 0)` — line 93

**Private slots:**
- `void on_pushButton_clicked()` — line 96

**Private methods:**
- `void onPinCode()` — line 99
- `void onCardSwiped(...)` — line 100
- `void onPinDialogAccepted()` — line 102
- `void onAuthorisedDialogAccepted()` — line 103
- `void onAuthorisedUserLogout()` — line 104
- `void onOptionalCheckConfirmed()` — line 105
- `void onCheckStartDialogAccepted()` — line 106
- `void onCheckQuestionDialogFinished(int result)` — line 107
- `void onCheckConfirmationDialogFinished(int result)` — line 108
- `void onCheckCompletedDialogAccepted()` — line 109
- `void onCheckCompletedDialogRejected()` — line 110
- `void onUnlockedDialogAccepted()` — line 111
- `void onProcessUnlock()` — line 112
- `void onPreopCommentDone()` — line 113
- `void onBroadcastDialogDone(int result)` — line 114
- `bool isValidId(quint64 id)` — line 116
- `bool isChecklistEmpty(bool reload)` — line 117
- `bool bypassChecklist()` — line 118
- `void clearWidgets()` — line 119
- `void login(quint64 id)` — line 121
- `void postLogin()` — line 122
- `void postMaintenanceLogin()` — line 123
- `void logout()` — line 124
- `void openMenuDialog()` — line 125
- `void startCheck(bool restartTimer=true)` — line 127
- `void sendStartCheck()` — line 128
- `void superListUpdated(bool empty)` — line 130
- `void updateOnDemand()` — line 131
- `void convorStatusUpdated()` — line 133
- `bool isOnDemandExpired()` — line 135
- `void fullLockStart()` — line 137
- `void updateFullLock()` — line 138
- `void updateTime()` — line 140
- `void writeMsgToQueue(CIGCONF::BroadcastMessage m)` — line 201
- `bool displayNextBroadcastMessage()` — line 202
- `void clearMsgQueue()` — line 203
- `void initOnScreenPreopTimer(quint16 survto)` — line 207
- `QString showCustomTimeFormat(quint32 time)` — line 208
- `void adjustPreopDialogs(bool en)` — line 212
- `void updateBLEConSpinner(quint8 status)` — line 214

**#include directives (dialog.cpp):**
- `"dialog.h"`, `"ui_dialog.h"`, `"ui/pindialog.h"`, `"ui/authoriseddialog.h"`, `"ui/checkstartdialog.h"`, `"ui/checkcompleteddialog.h"`, `"ui/checkconfirmationdialog.h"`, `"ui/checkquestiondialog.h"`, `"ui/lockeddialog.h"`, `"ui/unlockeddialog.h"`, `"ui/messagedialog.h"`, `"ui/ondemanddialog.h"`, `"ui/commentdialog.h"`, `"ui/informationdialog.h"`, `"ui/broadcastuidialog.h"`, `"ui/supervisordialog.h"`, `"ui/languagedialog.h"`, `"platform/wiegandrfid.h"`, `"platform/internalrfid.h"`, `"platform/pwmbeeper.h"`, `"app/globalconfigs.h"`, `<QMouseEvent>`, `<QTimer>`, `<QTime>`, `<QDebug>`, `<QApplication>`, `<QPixmap>`, `"ui/keyfilter.h"`, `"ui/vorwarningdialog.h"`, `"mytranslator.h"`, `"ui/preopscreenoverlay.h"`, `"ui/amberimpactalertdialog.h"`

**Member variables (dialog.h):**
- `Ui::Dialog *ui`
- All child dialog pointers: `m_pinDialog`, `m_authorisedDialog`, `m_checkStartDialog`, `m_checkQuestionDialog`, `m_checkConfirmationDialog`, `m_checkCompletedDialog`, `m_lockedDialog`, `m_unlockedDialog`, `m_messageDialog`, `m_informationDialog`, `m_onDemandDialog`, `m_unlockReasonDlg`, `m_preopCommentDlg`, `m_broadcastDialog`, `m_supervisorDialog`, `m_languageDialog`, `m_amberImpactAlertDialog`
- Hardware: `m_internalRfid`, `m_wiegandRfid`, `m_beeper`
- Timers: `m_checklistTimer`, `m_odTimer`, `m_messageTimer`, `m_timeTimer`
- State: `m_driverId`, `m_pendingDriverId`, `m_checkReason`, `m_checkFailed`, `m_checkSelectedYes`, `m_checkResponses`, `m_checkItemIndex`, `m_checkItem`, `m_bleReady`, `m_networkReady`, `m_locked`, `m_driverBased`, `m_timeBased`, `m_preopOncePerDay`, `m_power`
- `m_vorwarningDialog`, `m_survTo`, `m_overlay`, `m_bleSpinnerMovie`
- `m_broadcastMsgUrgent`, `m_broadcastMsgNormal`, `m_response`

**UI widgets (dialog.ui):**
- `QLabel` name="label" — full-screen login background pixmap
- `QLabel` name="labelOdm" — on-demand mode text overlay
- `QLabel` name="labelTime" — clock display
- `QLabel` name="lblVor_1" — VOR icon left
- `QLabel` name="lblVor_2" — VOR icon right
- `QPushButton` name="pushButton" — language selector ("EN")
- `QFrame` name="frLoginOverlay" — BLE connecting overlay
  - `QLabel` name="lblBleConnStat" — spinner animation
  - `QLabel` name="label_2" — "Please wait while we connect to the expansion module"

---

## Step 5 — Security Review

### 1. Memory Safety

**A19-1** · HIGH · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/utils/bytearray.h:25`
**Description:** `ByteArray::asprintf` calls `vsnprintf` with a cleared `va_list` (after `va_end` on line 21) to measure the required buffer size, then calls `vsprintf` (unbounded) on line 25 with a second `va_start` that was never called — the `va_list ap` is reused after `va_end` without reinitialisation. Accessing a `va_list` after `va_end` is undefined behaviour in C++. Additionally, `vsprintf` is used instead of `vsnprintf` for the actual write, so if the undefined-behaviour `va_list` reuse produces a different (larger) size than measured, it will write past the end of the `QByteArray`. This function is called from `dialog.cpp` with operator-influenced data (checklist question text and comment strings), making corruption of the output buffer possible.

**A19-2** · MEDIUM · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/commentdialog.cpp:209-211`
**Description:** `onUnlkReasonSelected()` inserts a reason string selected from `UnlockReasonDialog` directly into `pteMessageBox` without applying the `MAX_CHARACTER` (100) limit check that `UpdateTextInput()` enforces for keyboard input. If any pre-defined reason string in `UnlockReasonDialog` exceeds 100 characters, the resulting `unlockString` passed to `gCfg->setUnlkReasonString()` and then formatted with `vsprintf` in `backgroundworker.cpp:2340` will exceed the intended limit, creating an inconsistency between the keyboard and dropdown paths.

### 2. Communication Security

**A19-3** · HIGH · Communication Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/backgroundworker.cpp:2243-2246`
**Description:** The preop comment string entered by the operator is inserted into the GMTP OPCMNT message using `ByteArray::asprintf("AUTH=%llX,%X OPCMNT=%s", ..., gCfg->preopCommentString().toLatin1().data())`. The comment string is used as a `%s` argument to an `sprintf`-family call, not as the format string itself, so this is not a format-string vulnerability. However, there is no validation that the comment string is free of control characters or embedded protocol delimiters before transmission to the server. A malicious or malformed comment could corrupt the server-side message parsing if the server does not sanitise the field. This is a medium-to-high concern in a safety-critical communications protocol.

**A19-4** · HIGH · Communication Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/backgroundworker.cpp:2340-2347`
**Description:** The unlock reason string from `gCfg->UnlkReasonString()` is transmitted to the server via `ByteArray::asprintf("UNLK=%llX,%X,%X,%llX,%X,%s,%X", ..., gCfg->UnlkReasonString().toLatin1().data(), ...)`. As with the OPCMNT case, the string is used as a `%s` argument, but it is not validated for embedded commas, percent signs, or other protocol-significant characters before being formatted and transmitted. Because the UNLK message uses comma-delimited fields, an operator-entered reason string containing a comma will corrupt the field structure seen by the server parser.

### 3. Input Handling

**A19-5** · HIGH · Input Handling
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.cpp:408`
**Description:** Format string constructed from operator-influenced data. The call `ByteArray::asprintf("%u,%u," + response.text.toLatin1(), response.id & 0x7fffffff, response.response)` constructs the format string by concatenating a literal prefix with `response.text.toLatin1()`. `response.text` originates from `m_checkItem.question`, which is the checklist question text loaded from configuration. If a checklist question string contains a `%` character followed by a format specifier (e.g., `%s`, `%n`, `%x`), it will be interpreted as a format directive by `vsprintf` inside `ByteArray::asprintf`. This is a format-string injection vulnerability. Configuration data may be delivered from the server, making this exploitable remotely by an attacker who can influence checklist content.

**A19-6** · MEDIUM · Input Handling
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/commentdialog.cpp:115`
**Description:** The `MAX_CHARACTER` limit of 100 is enforced only in `UpdateTextInput()`, which is called from the on-screen keyboard path. The limit is enforced with `< MAX_CHARACTER` (strictly less than), meaning the maximum text length is 99 characters, not 100 as the constant name implies. This is an off-by-one inconsistency in the enforcement of the stated constraint. Direct paste or programmatic injection through `onUnlkReasonSelected()` bypasses this check entirely (see A19-2).

**A19-7** · LOW · Input Handling
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.cpp:863`
**Description:** Debug output leaks operational state. `qDebug() << "Timebased " << hm_now << " " << hm_last;` at line 863 inside `bypassChecklist()` logs current time and last check time values to debug output. If debug logging is active in a production build, this leaks the device's local time and checklist scheduling state to any process or log reader with access to the device's debug output.

### 4. Build Security

**A19-8** · HIGH · Build Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/mk3.pro`
**Description:** No hardening compiler flags are present in the `.pro` file. Specifically absent are: `-fstack-protector-strong` (stack overflow detection), `-D_FORTIFY_SOURCE=2` (buffer overflow detection for standard library functions), `-fPIE`/`-pie` (position-independent executable for ASLR), and `-Wformat -Wformat-security` (format string vulnerability detection at compile time). On an embedded Linux device running safety-critical vehicle proximity detection software, the absence of these flags means the firmware has no run-time stack-smashing protection and no ASLR benefit, maximising the impact of the memory-safety issues identified above.

**A19-9** · MEDIUM · Build Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/mk3.pro`
**Description:** No `CONFIG += release` or `QMAKE_STRIP` directive is present in the `.pro` file. Without an explicit release configuration or strip directive, debug symbols may be included in production firmware images, providing an attacker who gains access to the firmware binary with full symbol information including function names, variable names, and source file paths. The comment on line 37 of `dialog.cpp` — `/* TODO: all functions of gCfg might be guarded as they are used in multithread */` — would also be visible in debug symbol strings.

### 5. Device and Firmware

**A19-10** · HIGH · Device and Firmware
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.cpp:233`
**Description:** `QProcess::execute("/bin/sh", QStringList() << "-c" << "echo 0 > /sys/class/gpio/gpio37/value")` is called inside `showInformationScreen()` to disable the camera GPIO. While the command string is a literal (not user-influenced), this call spawns a full shell (`/bin/sh -c`) to write a single byte to a sysfs path. If the PATH or environment is manipulated prior to this call (e.g., by a compromised service on the device), or if the sysfs path is writable by a lower-privilege process, this represents a privileged shell execution from the UI process. Using direct file I/O (`QFile::write`) on the GPIO sysfs path would eliminate the shell invocation entirely. Additionally, using `/bin/sh -c` for any operation, even with a literal command, is a pattern that is unsafe to generalise and sets a precedent for future developers to pass variable data to this pattern.

**A19-11** · MEDIUM · Device and Firmware
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.cpp:37`
**Description:** A developer TODO comment acknowledges a known thread-safety defect: `/* TODO: all functions of gCfg might be guarded as they are used in multithread */`. `gCfg` (the global `GlobalConfigs` object) is accessed from both the UI thread (dialog.cpp) and the background worker thread (backgroundworker.cpp), including the `preopCommentString` and `UnlkReasonString` fields that are written in the UI thread and read in the background worker. Without mutex protection, this is a data race with undefined behaviour. On an embedded device with a safety-critical function (vehicle proximity detection), a data race corrupting device state could cause incorrect relay output behaviour.

### 6. Qt-Specific Security

**A19-12** · MEDIUM · Qt-Specific Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.cpp:233`
**Description:** `QProcess::execute` is used to control a GPIO via a shell command. See A19-10. From the Qt-specific security perspective: `QProcess::execute` is a blocking call that runs a subprocess. It is called from the UI thread inside `showInformationScreen()`. This can cause the UI to freeze if the subprocess takes longer than expected. More importantly, spawning `/bin/sh -c` from the main application process grants the shell the same process credentials as the Qt application, which on an embedded device may run as root. Any subsequent call that passes non-literal data to a similar pattern would be a command injection vulnerability.

**A19-13** · INFO · Qt-Specific Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/commentdialog.cpp:18`
**Description:** `ui->pteMessageBox->setTextInteractionFlags(Qt::TextEditable)` is called in the constructor. `QPlainTextEdit` is editable by default; this call is redundant and has no security impact, but it documents that the widget is intentionally made editable. No rich-text or HTML rendering flags are set, so HTML injection into the display label is not a concern for this widget.

---

*End of A19 findings.*
