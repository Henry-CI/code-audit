# Pass 1 Audit — A18
**Auditor:** A18
**Date:** 2026-02-28
**Branch:** master (confirmed)

---

## Step 4 — Reading Evidence

### File Set 1: CheckCompletedDialog

**Files:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkcompleteddialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkcompleteddialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkcompleteddialog.ui`

**Class:** `CheckCompletedDialog` : `QDialog`

**Q_OBJECT macro:** `checkcompleteddialog.h:14`

**Public methods:**
- `explicit CheckCompletedDialog(QWidget *parent = 0)` — h:17, cpp:7
- `~CheckCompletedDialog()` — h:18, cpp:62
- `void languageChanged(void)` — h:20, cpp:67
- `bool isTimerActive()` — h:21, cpp:135
- `void stopTimer()` — h:22, cpp:140
- `void setCheckResponses(QList<CIGCONF::CheckResponse> &responses)` — h:23 (inline)

**Signals:**
- `void openPreopNotes()` — h:30

**Protected:**
- `void showEvent(QShowEvent *event = 0)` — h:33, cpp:75

**`#include` directives (cpp):**
- `#include "checkcompleteddialog.h"` — cpp:1
- `#include "ui_checkcompleteddialog.h"` — cpp:2
- `#include "app/globalconfigs.h"` — cpp:3

**`#include` directives (h):**
- `#include <QDialog>` — h:4
- `#include <QTimer>` — h:5
- `#include "app/cigconfigs.h"` — h:6

**Member variables:**
- `Ui::CheckCompletedDialog *ui` — h:36
- `QTimer *m_timer` — h:37
- `QList<CIGCONF::CheckResponse> m_checkResponses` — h:38

**Macro:**
- `#define NO_ACTIVITY_TIME 10000` — cpp:5

**UI widgets (checkcompleteddialog.ui):**
- `btnBack` (QPushButton) — hidden in constructor
- `btnSend` (QPushButton) — icon-only "Continue" button
- `btnSend_2` (QPushButton) — text "Continue"
- `btnRepeat` (QPushButton) — icon-only "Repeat" button
- `btnRepeat_2` (QPushButton) — text "Repeat all questions"
- `btnNotes` (QPushButton) — icon-only "Notes" button
- `btnNotes_2` (QPushButton) — text "Add notes"
- `label_2` (QLabel) — "Pre-op safety check complete"
- `lblSummaryCritical` (QLabel) — "1 Failed critical question"

---

### File Set 2: CheckConfirmationDialog

**Files:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkconfirmationdialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkconfirmationdialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkconfirmationdialog.ui`

**Class:** `CheckConfirmationDialog` : `QDialog`

**Q_OBJECT macro:** `checkconfirmationdialog.h:13`

**Public methods:**
- `explicit CheckConfirmationDialog(QWidget *parent = 0)` — h:16, cpp:4
- `~CheckConfirmationDialog()` — h:17, cpp:24
- `void confirm(bool yes)` — h:19, cpp:29
- `void setQuestion(const QString &question)` — h:20, cpp:40
- `void languageChanged(void)` — h:21, cpp:45

**Signals:** none

**Slots:** none explicitly declared (connect-time lambdas used)

**`#include` directives (h):**
- `#include <QDialog>` — h:4
- `#include "ui/dialog.h"` — h:5

**`#include` directives (cpp):**
- `#include "checkconfirmationdialog.h"` — cpp:1
- `#include "ui_checkconfirmationdialog.h"` — cpp:2

**Member variables:**
- `Ui::CheckConfirmationDialog *ui` — h:24

**UI widgets (checkconfirmationdialog.ui):**
- `labelQuestion` (QLabel) — displays question text, wordWrap enabled
- `labelNo` (QLabel) — "NO"
- `labelYes` (QLabel) — "YES"
- `btnBack` (QPushButton) — icon-only back
- `btnNext` (QPushButton) — icon-only next
- `label_2` (QLabel) — "CONFIRMATION"
- `label_3` (QLabel) — "You pressed"
- `btnNext_2` (QPushButton) — text "Next"
- `btnBack_2` (QPushButton) — text "Back"

---

### File Set 3: CheckQuestionDialog

**Files:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkquestiondialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkquestiondialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkquestiondialog.ui`

**Class:** `CheckQuestionDialog` : `QDialog`

**Q_OBJECT macro:** `checkquestiondialog.h:14`

**Public methods:**
- `explicit CheckQuestionDialog(QWidget *parent = 0)` — h:17, cpp:4
- `~CheckQuestionDialog()` — h:18, cpp:14
- `const QString &question() const` — h:20 (inline)
- `void setQuestion(const QString &question, bool critical = false)` — h:21, cpp:19

**Signals:**
- `void shown(void)` — h:28

**Protected:**
- `void showEvent(QShowEvent *event)` — h:31, cpp:39

**`#include` directives (h):**
- `#include <QDialog>` — h:4
- `#include <QTimer>` — h:5
- `#include "ui/dialog.h"` — h:6

**`#include` directives (cpp):**
- `#include "checkquestiondialog.h"` — cpp:1
- `#include "ui_checkquestiondialog.h"` — cpp:2

**Member variables:**
- `Ui::CheckQuestionDialog *ui` — h:34
- `QString m_question` — h:35

**UI widgets (checkquestiondialog.ui):**
- `labelQuestion` (QLabel) — displays question text, wordWrap enabled
- `btnNo` (QPushButton) — "NO", wired to reject()
- `btnYes` (QPushButton) — "YES", wired to accept()
- `lblCritical` (QLabel) — "[Critical Question]", shown/hidden based on critical flag

---

## Step 5 — Security Review

### 1. Memory Safety

**A18-1** · HIGH · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/utils/bytearray.h:25`
**Description:** `ByteArray::asprintf` calls `va_end(ap)` at line 21, then passes the already-invalidated `ap` to `vsprintf` at line 25. After `va_end`, the `va_list` is indeterminate; using it is undefined behaviour per C/C++ standards. On many architectures this corrupts the stack or heap. This function is called at `dialog.cpp:408` with the checklist response text, making the corruption reachable from configuration-supplied question text. While `ByteArray.h` is not directly assigned to A18, the call at `dialog.cpp:408` is inside `onCheckCompletedDialogAccepted` which directly processes checklist responses collected by the three assigned dialogs, making it a direct consequence of the checklist flow audited here.

**A18-2** · LOW · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkcompleteddialog.cpp:105`
**Description:** The loop variable in `for (const CIGCONF::CheckResponse response : m_checkResponses)` copies each struct by value which is benign, but `failedResponses` is declared `quint8` (8-bit unsigned). If a checklist ever contains more than 255 items with failures, the counter silently wraps to zero, causing the summary label to show "0 failed critical questions" even when all questions failed. This is an integer overflow on a safety-critical display counter.

### 2. Communication Security

No direct communication logic exists in the three assigned dialog files. The `sendGmtpMessage` signal is emitted in `dialog.cpp:onCheckCompletedDialogAccepted`, which is out of scope for this file set. The assigned files themselves do not transmit data.

Communication Security: no issues found.

### 3. Input Handling

**A18-3** · HIGH · Input Handling — Format String
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.cpp:408`
**Description:** In `onCheckCompletedDialogAccepted`, the checklist response is serialised with:
```cpp
QByteArray ba = ByteArray::asprintf("%u,%u," + response.text.toLatin1(), response.id & 0x7fffffff, response.response);
```
The format string is constructed by concatenating the fixed literal `"%u,%u,"` with `response.text.toLatin1()`, which is the question text loaded from external configuration. If a question string contains `printf` format specifiers (e.g., `%s`, `%n`, `%x`), they are passed verbatim to `vsprintf` as active format specifiers, because `ByteArray::asprintf` passes this concatenated `const char*` directly as the `cformat` parameter. An attacker who can write a checklist configuration file with a question containing `%n` can write to an arbitrary memory address. The question text is displayed without modification by `CheckQuestionDialog::setQuestion` and `CheckConfirmationDialog::setQuestion`, so the same externally-supplied string reaches the format call unchanged.

**A18-4** · MEDIUM · Input Handling — Question Text Length
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkquestiondialog.cpp:36` and `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkconfirmationdialog.cpp:42`
**Description:** Question text is assigned directly to `QLabel::setText` with no maximum length check. `QLabel` does not truncate; a very long question string (e.g., tens of thousands of characters) from a misconfigured or maliciously modified checklist file will cause the label to allocate a large heap buffer and attempt to lay out the text, potentially causing excessive memory consumption or an out-of-memory crash on the embedded device.

### 4. Build Security

Build Security: no issues found.
(Build configuration files are not among the assigned files; no `.pro` file was reviewed here.)

### 5. Device and Firmware — Checklist Bypass

**A18-5** · HIGH · Device and Firmware — Checklist Bypass via Timeout Auto-Accept
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkcompleteddialog.cpp:58` and `checkcompleteddialog.cpp:132`
**Description:** `CheckCompletedDialog` starts a 10-second single-shot timer (`NO_ACTIVITY_TIME = 10000 ms`) in `showEvent`. On timeout, the timer fires `accept()` unconditionally, advancing the checklist workflow to the authorised/unlocked state as if the operator had pressed "Continue". There is no check at timeout whether any critical questions were failed (`m_checkFailed`). The timeout path bypasses the `onCheckCompletedDialogAccepted` logic in `dialog.cpp` — that slot fires from `CheckCompletedDialog::accepted`, but so does the timer path via the lambda at line 58 which also calls `accept()`. Tracing the signal chain: both paths emit `accepted`, so `onCheckCompletedDialogAccepted` is reached for both. However, the 10-second automatic acceptance without operator confirmation is a security concern on an embedded safety device: if the device screen is unattended, the checklist completion step is auto-confirmed without operator presence, potentially unlocking equipment without a deliberate confirmation action.

**A18-6** · MEDIUM · Device and Firmware — Deprecated PRNG for YES/NO Button Shuffle
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkquestiondialog.cpp:24`
**Description:** `qrand() % 2` is used to randomly swap the positions of the YES and NO buttons each time a question is displayed. `qrand()` is deprecated since Qt 5.15 and is a simple LCG with a predictable sequence if `qsrand()` is not called with a strong seed. More importantly, use of a predictable PRNG for this swap means that a sophisticated attacker who can predict or observe the seed state could anticipate button layout and automate or spoof operator input. The security impact is low in isolation, but on a safety-critical proximity-detection device, the design intent of randomising buttons is to prevent muscle-memory bypass of the checklist; a predictable PRNG undermines that intent.

**A18-7** · MEDIUM · Device and Firmware — Checklist Bypass via convorStatus
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.cpp:799` (context of `bypassChecklist()`)
**Description:** `bypassChecklist()` returns `true` unconditionally when `gCfg->convorStatus()` is active, skipping the entire pre-operation checklist for the logged-in driver. If the `convorStatus` flag can be set by a remotely received message without adequate authentication (this is outside the scope of the assigned files but is a concern raised by reading the checklist workflow), an attacker could bypass the mandatory pre-op safety check entirely. This finding is raised as a flag for the reviewer of the communication and configuration modules.

### 6. Qt-Specific Security

**A18-8** · INFO · Qt-Specific Security — QDialog Accepted by Timer Without User Gesture
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkcompleteddialog.cpp:58`
**Description:** The `QTimer::timeout` signal is connected to `accept()` on the `CheckCompletedDialog`. This is a Qt-level observation: `QDialog::accept()` emits `accepted`, which is connected in the parent `Dialog` to `onCheckCompletedDialogAccepted`. The timer fires on the main Qt event loop so there is no threading concern, but the design means the dialog resolves itself as "accepted" (continue) rather than "rejected" (repeat) on timeout. This design choice treats operator inaction as affirmative consent for a safety-critical step.

**A18-9** · INFO · Qt-Specific Security — `#include "ui/dialog.h"` in Header Files
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkconfirmationdialog.h:5` and `/c/Projects/cig-audit/repos/mark3-pvd/ui/checkquestiondialog.h:6`
**Description:** Both dialog headers include `"ui/dialog.h"`, which is the top-level application dialog header. This creates a wide transitive include dependency. `dialog.h` pulls in nearly every subsystem header (RFID, beeper, GMTP, all other dialogs). While not a direct security vulnerability, this tight coupling means that any future security-sensitive change to `dialog.h` (e.g., adding a friend declaration, changing visibility of security-critical members) silently affects the compilation environment of these checklist dialogs. It is an architectural concern that increases the attack surface of the header dependency chain.

---

## Summary of Findings

| ID | Severity | Category | File |
|----|----------|----------|------|
| A18-1 | HIGH | Memory Safety — use-after-va_end in ByteArray::asprintf | bytearray.h:25 |
| A18-2 | LOW | Memory Safety — quint8 overflow on failedResponses counter | checkcompleteddialog.cpp:105 |
| A18-3 | HIGH | Input Handling — format string injection via question text | dialog.cpp:408 |
| A18-4 | MEDIUM | Input Handling — no length check on question text in QLabel | checkquestiondialog.cpp:36, checkconfirmationdialog.cpp:42 |
| A18-5 | HIGH | Device/Firmware — 10-second auto-accept bypasses operator confirmation | checkcompleteddialog.cpp:58,132 |
| A18-6 | MEDIUM | Device/Firmware — deprecated predictable PRNG for button shuffle | checkquestiondialog.cpp:24 |
| A18-7 | MEDIUM | Device/Firmware — checklist bypass via convorStatus flag | dialog.cpp:799 |
| A18-8 | INFO | Qt-Specific — timer-driven QDialog::accept() as affirmative consent | checkcompleteddialog.cpp:58 |
| A18-9 | INFO | Qt-Specific — broad transitive include via dialog.h in dialog headers | checkconfirmationdialog.h:5, checkquestiondialog.h:6 |
