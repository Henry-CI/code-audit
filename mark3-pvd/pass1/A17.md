# Pass 1 Security Audit — A17
**Repository:** mark3-pvd
**Branch:** master
**Date:** 2026-02-28
**Auditor:** A17

---

## Step 1 — Branch Verification

`git rev-parse --abbrev-ref HEAD` returned: `master`. Confirmed correct branch.

---

## Step 4 — Reading Evidence

### File Set 1: AmberImpactAlertDialog

**File paths:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/amberimpactalertdialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/amberimpactalertdialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/amberimpactalertdialog.ui`

**Class name and base classes:**
- `AmberImpactAlertDialog : public QDialog`

**Q_OBJECT macro location:**
- `amberimpactalertdialog.h` line 12

**Public methods (with line numbers):**
- `explicit AmberImpactAlertDialog(QWidget *parent = nullptr)` — .h line 15 / .cpp line 6
- `~AmberImpactAlertDialog()` — .h line 16 / .cpp line 14
- `bool isOpen() const` — .h line 18 / .cpp line 49
- `void closeWindow()` — .h line 19 / .cpp line 31
- `void languageChanged()` — .h line 20 / .cpp line 19

**Signals:** none declared

**Slots:**
- `void amberAlertDialogShowEvent(bool isLocked)` — .h line 23 (public slot) / .cpp line 54

**Protected methods:**
- `void mouseReleaseEvent(QMouseEvent *)` — .h line 26 / .cpp line 25
- `void showEvent(QShowEvent *event = 0)` — .h line 27 / .cpp line 39

**#include directives:**
- `.h`: `<QDialog>`
- `.cpp`: `"amberimpactalertdialog.h"`, `"ui_amberimpactalertdialog.h"`, `"app/globalconfigs.h"`, `<QDebug>`

**Member variables:**
- `Ui::AmberImpactAlertDialog *ui` (private, line 30 .h)
- `bool dialogOpenFlag` (private, line 31 .h)

**UI widgets (amberimpactalertdialog.ui):**
- `AmberImpactAlertDialog` — QDialog, 800x480
- `labelWarning` — QLabel (displays warning.png pixmap)
- `labelTip` — QLabel (displays "Amber shock impact detected. Kindly acknowledge by tapping the screen.")
- `label_3` — QLabel (displays "Amber Impact Alert")

---

### File Set 2: AuthorisedDialog

**File paths:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/authoriseddialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/authoriseddialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/authoriseddialog.ui`

**Class name and base classes:**
- `AuthorisedDialog : public QDialog`

**Q_OBJECT macro location:**
- `authoriseddialog.h` line 14

**Public methods (with line numbers):**
- `explicit AuthorisedDialog(QWidget *parent = 0)` — .h line 17 / .cpp line 13
- `~AuthorisedDialog()` — .h line 18 / .cpp line 44
- `void setHasChecklist(bool yes)` — .h line 19 / .cpp line 56
- `void setDriverId(quint64 id)` — .h line 20 / .cpp line 67
- `void setTime(const QString s)` — .h line 21 / .cpp line 178
- `void setPower(bool on)` — .h line 22 / .cpp line 211
- `void updateCamera()` — .h line 23 / .cpp line 217

**Signals:**
- `void userLogout()` — .h line 30

**Protected methods:**
- `void showEvent(QShowEvent *)` — .h line 33 / .cpp line 71
- `void hideEvent(QHideEvent *)` — .h line 34 / .cpp line 113

**Private methods:**
- `bool debounce()` — .h line 43 / .cpp line 148
- `void screensaverOff()` — .h line 44 / .cpp line 120
- `void screensaverPressed()` — .h line 45 / .cpp line 138
- `void onButtonConfirmStart()` — .h line 46 / .cpp line 50
- `void screensaverOn()` — .h line 47 / .cpp line 130
- `void setCamera(bool on, bool flip)` — .h line 48 / .cpp line 188

**Private slots:**
- `void rstLogout()` — .h line 54 / .cpp line 172
- `void onLogoutRequest()` — .h line 55 / .cpp line 156

**#include directives:**
- `.h`: `<QDialog>`
- `.cpp`: `"app/globalconfigs.h"`, `"authoriseddialog.h"`, `"ui_authoriseddialog.h"`, `"ui/optionalcheckconfirmationdialog.h"`, `<QMouseEvent>`, `<QTimer>`, `"app/driverlist.h"`, `<QDebug>`, `<QFile>`

**Member variables:**
- `bool m_waking` (private, .h line 37)
- `Ui::AuthorisedDialog *ui` (private, .h line 38)
- `OptionalCheckConfirmationDialog *m_optionalCheckConfirmationDialog` (private, .h line 39)
- `QTimer *m_resetTimer` (private, .h line 40)
- `quint32 m_lastPress` (private, .h line 41)
- `quint64 m_pendingDriverId` (private, .h line 42)
- `bool m_showCamera` (private, .h line 50)
- `bool m_power` (private, .h line 51)

**Conditional compilation:**
- `#ifdef UNIT_TEST` — `friend class TestDialog` declared at .h lines 25-27

**UI widgets (authoriseddialog.ui):**
- `AuthorisedDialog` — QDialog, 800x480
- `labelUpper` — QLabel (background panel, no text)
- `labelBelow` — QLabel (background panel, no text)
- `label` — QLabel (displays authorised.png pixmap)
- `label_2` — QLabel (displays "Cool! You are in.")
- `label_3` — QLabel (displays "You are authorised to operate this vehicle")
- `btnStart` — QPushButton (optional pre-op check trigger)
- `labelStart` — QLabel (displays "Optional pre-op check")
- `btnScreensaver` — QPushButton (full-screen screensaver overlay)
- `btnLogout` — QPushButton (logout button)
- `lblDriverName` — QLabel (displays driver name if `showDriverName` enabled)
- `labelTime` — QLabel (displays current time)

---

### File Set 3: BroadcastUIDialog

**File paths:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/broadcastuidialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/broadcastuidialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/broadcastuidialog.ui`

**Class name and base classes:**
- `BroadcastUIDialog : public QDialog`

**Q_OBJECT macro location:**
- `broadcastuidialog.h` line 14

**Public enum:**
- `enum MessageResult {MsgResultOK, MsgResultYes, MsgResultNo, MsgResultTimeout, MsgResultLogout, MsgResultNoDriver}` — .h line 17

**Public methods (with line numbers):**
- `explicit BroadcastUIDialog(QWidget *parent = nullptr)` — .h line 19 / .cpp line 4
- `~BroadcastUIDialog()` — .h line 20 / .cpp line 19
- `void setUIParam(CIGCONF::BroadcastMessage m)` — .h line 22 / .cpp line 24

**Signals:**
- `void messageClosed(CIGCONF::BroadcastMessage m)` — .h line 25

**Private slots:**
- `void onYes()` — .h line 32 / .cpp line 48
- `void onNo()` — .h line 33 / .cpp line 54
- `void onOK()` — .h line 34 / .cpp line 60

**#include directives:**
- `.h`: `"app/cigconfigs.h"`, `<QDialog>`, `<QTimer>`
- `.cpp`: `"broadcastuidialog.h"`, `"ui_broadcastuidialog.h"`

**Member variables:**
- `Ui::BroadcastUIDialog *ui` (private, .h line 28)
- `QTimer *m_timer` (private, .h line 29)

**UI widgets (broadcastuidialog.ui):**
- `BroadcastUIDialog` — QDialog, 800x480
- `pEditMsgBox` — QPlainTextEdit (read-only, displays broadcast message body; enabled=false, readOnly=true)
- `label` — QLabel (static header "Broadcast Message")
- `btnNo` — QPushButton ("NO")
- `btnYes` — QPushButton ("YES")
- `labelWarning` — QLabel (displays urgent.png pixmap when message type is set)
- `btnOK` — QPushButton ("OK")

---

## Step 5 — Security Review

### 1. Memory Safety

**A17-1** · LOW · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/authoriseddialog.cpp:192`
**Description:** `setCamera()` opens `/sys/class/gpio/gpio37/value` and `/sys/class/gpio/gpio39/value` using `QFile::open()` but does not check the return value of `open()`. If the GPIO sysfs entry is absent or permission-denied (e.g., during early boot, after a hardware fault, or on a non-ARM build), `file.write()` is called on an unopened file handle. While `QFile::write()` on a closed file returns -1 rather than crashing, the failure is entirely silent — no error is logged, no fallback is taken, and the camera/relay GPIO state becomes undefined. On a safety device this silent failure is a reliability concern. The pattern is repeated for both gpio37 (lines 192–198) and gpio39 (lines 201–208).

**A17-2** · LOW · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/broadcastuidialog.cpp:7`
**Description:** `m_timer` is allocated with `new QTimer` (no parent argument) in the constructor. All other `QTimer` and `QObject` child objects in this codebase are constructed with `this` as parent, enabling automatic deletion. This `QTimer` has no parent, so it is not part of the Qt object-ownership tree and will not be deleted when the dialog is destroyed unless explicitly managed. There is no `delete m_timer` in `~BroadcastUIDialog()` (destructor only calls `delete ui`), resulting in a memory leak every time a `BroadcastUIDialog` is instantiated and destroyed. In a long-running embedded application this leaks heap memory and an OS timer handle on every broadcast message receipt.

### 2. Communication Security

Communication Security: no issues found in the three assigned dialog files. These dialogs are display/UI components and do not themselves initiate network connections, transmit credentials, or contain hardcoded server addresses. The `BroadcastUIDialog` receives a `CIGCONF::BroadcastMessage` struct from the application layer and displays it — the communication path itself is out of scope for these files. No TLS configuration, certificate handling, or plaintext transmission logic is present in the reviewed files.

### 3. Input Handling

**A17-3** · MEDIUM · Input Handling
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/authoriseddialog.cpp:79`
**Description:** Driver name data received from the server (provisioned into `gCfg` via the driver list) is concatenated directly into a UI label string with no length validation or sanitisation: `ui->lblDriverName->setText("Welcome, " + driverName)`. `QLabel::setText()` renders rich text when it detects HTML tags, and `driverName` is a `QString` obtained from `m_driverList` structures populated from network-received data (AT commands from the GMTP server, or FTP-provisioned list files at `/home/dlist.txt`, `/home/mlist.txt`). A driver name containing HTML such as `<img src=x onerror=...>` or `<a href="file:///...">` may be rendered as rich text by Qt's label renderer, allowing UI content injection. While this does not have the same severity as a remote code execution on a server, it can produce misleading on-screen content and potentially trigger unintended Qt resource loading. The `QLabel` has no `setTextFormat(Qt::PlainText)` call to force plain-text rendering.

**A17-4** · LOW · Input Handling
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/broadcastuidialog.cpp:26`
**Description:** Broadcast message text from the server is truncated to `BROADCASTMSG_TEXT_LEN` (100 characters, defined in `cigconfigs.h` line 15) before display: `ui->pEditMsgBox->setPlainText(m.text.mid(0, BROADCASTMSG_TEXT_LEN))`. The use of `setPlainText()` correctly prevents HTML injection in this widget. The length truncation is a correct defensive control. However, the `timeout` field of `BroadcastMessage` is used without range validation at line 45: `m_timer->start(m.timeout * 1000)`. `m.timeout` is a `quint32`; multiplying by 1000 before passing to `QTimer::start(int msec)` (which takes a signed `int`) can overflow when `m.timeout` is greater than 2,147,483 (approximately 24.8 days). An attacker-controlled timeout value of 2,147,484 or higher would overflow to a negative or zero millisecond value, causing the timer to fire immediately or behave unpredictably, potentially bypassing the intended timeout-dismiss behaviour for broadcast messages.

### 4. Build Security

Build Security: not assessed in this file set. The assigned files are UI dialog source files (.h/.cpp/.ui). Build flags are controlled by the project `.pro` file, which is outside the file set assigned to A17. No build configuration artefacts are present in these files.

### 5. Device and Firmware

**A17-5** · MEDIUM · Device and Firmware — Authorization Logic
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/authoriseddialog.cpp:160`
**Description:** The logout confirmation check at line 160 compares the button's displayed text string against a translated string to determine whether to execute a logout: `if (ui->btnLogout->text() == tr("Confirm?"))`. This is a UI-state-as-security-gate pattern. The authorization state ("is the user in the first-press or second-press/confirm stage?") is stored in a mutable UI widget property rather than in a dedicated boolean member variable. This creates two risks: (1) if a translation for "Confirm?" in any supported locale produces a string that collides with "Logout" (the initial button label), a single press would immediately log out without confirmation; (2) any external path that sets `btnLogout`'s text to "Confirm?" (e.g., a language-change event firing at an unexpected time) could cause the dialog to treat the next button press as a confirmed logout even if the user has not initiated one. The correct pattern is to maintain an explicit `bool m_awaitingLogoutConfirm` state variable.

**A17-6** · LOW · Device and Firmware — GPIO Error Handling
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/authoriseddialog.cpp:188`
**Description:** The `setCamera()` function controls hardware GPIO lines by writing to sysfs files (`/sys/class/gpio/gpio37/value`, `/sys/class/gpio/gpio39/value`). This is a direct hardware control path for the camera and (by implication) a relay. No error is returned from `setCamera()` (return type is `void`), no error is logged, and callers (`updateCamera()`) have no way to detect or respond to a GPIO write failure. In a proximity-detection device where camera state may be safety-relevant (e.g., reversing camera for proximity alerts), silent hardware control failure is a safety and audit concern.

**A17-7** · INFO · Device and Firmware — UNIT_TEST Friend Class
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/authoriseddialog.h:25`
**Description:** `AuthorisedDialog` declares `friend class TestDialog` under `#ifdef UNIT_TEST` (lines 25–27). This pattern is standard and the guard ensures the friend declaration is removed from production builds. Auditors should verify that no production build configuration defines `UNIT_TEST`, as doing so would grant `TestDialog` unrestricted access to all private members of the authorization dialog, including `m_pendingDriverId` and `m_optionalCheckConfirmationDialog`.

### 6. Qt-Specific Security

**A17-8** · LOW · Qt-Specific Security — screensaver debounce via QTimer::singleShot
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/authoriseddialog.cpp:145`
**Description:** The screensaver wake-up path uses `QTimer::singleShot(200, this, [this](){screensaverOff();})`. The lambda captures `this` by value. If the `AuthorisedDialog` is destroyed within the 200 ms window (e.g., a logout is processed while the screensaver wake timer is in flight), the lambda will execute with a dangling `this` pointer, invoking `screensaverOff()` on a destroyed object. Qt's `QTimer::singleShot` with a raw `this` context pointer does not automatically invalidate the callback when the context object is destroyed when used with a lambda (unlike the `SLOT()` form which uses Qt's connection tracking). This is a potential use-after-free. The pattern at line 126 (`QTimer::singleShot(5000, this, &AuthorisedDialog::screensaverOn)`) uses a member function pointer form and is safe because Qt's signal/slot connection tracks object lifetime. Only the lambda form at line 145 is affected.

Qt-Specific: No `QProcess` usage, no `QSslSocket` usage, no `QSettings` usage, and no dynamic code execution was found in any of the three reviewed dialog files.

---

## Summary of Findings

| ID | Severity | Category | File |
|----|----------|----------|------|
| A17-1 | LOW | Memory Safety | authoriseddialog.cpp:192 |
| A17-2 | LOW | Memory Safety | broadcastuidialog.cpp:7 |
| A17-3 | MEDIUM | Input Handling | authoriseddialog.cpp:79 |
| A17-4 | LOW | Input Handling | broadcastuidialog.cpp:45 |
| A17-5 | MEDIUM | Device and Firmware | authoriseddialog.cpp:160 |
| A17-6 | LOW | Device and Firmware | authoriseddialog.cpp:188 |
| A17-7 | INFO | Device and Firmware | authoriseddialog.h:25 |
| A17-8 | LOW | Qt-Specific Security | authoriseddialog.cpp:145 |
