# Pass 1 — A05 Security Audit
**Auditor:** A05
**Date:** 2026-02-28
**Branch:** master (confirmed)

---

## Reading Evidence

### File Pair 1: globalconfigs.h / globalconfigs.cpp

**File paths:**
- `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp`

**Class name and base classes:**
- `GlobalConfigs` : public `QObject`

**Q_OBJECT macro location:**
- `globalconfigs.h` line 17

**#include directives (header):**
- `<QtGlobal>` (line 4)
- `<QFile>` (line 5)
- `<QDateTime>` (line 6)
- `<QObject>` (line 7)
- `"utils/bytearray.h"` (line 8)
- `"app/cigconfigs.h"` (line 9)
- `"app/checklist.h"` (line 10)
- `"app/driverlist.h"` (line 11)

**#include directives (source):**
- `"globalconfigs.h"` (line 1)
- `"platform/internalrtc.h"` (line 2)
- `<QGlobalStatic>` (line 3)
- `<QBluetoothAddress>` (line 4)
- `<QProcess>` (line 5)
- `<QDebug>` (line 6)
- `<QSaveFile>` (line 7)
- `<QTextStream>` (line 8)
- `<QString>` (line 9)

**Signals:**
- `superListChanged(bool empty)` — line 710
- `convorStatusChanged()` — line 711
- `preopOncePerDayStatusChanged()` — line 712

**Slots:** None declared explicitly (no public/protected slots section)

**Every public method with signature and line number (selected key methods):**
- `explicit GlobalConfigs(QObject *parent = nullptr)` — line 20
- `static GlobalConfigs *instance()` — line 21
- `static quint32 crc32(const void *buf, int len)` — line 22
- `void readConfigs()` — line 24
- `void saveConfigs()` — line 25
- `void saveOpdDriverList()` — line 26
- `void resetConfigs(bool resetAll = false)` — line 27
- `quint32 keepAliveTime() const` — line 30
- `bool setKeepAliveTime(quint32 time)` — line 31
- `quint32 shutdownTime() const` — line 40
- `bool setShutdownTime(quint32 time)` — line 41
- `QByteArray gmtpId() const` — line 50
- `bool setGmtpId(const QByteArray &id)` — line 51
- `bool setDialNumber(const QByteArray &number)` — line 88
- `bool setApn(const QByteArray &apn)` — line 98
- `bool setApnUser(const QByteArray &user)` — line 108
- `bool setApnPassword(const QByteArray &password)` — line 118
- `QByteArray gmtpServerAddress(int index) const` — line 127
- `bool setGmtpServerAddress(int index, const QByteArray &addr)` — line 128
- `quint16 gmtpServerPort(int index) const` — line 137
- `bool setGmtpServerPort(int index, quint16 port)` — line 138
- `bool setWifiNetwork(quint32 index, const QByteArray &ssid, const QByteArray &pw)` — line 588
- `bool setWifiCountry(const QByteArray &country)` — line 591
- `void clearWifiConfig()` — line 594
- `quint32 shockThreshold() const` — line 382
- `bool setShockThreshold(quint32 data)` — line 383
- `quint32 shockRedImpact() const` — line 389
- `bool setShockRedImpact(quint32 data)` — line 390
- `quint32 shockPeriod() const` — line 396
- `bool setShockPeriod(quint32 data)` — line 397
- `quint32 shockTimer() const` — line 403
- `bool setShockTimer(quint32 data)` — line 404
- `quint64 fwVersion()` — line 569
- `QString fwVersionString()` — line 570

**Key constants (defined in .cpp):**
- `FMS_INI_FILE` = `"fms.ini"` (line 13)
- `DYN_INI_FILE` = `"dyn.ini"` (line 14)
- `FMS_CONFIG_FILE` = `"fmscfg.dat"` (line 15)
- `OD_CONFIG_FILE` = `"odcfg.dat"` (line 16)
- `VOR_CONFIG_FILE` = `"vor.cfg"` (line 17)
- `GFNCE_CONFIG_FILE` = `"gfnce.cfg"` (line 18)
- `MAGIC_CODE` = `0xA53F3456` (line 19)
- `OD_VERSION` = `1` (line 20)

**Hardcoded values of note in resetConfigs():**
- Default GMTP server address: `"fleetiq.ciifm.com"` (line 208)
- Default GMTP server port: `4687` (line 209)
- Default time server: `"ntp.ciifm.com"` (line 217)
- Default BLE MAC: `"00:07:80:2E:9B:85"` (line 189)

**Key member variables:**
- `ConfigsData m_configs` — includes `gmtpServer[]`, `apnPassword[]`, `dialNumber[]`, `apn[]`, `apnUser[]`, `shockThreshold`, `shockRedImpact`, `shockPeriod`, `shockTimer`, `timeServerAddress`
- `char simICCID[MODEM_ICCID_LEN]` — line 849
- `QList<CIGCONF::WifiNetwork> m_networks` — includes ssid/password pairs (line 819)

---

### File Pair 2: bleexpansion.h / bleexpansion.cpp

**File paths:**
- `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansion.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansion.cpp`

**Class name and base classes:**
- `BleExpansion` : public `QObject`

**Q_OBJECT macro location:**
- `bleexpansion.h` line 25

**#include directives (header):**
- `"app/cigconfigs.h"` (line 4)
- `<QObject>` (line 5)
- `<QDateTime>` (line 6)
- `<QBluetoothAddress>` (line 7)
- `<QBluetoothUuid>` (line 8)
- `<QQueue>` (line 9)
- `<QTimer>` (line 10)

**#include directives (source):**
- `"bleexpansion.h"` (line 1)
- `"platform/blecentral.h"` (line 2)
- `"platform/seriallogger.h"` (line 3)
- `"comm/bleexpansionuuid.h"` (line 4)
- `"app/globalconfigs.h"` (line 5)
- `<QTimerEvent>` (line 6)
- `<QDebug>` (line 7)

**Signals:**
- `accessible(bool yes)` — line 60
- `inputStateChanged(CIGCONF::BleExpansionDI input, bool state)` — line 61
- `shockOccurred()` — line 62
- `amberImpactOccurred()` — line 63
- `redImpactOccurred()` — line 64

**Slots (protected):**
- `void timerEvent(QTimerEvent *)` — line 67 (not a Qt slot per se, but overrides QObject::timerEvent)

**Public methods with signatures and line numbers:**
- `explicit BleExpansion(EM070::BleCentral *bleCentral)` — line 32
- `void setEnabled(bool enable)` — line 34
- `const QByteArray &deviceName() const` — line 36
- `const QByteArray &bleVersion() const` — line 37
- `const QByteArray &mainVersion() const` — line 38
- `const QByteArray &manufacture() const` — line 39
- `const QByteArray &modelNumber() const` — line 40
- `bool digitalInput(CIGCONF::BleExpansionDI di) const` — line 42
- `bool relayOutput(CIGCONF::BleExpansionRelay relay) const` — line 44
- `void setRelayOutput(CIGCONF::BleExpansionRelay relay, bool state)` — line 47
- `void setShockThreshold(quint32 threshold)` — line 49
- `void setShockPeriod(quint32 period)` — line 50
- `bool isShockQueueEmpty()` — line 52
- `ShockEvent shockEvent()` — line 53
- `void setCurrentTime(const QDateTime &time)` — line 55
- `bool generateShockMessage(bool force)` — line 57

**Key constants in source:**
- `AUTH_CODE` = `"uS8MgpklMx"` (line 9)
- `MAX_SHOCK_COUNT` = `10000` (line 11)
- `RELAY1_TIMEOUT` = `60` (line 12)
- `RELAY2_TIMEOUT` = `60` (line 13)

**Key member variables:**
- `EM070::BleCentral *m_bleCentral` — line 116
- `bool m_digitalInput[4]` — line 132
- `bool m_outputRelay[2]` — line 133
- `quint32 m_shockThreshold` — line 134
- `quint32 m_shockPeriod` — line 135
- `quint32 m_shockMaxMagnitude` — line 131
- `QQueue<ShockEvent> m_shockEvents` — line 140
- `union RtcTime { char data[10]; ... }` — line 71
- `union WritePending { quint32 val; ... }` — line 85

---

## Security Review

### 1. Memory Safety

**A05-1** · HIGH · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.h:53`
**Description:** `setGmtpId()` uses `qstrcpy(m_configs.gmtpId, id.constData())` after checking `id.size() < GMTP_ID_LEN`. The check correctly excludes inputs equal to `GMTP_ID_LEN`, but `qstrcpy` performs no length enforcement — if the caller passes a `QByteArray` that does not contain a null terminator and whose `.size()` matches one of the raw bytes, the copy could overrun the destination buffer. More critically, `qstrcpy` is equivalent to `strcpy` and copies until a null byte: if the source `QByteArray` was constructed without an embedded null (e.g. from network data), the copy will read past the declared length. The same pattern applies to `setDialNumber()` (line 90), `setApn()` (line 100), `setApnUser()` (line 110), `setApnPassword()` (line 120), `setGmtpServerAddress()` (line 130), `setTimeServerAddress()` (line 422), and the `resetConfigs()` direct `qstrcpy` calls on lines 183, 197, 208, 217. Every one of these should use `qstrncpy` or `memcpy` with a known length. In an embedded C++ device, a stack or struct buffer overflow from network-supplied configuration data is a memory-safety and safety-critical finding.

**A05-2** · MEDIUM · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.h:162`
**Description:** `setSimCardID()` uses `qstrcpy(simICCID, iccid.constData())` after checking `iccid.size() < MODEM_ICCID_LEN`. The same null-terminator assumption as A05-1 applies. A `QByteArray` built from raw modem data may not terminate with `\0`, causing overrun of the fixed-size `char simICCID[MODEM_ICCID_LEN]` member.

**A05-3** · MEDIUM · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:800-816`
**Description:** `readGeofenceConfig()` uses polygon indices `n` and `vect` parsed directly from a config file with `toInt()-1`. There is no bounds check on `n` before `m_polygon[n]` is written (line 806-807). If the file contains `n=0` the resulting index is `-1`, and if `n` exceeds `MAX_POLY` the array `m_polygon[MAX_POLY]` is overwritten out of bounds. Similarly `vect` is not checked against `MAX_POLY_POINTS` before the write. This is an out-of-bounds write from a file that may be modified or replaced on the device filesystem.

**A05-4** · LOW · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:140`
**Description:** In `resetConfigs()`, line 140 reads `memset(&m_configs, 0, sizeof(ConfigsDataExt))`. The first argument is `&m_configs` which is of type `ConfigsData`, not `ConfigsDataExt`. This is almost certainly a copy-paste error; the intent was `memset(&m_configsExt, 0, sizeof(ConfigsDataExt))`. The effect is that the first `sizeof(ConfigsDataExt)` bytes of `m_configs` are zeroed a second time (redundant but harmless as written), while `m_configsExt` is never zero-initialised by this call. This means `m_configsExt.unlkScr` retains its previous value across a `resetConfigs()` call unless explicitly set afterward (it is set at line 231). The bug may mask future fields added to `ConfigsDataExt` that require explicit reset.

### 2. Communication Security

**A05-5** · HIGH · Communication Security — Hardcoded Server Addresses
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:208`
**Description:** The GMTP server hostname `"fleetiq.ciifm.com"` and port `4687` are hardcoded as the default reset values applied in `resetConfigs()`. The NTP server `"ntp.ciifm.com"` is also hardcoded (line 217). Hardcoding production server addresses in firmware prevents environment separation (dev/staging/production), makes it impossible to redirect devices to a different backend without a firmware update, and leaks infrastructure topology. These values should be injected via a provisioning process or read from a secure configuration store.

**A05-6** · HIGH · Communication Security — Hardcoded BLE Authentication Credential
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansion.cpp:9`
**Description:** The BLE expansion module authentication code `AUTH_CODE "uS8MgpklMx"` is hardcoded as a plain-text `#define` and passed directly as the authorization code to the BLE central (line 40). This credential is the same across all devices (it is baked into the firmware binary). Any attacker with access to the firmware binary can extract it and use it to authenticate to any expansion module that shares this firmware. The credential should be unique per device and injected at provisioning time.

**A05-7** · MEDIUM · Communication Security — Hardcoded Default BLE MAC Address
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:189`
**Description:** The expansion module MAC address `"00:07:80:2E:9B:85"` is hardcoded as the default in `resetConfigs()`. If a device configuration is reset, the device will attempt to connect to this specific hardcoded MAC address. In a multi-device deployment this means all reset devices would try to pair with the same physical module. While this is likely a factory default, it represents a misconfiguration risk and should be clearly flagged.

**A05-8** · MEDIUM · Communication Security — WiFi Passwords Stored in Plaintext Config File
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:480-481`
**Description:** `saveStaticConfig()` writes WiFi SSID and password pairs to `fms.ini` as plaintext: `out << "Wifi network " << i+1 << "=" << m_networks[i].ssid << "," << m_networks[i].pw`. If the device filesystem is accessible (e.g. via USB mass storage, serial console, or physical extraction), all configured WiFi credentials are trivially readable.

**A05-9** · MEDIUM · Communication Security — APN Password Stored in Plaintext Config File
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:442`
**Description:** `saveStaticConfig()` writes the cellular APN password to `fms.ini` in plaintext: `out << "APN password=" << apnPassword()`. An attacker with filesystem access obtains the cellular APN credential without any further effort.

**A05-10** · INFO · Communication Security — No TLS or Certificate Validation Visible in These Files
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp`
**Description:** The GMTP server address and port are stored and configured here, but no TLS, certificate pinning, or peer verification logic is present in these files. Whether TLS is applied at the connection layer (in the GMTP communication module) cannot be confirmed from these files alone. This should be verified in the GMTP/comm module during a subsequent pass.

### 3. Input Handling

**A05-11** · MEDIUM · Input Handling — Config File Values Applied Without Range Validation
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:319-325`
**Description:** In `readStaticConfig()`, the shock safety parameters `shockThreshold`, `shockRedImpact`, `shockPeriod`, and `shockTimer` are read from the plaintext `fms.ini` file and assigned directly to `m_configs` fields without any range validation. For example, `m_configs.shockThreshold = args[1].toUInt()` (line 319). An attacker or corrupted file that sets `shockThreshold = 0` would cause every vibration to register as a shock event; setting `shockRedImpact` to a very high value would suppress red-impact alerts. These are safety-critical parameters — they should be range-validated on read.

**A05-12** · MEDIUM · Input Handling — Config File Values Applied Without Range Validation (Idle/Keepalive/GPS)
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:286-331`
**Description:** Several additional configuration values are read from `fms.ini` and assigned directly without range checking: `keepAliveTime` (line 286), `shutdownTime` (line 288), `gpsUpdateTime` (line 331), `idleTimeout` (line 333). The setter methods for these values (`setKeepAliveTime`, `setShutdownTime`) do apply range checks, but `readStaticConfig()` bypasses the setters and writes directly to `m_configs` struct fields. This means the range checks in the setters are ineffective for values loaded from the config file.

**A05-13** · MEDIUM · Input Handling — BLE Shock Event Data Parsed via Raw Pointer Cast Without Full Validation
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansion.cpp:202-205`
**Description:** `popShockEvent()` checks `ba.size() >= 8` and then accesses `event.timestamp` and `event.magnitude` by casting `ba.constData()` to `const quint32 *`. The size check is present and the alignment comment notes `4-byte aligned is safe`. However, there is no validation that the BLE payload is not adversarially crafted to contain unexpected values. Specifically, `event.magnitude` is used directly in comparisons against `gCfg->shockRedImpact()` and `gCfg->shockThreshold()` to trigger safety alerts (`emit redImpactOccurred()`). A malicious or faulty BLE peripheral could send an arbitrarily high magnitude and trigger a false safety event, or send zero magnitude to suppress real events. Input from a BLE peripheral should be treated as untrusted.

**A05-14** · LOW · Input Handling — Digital Input State Treated as Full Byte, Not Boolean
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/comm/bleexpansion.cpp:332-334`
**Description:** In `characteristicRead()`, when handling `inputD0` through `inputD3`, the code reads `ba[0]` and assigns it directly as a `bool` value: `m_digitalInput[0] = ba[0]`. The emit is `emit inputStateChanged(CIGCONF::BleExpDI1, ba[0])`. Any non-zero byte from the BLE peripheral will be treated as `true`. While functionally equivalent in most cases, a malformed byte from the peripheral could encode additional data that is silently discarded, masking a protocol mismatch. More importantly, `ba[0]` is a `char` which is sign-extended; value `0xFF` as a signed char is `-1`, which is truthy. This is a minor robustness issue.

### 4. Build Security

Build Security: no issues found in the files assigned to this auditor. The `.pro` file was not assigned; compiler security flags (`-fstack-protector-strong`, `-D_FORTIFY_SOURCE=2`, `-fPIE`, `-Wformat-security`) should be checked by the auditor assigned that file.

**A05-15** · MEDIUM · Build Security — QProcess Included But Usage Not Visible in Assigned Files
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:5`
**Description:** `<QProcess>` is `#include`d in `globalconfigs.cpp` but no `QProcess` usage is visible anywhere in the file. This unused include may be a leftover from removed code, or `QProcess` may be invoked in a macro or template instantiation not visible here. The presence of this include warrants a targeted grep across the codebase to confirm whether `QProcess` is used anywhere with arguments derived from configuration values (which would be a HIGH finding).

### 5. Device and Firmware

**A05-16** · HIGH · Device and Firmware — Safety-Critical Shock Thresholds Received Without Validation
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.h:383-408`
**Description:** The setter methods `setShockThreshold()`, `setShockRedImpact()`, `setShockPeriod()`, and `setShockTimer()` accept any `quint32` value without range validation. These thresholds directly determine when proximity/impact alerts are triggered (`amberImpactOccurred`, `redImpactOccurred` signals in `bleexpansion.cpp`). A server-sent configuration message that sets `shockThreshold` to `UINT32_MAX` would permanently disable all shock alerts. A value of `0` for `shockRedImpact` or `shockThreshold` bypasses alert logic (checked with `if (gCfg->shockRedImpact() && ...)` in bleexpansion.cpp line 213). Safety-critical parameters received from the network must have validated minimum/maximum bounds before being applied.

**A05-17** · MEDIUM · Device and Firmware — Default Shock Threshold Hardcoded
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:211`
**Description:** `m_configs.shockThreshold = 80000` is set as the hardcoded factory default in `resetConfigs()`. While defaults are expected, the value `80000` has no documented engineering basis visible in the code and no associated comment explaining the unit or calibration rationale. If this value is incorrect for a given vehicle type, it could result in missed impact events. The safety-critical nature of this threshold warrants a documented, validated default value.

**A05-18** · INFO · Device and Firmware — Full Lockout Enable/Timeout Have No Upper Bound Validation
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.h:271-282`
**Description:** `setFullLockoutEnable()` and `setFullLockoutTimeout()` accept any `quint8` or `quint32` value without validation. A lockout timeout of `0` or `UINT32_MAX` could cause unexpected device behavior (permanent lockout or instant expiry). Range validation should be applied.

### 6. Qt-Specific Security

**A05-19** · MEDIUM · Qt-Specific Security — QProcess Included Unnecessarily
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/app/globalconfigs.cpp:5`
**Description:** `#include <QProcess>` appears in `globalconfigs.cpp` with no corresponding usage in the file. As noted in A05-15, this raises the question of whether `QProcess` is used elsewhere with inputs derived from global configuration values (server addresses, APN strings, etc.). If any `QProcess` invocation passes configuration-derived values as command arguments, it would be a HIGH finding. This include should be removed if unused, or investigated if it reflects an intended use not visible in this file.

QSslSocket peer verify mode: no QSslSocket usage found in the assigned files.

---

## Summary of Findings

| ID | Severity | Category | Location |
|----|----------|----------|----------|
| A05-1 | HIGH | Memory Safety | `globalconfigs.h:53` (qstrcpy pattern, multiple setters) |
| A05-2 | MEDIUM | Memory Safety | `globalconfigs.h:162` (setSimCardID qstrcpy) |
| A05-3 | MEDIUM | Memory Safety | `globalconfigs.cpp:800-816` (geofence index no bounds check) |
| A05-4 | LOW | Memory Safety | `globalconfigs.cpp:140` (wrong memset target) |
| A05-5 | HIGH | Communication Security | `globalconfigs.cpp:208` (hardcoded server addresses) |
| A05-6 | HIGH | Communication Security | `bleexpansion.cpp:9` (hardcoded BLE auth credential) |
| A05-7 | MEDIUM | Communication Security | `globalconfigs.cpp:189` (hardcoded BLE MAC) |
| A05-8 | MEDIUM | Communication Security | `globalconfigs.cpp:480-481` (WiFi passwords plaintext) |
| A05-9 | MEDIUM | Communication Security | `globalconfigs.cpp:442` (APN password plaintext) |
| A05-10 | INFO | Communication Security | `globalconfigs.cpp` (TLS not verifiable from these files) |
| A05-11 | MEDIUM | Input Handling | `globalconfigs.cpp:319-325` (shock params no range check on read) |
| A05-12 | MEDIUM | Input Handling | `globalconfigs.cpp:286-331` (setters bypassed on config read) |
| A05-13 | MEDIUM | Input Handling | `bleexpansion.cpp:202-205` (BLE shock data trusted without validation) |
| A05-14 | LOW | Input Handling | `bleexpansion.cpp:332-334` (digital input byte not masked to bool) |
| A05-15 | MEDIUM | Build Security | `globalconfigs.cpp:5` (unused QProcess include) |
| A05-16 | HIGH | Device and Firmware | `globalconfigs.h:383-408` (shock thresholds no range validation) |
| A05-17 | MEDIUM | Device and Firmware | `globalconfigs.cpp:211` (default shock threshold undocumented) |
| A05-18 | INFO | Device and Firmware | `globalconfigs.h:271-282` (lockout params no upper bound) |
| A05-19 | MEDIUM | Qt-Specific Security | `globalconfigs.cpp:5` (QProcess include, potential misuse) |
