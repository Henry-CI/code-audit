# Pass 1 Security Audit — A22
**Auditor:** A22
**Date:** 2026-02-28
**Branch:** master
**Repository:** mark3-pvd

---

## Step 1 — Branch Verification

```
git -C /c/Projects/cig-audit/repos/mark3-pvd rev-parse --abbrev-ref HEAD
master
```

Branch confirmed: master.

---

## Step 4 — Reading Evidence

### File Set 1: OnDemandDialog

**File paths:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/ondemanddialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/ondemanddialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/ondemanddialog.ui`

**Class name and base classes:**
- `OnDemandDialog` : `QDialog`

**Q_OBJECT macro location:**
- `ondemanddialog.h` line 17

**Every #include directive:**
- `ondemanddialog.h`: `<QDialog>`, `<QMap>`, `<QString>`, `<QPushButton>`, `<QTimer>`, `"app/cigconfigs.h"`
- `ondemanddialog.cpp`: `"ondemanddialog.h"`, `"ui_ondemanddialog.h"`, `"app/globalconfigs.h"`, `<QPalette>`

**Every public method with signature and line number:**
- `explicit OnDemandDialog(QWidget *parent = 0)` — h:20
- `~OnDemandDialog()` — h:21
- `void setSuperMasterId(quint64 id)` — h:23 (inline)
- `void reset()` — h:24
- `void setTimeRemaining(quint32 secs)` — h:25
- `QString showCustomTimeFormat(quint32 time)` — h:26

**Every signal:**
- `void onDemandStarted(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src = CIGCONF::OnDemandLocal)` — h:29
- `void onDemandExtended(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src = CIGCONF::OnDemandLocal)` — h:30
- `void onDemandEnded(quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src = CIGCONF::OnDemandLocal)` — h:31

**Slots (protected methods used as slots):**
- `void showEvent(QShowEvent *event = 0)` — h:34
- `void onStart()` — h:36
- `void onExtend()` — h:37
- `void onEnd()` — h:38

**Private methods:**
- `bool debounce()` — h:41

**Member variables:**
- `Ui::OnDemandDialog *ui` — h:42
- `QTimer *m_timer` — h:44
- `quint32 m_lastPress` — h:45
- `quint64 m_smId` — h:46

**#define constants (ondemanddialog.cpp):**
- `NO_ACTIVITY_TIME 10000` — cpp:7

**UI widgets (ondemanddialog.ui):**
- `QPushButton btnHide` — closes dialog (accept)
- `QLabel labelMsg` — main message label
- `QPushButton btnStart` — starts on-demand session (initially disabled)
- `QPushButton btnExtend` — extends session (initially disabled)
- `QPushButton btnEnd` — ends session (initially disabled)
- `QLabel label` — describes Start button
- `QLabel label_2` — describes Extend button
- `QLabel label_3` — describes End button

---

### File Set 2: OptionalCheckConfirmationDialog

**File paths:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/optionalcheckconfirmationdialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/optionalcheckconfirmationdialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/optionalcheckconfirmationdialog.ui`

**Class name and base classes:**
- `OptionalCheckConfirmationDialog` : `QDialog`

**Q_OBJECT macro location:**
- `optionalcheckconfirmationdialog.h` line 12

**Every #include directive:**
- `optionalcheckconfirmationdialog.h`: `<QDialog>`
- `optionalcheckconfirmationdialog.cpp`: `"optionalcheckconfirmationdialog.h"`, `"ui_optionalcheckconfirmationdialog.h"`, `<QTimer>`, `<QDebug>`

**Every public method with signature and line number:**
- `explicit OptionalCheckConfirmationDialog(QWidget *parent = 0)` — h:15
- `~OptionalCheckConfirmationDialog()` — h:16
- `void onRefreshLanguage(void)` — h:17

**Signals:** None defined.

**Protected methods:**
- `void hideEvent(QHideEvent *)` — h:24
- `void showEvent(QShowEvent *event = 0)` — h:25

**Member variables:**
- `Ui::OptionalCheckConfirmationDialog *ui` — h:20
- `QTimer *m_timer` — h:21

**UI widgets (optionalcheckconfirmationdialog.ui):**
- `QLabel label_2` — lower background gradient label
- `QLabel label` — upper background gradient label
- `QWidget layoutWidget` — container for VBoxLayout
  - `QLabel labelTip11` — "Please confirm that you would like to do"
  - `QLabel labelTip22_2` — "an"
  - `QLabel labelTip21` — " optional " (red text)
  - `QLabel labelTip22` — "pre-op safety check."
- `QPushButton btnYes` — accepts dialog
- `QPushButton btnNo` — rejects dialog

---

### File Set 3: PinDialog

**File paths:**
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.h`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.cpp`
- `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.ui`

**Class name and base classes:**
- `PinDialog` : `QDialog`

**Q_OBJECT macro location:**
- `pindialog.h` line 14

**Every #include directive:**
- `pindialog.h`: `<QDialog>` (forward declares `QTimer`)
- `pindialog.cpp`: `"pindialog.h"`, `"ui_pindialog.h"`, `"app/globalconfigs.h"`, `<QDebug>`, `<QTimer>`, `<QThread>`, `<QApplication>`

**Every public method with signature and line number:**
- `explicit PinDialog(QWidget *parent = 0)` — h:17
- `~PinDialog()` — h:18
- `quint32 pinCode() const` — h:20
- `void clearPinCode()` — h:21
- `void languageChanged()` — h:22

**Protected methods (event handlers):**
- `void showEvent(QShowEvent *)` — h:25
- `void hideEvent(QHideEvent *)` — h:26

**Private methods:**
- `void keyPressed()` — h:29

**Member variables:**
- `Ui::PinDialog *ui` — h:31
- `QTimer *m_timer` — h:32

**#define constants (pindialog.cpp):**
- `PIN_MAX_LENGTH 5` — cpp:9
- `ACTIVITY_TIME 30000` — cpp:10

**UI widgets (pindialog.ui):**
- `QWidget layoutWidget` — container for keypad VBoxLayout
  - `QPushButton btn1` through `btn9`, `btn0` — digit keys (text = digit string)
  - `QPushButton btnCancel` — rejects dialog
  - `QPushButton btnClear` — clears input (text = "CLEAR")
  - `QPushButton btnEnter` — accepts dialog
  - `QPushButton btnStar` — key with text "*"
  - `QPushButton btnHash` — key with text "#" (also triggers accept)
  - `QPushButton btnBack` — backspace (text = "DEL")
- `QLabel label` — "Please enter PIN"
- `QLineEdit lineEdit` — stores PIN; maxLength=5; echoMode=`QLineEdit::PasswordEchoOnEdit`
- `QLabel labelPin` — overlapping asterisk masking label (workaround for Helvetica font)

---

## Step 5 — Security Review

### 1. Memory Safety

**A22-1** · LOW · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.cpp:51`
**Description:** The debounce variable `last` inside `keyPressed()` is declared `static quint64 last = 0`. On a single-CPU embedded device this is not a thread-safety issue in practice, but a static local variable persists PIN-entry timing state across all dialog open/close cycles for the lifetime of the process. If `gCfg->clockTime()` ever wraps or returns a value less than the stored `last` value (which is handled on line 54-55 only for the case `last > now`), debounce logic could be bypassed or permanently block input. The condition on line 54 resets `last` only when `last > now`, meaning a wrap scenario where `now` skips past `last` by an amount less than 50ms would not be caught. The risk is low on a stable embedded clock, but the pattern is fragile for an authentication input handler.

**A22-2** · LOW · Memory Safety
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.cpp:97`
**Description:** `pinCode()` returns a `quint32`. The PIN value is then cast to `quint64` at the call site (`dialog.cpp:321`). The PIN digits are accumulated via `val *= 10; val += c.toLatin1() - '0'` with no overflow check on `val`. With `PIN_MAX_LENGTH` enforced at 5 digits, the maximum value is 99999, which fits comfortably in `quint32`. However, the `*` button is wired to `keyPressed()` (which inserts the `*` character), and `pinCode()` stops parsing at the first non-digit character. If the asterisk button text ("*") is inserted, the returned PIN will be 0 or a truncated value — silently, without any user feedback — which could enable a brute-force shortcut via the `*` key.

### 2. Communication Security

**A22-3** · HIGH · Communication Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/dialog.cpp:546`
**Description:** When a PIN is accepted, `onPinDialogAccepted()` calls `login()`, which immediately emits `sendGmtpMessage(CIGCONF::GMTP_CARD, QByteArray::number(id, 16))` at line 546. The GMTP transport (`comm/gmtpchat.cpp:24`) uses a plain `QTcpSocket`, not `QSslSocket`. There is no TLS wrapping in the GMTP communication layer. The `AesCrypto::encrypt()` function exists in `platform/aescrypto.cpp` but is never called anywhere in the GMTP send path. Consequently, the PIN-derived identifier is transmitted to the server in plaintext hex format over an unencrypted TCP connection on port 4687. Any network observer on the path between the device and `fleetiq.ciifm.com` can capture and replay this value to impersonate a driver.

**A22-4** · MEDIUM · Communication Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/platform/aescrypto.cpp:124`
**Description:** A hardcoded AES-CBC initialization vector `\x3d\xaf\xba\x42\x9d\x9e\xb4\x30\xb4\x22\xda\x80\x2c\x9f\xac\x41` is embedded in `aescrypto.cpp` at line 124. A fixed IV with CBC mode destroys semantic security: two identical plaintexts always produce identical ciphertexts, and patterns in the first block are not concealed. Although `AesCrypto::encrypt()` is not currently called in the GMTP path, this function is part of the codebase and may be used for firmware or configuration encryption. A hardcoded IV committed to version control is a security finding regardless of current usage.

### 3. Input Handling

**A22-5** · MEDIUM · Input Handling
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.cpp:29`
**Description:** The `*` (star) button is connected to `keyPressed()` and will insert the literal character `"*"` into `ui->lineEdit`. The `pinCode()` method stops digit parsing at the first non-digit character and returns the partial numeric value accumulated up to that point. This means a user (or an attacker with physical access) can submit a partial PIN ending in `*` — for example, entering `123*` will result in `pinCode()` returning 123 — and that truncated value is then passed to `login()`. Depending on whether 123 happens to be a valid driver ID, this may allow PIN bypass. The `*` key should be validated out of the accepted character set or prevented from triggering `accept()`.

**A22-6** · MEDIUM · Input Handling
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.cpp:34`
**Description:** The `#` (hash) button is connected directly to `accept()` (line 35 in constructor), not to `keyPressed()`. Pressing `#` immediately submits the dialog regardless of how many digits have been entered, including zero digits. A user pressing `#` on an empty PIN field calls `pinCode()`, which returns 0. If 0 happens to map to a valid or fallback driver identifier (e.g., if the caller does not validate the returned code before calling `login()`), an empty PIN could authenticate. The `pinCode()` return value of 0 should be explicitly rejected before calling `login()`, or `#` should be treated as ENTER (requiring minimum-length validation) rather than as an unconditional submit trigger.

### 4. Build Security

Build Security: no issues found in the reviewed files. The `.pro` file and build configuration were not part of this file assignment. No compiler flags or build-related content appears in the three dialog files reviewed.

### 5. Device and Firmware

**A22-7** · HIGH · Device and Firmware
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.cpp:112`
**Description:** After a successful PIN submission, `clearPinCode()` is never called. In `onPinDialogAccepted()` (`dialog.cpp:319-323`), `pinCode()` is read and `login()` is called, but `clearPinCode()` is not invoked. The PIN string remains stored in `ui->lineEdit` until the next time the PIN dialog is opened — at which point `clearPinCode()` is called before `open()` (see `dialog.cpp:272`). Between those two events, the PIN digits remain accessible in the QLineEdit widget's internal buffer. On an embedded device, this buffer lives in process heap memory and is not zeroed. A memory dump of the process (e.g., via `/proc/<pid>/mem`, a crash dump, or a debug port) taken after authentication would expose the previously entered PIN.

**A22-8** · HIGH · Device and Firmware
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.cpp:9`
**Description:** There is no rate limiting or brute-force protection on PIN entry attempts. The dialog has a 30-second inactivity timeout (`ACTIVITY_TIME = 30000`) that rejects the dialog if no key is pressed, but there is no count of incorrect PIN submissions and no lockout or delay after a failed attempt. The PIN space is at most 5 decimal digits (0–99999 = 100,000 possible values). An operator with physical access to the device can repeatedly open the PIN dialog (via the lock screen) and attempt different PINs at the rate limited only by the 200ms debounce in `OnDemandDialog` — the PinDialog itself has a 50ms debounce. With automated tapping, exhaustive search of the 5-digit PIN space is feasible.

### 6. Qt-Specific Security

**A22-9** · MEDIUM · Qt-Specific Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/pindialog.ui:505`
**Description:** The `QLineEdit` widget (`lineEdit`) in `pindialog.ui` has its `echoMode` set to `QLineEdit::PasswordEchoOnEdit`. This mode shows each character briefly as it is typed before replacing it with a masking character. The comment in `pindialog.cpp` (line 76-78) acknowledges that Helvetica does not contain Qt's password masking character and therefore a `QLabel` (`labelPin`) is used as a visual overlay of asterisks. However, the underlying `QLineEdit` still operates in `PasswordEchoOnEdit` mode — each new digit is briefly visible on screen as it is inserted before the label overlays it. The label overlay does not prevent the `QLineEdit` itself from briefly displaying the typed character, which may be captured by a camera or shoulder-surfing observer. The `echoMode` should be set to `QLineEdit::Password` (always masked) and the custom asterisk label retained for the font workaround.

**A22-10** · LOW · Qt-Specific Security
**File:** `/c/Projects/cig-audit/repos/mark3-pvd/ui/optionalcheckconfirmationdialog.cpp:28`
**Description:** The optional pre-op safety check confirmation dialog has a 5-second auto-reject timer (`m_timer->start(5000)`). When the timer fires, `reject()` is called, meaning the optional check is automatically skipped if the operator does not respond within 5 seconds. This timer applies to a safety-related prompt — "please confirm that you would like to do an optional pre-op safety check." If the intent is to encourage safety checks, defaulting to rejection on timeout works against that intent. If an attacker or inattentive operator is aware of the 5-second timeout, they can simply wait for the dialog to dismiss itself without pressing NO, potentially appearing compliant while the check is bypassed. This is a safety-process concern as well as a security concern.

---

## Summary Table

| Finding | Severity | Category | File |
|---------|----------|----------|------|
| A22-1 | LOW | Memory Safety | `pindialog.cpp:51` |
| A22-2 | LOW | Memory Safety | `pindialog.cpp:97` |
| A22-3 | HIGH | Communication Security | `dialog.cpp:546` |
| A22-4 | MEDIUM | Communication Security | `aescrypto.cpp:124` |
| A22-5 | MEDIUM | Input Handling | `pindialog.cpp:29` |
| A22-6 | MEDIUM | Input Handling | `pindialog.cpp:34` |
| A22-7 | HIGH | Device and Firmware | `pindialog.cpp:112` |
| A22-8 | HIGH | Device and Firmware | `pindialog.cpp:9` |
| A22-9 | MEDIUM | Qt-Specific Security | `pindialog.ui:505` |
| A22-10 | LOW | Qt-Specific Security | `optionalcheckconfirmationdialog.cpp:28` |
