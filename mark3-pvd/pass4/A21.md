# Pass 4 Agent A21 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `ui/informationdialog.h` + `ui/informationdialog.cpp`
- `ui/keyfilter.h` + `ui/keyfilter.cpp`
- `ui/languagedialog.h` + `ui/languagedialog.cpp`

---

## Reading Evidence

### `ui/informationdialog.h`

**Class:** `InformationDialog : public QDialog`

| Line | Member / Function |
|------|-------------------|
| 21 | `explicit InformationDialog(QWidget *parent = 0)` — constructor |
| 22 | `~InformationDialog()` — destructor |
| 23 | `void updateInformationScreen()` |
| 24 | `void setLux(int lux)` |
| 25 | `void setStatus(QByteArray IO, bool Rly1, bool Rly2, QByteArray can, const QByteArray &rssi, const QByteArray &moni, bool netStat, bool mdemStat, bool wifiStat, qint8 sat, qint32 lat, qint32 lon)` |
| 26 | `void setConfigParam()` |
| 27 | `void setBatteryStatus(bool avail, int state, int fault, quint16 voltage, qint16 current, quint16 temp, quint16 remainingCapacity)` |
| 28 | `void setExpModInfo(QByteArray mainVersion)` |
| 29 | `void setSuperMasterStatus()` |
| 30 | `void setVOR()` |
| 31 | `void setLastWiegand(quint64 id)` |
| 32 | `void languageChanged()` |
| 35 | `void showEvent(QShowEvent *)` — protected override |
| 36 | `void hideEvent(QHideEvent *)` — protected override |

**Private members:**
- `Ui::InformationDialog *ui` (line 39)
- `QMap<int, QString> m_chargeStatusMap` (line 40)
- `QMap<int, QString> m_chargeFaultMap` (line 41)
- `QTimer *m_updateConfigTmr` (line 42)

**Types / constants defined in implementation:**
- `#define UPDATE_CONFIG_TIMER_MS 5000` (informationdialog.cpp, line 9)

---

### `ui/informationdialog.cpp`

| Line | Function |
|------|----------|
| 11  | `InformationDialog::InformationDialog(QWidget *parent)` — constructor |
| 89  | `void InformationDialog::hideEvent(QHideEvent *)` |
| 94  | `void InformationDialog::showEvent(QShowEvent *)` |
| 101 | `InformationDialog::~InformationDialog()` |
| 106 | `void InformationDialog::setLux(int lux)` |
| 111 | `void InformationDialog::setStatus(QByteArray IO, bool Rly1, bool Rly2, QByteArray can, const QByteArray &rssi, const QByteArray &moni, bool netStat, bool modemStat, bool wifiStat, qint8 sat, qint32 lat, qint32 lon)` |
| 126 | `void InformationDialog::setBatteryStatus(bool avail, int state, int fault, quint16 voltage, qint16 current, quint16 temp, quint16 remainingCapacity)` |
| 137 | `void InformationDialog::setConfigParam()` |
| 195 | `void InformationDialog::setExpModInfo(QByteArray mainVersion)` |
| 200 | `void InformationDialog::setSuperMasterStatus()` |
| 220 | `void InformationDialog::setVOR()` |
| 228 | `void InformationDialog::setLastWiegand(quint64 id)` |
| 233 | `void InformationDialog::updateInformationScreen()` |
| 240 | `void InformationDialog::languageChanged()` |

---

### `ui/keyfilter.h`

**Class:** `KeyFilter : public QObject`

| Line | Member / Function |
|------|-------------------|
| 13 | `explicit KeyFilter(QObject *parent = nullptr)` — constructor |
| 13 | `static bool isPowerKeyPressed()` — static inline accessor |
| 16 | `signal: void showInfoDialog()` |
| 18 | `bool eventFilter(QObject *obj, QEvent *event)` — protected override |
| 21 | `static bool m_powerKeyPressed` — static private member |
| 22 | `QSet<int> m_pressedKeys` — private member |
| 24 | `QTimer *m_timer` — private member |
| 25 | `int m_leftKeyCount` |
| 26 | `int m_rightKeyCount` |
| 27 | `int m_upKeyCount` |
| 28 | `int m_downKeyCount` |
| 29 | `bool m_leftKeyPressed` |
| 30 | `bool m_rightKeyPressed` |
| 31 | `bool m_upKeyPressed` |
| 32 | `bool m_downKeyPressed` |
| 34 | `void resetKeyCount()` — private |
| 35 | `void incrementKeyCount(int key)` — private |
| 36 | `int getKeyCount(int key)` — private |
| 37 | `void resetKeyCounter(int key)` — private |
| 38 | `bool getPressState(int key)` — private |
| 39 | `void setPressState(int key, bool state)` — private |

---

### `ui/keyfilter.cpp`

| Line | Function |
|------|----------|
| 6   | `bool KeyFilter::m_powerKeyPressed = false` — static member definition |
| 8   | `KeyFilter::KeyFilter(QObject *parent)` — constructor |
| 20  | `bool KeyFilter::eventFilter(QObject *obj, QEvent *event)` |
| 66  | `void KeyFilter::resetKeyCount()` |
| 76  | `void KeyFilter::incrementKeyCount(int key)` |
| 101 | `int KeyFilter::getKeyCount(int key)` |
| 114 | `void KeyFilter::resetKeyCounter(int key)` |
| 126 | `void KeyFilter::setPressState(int key, bool state)` |
| 145 | `bool KeyFilter::getPressState(int key)` |

---

### `ui/languagedialog.h`

**Class:** `LanguageDialog : public QDialog`

| Line | Member / Function |
|------|-------------------|
| 15 | `explicit LanguageDialog(QWidget *parent = nullptr)` — constructor |
| 16 | `~LanguageDialog()` |
| 17 | `void languageChanged()` |
| 18 | `void startScreenTimeout()` |
| 21 | `signal: void sigLanguageChanged()` |
| 24 | `slot: void on_btnEnglish_clicked()` — private slot |
| 25 | `slot: void on_btnSpanish_clicked()` — private slot |
| 26 | `slot: void on_btnQuit_clicked()` — private slot |
| 29 | `void showEvent(QShowEvent *event = 0)` — protected override |
| 32 | `Ui::LanguageDialog *ui` — private member |
| 33 | `QTimer *m_timer` — private member |
| 34 | `bool debounce()` — private |
| 35 | `quint32 m_lastPress` — private member |

**Constants defined in implementation:**
- `#define NO_ACTIVITY_TIME (10000)` (languagedialog.cpp, line 10)

---

### `ui/languagedialog.cpp`

| Line | Function |
|------|----------|
| 12 | `LanguageDialog::LanguageDialog(QWidget *parent)` — constructor |
| 25 | `LanguageDialog::~LanguageDialog()` |
| 30 | `void LanguageDialog::on_btnEnglish_clicked()` |
| 42 | `void LanguageDialog::on_btnSpanish_clicked()` |
| 54 | `void LanguageDialog::on_btnQuit_clicked()` |
| 59 | `void LanguageDialog::showEvent(QShowEvent *event)` |
| 65 | `bool LanguageDialog::debounce()` |
| 76 | `void LanguageDialog::languageChanged()` |
| 84 | `void LanguageDialog::startScreenTimeout()` |

---

## Findings

---

**A21-1** · HIGH · Deprecated `qChecksum` signature — potential length mismatch and Qt 6 breakage

**Description:** `informationdialog.cpp` line 74 calls:
```cpp
quint16 checksum = qChecksum(string.toLatin1().constData(), string.size());
```
Two distinct problems exist here. First, `string` is a `QString`; `string.size()` returns the number of UTF-16 code units, not the number of Latin-1 bytes produced by `.toLatin1()`. For any version string containing only ASCII characters these numbers coincide, but the distinction is latent and would cause an over-read the moment a non-ASCII character appears. Second, the two-argument `qChecksum(const char*, uint)` overload was deprecated in Qt 5.9 and removed in Qt 6. The project `.pro` file contains `QT_DEPRECATED_WARNINGS`, meaning this call already triggers a compiler warning on Qt 5.9+.

**Fix:** Store the `QByteArray` in a named local, pass its own `.size()`, and use the Qt 5.9+ three-argument overload that accepts a `QChecksumsType` so the call compiles cleanly on both Qt 5 and Qt 6:
```cpp
QByteArray la = string.toLatin1();
quint16 checksum = qChecksum(la.constData(), static_cast<uint>(la.size()));
```

---

**A21-2** · MEDIUM · `setStatus` parameter name inconsistency between declaration and definition

**Description:** The header declaration at `informationdialog.h:25` names the modem-status parameter `mdemStat`, while the implementation at `informationdialog.cpp:111` names it `modemStat`. Although this does not affect compilation (parameter names in declarations are advisory), it is a maintenance hazard: readers of the header see an abbreviated name that does not match the implementation, and grep/cross-reference tools may miss usages.

**Fix:** Align the parameter name to the more descriptive form used in the implementation. Change `informationdialog.h:25` to use `modemStat` consistently.

---

**A21-3** · MEDIUM · Leaky abstraction — `setStatus` takes 12 positional arguments

**Description:** `InformationDialog::setStatus` at `informationdialog.h:25` / `informationdialog.cpp:111` accepts 12 positional arguments covering relay states, CSQ, network/modem/WiFi status, MONI, digital IO, CAN data, and GPS coordinates. This is far beyond the commonly accepted limit of 4–5 parameters and forces every call site to supply all 12 values in the correct order with no compiler protection against transposition of same-typed arguments (e.g., `bool Rly1, bool Rly2` followed by three more booleans). The coupling between the caller (which assembles all hardware status at once) and the dialog's display concerns is maximal.

**Fix:** Introduce a value-type status struct (e.g., `struct DeviceStatus`) that groups related fields. The `setStatus` call becomes `setStatus(const DeviceStatus &)`, callers populate the struct by name, and the dialog remains decoupled from the order of hardware fields.

---

**A21-4** · MEDIUM · Hardcoded hardware revision string with TODO comment

**Description:** `informationdialog.cpp:42` contains:
```cpp
// TODO: currently doesn't support
ui->labelHwVer->setText("EM-070-02-B");
```
The hardware version is a hardcoded literal with an unresolved TODO. Because this string is also used in the `qChecksum` calculation (lines 69–74) that generates the barcode on the System tab, deploying on hardware with a different PCB revision silently produces a wrong barcode without any runtime error.

**Fix:** Read the hardware version from a device file, configuration source, or compile-time define that reflects the actual deployed revision. At minimum, promote the string to a named constant and remove the stale TODO or file a tracked issue.

---

**A21-5** · MEDIUM · `languagedialog.h` — `showEvent` declares a non-standard default argument

**Description:** `languagedialog.h:29` declares:
```cpp
void showEvent(QShowEvent *event = 0);
```
The base class `QWidget::showEvent(QShowEvent *)` has no default argument. Providing a default argument on an override is both a style violation and potentially confusing: it implies `showEvent()` can be called with no argument, which is never done. The C++ standard permits this but most static analysers flag it as a defect.

**Fix:** Remove the `= 0` default from the override declaration:
```cpp
void showEvent(QShowEvent *event) override;
```
Add `override` while editing to make the override relationship explicit.

---

**A21-6** · MEDIUM · `languagedialog.h` — missing `#include <QTimer>` for member type

**Description:** `languagedialog.h:33` declares `QTimer *m_timer` but the header does not include `<QTimer>`. The code compiles only because `ui_languagedialog.h` or another transitively-included header happens to pull in `QTimer`. This is a fragile dependency on include order.

**Fix:** Add `#include <QTimer>` to `languagedialog.h` directly.

---

**A21-7** · LOW · `KeyFilter` constructor only initialises `m_leftKeyPressed`; three bool members left uninitialised

**Description:** `keyfilter.cpp:8–18` — the constructor initialiser list is:
```cpp
m_timer(new QTimer(this)),
m_leftKeyCount(0),
m_rightKeyCount(0),
m_upKeyCount(0),
m_downKeyCount(0),
m_leftKeyPressed(false)
```
The three members `m_rightKeyPressed`, `m_upKeyPressed`, and `m_downKeyPressed` (declared at `keyfilter.h:30–32`) are not listed. Because `KeyFilter` inherits from `QObject` (which does not zero-initialise its subclass members), these booleans have indeterminate values until the first call to `setPressState`. The `getPressState` function reads them before any initialisation if a key release event arrives before the first press of that key, producing undefined behaviour.

**Fix:** Add all three to the initialiser list:
```cpp
m_leftKeyPressed(false),
m_rightKeyPressed(false),
m_upKeyPressed(false),
m_downKeyPressed(false)
```

---

**A21-8** · LOW · Commented-out `qDebug` blocks left in production code

**Description:** `keyfilter.cpp` contains five commented-out debug lines:
- Line 129: `// qDebug() << "KeyFilter::Key_Left: State=" << state;`
- Line 132: `// qDebug() << "KeyFilter::Key_Up: State=" << state;` (mislabelled as `Key_Up` for the `Key_Right` branch)
- Line 135: `// qDebug() << "KeyFilter::Key_Up: State=" << state;`
- Line 138: `// qDebug() << "KeyFilter::Key_Down: State=" << state;`
- Line 141: `// qDebug() << "KeyFilter::others:" << key << " State=" << state;`

These add visual noise, and the mislabelled `Key_Up` comment on line 132 (inside the `Key_Right` branch) is actively misleading to anyone who re-enables debug logging.

**Fix:** Remove all commented-out debug lines. If conditional debug output is needed, use `qCDebug` with a named category controlled by `QLoggingCategory` so it can be enabled at runtime without code changes.

---

**A21-9** · LOW · Inconsistent naming convention — `InformationDialog` constructor uses `QWidget *parent = 0` instead of `nullptr`

**Description:** `informationdialog.h:21` declares:
```cpp
explicit InformationDialog(QWidget *parent = 0);
```
The rest of the codebase (`KeyFilter`, `LanguageDialog`) uses `nullptr`. Using `0` as a null pointer constant is legal C++ but deprecated style since C++11 and is flagged by `-Wzero-as-null-pointer-constant` on modern GCC/Clang.

**Fix:** Change to `QWidget *parent = nullptr` to be consistent with the other classes in this directory.

---

**A21-10** · LOW · `languagedialog.h` — `showEvent` default argument uses `0` instead of `nullptr`

**Description:** `languagedialog.h:29`:
```cpp
void showEvent(QShowEvent *event = 0);
```
This is the same style issue as A21-9 but compounded by the unnecessary default argument (see A21-5). Both problems should be resolved together.

**Fix:** Remove the default argument and use `nullptr` style if any default is ever warranted.

---

**A21-11** · LOW · `InformationDialog` parameter naming violates project convention — capitalised parameter names

**Description:** `setStatus` uses `bool Rly1, bool Rly2` (capitalised, abbreviated) and `QByteArray IO` (all caps) while the remainder of the codebase uses `lowerCamelCase` for parameters. This inconsistency makes the function signature stand out as having originated from a different style guide and increases the risk of future misreads.

**Fix:** Rename to `bool relay1, bool relay2, QByteArray ioState` (or equivalent lower-camel forms) in both header and implementation.

---

**A21-12** · LOW · `languagedialog.cpp` — file opened in `languageChanged()` but never closed on the success path

**Description:** `languagedialog.cpp:306–309`:
```cpp
QFile file("/sys/class/net/wlan0/address");
if (!file.open(QIODevice::ReadOnly)) {
    ui->lblMacAddress_2->setText(tr("na"));
}
```
The file is opened only to test whether the WiFi interface exists; on success the file is left open and the `QFile` destructor eventually closes it. This is not a resource leak per se (RAII closes it), but the intent is clearly only to check existence. Additionally, `setConfigParam()` (lines 164–169) correctly opens, reads, and closes the same file. This code in `languageChanged()` duplicates the existence check unnecessarily. If `languageChanged()` is called repeatedly (it is — on every `showEvent`), this opens and silently leaks the file descriptor for the lifetime of each `QFile` stack object.

**Fix:** Remove the duplicate file-open test from `languageChanged()`. The "na" fallback for the WiFi MAC address label is already handled adequately in `setConfigParam()`, which is called from both `showEvent()` and the periodic timer.

---

**A21-13** · INFO · `InformationDialog` stylesheet embedded as a string literal in constructor

**Description:** `informationdialog.cpp:20–36` defines a multi-line `QString styleSheet` directly in the constructor. While functional, embedding display styling in C++ source couples appearance to compiled code and makes it impossible to adjust the UI skin without recompiling.

**Fix:** Move the stylesheet to a Qt resource file (`.qss`) loaded at runtime via `QFile`, or define it in the `.ui` designer file where it can be reviewed visually.

---

**A21-14** · INFO · `KeyFilter` models per-key state as four parallel scalar fields rather than a map or array

**Description:** `keyfilter.h` declares eight separate member variables (`m_leftKeyCount`, `m_rightKeyCount`, `m_upKeyCount`, `m_downKeyCount`, `m_leftKeyPressed`, `m_rightKeyPressed`, `m_upKeyPressed`, `m_downKeyPressed`) and `keyfilter.cpp` replicates the same `if/else if` chain six times across `incrementKeyCount`, `getKeyCount`, `resetKeyCounter`, `getPressState`, and `setPressState`. This design violates DRY, contributed to the uninitialised-member bug (A21-7), and would require changes in eight places if a fifth key were added.

**Fix:** Replace the eight fields with `QMap<int, int> m_keyCounts` and `QMap<int, bool> m_keyPressed` (keyed by `Qt::Key`). The five helper methods collapse to two or three lines each, and initialisation is automatic.

---

## Summary Table

| ID | Severity | Category | File | Line(s) | Title |
|----|----------|----------|------|---------|-------|
| A21-1 | HIGH | Deprecated API / correctness | `ui/informationdialog.cpp` | 74 | `qChecksum` uses deprecated 2-arg overload with mismatched length |
| A21-2 | MEDIUM | Inconsistency | `ui/informationdialog.h` / `.cpp` | 25 / 111 | `setStatus` parameter name `mdemStat` vs `modemStat` |
| A21-3 | MEDIUM | Leaky abstraction | `ui/informationdialog.h` | 25 | `setStatus` has 12 positional parameters |
| A21-4 | MEDIUM | Dead / hardcoded data | `ui/informationdialog.cpp` | 42 | Hardcoded hardware revision with unresolved TODO |
| A21-5 | MEDIUM | Style / correctness | `ui/languagedialog.h` | 29 | `showEvent` override declares non-standard default argument |
| A21-6 | MEDIUM | Missing include | `ui/languagedialog.h` | 33 | `QTimer` used but not included in header |
| A21-7 | LOW | Uninitialised member | `ui/keyfilter.cpp` | 8–18 | Three `bool` press-state members not initialised in constructor |
| A21-8 | LOW | Commented-out code | `ui/keyfilter.cpp` | 129,132,135,138,141 | Five commented-out `qDebug` lines (one mislabelled) |
| A21-9 | LOW | Style | `ui/informationdialog.h` | 21 | `parent = 0` should be `parent = nullptr` |
| A21-10 | LOW | Style | `ui/languagedialog.h` | 29 | `event = 0` should use `nullptr` (see also A21-5) |
| A21-11 | LOW | Naming convention | `ui/informationdialog.h` / `.cpp` | 25 / 111 | Capitalised parameter names `Rly1`, `Rly2`, `IO` violate camelCase convention |
| A21-12 | LOW | Resource management | `ui/languagedialog.cpp` | 306–309 | File opened in `languageChanged()` only for existence check; duplicate of `setConfigParam()` logic |
| A21-13 | INFO | Maintainability | `ui/informationdialog.cpp` | 20–36 | Stylesheet embedded as string literal in constructor |
| A21-14 | INFO | Design / DRY | `ui/keyfilter.h` / `.cpp` | multiple | Eight parallel scalar fields instead of a keyed collection |
