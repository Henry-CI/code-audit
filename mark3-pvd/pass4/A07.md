# Pass 4 Agent A07 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `comm/bleinputhandler.h`
- `comm/bleinputhandler.cpp`
- `comm/canexpansion.h`
- `comm/canexpansion.cpp`

---

## Reading Evidence

### comm/bleinputhandler.h

**Class:** `BleInputHandler` (extends `QObject`)

**Enums / Types defined:**
| Name | Values |
|------|--------|
| `DigitalFormat` (public enum) | `SessionFormat`, `UsageFormat`, `OnDemandFormat` |
| `InputState` (private struct) | fields: `bool state`, `quint32 sessionOnTime`, `quint32 sessionOffTime`, `quint32 usageOnTime`, `quint32 usageOffTime`, `quint32 sessionRisings`, `quint32 usageRisings`, `quint64 clock` |

**Methods (all in `BleInputHandler`):**

| Method | Line | Visibility |
|--------|------|------------|
| `BleInputHandler(CanExpansion *canExpansion)` (constructor) | 20 | public |
| `updateIgnition(CIGCONF::PowerState state)` | 22 | public |
| `updateBleInput(CIGCONF::BleExpansionDI input, bool state)` | 23 | public |
| `changeBleState(bool connected)` | 24 | public |
| `updateIdleTimer()` | 26 | public |
| `digitalInputs(DigitalFormat format, bool autoReset)` | 28 | public |
| `idleTimeout()` | 31 | signal |
| `sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra)` | 32 | signal |
| `resetStates()` | 35 | private |
| `onTimerEvent()` | 36 | private |
| `sendSeenSafeReport(bool state)` | 37 | private |

**Member variables:**
- `m_canExpansion` (`CanExpansion *`)
- `m_timer` (`QTimer *`)
- `m_digInputModeTimer` (`QTimer *`)
- `m_ignition` (`InputState`)
- `m_bleInputs[4]` (`InputState`)
- `m_bypassReset` (`bool`)
- `m_bleConnected` (`bool`)
- `m_seenState` (`bool`)
- `m_lastSeenReport` (`quint64`)
- `m_seenSecond` (`bool`)
- `m_seenTimestamp` (`quint32`)

---

### comm/bleinputhandler.cpp

**Functions (all in `BleInputHandler`):**

| Function | Line |
|----------|------|
| `BleInputHandler(CanExpansion *canExpansion)` — constructor | 7 |
| `resetStates()` | 25 |
| `updateIgnition(CIGCONF::PowerState state)` | 40 |
| `onTimerEvent()` | 81 |
| `sendSeenSafeReport(bool state)` | 92 |
| `updateBleInput(CIGCONF::BleExpansionDI input, bool state)` | 115 |
| `changeBleState(bool connected)` | 178 |
| `updateIdleTimer()` | 201 |
| `digitalInputs(DigitalFormat format, bool autoReset)` | 257 |

---

### comm/canexpansion.h

**Class:** `CanExpansion` (extends `QObject`)

**Enums / Types defined:**
| Name | Description |
|------|-------------|
| `ShockEvent` (public struct) | fields: `quint32 timestamp`, `quint32 magnitude`, `quint64 driverId`, `quint8 satelliteCount`, `quint32 lastLongitude`, `quint32 lastLatitude`, `quint16 speed`, `quint32 sumOfDistance`, `quint16 course`, `quint32 longitude`, `quint32 latitude`, `quint32 distance`, `bool isIgnitionOn` |

**Methods:**

| Method | Line | Visibility |
|--------|------|------------|
| `CanExpansion(EM070::CanBus *canBus, EM070::PowerSupply *ps)` (constructor) | 42 | public |
| `setEnabled(bool enable)` | 44 | public |
| `deviceName() const` | 46 | public inline |
| `bleVersion() const` | 47 | public inline |
| `mainVersion() const` | 48 | public inline |
| `manufacture() const` | 49 | public inline |
| `modelNumber() const` | 50 | public inline |
| `relayOutput(CIGCONF::BleExpansionRelay relay) const` | 52 | public inline |
| `setRelayOutput(CIGCONF::BleExpansionRelay relay, bool state)` | 55 | public |
| `relayTimeout(CIGCONF::BleExpansionRelay relay) const` | 57 | public inline |
| `setRelayTimeout(CIGCONF::BleExpansionRelay relay, quint16 timeout_in_sec)` | 60 | public |
| `setCurrentTime(quint32 time)` | 62 | public |
| `digitalInput(CIGCONF::BleExpansionDI di) const` | 64 | public inline |
| `setShockThreshold(quint32 threshold)` | 66 | public |
| `setShockPeriod(quint32 period)` | 67 | public |
| `isShockQueueEmpty()` | 69 | public inline |
| `shockEvent()` | 70 | public inline |
| `generateShockMessage(bool force)` | 72 | public |
| `setGnssReceiver(EM070::GnssReceiver* gnss)` | 74 | public |
| `inputStateChanged(CIGCONF::BleExpansionDI input, bool state)` | 77 | signal |
| `shockOccurred()` | 78 | signal |
| `amberImpactOccurred()` | 79 | signal |
| `redImpactOccurred()` | 80 | signal |
| `accessible(bool yes)` | 81 | signal |
| `expModInfo(QByteArray mainVersion)` | 82 | signal |
| `inactiveNotification(bool inactive, quint32 secs)` | 83 | signal |
| `relayStateChanged(bool relay1, bool relay2)` | 84 | signal |
| `initialise()` | 87 | private |
| `updateBusConfig()` | 88 | private |
| `readCanFrame(quint32 id, const QByteArray &ba)` | 89 | private |
| `packetHandler()` | 90 | private |
| `writeFrame()` | 91 | private |
| `timeout()` | 92 | private |
| `sendPacket(uint16_t cmd, const QByteArray &ba)` | 94 | private |
| `initRelays()` | 96 | private |
| `clearShockEvent()` | 97 | private |
| `popShockEvent(const QByteArray &ba)` | 98 | private |

**Member variables:**
- `m_canBus` (`EM070::CanBus *`)
- `m_powerSupply` (`EM070::PowerSupply *`)
- `m_gnssReceiver` (`EM070::GnssReceiver *`)
- `m_timer` (`QTimer *`)
- `m_initTimer` (`QTimer *`)
- `m_rx` (`QByteArray`)
- `m_tx` (`QByteArray`)
- `m_active` (`bool`)
- `m_lastActive` (`bool`)
- `m_inactiveCount` (`quint32`)
- `m_deviceName` (`QByteArray`)
- `m_bleVersion` (`QByteArray`)
- `m_mainVersion` (`QByteArray`)
- `m_manufacture` (`QByteArray`)
- `m_modelNumber` (`QByteArray`)
- `m_digitalInput[4]` (`bool`) — **declared but never written in canexpansion.cpp**
- `m_outputRelay[2]` (`bool`)
- `m_outputRelayTimeout[2]` (`quint16`)
- `m_shockThreshold` (`quint32`)
- `m_shockPeriod` (`quint32`)
- `m_redImpactCounter` (`qint32`)
- `m_shockTimestamp` (`quint32`)
- `m_shockEvent1` (`ShockEvent`)
- `m_shockEvents` (`QQueue<ShockEvent>`)

**Constants defined (canexpansion.cpp, file-scope `#define`):**

| Macro | Value | Comment |
|-------|-------|---------|
| `CMD_DEVICE_NAME` | 1001 | |
| `CMD_BLE_FWVER` | 8 | |
| `CMD_MAIN_FWVER` | 10 | |
| `CMD_MFR_NAME` | 1002 | |
| `CMD_MODEL_NUMBER` | 1003 | |
| `CMD_RTC_TIME` | 26 | |
| `CMD_DIGIN_STATE0..3` | 31,35,39,43 | |
| `CMD_RELAY_RESET` | 48 | |
| `CMD_RELAY_STATE0/1` | 50,54 | |
| `CMD_RELAY_TIMEOUT0/1` | 52,56 | |
| `CMD_SHOCK_COUNT` | 75 | |
| `CMD_SHOCK_PEEK` | 78 | |
| `CMD_SHOCK_POP` | 80 | |
| `CMD_SHOCK_THRESHOLD` | 82 | |
| `CMD_SHOCK_PERIOD` | 84 | |
| `CMD_SHOCK_MAGMAX` | 86 | |
| `CMD_SHOCK_NOTIFY` | 1004 | |
| `UPDATE_DEFER` | 500 | |
| `MAX_BUFFER_SIZE` | 256 | |
| `MK3_ID` | 0x3C1 | |
| `SLIP_END/ESC/ESC_END/ESC_ESC` | 0xC0,0xDB,0xDC,0xDD | |
| `FROM_MK3_HEADER` | 0x01 | |
| `TO_MK3_HEADER` | 0x81 | |
| `CMD_WRITE_FLAG` | 0x8000 | |
| `REDIMPACT_SHOCKMSG_TIME` | 3 | |
| `REDIMPACT_COUNTER_OFF` | -1 | |
| `TIMER` | 2000 | |
| `INACTIVE_TIME` | 2 | |

---

## Findings

---

**A07-1** · HIGH · Dead member: `m_digitalInput[4]` declared in `CanExpansion` but never written

**Description:** `canexpansion.h` line 119 declares `bool m_digitalInput[4]` and line 64 exposes a `digitalInput()` accessor. However, `canexpansion.cpp` never writes to `m_digitalInput` — the digital-input state is emitted only via the `inputStateChanged` signal and is tracked inside `BleInputHandler`. The accessor therefore always returns the zero-initialised value (`false`). Any caller that uses `CanExpansion::digitalInput()` receives stale, permanently-false data. (Contrast with `bleexpansion.h/.cpp`, which maintains its own identical member and does write to it correctly.)

**Fix:** Either populate `m_digitalInput[index]` when `inputStateChanged` is emitted inside `packetHandler()`, or remove the member and the `digitalInput()` accessor from the public API and update any callers to use the signal instead.

---

**A07-2** · HIGH · Static local state in `readCanFrame` and `packetHandler` breaks re-entrancy and testability

**Description:**
- `readCanFrame()` (canexpansion.cpp line 130): `static bool esc = false;` persists across calls. If the CAN bus is reset or `CanExpansion` is destroyed and recreated, the escape-flag is never cleared, so the next SLIP stream may be decoded incorrectly.
- `packetHandler()` (canexpansion.cpp line 251–252): `static quint16 sm = 0; static quint16 shocks_read = 0;` are the sole state-machine registers for the init handshake and shock-drain loop. Because they are function-local statics they are shared across all instances and survive object destruction. In a single-instance embedded target this is unlikely to cause a runtime fault, but it is architecturally broken: unit tests cannot reset the state machine, and a second `CanExpansion` instance would corrupt the first's handshake.

**Fix:** Promote `esc`, `sm`, and `shocks_read` to private member variables of `CanExpansion` (initialised in the constructor). Add their reset to any `setEnabled(false)` / re-initialisation path.

---

**A07-3** · MEDIUM · Commented-out code left in production sources

**Description:**
- `canexpansion.h` line 118: `//quint32     m_shockMaxMagnitude;` — commented-out member declaration.
- `canexpansion.cpp` line 234: `//SerialLogger::log(QString("[%1 " + m_canBus->canBusDevice()->errorString() + "]\r\n").arg(m_canBus->canBusDevice()->framesToWrite()).toLatin1());` — entire debug-logging line inside `writeFrame()`.
- `canexpansion.cpp` line 123: `//if (m_busConfig.enabled)` — a guard expression replaced by `if (enabled)` on the very next line; the old version is still present.

**Fix:** Delete all three commented-out lines. If `m_shockMaxMagnitude` is genuinely unused it should be removed entirely; if it will be needed it should be tracked in a TODO/issue rather than left as dead markup in the header.

---

**A07-4** · MEDIUM · `qDebug()` statement left in production code

**Description:** `canexpansion.cpp` line 659:
```cpp
qDebug() << "EXPMOD Shock" << event.timestamp << event.magnitude;
```
This is inside `popShockEvent()`, which executes on every shock detection. `qDebug()` output is compiled in by default in release builds unless `QT_NO_DEBUG_OUTPUT` is explicitly defined, leaking internal telemetry data to any connected debug console and adding unnecessary overhead on the target hardware.

**Fix:** Remove the `qDebug()` line. The `SerialLogger::log()` call on the line immediately below provides sufficient structured diagnostic output through the controlled logging subsystem.

---

**A07-5** · MEDIUM · Mixed integer type for `sendPacket` command parameter (`uint16_t` vs `quint16`)

**Description:** The private declaration of `sendPacket` in `canexpansion.h` line 94 uses the raw C type `uint16_t`:
```cpp
void sendPacket(uint16_t cmd, const QByteArray &ba);
```
Every other integer in both files uses Qt's portable types (`quint16`, `quint32`, etc.). The rest of the codebase is consistent in using Qt types. This inconsistency is exacerbated by the fact that `sendPacket` is called with expressions such as `CMD_RELAY_STATE0 | CMD_WRITE_FLAG`, where `CMD_WRITE_FLAG` is defined as `0x8000` (an `int` macro), causing the result to be implicitly narrowed through a mixed-type OR before being passed.

**Fix:** Change the parameter type to `quint16` to match the rest of the file. If the OR-with-`CMD_WRITE_FLAG` pattern is intentional (setting the high bit to indicate a write), replace the raw `int` macro with a typed constant (`static const quint16 CMD_WRITE_FLAG = 0x8000;`) to make the narrowing explicit.

---

**A07-6** · MEDIUM · `updateBleInput` does not bounds-check the `input` index

**Description:** `bleinputhandler.cpp` line 117:
```cpp
int index = input - CIGCONF::BleExpDI1;
InputState &is = m_bleInputs[index];
```
`CIGCONF::BleExpansionDI` is an unscoped enum starting at `BleExpDI1 = 0`. If `input` is ever passed a value outside `[BleExpDI1, BleExpDI4]` (e.g., from a future enum extension or a programming error in a caller), `index` will be negative or >= 4 and the array access will be out-of-bounds with undefined behaviour. The same unchecked arithmetic appears in `canexpansion.h` line 64 (`digitalInput()`).

**Fix:** Add a bounds assertion or early-return guard:
```cpp
int index = input - CIGCONF::BleExpDI1;
if (index < 0 || index >= 4) return;
```
Alternatively use `Q_ASSERT` for debug builds.

---

**A07-7** · MEDIUM · Empty `switch` cases in `packetHandler` with no documentation

**Description:** `canexpansion.cpp` lines 330–465 contain nine `case` labels (`CMD_RELAY_RESET`, `CMD_RELAY_STATE0`, `CMD_RELAY_STATE1`, `CMD_RELAY_TIMEOUT0`, `CMD_RELAY_TIMEOUT1`, `CMD_RTC_TIME`, `CMD_SHOCK_THRESHOLD`, `CMD_SHOCK_PERIOD`, `CMD_SHOCK_MAGMAX`, `CMD_SHOCK_NOTIFY`) that have empty bodies with no comment. It is impossible to determine whether these are intentional no-ops (acknowledgement frames where no action is required), planned future work, or overlooked implementations. This ambiguity is a maintenance hazard.

**Fix:** Add a brief comment to each empty case explaining the intent, for example:
```cpp
case CMD_RTC_TIME:
    // Write-only; no response payload expected.
    break;
```

---

**A07-8** · LOW · Inconsistent `relayOutput` / `relayTimeout` accessor guard logic

**Description:** `canexpansion.h` lines 52–59:
```cpp
bool relayOutput(CIGCONF::BleExpansionRelay relay) const {
    return (relay == CIGCONF::BleExpRelay2 ? m_outputRelay[1] : m_outputRelay[0]);
}
quint16 relayTimeout(CIGCONF::BleExpansionRelay relay) const {
    return (relay == CIGCONF::BleExpRelay2 ? m_outputRelayTimeout[1] : m_outputRelayTimeout[0]);
}
```
Both accessors use a ternary where any value that is not `BleExpRelay2` silently maps to relay 1. An invalid relay enum value would return relay-1 data rather than triggering a diagnostic. This is the same structural problem as A07-6. The `BleExpansionRelay` enum has exactly two values so it is low severity today, but the silent-fallback pattern is fragile.

**Fix:** Replace the ternary with an explicit index calculation (`relay - CIGCONF::BleExpRelay1`) and add an assertion, or use a switch with a default that asserts/returns a sentinel.

---

**A07-9** · LOW · `updateIdleTimer()` is `public` but is an implementation detail

**Description:** `bleinputhandler.h` line 26: `updateIdleTimer()` is declared `public`. Inspecting the call sites, `updateIdleTimer()` is only called from `resetStates()` (an internal method) and indirectly from the constructor. It is exposed publicly with no documented reason. Callers outside the class that invoke it at the wrong time could corrupt the idle-timer state.

**Fix:** Move `updateIdleTimer()` to the `private` section unless there is a documented external caller that requires it.

---

**A07-10** · LOW · `bool on = (state == CIGCONF::NormalPowerState) ? true : false;` — redundant ternary

**Description:** `bleinputhandler.cpp` line 42:
```cpp
bool on = (state == CIGCONF::NormalPowerState) ? true : false;
```
The comparison expression already yields a `bool`. The `? true : false` suffix is redundant and a common style warning in static analysis tools.

**Fix:** Simplify to:
```cpp
bool on = (state == CIGCONF::NormalPowerState);
```

---

**A07-11** · LOW · Trailing whitespace and brace/formatting inconsistencies

**Description:**
- `canexpansion.cpp` line 232: `void CanExpansion::writeFrame()` — the opening brace is on the same line as the first variable declaration (`{   int len;`), which is unique in the file and inconsistent with every other function definition.
- `canexpansion.cpp` line 147: trailing whitespace after `packetHandler();` inside `readCanFrame`.
- `canexpansion.cpp` line 525: trailing whitespace after the closing brace of `initRelays()`.
- `bleinputhandler.cpp` line 142: trailing whitespace after `m_digInputModeTimer->start(...)`.
- `bleinputhandler.cpp` line 289: trailing whitespace before the blank line inside `digitalInputs()`.

These are minor but indicate the files have not been passed through a consistent formatter.

**Fix:** Run `clang-format` (or the project's chosen formatter) over both files and configure the CI pipeline to enforce formatting on commit.

---

**A07-12** · LOW · `QTimer` forward-declared in `canexpansion.h` but also `#include <QTimer>` present

**Description:** `canexpansion.h` line 19 contains a forward declaration `class QTimer;`, but line 11 already `#include <QTimer>`. The forward declaration is therefore redundant. (`bleinputhandler.h` has the same pattern: forward-declares `QTimer` at line 12 despite not including the header — that usage is correct as a forward declaration only, but should be verified against Qt's inclusion requirements for inline use.)

**Fix:** Remove the redundant `class QTimer;` forward declaration from `canexpansion.h` since the full header is already included. In `bleinputhandler.h` the forward declaration is appropriate (the type is only used as a pointer), so it should be retained.

---

**A07-13** · INFO · Magic number `500` used directly in `initialise()`

**Description:** `canexpansion.cpp` line 94: `m_timer->start(500);`. The constant `TIMER` is defined as `2000` on line 58, and `UPDATE_DEFER` as `500` on line 40. The poll interval for the main 2-second cycle is started with the literal `500` rather than a named constant. While `UPDATE_DEFER` happens to have the same value, using the literal hides the intent (is this 500 ms by coincidence or by design to match `UPDATE_DEFER`?).

**Fix:** If the 500 ms poll interval is intentional and independent of `UPDATE_DEFER`, define a separate named constant (e.g., `POLL_INTERVAL 500`). If it is the same concept, replace the literal with `UPDATE_DEFER`.

---

## Summary Table

| ID | Severity | Title |
|----|----------|-------|
| A07-1 | HIGH | Dead member `m_digitalInput[4]` declared but never written in `CanExpansion` |
| A07-2 | HIGH | Static local variables in `readCanFrame` / `packetHandler` break re-entrancy |
| A07-3 | MEDIUM | Commented-out code left in production sources (3 sites) |
| A07-4 | MEDIUM | `qDebug()` statement left in production `popShockEvent()` |
| A07-5 | MEDIUM | Mixed `uint16_t` / `quint16` type for `sendPacket` command parameter |
| A07-6 | MEDIUM | `updateBleInput` array index not bounds-checked |
| A07-7 | MEDIUM | Nine empty `switch` cases in `packetHandler` with no explanatory comment |
| A07-8 | LOW | Accessor ternary silently maps invalid relay enum to relay 1 |
| A07-9 | LOW | `updateIdleTimer()` is public but is an internal implementation detail |
| A07-10 | LOW | Redundant `? true : false` ternary in `updateIgnition` |
| A07-11 | LOW | Trailing whitespace and brace-placement inconsistencies |
| A07-12 | LOW | Redundant `class QTimer` forward declaration in `canexpansion.h` |
| A07-13 | INFO | Magic literal `500` in `initialise()` should be a named constant |
