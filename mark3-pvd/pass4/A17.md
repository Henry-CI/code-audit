# Pass 4 Agent A17 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Repo root:** `C:/Projects/cig-audit/repos/mark3-pvd`
**Files reviewed:**
- `platform/userport.h` + `platform/userport.cpp`
- `platform/wiegandrfid.h` + `platform/wiegandrfid.cpp`
- `platform/wifi.h` + `platform/wifi.cpp`

---

## Reading Evidence

### `platform/userport.h`

**Class:** `EM070::UserPort` (extends `QObject`)

| Method / Member | Line |
|---|---|
| `explicit UserPort(QObject *parent = nullptr)` | 15 |
| `void response(const QByteArray &ba)` | 16 |
| `void setBaudRate(QSerialPort::BaudRate baudRate)` | 18 |
| signal: `void cmdReceived(const QByteArray &ba)` | 21 |
| private: `void readData()` | 24 |
| private: `QSerialPort *m_serialPort` | 26 |
| private: `QByteArray m_receiver` | 27 |

**Types / constants defined:** none beyond class members.

**Includes:**
- `<QObject>` (line 4)
- `<QSerialPort>` (line 5)
- Forward declaration `class QSerialPort;` (line 7) — redundant after `#include <QSerialPort>`

---

### `platform/userport.cpp`

| Function | Line |
|---|---|
| `UserPort::UserPort(QObject *parent)` | 15 |
| `UserPort::readData()` | 54 |
| `UserPort::response(const QByteArray &ba)` | 78 |
| `UserPort::setBaudRate(QSerialPort::BaudRate baudRate)` | 88 |

**Macros / constants defined:**
- `FILE_USER_PORT "/dev/ttyS1"` (line 5)

**Conditional blocks:**
- `#if (TEST_MODE == 1)` at lines 7–11 and 44–51 and 83–85 — introduces `QSocketNotifier *notifier` as a file-scope (global) raw pointer.

---

### `platform/wiegandrfid.h`

**Class:** `EM070::WiegandRfid` (extends `QObject`)

| Method / Member | Line |
|---|---|
| `explicit WiegandRfid(QObject *parent = 0)` | 14 |
| `void setEnabled(bool enable)` | 15 |
| `static quint64 wiegandData(quint8 facility, quint32 number)` | 17 |
| signal: `void cardData(quint64 wiegand, quint16 facility, quint32 number, QByteArray &readerOutput)` | 20 |
| signal: `void error(const QString &text)` | 21 |
| private: `void activated()` | 24 |
| private: `QFile m_cardReadyFile` | 26 |
| private: `QSocketNotifier *m_notifier` | 27 |

**Types / constants defined:** none beyond class members.

---

### `platform/wiegandrfid.cpp`

| Function | Line |
|---|---|
| `WiegandRfid::WiegandRfid(QObject *parent)` | 11 |
| `WiegandRfid::activated()` | 24 |
| `WiegandRfid::setEnabled(bool enable)` | 106 |
| `WiegandRfid::wiegandData(quint8 facility, quint32 number)` | 111 |

**Macros / constants defined:**
- `FILE_CARD_READY "/sys/devices/platform/wiegand-gpio.0/card_ready"` (line 5)
- `FILE_CARD_DATA  "/sys/devices/platform/wiegand-gpio.0/card_data"` (line 6)
- `FILE_RAW_DATA   "/sys/devices/platform/wiegand-gpio.0/raw_data"` (line 7)

**Commented-out block:** 37-bit Wiegand decode, lines 83–96.

---

### `platform/wifi.h`

**Class:** `EM070::Wifi` (extends `QObject`)

| Method / Member | Line |
|---|---|
| `explicit Wifi(EM070::UserPort *userPort)` | 26 |
| `~Wifi() {}` | 27 |
| `void writeConf()` | 29 |
| `void restart()` | 30 |
| `bool status()` — inline, returns `m_status` | 32 |
| `bool startPositioning()` | 34 |
| `void parseResponse(const QByteArray &ba)` | 36 |
| `QList<CIGCONF::AccessPoint> accessPoints()` — inline | 38 |
| `void setCellularState(bool state)` | 40 |
| `void setPowerState(CIGCONF::PowerState state)` | 42 |
| signal: `void ethernetStateChanged(bool ready)` | 46 |
| signal: `void wifiReconnectionFailed()` | 47 |
| signal: `void wifiScanFinished(QList<CIGCONF::AccessPoint> list)` | 48 |
| private: `void attemptReconnectToWifi()` | 51 |
| private: `void checkStatus()` | 52 |
| private: `void scanAccessPoints()` | 53 |
| private: `void scanFinished(int exitCode, QProcess::ExitStatus exitStatus)` | 54 |
| private data members | 56–69 |

**Types / constants defined:** none beyond class members (uses imported `CIGCONF::AccessPoint`, `CIGCONF::PowerState`).

**Includes:**
- `"../app/cigconfigs.h"` (line 4)
- `<QObject>` (line 5)
- `<QByteArray>` (line 6)
- `<QList>` **(line 7 — first occurrence)**
- `<QProcess>` (line 8)
- `<QNetworkConfigurationManager>` (line 9)
- `<QTimer>` (line 10)
- `<QList>` **(line 11 — DUPLICATE)**
- Forward declaration `class QTimer;` (line 13) — redundant after `#include <QTimer>`

---

### `platform/wifi.cpp`

| Function | Line |
|---|---|
| `Wifi::Wifi(UserPort *userPort)` | 16 |
| `Wifi::writeConf()` | 46 |
| `Wifi::restart()` | 82 |
| `Wifi::checkStatus()` | 96 |
| `Wifi::setCellularState(bool state)` | 146 |
| `Wifi::attemptReconnectToWifi()` | 153 |
| `Wifi::startPositioning()` | 191 |
| `Wifi::parseResponse(const QByteArray &ba)` | 211 |
| `Wifi::scanAccessPoints()` | 250 |
| `Wifi::scanFinished(int exitCode, QProcess::ExitStatus exitStatus)` | 266 |
| `Wifi::setPowerState(CIGCONF::PowerState state)` | 297 |

**Macros / constants defined:**
- `SCAN_WATCHDOG (300*1000)` (line 13)
- `RECONNECT_TIMEOUT (210000)` (line 14)

**Commented-out blocks:**
- `cigconfigs.h` include, line 5
- Old SIGNAL/SLOT connect for `QProcess::finished`, line 35
- WiFi nmcli reconnection block, lines 174–188
- RSSI format guard in `parseResponse`, lines 229–231
- Debug output in `scanFinished`, lines 284–287
- Debug output in `parseResponse`, line 247

---

## Findings

---

**A17-1** · LOW · Duplicate `#include <QList>` in `wifi.h`
**Description:** `wifi.h` includes `<QList>` twice: once at line 7 and again at line 11. While include guards inside Qt headers make this harmless at compile time, it is a clear copy-paste error that adds noise for readers and can cause warnings with some static analysis tools.
**Fix:** Remove the duplicate `#include <QList>` at line 11 of `platform/wifi.h`.

---

**A17-2** · LOW · Redundant forward declarations after full includes
**Description:** `userport.h` line 7 forward-declares `class QSerialPort;` after already `#include <QSerialPort>`-ing the full header at line 5. Similarly, `wifi.h` line 13 forward-declares `class QTimer;` after already including `<QTimer>` at line 10. Forward declarations after full includes are dead text and can confuse readers about the intended dependency.
**Fix:** Remove `class QSerialPort;` from `platform/userport.h` line 7 and `class QTimer;` from `platform/wifi.h` line 13.

---

**A17-3** · LOW · Deprecated `parent = 0` default argument instead of `nullptr`
**Description:** `WiegandRfid`'s constructor in `wiegandrfid.h` line 14 uses `QObject *parent = 0` as a default argument. This is a pre-C++11 idiom; the rest of the codebase (e.g. `UserPort` at `userport.h` line 15) consistently uses `nullptr`. This inconsistency creates a minor style regression.
**Fix:** Change `explicit WiegandRfid(QObject *parent = 0)` to `explicit WiegandRfid(QObject *parent = nullptr)` in `platform/wiegandrfid.h` line 14.

---

**A17-4** · MEDIUM · `wifiReconnectionFailed` signal declared but never emitted — connected slot silently dead
**Description:** `wifi.h` line 47 declares the `wifiReconnectionFailed()` signal. `backgroundworker.cpp` line 2806 connects it to `m_modemPort->resetModem()`. However, the only `emit wifiReconnectionFailed()` call (inside `attemptReconnectToWifi()`) was commented out as part of the larger reconnection block at `wifi.cpp` line 179. As a result, modem reset on WiFi failure never occurs; the caller believes this recovery path is active when it is not.
**Fix:** Either implement the reconnection logic so that `emit wifiReconnectionFailed()` is reached, or remove the signal declaration, remove the `connect()` in `backgroundworker.cpp`, and document clearly that WiFi-failure-triggered modem reset is not yet implemented.

---

**A17-5** · MEDIUM · `wifiScanFinished` signal declared but never emitted — GPS positioning data never delivered
**Description:** `wifi.h` line 48 declares `wifiScanFinished(QList<CIGCONF::AccessPoint>)`. `backgroundworker.cpp` line 2807 connects it to `sendGmtpMessage(CIGCONF::GMTP_WIFIPOS)`. No `emit wifiScanFinished(...)` call exists anywhere in `wifi.cpp`. `scanFinished()` populates `m_accessPoints` but never fires this signal; the positioning system can never deliver a WiFi position fix.
**Fix:** Add `emit wifiScanFinished(m_accessPoints)` at the end of `Wifi::scanFinished()` (after the access-point list is fully populated) and after `parseResponse()` completes a scan cycle (the `ba.at(0) == '>'` branch in line 219).

---

**A17-6** · MEDIUM · `m_status` permanently `false` — `status()` accessor is useless
**Description:** `wifi.h` line 32 exposes `bool status() { return m_status; }`. `m_status` is initialised to `false` in the constructor (`wifi.cpp` line 19) and is never written again anywhere in the file. No code path sets it to `true`. Any caller relying on `status()` to know whether the WiFi subsystem is functional will always receive `false`. (Confirmed by grep: no `m_status = true` or `m_status = false` assignment exists beyond initialisation.)
**Fix:** Either remove `m_status` and `status()` if they serve no purpose, or wire `m_status` to be set `true` when `m_configurationManager` is successfully initialised and `false` on failure, mirroring the pattern used for `m_wifiStatus`.

---

**A17-7** · MEDIUM · Commented-out WiFi reconnection block leaves `attemptReconnectToWifi()` functionally empty
**Description:** `wifi.cpp` lines 174–188 contain a large commented-out block that was the core reconnection logic: starting `nmcli`, waiting for it to finish, and handling failure. What remains live in `attemptReconnectToWifi()` only kills the DHCP process and returns — there is no actual reconnection attempt. The function name strongly implies active remediation, but the body provides none. This is a leaky abstraction: callers (`checkStatus()`) believe reconnection was attempted.
**Fix:** Either restore the reconnection logic (replacing the deprecated `nmcli` path with a working alternative such as `wpa_cli reconnect` or direct `dhclient`), or rename the function to reflect its actual behaviour (e.g., `releaseDhcpLease()`) and update callers accordingly. Remove the dead comment block once the intent is resolved.

---

**A17-8** · MEDIUM · Commented-out 37-bit Wiegand decode leaves an unsupported card format with no error reporting
**Description:** `wiegandrfid.cpp` lines 83–96 contain a commented-out `if (bits == 37)` block for decoding HID 37-bit Wiegand cards. With the block disabled, 37-bit cards fall through to the `if (bits >= 26)` catch-all at line 98, which emits `cardData(wiegand, 0, 0, ba)` (facility=0, number=0) followed immediately by `emit error(ba)` at line 103. This means 37-bit HID cards are treated as decode failures rather than as an unsupported-but-known format, and the error message contains only raw binary data, not a useful diagnostic.
**Fix:** Either re-enable and fix the 37-bit decode path (the commented code contains a type mismatch: `facility` is `quint16` inside but the signal and `wiegandData()` accept `quint8`/`quint16` — verify the field widths and correct them), or add an explicit `bits == 37` branch that emits a descriptive `error()` string such as `"37-bit HID format not supported"` instead of raw card data. Remove the commented block.

---

**A17-9** · LOW · C-style casts in `wiegandrfid.cpp` Wiegand decode logic
**Description:** `wiegandrfid.cpp` lines 71–72 use C-style casts `(quint8)(w >> 16)` and `(quint16)w` to extract facility and card number from the 34-bit Wiegand word. C-style casts suppress all compiler warnings about truncation and are stylistically inconsistent with the rest of the Qt codebase which generally avoids them.
**Fix:** Replace with `static_cast<quint8>(w >> 16)` and `static_cast<quint16>(w)` to make the intended truncation explicit and compiler-visible.

---

**A17-10** · LOW · Test-mode global raw pointer `notifier` leaks into translation unit scope
**Description:** `userport.cpp` lines 9–10 declare `QSocketNotifier *notifier` as a file-scope global raw pointer guarded by `#if (TEST_MODE == 1)`. The pointer is assigned inside the constructor but is never deleted and is never wrapped in a smart pointer. Even in test mode, if the `UserPort` object is destroyed and recreated, the old notifier is orphaned. Additionally, a bare global pointer is unidiomatic in Qt code where `QObject` parented children are the norm.
**Fix:** Move `notifier` into the `UserPort` class as a `QSocketNotifier *m_testNotifier` member (still `#if TEST_MODE` guarded), constructed with `this` as parent so Qt's object tree handles its lifetime. Remove the global declaration.

---

**A17-11** · LOW · `wifi.h` includes `<QNetworkConfigurationManager>` — deprecated Qt Network Bearer API exposed in public header
**Description:** `QNetworkConfigurationManager` and `QNetworkConfiguration` are part of the Qt Network Bearer API that was deprecated in Qt 5.15 and removed in Qt 6. Including this header in the public `wifi.h` forces all consumers of `Wifi` to transitively depend on a deprecated API. The implementation detail (`m_configurationManager`) belongs in the `.cpp` file and should be forward-declared or hidden.
**Fix:** Forward-declare `QNetworkConfigurationManager` in `wifi.h` (or use a PIMPL), move `#include <QNetworkConfigurationManager>` and `#include <QNetworkConfiguration>` to `wifi.cpp` only. Longer term, migrate off `QNetworkConfigurationManager` to `QNetworkInformation` (Qt 6) or a direct kernel interface.

---

**A17-12** · LOW · `wifi.cpp` line 5 has a commented-out `#include "../app/cigconfigs.h"`
**Description:** `wifi.cpp` line 5 reads `//#include "../app/cigconfigs.h"`. This header is included transitively via `wifi.h` (which includes `"../app/cigconfigs.h"` at line 4), so the direct include was presumably removed when the header was added to `wifi.h`. The dead comment adds confusion about whether `cigconfigs.h` is required here.
**Fix:** Delete the commented-out include at `wifi.cpp` line 5.

---

**A17-13** · LOW · Commented-out old-style SIGNAL/SLOT connect left in `wifi.cpp`
**Description:** `wifi.cpp` line 35 contains a commented-out `connect(m_ps, SIGNAL(...), ...)` call. The modern `QOverload` form on the next line (line 36) is the intended and active connection. The dead comment creates confusion about which form is in use.
**Fix:** Delete `wifi.cpp` line 35.

---

**A17-14** · LOW · Inconsistent indentation in `wifi.cpp` `writeConf()` body
**Description:** Inside the `if`/`else` block of `writeConf()` (lines 65–74), the `if` branch uses consistent `\t`-indented `out <<` lines, but the `else` branch (lines 69–73) drops back to the enclosing indentation level for the `out <<` statements, making the block harder to read and diff.
**Fix:** Indent the `else` branch body to one level deeper than the `else` keyword, consistent with the `if` branch.

---

**A17-15** · LOW · `wifi.cpp` `checkStatus()` uses `BearerEthernet` to classify `wlan0` — semantic mismatch
**Description:** `wifi.cpp` line 118 checks `cfg.bearerType() == QNetworkConfiguration::BearerEthernet` to identify the wlan0 interface. WiFi connections have bearer type `BearerWLAN`, not `BearerEthernet`. This check may never match (or may match a wired interface by accident), meaning `wifiConnected` could remain `false` even when wlan0 is up. The `name().contains(wifiInterfaceName)` guard narrows the risk but does not compensate for the wrong bearer type.
**Fix:** Change the bearer type check to `QNetworkConfiguration::BearerWLAN`, or remove it and rely solely on `cfg.name().contains(wifiInterfaceName)` combined with `cfg.state() == QNetworkConfiguration::Active`.

---

**A17-16** · INFO · Multiple scattered `qDebug()` calls remain in production paths
**Description:** `wiegandrfid.cpp` lines 42, 60, 74, 99 and `wifi.cpp` lines 111, 158, 169, 256, 260, 268 emit `qDebug()` output unconditionally in production code paths (not behind `#ifdef QT_DEBUG` or `Q_LOGGING_CATEGORY`). On an embedded device this can flood the serial console or system journal. Some of the messages also include raw card data values (line 42: `ba`, line 60: `ba`) which could expose credential-adjacent information in logs.
**Fix:** Wrap debug prints in `Q_LOGGING_CATEGORY` / `qCDebug` with a named category so they can be disabled at runtime. At minimum, protect them with `#ifdef QT_DEBUG`. Remove or redact prints that include raw card data bytes.

---

## Summary Table

| Finding | Severity | Short Title | File(s) | Line(s) |
|---|---|---|---|---|
| A17-1 | LOW | Duplicate `#include <QList>` | `wifi.h` | 7, 11 |
| A17-2 | LOW | Redundant forward declarations after full includes | `userport.h`, `wifi.h` | 7; 13 |
| A17-3 | LOW | `parent = 0` instead of `nullptr` | `wiegandrfid.h` | 14 |
| A17-4 | MEDIUM | `wifiReconnectionFailed` signal never emitted — modem reset silently disabled | `wifi.h`, `wifi.cpp` | 47; 174–188 |
| A17-5 | MEDIUM | `wifiScanFinished` signal never emitted — positioning data never delivered | `wifi.h`, `wifi.cpp` | 48; 266–295 |
| A17-6 | MEDIUM | `m_status` permanently `false` — `status()` accessor always wrong | `wifi.h`, `wifi.cpp` | 32; 19 |
| A17-7 | MEDIUM | Commented-out reconnect block leaves `attemptReconnectToWifi()` functionally empty | `wifi.cpp` | 153–188 |
| A17-8 | MEDIUM | Commented-out 37-bit Wiegand decode causes 37-bit HID cards to fail silently | `wiegandrfid.cpp` | 83–96 |
| A17-9 | LOW | C-style casts in Wiegand 34-bit decode | `wiegandrfid.cpp` | 71–72 |
| A17-10 | LOW | Test-mode global raw pointer `notifier` leaks into TU scope | `userport.cpp` | 9–10, 45 |
| A17-11 | LOW | Deprecated `QNetworkConfigurationManager` in public header | `wifi.h` | 9, 58 |
| A17-12 | LOW | Commented-out `#include` in `wifi.cpp` | `wifi.cpp` | 5 |
| A17-13 | LOW | Dead old-style SIGNAL/SLOT connect comment | `wifi.cpp` | 35 |
| A17-14 | LOW | Inconsistent indentation in `writeConf()` else-branch | `wifi.cpp` | 69–73 |
| A17-15 | LOW | `BearerEthernet` used to classify `wlan0` — wrong bearer type | `wifi.cpp` | 118 |
| A17-16 | INFO | Unconditional `qDebug()` in production paths, some emit raw card data | `wiegandrfid.cpp`, `wifi.cpp` | multiple |
