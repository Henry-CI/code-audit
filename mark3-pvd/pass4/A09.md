# Pass 4 Agent A09 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Reviewer:** Pass 4 Agent A09
**Files reviewed:**
- `comm/ftpclient.h`
- `comm/ftpclient.cpp`
- `comm/gmtpchat.h`
- `comm/gmtpchat.cpp`

---

## Reading Evidence

### `comm/ftpclient.h`

**Class:** `FtpClient` (extends `QObject`)

**Public methods:**

| Line | Signature |
|------|-----------|
| 17 | `explicit FtpClient(BackgroundWorker *parent)` |
| 18 | `void download(const QUrl &url)` |
| 19 | `void startTransfer()` |
| 21 | `void writeQueue()` |
| 22 | `void readQueue()` |
| 24 | `void setPowerState(CIGCONF::PowerState state)` |

**Signals:**

| Line | Signature |
|------|-----------|
| 27 | `void fileUpdated(const QString &fileName)` |
| 28 | `void sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra)` |
| 29 | `void nextTransfer()` |

**Private methods:**

| Line | Signature |
|------|-----------|
| 32 | `void readData()` |
| 33 | `void downloadFinished()` |
| 34 | `void setReport(CIGCONF::FtpErrorCode errorCode)` |
| 35 | `void popQueue()` |

**Private members:**

| Line | Name | Type |
|------|------|------|
| 37 | `m_worker` | `BackgroundWorker *` |
| 38 | `m_manager` | `QNetworkAccessManager *` |
| 39 | `m_url` | `QUrl` |
| 40 | `m_file` | `QSaveFile` |
| 41 | `m_fileSize` | `quint32` |
| 43 | `m_transferInProgress` | `bool` |
| 45 | `m_queue` | `QQueue<QUrl>` |
| 46 | `m_retries` | `quint32` |
| 47 | `m_queueFile` | `bool` |
| 48 | `m_powerState` | `CIGCONF::PowerState` |

**Types / constants defined in `ftpclient.cpp`:**

| Line | Name | Value |
|------|------|-------|
| 14 | `MAX_FILE_SIZE` | `16 * 1024 * 1024` (16 MiB) |
| 15 | `FTP_QUEUE_FILE` | `"/home/ftpqueue.txt"` |
| 16 | `FTP_RETRIES` | `5` |

---

### `comm/gmtpchat.h`

**Class:** `GmtpChat` (extends `QObject`)

**Enums:**

| Name | Values |
|------|--------|
| `Priority` | `NormalPriority = 0`, `HighPriority = 1` (line 18) |
| `PduType` | `PduId = 1`, `PduData = 2`, `PduIdExt = 3`, `PduDataExt = 4`, `PduAck = 5` (line 19) |

**Public methods:**

| Line | Signature |
|------|-----------|
| 21 | `explicit GmtpChat(ModemChat *parent)` |
| 22 | `void setPowerState(CIGCONF::PowerState state)` |
| 23 | `void connectServer()` |
| 24 | `void sendMessage(const QByteArray &msgData, Priority priority = NormalPriority)` |
| 25 | `void sendAck(quint16 msgId)` |
| 26 | `void clearGMTPMsgQueue()` |
| 27 | `bool sleeping()` (inline) |
| 28 | `void setEthernetState(bool up)` (inline) |
| 29 | `bool acksRemaining()` (inline) |

**Signals:**

| Line | Signature |
|------|-----------|
| 32 | `void cmdReceived(const QByteArray &ba)` |
| 33 | `void socketStateChanged(bool state)` |
| 34 | `void allMessagesSent()` |
| 35 | `void allAcksSent()` |
| 36 | `void gmtpHotStartReconnect()` |
| 37 | `void disconnectSocket()` |

**Private methods:**

| Line | Signature |
|------|-----------|
| 40 | `void readToQueue()` |
| 41 | `void writeQueue(bool recent)` |
| 42 | `void onConnected()` |
| 43 | `void onDisconnected()` |
| 44 | `void reconnectServer()` |
| 45 | `void readSocket()` |
| 46 | `void writeSocket()` |
| 47 | `void bytesWritten(qint64 bytes)` |
| 49 | `QByteArray packedMessage(const QByteArray &msgData, PduType type = PduDataExt, quint16 ackId = 0)` |
| 50 | `void setOnIgnitionOffDisconnect(bool state)` |
| 51 | `void disconnectFromHost()` |

**Private members:**

| Line | Name | Type |
|------|------|------|
| 53 | `m_modemChat` | `ModemChat *` |
| 54 | `m_tcpSocket` | `QTcpSocket *` |
| 55 | `m_socketTimer` | `QTimer *` |
| 56 | `m_uploadTimer` | `QTimer *` |
| 57 | `m_ackTimer` | `QTimer *` |
| 58 | `m_powerState` | `CIGCONF::PowerState` |
| 60 | `m_serverIndex` | `int` |
| 61 | `m_gmtpFileIndexes` | `QList<quint32>` |
| 63 | `m_uploadMessages` | `QQueue<QByteArray>` |
| 64 | `m_recentMessages` | `QQueue<QByteArray>` |
| 65 | `m_ackMessages` | `QQueue<QByteArray>` |
| 67 | `m_sendingMessage` | `QByteArray` |
| 68 | `m_downloadMessage` | `QByteArray` |
| 70 | `m_msgId` | `quint16` |
| 71 | `m_ackId` | `quint16` |
| 72 | `m_retryCount` | `quint8` |
| 73 | `m_reconnectCount` | `quint8` |
| 74 | `m_idSent` | `bool` |
| 75 | `m_connect` | `bool` |
| 76 | `m_ethState` | `bool` |
| 77 | `m_onIgnitionOffDisconnect` | `bool` |
| 78 | `m_mutexConnectToHost` | `QMutex` |
| 79 | `m_mutexWriteSocket` | `QMutex` |
| 80 | `m_mutexDisconnectFromHost` | `QMutex` |

**Constants defined in `gmtpchat.cpp`:**

| Line | Name | Value |
|------|------|-------|
| 16 | `MAX_MESSAGE_CNT` | `1000` |
| 17 | `MAX_RETRIES` | `3` |
| 18 | `DEF_MSOCKET_TIMEOUT` | `10000` (ms) |
| 19 | `MAX_GMTP_RECONNECT_CNT` | `20` |

---

## Findings

---

**A09-1** · HIGH · `ByteArray::asprintf` re-uses invalidated `va_list`

**Description:** In `utils/bytearray.h` (used extensively in both files), `ByteArray::asprintf` calls `va_start`/`va_end`, then calls `vsprintf` with the same `ap` after `va_end` has already been called on it (the two-pass pattern is broken: `va_end` is called after `vsnprintf` but before `vsprintf`, making the second use of `ap` undefined behaviour per C11 7.16). Every `ByteArray::asprintf(...)` call in `ftpclient.cpp` (lines 71, 89, 96, 206, 208, 259, 275) and `gmtpchat.cpp` (lines 67, 201, 231, 352, 415, 457, 482, 498) is therefore producing undefined behaviour at runtime. This is a latent data-corruption bug that may silently truncate or garble log/GMTP messages.

**Fix:** In `ByteArray::asprintf`, call `va_start` a second time before the `vsprintf` call (add `va_start(ap, cformat)` before `vsprintf` and a matching `va_end(ap)` after it), or rewrite using `QByteArray::asprintf` (Qt 5.5+) which handles this correctly.

---

**A09-2** · HIGH · Large commented-out code blocks leave dead logic in `gmtpchat.cpp`

**Description:** Several substantial blocks of logic have been commented out but left in the source, creating noise and indicating unresolved design decisions:
- Lines 89–106: An entire `if/else` branch for `m_onIgnitionOffDisconnect` hot-start reconnect logic is commented out inside `connectServer()`. The surrounding braces and the `// }` closing markers remain, indicating this was originally a structural else-branch.
- Lines 187–191: The companion power-state guard in `onDisconnected()` is also commented out.
- Lines 136 in `reconnectServer()`: `//m_modemChat->detach();` — a replaced call left as a comment rather than removed.
- Line 97 in `connectServer()`: `//SerialLogger::log(...)` — a debug log line.
- Lines 267, 315, 328, 337 in `gmtpchat.cpp`: Multiple `SerialLogger::log` hex-dump calls commented out.

The `setOnIgnitionOffDisconnect` private method (lines 516–519) and the `m_onIgnitionOffDisconnect` member variable exist solely to support the commented-out logic. They are otherwise dead code.

**Fix:** Either restore the intended logic behind the comment-out and remove the guards, or delete the commented-out blocks, the `setOnIgnitionOffDisconnect` method, and the `m_onIgnitionOffDisconnect` member entirely. Prefer deletion — version control preserves history.

---

**A09-3** · MEDIUM · `writeQueue()` / `readQueue()` are public on `FtpClient` with no documented contract

**Description:** `FtpClient::writeQueue()` and `FtpClient::readQueue()` are declared `public` in the header (lines 21–22). Internally they manipulate the transfer queue and persistence file; calling them externally in the wrong order (e.g., `readQueue()` while a transfer is in progress) would corrupt `m_retries` and the queue state. There is no documented reason for these to be public — inspection of the codebase shows they are only called from within `FtpClient` itself (`startTransfer()` calls `readQueue()`; `setPowerState()` calls `writeQueue()`).

**Fix:** Demote both methods to `private`.

---

**A09-4** · MEDIUM · `FtpClient::startTransfer()` is public but is only ever called via the `nextTransfer` signal

**Description:** `startTransfer()` is declared `public` (line 19) and is connected to `nextTransfer` internally (constructor line 26). No external caller exists in the codebase. Calling it externally while `m_transferInProgress` is true is silently a no-op; calling it from a different thread would be a data race. The method should be private (or a private slot).

**Fix:** Declare `startTransfer()` as a `private` slot (add it under a `private slots:` section or use the `connect` with a lambda).

---

**A09-5** · MEDIUM · `PduType` enum exposed in `GmtpChat` public interface but belongs to internal wire protocol

**Description:** `GmtpChat::PduType` (`PduId`, `PduData`, `PduIdExt`, `PduDataExt`, `PduAck`) is a public enum (header line 19) that describes the GMTP wire-protocol PDU type field. It is used only internally by `packedMessage()` and `readSocket()`. Exposing it in the public interface leaks the wire-format details to callers and creates an unnecessary coupling point.

**Fix:** Move `PduType` to the private section of the class declaration, or forward-declare it in the `.cpp` file as a file-local enum.

---

**A09-6** · MEDIUM · Magic number `6` repeated throughout `gmtpchat.cpp` without a named constant

**Description:** The GMTP PDU header size (2 bytes type + 2 bytes msg ID + 2 bytes length = 6 bytes) appears as the bare integer `6` in at least seven locations: lines 333, 342, 349, 353, 372, 468, 469, 474, 475. There is no named constant such as `GMTP_HEADER_SIZE`. If the header layout ever changes, all sites must be found and updated manually.

**Fix:** Define `static constexpr int GMTP_HEADER_SIZE = 6;` (or a `#define`) and replace every literal `6` that refers to the PDU header with that constant.

---

**A09-7** · MEDIUM · `GmtpChat::sendAck()` is public but invokes internal protocol machinery

**Description:** `sendAck(quint16 msgId)` is a public method (header line 25). It constructs a `PduAck` PDU and queues it for transmission. Callers need to know server-assigned message IDs — a protocol-level detail — to use it correctly. Inspecting the codebase, `sendAck` is called only from `readSocket()` (line 347), which is itself private. The public exposure creates an unnecessary surface for misuse.

**Fix:** Demote `sendAck` to `private`. The ACK response is an implementation detail of the receive loop.

---

**A09-8** · MEDIUM · Double semicolon on `writeQueue` local variable declaration (`ftpclient.cpp` line 124)

**Description:** Line 124 reads `QFile file(FTP_QUEUE_FILE);;` — two consecutive semicolons. This is syntactically harmless (the second `;` is an empty statement) but is a style error that indicates copy-paste or editing slippage and may confuse static analysis tools.

**Fix:** Remove the duplicate semicolon.

---

**A09-9** · MEDIUM · `readSocket()` silently discards unknown PDU types one byte at a time

**Description:** In `gmtpchat.cpp` lines 371–373, when a received PDU type is neither `PduDataExt` nor `PduAck`, the code removes exactly one byte (`ba.remove(0,1)`) and retries. This is a framing-resync heuristic. No log message is emitted; no error counter is incremented. A corrupt or unexpected PDU type will cause the loop to spin silently, consuming the buffer byte-by-byte. This masks protocol errors and makes field diagnosis very difficult.

**Fix:** Log a warning (at least at `SerialLogger` level) when an unexpected type is encountered, and consider recording a metric or emitting a diagnostic signal. If the protocol guarantees well-formed frames, consider aborting and reconnecting instead.

---

**A09-10** · LOW · `m_serverIndex` typed as `int` while compared against `GMTP_SERVER_CNT` (unsigned)

**Description:** `m_serverIndex` is declared as `int` (header line 60), but it is used in an unsigned comparison against `GMTP_SERVER_CNT` (value 3) at `gmtpchat.cpp` line 129 (`if (++m_serverIndex >= GMTP_SERVER_CNT)`). A signed/unsigned comparison warning will be generated by compilers with `-Wsign-compare`. While it cannot go negative in practice, the type mismatch is inconsistent with the surrounding `quint8`/`quint16` usage.

**Fix:** Change `m_serverIndex` to `int` with an explicit `static_cast<int>(GMTP_SERVER_CNT)` comparison, or change it to `quint8` / `quint32` to match the unsigned context.

---

**A09-11** · LOW · Inline method bodies in `gmtpchat.h` mix logic with class declaration

**Description:** Three public methods are defined inline in the header (lines 27–29): `sleeping()`, `setEthernetState(bool)`, and `acksRemaining()`. While `sleeping()` and `acksRemaining()` are trivial getters, `setEthernetState` contains a side-effect (emitting `disconnectSocket()`) with a guarded branch. Inline logic in headers makes the interface harder to read and can surprise callers who do not expect a signal emission from a setter.

**Fix:** Move `setEthernetState` to the `.cpp` file. Keep the two pure getters inline only if consistency with the rest of the codebase demands it.

---

**A09-12** · LOW · `using namespace CIGCONF` at file scope in `gmtpchat.cpp`

**Description:** Line 20 of `gmtpchat.cpp` declares `using namespace CIGCONF;` at file scope. This pulls every name from that namespace into the translation unit, increasing the risk of accidental name shadowing or collisions as the namespace grows. The remainder of the codebase (including `ftpclient.cpp`) uses the fully qualified `CIGCONF::` prefix consistently.

**Fix:** Remove the `using namespace CIGCONF;` directive and qualify all references with `CIGCONF::`, consistent with the rest of the codebase.

---

**A09-13** · LOW · Commented-out code in `ftpclient.cpp` lines 38–39

**Description:** Inside `FtpClient::download()`, lines 38–39 contain:
```cpp
//setReport(CIGCONF::FtpGenericError);
```
This commented-out call was presumably the original behaviour when the network is not available: report an error immediately. The code was silently removed, leaving only a `return` with no notification. The comment has no associated ticket reference or explanation.

**Fix:** Either restore the `setReport` call with appropriate justification, or delete the comment. Add a code comment explaining why no error is reported when the network is down (i.e., the URL is queued and will retry later).

---

**A09-14** · LOW · `reconnectCount` overflow silently wraps

**Description:** `m_reconnectCount` is `quint8` (max 255, header line 73). In `reconnectServer()` (line 134), the check is `if (m_reconnectCount > MAX_GMTP_RECONNECT_CNT)` (20). After triggering, it resets to 0 (line 135) then immediately increments to 1 (line 140), so the logic works today. However, if the reset were removed or the check changed, `quint8` wraps at 256. Using `quint8` for a counter compared against an `int` constant also generates a compiler sign/size warning. Additionally `m_reconnectCount` is initialised to `1` in the constructor (not `0`), which means the very first connection attempt already counts as reconnect attempt #1, which is misleading.

**Fix:** Initialise `m_reconnectCount` to `0`. Consider using `quint32` or `int` to avoid overflow-related surprises.

---

**A09-15** · LOW · `FtpClient::downloadFinished()` line 259 — GMTP message key mismatch

**Description:** At line 259, the "no more retries" GMTP monitoring message is keyed as `"FTPF_DL_NO_MORE_RETRIES"` but the accompanying log message at line 258 says `"File transfer failed ... no more retries"`. However, this branch is reached only when `m_retries < FTP_RETRIES` (i.e., there *are* retries remaining — it is the retry-in-progress path). The GMTP key name `FTPF_DL_NO_MORE_RETRIES` is semantically incorrect for this branch; that key is used when retries are exhausted (which is the branch at line 253–256 that uses no such key). The misleading constant name will confuse server-side log analysis.

**Fix:** Rename the monitoring message key to `FTPF_DL_RETRY` or similar to accurately describe the retry-in-progress case.

---

**A09-16** · INFO · Timer interval constants are bare integer literals in constructor

**Description:** In `GmtpChat`'s constructor (`gmtpchat.cpp` lines 41–43), three timers are assigned intervals: `5000` ms (socket timer), `1000` ms (upload timer), `10000` ms (ACK timer). Only the ACK timer value is captured in the named constant `DEF_MSOCKET_TIMEOUT` (which equals `10000` — but this constant is used in `reconnectServer()` / `connectServer()` for the socket reconnect timer, not the ACK timer). The `5000` and `1000` values are truly bare literals with no named constant.

**Fix:** Introduce named constants (e.g., `GMTP_SOCKET_TIMEOUT_MS = 5000`, `GMTP_UPLOAD_INTERVAL_MS = 1000`) and use them in place of the literals.

---

**A09-17** · INFO · `GmtpChat::signal gmtpHotStartReconnect()` is declared but never emitted

**Description:** The signal `gmtpHotStartReconnect()` (header line 36) is never emitted anywhere in the codebase — the only location that would emit it is inside the commented-out block at `gmtpchat.cpp` lines 91–93. The signal declaration is dead code that cannot be used until the hot-start logic is restored.

**Fix:** Either restore the hot-start reconnect logic or remove the signal declaration.

---

## Summary Table

| ID | Severity | Title |
|----|----------|-------|
| A09-1 | HIGH | `ByteArray::asprintf` re-uses invalidated `va_list` (UB) |
| A09-2 | HIGH | Large commented-out code blocks with dead `setOnIgnitionOffDisconnect` |
| A09-3 | MEDIUM | `writeQueue()`/`readQueue()` unnecessarily public on `FtpClient` |
| A09-4 | MEDIUM | `FtpClient::startTransfer()` unnecessarily public |
| A09-5 | MEDIUM | `PduType` wire-protocol enum exposed in public interface |
| A09-6 | MEDIUM | Magic number `6` (PDU header size) repeated without named constant |
| A09-7 | MEDIUM | `sendAck()` unnecessarily public; leaks protocol details |
| A09-8 | MEDIUM | Double semicolon at `ftpclient.cpp` line 124 |
| A09-9 | MEDIUM | Silent byte-by-byte resync on unknown PDU type in `readSocket()` |
| A09-10 | LOW | `m_serverIndex` signed/unsigned mismatch with `GMTP_SERVER_CNT` |
| A09-11 | LOW | Inline side-effect method `setEthernetState` in header |
| A09-12 | LOW | `using namespace CIGCONF` at file scope in `gmtpchat.cpp` |
| A09-13 | LOW | Commented-out `setReport` call in `FtpClient::download()` |
| A09-14 | LOW | `m_reconnectCount` initialised to 1, `quint8` overflow risk |
| A09-15 | LOW | GMTP monitoring key `FTPF_DL_NO_MORE_RETRIES` used on retry-in-progress path |
| A09-16 | INFO | Bare timer interval literals in `GmtpChat` constructor |
| A09-17 | INFO | Signal `gmtpHotStartReconnect()` declared but never emitted |
