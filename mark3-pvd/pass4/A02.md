# Pass 4 Agent A02 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:** `mk3.pro`, `mk3-test.pro`

---

## Reading Evidence

### mk3.pro

**Purpose:** Main Qt application project file for the FleetFocus production build. Controls what source, header, UI, and resource files are compiled into the `FleetFocus` binary.

| Setting | Line(s) | Value |
|---|---|---|
| `DEFINES += "TEST_MODE=0"` | 6 | Disables test mode for production build |
| `QT` modules | 8 | `core gui serialport serialbus bluetooth network` |
| `QT += widgets` (conditional) | 10 | Added when Qt major version > 4 |
| `linux:` block — `INCLUDEPATH` | 13–14 | `../sdk/kernel_include`, `../sdk/3rd/include` |
| `linux:` block — `LIBS` | 15 | `-L../sdk/3rd/lib` |
| `RCC_DIR` | 18 | `tmp/rcc` |
| `MOC_DIR` | 19 | `tmp/moc` |
| `UI_DIR` | 20 | `tmp/ui` |
| `OBJECTS_DIR` | 21 | `tmp/obj` |
| `TARGET` | 23 | `FleetFocus` |
| `TEMPLATE` | 24 | `app` |
| `DEFINES += QT_DEPRECATED_WARNINGS` | 30 | Enables deprecation warnings |
| `SOURCES` | 38–96 | 57 source files |
| `HEADERS` | 98–157 | 59 header entries (includes one duplicate) |
| `FORMS` | 160–184 | 23 UI form files |
| `RESOURCES` | 186–187 | `mk3.qrc` |
| `TRANSLATIONS` | 189 | `lang_es_ES.ts` |
| `DISTFILES` | 191–192 | `netcfg.json` |

**Commented-out define (line 35):**
```
#DEFINES += QT_DISABLE_DEPRECATED_BEFORE=0x060000
```

**Defines:**
- `TEST_MODE=0` (line 6)
- `QT_DEPRECATED_WARNINGS` (line 30)

---

### mk3-test.pro

**Purpose:** Qt test project file for the FleetFocus unit test build. Mirrors the production project but adds the `testlib` Qt module, the `UNIT_TEST` define, and four test source/header file pairs from `test/`.

| Setting | Line(s) | Value |
|---|---|---|
| `DEFINES += "TEST_MODE=0"` | 6 | Same as production — test mode disabled at macro level |
| `DEFINES += UNIT_TEST` | 7 | Enables unit-test code paths |
| `QT` modules | 9 | `core gui serialport serialbus bluetooth network testlib` |
| `QT += widgets` (conditional) | 11 | Added when Qt major version > 4 |
| `linux:` block — `INCLUDEPATH` | 13–14 | `../sdk/kernel_include`, `../sdk/3rd/include` |
| `linux:` block — `LIBS` | 15 | `-L../sdk/3rd/lib` |
| `RCC_DIR` | 19 | `tmp/rcc` |
| `MOC_DIR` | 20 | `tmp/moc` |
| `UI_DIR` | 21 | `tmp/ui` |
| `OBJECTS_DIR` | 22 | `tmp/obj` |
| `TARGET` | 24 | `FleetFocus` |
| `TEMPLATE` | 25 | `app` |
| `DEFINES += QT_DEPRECATED_WARNINGS` | 31 | Enables deprecation warnings |
| `SOURCES` | 39–100 | 61 source files (57 production + 4 test) |
| `HEADERS` | 102–165 | 63 header entries (59 production entries + 4 test, includes one duplicate) |
| `FORMS` | 168–192 | 23 UI form files (identical to production) |
| `RESOURCES` | 194–195 | `mk3.qrc` |
| `TRANSLATIONS` | 197 | `lang_es_ES.ts` |
| `DISTFILES` | 199–200 | `netcfg.json` |

**Commented-out define (line 36):**
```
#DEFINES += QT_DISABLE_DEPRECATED_BEFORE=0x060000
```

**Defines:**
- `TEST_MODE=0` (line 6)
- `UNIT_TEST` (line 7)
- `QT_DEPRECATED_WARNINGS` (line 31)

**Test-specific sources/headers (lines 40–43 / 103–106):**
- `test/test_ota.cpp` / `test/test_ota.h`
- `test/test_dialog.cpp` / `test/test_dialog.h`
- `test/test_backgroundworker.cpp` / `test/test_backgroundworker.h`
- `test/test_canbus.cpp` / `test/test_canbus.h`

---

## Findings

**A02-1** · MEDIUM · Duplicate HEADERS entry: `utils/logger.h` in both project files

**Description:** `utils/logger.h` appears twice in the `HEADERS` list in both `mk3.pro` (lines 112 and 122) and `mk3-test.pro` (lines 120 and 130). While qmake silently ignores duplicates and this does not cause a build failure, it indicates the file lists were assembled by successive concatenation rather than managed as a whole. It may cause redundant MOC processing depending on the Qt version and tool.

**Fix:** Remove the second occurrence of `utils/logger.h` from the `HEADERS` block in both `mk3.pro` and `mk3-test.pro`.

---

**A02-2** · MEDIUM · Hardcoded relative SDK path outside the repository tree

**Description:** Both project files include a `linux:` block (lines 12–16 in `mk3.pro`; lines 13–17 in `mk3-test.pro`) that adds `../sdk/kernel_include` and `../sdk/3rd/include` to `INCLUDEPATH` and `../sdk/3rd/lib` to `LIBS`. The path `../sdk/` is a sibling directory of the repository root that does not exist in the audited checkout (confirmed absent from `C:/Projects/cig-audit/repos/`). This creates an invisible build dependency on an undocumented directory layout on the developer's machine. Any developer or CI system that clones only this repository will silently get missing-include errors on Linux builds, potentially masking header resolution problems.

**Fix:** Document the required SDK checkout location in a `README` or `BUILD.md`. Consider using a qmake variable (e.g. `SDK_ROOT`) that can be overridden on the command line (`qmake SDK_ROOT=/path/to/sdk`), or use a `.prf` feature file so the dependency is explicit and version-controlled.

---

**A02-3** · MEDIUM · Test project TARGET name collides with production TARGET

**Description:** Both `mk3.pro` and `mk3-test.pro` set `TARGET = FleetFocus` (line 23 / line 24 respectively). If both projects are built in the same shadow-build directory, the test binary will overwrite the production binary without warning. In a CI pipeline that builds both projects this can silently ship a test binary to the deployment stage.

**Fix:** Set `TARGET = FleetFocusTest` (or similar) in `mk3-test.pro` to produce a distinctly named binary.

---

**A02-4** · LOW · `TEST_MODE=0` define is misleading in the test project

**Description:** `mk3-test.pro` defines `TEST_MODE=0` on line 6, identical to the production project, while simultaneously defining `UNIT_TEST` on line 7. If `TEST_MODE` is intended to gate test-only code paths (distinct from `UNIT_TEST`), the value `0` in the test project is contradictory. If `TEST_MODE` is not used for this purpose, carrying it into the test project with the same value adds confusion about what distinguishes the two build configurations at the macro level.

**Fix:** Either remove `TEST_MODE=0` from `mk3-test.pro` if it is irrelevant to the test build, or set it to `1` if it is supposed to activate test-specific code paths. Add a comment explaining the intended distinction between `TEST_MODE` and `UNIT_TEST`.

---

**A02-5** · LOW · Commented-out `QT_DISABLE_DEPRECATED_BEFORE` define is boilerplate noise

**Description:** Both files carry the QtCreator-generated comment block (lines 33–35 in `mk3.pro`; lines 33–36 in `mk3-test.pro`) with a commented-out `#DEFINES += QT_DISABLE_DEPRECATED_BEFORE=0x060000`. This is copy-paste boilerplate from project creation in 2018 and has never been activated. Combined with the active `QT_DEPRECATED_WARNINGS` define, the project emits warnings for deprecated APIs but does not enforce that deprecated APIs are absent. In a codebase targeting embedded Linux hardware this means deprecation warnings can accumulate unnoticed.

**Fix:** Either remove the comment block entirely to reduce noise, or enable `QT_DISABLE_DEPRECATED_BEFORE` for the Qt version in use to make the build fail on deprecated API usage. At minimum, document explicitly why it remains disabled.

---

**A02-6** · LOW · Inconsistent indentation in SOURCES block between the two project files

**Description:** In `mk3.pro`, the first entry in `SOURCES` uses 8-space indentation (`        main.cpp`, line 39), while all subsequent entries use 4-space indentation (e.g. `    mytranslator.cpp`, line 40). This same asymmetry is replicated in `mk3-test.pro`. The inconsistency suggests `main.cpp` was the original auto-generated entry and all later files were appended with a different editor setting. This is a cosmetic issue but indicates the project files are not reviewed as part of code review.

**Fix:** Normalise all SOURCES entries to 4-space indentation. The corrected first line should read `    main.cpp \`.

---

**A02-7** · LOW · `OBJECTS_DIR`, `MOC_DIR`, `RCC_DIR`, `UI_DIR` share the same `tmp/` prefix with no platform conditioning

**Description:** Both project files write intermediate files to `tmp/rcc`, `tmp/moc`, `tmp/ui`, and `tmp/obj` (lines 18–21 / 19–22). Because both projects share the same relative path and the production and test binaries use the same `TARGET` name, a `make clean` in a shared shadow build can remove intermediate files from both builds simultaneously. On Windows this path is relative to the `.pro` file location, meaning parallel builds of the two projects will collide if invoked from the same directory.

**Fix:** Use distinct subdirectories per project, for example `tmp_test/` in `mk3-test.pro`, or rely on Qt's shadow build mechanism and remove the explicit `*_DIR` overrides.

---

**A02-8** · INFO · `FleetIQ360App_5.2.2F.h` present in `test/` but not referenced in either project file

**Description:** The file `test/FleetIQ360App_5.2.2F.h` exists on disk inside the `test/` directory but is not listed in `HEADERS` or `SOURCES` in either `mk3.pro` or `mk3-test.pro`. This suggests it may be a leftover artefact from a previous release or an accidentally committed file. It is not a build defect but it is dead weight in the repository.

**Fix:** Determine whether `test/FleetIQ360App_5.2.2F.h` is still needed. If not, remove it from the repository to keep the `test/` directory clean.

---

**A02-9** · INFO · Style inconsistency: section ordering differs between the two files

**Description:** Both files follow the same overall structure (DEFINES, QT, platform block, build dirs, TARGET/TEMPLATE, SOURCES, HEADERS, FORMS, RESOURCES, TRANSLATIONS, DISTFILES). However, `mk3-test.pro` places `DEFINES += UNIT_TEST` (line 7) before the `QT` assignment rather than grouping all DEFINES together or placing them after QT as done in `mk3.pro`. This minor ordering inconsistency makes it harder to diff the two files and to confirm they are otherwise identical.

**Fix:** Group `DEFINES += UNIT_TEST` together with `DEFINES += "TEST_MODE=0"` and `DEFINES += QT_DEPRECATED_WARNINGS` in a single DEFINES section for clarity.

---

## Summary Table

| ID | Severity | Title |
|---|---|---|
| A02-1 | MEDIUM | Duplicate `utils/logger.h` entry in HEADERS in both project files |
| A02-2 | MEDIUM | Hardcoded relative SDK path (`../sdk/`) outside repository tree |
| A02-3 | MEDIUM | Test project TARGET collides with production TARGET (`FleetFocus`) |
| A02-4 | LOW | `TEST_MODE=0` in test project is contradictory / misleading |
| A02-5 | LOW | Commented-out `QT_DISABLE_DEPRECATED_BEFORE` boilerplate in both files |
| A02-6 | LOW | Inconsistent indentation on first SOURCES entry in both files |
| A02-7 | LOW | Shared `tmp/` intermediate directories cause collision between the two builds |
| A02-8 | INFO | `test/FleetIQ360App_5.2.2F.h` exists on disk but is unreferenced in any project file |
| A02-9 | INFO | Minor section-ordering inconsistency between `mk3.pro` and `mk3-test.pro` |
