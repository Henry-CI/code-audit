# Pass 4 Agent A01 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Repo root:** C:/Projects/cig-audit/repos/mark3-pvd
**Assigned files:** `run_tests`, `netcfg.json`, `.gitignore`

---

## Reading Evidence

### `run_tests`

**File purpose:** A POSIX shell script that runs the compiled test binary `FleetFocus` and post-processes its output by colourising lines based on their content (PASS, FAIL, DEBUG, WARN).

**Functions/methods:** None defined. The script is a single pipeline with no functions.

**Constants defined:** None. ANSI escape codes are embedded as string literals inline in the `awk` program.

**Types/errors defined:** None.

**Full content (9 lines):**

```sh
#!/bin/sh
./FleetFocus | awk '
    /PASS/ {print "\033[32m" $0 "\033[0m"}    # Green for PASS
    /FAIL/ {print "\033[31m" $0 "\033[0m"}    # Red for FAIL
    /DEBUG/ {print $0}                         # Leave debug as-is (yellow from handler)
    /WARN/ {print $0}                          # Leave warn as-is (magenta from handler)
    !/PASS|FAIL|DEBUG|WARN/ {print $0}        # Other lines unchanged
'
```

Line 1: shebang `#!/bin/sh`
Line 2–8: Single pipeline — `./FleetFocus` piped into an inline `awk` program.

---

### `netcfg.json`

**File purpose:** A JSON configuration file providing default Wi-Fi provisioning credentials (SSID and password). The file is embedded in the Qt resource bundle (`mk3.qrc` line 29) at compile time and listed in the `DISTFILES` variable of both `mk3.pro` (line 192) and `mk3-test.pro` (line 200). Git history shows it was introduced in commit `5fdc821` ("Implement default Wifi SSID & Pass (MK3-289)") and modified in `2adcd83` ("Fix missing SSID and password").

**Functions/methods:** None (data file).

**Constants/types/errors:** None (data file).

**Keys defined:**

| Line | Key | Value |
|------|-----|-------|
| 2 | `password` | `P@ssMK3!` |
| 3 | `ssid` | `cigSecureConnect` |

---

### `.gitignore`

**File purpose:** Tells git which files and patterns to exclude from version control in this repository.

**Functions/methods:** None (configuration file).

**Constants/types/errors:** None (configuration file).

**Rules defined (7 effective lines):**

| Line | Pattern | Effect |
|------|---------|--------|
| 1 | `Makefile` | Ignores the generated production Makefile |
| 2 | `FleetFocus` | Ignores the compiled test/production binary |
| 3 | `.*` | Ignores all dot-files/directories |
| 5 | `/tmp` | Ignores the `/tmp` directory at repo root |
| 7 | `!.gitignore` | Re-includes `.gitignore` itself (negates line 3) |
| 8 | `*.bak` | Ignores all `.bak` backup files |

Note: Line 4 and line 6 are blank separator lines.

---

## Findings

---

**A01-1** · CRITICAL · Plaintext credential committed to version control and compiled into firmware

**Description:** `netcfg.json` contains a plaintext Wi-Fi password (`P@ssMK3!`) and SSID (`cigSecureConnect`) committed to the repository (first introduced in commit `5fdc821`, modified in `2adcd83`). The file is also bundled into the Qt resource archive via `mk3.qrc` (line 29), meaning the credential is compiled directly into every firmware binary. Any party with repository read access or a firmware binary can trivially extract the credential using `strings` or Qt resource tools. The credential cannot be rotated without a code change and a new commit, and the old value remains permanently in git history. This is a provisioning or default network credential that has no business being stored in version control or baked into firmware.

**Fix:** (1) Remove `netcfg.json` from the repository immediately and rotate the password. (2) Add `netcfg.json` to `.gitignore`. (3) Remove `netcfg.json` from `mk3.qrc` and from `DISTFILES` in both `.pro` files. (4) Inject the credential at device provisioning time (written to protected on-device storage, not compiled in). (5) Purge the file from git history using `git filter-repo --path netcfg.json --invert-paths` or an equivalent tool, then force-push and notify all collaborators to re-clone.

---

**A01-2** · HIGH · `run_tests` script has no error handling and silently swallows test-runner failures

**Description:** The script uses `#!/bin/sh` and contains no `set -e`, `set -o pipefail`, or any explicit exit-code propagation. The test binary `./FleetFocus` is piped directly into `awk`. In any POSIX shell without `pipefail`, the exit status of the entire pipeline is that of the last command (`awk`), not of `./FleetFocus`. If `./FleetFocus` crashes, exits non-zero, or cannot be found, the script still exits 0 as long as `awk` exits 0. This means CI or any automated caller will see a success even when all tests have crashed. Additionally, if `./FleetFocus` does not exist in the current working directory (the script is run from a directory other than the one containing the binary) it fails with a non-actionable `./FleetFocus: not found` message with no diagnostic context.

**Fix:** (1) Replace `#!/bin/sh` with `#!/bin/bash` (or use `set -o pipefail` if `sh` must be kept, though `pipefail` is not specified by POSIX). (2) Add `set -euo pipefail` at the top of the script. (3) Capture and propagate the exit code of `./FleetFocus` explicitly, e.g.:

```bash
#!/bin/bash
set -euo pipefail
./FleetFocus | awk '...'
exit "${PIPESTATUS[0]}"
```

(4) Add a guard to verify the binary exists before running it.

---

**A01-3** · MEDIUM · `run_tests` uses a relative path to the test binary

**Description:** The script invokes the test binary as `./FleetFocus` (a path relative to the current working directory at the time the script is run). If the script is executed from any directory other than the one containing the compiled `FleetFocus` binary, it will fail. There is no documentation, comment, or guard indicating the required working directory. The `.gitignore` ignores `FleetFocus` (the binary) but the script assumes it is co-located with itself. The Makefile.test confirms the binary is produced in the same root as `run_tests`, but this is an implicit coupling.

**Fix:** Derive the binary path relative to the script's own location rather than the caller's working directory. For example:

```bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
"${SCRIPT_DIR}/FleetFocus" | awk '...'
```

---

**A01-4** · MEDIUM · `netcfg.json` embeds no schema version and has no validation mechanism

**Description:** `netcfg.json` contains two fields (`ssid`, `password`) with no schema version field, no required-field marker, and no indication of expected value constraints (e.g., SSID must be 1–32 bytes, WPA2 password must be 8–63 bytes). The application code in `wifi.cpp` and `globalconfigs.cpp` validates Wi-Fi parameters at the point of use, but there is no validation path visible for the values loaded from `netcfg.json` itself (no `.cpp` or `.h` file references `netcfg.json` by name). If either key is absent, has an empty value, or has an invalid length, the failure mode is silent or undefined. The absence of a schema version means any future addition of new configuration fields provides no forward- or backward-compatibility signal.

**Fix:** Add a `"version"` field to `netcfg.json` (e.g., `"version": 1`). Add explicit parsing and validation of the file in the code that consumes it, checking that both `ssid` and `password` are present, non-empty, and within specification limits. Return a clear error if validation fails.

---

**A01-5** · MEDIUM · `.gitignore` rule `.*` is overly broad and masks developer tooling files

**Description:** The pattern `.*` on line 3 matches every dot-file and dot-directory at every level of the repository, including — but not limited to — `.env`, `.env.local`, IDE project files (`.idea/`, `.vscode/`), and secret key files (`.ssh/`, `.netrc`). While the rule `!.gitignore` on line 7 correctly re-includes `.gitignore` itself, any other configuration or tooling file that developers may legitimately want to track (e.g., `.clang-format`, `.editorconfig`, `.clang-tidy`) is silently excluded. Developers may not notice that their tooling configuration files are not being tracked, leading to inconsistent development environments across the team.

**Fix:** Replace the single `.*` wildcard with an explicit allowlist/denylist approach. Keep denying clearly sensitive patterns, and explicitly allow known tooling dot-files that should be tracked:

```
# Explicitly ignore sensitive files
.env
.env.*
.netrc

# Allow tracked dot-files
!.gitignore
!.clang-format
!.editorconfig
```

---

**A01-6** · LOW · `.gitignore` ignores `Makefile` but not `Makefile.test`

**Description:** Line 1 of `.gitignore` ignores `Makefile` (the generated production Makefile). However, `Makefile.test` (the generated test Makefile) is not ignored and is tracked in the repository. `Makefile.test` is a fully generated file produced by `qmake -o Makefile.test mk3-test.pro` and contains machine-specific absolute paths (e.g., `/home/ryanharm/git/sdk/qt/...`, `/home/ryanharm/git/mark3-pvd/...`) embedded throughout. Committing generated files with developer-specific absolute paths pollutes the repository history, causes spurious diffs on every developer machine, and leaks details about the development environment layout.

**Fix:** Add `Makefile.test` to `.gitignore` and remove it from the repository index (`git rm --cached Makefile.test`).

---

**A01-7** · LOW · `Makefile.test` (tracked file) contains hardcoded developer home directory paths

**Description:** Although `Makefile.test` is not one of the three directly assigned files, it is a tracked file in the repository and its presence is directly caused by the gap in `.gitignore` noted in A01-6. The file contains multiple absolute paths rooted in `/home/ryanharm/git/...`, including SDK paths and build output directories. These paths are specific to a single developer's workstation. Any other developer or CI system must regenerate this file or patch all paths before building tests. This is a leaky abstraction — the build system's internal layout is exported into version control.

**Fix:** Add `Makefile.test` to `.gitignore` (see A01-6). Document the `qmake` command to regenerate it in a `README` or build script. All developers regenerate it locally; it is never committed.

---

**A01-8** · LOW · `run_tests` script has no usage comment or documentation

**Description:** The script is nine lines long with no header comment explaining its purpose, prerequisites (the `FleetFocus` binary must be pre-built), how to build it, or what the coloured output means. A new developer reading the repository has no context for when or how to run it, whether it is meant to be run manually or by a CI step, or what a passing run looks like.

**Fix:** Add a short comment block at the top of the script:

```sh
#!/bin/sh
# run_tests - Execute the compiled FleetFocus test binary and colourise output.
# Prerequisites: build the test binary first with: make -f Makefile.test
# Usage: ./run_tests
# Exit code mirrors the exit code of the FleetFocus binary (requires bash + pipefail).
```

---

**A01-9** · INFO · `netcfg.json` is listed in `DISTFILES` but no source code reads it

**Description:** `netcfg.json` is listed in the `DISTFILES` variable of both `mk3.pro` and `mk3-test.pro`, and is included in `mk3.qrc` (compiled into the Qt resource bundle). However, no `.cpp` or `.h` file in the repository references `netcfg.json` by name, nor does any code read from the `qrc:/netcfg.json` resource path. It is possible the file is read via a generic path that was not found in this search, or that the feature that reads it was removed while the file itself was not cleaned up. This is dead configuration — a file that is compiled into every firmware image but appears to serve no live code path.

**Fix:** Audit whether any code actually loads `netcfg.json` at runtime. If no code reads it, remove it from `mk3.qrc`, from `DISTFILES` in both `.pro` files, and from the repository. If code does read it, add a source-level comment or search tag so it can be located by future auditors.

---

**A01-10** · INFO · `run_tests` awk patterns are case-sensitive and may miss mixed-case output

**Description:** The `awk` patterns `/PASS/`, `/FAIL/`, `/DEBUG/`, `/WARN/` are all uppercase and case-sensitive. If any test or log output uses mixed case (e.g., `Pass`, `fail`, `Warning`), those lines will fall through to the uncolourised default case (`!/PASS|FAIL|DEBUG|WARN/`). This is a minor robustness gap rather than a security issue, but it can result in failures being displayed without the red colouring that would make them immediately visible.

**Fix:** Use case-insensitive matching in awk (`/[Pp][Aa][Ss][Ss]/` or `tolower($0) ~ /pass/`) or document the required output format contract in the test framework.

---

## Summary Table

| ID | Severity | Title |
|----|----------|-------|
| A01-1 | CRITICAL | Plaintext credential committed to version control and compiled into firmware |
| A01-2 | HIGH | `run_tests` has no error handling and silently swallows test-runner failures |
| A01-3 | MEDIUM | `run_tests` uses a relative path to the test binary |
| A01-4 | MEDIUM | `netcfg.json` embeds no schema version and has no validation mechanism |
| A01-5 | MEDIUM | `.gitignore` rule `.*` is overly broad and masks developer tooling files |
| A01-6 | LOW | `.gitignore` ignores `Makefile` but not `Makefile.test` |
| A01-7 | LOW | `Makefile.test` (tracked file) contains hardcoded developer home directory paths |
| A01-8 | LOW | `run_tests` script has no usage comment or documentation |
| A01-9 | INFO | `netcfg.json` is listed in `DISTFILES` but no source code reads it |
| A01-10 | INFO | `run_tests` awk patterns are case-sensitive and may miss mixed-case output |
