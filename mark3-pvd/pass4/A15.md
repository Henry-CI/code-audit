# Pass 4 Agent A15 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `platform/modemport.h`
- `platform/modemport.cpp`
- `platform/powersupply.h`
- `platform/powersupply.cpp`

---

## Reading Evidence

### `platform/modemport.h`

**Class:** `EM070::ModemPort` (inherits `QObject`)

| Line | Name | Kind |
|------|------|------|
| 14 | `explicit ModemPort(QObject *parent = nullptr)` | constructor |
| 15 | `bool sendCmd(const QByteArray &cmd)` | public method |
| 16 | `void resetModem()` | public method |
| 17 | `void setEnabled(bool enable)` | public method |
| 18 | `void setEcho(bool enable)` | public inline method |
| 19 | `bool isWwx()` | public inline method |
| 20 | `void setWwx(bool isWwx)` | public inline method |
| 23 | `void portStateChanged(bool open)` | signal |
| 24 | `void response(bool ok, const QByteArrayList &content)` | signal |
| 27 | `void openPort()` | private method |
| 28 | `void portError()` | private method |
| 29 | `void readData()` | private method |
| 30 | `void parseData(const QByteArray &line)` | private method |

**Members:**

| Line | Name | Type |
|------|------|------|
| 32 | `m_serialPort` | `QSerialPort *` |
| 33 | `m_timer` | `QTimer *` |
| 34 | `m_tryTimes` | `int` |
| 35 | `m_receiver` | `QByteArray` |
| 36 | `m_response` | `QByteArrayList` |
| 37 | `m_cmdLine` | `QByteArray` |
| 38 | `m_echo` | `bool` |
| 39 | `m_wwx` | `bool` |

**Types/enums/constants defined:** none in this header.

---

### `platform/modemport.cpp`

**Macros defined:**

| Line | Name | Value |
|------|------|-------|
| 7 | `FILE_MODEM_PORT_WWX` | `"/dev/ttyUSB2"` |
| 8 | `FILE_MODEM_PORT` | `"/dev/ttyUSB3"` |

**Functions:**

| Line | Name |
|------|------|
| 12 | `ModemPort::ModemPort(QObject *parent)` |
| 50 | `void ModemPort::resetModem()` |
| 68 | `void ModemPort::setEnabled(bool enable)` |
| 90 | `void ModemPort::openPort()` |
| 108 | `void ModemPort::portError()` |
| 125 | `bool ModemPort::sendCmd(const QByteArray &cmd)` |
| 139 | `void ModemPort::readData()` |
| 168 | `void ModemPort::parseData(const QByteArray &line)` |

---

### `platform/powersupply.h`

**Class:** `EM070::PowerSupply` (inherits `QObject`)

**Enums:**

| Line | Name | Enumerators |
|------|------|-------------|
| 16 | `BlankMode` | `UnBlank = 0`, `BlankPowerDown = 4` |
| 17 | `ChargeState` | `NotCharging = 0`, `PreCharging = 1`, `FastCharging = 2`, `ChargeDone = 3` |
| 18 | `ChargeFault` | `NoFault = 0`, `InputFault = 1`, `ThermalShutdown = 2`, `ChargeTimerExpired = 3` |

**Public methods:**

| Line | Name | Kind |
|------|------|------|
| 19 | `explicit PowerSupply(QObject *parent = nullptr)` | constructor |
| 21 | `bool isIgnitionOn() const` | inline getter |
| 23 | `bool isPowerGood() const` | inline getter |
| 24 | `bool isBatteryAvailable() const` | inline getter |
| 25 | `ChargeState chargeState() const` | inline getter |
| 26 | `ChargeFault chargeFault() const` | inline getter |
| 27 | `quint16 voltage() const` | inline getter |
| 28 | `qint16 current() const` | inline getter |
| 29 | `quint16 temperature() const` | inline getter |
| 30 | `quint16 remainingCapacity() const` | inline getter |
| 31 | `quint16 designCapacity() const` | inline getter |
| 32 | `quint16 timeToEmpty() const` | inline getter |
| 33 | `quint16 timeToFull() const` | inline getter |
| 35 | `static void reboot()` | static method |
| 36 | `static void poweroff()` | static method |
| 37 | `static void setBlankMode(BlankMode mode)` | static method |
| 38 | `static void setTouchPower(bool on)` | static method |
| 39 | `static void charge(bool enable)` | static method |
| 40 | `static void setBatteryEnabled(bool enable)` | static method |

**Signals:**

| Line | Name |
|------|------|
| 43 | `void ignitionStateChanged(bool on)` |
| 44 | `void batteryStatusRead(bool avail, int state, int fault, quint16 voltage, qint16 current, quint16 temp, quint16 remainingCapacity)` |

**Private methods:**

| Line | Name |
|------|------|
| 47 | `void readIgnitionState()` |
| 48 | `void readChargerStatus()` |
| 49 | `void readGaugeStatus()` |

**Private members:**

| Line | Name | Type | Comment |
|------|------|------|---------|
| 51 | `m_ignitionFile` | `QFile` | |
| 52 | `m_notifier` | `QSocketNotifier *` | |
| 53 | `m_timer` | `QTimer *` | |
| 55 | `m_ignitionOn` | `bool` | |
| 56 | `m_powerGood` | `bool` | |
| 57 | `m_batteryAvailable` | `bool` | false means VBat < Vsysmin |
| 58 | `m_chargeState` | `ChargeState` | |
| 59 | `m_chargeFault` | `ChargeFault` | |
| 60 | `m_voltage` | `quint16` | in mV |
| 61 | `m_current` | `qint16` | in mA |
| 62 | `m_temperature` | `quint16` | in Celsius degree |
| 63 | `m_remainingCapacity` | `quint16` | in % |
| 64 | `m_designCapacity` | `quint16` | in mAH |
| 65 | `m_timeToEmpty` | `quint16` | in minitues [sic] |
| 66 | `m_timeToFull` | `quint16` | in minitues [sic] |

---

### `platform/powersupply.cpp`

**Macros defined:**

| Line | Name | Value |
|------|------|-------|
| 8 | `QUERY_INTERVAL` | `6000` |
| 10 | `FILE_IGNITION` | `"/sys/devices/platform/nuc970-gpio.0/gpio/gpio225/value"` |
| 11 | `FILE_FB_BLANK` | `"/sys/devices/platform/nuc970-lcd/graphics/fb0/blank"` |
| 12 | `FILE_TOUCH_POWER` | `"/sys/touchscreen/power_state"` |
| 13 | `FILE_CHARGE_EN` | `"/sys/class/gpio/gpio160/value"` |
| 14 | `FILE_BATFET_DISABLE` | `"/sys/devices/platform/nuc970-i2c0/i2c-0/0-006b/power_supply/bq24190-charger/f_batfet_disable"` |
| 15 | `FILE_PG_STAT` | `"/sys/devices/platform/nuc970-i2c0/i2c-0/0-006b/power_supply/bq24190-charger/f_pg_stat"` |
| 16 | `FILE_VSYS_STAT` | `"/sys/devices/platform/nuc970-i2c0/i2c-0/0-006b/power_supply/bq24190-charger/f_vsys_stat"` |
| 17 | `FILE_CHRG_STAT` | `"/sys/devices/platform/nuc970-i2c0/i2c-0/0-006b/power_supply/bq24190-charger/f_chrg_stat"` |
| 18 | `FILE_CHRG_FAULT` | `"/sys/devices/platform/nuc970-i2c0/i2c-0/0-006b/power_supply/bq24190-charger/f_chrg_fault"` |
| 19 | `FILE_NTC_FAULT` | `"/sys/devices/platform/nuc970-i2c0/i2c-0/0-006b/power_supply/bq24190-charger/f_ntc_fault"` |
| 20 | `FILE_GAUGE_REGS` | `"/sys/devices/platform/nuc970-i2c0/i2c-0/0-0055/show_regs"` |

**Functions:**

| Line | Name |
|------|------|
| 24 | `PowerSupply::PowerSupply(QObject *parent)` |
| 53 | `void PowerSupply::readIgnitionState()` |
| 65 | `void PowerSupply::readChargerStatus()` |
| 123 | `void PowerSupply::readGaugeStatus()` |
| 181 | `void PowerSupply::reboot()` |
| 208 | `void PowerSupply::poweroff()` |
| 214 | `void PowerSupply::setBlankMode(BlankMode mode)` |
| 229 | `void PowerSupply::setTouchPower(bool on)` |
| 240 | `void PowerSupply::charge(bool enable)` |
| 251 | `void PowerSupply::setBatteryEnabled(bool enable)` |

---

## Findings

---

**A15-1** · MEDIUM · Commented-out code in `ModemPort::sendCmd` (modemport.cpp:132)

**Description:** Line 132 contains a commented-out `SerialLogger::log` call for outgoing modem commands:
```cpp
//SerialLogger::log("[MODEM:SEND] " + cmd + "\r\n");
```
Similarly, line 171 in `parseData` has a commented-out log for received modem data:
```cpp
//SerialLogger::log("[MODEM:RECV] " + line + "\r\n");
```
These blocks were apparently disabled deliberately (since `m_echo` was added as an alternative mechanism), but the dead code remains in the source. A companion commented-out block also exists at modemport.cpp:29:
```cpp
//m_wwx = true;
```
This appears to be a leftover from a port-detection experiment where `m_wwx` was supposed to be set automatically when `FILE_MODEM_PORT` did not exist, but that behavior was suppressed without explanation.

**Fix:** Remove all three commented-out code lines (modemport.cpp:29, 132, 171). If any of these represent intentional design decisions (e.g., disabling the wwx auto-detection), document the rationale in a comment rather than leaving dead code.

---

**A15-2** · MEDIUM · Commented-out code in `PowerSupply::readGaugeStatus` (powersupply.cpp:130–131)

**Description:** Lines 130–131 contain a commented-out early-return guard:
```cpp
// if (!m_batteryAvailable)
//    return;
```
The surrounding block comment (lines 125–129) explains *why* the guard was disabled — to allow charging even when the battery is fully discharged — but the dead code lines still remain in source, creating noise and ambiguity.

**Fix:** Remove the commented-out `if` block. If the comment block explaining the rationale is still valid, keep it as a plain prose comment without the dead code lines.

---

**A15-3** · LOW · Commented-out code in `PowerSupply::parseData` — modem response terms (modemport.cpp:195–199)

**Description:** Lines 195–199 contain a block of commented-out `startsWith` conditions that were apparently considered but not implemented:
```cpp
//            line.startsWith("BUSY") ||
//            line.startsWith("RING") ||
//            line.startsWith("NO CARRIER") ||
//            line.startsWith("NO ANSWER") ||
//            line.startsWith("NO DIALTONE") ||
```
These suggest dial-up/voice-call handling was considered and then abandoned. They carry no explanatory note.

**Fix:** Remove the commented-out lines. If these responses are genuinely not expected on the data-only modem interface in use, a brief comment stating "voice call responses not applicable" is clearer than dead code.

---

**A15-4** · LOW · Commented-out code in `PowerSupply::reboot` — shell script embedded in comment (powersupply.cpp:183–203)

**Description:** The body of `reboot()` is preceded by a multi-line comment (lines 183–203) that reproduces the entire content of the `/etc/pvd/reboot` shell script inline. While this is informational, it duplicates maintenance-sensitive logic that lives in an external script. If the script changes, the comment will silently drift out of sync.

**Fix:** Replace the verbatim script reproduction with a brief prose description (e.g., "Calls /etc/pvd/reboot which shuts down the modem and network interfaces before rebooting the system"). Reference a documentation location or the script path for readers who want full details.

---

**A15-5** · MEDIUM · Hardware sysfs paths hard-coded as `#define` macros in implementation file (powersupply.cpp:10–20)

**Description:** Ten hardware-specific sysfs paths are defined as `#define` macros at the top of `powersupply.cpp`. These paths encode the SoC part number (`nuc970`), I2C bus topology (`i2c-0/0-006b`), GPIO numbers (`gpio160`, `gpio225`), and charger chip model (`bq24190`). Any board revision or kernel driver update that changes a sysfs path requires edits to this file. There is no mechanism to override paths at compile time or runtime for different board variants.

Examples:
```cpp
#define FILE_IGNITION       "/sys/devices/platform/nuc970-gpio.0/gpio/gpio225/value"
#define FILE_CHARGE_EN      "/sys/class/gpio/gpio160/value"
#define FILE_BATFET_DISABLE "/sys/devices/platform/nuc970-i2c0/i2c-0/0-006b/power_supply/bq24190-charger/f_batfet_disable"
```

**Fix:** Collect the sysfs path strings into a named constant struct or a dedicated `platform_paths.h` header, or make them compile-time configurable via a build variable. As a minimum, group them with a comment indicating the target hardware revision so the scope of change is explicit.

---

**A15-6** · LOW · Device node paths hard-coded as `#define` macros in implementation file (modemport.cpp:7–8)

**Description:** The modem serial port device paths are defined as `#define` macros at the top of the `.cpp` file:
```cpp
#define FILE_MODEM_PORT_WWX "/dev/ttyUSB2"
#define FILE_MODEM_PORT     "/dev/ttyUSB3"
```
There is also a non-ARM fallback hard-coded as the string literal `"COM4"` on line 33, with no macro. These paths are tied to a specific USB enumeration order that can vary between kernel versions or USB attachment sequences.

**Fix:** Promote these to named constants in the header or a shared platform configuration header. The `"COM4"` literal on line 33 should also be named and placed alongside the other port definitions. Consider supporting runtime override via the existing `QT_MOBILE_SERIAL_PORT` environment variable mechanism for both port variants.

---

**A15-7** · MEDIUM · `QProcess::startDetached` called with a combined command-and-argument string (modemport.cpp:61)

**Description:** `resetModem()` invokes:
```cpp
QProcess::startDetached("/etc/pvd/mobile -r");
```
The single-string overload of `QProcess::startDetached` was deprecated in Qt 5.15 in favour of the overload that takes the program path and a separate `QStringList` of arguments. Using the deprecated single-string form is a build warning source on Qt 5.15+ and will be removed in Qt 6.

**Fix:** Replace with the two-argument form:
```cpp
QProcess::startDetached("/etc/pvd/mobile", {"-r"});
```

---

**A15-8** · LOW · Magic numbers used in `readGaugeStatus` without symbolic names (powersupply.cpp:145–175)

**Description:** `readGaugeStatus` uses a series of `mid(N)` calls with bare integer offsets (5, 10, 14, 7, 6, 6, 6) to parse fixed-position fields from a comma-separated register dump string. These offsets correspond to the byte lengths of field-name prefixes in the sysfs output (e.g., `"volt="` is 5 chars, `"current_now="` is 12 chars). No comment names the corresponding field labels, making the parsing logic opaque and fragile.

Additionally, the voltage thresholds on lines 148 and 150 (`4100` and `4300` mV) are bare integer literals with no named constants or comments explaining what charge levels they represent.

**Fix:** Define named constants or an inline comment for each `mid` offset that identifies the prefix being skipped. For example:
```cpp
constexpr int VOLT_PREFIX_LEN = 5; // "volt="
```
Similarly, define named constants for the charge threshold voltages:
```cpp
constexpr int CHARGE_ENABLE_THRESHOLD_MV  = 4100;
constexpr int CHARGE_DISABLE_THRESHOLD_MV = 4300;
```

---

**A15-9** · LOW · `BlankMode` enum gap between `UnBlank` (0) and `BlankPowerDown` (4) (powersupply.h:16)

**Description:** The enum is declared as:
```cpp
enum BlankMode {UnBlank, BlankPowerDown = 4};
```
Values 1, 2, and 3 are implicit holes in the enum range. The `setBlankMode` implementation ignores the enum value entirely for the non-`UnBlank` case and always writes `"4"` to the framebuffer blank sysfs node:
```cpp
default:
    file.write("4");
    break;
```
This means any caller who constructs a `BlankMode` with a value of 1, 2, or 3 (possible via a cast) will silently write `"4"` rather than the intended value. The Linux framebuffer blank interface supports values 0–4 (FB_BLANK_UNBLANK through FB_BLANK_POWERDOWN), so values 1–3 are valid and meaningful intermediates that the enum design implies should be reachable but are not.

**Fix:** Either enumerate all meaningful FB_BLANK values (0 = unblank, 1 = normal blank, 2 = vsync suspend, 3 = hsync suspend, 4 = powerdown) or document explicitly that only `UnBlank` and `BlankPowerDown` are supported by this hardware. The `switch` in `setBlankMode` should use the actual enum value when writing the sysfs file rather than the hard-coded `"4"`.

---

**A15-10** · LOW · `m_timer->start(QUERY_INTERVAL)` called twice in `readGaugeStatus` (powersupply.cpp:120, 178)

**Description:** `readChargerStatus` calls `readGaugeStatus` on line 117, then immediately calls `m_timer->start(QUERY_INTERVAL)` on line 120 to schedule the next poll. However, `readGaugeStatus` itself also calls `m_timer->start(QUERY_INTERVAL)` at line 178. Because `readGaugeStatus` is only ever called from `readChargerStatus`, the timer is restarted twice per poll cycle. The second start (line 120 in `readChargerStatus`) is a no-op because `QTimer::start` on an already-active single-shot timer that has not fired simply resets the interval — but the intent is obscured and the placement is misleading.

**Fix:** Remove the `m_timer->start(QUERY_INTERVAL)` call from inside `readGaugeStatus` (line 178). The timer restart belongs in `readChargerStatus` only, after all status reads are complete.

---

**A15-11** · LOW · Inconsistent `inline` method style in `modemport.h` (modemport.h:18–20)

**Description:** Three inline methods in the `ModemPort` header have inconsistent formatting. `setEcho` at line 18 omits the space before the opening brace and uses no space after the function signature:
```cpp
void setEcho(bool enable) {m_echo = enable;}
```
`isWwx` at line 19 has a trailing semicolon after the closing brace, which is valid C++ but inconsistent:
```cpp
bool isWwx() {return m_wwx;};
```
The `PowerSupply` inline getters in `powersupply.h` are consistently formatted with spaces inside braces (e.g., `{return m_ignitionOn;}`). The style difference between the two headers in the same namespace is a minor consistency issue.

**Fix:** Apply consistent inline formatting. For `modemport.h`, add spaces around the body content and remove the spurious trailing semicolon on `isWwx`:
```cpp
void setEcho(bool enable) { m_echo = enable; }
bool isWwx() { return m_wwx; }
void setWwx(bool isWwx) { m_wwx = isWwx; }
```

---

**A15-12** · LOW · Typo in `powersupply.h` member comments: "minitues" (powersupply.h:65–66)

**Description:** The inline comments on lines 65 and 66 read:
```cpp
quint16 m_timeToEmpty;      // in minitues
quint16 m_timeToFull;       // in minitues
```
"minitues" is a misspelling of "minutes".

**Fix:** Correct to "minutes" on both lines.

---

**A15-13** · INFO · `qDebug()` trace left in production code paths (modemport.cpp:102, 118, 131, 170)

**Description:** Four `qDebug()` calls remain in `ModemPort`:
- Line 102: `qDebug() << "ModemPort open";`
- Line 118: `qDebug() << "ModemPort closed";`
- Line 131: `qDebug() << "ModemPort >" << m_cmdLine;` (logs every outgoing AT command)
- Line 170: `qDebug() << "ModemPort <" << line;` (logs every received line)

Lines 131 and 170 will produce high-frequency output on every AT command transaction. In release builds without `QT_NO_DEBUG_OUTPUT` defined, this constitutes unnecessary I/O and potential log volume concern.

**Fix:** Guard high-frequency debug traces (lines 131 and 170) with `#ifdef QT_DEBUG` or replace with the existing `SerialLogger` mechanism controlled by `m_echo`, so they are not emitted in production firmware builds.

---

## Summary Table

| ID | Severity | Location | Short Title |
|----|----------|----------|-------------|
| A15-1 | MEDIUM | modemport.cpp:29, 132, 171 | Commented-out code: log calls and wwx auto-detect |
| A15-2 | MEDIUM | powersupply.cpp:130–131 | Commented-out early-return guard in readGaugeStatus |
| A15-3 | LOW | modemport.cpp:195–199 | Commented-out modem response terms (BUSY, RING, etc.) |
| A15-4 | LOW | powersupply.cpp:183–203 | Verbatim shell script reproduced in comment |
| A15-5 | MEDIUM | powersupply.cpp:10–20 | Hardware sysfs paths hard-coded as #define macros |
| A15-6 | LOW | modemport.cpp:7–8, 33 | Device node paths hard-coded as #define macros |
| A15-7 | MEDIUM | modemport.cpp:61 | Deprecated QProcess::startDetached single-string overload |
| A15-8 | LOW | powersupply.cpp:145–175 | Magic numbers in sysfs field offset parsing and voltage thresholds |
| A15-9 | LOW | powersupply.h:16, powersupply.cpp:218–226 | BlankMode enum gap; implementation ignores enum value |
| A15-10 | LOW | powersupply.cpp:120, 178 | Timer restarted twice per poll cycle |
| A15-11 | LOW | modemport.h:18–20 | Inconsistent inline method style (trailing semicolon, missing spaces) |
| A15-12 | LOW | powersupply.h:65–66 | Typo "minitues" in member comments |
| A15-13 | INFO | modemport.cpp:102, 118, 131, 170 | High-frequency qDebug() calls left in production code paths |
