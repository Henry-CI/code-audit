# Pass 4 Agent A18 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `ui/amberimpactalertdialog.h` + `ui/amberimpactalertdialog.cpp`
- `ui/authoriseddialog.h` + `ui/authoriseddialog.cpp`
- `ui/broadcastuidialog.h` + `ui/broadcastuidialog.cpp`

---

## 1. Reading Evidence

### 1.1 AmberImpactAlertDialog

**File:** `ui/amberimpactalertdialog.h` / `ui/amberimpactalertdialog.cpp`

**Class:** `AmberImpactAlertDialog` (extends `QDialog`)

**Methods / functions (with line numbers):**

| Location | Signature |
|---|---|
| h:15 / cpp:6 | `explicit AmberImpactAlertDialog(QWidget *parent = nullptr)` |
| h:16 / cpp:14 | `~AmberImpactAlertDialog()` |
| h:18 / cpp:49 | `bool isOpen() const` |
| h:19 / cpp:31 | `void closeWindow()` |
| h:20 / cpp:19 | `void languageChanged()` |
| h:23 (public slot) / cpp:54 | `void amberAlertDialogShowEvent(bool isLocked)` |
| h:26 (protected) / cpp:25 | `void mouseReleaseEvent(QMouseEvent *)` |
| h:27 (protected) / cpp:39 | `void showEvent(QShowEvent *event = 0)` |

**Types / enums / constants defined:** none beyond those inherited from `QDialog`.

**Private members:**
- `Ui::AmberImpactAlertDialog *ui` (h:30)
- `bool dialogOpenFlag` (h:31)

---

### 1.2 AuthorisedDialog

**File:** `ui/authoriseddialog.h` / `ui/authoriseddialog.cpp`

**Class:** `AuthorisedDialog` (extends `QDialog`)

**Methods / functions (with line numbers):**

| Location | Signature |
|---|---|
| h:17 / cpp:13 | `explicit AuthorisedDialog(QWidget *parent = 0)` |
| h:18 / cpp:44 | `~AuthorisedDialog()` |
| h:19 / cpp:56 | `void setHasChecklist(bool yes)` |
| h:20 / cpp:67 | `void setDriverId(quint64 id)` |
| h:21 / cpp:178 | `void setTime(const QString s)` |
| h:22 / cpp:211 | `void setPower(bool on)` |
| h:23 / cpp:217 | `void updateCamera()` |
| h:33 (protected) / cpp:71 | `void showEvent(QShowEvent *)` |
| h:34 (protected) / cpp:113 | `void hideEvent(QHideEvent *)` |
| h:43 (private) / cpp:148 | `bool debounce()` |
| h:44 (private) / cpp:120 | `void screensaverOff()` |
| h:45 (private) / cpp:138 | `void screensaverPressed()` |
| h:46 (private) / cpp:50 | `void onButtonConfirmStart()` |
| h:47 (private) / cpp:130 | `void screensaverOn()` |
| h:48 (private) / cpp:188 | `void setCamera(bool on, bool flip)` |
| h:54 (private slot) / cpp:172 | `void rstLogout()` |
| h:55 (private slot) / cpp:156 | `void onLogoutRequest()` |

**Signals:**
- `void userLogout()` (h:30)

**Types / enums / constants defined:**
- `#define RESET_TIMEOUT 2000` (cpp:11)

**Private members:**
- `bool m_waking` (h:37)
- `Ui::AuthorisedDialog *ui` (h:38)
- `OptionalCheckConfirmationDialog *m_optionalCheckConfirmationDialog` (h:39)
- `QTimer *m_resetTimer` (h:40)
- `quint32 m_lastPress` (h:41)
- `quint64 m_pendingDriverId` (h:42)
- `bool m_showCamera` (h:50)
- `bool m_power` (h:51)

---

### 1.3 BroadcastUIDialog

**File:** `ui/broadcastuidialog.h` / `ui/broadcastuidialog.cpp`

**Class:** `BroadcastUIDialog` (extends `QDialog`)

**Methods / functions (with line numbers):**

| Location | Signature |
|---|---|
| h:19 / cpp:4 | `explicit BroadcastUIDialog(QWidget *parent = nullptr)` |
| h:20 / cpp:19 | `~BroadcastUIDialog()` |
| h:22 / cpp:24 | `void setUIParam(CIGCONF::BroadcastMessage m)` |
| h:32 (private slot) / cpp:48 | `void onYes()` |
| h:33 (private slot) / cpp:54 | `void onNo()` |
| h:34 (private slot) / cpp:60 | `void onOK()` |

**Signals:**
- `void messageClosed(CIGCONF::BroadcastMessage m)` (h:25)

**Enums defined:**
- `enum MessageResult { MsgResultOK, MsgResultYes, MsgResultNo, MsgResultTimeout, MsgResultLogout, MsgResultNoDriver }` (h:17)

**Private members:**
- `Ui::BroadcastUIDialog *ui` (h:28)
- `QTimer *m_timer` (h:29)

---

## 2. Findings

---

**A18-1** · HIGH · `BroadcastUIDialog::m_timer` allocated without parent — potential memory leak

**Description:** In `broadcastuidialog.cpp` line 7, `m_timer` is constructed as `new QTimer` with no parent argument. Every other `QTimer` allocation in the `ui/` directory uses `new QTimer(this)`, which means the Qt object tree will automatically delete the timer when the dialog is destroyed. Without a parent, the timer is not owned by the object tree and must be deleted manually. The destructor (`cpp:19–22`) only calls `delete ui` and never deletes `m_timer`, so the timer is leaked on every `BroadcastUIDialog` destruction.

**Fix:** Change `m_timer(new QTimer)` to `m_timer(new QTimer(this))` at `broadcastuidialog.cpp:7`. This registers the timer in the Qt object tree and removes the need for a manual `delete`.

---

**A18-2** · HIGH · `messageClosed` signal declared but never emitted — silent API contract failure

**Description:** `BroadcastUIDialog` declares `void messageClosed(CIGCONF::BroadcastMessage m)` at `broadcastuidialog.h:25`. This signal is never emitted anywhere in the codebase (verified by full-repository search). The three button slots (`onYes`, `onNo`, `onOK`) and the timer lambda all call `emit done(MsgResultXxx)`, which invokes the inherited `QDialog::finished(int)` signal rather than `messageClosed`. Any caller that connects to `messageClosed` will never receive a notification, silently discarding message results. The actual consumer in `dialog.cpp:133` connects to `BroadcastUIDialog::finished`, confirming `messageClosed` is unreachable dead code that creates a misleading public API surface.

**Fix:** Remove the `messageClosed` signal declaration from `broadcastuidialog.h`. If a typed result notification carrying back the `BroadcastMessage` is needed in future, re-introduce it and emit it from each slot. Add a comment near the `done()` calls noting that callers should connect to `QDialog::finished(int)` and cast the result to `BroadcastUIDialog::MessageResult`.

---

**A18-3** · MEDIUM · `MessageResult` values `MsgResultLogout` and `MsgResultNoDriver` emitted externally, not by the owning class

**Description:** The `MessageResult` enum values `MsgResultLogout` and `MsgResultNoDriver` are never emitted inside `BroadcastUIDialog` itself. They are fired from `dialog.cpp:135` (`emit m_broadcastDialog->done(BroadcastUIDialog::MsgResultLogout)`) and `dialog.cpp:1165` (`onBroadcastDialogDone(BroadcastUIDialog::MsgResultNoDriver)`). Calling `emit` on another object's signal is a Qt anti-pattern: it bypasses the owning class's encapsulation, couples the external class to internal state transitions, and makes the control flow non-obvious. It can also produce unexpected re-entrancy if the signal is connected with `Qt::DirectConnection`.

**Fix:** Add dedicated public slots or methods to `BroadcastUIDialog` — e.g., `void forceLogoutClose()` and `void forceNoDriverClose()` — that call `emit done(MsgResultLogout)` and `emit done(MsgResultNoDriver)` respectively from within the class. The external caller in `dialog.cpp` should invoke these methods instead of reaching into the object to emit its signals.

---

**A18-4** · MEDIUM · `showEvent` default argument `= 0` is deprecated C++11 / Qt style inconsistency

**Description:** `amberimpactalertdialog.h:27` declares `void showEvent(QShowEvent *event = 0)`. Using integer literal `0` as a default value for a pointer parameter is deprecated C++ style; the correct form is `= nullptr`. This pattern also appears on the same line using a tab-indented style that differs from the spaces-indented body of the same header. `authoriseddialog.h:33` uses `void showEvent(QShowEvent *)` (no default at all), which is the correct override form. `broadcastuidialog.h` omits `showEvent` entirely. Providing a default argument on a virtual override is misleading: the base class `QDialog::showEvent` has no default, so callers always pass the event; the default is never used and serves only to confuse.

**Fix:** Remove the `= 0` default from `amberimpactalertdialog.h:27`. Change `0` to `nullptr` as a secondary improvement wherever legacy `= 0` defaults appear across the `ui/` directory. Align all `showEvent` overrides to the form `void showEvent(QShowEvent *event) override;`.

---

**A18-5** · MEDIUM · `AuthorisedDialog` constructor uses `= 0` for parent parameter; `AmberImpactAlertDialog` uses `= nullptr` — inconsistent within the same file set

**Description:** `authoriseddialog.h:17` declares `explicit AuthorisedDialog(QWidget *parent = 0)` whereas `amberimpactalertdialog.h:15` and `broadcastuidialog.h:19` both use `= nullptr`. Within the same logical group of dialog classes, two different null-pointer representations are used. This is a style inconsistency that will produce compiler warnings under `-Wzero-as-null-pointer-constant` on modern compilers.

**Fix:** Standardise all constructor default parent arguments to `= nullptr` across the `ui/` dialog class headers.

---

**A18-6** · MEDIUM · `AuthorisedDialog::setCamera` contains a leftover `qDebug` trace statement in production code

**Description:** `authoriseddialog.cpp:190` contains `qDebug() << "setCamera(" << on << "," << flip << ")";`. This diagnostic trace fires on every camera state transition, which can occur frequently (on every screensaver toggle, hide/show event, and power change). Debug output in production code adds unnecessary I/O overhead and can expose internal state information in production logs.

**Fix:** Remove the `qDebug` call, or wrap it in `#ifdef QT_DEBUG` / `#endif` so it compiles out in release builds.

---

**A18-7** · MEDIUM · `AmberImpactAlertDialog` includes `<QDebug>` but never calls `qDebug`

**Description:** `amberimpactalertdialog.cpp:4` includes `<QDebug>`, but no `qDebug()` call exists anywhere in the file. This is a dead include left over from development. Unused includes add noise and marginally increase compile time.

**Fix:** Remove `#include <QDebug>` from `amberimpactalertdialog.cpp`.

---

**A18-8** · MEDIUM · `AmberImpactAlertDialog::languageChanged` not called from `Dialog::onLanguageChanged` — localisation gap

**Description:** `dialog.cpp` calls `languageChanged()` on eight child dialogs during language switching (lines 1275–1282), but `m_amberImpactAlertDialog->languageChanged()` is absent from that list. `AmberImpactAlertDialog` has its own `languageChanged()` implementation (`amberimpactalertdialog.cpp:19–23`) that re-translates two labels. If the user changes language while the amber alert dialog is open or has been shown before, those labels will remain in the previous language.

**Fix:** Add `m_amberImpactAlertDialog->languageChanged();` to the `Dialog::onLanguageChanged` handler alongside the other dialog calls.

---

**A18-9** · LOW · `AmberImpactAlertDialog::showEvent` duplicates translation strings already in `languageChanged`

**Description:** `amberimpactalertdialog.cpp:43–44` (inside `showEvent`) and `amberimpactalertdialog.cpp:21–22` (inside `languageChanged`) contain identical `tr(...)` calls for the same two labels. This duplication means any future change to the displayed text must be made in two places, risking divergence.

**Fix:** Refactor `showEvent` to call `languageChanged()` rather than repeating the `tr(...)` assignments. This makes `languageChanged` the single source of truth for translated strings.

---

**A18-10** · LOW · `AuthorisedDialog::onLogoutRequest` compares button text to a translated string to determine dialog state

**Description:** `authoriseddialog.cpp:160` uses `ui->btnLogout->text() == tr("Confirm?")` to test whether the button is in its first-click or second-click (confirm) state. This couples state detection to the localised display text. If the translated string for "Confirm?" in any language contains leading/trailing whitespace or differs in punctuation, the comparison will silently fail and the logout confirmation flow will break. It also makes the component untestable without mocking the translation engine.

**Fix:** Introduce a private `bool m_logoutPending` member that is set to `true` on the first click and reset to `false` by `rstLogout()` and on successful logout. Use `m_logoutPending` as the state gate instead of comparing button text.

---

**A18-11** · LOW · `AuthorisedDialog::setTime` takes `const QString s` by value — unnecessary copy

**Description:** `authoriseddialog.h:21` declares `void setTime(const QString s)`. Passing `QString` by `const` value provides no benefit over passing by `const QString &`; it creates a copy of the string on every call with no additional safety guarantee.

**Fix:** Change the signature to `void setTime(const QString &s)` in both the header and the implementation.

---

**A18-12** · LOW · `AuthorisedDialog::showEvent` sets widget geometry with hard-coded pixel coordinates

**Description:** `authoriseddialog.cpp:82–96` uses hard-coded absolute pixel positions (e.g., `resize(800,321)`, `move(355,170)`) to reposition labels depending on whether the driver name is displayed. Hard-coded pixel layout is fragile: it breaks on any display resolution other than the targeted 800x480 and is unaffected by Qt's layout system. This is a maintainability concern rather than a security issue.

**Fix:** Replace hard-coded geometry calls with a QLayout-based approach (e.g., a `QVBoxLayout` / `QStackedWidget` that shows or hides the driver name label while the other widgets reflow automatically).

---

**A18-13** · LOW · `AuthorisedDialog::showEvent` sets a non-translated hard-coded English string `"Welcome, "`

**Description:** `authoriseddialog.cpp:79` constructs the driver name label text as `"Welcome, " + driverName`. The string literal `"Welcome, "` is not wrapped in `tr(...)`, so it is not subject to translation even when the UI language is changed.

**Fix:** Change the assignment to `ui->lblDriverName->setText(tr("Welcome, ") + driverName)` or, preferably, use `tr("Welcome, %1").arg(driverName)` which is safer for languages where word order differs.

---

**A18-14** · LOW · `BroadcastUIDialog::setUIParam` takes `CIGCONF::BroadcastMessage` by value — unnecessary copy of a potentially non-trivial struct

**Description:** `broadcastuidialog.h:22` declares `void setUIParam(CIGCONF::BroadcastMessage m)`. If `BroadcastMessage` contains a `QString` member (which it does — `m.text` is accessed on cpp:26), passing by value copies the entire struct including the string allocation on every call.

**Fix:** Change the parameter to `const CIGCONF::BroadcastMessage &m`.

---

## 3. Summary Table

| ID | Severity | File(s) | Short Title |
|---|---|---|---|
| A18-1 | HIGH | `broadcastuidialog.cpp:7` | `m_timer` allocated without parent — memory leak |
| A18-2 | HIGH | `broadcastuidialog.h:25` / `.cpp` | `messageClosed` signal declared but never emitted |
| A18-3 | MEDIUM | `broadcastuidialog.h:17` / `dialog.cpp:135,1165` | `MsgResultLogout`/`MsgResultNoDriver` emitted externally via `emit obj->signal()` |
| A18-4 | MEDIUM | `amberimpactalertdialog.h:27` | `showEvent` default argument `= 0` — deprecated null pointer style |
| A18-5 | MEDIUM | `authoriseddialog.h:17` | Constructor uses `= 0` vs `= nullptr` — inconsistent across file set |
| A18-6 | MEDIUM | `authoriseddialog.cpp:190` | Leftover `qDebug` trace in production `setCamera` path |
| A18-7 | MEDIUM | `amberimpactalertdialog.cpp:4` | Unused `#include <QDebug>` |
| A18-8 | MEDIUM | `dialog.cpp` / `amberimpactalertdialog.cpp` | `languageChanged()` never called on `AmberImpactAlertDialog` during language switch |
| A18-9 | LOW | `amberimpactalertdialog.cpp:43–44` | Translation strings duplicated in `showEvent` and `languageChanged` |
| A18-10 | LOW | `authoriseddialog.cpp:160` | Logout state detected by comparing translated button text |
| A18-11 | LOW | `authoriseddialog.h:21` / `.cpp:178` | `setTime` takes `QString` by value instead of `const QString &` |
| A18-12 | LOW | `authoriseddialog.cpp:82–96` | Hard-coded pixel geometry in `showEvent` |
| A18-13 | LOW | `authoriseddialog.cpp:79` | Hard-coded English string `"Welcome, "` not passed through `tr()` |
| A18-14 | LOW | `broadcastuidialog.h:22` / `.cpp:24` | `setUIParam` takes `BroadcastMessage` by value instead of const reference |
