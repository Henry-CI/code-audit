# Pass 4 Agent A22 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `ui/lockeddialog.h` + `ui/lockeddialog.cpp`
- `ui/messagedialog.h` + `ui/messagedialog.cpp`
- `ui/onScreenKeyboard.h` + `ui/onScreenKeyboard.cpp`

---

## Reading Evidence

### `ui/lockeddialog.h` + `ui/lockeddialog.cpp`

**Class:** `LockedDialog` (extends `QDialog`)

**Public methods (header line numbers):**

| Location | Signature |
|---|---|
| h:18 | `explicit LockedDialog(QWidget *parent = 0)` — constructor |
| h:19 | `~LockedDialog()` — destructor |
| h:20 | `void setLockedReason(CIGCONF::MaintLockedCode lockedCode)` |
| h:21 | `void languageChanged(void)` |
| h:22 | `void setTimeRemaining(quint32 secs)` |
| h:23 | `void clearTimerText()` |
| h:24 | `void stopTimer()` |
| h:25 | `void startTimer()` |

**Signals:**

| Location | Signature |
|---|---|
| h:32 | `void fullLockoutTimerEnded(bool on1, bool on2)` |
| h:33 | `void beeperOn()` |

**Protected methods:**

| Location | Signature |
|---|---|
| h:36 | `void mouseReleaseEvent(QMouseEvent *)` — inline, calls `accept()` |

**Private methods:**

| Location | Signature |
|---|---|
| h:40 | `void updateFullLock()` |
| h:41 | `void fullLockStart()` |

**Private members:**

- `Ui::LockedDialog *ui` — h:39
- `QTimer *m_fullLockTimer` — h:43
- `quint32 m_timeCntr` — h:44

**Conditional compilation:**
- `#ifdef UNIT_TEST` — h:27–29: `friend class TestDialog`

**Types used from external header (`app/cigconfigs.h`):**

`CIGCONF::MaintLockedCode` enum (defined at cigconfigs.h:142–148):

| Enumerator | Value |
|---|---|
| `MaintNormal` | `0x00` |
| `MaintIdle` | `0xea` |
| `MaintCriticalQuestion` | `0xfb` |
| `MaintRedImpact` | `0xfd` |
| `MaintSurveyTimeout` | `0xfe` |

**Implementation function line numbers (cpp):**

| Line | Function |
|---|---|
| 6 | `LockedDialog::LockedDialog(QWidget *parent)` |
| 16 | `LockedDialog::~LockedDialog()` |
| 21 | `void LockedDialog::startTimer()` |
| 30 | `void LockedDialog::stopTimer()` |
| 36 | `void LockedDialog::setLockedReason(CIGCONF::MaintLockedCode lockedCode)` |
| 61 | `void LockedDialog::languageChanged()` |
| 66 | `void LockedDialog::clearTimerText()` |
| 70 | `void LockedDialog::setTimeRemaining(quint32 secs)` |
| 77 | `void LockedDialog::fullLockStart()` |
| 84 | `void LockedDialog::updateFullLock()` |

---

### `ui/messagedialog.h` + `ui/messagedialog.cpp`

**Class:** `MessageDialog` (extends `QDialog`)

**Enum defined in class scope (h:18–27):**

`MessageType`:

| Enumerator | Implicit value |
|---|---|
| `NoMessage` | 0 |
| `ExpansionConnecting` | 1 |
| `WaitForAuthorised` | 2 |
| `NotAuthorised` | 3 |
| `OnDemandNotAuthorised` | 4 |
| `PowerOff` | 5 |
| `Reboot` | 6 |
| `VehicleOutOfService` | 7 |

**Public methods (header line numbers):**

| Location | Signature |
|---|---|
| h:29 | `explicit MessageDialog(QWidget *parent = 0)` — constructor |
| h:30 | `~MessageDialog()` — destructor |
| h:31 | `void openWithMessage(MessageType type)` — inline; calls `setMessageType(type); open()` |
| h:33 | `void setMessageType(MessageType type)` |
| h:34 | `MessageType messageType() const` — inline getter |

**Protected methods:**

| Location | Signature |
|---|---|
| h:37 | `void hideEvent(QHideEvent *)` |

**Private members:**

- `Ui::MessageDialog *ui` — h:40
- `QTimer *m_timer` — h:42
- `QMovie *m_movie` — h:43
- `MessageType m_messageType` — h:44

**Macro constants (cpp):**

| Name | Value | Location |
|---|---|---|
| `WAIT_AUTH_TIME` | `10000` | cpp:7 |
| `NOT_AUTH_TIME` | `5000` | cpp:8 |

**Implementation function line numbers (cpp):**

| Line | Function |
|---|---|
| 10 | `MessageDialog::MessageDialog(QWidget *parent)` |
| 30 | `MessageDialog::~MessageDialog()` |
| 35 | `void MessageDialog::hideEvent(QHideEvent *)` |
| 42 | `void MessageDialog::setMessageType(MessageType type)` |

---

### `ui/onScreenKeyboard.h` + `ui/onScreenKeyboard.cpp`

**Class:** `onScreenKeyboard` (extends `QWidget`) — note non-standard lower-camel class name

**Enums defined in class scope (h:17–19):**

`KeyToggleState`:

| Enumerator | Implicit value |
|---|---|
| `Normal` | 0 |
| `Upper` | 1 |
| `Lower` | 2 |

`CaseButton`:

| Enumerator | Implicit value |
|---|---|
| `AllButtons` | 0 |
| `CapsButton` | 1 |
| `ShiftButton` | 2 |
| `SymbolButton` | 3 |

`CtrlButton`:

| Enumerator | Implicit value |
|---|---|
| `None` | 0 |
| `Backspace` | 1 |
| `Delete` | 2 |

**Public members:**

- `QPushButton *enterButton` — h:22 (public raw pointer; never initialized in constructor; never referenced anywhere in the codebase)

**Public methods (header line numbers):**

| Location | Signature |
|---|---|
| h:20 | `explicit onScreenKeyboard(QWidget *parent = 0)` — constructor |
| h:21 | `~onScreenKeyboard()` — destructor |
| h:24 | `void setInitialText(QString str)` |
| h:25 | `void languageChanged(void)` |

**Private slots:**

| Location | Signature |
|---|---|
| h:28 | `void keyboardHandler()` |
| h:29 | `void on_btnShift_clicked(bool checked)` |
| h:30 | `void on_btnEnter_clicked()` |
| h:31 | `void on_btnBack_clicked()` |
| h:32 | `void on_btnCaps_toggled(bool checked)` |
| h:33 | `void on_btnHideKeyboard_clicked()` |
| h:34 | `void on_btnDelete_clicked()` |

**Signals:**

| Location | Signature |
|---|---|
| h:36 | `void updateText(QString str, CtrlButton ctrl)` |
| h:37 | `void onScreenKeyboardClose()` |

**Protected methods:**

| Location | Signature |
|---|---|
| h:40 | `void closeEvent(QCloseEvent *event)` |

**Private methods:**

| Location | Signature |
|---|---|
| h:43 | `void toggle()` |
| h:44 | `QString dualCharCase(QString ch, int toggleState)` |
| h:45 | `QString singleCharCase(QString ch, int toggleState)` |
| h:46 | `void setCaseButton(CaseButton btn, bool set)` |

**Private members:**

- `Ui::onScreenKeyboard *ui` — h:47
- `QString outputText` — h:48
- `QString m_capsStylesheet` — h:49
- `QString m_symbolStylesheet` — h:50
- `QString m_shiftStylesheet` — h:51

**Implementation function line numbers (cpp):**

| Line | Function |
|---|---|
| 5 | `onScreenKeyboard::onScreenKeyboard(QWidget *parent)` |
| 56 | `void onScreenKeyboard::setInitialText(QString str)` |
| 61 | `void onScreenKeyboard::keyboardHandler()` |
| 102 | `onScreenKeyboard::~onScreenKeyboard()` |
| 107 | `void onScreenKeyboard::closeEvent(QCloseEvent *event)` |
| 113 | `void onScreenKeyboard::on_btnShift_clicked(bool checked)` |
| 119 | `QString onScreenKeyboard::singleCharCase(QString ch, int toggleState)` |
| 127 | `QString onScreenKeyboard::dualCharCase(QString ch, int toggleState)` |
| 145 | `void onScreenKeyboard::toggle()` |
| 184 | `void onScreenKeyboard::on_btnEnter_clicked()` |
| 192 | `void onScreenKeyboard::on_btnBack_clicked()` |
| 197 | `void onScreenKeyboard::on_btnCaps_toggled(bool checked)` |
| 202 | `void onScreenKeyboard::on_btnHideKeyboard_clicked()` |
| 209 | `void onScreenKeyboard::setCaseButton(CaseButton btn, bool set)` |
| 243 | `void onScreenKeyboard::on_btnDelete_clicked()` |
| 248 | `void onScreenKeyboard::languageChanged()` |

---

## Findings

---

**A22-1** · HIGH · `onScreenKeyboard` class name violates Qt/C++ naming convention

**Description:** The class is named `onScreenKeyboard` with a lowercase leading letter, which violates the established Qt and C++ convention of PascalCase for class names (e.g., `OnScreenKeyboard`). This is not merely stylistic: the Qt `Q_OBJECT` macro, `moc` toolchain, and IDE tooling all assume PascalCase class names, and the inconsistency creates confusion throughout the codebase. The companion `Ui::onScreenKeyboard` namespace alias and the `.ui` file name also inherit the non-standard casing, making the inconsistency pervasive. Every other class in the codebase (`LockedDialog`, `MessageDialog`, `CommentDialog`, etc.) uses PascalCase.

**Fix:** Rename the class to `OnScreenKeyboard`, update the `.h`, `.cpp`, `.ui`, and all callers accordingly. This is a straightforward mechanical rename; no behavioral changes are required.

---

**A22-2** · HIGH · `enterButton` — uninitialized public raw pointer (undefined behavior on any dereference)

**Description:** `QPushButton *enterButton` is declared as a public data member of `onScreenKeyboard` (h:22) but is never assigned in the constructor or anywhere else in the class implementation. The UI form names the enter button `btnEnter`, accessed internally via `ui->btnEnter`. A grep across the entire source tree shows that no caller ever assigns or dereferences `enterButton`. The pointer therefore holds an indeterminate (garbage) value for the entire lifetime of any `onScreenKeyboard` instance. Any future caller who attempts to use `enterButton` (e.g., to connect a signal) will trigger undefined behavior resulting in a crash or silent data corruption.

**Fix:** Either (a) remove `enterButton` entirely if it is not needed, or (b) assign it in the constructor body: `enterButton = ui->btnEnter;` and document the intended use. If the purpose is to allow callers to connect to the enter button's signals, add a public accessor method `QPushButton* enterButtonWidget() const { return ui->btnEnter; }` and keep the member private.

---

**A22-3** · HIGH · Backslash key emits the text of `Buttonr` instead of a backslash character

**Description:** In `keyboardHandler()` (cpp:75–77), when the pressed button's text is `"\\"`, the handler sets:
```cpp
outputText = ui->Buttonr->text();
```
This emits whatever letter is currently displayed on the `r` key (either `"r"` or `"R"` depending on shift/caps state) instead of a backslash character `"\"`. This is a logic error: the backslash key will never produce a backslash in user input. The likely cause is an erroneous copy-paste from nearby code during development. The `"&&"` special case immediately above it (cpp:72–74) correctly sets `outputText = "&"`, demonstrating the intended pattern was `outputText = "\\"`.

**Fix:** Replace `outputText = ui->Buttonr->text();` with `outputText = "\\";` so that the backslash key emits a backslash character.

---

**A22-4** · MEDIUM · `dualCharCase()` is dead code — defined but never called

**Description:** `QString onScreenKeyboard::dualCharCase(QString ch, int toggleState)` is declared in the header (h:44) and fully implemented in the cpp (cpp:127–143). It contains 10 explicit branches handling the number-row dual-label keys (e.g., `"!\n0"`, `"@\n1"`, etc.). A search of the entire codebase shows it is never invoked. The `toggle()` function only calls `singleCharCase()` for alphabetic keys, and `keyboardHandler()` processes multi-character keys inline without using this helper. The function is therefore completely unreachable dead code.

**Fix:** Remove `dualCharCase()` from both the header and implementation. If the intent was to factor the multi-character key logic out of `keyboardHandler()`, refactor accordingly and connect the call sites.

---

**A22-5** · MEDIUM · `MaintLockedCode` uses arbitrary magic hex values with no documentation

**Description:** The `MaintLockedCode` enum (cigconfigs.h:142–148) assigns non-contiguous magic hexadecimal values to its enumerators (`MaintIdle = 0xea`, `MaintCriticalQuestion = 0xfb`, `MaintRedImpact = 0xfd`, `MaintSurveyTimeout = 0xfe`). These values are used as a `switch` discriminant in `LockedDialog::setLockedReason()` (cpp:38–58) and presumably as wire-protocol or storage codes elsewhere. There is no comment explaining the origin or significance of these values, making it impossible to verify correctness, add new codes safely, or catch encoding mismatches. `MaintNormal = 0x00` is also defined but never handled in the `switch` — it falls through to the `default` case.

**Fix:** Add a comment above the enum explaining the source and semantics of the assigned values (e.g., "values match the protocol byte defined in firmware spec section X"). If `MaintNormal` is a valid expected state, add an explicit `case CIGCONF::MaintNormal:` branch to `setLockedReason()`.

---

**A22-6** · MEDIUM · `SymbolButton` enumerator declared but never used

**Description:** The `CaseButton` enum in `onScreenKeyboard` (h:18) declares four values: `AllButtons`, `CapsButton`, `ShiftButton`, and `SymbolButton`. The `setCaseButton()` implementation (cpp:209–241) handles `CapsButton` and `ShiftButton` explicitly, and `AllButtons` via the `default` branch. `SymbolButton` has no corresponding `case` in the `switch` and is never passed to `setCaseButton()` anywhere in the codebase — it is an entirely dead enumerator that suggests an unimplemented feature was planned but never completed.

**Fix:** Either implement the `SymbolButton` case in `setCaseButton()` and wire up the UI symbol-toggle button, or remove the `SymbolButton` enumerator and any corresponding unused UI elements.

---

**A22-7** · MEDIUM · `PowerOff` movie file path missing `.gif` extension

**Description:** In `MessageDialog::setMessageType()` (cpp:113), the `PowerOff` case sets:
```cpp
m_movie->setFileName(":/image/icons/movie/wait-power-off");
```
Every other case that uses a `QMovie` appends `.gif` to the resource path (e.g., `":/image/icons/movie/wait-ble.gif"`, `":/image/icons/movie/wait-until-restart.gif"`). The missing extension means `QMovie` will fail to load the resource because Qt's resource system uses the exact path as specified, and the file registered in the `.qrc` almost certainly ends in `.gif`. The `PowerOff` dialog will silently display no animation.

**Fix:** Change the path to `":/image/icons/movie/wait-power-off.gif"` (verify the actual resource file name in the `.qrc` manifest and align accordingly).

---

**A22-8** · LOW · Non-standard class naming propagates into `Ui` namespace and `.ui` file

**Description:** Because the class is named `onScreenKeyboard` rather than `OnScreenKeyboard`, the Qt Designer-generated `Ui::onScreenKeyboard` namespace and the `ui_onScreenKeyboard.h` generated file inherit the non-standard casing. This makes it harder for static analysis tools and IDEs to distinguish class names from variable names, and violates the expectation that `Ui::` namespace members match PascalCase class names. (Related to A22-1 but separately observable as a build-artefact quality issue.)

**Fix:** Address as part of the A22-1 rename.

---

**A22-9** · LOW · `LockedDialog` internal timer `m_fullLockTimer` and counter `m_timeCntr` have no encapsulation boundary against misuse via `startTimer()`/`stopTimer()` public API

**Description:** `startTimer()` and `stopTimer()` are public methods (h:24–25) that directly manipulate `m_fullLockTimer`. There is no guard preventing a caller from calling `startTimer()` multiple times, which the implementation partially handles with `!m_fullLockTimer->isActive()` (cpp:26), but `stopTimer()` calls `clearTimerText()` as a side effect (cpp:32–33) which alters UI state. Callers have no way to query whether the timer is active without checking timer internals indirectly. The timer is an implementation detail that leaks into the public API.

**Fix:** Document the preconditions and side effects of `startTimer()` and `stopTimer()` in the header, or refactor the timer management into a single `setTimerActive(bool)` method with clear semantics and no hidden UI side effects.

---

**A22-10** · LOW · `updateFullLock()` post-decrement on `quint32` produces unsigned underflow on final tick

**Description:** The shutdown logic in `updateFullLock()` (cpp:87) uses:
```cpp
if (!m_timeCntr--)
```
This post-decrements `m_timeCntr` after the zero-check. When `m_timeCntr` reaches zero, the condition fires and `stopTimer()` is called — correct. However, because `quint32` is unsigned, the post-decrement on the iteration where `m_timeCntr == 0` wraps `m_timeCntr` to `0xFFFFFFFF` before `stopTimer()` is reached. If `stopTimer()` were ever not called (e.g., due to a future code change), the counter would wrap to a very large value. The comment on cpp:86 ("This will immediately close both relays if Timeout Parameter is zero") also describes a separate edge case: if `fullLockoutTimeout()` returns 0, the first tick immediately fires `fullLockoutTimerEnded`, which is the intended behavior, but the comment does not explain the wrap risk.

**Fix:** Use an explicit comparison: `if (m_timeCntr == 0) { ... } else { m_timeCntr--; setTimeRemaining(m_timeCntr); }` to avoid unsigned wrap and make the zero-timeout edge case explicit.

---

**A22-11** · LOW · `WAIT_AUTH_TIME` and `NOT_AUTH_TIME` are file-scope `#define` macros rather than typed constants

**Description:** `messagedialog.cpp` (cpp:7–8) defines:
```cpp
#define WAIT_AUTH_TIME  10000
#define NOT_AUTH_TIME   5000
```
These are untyped preprocessor macros with no scope, no type safety, and no visibility from the header. They are integer literals (milliseconds) with no documenting comment. Any future inclusion of this translation unit's internal constants in a unit test or via copy-paste will silently use the wrong type (e.g., 32-bit int rather than the `int` expected by `QTimer::start()`).

**Fix:** Replace with `static constexpr int kWaitAuthTimeMs = 10000;` and `static constexpr int kNotAuthTimeMs = 5000;` as private static members of `MessageDialog`, or at minimum as `constexpr` file-scope variables with a `// ms` comment.

---

**A22-12** · LOW · `keyboardHandler()` uses a C-style cast instead of `qobject_cast`

**Description:** `keyboardHandler()` (cpp:63) casts `sender()` using a C-style cast:
```cpp
QPushButton *button = (QPushButton *)sender();
```
All buttons connected to this slot are `QPushButton` instances, so the cast is safe in practice. However, C-style casts bypass Qt's object model and will silently return a corrupt pointer if the slot is ever accidentally connected to a non-`QPushButton` signal source. The Qt-correct pattern is `qobject_cast<QPushButton *>(sender())` which returns `nullptr` on type mismatch and allows a null check.

**Fix:** Replace with:
```cpp
QPushButton *button = qobject_cast<QPushButton *>(sender());
if (!button) return;
```

---

**A22-13** · INFO · `m_symbolStylesheet` member is declared but never read or written in a meaningful way

**Description:** `m_symbolStylesheet` (h:50) is declared as a private `QString` member of `onScreenKeyboard`. It is never assigned and never read anywhere in the implementation. The `SymbolButton` case of `setCaseButton()` is also absent (see A22-6), confirming this field was part of an unimplemented symbol-mode feature. The field adds dead state to every instance.

**Fix:** Remove `m_symbolStylesheet` along with `SymbolButton` as part of the A22-6 cleanup, or implement the symbol mode fully.

---

**A22-14** · INFO · `onScreenKeyboard` constructor has a blank line inside the initializer block (cpp:21–22)

**Description:** Lines 21–22 of `onScreenKeyboard.cpp` contain a blank line in the middle of the `connect()` call sequence inside the constructor body. While harmless, it inconsistently separates the `p` key connection from the rest of the top row (lines 11–20), which may mislead a reader into thinking the blank line has significance. The rest of the constructor groups rows with single blank lines between rows, which is the correct intent.

**Fix:** Remove the extra blank line between the `Buttonp` connection (line 20) and the start of the home-row connections (line 23), or keep one blank line consistently between keyboard rows.

---

## Summary Table

| ID | Severity | Title |
|---|---|---|
| A22-1 | HIGH | `onScreenKeyboard` class name violates Qt/C++ PascalCase convention |
| A22-2 | HIGH | `enterButton` — uninitialized public raw pointer (UB on any dereference) |
| A22-3 | HIGH | Backslash key emits `Buttonr` text instead of `"\\"` — logic error |
| A22-4 | MEDIUM | `dualCharCase()` defined but never called — dead code |
| A22-5 | MEDIUM | `MaintLockedCode` uses undocumented magic hex values |
| A22-6 | MEDIUM | `SymbolButton` enumerator declared but never implemented or used |
| A22-7 | MEDIUM | `PowerOff` movie resource path missing `.gif` extension |
| A22-8 | LOW | Non-standard class casing propagates into `Ui` namespace and generated files |
| A22-9 | LOW | Public `startTimer()`/`stopTimer()` API leaks timer implementation details |
| A22-10 | LOW | `quint32` post-decrement in `updateFullLock()` wraps to `0xFFFFFFFF` on zero tick |
| A22-11 | LOW | `WAIT_AUTH_TIME` / `NOT_AUTH_TIME` are untyped `#define` macros |
| A22-12 | LOW | C-style cast in `keyboardHandler()` should be `qobject_cast` |
| A22-13 | INFO | `m_symbolStylesheet` member is dead state — never assigned or read |
| A22-14 | INFO | Spurious blank line in `onScreenKeyboard` constructor body |

**Totals:** 3 HIGH, 4 MEDIUM, 5 LOW, 2 INFO
