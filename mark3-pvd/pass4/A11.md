# Pass 4 Agent A11 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `main.cpp` (repo root: `C:/Projects/cig-audit/repos/mark3-pvd/main.cpp`)
- `mytranslator.h` (repo root: `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.h`)
- `mytranslator.cpp` (repo root: `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.cpp`)

---

## Reading Evidence

### `main.cpp`

**File purpose:** Application entry point. Initialises the Qt application, installs a key event filter, loads the locale, registers Qt meta-types, starts GPIO configuration via shell commands, creates the main `Dialog` UI, and spins up the `BackgroundWorker` on a dedicated `QThread`.

**Functions / methods:**

| Line | Name | Signature |
|------|------|-----------|
| 24 | `hideBootProgress` | `void hideBootProgress()` |
| 38 | `configureCrashLogging` | `void configureCrashLogging()` |
| 71 | `main` | `int main(int argc, char *argv[])` |

**Types / enums / constants defined:**

| Line | Kind | Name | Value |
|------|------|------|-------|
| 17 | Preprocessor macro (commented out) | `CONSTRAINED_MEMORY_TEST` | — |
| 20 | Preprocessor macro (conditional) | `MEMSZ` | `10*1024*1024` |
| 21 | Static global array (conditional) | `mem` | `static quint8 mem[MEMSZ]` |

**Namespace in scope:** `using namespace EM070;` (line 15)

---

### `mytranslator.h`

**File purpose:** Public interface for the application's translation subsystem. Declares the global `QTranslator` object and all free functions that load, update, query, and remove locale files.

**Functions declared:**

| Line | Name | Signature |
|------|------|-----------|
| 15 | `loadLocalLanguage` | `void loadLocalLanguage(void)` |
| 16 | `updateLocalLanguage` | `void updateLocalLanguage(const QString &arg1)` |
| 17 | `getCurrentLanguage` | `QString getCurrentLanguage(void)` |
| 18 | `queryLanguage` | `int queryLanguage(void)` |
| 19 | `setLanguage` | `int setLanguage(int local)` |
| 20 | `removeTranslator` | `void removeTranslator()` |

**Types / constants defined:**

| Line | Kind | Name | Value |
|------|------|------|-------|
| 11 | `const QString` (non-`inline`, header-level) | `langEnglish` | `"EN"` |
| 12 | `const QString` (non-`inline`, header-level) | `langSpanish` | `"ES"` |
| 14 | `extern` global object | `mTranslator` | `QTranslator` |

---

### `mytranslator.cpp`

**File purpose:** Implementation of the translation subsystem. Manages reading/writing a plain-text `local.dat` file to persist the selected language, and loading the corresponding Qt `.qm` translation file listed in the embedded `lang.dat` resource.

**Functions defined:**

| Line | Name | Notes |
|------|------|-------|
| 15 | `loadLocalLanguage` | Reads `local.dat`, looks up entry in `lang.dat`, installs `mTranslator`. Deletes `local.dat` if language not found. |
| 74 | `updateLocalLanguage` | Looks up language in `lang.dat`, installs `mTranslator`, writes `local.dat`. Removes file on miss. |
| 132 | `getCurrentLanguage` | Returns the two-letter language code for the active locale, defaulting to `langEnglish`. |
| 167 | `queryLanguage` | Maps language string to `QLocale::Language` integer; returns `-1` on unknown. |
| 177 | `setLanguage` | Calls `updateLocalLanguage` if locale differs from current; returns `-1` on unknown locale. |
| 190 | `removeTranslator` | Removes `mTranslator` from the application via `QCoreApplication::removeTranslator`. |

**Types / constants defined:**

| Line | Kind | Name | Value |
|------|------|------|-------|
| 7 | `const QString` (file-scope) | `localFile` | `"local.dat"` |
| 8 | `const QString` (file-scope) | `langFile` | `":/lang.dat"` |
| 10 | Global object definition | `mTranslator` | `QTranslator mTranslator;` |

---

## Findings

---

**A11-1** · MEDIUM · Global `QTranslator` object exposed through a header

**Description:** `mTranslator` is declared `extern` in `mytranslator.h` (line 14) and defined at translation-unit scope in `mytranslator.cpp` (line 10). Every translation unit that includes `mytranslator.h` can read or write the translator directly, bypassing the API. More critically, `QTranslator` inherits `QObject`, and `QObject` instances must not be constructed before `QApplication` exists. Because `mTranslator` is a namespace-scope (pre-`main`) object its constructor runs at static-initialisation time, before `QApplication a(argc, argv)` on line 78 of `main.cpp`. On platforms where Qt's internal state is not yet ready this is undefined behaviour.

**Fix:** Remove the `extern` declaration from the header. Make `mTranslator` a function-local static or a private member of a small `TranslatorManager` singleton initialised after `QApplication`. Expose only the six existing free-function signatures (which are already sufficient for all callers).

---

**A11-2** · LOW · Header-level `const QString` constants cause ODR issues across translation units

**Description:** `langEnglish` and `langSpanish` are defined as `const QString` at namespace scope directly in `mytranslator.h` (lines 11–12). Unlike `const int` or `constexpr`, `QString` is not an integral constant and is not `inline`. Every translation unit that includes this header gets its own definition (though the linker typically merges them under the One-Definition Rule). More important, each TU pays the cost of constructing and destructing a `QString` at static-init and static-deinit time. This is an anti-pattern for Qt applications.

**Fix:** Replace with `constexpr char` arrays or `inline const QString` (Qt 5.10+ / C++17), or move them to a `.cpp`-level `static const`. For example:

```cpp
// mytranslator.h
constexpr char langEnglish[] = "EN";
constexpr char langSpanish[] = "ES";
```

---

**A11-3** · LOW · `configureCrashLogging()` is a fully implemented function that is permanently commented out

**Description:** `configureCrashLogging()` (lines 38–69 of `main.cpp`) is a complete function that writes a shell script to `/mnt/sd/app_monitor` and starts it with `QProcess::startDetached`. Its call site on line 101 is commented out with no associated TODO or bug-reference comment. The function is compiled into the binary but never called, constituting dead code. The embedded shell script also leaks the internal product name `FleetFocus` into the binary image.

**Fix:** If crash-logging monitoring is not required for this release, remove both the function definition and its commented-out call site. If it is intended for a future release, add a JIRA/issue reference in the comment and guard it under an appropriate `#ifdef` (e.g., `#ifdef ENABLE_CRASH_MONITOR`).

---

**A11-4** · LOW · `CONSTRAINED_MEMORY_TEST` dead-code block is compiled in unconditionally (false branch always taken)

**Description:** Lines 17–22 and 102–105 of `main.cpp` define a preprocessor-guarded memory-stress test that allocates a 10 MB static array and locks it with `mlock`. The controlling macro `CONSTRAINED_MEMORY_TEST` is permanently commented out (line 17: `//#define CONSTRAINED_MEMORY_TEST`). The guarded block can never be entered. This is a development artifact that should not remain in the repository on the `master` / release branch.

**Fix:** Remove the `#define`, the `#ifdef` blocks, the static `mem` array, and the `#include <sys/mman.h>` if it is only needed by that block. If the test is still needed, move it to the test project (`mk3-test.pro`) rather than the production build.

---

**A11-5** · LOW · Commented-out GPIO shell command on line 108

**Description:** Line 108 of `main.cpp` contains a commented-out alternative approach for exporting GPIO 37:

```cpp
//int ret = QProcess::execute("echo 37 > /sys/class/gpio/export");
```

The equivalent shell-safe version immediately follows on line 109. The commented-out line is dead code and its stale variable `ret` (which was never checked) also indicates the original implementation was incomplete.

**Fix:** Remove the commented-out line. The active version on line 109 is the correct implementation.

---

**A11-6** · MEDIUM · `QTextStream::setCodec` is deprecated in Qt 5 and removed in Qt 6

**Description:** `setCodec("UTF-8")` is called on every `QTextStream` instance in `mytranslator.cpp` (lines 22, 29, 84, 115, 140, 147). `QTextStream::setCodec(const char *)` was deprecated in Qt 5.15 and removed in Qt 6. The project's `.pro` file (`mk3.pro`, line 30) enables `QT_DEPRECATED_WARNINGS`, meaning every build targeting Qt 5.15+ will emit compiler warnings for these six call sites. There is also a commented-out entry in `mk3.pro` (line 35) suggesting a future migration to Qt 6 has been considered.

**Fix:** Replace with `QTextStream::setEncoding(QStringConverter::Utf8)` (Qt 6 API). If Qt 5 compatibility must be retained, use a version-guarded wrapper:

```cpp
#if QT_VERSION < QT_VERSION_CHECK(6, 0, 0)
    stream.setCodec("UTF-8");
#else
    stream.setEncoding(QStringConverter::Utf8);
#endif
```

---

**A11-7** · LOW · `qsrand` / `qrand` are deprecated Qt APIs

**Description:** `qsrand(QDateTime::currentSecsSinceEpoch())` is called in `main.cpp` line 99. `qsrand` and its companion `qrand` (used in `ui/checkquestiondialog.cpp` line 24) were deprecated in Qt 5.15. They wrap the C `srand`/`rand` functions, which are not thread-safe. With `QT_DEPRECATED_WARNINGS` enabled in `mk3.pro`, these produce build warnings.

**Fix:** Replace with `QRandomGenerator::global()->seed(...)` and `QRandomGenerator::global()->bounded(...)` respectively. Seeding the global generator is optional (it is auto-seeded from the OS); callers should simply call `QRandomGenerator::global()->bounded(n)` in place of `qrand() % n`.

---

**A11-8** · LOW · `endl` manipulator deprecated in Qt 5.15 / Qt 6 context

**Description:** `out << lang << endl;` on line 116 of `mytranslator.cpp` uses Qt's `endl` manipulator (imported via `<QTextStream>`). Qt's `endl` (distinct from `std::endl`) was deprecated in Qt 5.14. With `QT_DEPRECATED_WARNINGS` active, this is a build warning.

**Fix:** Replace with `Qt::endl` (available from Qt 5.14):

```cpp
out << lang << Qt::endl;
```

---

**A11-9** · INFO · Inconsistent naming convention: parameter `arg1` in public API

**Description:** The public function `updateLocalLanguage(const QString &arg1)` (header line 16, implementation line 74) uses the auto-generated Qt slot parameter name `arg1` rather than a descriptive name. All other parameters in the file use meaningful names (`lang`, `local`, `filename`). This reduces readability and is inconsistent with the rest of the codebase.

**Fix:** Rename the parameter to something descriptive, for example `languageCode` or `langCode`, in both the header declaration and the implementation.

---

**A11-10** · INFO · `loadLocalLanguage` closes `local` in only one branch; open file may be leaked on error path

**Description:** In `loadLocalLanguage` (lines 55–63 of `mytranslator.cpp`), the `QFile local` is closed only in the `isFound == true` branch. In the `isFound == false` branch the file is deleted via `local.remove()`. `QFile::remove()` does implicitly close on some Qt versions, but this behaviour is undocumented as guaranteed and differs from the explicit `close()` in the success path, creating an inconsistency that makes correctness reasoning harder.

**Fix:** Call `local.close()` unconditionally before the `if(isFound)` block, then call `local.remove()` in the false branch. This matches the pattern used in `updateLocalLanguage` (line 124) and makes the control flow symmetrical.

---

**A11-11** · INFO · `gCfg` macro defined in included header creates a leaky abstraction in `globalconfigs.h`

**Description:** `globalconfigs.h` (line 13) defines:

```cpp
#define gCfg GlobalConfigs::instance()
```

This macro is included transitively by a large portion of the codebase. Every call site that writes `gCfg->someMethod()` expands to `GlobalConfigs::instance()->someMethod()`, silently calling the singleton accessor on every use. Although this is not directly in the audited files, `main.cpp` pulls it in through `app/backgroundworker.h`. The macro hides the singleton pattern, prevents IDE navigation and refactoring, and makes it impossible to inject a mock for unit testing.

**Fix:** Remove the macro. Provide a named free function `GlobalConfigs *globalConfigs()` (or simply use `GlobalConfigs::instance()` at call sites). Where unit-testability is required, pass the instance as a constructor parameter.

---

## Summary Table

| ID | Severity | Title |
|----|----------|-------|
| A11-1 | MEDIUM | Global `QTranslator` object exposed through a header (pre-`QApplication` construction risk) |
| A11-2 | LOW | Header-level `const QString` constants — ODR concern and static-init overhead |
| A11-3 | LOW | `configureCrashLogging()` fully implemented but permanently commented out (dead code) |
| A11-4 | LOW | `CONSTRAINED_MEMORY_TEST` dead-code block left in production branch |
| A11-5 | LOW | Commented-out GPIO shell command on line 108 of `main.cpp` |
| A11-6 | MEDIUM | `QTextStream::setCodec` deprecated (Qt 5.15) / removed (Qt 6) — 6 call sites |
| A11-7 | LOW | `qsrand` / `qrand` deprecated in Qt 5.15; not thread-safe |
| A11-8 | LOW | `endl` manipulator deprecated in Qt 5.14 |
| A11-9 | INFO | Opaque parameter name `arg1` in public API `updateLocalLanguage` |
| A11-10 | INFO | `loadLocalLanguage` closes `QFile local` only in the success branch |
| A11-11 | INFO | `gCfg` macro in `globalconfigs.h` leaks singleton pattern across codebase |
