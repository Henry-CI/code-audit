# Pass 4 Agent A23 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Repo root:** C:/Projects/cig-audit/repos/mark3-pvd
**Assigned files:**
- `ui/ondemanddialog.h` + `ui/ondemanddialog.cpp`
- `ui/optionalcheckconfirmationdialog.h` + `ui/optionalcheckconfirmationdialog.cpp`
- `ui/pindialog.h` + `ui/pindialog.cpp`

---

## Reading Evidence

### `ui/ondemanddialog.h`

**Class:** `OnDemandDialog` (extends `QDialog`)

**Methods / line numbers:**

| Line | Signature | Notes |
|------|-----------|-------|
| 20 | `explicit OnDemandDialog(QWidget *parent = 0)` | Constructor |
| 21 | `~OnDemandDialog()` | Destructor |
| 23 | `void setSuperMasterId(quint64 id)` | Inline setter |
| 24 | `void reset()` | Public reset |
| 25 | `void setTimeRemaining(quint32 secs)` | Public updater |
| 26 | `QString showCustomTimeFormat(quint32 time)` | Public utility |
| 29 | `void onDemandStarted(quint32, quint32, quint64, CIGCONF::OnDemandCmdSrc)` | Signal |
| 30 | `void onDemandExtended(quint32, quint32, quint64, CIGCONF::OnDemandCmdSrc)` | Signal |
| 31 | `void onDemandEnded(quint32, quint64, CIGCONF::OnDemandCmdSrc)` | Signal |
| 34 | `void showEvent(QShowEvent *event = 0)` | Protected override |
| 36 | `void onStart()` | Protected slot |
| 37 | `void onExtend()` | Protected slot |
| 38 | `void onEnd()` | Protected slot |
| 41 | `bool debounce()` | Private helper |

**Members:**

| Line | Name | Type |
|------|------|------|
| 42 | `ui` | `Ui::OnDemandDialog *` |
| 44 | `m_timer` | `QTimer *` |
| 45 | `m_lastPress` | `quint32` |
| 46 | `m_smId` | `quint64` |

**Types / constants defined:** None directly; uses `CIGCONF::OnDemandCmdSrc` from `app/cigconfigs.h`.

---

### `ui/ondemanddialog.cpp`

**Methods / line numbers:**

| Line | Signature |
|------|-----------|
| 9 | `OnDemandDialog::OnDemandDialog(QWidget *parent)` |
| 26 | `OnDemandDialog::~OnDemandDialog()` |
| 31 | `void OnDemandDialog::showEvent(QShowEvent *event)` |
| 57 | `void OnDemandDialog::onStart()` |
| 74 | `void OnDemandDialog::onExtend()` |
| 91 | `void OnDemandDialog::onEnd()` |
| 106 | `bool OnDemandDialog::debounce()` |
| 117 | `void OnDemandDialog::reset()` |
| 123 | `QString OnDemandDialog::showCustomTimeFormat(quint32 time)` |
| 131 | `void OnDemandDialog::setTimeRemaining(quint32 secs)` |

**Constants defined:**

| Line | Name | Value |
|------|------|-------|
| 7 | `NO_ACTIVITY_TIME` | `10000` (ms) |

---

### `ui/optionalcheckconfirmationdialog.h`

**Class:** `OptionalCheckConfirmationDialog` (extends `QDialog`)

**Methods / line numbers:**

| Line | Signature | Notes |
|------|-----------|-------|
| 15 | `explicit OptionalCheckConfirmationDialog(QWidget *parent = 0)` | Constructor |
| 16 | `~OptionalCheckConfirmationDialog()` | Destructor |
| 17 | `void onRefreshLanguage(void)` | Public language refresh |
| 24 | `void hideEvent(QHideEvent *)` | Protected override |
| 25 | `void showEvent(QShowEvent *event = 0)` | Protected override |

**Members:**

| Line | Name | Type |
|------|------|------|
| 20 | `ui` | `Ui::OptionalCheckConfirmationDialog *` |
| 21 | `m_timer` | `QTimer *` |

**Types / constants defined:** None.

---

### `ui/optionalcheckconfirmationdialog.cpp`

**Methods / line numbers:**

| Line | Signature |
|------|-----------|
| 6 | `OptionalCheckConfirmationDialog::OptionalCheckConfirmationDialog(QWidget *parent)` |
| 19 | `void OptionalCheckConfirmationDialog::showEvent(QShowEvent *event)` |
| 31 | `void OptionalCheckConfirmationDialog::hideEvent(QHideEvent *)` |
| 36 | `OptionalCheckConfirmationDialog::~OptionalCheckConfirmationDialog()` |
| 41 | `void OptionalCheckConfirmationDialog::onRefreshLanguage(void)` |

**Constants / magic numbers:**

| Line | Value | Meaning |
|------|-------|---------|
| 28 | `5000` | Dialog auto-dismiss timeout (ms), bare literal in `m_timer->start(5000)` |

---

### `ui/pindialog.h`

**Class:** `PinDialog` (extends `QDialog`)

**Methods / line numbers:**

| Line | Signature | Notes |
|------|-----------|-------|
| 17 | `explicit PinDialog(QWidget *parent = 0)` | Constructor |
| 18 | `~PinDialog()` | Destructor |
| 20 | `quint32 pinCode() const` | Public — returns raw PIN digits as integer |
| 21 | `void clearPinCode()` | Public |
| 22 | `void languageChanged()` | Public |
| 25 | `void showEvent(QShowEvent *)` | Protected override |
| 26 | `void hideEvent(QHideEvent *)` | Protected override |
| 29 | `void keyPressed()` | Private slot |

**Members:**

| Line | Name | Type |
|------|------|------|
| 31 | `ui` | `Ui::PinDialog *` |
| 32 | `m_timer` | `QTimer *` |

**Types / constants defined:** None in header.

---

### `ui/pindialog.cpp`

**Methods / line numbers:**

| Line | Signature |
|------|-----------|
| 12 | `PinDialog::PinDialog(QWidget *parent)` |
| 42 | `PinDialog::~PinDialog()` |
| 47 | `void PinDialog::keyPressed()` |
| 87 | `void PinDialog::hideEvent(QHideEvent *)` |
| 92 | `void PinDialog::showEvent(QShowEvent *)` |
| 97 | `quint32 PinDialog::pinCode() const` |
| 112 | `void PinDialog::clearPinCode()` |
| 118 | `void PinDialog::languageChanged()` |

**Constants defined:**

| Line | Name | Value |
|------|------|-------|
| 9 | `PIN_MAX_LENGTH` | `5` |
| 10 | `ACTIVITY_TIME` | `30000` (ms) |

---

## Findings

---

**A23-1** · MEDIUM · `onEnd()` updates `m_lastPress` redundantly after `debounce()` already did so

**Description:** In `ondemanddialog.cpp`, the `debounce()` helper (line 106–115) already assigns `m_lastPress = now` before returning `true`. However, `onEnd()` (line 103) then assigns `m_lastPress = gCfg->clockTime()` a second time unconditionally, after the timer restart. This redundant write is absent in `onStart()` (line 57–72) and `onExtend()` (line 74–89), making the three handlers inconsistent. The double-write is harmless in isolation but indicates a copy-paste omission during `onEnd()` authoring and could confuse future maintainers about the debounce contract.

**Fix:** Remove the redundant `m_lastPress = gCfg->clockTime();` assignment at `ondemanddialog.cpp:103`. The debounce pattern for all three action handlers should be identical: call `debounce()`, act on button state, restart `m_timer`.

---

**A23-2** · MEDIUM · `onStart()` and `onExtend()` omit the post-action `m_lastPress` update, while `onEnd()` has it — asymmetric debounce state

**Description:** As a direct consequence of A23-1, `onStart()` and `onExtend()` do not explicitly refresh `m_lastPress` after completing their action, whereas `onEnd()` does. Because `debounce()` already updates `m_lastPress`, the behaviour is identical in practice for all three handlers. The asymmetry creates a false implication that `onEnd()` requires special cooldown handling that `onStart()`/`onExtend()` do not, which is misleading to anyone reading the code.

**Fix:** Adopt a single, consistent style: either rely entirely on `debounce()` to maintain `m_lastPress` (recommended — remove the stray line in `onEnd()`) or have all three handlers refresh it explicitly after the action block. The former matches the pattern used by `AuthorisedDialog`, `SupervisorDialog`, and `CommentDialog` in the same codebase.

---

**A23-3** · MEDIUM · `reset()` calls `showEvent()` directly, bypassing the Qt event system

**Description:** `ondemanddialog.cpp:120` calls `showEvent()` directly as a regular C++ function call rather than allowing Qt to emit the event naturally. `showEvent()` is documented in Qt as a virtual event handler that Qt dispatches; calling it directly couples `reset()` to the current implementation of `showEvent()` and will silently bypass any base-class behaviour in `QDialog::showEvent()`. While the immediate `showEvent()` body does not call `QDialog::showEvent(event)` itself (and so passes `nullptr`/`0` for the default-argument `event = 0`), the pattern is fragile: if `showEvent()` is ever updated to call `event->accept()` or similar, the null pointer will cause undefined behaviour.

**Fix:** Replace the direct call with the intended side-effects: extract the state-reset logic in `showEvent()` into a private `refreshUi()` helper and call that helper from both `showEvent()` and `reset()`. This is the pattern used elsewhere (e.g., `languageChanged()` / `onRefreshLanguage()`).

---

**A23-4** · MEDIUM · `onStart()` and `onExtend()` action handlers are `protected`, not `private`

**Description:** `ondemanddialog.h` (lines 36–38) declares `onStart()`, `onExtend()`, and `onEnd()` in the `protected` section. These three methods are pure internal slot handlers connected to button clicks in the constructor; they are not intended to be overridden or called by subclasses. Across the rest of the UI layer, comparable button-click slots (`rstLogout`, `onLogoutRequest` in `AuthorisedDialog`; language selection slots in `LanguageDialog`; confirm-action slots in `SupervisorDialog`) are uniformly placed in `private` or `private slots`. Declaring them `protected` widens the interface unnecessarily and exposes authentication-sensitive actions (start/extend/end an on-demand session) to subclass override.

**Fix:** Move `onStart()`, `onExtend()`, and `onEnd()` into the `private` section (or a `private slots:` subsection) of `OnDemandDialog`. No callers outside the class exist.

---

**A23-5** · MEDIUM · `PIN_MAX_LENGTH` defined in `.cpp` is not used; actual limit comes from the UI designer's `maxLength` property

**Description:** `pindialog.cpp:9` defines `#define PIN_MAX_LENGTH 5`, but `keyPressed()` (line 64) reads the PIN length limit from `ui->lineEdit->maxLength()` — a value set in the Qt Designer `.ui` file — and stores it in a local variable `maxLength`. The `PIN_MAX_LENGTH` macro is never referenced anywhere in `pindialog.cpp` or anywhere else in the codebase. This means the true maximum PIN length is controlled by a property embedded in a binary `.ui` resource, invisible in code review and not enforced by the named constant. If a developer changes `PIN_MAX_LENGTH` expecting the dialog to enforce a different length, nothing changes at runtime.

**Fix:** Either (a) remove `#define PIN_MAX_LENGTH 5` entirely and document in a comment that `ui->lineEdit->maxLength()` is the authoritative source set in the `.ui` designer file, or (b) enforce `PIN_MAX_LENGTH` at runtime by calling `ui->lineEdit->setMaxLength(PIN_MAX_LENGTH)` in the constructor and removing the reliance on the designer property for this security-relevant limit. Option (b) is strongly preferred because it makes the PIN length constraint visible and auditable in code.

---

**A23-6** · LOW · `static` local variable used for debounce in `PinDialog::keyPressed()` instead of a member variable

**Description:** `pindialog.cpp:51` uses `static quint64 last = 0;` for debouncing key presses. Using function-level `static` variables means the debounce state is shared across all instances of `PinDialog` (if more than one were ever created) and is never reset when a `PinDialog` instance is destroyed and recreated. Every other dialog in the codebase that implements debouncing (`OnDemandDialog`, `AuthorisedDialog`, `SupervisorDialog`, `CommentDialog`, `LanguageDialog`) uses an instance-level member variable `m_lastPress`. The inconsistency also means the debounce state persists across separate invocations of the same `PinDialog` instance, potentially causing the very first key press of a new session to be silently dropped if the dialog is shown shortly after the previous dismissal.

**Fix:** Replace the `static` local with a member variable `quint64 m_lastPress` (consistent with the rest of the codebase), initialise it to `0` in the constructor, and reset it in `clearPinCode()` or `showEvent()`. Change the type from `quint64` to `quint32` for consistency with `m_lastPress` elsewhere, or confirm that `clockTime()` returns a value requiring 64-bit range.

---

**A23-7** · LOW · `showCustomTimeFormat()` is public but is only a display-formatting helper

**Description:** `ondemanddialog.h:26` declares `showCustomTimeFormat(quint32 time)` as `public`. The method is a pure formatting utility that converts a second-count to `HH:MM:SS` string. It is only called from within `OnDemandDialog::setTimeRemaining()` (cpp:136) and from `Dialog::showCustomTimeFormat()` (a separately defined duplicate in `dialog.cpp:1249`). Making it `public` unnecessarily enlarges the class API surface and duplicates a utility that already exists in `Dialog`. The name itself is also misleading: the verb "show" implies a side-effecting display operation, whereas the method is a pure computation returning a `QString`.

**Fix:** Change the visibility to `private` (it has no external callers on `OnDemandDialog` objects). Rename to `formatDuration()` or `secondsToTimeString()` to accurately reflect its pure-function nature. Consider whether the duplicate in `Dialog` should be unified into a shared static helper.

---

**A23-8** · LOW · `onRefreshLanguage()` in `OptionalCheckConfirmationDialog` duplicates `showEvent()` body verbatim

**Description:** `optionalcheckconfirmationdialog.cpp:41–48` (`onRefreshLanguage()`) is a character-for-character copy of the UI text-setting block in `showEvent()` (lines 22–28). Any future change to the dialog's display strings must be made in two places. The `showEvent()` body does not call `onRefreshLanguage()`, so the two copies can drift. This is a classic DRY violation. The corresponding pattern in other dialogs (e.g., `LockedDialog::languageChanged()`, `PinDialog::languageChanged()`) correctly calls into a single update method.

**Fix:** In `showEvent()`, replace the text-setting block with a call to `onRefreshLanguage()`, leaving only `m_timer->start(5000)` as the additional line in `showEvent()`. This ensures a single source of truth for the display strings.

---

**A23-9** · LOW · Magic number `5000` in `OptionalCheckConfirmationDialog::showEvent()`

**Description:** `optionalcheckconfirmationdialog.cpp:28` calls `m_timer->start(5000)` with an unexplained bare integer. The inline comment (`// wait 5 second before closing the dialog`) partially explains the intent, but the value is not given a named constant. Every other dialog in the same directory that uses a similar auto-dismiss timer defines a named macro (`NO_ACTIVITY_TIME`, `ACTIVITY_TIME`, `RESET_TIMEOUT`, `WAIT_AUTH_TIME`). The magic number is inconsistent with established style and makes future adjustment of the timeout harder to locate.

**Fix:** Add `#define ACTIVITY_TIME 5000` (or an appropriately named constant) at the top of the `.cpp` file and replace the literal with the constant, consistent with the style of `ondemanddialog.cpp`, `pindialog.cpp`, and `supervisordialog.cpp`.

---

**A23-10** · LOW · Unused `#include <QDebug>` in `optionalcheckconfirmationdialog.cpp`

**Description:** `optionalcheckconfirmationdialog.cpp:4` includes `<QDebug>`, but no `qDebug()` call or `QDebug` usage appears anywhere in the file. This is a leftover from a development or debugging session. Unnecessary includes slow incremental builds and signal to auditors and maintainers that debug instrumentation may have been removed without cleanup.

**Fix:** Remove `#include <QDebug>` from `optionalcheckconfirmationdialog.cpp`.

---

**A23-11** · LOW · Unused `#include <QThread>` in `pindialog.cpp`

**Description:** `pindialog.cpp:6` includes `<QThread>`, but no `QThread` symbol is used anywhere in the file. Like the `QDebug` issue above, this is dead include residue, likely left over from an earlier implementation attempt. The comment at line 49–51 mentions an application-wide event filter was considered ("Tried application wide event filter") — the `QThread` include may be a remnant of that approach.

**Fix:** Remove `#include <QThread>` from `pindialog.cpp`.

---

**A23-12** · LOW · Unused `#include <QDebug>` in `pindialog.cpp`

**Description:** `pindialog.cpp:4` includes `<QDebug>`, but no `qDebug()` or `QDebug` reference exists anywhere in the file.

**Fix:** Remove `#include <QDebug>` from `pindialog.cpp`.

---

**A23-13** · LOW · `showCustomTimeFormat()` uses signed `qint32` for hour/minute/second decomposition of `quint32` input

**Description:** `ondemanddialog.cpp:124–126` declares `h`, `m`, and `s` as `qint32` while computing from a `quint32` input. For very large values of `time` (near `UINT32_MAX`, approximately 4.29 billion seconds / ~136 years), the division `time/3600` yields a value of up to ~1,193,046 — well within `qint32` range — so no actual overflow occurs in practice. However, the intermediate computation `time - (3600*h)` on line 125 passes a `qint32` value (`h`) back into arithmetic with `quint32` (`time`), which involves an implicit signed/unsigned conversion. Additionally, `3600*h` with a `qint32` `h` is evaluated as signed multiplication where `3600 * 1193046` = ~4.295 billion, which overflows `qint32` (max ~2.147 billion). This causes undefined behaviour for the intermediate expression when `time` is near `UINT32_MAX`. While such values are operationally implausible for a remaining-session timer, the type mismatch is a latent code quality defect.

**Fix:** Declare `h`, `m`, and `s` as `quint32` to match the input type and eliminate implicit signed/unsigned conversion warnings:
```cpp
quint32 h = time / 3600;
quint32 m = (time - (3600 * h)) / 60;
quint32 s = time - (3600 * h) - (m * 60);
```

---

**A23-14** · INFO · `QApplication::processEvents()` call in `PinDialog::keyPressed()` is a code smell

**Description:** `pindialog.cpp:82` calls `QApplication::processEvents()` before `accept()` when the PIN reaches maximum length. The comment (lines 75–78) explains that this is needed to repaint the asterisk mask label before the dialog closes. Calling `processEvents()` from within a slot is generally considered a code smell in Qt: it can cause re-entrant event delivery, unexpected signal emission, and unpredictable widget state during the interim event processing. The correct Qt idiom is to use a zero-delay `QTimer::singleShot(0, this, &PinDialog::accept)` instead, which defers `accept()` to the next event loop iteration after the current event processing completes, ensuring the repaint happens naturally.

**Fix:** Replace:
```cpp
QApplication::processEvents();
accept();
```
with:
```cpp
QTimer::singleShot(0, this, &PinDialog::accept);
```
This allows Qt to process the pending repaint event before triggering the dialog close, without the risks of synchronous re-entrant event dispatch.

---

**A23-15** · INFO · `showEvent(QShowEvent *event = 0)` default-argument pattern inconsistent with newer Qt style

**Description:** `ondemanddialog.h:34` and `optionalcheckconfirmationdialog.h:25` declare `showEvent` with a default argument `= 0`. This is an older Qt4-era style. Other dialogs in the same directory (`pindialog.h:25`, `authoriseddialog.h:33`) correctly declare `showEvent(QShowEvent *)` without a default argument, matching the base class signature. The default-argument form is not wrong — Qt will dispatch the event correctly — but it is inconsistent and can mislead readers into thinking the function can legitimately be called with no argument (which is what `reset()` in `ondemanddialog.cpp:120` exploits, passing a null pointer to `event`). This connects back to A23-3.

**Fix:** Remove the `= 0` default argument from all `showEvent` and `hideEvent` declarations in the assigned files to match the Qt base-class signature and codebase majority style.

---

## Summary Table

| ID | Severity | File | Line(s) | Title |
|----|----------|------|---------|-------|
| A23-1 | MEDIUM | `ondemanddialog.cpp` | 103 | Redundant `m_lastPress` update in `onEnd()` after `debounce()` already wrote it |
| A23-2 | MEDIUM | `ondemanddialog.cpp` | 57–104 | Asymmetric debounce state: `onEnd()` extra update absent in `onStart()`/`onExtend()` |
| A23-3 | MEDIUM | `ondemanddialog.cpp` | 120 | `reset()` calls `showEvent()` directly, passing implicit null event pointer |
| A23-4 | MEDIUM | `ondemanddialog.h` | 36–38 | Action handlers `onStart/onExtend/onEnd` declared `protected` instead of `private` |
| A23-5 | MEDIUM | `pindialog.cpp` | 9, 64 | `PIN_MAX_LENGTH` defined but never used; actual limit is the UI designer property |
| A23-6 | LOW | `pindialog.cpp` | 51 | `static` local for debounce instead of instance member — inconsistent with all other dialogs |
| A23-7 | LOW | `ondemanddialog.h` | 26 | `showCustomTimeFormat()` is `public` but is a private formatting utility |
| A23-8 | LOW | `optionalcheckconfirmationdialog.cpp` | 22–28, 43–48 | `onRefreshLanguage()` duplicates `showEvent()` body verbatim — DRY violation |
| A23-9 | LOW | `optionalcheckconfirmationdialog.cpp` | 28 | Magic number `5000` instead of named constant for auto-dismiss timeout |
| A23-10 | LOW | `optionalcheckconfirmationdialog.cpp` | 4 | Unused `#include <QDebug>` |
| A23-11 | LOW | `pindialog.cpp` | 6 | Unused `#include <QThread>` |
| A23-12 | LOW | `pindialog.cpp` | 4 | Unused `#include <QDebug>` |
| A23-13 | LOW | `ondemanddialog.cpp` | 124–126 | Signed `qint32` used for `quint32` decomposition; potential UB for extreme inputs |
| A23-14 | INFO | `pindialog.cpp` | 82–83 | `QApplication::processEvents()` in slot is a re-entrancy code smell |
| A23-15 | INFO | `ondemanddialog.h`, `optionalcheckconfirmationdialog.h` | 34, 25 | `showEvent(QShowEvent *event = 0)` default-argument inconsistent with Qt style and base class |
