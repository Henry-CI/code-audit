# Pass 4 Agent A06 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `comm/bleexpansion.h`
- `comm/bleexpansion.cpp`
- `comm/bleexpansionuuid.h`
- `comm/bleexpansionuuid.cpp` (companion definition file, read for full context)

---

## Reading Evidence

### `comm/bleexpansion.h`

**Class:** `BleExpansion` (inherits `QObject`)

| Function / Method | Line | Visibility |
|---|---|---|
| `explicit BleExpansion(EM070::BleCentral *bleCentral)` | 32 | public |
| `void setEnabled(bool enable)` | 34 | public |
| `const QByteArray &deviceName() const` | 36 | public inline |
| `const QByteArray &bleVersion() const` | 37 | public inline |
| `const QByteArray &mainVersion() const` | 38 | public inline |
| `const QByteArray &manufacture() const` | 39 | public inline |
| `const QByteArray &modelNumber() const` | 40 | public inline |
| `bool digitalInput(CIGCONF::BleExpansionDI di) const` | 42 | public inline |
| `bool relayOutput(CIGCONF::BleExpansionRelay relay) const` | 44–46 | public inline |
| `void setRelayOutput(CIGCONF::BleExpansionRelay relay, bool state)` | 47 | public |
| `void setShockThreshold(quint32 threshold)` | 49 | public |
| `void setShockPeriod(quint32 period)` | 50 | public |
| `bool isShockQueueEmpty()` | 52 | public inline |
| `ShockEvent shockEvent()` | 53 | public inline |
| `void setCurrentTime(const QDateTime &time)` | 55 | public |
| `bool generateShockMessage(bool force)` | 57 | public |
| `void accessible(bool yes)` *(signal)* | 60 | signal |
| `void inputStateChanged(CIGCONF::BleExpansionDI input, bool state)` *(signal)* | 61 | signal |
| `void shockOccurred()` *(signal)* | 62 | signal |
| `void amberImpactOccurred()` *(signal)* | 63 | signal |
| `void redImpactOccurred()` *(signal)* | 64 | signal |
| `void timerEvent(QTimerEvent *)` | 67 | protected override |
| `void setAccessible(bool yes)` | 103 | private |
| `void readDeviceInfo()` | 104 | private |
| `void resetInputTimer()` | 105 | private |
| `void resetOutput()` | 106 | private |
| `void initRelays()` | 107 | private |
| `void clearShockEvent()` | 108 | private |
| `void popShockEvent(const QByteArray &ba)` | 109 | private |
| `void allowShockCountNotify(bool yes)` | 110 | private |
| `void characteristicRead(const quint128 &uuid, const QByteArray &ba)` | 111 | private |
| `void characteristicWritten(const quint128 &uuid, const QByteArray &ba)` | 112 | private |
| `void descriptorRead(const quint128 &uuid, const QByteArray &ba)` | 113 | private |
| `void descriptorWritten(const quint128 &uuid, const QByteArray &ba)` | 114 | private |

**Types / Unions / Nested structs defined in `bleexpansion.h`:**

| Name | Kind | Lines |
|---|---|---|
| `BleExpansion::ShockEvent` | nested struct | 27–30 |
| `BleExpansion::RtcTime` | private union (char[10] + packed struct) | 71–83 |
| `BleExpansion::WritePending` | private union (quint32 + bitfield struct) | 85–101 |

**Member variables:** `m_bleCentral`, `m_timerId`, `m_accessible`, `m_shockCountNotifyEnabled`, `m_pending`, `m_previousPending`, `m_deviceName`, `m_bleVersion`, `m_mainVersion`, `m_manufacture`, `m_modelNumber`, `m_shockMaxMagnitude`, `m_digitalInput[4]`, `m_outputRelay[2]`, `m_shockThreshold`, `m_shockPeriod`, `m_shockTimestamp`, `m_shockEvent1`, `m_readingShocks`, `m_shockEvents`, `m_popTimer`.

---

### `comm/bleexpansionuuid.h`

**Class:** `BleExpansionUuid` (utility/namespace-like class, no base)

| Function / Method | Line | Visibility |
|---|---|---|
| `static inline bool equals128(const quint128 *v1, const quint128 *v2)` | 9–17 | public static inline |

**Static data members (all `private static quint128`):**

`authUuid` (20), `deviceName` (21), `appearance` (22), `bleVersion` (23), `mainVersion` (24), `manufactureName` (25), `modelNumber` (26), `currentRtc` (27), `inputTimerReset` (28), `inputD0`–`inputD3` (29–32), `inputPullUp0`–`inputPullUp3` (33–36), `outputReset` (37), `outputRelay0`–`outputRelay1` (38–39), `relay0Timeout`–`relay1Timeout` (40–41), `outputD0`–`outputD3` (42–45), `openCollector0`–`openCollector3` (46–49), `shockCount` (50), `shockPeek` (51), `shockPop` (52), `shockThreshold` (53), `shockPeriod` (54), `shockMaxMagnitude` (55), `shockCountNotifyDesc` (56).

**Friend declaration:** `friend class BleExpansion;` (line 58).

---

### `comm/bleexpansion.cpp`

**Preprocessor macros defined:**

| Macro | Value | Line |
|---|---|---|
| `AUTH_CODE` | `"uS8MgpklMx"` | 9 |
| `MAX_SHOCK_COUNT` | `10000` | 11 |
| `RELAY1_TIMEOUT` | `60` | 12 |
| `RELAY2_TIMEOUT` | `60` | 13 |

**Function definitions (line numbers are the definition start):**

| Function | Line |
|---|---|
| `BleExpansion::BleExpansion` (constructor) | 17 |
| `BleExpansion::timerEvent` | 43 |
| `BleExpansion::setEnabled` | 76 |
| `BleExpansion::setAccessible` | 81 |
| `BleExpansion::setRelayOutput` | 114 |
| `BleExpansion::readDeviceInfo` | 140 |
| `BleExpansion::setCurrentTime` | 154 |
| `BleExpansion::resetInputTimer` | 175 |
| `BleExpansion::resetOutput` | 184 |
| `BleExpansion::clearShockEvent` | 193 |
| `BleExpansion::popShockEvent` | 200 |
| `BleExpansion::generateShockMessage` | 237 |
| `BleExpansion::setShockThreshold` | 254 |
| `BleExpansion::initRelays` | 265 |
| `BleExpansion::setShockPeriod` | 289 |
| `BleExpansion::allowShockCountNotify` | 300 |
| `BleExpansion::characteristicRead` | 308 |
| `BleExpansion::characteristicWritten` | 427 |
| `BleExpansion::descriptorRead` | 508 |
| `BleExpansion::descriptorWritten` | 518 |

---

## Findings

---

**A06-1** · HIGH · `descriptorRead` is implemented but never connected

**Description:** `BleExpansion::descriptorRead` is declared at header line 113 and implemented at `bleexpansion.cpp` line 508. However, the constructor (lines 29–34) only connects four `BleCentral` signals: `characteristicChanged`, `characteristicRead`, `characteristicWritten`, `descriptorWritten`, and `accessible`. There is no `connect` call for `BleCentral::descriptorRead`. The `descriptorRead` slot is therefore dead — it can never be invoked at runtime. The `m_shockCountNotifyEnabled` flag that depends on it (lines 511–514) can therefore only ever be set through `descriptorWritten`, and the `descriptorRead` path is silently unreachable. This is both dead code and a latent bug if the read path is ever relied upon.

**Fix:** Either add `connect(m_bleCentral, &BleCentral::descriptorRead, this, &BleExpansion::descriptorRead);` in the constructor, or remove the `descriptorRead` method entirely if only the write confirmation path is needed.

---

**A06-2** · HIGH · `allowShockCountNotify` is defined but never called

**Description:** `BleExpansion::allowShockCountNotify(bool yes)` is declared private (header line 110) and implemented at `bleexpansion.cpp` line 300. A full search of the repository finds no call site for this function. The `m_shockCountNotifyEnabled` flag it manages is also never read from outside the notification-descriptor callbacks. The BLE CCCD notification path for `shockCount` is therefore permanently disabled, meaning the firmware relies entirely on polling (the 1-second timer) to detect shock events rather than the notification mechanism that was apparently planned.

**Fix:** Either wire `allowShockCountNotify` into the `setAccessible(true)` path and handle the resulting `characteristicChanged` notifications, or remove the method and the `m_shockCountNotifyEnabled` member to reflect the chosen polling design.

---

**A06-3** · HIGH · `resetInputTimer` and `resetOutput` are defined but never called

**Description:** Both `BleExpansion::resetInputTimer()` (header line 105, impl line 175) and `BleExpansion::resetOutput()` (header line 106, impl line 184) are private methods with no call sites anywhere in the repository. The `WritePending` bitfield contains corresponding bits `inputTimerReset` (bit 1) and `outputReset` (bit 6) that are set inside these methods, but because the methods are never invoked, those bits are permanently zero and their acknowledgement branches in `characteristicWritten` (lines 494–504) are also unreachable dead code.

**Fix:** Remove both methods and their corresponding `WritePending` bitfield entries, or document and implement the conditions under which they should be triggered.

---

**A06-4** · MEDIUM · Commented-out code block in `initRelays` (lines 284–286)

**Description:** Three lines of commented-out code appear at the end of `initRelays`:

```cpp
//m_pending.bitMap.outputRelay = 1;
//        m_bleCentral->writeCharacteristic(BleExpansionUuid::outputRelay0, ba);
//        SerialLogger::log(QString("[EXPMOD:RLY] Relay 1 %1\r\n").arg(state?"closed":"opened").toLatin1());
```

These lines were replaced by the `setRelayOutput` calls on lines 281–282 but left in place. The fragment is also syntactically incomplete (references `ba` and `state` that are out of scope at that point), meaning it could not even be uncommented without further edits.

**Fix:** Delete the three commented-out lines.

---

**A06-5** · MEDIUM · `MAX_SHOCK_COUNT` macro defined but never used

**Description:** `#define MAX_SHOCK_COUNT 10000` appears at `bleexpansion.cpp` line 11. No usage of this constant exists anywhere in the file or the wider codebase. The `m_shockEvents` queue is unbounded; the hardware shock counter is a 16-bit value read from a BLE characteristic. It is unclear whether this constant was intended as a queue size cap or as a guard in `popShockEvent`. Its presence without use is misleading and may indicate an unimplemented safety limit.

**Fix:** Either apply the constant as an upper bound on `m_shockEvents.size()` (or on the shock counter read-back) or remove the macro.

---

**A06-6** · MEDIUM · `m_shockMaxMagnitude` is written but never read

**Description:** `m_shockMaxMagnitude` is declared at header line 131 and assigned at `bleexpansion.cpp` line 422 when the BLE characteristic is read. However, it is never subsequently used — not in `popShockEvent`, `generateShockMessage`, nor exposed via any getter. The corresponding UUID (`BleExpansionUuid::shockMaxMagnitude`) is read from the peripheral at startup (line 151) purely to populate this variable. The field appears to have been retained for a planned feature (e.g., normalising shock magnitude or setting an upper alert threshold) that was never implemented.

**Fix:** Either expose `m_shockMaxMagnitude` through a getter and use it in threshold comparisons, or remove the member, the `readCharacteristic` call for `shockMaxMagnitude`, and the handling branch in `characteristicRead`.

---

**A06-7** · MEDIUM · `AUTH_CODE` is a plain-text hardcoded secret in source

**Description:** Line 9 of `bleexpansion.cpp` defines:

```cpp
#define AUTH_CODE   "uS8MgpklMx"
```

This value is passed directly as the BLE authorisation code to `m_bleCentral->setAuthorizationCode(...)` in the constructor (line 40). It is stored verbatim in the compiled binary and committed in version control. Any party with access to the repository or the binary can recover the peripheral authentication credential.

**Fix:** Do not store credentials as string literals in source. Load the auth code from a protected key store, a provisioned device identity, or a configuration protected by OS-level access controls. At minimum, move it out of a public macro into a more restricted scope.

---

**A06-8** · MEDIUM · Double-semicolons on relay-correction lines create silent no-ops

**Description:** Lines 377 and 385 of `bleexpansion.cpp` each have a trailing double semicolon:

```cpp
setRelayOutput(CIGCONF::BleExpRelay1, m_outputRelay[0]);;   // line 377
setRelayOutput(CIGCONF::BleExpRelay2, m_outputRelay[1]);;   // line 385
```

While a stray `;` is syntactically harmless as an empty statement in C++, it is a style defect that signals a copy-paste error or incomplete edit, and some compiler warning configurations (`-Wextra` with pedantic settings) will flag it. More importantly, both lines are inside the relay-discrepancy correction block but the double semicolon suggests the code was hastily edited and may have originally contained a missing `else` branch or an additional side-effect call.

**Fix:** Remove the extra semicolons.

---

**A06-9** · MEDIUM · `RtcTime` uses GCC-specific `__attribute__((packed))` on an anonymous struct inside a union

**Description:** The `RtcTime` union (header lines 71–83) uses:

```cpp
} DateTime __attribute__ ((packed));
```

`__attribute__((packed))` is a GCC/Clang extension not available in MSVC. The union overlays a `char[10]` array against a struct of `quint8`/`quint16` fields. Even without the attribute, accessing the struct members through `rtc.DateTime.year` on a platform where `quint16` requires 2-byte alignment would be undefined behaviour if the union's base address is odd. Mixing union-based type-punning with packed structs is not portable C++ and may produce misaligned-read UB on ARM platforms depending on the allocator.

**Fix:** Replace the union/packed-struct with explicit `qToLittleEndian`/byte-array writes to remove both the portability and the UB risk.

---

**A06-10** · MEDIUM · `reinterpret_cast` on potentially unaligned BLE byte buffers

**Description:** Multiple locations dereference `reinterpret_cast<const quint32 *>(ba.constData())` directly:

- `popShockEvent` line 204: `event.timestamp = *(reinterpret_cast<const quint32 *>(ba.constData()))`
- `popShockEvent` line 205: `event.magnitude = *(reinterpret_cast<const quint32 *>(ba.constData() + 4))`
- `characteristicRead` line 422: `m_shockMaxMagnitude = *(reinterpret_cast<const quint32 *>(ba.constData()))`
- `characteristicWritten` lines 474 and 481: same pattern for threshold/period confirmation

`QByteArray::constData()` returns a `const char *` whose alignment is only guaranteed to be 1-byte. On ARM Cortex-A/M targets where the BLE stack may supply non-4-byte-aligned buffers, dereferencing a `quint32 *` from such a pointer is undefined behaviour (unaligned access trap or silent tearing depending on MCU configuration).

**Fix:** Use `qFromLittleEndian<quint32>(ba.constData())` or `memcpy` into a local `quint32` to perform safe unaligned reads.

---

**A06-11** · MEDIUM · `WritePending` bitfield uses signed `int` for bit members

**Description:** The `WritePending::bitMap` struct (header lines 87–100) declares all bit-field members as `int` (signed), e.g.:

```cpp
int currentTime     : 1;
int shockEventClear : 1;
```

A 1-bit signed integer has only two representable values: `0` and `-1`. Assigning `1` to a 1-bit signed bitfield yields implementation-defined behaviour in C++03 and is still potentially surprising in C++11+. The code uses assignments like `m_pending.bitMap.currentTime = 1` throughout, which will always store `-1` in a 1-bit signed field on two's-complement platforms, but comparing or printing the value produces unexpected results.

**Fix:** Change all bitfield member types to `unsigned int` (or `quint32`) to make single-bit values behave as booleans with values 0 and 1.

---

**A06-12** · LOW · `isShockQueueEmpty` and `shockEvent` are non-`const` public inline methods lacking `const` correctness

**Description:** `isShockQueueEmpty()` (header line 52) could logically be `const` — it only calls `m_shockEvents.isEmpty()`. It is not declared `const`. `shockEvent()` (line 53) does mutate the queue (dequeue), so `const` is not applicable there, but the absence of `const` on `isShockQueueEmpty` is a minor style defect.

**Fix:** Add `const` qualifier to `isShockQueueEmpty`.

---

**A06-13** · LOW · `BleExpansionUuid` UUID constants declared without `const`

**Description:** All 37 UUID constants in `BleExpansionUuid` are declared `static quint128` — mutable by any code in scope — rather than `static const quint128`. The `friend class BleExpansion` declaration makes all private members accessible to `BleExpansion`, which means any method of `BleExpansion` can inadvertently modify a UUID constant. Given the definitions in `bleexpansionuuid.cpp` are used only as read-only lookup keys, they should be const.

**Fix:** Change all `static quint128` members in `BleExpansionUuid` to `static const quint128` and update the `bleexpansionuuid.cpp` definitions accordingly.

---

**A06-14** · LOW · `equals128` performs pointer arithmetic past the end of `quint128` without size guarantee

**Description:** `BleExpansionUuid::equals128` (header lines 9–17) casts two `const quint128 *` pointers to `const quint32 *` and iterates four times with `++p1`/`++p2`. This assumes `sizeof(quint128) == 16` and that the layout is exactly four contiguous `quint32` values. Qt's `quint128` is a typedef for a compiler-specific 128-bit integer type (or a struct on platforms without native 128-bit support). If the struct representation has padding, the comparison silently fails. Qt provides `QBluetoothUuid::toUInt128()` which returns a well-defined struct; however, there is no static assertion verifying this assumption.

**Fix:** Add `static_assert(sizeof(quint128) == 16, "quint128 size mismatch");` inside `equals128`, or use `memcmp(v1, v2, sizeof(quint128))` which is both safer and more readable.

---

**A06-15** · LOW · `setRelayOutput` logs a debug warning on inaccessible state but continues execution

**Description:** At `bleexpansion.cpp` line 117:

```cpp
if (!m_accessible)
    qDebug() << "setRelayOutput(" << relay << ", " << state << ") not accessible";
```

The function does **not** return after logging. It falls through to update `m_outputRelay[0]` or `m_outputRelay[1]` (lines 123, 131) even when not accessible, but does not write to the BLE characteristic. This silent state divergence means the local shadow state (`m_outputRelay`) is updated as if the write succeeded, but the peripheral is not written. When accessibility is later restored, `initRelays` will push the cached state to the peripheral, which partly mitigates this, but the debug-only log with no early return is a style inconsistency with every other method in the class (all of which do `if (!m_accessible) return;`).

**Fix:** Consistently apply the early-return guard, or replace with `qWarning()` to surface the issue at a non-debug build level.

---

**A06-16** · LOW · `appearance` UUID is declared and defined but never used

**Description:** `BleExpansionUuid::appearance` is declared in `bleexpansionuuid.h` line 22 and defined in `bleexpansionuuid.cpp` line 9. No code in `bleexpansion.cpp` (or anywhere else in the repository) reads or writes the `appearance` characteristic. It is dead data.

**Fix:** Remove the `appearance` declaration and definition.

---

**A06-17** · LOW · Output UUIDs `outputD0`–`outputD3` and `openCollector0`–`openCollector3` are never referenced in `bleexpansion.cpp`

**Description:** Eight UUID constants — `outputD0`, `outputD1`, `outputD2`, `outputD3`, `openCollector0`, `openCollector1`, `openCollector2`, `openCollector3` — are declared in `bleexpansionuuid.h` and defined in `bleexpansionuuid.cpp`, but are never referenced in `bleexpansion.cpp`. The corresponding `WritePending` bitfield allocates bits for `output` (4 bits) and `openCollector` (4 bits) but no code ever sets or clears these bits. This suggests a partially implemented feature for driving digital outputs and open-collector outputs.

**Fix:** Either implement the digital output and open-collector write/read paths, or remove the UUID constants and `WritePending` bit allocations to keep the code consistent with what is actually used.

---

**A06-18** · INFO · `inputPullUp0`–`inputPullUp3` UUIDs are defined but never used in `bleexpansion.cpp`

**Description:** The four pull-up configuration UUIDs (`inputPullUp0`–`inputPullUp3`, `bleexpansionuuid.h` lines 33–36) are defined but never referenced in `bleexpansion.cpp`. The `WritePending` bitfield reserves 4 bits for `inputPullup` (header line 90), but no code sets or clears these bits.

**Fix:** Implement pull-up configuration writes if required by the hardware protocol, or remove the unused UUID constants and bitfield entries.

---

**A06-19** · INFO · `relay0Timeout` and `relay1Timeout` use magic constants `RELAY1_TIMEOUT`/`RELAY2_TIMEOUT` both set to `60` with no units documented

**Description:** Macros `RELAY1_TIMEOUT` (value `60`) and `RELAY2_TIMEOUT` (value `60`) are defined at lines 12–13 without any comment indicating the unit (seconds? milliseconds? BLE ticks?). The values are written as a 16-bit little-endian integer to the relay timeout characteristics. A reader cannot determine from source alone what timeout duration is configured.

**Fix:** Add a comment stating the unit (e.g., `// seconds`) next to the macro definitions.

---

**A06-20** · INFO · `m_previousPending` is not initialised in the constructor member-initialiser list

**Description:** `m_previousPending` is declared at header line 123 but does not appear in the constructor initialiser list (`bleexpansion.cpp` lines 17–26). `m_pending.val` is explicitly zeroed at line 27, but `m_previousPending` receives no initialisation — its value at construction is indeterminate until the first write acknowledgement. If `timerEvent` fires before any write is acknowledged, the stale comparison on line 50 (`m_previousPending == m_pending.val`) may suppress the "Failed to write" warning spuriously.

**Fix:** Add `m_previousPending(0)` to the constructor's member-initialiser list.

---

**A06-21** · INFO · `m_shockCountNotifyEnabled` is not initialised in the constructor member-initialiser list

**Description:** `m_shockCountNotifyEnabled` is declared at header line 120 but is absent from the constructor initialiser list. It is set to `false` inside `setAccessible(true)` at line 98, but if any BLE event arrives before `setAccessible` is called (unlikely but technically possible during connection setup), the field value is indeterminate.

**Fix:** Add `m_shockCountNotifyEnabled(false)` to the constructor's member-initialiser list.

---

**A06-22** · INFO · `m_digitalInput[4]` is not zero-initialised in the constructor

**Description:** `m_digitalInput[4]` (header line 132) is not initialised in the constructor initialiser list or in the constructor body. The array holds the last-known state of the four digital inputs. Before any BLE read completes, `digitalInput()` will return garbage. On most Qt-embedded targets the heap is zeroed, but this is not a language guarantee.

**Fix:** Initialise the array either as `m_digitalInput{}` in the member-initialiser list or add a `memset` in the constructor body.

---

## Summary Table

| ID | Severity | Title |
|---|---|---|
| A06-1 | HIGH | `descriptorRead` slot implemented but never connected |
| A06-2 | HIGH | `allowShockCountNotify` defined but never called |
| A06-3 | HIGH | `resetInputTimer` and `resetOutput` defined but never called |
| A06-4 | MEDIUM | Commented-out code block in `initRelays` (lines 284–286) |
| A06-5 | MEDIUM | `MAX_SHOCK_COUNT` macro defined but never used |
| A06-6 | MEDIUM | `m_shockMaxMagnitude` written but never read |
| A06-7 | MEDIUM | `AUTH_CODE` is a hardcoded plain-text secret in source |
| A06-8 | MEDIUM | Double-semicolons on relay-correction lines (lines 377, 385) |
| A06-9 | MEDIUM | `RtcTime` uses non-portable GCC `__attribute__((packed))` |
| A06-10 | MEDIUM | `reinterpret_cast` on potentially unaligned BLE byte buffers |
| A06-11 | MEDIUM | `WritePending` bitfield uses signed `int` for 1-bit members |
| A06-12 | LOW | `isShockQueueEmpty` missing `const` qualifier |
| A06-13 | LOW | `BleExpansionUuid` UUID constants not declared `const` |
| A06-14 | LOW | `equals128` lacks size assertion for `quint128` layout |
| A06-15 | LOW | `setRelayOutput` logs debug but does not early-return when inaccessible |
| A06-16 | LOW | `appearance` UUID declared, defined, and never used |
| A06-17 | LOW | `outputD0`–`outputD3` and `openCollector0`–`openCollector3` UUIDs unused |
| A06-18 | INFO | `inputPullUp0`–`inputPullUp3` UUIDs defined but never used |
| A06-19 | INFO | Relay timeout macros lack unit documentation |
| A06-20 | INFO | `m_previousPending` not initialised in constructor initialiser list |
| A06-21 | INFO | `m_shockCountNotifyEnabled` not initialised in constructor initialiser list |
| A06-22 | INFO | `m_digitalInput[4]` not zero-initialised in constructor |
