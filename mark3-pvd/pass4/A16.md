# Pass 4 Agent A16 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Repo root:** `C:/Projects/cig-audit/repos/mark3-pvd`
**Files reviewed:**
- `platform/pwmbacklight.h`
- `platform/pwmbacklight.cpp`
- `platform/pwmbeeper.h`
- `platform/pwmbeeper.cpp`
- `platform/seriallogger.h`
- `platform/seriallogger.cpp`

---

## Reading Evidence

### `platform/pwmbacklight.h`

**Class:** `EM070::PwmBacklight` (extends `QObject`)

| Name | Kind | Line |
|------|------|------|
| `State` | enum | 15 |
| `State::NoChange` | enum value | 15 |
| `State::Brighter` | enum value | 15 |
| `State::Darker` | enum value | 15 |
| `PwmBacklight(QObject *parent)` | constructor | 16 |
| `~PwmBacklight()` | destructor | 17 |
| `setAutoBrightness(bool enable)` | public method | 18 |
| `isAutoBrightness() const` | public inline method | 19 |
| `brightness()` | public static method | 21 |
| `setBrightness(quint8 val)` | public static method | 22 |
| `luxRead(int lux)` | signal | 25 |
| `timerEvent(QTimerEvent *)` | protected override | 28 |
| `parse(int lux)` | private method | 31 |
| `adjust(int lux)` | private method | 32 |
| `readLux()` | private method | 33 |
| `m_alsPowerFile` | `QFile` member | 35 |
| `m_alsLuxFile` | `QFile` member | 36 |
| `m_brightnessMap` | `QMap<int,int>` member | 37 |
| `m_luxQueue` | `QQueue<int>` member | 38 |
| `m_autoBrightness` | `bool` member | 39 |
| `m_timerId` | `int` member | 40 |
| `m_state` | `State` member | 41 |
| `m_stateCount` | `quint8` member | 42 |
| `m_currentLux` | `int` member | 43 |

**Constants / macros defined in `pwmbacklight.cpp`:**

| Name | Value | Line |
|------|-------|------|
| `FILE_BRIGHTNESS` | sysfs path string | 6 |
| `FILE_ALS_POWER` | sysfs path string | 7 |
| `FILE_ALS_RANGE` | sysfs path string | 8 |
| `FILE_ALS_LUX` | sysfs path string | 9 |
| `TIMER_INTERVAL` | `250` (ms) | 11 |
| `TWO_SECONDS` | `7` (tick count) | 12 |
| `THREE_SECONDS` | `11` (tick count) | 13 |
| `MAX_QUEUE_SIZE` | `20` | 15 |
| `X1P1(v)` | threshold macro | 17 |
| `X1P2(v)` | threshold macro | 18 |

---

### `platform/pwmbeeper.h`

**Class:** `EM070::PwmBeeper` (extends `QObject`)

| Name | Kind | Line |
|------|------|------|
| `BeepType` | enum | 15 |
| `BeepType::BeepOn` | enum value | 15 |
| `BeepType::BeepSilent` | enum value | 15 |
| `BeepType::BeepOff` | enum value | 15 |
| `PwmBeeper(bool autoDelete, QObject *parent)` | constructor | 18 |
| `~PwmBeeper()` | destructor | 19 |
| `setFrequency(quint16 frequency)` | public inline method | 20 |
| `beep(quint16 milliseconds)` | public method | 21 |
| `beep(quint16 frequency, quint16 milliseconds)` | public method | 22 |
| `beep(qint16 count, quint16 msecOn, quint16 msecOff)` | public method | 23 |
| `stop()` | public method | 24 |
| `timeout()` | private slot | 27 |
| `setBeep(bool on)` | private method | 28 |
| `m_timerOn` | `QTimer *` member | 30 |
| `m_timerOff` | `QTimer *` member | 31 |
| `m_file` | `QFile` member | 32 |
| `m_autoDelete` | `bool` member | 33 |
| `m_frequency` | `quint16` member | 34 |
| `m_beeping` | `bool` member | 35 |
| `m_count` | `qint16` member | 36 |
| `m_msecOn` | `quint16` member | 37 |
| `m_msecOff` | `quint16` member | 38 |

**Constants / macros defined in `pwmbeeper.cpp`:**

| Name | Value | Line |
|------|-------|------|
| `FILE_BEEPER` | `"/dev/input/event3"` | 8 |

---

### `platform/seriallogger.h`

**Class:** `SerialLogger` (no base class, pure-static utility)

| Name | Kind | Line |
|------|------|------|
| `log(const QByteArray &message)` | public static method | 9 |
| `setSerialPort(EM070::UserPort *serial)` | public static method | 10 |
| `m_serial` | `static EM070::UserPort *` member | 13 |

**Constants / macros defined in `seriallogger.cpp`:**

| Name | Value | Line |
|------|-------|------|
| `ENABLE_SL_FILE` | `0` | 5 |
| `SERIAL_LOG_FILE` | `"/mnt/sd/sl.log"` | 6 |

---

## Findings

---

**A16-1** · HIGH · Broken include guard in `pwmbacklight.h`

**Description:** Line 1 of `pwmbacklight.h` opens with `#ifndef PWMBACKLIGHT_H`, but line 2 defines `BRIGHTNESS_H` instead of `PWMBACKLIGHT_H`. These two macros are completely independent, so the guard never fires: on any second inclusion within the same translation unit the preprocessor evaluates `#ifndef PWMBACKLIGHT_H` as true (the macro was never defined), re-processes the entire header, and redeclares `class PwmBacklight` — a hard compiler error. The name `BRIGHTNESS_H` also appears to be a leftover from a previous file name or copy-paste from an earlier draft.

**Fix:** Change line 2 from `#define BRIGHTNESS_H` to `#define PWMBACKLIGHT_H` so it matches the guard on line 1. Alternatively, replace the entire traditional guard with `#pragma once`.

---

**A16-2** · MEDIUM · Dead `BeepType` enum in public API (`pwmbeeper.h:15`)

**Description:** `enum BeepType {BeepOn, BeepSilent, BeepOff}` is declared public at line 15 of `pwmbeeper.h`. No `beep()` overload, no internal method, and no call site in the codebase (confirmed by repository-wide search) references `BeepType` or any of its values. The three `beep()` overloads use `quint16` and `qint16` raw integers. The presence of a public, unused enum in a hardware driver creates ambiguity: integrators may attempt to pass `BeepType` values to `beep()` and find no matching overload. `BeepSilent` implies a distinct beep mode that is entirely unimplemented.

**Fix:** If `BeepType` is not planned for near-term use, remove the enum entirely. If it is intended to replace the raw-integer API, implement the corresponding overload (`void beep(BeepType type, quint16 milliseconds)`) and deprecate the `bool`-based internal `setBeep()`.

---

**A16-3** · MEDIUM · Large commented-out brightness map block (`pwmbacklight.cpp:48–59`)

**Description:** Lines 48–59 contain a 12-entry `m_brightnessMap` initialisation block wrapped in a `/* ... */` comment. The comment was replaced by the two-entry linear map on lines 60–61. The old table is completely dead and will never execute. The values inside it (e.g. `2047 >> 3` = 255, brightness levels up to 2047) suggest a different hardware configuration from the one currently deployed. Dead blocks of this size obscure the maintenance history and may mislead future developers into believing the old table is still relevant.

**Fix:** Remove the commented-out block entirely. If the old brightness curve has historical value, preserve it in version control history or in a named git commit message rather than inline in the source.

---

**A16-4** · MEDIUM · Commented-out call on `setAutoBrightness` (`pwmbacklight.cpp:115`)

**Description:** Line 115 reads:
```cpp
m_currentLux = readLux();//m_brightnessMap.key(brightness(), 4000);
```
The inline comment `//m_brightnessMap.key(brightness(), 4000)` is a commented-out expression that was the original initialiser for `m_currentLux`. It is appended directly to the active statement, making the line hard to parse at a glance. The old expression also read the brightness sysfs file and reverse-looked it up in the map — a round-trip that could fail silently — so the replacement is correct, but the dead code should be removed.

**Fix:** Delete the commented fragment, leaving only `m_currentLux = readLux();`.

---

**A16-5** · MEDIUM · `X1P1` and `X1P2` macros carry stale commented-out magic numbers (`pwmbacklight.cpp:17–18`)

**Description:** Both threshold macros embed two alternative magic-number constants side-by-side, with one commented out:
```cpp
#define X1P1(v)  ((v) * 333/*281*/ >> 8)
#define X1P2(v)  ((v) * 333/*307*/ >> 8)
```
The values `281` and `307` (the original 1.1× and 1.2× approximations in Q8 fixed-point) were replaced by the shared value `333`, which approximates neither 1.1 nor 1.2 correctly (333/256 ≈ 1.301). The stale alternatives are embedded inline as comments making the macros obscure. The macro names (`X1P1` = ×1.1, `X1P2` = ×1.2) now misrepresent the actual multiplier used at runtime.

**Fix:** Decide on the correct multiplier for each threshold, update the constants, name them clearly (e.g. `BRIGHTER_RATIO_Q8`, `DARKER_RATIO_Q8`), remove the dead alternatives, and add a comment explaining the fixed-point arithmetic.

---

**A16-6** · MEDIUM · `ENABLE_SL_FILE` permanently disabled compile-time flag (`seriallogger.cpp:5`)

**Description:** `#define ENABLE_SL_FILE 0` permanently disables the file-logging branch on lines 18–30 at compile time. The dead branch includes a `static QFile` that is never constructed, and the path `/mnt/sd/sl.log` is never opened. Permanently-disabled `#if 0`-style blocks that remain in production code are a maintenance hazard: they age without testing, their APIs drift from the live code, and they consume reader attention. The `SERIAL_LOG_FILE` macro on line 6 is also effectively dead.

**Fix:** If file logging is not planned for any near-term build configuration, remove lines 5–6 and lines 18–30 entirely. If it is a debug feature that may be re-enabled, convert it to a proper build-system option (a CMake/qmake `DEFINES` flag) so it can be toggled without editing source, and add a build-configuration note in the file header.

---

**A16-7** · LOW · C-style cast in `pwmbeeper.cpp:77`

**Description:** Line 77 uses a C-style pointer cast:
```cpp
m_file.write((const char *) &event, sizeof(struct input_event));
```
C-style casts in C++ bypass type-system checks and are invisible to static analysers. In this context the cast from `struct input_event *` to `const char *` is the conventional way to serialise a kernel struct to a byte stream, but the explicit `sizeof(struct input_event)` separately increases the risk of a size mismatch if the struct type were ever changed.

**Fix:** Replace with `reinterpret_cast<const char *>(&event)` to make intent explicit. Consider also using `sizeof(event)` instead of `sizeof(struct input_event)` to keep size and object in sync.

---

**A16-8** · LOW · `input_event` struct partially uninitialized in `pwmbeeper.cpp:66–75`

**Description:** The `struct input_event event` declared at line 66 is never zero-initialized. The kernel `input_event` struct contains a `timeval time` field (two `long` members) that is not set before the struct is written to the device file. On most platforms the kernel ignores this field when reading from userspace, but writing stack garbage to a device file is an inadvertent information-disclosure of stack memory contents to any kernel-side observer or sniffer on the input subsystem. The code also does not initialise the `type` field to zero before branching on `on`, so the `type` field is set correctly but only after the `event` variable is allocated with indeterminate contents.

**Fix:** Zero-initialize the struct at declaration: `struct input_event event = {};`. This guarantees all fields are zero before the relevant ones are set.

---

**A16-9** · LOW · `TWO_SECONDS` and `THREE_SECONDS` names are misleading (`pwmbacklight.cpp:12–13`)

**Description:**
```cpp
#define TWO_SECONDS   7    // (7 + 1) * 250
#define THREE_SECONDS 11   // (11 + 1) * 250
```
The comment explains the derivation: `(count + 1) * TIMER_INTERVAL`. `(7+1)*250 = 2000 ms` and `(11+1)*250 = 3000 ms`. The names correctly describe the intent, but the encoding as a raw count (not a duration) means the constants are implicitly coupled to `TIMER_INTERVAL`. If `TIMER_INTERVAL` is ever changed the time duration changes without any compile-time error, and the macro names will silently lie.

**Fix:** Define the thresholds in terms of `TIMER_INTERVAL`:
```cpp
#define TWO_SECONDS_TICKS   (2000 / TIMER_INTERVAL - 1)
#define THREE_SECONDS_TICKS (3000 / TIMER_INTERVAL - 1)
```
This makes the coupling explicit and keeps the values automatically consistent.

---

**A16-10** · LOW · `SerialLogger` is a non-constructible static class without a deleted constructor

**Description:** `SerialLogger` has only static public methods and a single static private data member, making it a pure static-utility class. However, it has no deleted default constructor. Any code could accidentally write `SerialLogger logger;` and instantiate a useless object. The class also does not inherit from `QObject` but uses `EM070::UserPort` in its interface — the `EM070` namespace is used in the header without a forward declaration of the namespace itself, which requires `userport.h` to transitively pull in everything needed.

**Fix:** Add `SerialLogger() = delete;` to the private section to prevent instantiation. Consider making the class `final` if subclassing is also unintended.

---

**A16-11** · LOW · `setBrightness` and `brightness` open and close a file on every call (`pwmbacklight.cpp:179–201`)

**Description:** Both `brightness()` (line 179) and `setBrightness()` (line 191) construct a local `QFile`, open it, perform one read or write, and implicitly close it on destruction — every time they are called. For brightness reads this matters less (they are called infrequently), but `setBrightness` is called from `adjust()`, which is called from the 250 ms timer tick whenever the lux level changes. Opening and closing a sysfs node on every write adds unnecessary system-call overhead compared to holding an open file descriptor (as is already done for `m_alsPowerFile` and `m_alsLuxFile`).

**Fix:** Either promote the brightness sysfs file to a persistent `QFile` member on `PwmBacklight` (analogous to `m_alsPowerFile`) or, since `brightness()` and `setBrightness()` are static, maintain a `static QFile` within the translation unit opened once on first use.

---

**A16-12** · LOW · Trailing whitespace in `parse()` — extra space before `)` (`pwmbacklight.cpp:140`)

**Description:** Line 140 reads `if (m_state != Brighter )` with a stray space before the closing parenthesis. This is a minor style inconsistency; no other conditional in the file has this pattern.

**Fix:** Remove the extra space: `if (m_state != Brighter)`.

---

**A16-13** · INFO · Magic number `8` inside `parse()` with no named constant (`pwmbacklight.cpp:162–169`)

**Description:** Lines 162–169 use the literal `8` as the minimum queue depth and the divisor for averaging:
```cpp
if (size < 8)
    return;
int sum = 0;
for (int i = size - 8; i < size; ++i)
    sum += m_luxQueue.at(i);
adjust(sum >> 3);    // sum / 8
```
`8` corresponds to 8 × 250 ms = 2 seconds of samples, matching the `TWO_SECONDS` concept but expressed as a raw integer in three separate places. `sum >> 3` is the divide-by-8, but is not obviously connected to the `8` above.

**Fix:** Introduce a named constant (e.g. `#define AVG_WINDOW_SIZE 8`) and replace all three occurrences. Replace `sum >> 3` with `sum / AVG_WINDOW_SIZE` or add an explanatory comment.

---

**A16-14** · INFO · `SerialLogger::m_serial` initialised with `0` not `nullptr` (`seriallogger.cpp:8`)

**Description:** Line 8 initialises the static pointer with the integer literal `0`:
```cpp
EM070::UserPort *SerialLogger::m_serial = 0;
```
Modern C++ style uses `nullptr` for null pointer constants. Using `0` is not incorrect but is stylistically inconsistent with the rest of the codebase which uses Qt types and is compiled as C++11 or later.

**Fix:** Replace `= 0` with `= nullptr`.

---

## Summary Table

| ID | Severity | Category | Location | Short Title |
|----|----------|----------|----------|-------------|
| A16-1 | HIGH | Build / Guard | `pwmbacklight.h:1-2` | Broken include guard (`PWMBACKLIGHT_H` vs `BRIGHTNESS_H`) |
| A16-2 | MEDIUM | Dead Code | `pwmbeeper.h:15` | `BeepType` enum declared but never used |
| A16-3 | MEDIUM | Dead Code | `pwmbacklight.cpp:48-59` | Large commented-out brightness map block |
| A16-4 | MEDIUM | Dead Code | `pwmbacklight.cpp:115` | Commented-out expression inline on active statement |
| A16-5 | MEDIUM | Dead Code / Correctness | `pwmbacklight.cpp:17-18` | `X1P1`/`X1P2` macros carry stale alternatives; multiplier mismatches names |
| A16-6 | MEDIUM | Dead Code | `seriallogger.cpp:5-6,18-30` | `ENABLE_SL_FILE` permanently zero; file-log branch is dead code |
| A16-7 | LOW | Style | `pwmbeeper.cpp:77` | C-style cast instead of `reinterpret_cast` |
| A16-8 | LOW | Correctness | `pwmbeeper.cpp:66-75` | `input_event` struct not zero-initialized before write |
| A16-9 | LOW | Style / Maintenance | `pwmbacklight.cpp:12-13` | `TWO_SECONDS`/`THREE_SECONDS` are tick-counts implicitly tied to `TIMER_INTERVAL` |
| A16-10 | LOW | Style | `seriallogger.h` | Pure-static class missing deleted constructor |
| A16-11 | LOW | Performance | `pwmbacklight.cpp:179-201` | Brightness sysfs file opened/closed on every read and write |
| A16-12 | LOW | Style | `pwmbacklight.cpp:140` | Stray space before `)` in condition |
| A16-13 | INFO | Readability | `pwmbacklight.cpp:162-169` | Magic number `8` used three times with no named constant |
| A16-14 | INFO | Style | `seriallogger.cpp:8` | Static pointer initialised with `0` instead of `nullptr` |
