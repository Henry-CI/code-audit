# Pass 4 Agent A24 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Assigned files:**
- `ui/preopscreenoverlay.h` + `ui/preopscreenoverlay.cpp`
- `ui/supervisordialog.h` + `ui/supervisordialog.cpp`
- `ui/unlockeddialog.h` + `ui/unlockeddialog.cpp`

---

## Reading Evidence

### `ui/preopscreenoverlay.h`

**Class:** `PreopScreenOverlay` (extends `QDialog`)

| Method / Member | Line | Notes |
|---|---|---|
| `explicit PreopScreenOverlay(QWidget *parent = 0)` | 15 | Constructor |
| `~PreopScreenOverlay()` | 16 | Destructor |
| `void onUpdatePreopTimer(QString time)` | 18 | Public slot-like updater |
| `Ui::PreopScreenOverlay *ui` | 21 | Private UI pointer |

**Types/Enums/Constants defined:** None.

---

### `ui/preopscreenoverlay.cpp`

| Method | Line | Notes |
|---|---|---|
| `PreopScreenOverlay::PreopScreenOverlay(QWidget *parent)` | 4 | Constructor — calls `setupUi` |
| `PreopScreenOverlay::onUpdatePreopTimer(QString time)` | 11 | Sets label text with `tr("Time Remaining")` |
| `PreopScreenOverlay::~PreopScreenOverlay()` | 16 | Destructor — deletes `ui` |

**Types/Enums/Constants defined:** None.

---

### `ui/supervisordialog.h`

**Class:** `SupervisorDialog` (extends `QDialog`)

| Member / Method | Line | Notes |
|---|---|---|
| `explicit SupervisorDialog(QWidget *parent = nullptr)` | 20 | Constructor |
| `~SupervisorDialog()` | 21 | Destructor |
| `void setMasterOptions(CIGCONF::MasterId m)` | 23 | Takes `MasterId` struct by value |
| `void setTransportOptions()` | 24 | Configures transport-mode button visibility |
| `void startMasterSession()` (signal) | 31 | Emitted to trigger master login |
| `void startMaintenanceSession()` (signal) | 32 | Emitted to trigger maintenance login |
| `void onVORUpdate()` (signal) | 33 | Signal with `on` prefix (non-standard) |
| `bool debounce()` | 37 | Private — debounce guard |
| `void reset()` | 38 | Private — resets button text and timer |
| `void showEvent(QShowEvent *event = 0)` | 49 | Protected virtual override with default arg |
| `void onUnlkVehicle()` | 52 | Private slot |
| `void onNormalDriverAccess()` | 53 | Private slot |
| `void onActivateVOR()` | 54 | Private slot |
| `void openConfirmationDialog()` | 55 | Private slot |
| `void on_btnMaintenanceMode_clicked()` | 56 | Auto-connected private slot |

**Private data members:**
- `Ui::SupervisorDialog *ui` (line 36)
- `QTimer *m_timer` (line 40)
- `QTimer *m_resetTimer` (line 41)
- `quint32 m_lastPress` (line 42)
- `CIGCONF::MasterId m_master` (line 43)
- `VORConfirmationDialog *m_vorConfirmationDialog` (line 44)
- `WarningDialog *m_maintWarningDialog` (line 45)
- `WarningDialog *m_warningDialog` (line 46)

**Macro constants defined (in .cpp):**
- `NO_ACTIVITY_TIME` = 10000 (line 7)
- `RESET_TIME` = 2000 (line 8)

---

### `ui/supervisordialog.cpp`

| Method | Line | Notes |
|---|---|---|
| `SupervisorDialog::SupervisorDialog(QWidget *parent)` | 10 | Constructor — wires all connects |
| `SupervisorDialog::~SupervisorDialog()` | 47 | Destructor |
| `SupervisorDialog::showEvent(QShowEvent *event)` | 52 | Populates UI text and starts inactivity timer |
| `SupervisorDialog::onUnlkVehicle()` | 88 | Two-tap confirm; emits `startMasterSession` |
| `SupervisorDialog::onNormalDriverAccess()` | 106 | Two-tap confirm; opens warning dialog AND emits `startMasterSession` directly |
| `SupervisorDialog::openConfirmationDialog()` | 126 | Two-tap confirm; opens VOR confirmation dialog |
| `SupervisorDialog::onActivateVOR()` | 144 | Toggles VOR state |
| `SupervisorDialog::debounce()` | 155 | Returns false if < 200 ms since last press |
| `SupervisorDialog::reset()` | 166 | Resets `m_lastPress` and calls `showEvent` |
| `SupervisorDialog::setMasterOptions(CIGCONF::MasterId m)` | 172 | Logs options and sets button visibility via bitmask |
| `SupervisorDialog::setTransportOptions()` | 202 | Hard-codes transport button visibility |
| `SupervisorDialog::on_btnMaintenanceMode_clicked()` | 211 | Two-tap confirm; opens maintenance warning dialog |

---

### `ui/unlockeddialog.h`

**Class:** `UnlockedDialog` (extends `QDialog`)

| Member / Method | Line | Notes |
|---|---|---|
| `enum Mode { UnlockNoChecklist, UnlockChecklist, UnlockOnly }` | 15 | Public enum |
| `explicit UnlockedDialog(QWidget *parent = 0)` | 17 | Constructor |
| `~UnlockedDialog()` | 18 | Destructor |
| `void setMode(Mode m)` | 20 | Configures label visibility per mode |
| `void languageChanged()` | 21 | Refreshes translated strings |
| `Ui::UnlockedDialog *ui` | 28 | Private UI pointer |

**Types/Enums/Constants defined:**
- `enum Mode { UnlockNoChecklist, UnlockChecklist, UnlockOnly }` (line 15)

---

### `ui/unlockeddialog.cpp`

| Method | Line | Notes |
|---|---|---|
| `UnlockedDialog::UnlockedDialog(QWidget *parent)` | 5 | Constructor — sets icon, connects btnOk |
| `UnlockedDialog::~UnlockedDialog()` | 18 | Destructor |
| `UnlockedDialog::setMode(Mode m)` | 23 | Switches on `Mode` enum |
| `UnlockedDialog::languageChanged()` | 42 | Sets `label_3` text to `tr("OK")` |

---

## Findings

---

**A24-1** · HIGH · `startMasterSession` emitted twice in `onNormalDriverAccess`

**Description:** In `supervisordialog.cpp` lines 113–115, `onNormalDriverAccess()` calls `m_warningDialog->open()` and then immediately emits `startMasterSession()` and calls `accept()` — all in the same code path. The `m_warningDialog` (a `Transport`-type `WarningDialog`) is connected in the constructor (lines 33–36) to also `emit startMasterSession()` and `accept()` when its `accepted` signal fires. Because `open()` is used (non-blocking modal), the warning dialog's `accepted` path can complete after the dialog closes, meaning `startMasterSession` is emitted once from the slot directly and then potentially a second time from the `m_warningDialog::accepted` connection. This results in `postLogin()` being invoked twice in the parent `Dialog`, causing double-session initiation.

```cpp
// supervisordialog.cpp:111-115
if (ui->btnNormalDriver->text() == tr("Confirm?")) {
    qDebug() << "current driver id " << gCfg->currentDriverId();
    m_warningDialog->open();       // opens non-blocking; accepted also fires startMasterSession
    emit startMasterSession();     // also fires immediately — duplicate
    accept();
}
// constructor lines 33-36:
connect(m_warningDialog, &WarningDialog::accepted, this, [this](){
    emit startMasterSession();
    accept();
});
```

**Fix:** Remove the direct `emit startMasterSession(); accept();` lines from `onNormalDriverAccess()` and rely solely on the `m_warningDialog::accepted` connection. The pattern used for `on_btnMaintenanceMode_clicked()` (which only calls `m_maintWarningDialog->open()` and lets the `accepted` connection do the work) is the correct model.

---

**A24-2** · HIGH · `m_warningDialog->open()` called but dialog is never confirmed — session starts unconditionally

**Description:** As a consequence of A24-1, the Normal Driver Access path at lines 113–115 calls `emit startMasterSession()` and `accept()` unconditionally, without waiting for the user to confirm or dismiss the `WarningDialog`. The warning dialog is shown as a visual notification, but the session has already started before the user has had a chance to read and acknowledge it. This defeats the purpose of the warning confirmation step.

**Fix:** Remove the immediate `emit startMasterSession(); accept();` from `onNormalDriverAccess()`. Let the `m_warningDialog::accepted` handler (constructor lines 33–36) be the sole path that progresses the session, consistent with the maintenance mode pattern.

---

**A24-3** · MEDIUM · `MasterMenuOptions` enum used as bitmask without `Q_DECLARE_FLAGS`

**Description:** `cigconfigs.h` line 83 defines `MasterMenuOptions` as a plain `enum` with power-of-two values intended for bitwise combination (`UnlockVehicle=1`, `NormalDriverAccess=2`, `ActivateVOR=4`, `MaintenanceMode=8`). `supervisordialog.cpp` lines 180–198 apply bitwise AND (`&`) directly against these enumerators and against `m.option` (typed `quint8`). Qt provides `Q_DECLARE_FLAGS` and `Q_DECLARE_OPERATORS_FOR_FLAGS` to create a type-safe `QFlags<>` wrapper for exactly this pattern. Without it, the compiler will emit warnings on some Qt/C++ configurations ("result of OR on enum values is not an enum value"), and the flag combination is not type-safe — an arbitrary `quint8` value is accepted without error.

```cpp
// cigconfigs.h:83-84
enum MasterMenuOptions {UnlockVehicle=1, NormalDriverAccess=2, ActivateVOR=4,
                        MaintenanceMode=8, DefaultMasterMenu=7, UnassignedMasterMenu=255};

// supervisordialog.cpp:180
if (m.option & CIGCONF::ActivateVOR)   // m.option is quint8, not MasterMenuOptions
```

**Fix:** Declare a `QFlags` type in `cigconfigs.h`:
```cpp
Q_DECLARE_FLAGS(MasterMenuFlags, MasterMenuOptions)
Q_DECLARE_OPERATORS_FOR_FLAGS(CIGCONF::MasterMenuFlags)
```
Change `MasterId::option` from `quint8` to `CIGCONF::MasterMenuFlags`, and update `setMasterOptions` to accept the flag type.

---

**A24-4** · MEDIUM · `MasterId` struct passed by value into `setMasterOptions` — tight coupling to internal layout

**Description:** `SupervisorDialog::setMasterOptions(CIGCONF::MasterId m)` (supervisordialog.h line 23, supervisordialog.cpp line 172) accepts the full `MasterId` struct by value. `SupervisorDialog` only needs two fields: `m.option` (for button visibility) and `m.id` (for VOR activation in `onActivateVOR`). Passing the entire struct couples the dialog tightly to the internal layout of `MasterId`, meaning any future change to that struct (e.g., adding a `QString name` field that becomes expensive to copy, or restructuring `id`) directly affects the dialog API. The name member of `MasterId` is never used within `SupervisorDialog`.

**Fix:** Either pass the two needed values separately (`quint64 masterId, quint8 options`) or pass by const reference (`const CIGCONF::MasterId &m`). Passing by const reference is the minimal change and avoids the unnecessary copy of the `QString name` member on every call.

---

**A24-5** · MEDIUM · `showEvent` overrides a virtual function but declares a default argument

**Description:** `supervisordialog.h` line 49 and `warningdialog.h` line 30 declare `showEvent(QShowEvent *event = 0)`. Adding a default argument to an override of a virtual function is legal C++ but is a recognised anti-pattern: the default is resolved statically based on the pointer type, not the dynamic type. When called through a `QWidget*` or `QDialog*` pointer, the base class default (which has no default) is used; when called directly as `showEvent()` (as done in `supervisordialog.cpp` lines 97, 117, 135, 169), the derived-class default of `nullptr` is silently passed. This creates inconsistent and confusing call semantics, and is the root cause of `Q_UNUSED(event)` being needed at line 54 to suppress the warning.

**Fix:** Remove the `= 0` default from the `showEvent` override in the header. Extract the body of `showEvent` into a private helper (e.g., `void refreshUI()`) and call that helper directly in the places that currently call `showEvent()` without an argument.

---

**A24-6** · MEDIUM · `onVORUpdate` signal uses `on` prefix — naming convention violation

**Description:** `supervisordialog.h` line 33 declares the signal `void onVORUpdate()`. Qt's convention, and the convention used throughout this codebase, is that `on`-prefixed methods are slots (responses to signals), not signals themselves. Using `on` as a signal name creates readability confusion: a reader seeing `connect(..., &SupervisorDialog::onVORUpdate, ...)` is likely to mistake the signal for a slot. The other two signals in the same class (`startMasterSession`, `startMaintenanceSession`) correctly follow the verb-phrase convention.

**Fix:** Rename the signal to `vorStatusChanged()` or `vorUpdated()` and update the connection in `dialog.cpp` line 182 accordingly.

---

**A24-7** · LOW · `PreopScreenOverlay` and `UnlockedDialog` constructors use `= 0` instead of `= nullptr`

**Description:** `preopscreenoverlay.h` line 15 and `unlockeddialog.h` line 17 declare constructors with `QWidget *parent = 0`. `supervisordialog.h` line 20 correctly uses `= nullptr`. Using `0` as a null pointer constant is a C++03 idiom; `nullptr` (C++11) is the correct form for modern Qt/C++ projects and avoids potential ambiguity in overload resolution. The inconsistency also indicates these headers have not been updated alongside the rest of the codebase.

**Fix:** Replace `= 0` with `= nullptr` in the constructor declarations of `PreopScreenOverlay` and `UnlockedDialog`.

---

**A24-8** · LOW · `NO_ACTIVITY_TIME` and `RESET_TIME` defined as bare `#define` macros

**Description:** `supervisordialog.cpp` lines 7–8 define `NO_ACTIVITY_TIME 10000` and `RESET_TIME 2000` as preprocessor macros. These are file-scoped constants with no namespace, no type information, and no debugger visibility. They should be typed constants.

```cpp
#define NO_ACTIVITY_TIME    10000
#define RESET_TIME          2000
```

**Fix:** Replace with typed constants inside the class or as `static constexpr int` in the translation unit:
```cpp
static constexpr int NO_ACTIVITY_TIME = 10000;
static constexpr int RESET_TIME       = 2000;
```

---

**A24-9** · LOW · Mixed tabs and spaces indentation in `supervisordialog.cpp` and `supervisordialog.h`

**Description:** `supervisordialog.cpp` uses 4-space indentation throughout most of the file, but lines 17–18 (constructor initialiser list), line 8 (`RESET_TIME` macro), and several lines in `showEvent`, `onUnlkVehicle`, `onNormalDriverAccess`, `openConfirmationDialog`, `onActivateVOR`, `debounce`, `reset`, and `on_btnMaintenanceMode_clicked` use hard tab characters. `supervisordialog.h` line 49 (`void showEvent`) uses a hard tab while all surrounding lines use 4 spaces. All files also contain Windows-style `\r\n` line endings (`^M` in the raw file). The three other assigned files (`preopscreenoverlay.cpp/h`, `unlockeddialog.cpp/h`) are consistently 4-space indented.

**Fix:** Normalise `supervisordialog.cpp` and `supervisordialog.h` to 4-space indentation throughout and convert line endings to LF-only to match the rest of the UI source files. An `.editorconfig` rule would prevent recurrence.

---

**A24-10** · LOW · `UnlockedDialog::languageChanged` updates `label_3` (auto-generated name) instead of `btnOk`

**Description:** `unlockeddialog.cpp` line 44 sets `ui->label_3->setText(tr("OK"))`. The widget `label_3` is an automatically-generated Qt Designer name with no semantic meaning. The constructor at line 12 sets the icon on `ui->btnOk`, which is the actual OK button. Setting the text of an opaquely-named `label_3` rather than the button itself means that: (a) `label_3` and `btnOk` can display different text, and (b) any redesign of the `.ui` file that renumbers or renames the auto-generated label will silently break the `languageChanged()` call at runtime with no compile-time error.

**Fix:** Rename `label_3` in `unlockeddialog.ui` to `lblOkText` (or remove it if it overlaps visually with `btnOk`), and reference it by the semantic name. Alternatively, if the label is the visible text companion of `btnOk`, update `languageChanged()` to also set `ui->btnOk->setText(tr("OK"))` to keep them in sync.

---

**A24-11** · LOW · `qDebug()` left in production path of `onNormalDriverAccess` and `setMasterOptions`

**Description:** `supervisordialog.cpp` line 112 contains `qDebug() << "current driver id " << gCfg->currentDriverId();` inside the confirmed-second-tap branch of `onNormalDriverAccess()`. Lines 174–176 contain a `qDebug()` call in `setMasterOptions()` that logs the master ID and option bits in hex. These debug statements log security-relevant information (driver identifiers, supervisor credential option bitmasks) to the application debug output on every supervisor action, which may surface in production logs or serial consoles.

**Fix:** Remove the `qDebug()` at line 112. For `setMasterOptions`, replace the debug log with a conditional `qCDebug(categoryName)` that is compiled out in release builds, or remove it entirely.

---

**A24-12** · INFO · `#endif` guard label mismatch in `supervisordialog.h`

**Description:** `supervisordialog.h` line 59 has `#endif // SUPERVISOR_H` but the include guard is defined as `SUPERVISORDIALOG_H` (line 2). The comment is purely informational and has no effect on compilation, but it creates confusion for anyone scanning include guard names and does not match the `_H` suffix pattern used in the rest of the codebase.

**Fix:** Change line 59 to `#endif // SUPERVISORDIALOG_H`.

---

## Summary Table

| ID | Severity | Title |
|---|---|---|
| A24-1 | HIGH | `startMasterSession` emitted twice in `onNormalDriverAccess` |
| A24-2 | HIGH | Warning dialog shown but session starts without waiting for user confirmation |
| A24-3 | MEDIUM | `MasterMenuOptions` bitmask used without `Q_DECLARE_FLAGS` |
| A24-4 | MEDIUM | `MasterId` struct passed by value — leaky abstraction / unnecessary coupling |
| A24-5 | MEDIUM | `showEvent` virtual override declares default argument |
| A24-6 | MEDIUM | Signal `onVORUpdate` uses reserved `on` prefix |
| A24-7 | LOW | `= 0` null pointer in constructors instead of `= nullptr` |
| A24-8 | LOW | `NO_ACTIVITY_TIME` / `RESET_TIME` as untyped `#define` macros |
| A24-9 | LOW | Mixed tabs/spaces and CRLF line endings in `supervisordialog` files |
| A24-10 | LOW | `languageChanged()` targets auto-named `label_3` instead of semantic widget name |
| A24-11 | LOW | `qDebug()` logs security-relevant IDs in production path |
| A24-12 | INFO | `#endif` guard label mismatch in `supervisordialog.h` |
