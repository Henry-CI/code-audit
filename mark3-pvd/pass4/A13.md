# Pass 4 Agent A13 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `platform/canbus.h`
- `platform/canbus.cpp`
- `platform/gnssreceiver.h`
- `platform/gnssreceiver.cpp`

---

## Reading Evidence

### `platform/canbus.h`

**Class:** `EM070::CanBus` (extends `QObject`)

**Enums / Types / Constants:**

| Kind | Name | Location |
|------|------|----------|
| Enum | `CanDeviceId { CAN2, CAN1 }` | Line 16 |
| Struct | `Request { QCanBusFrame frame; quint32 interval; qint32 timer; }` | Lines 18–23 |

**Methods (public unless noted):**

| Line | Signature | Notes |
|------|-----------|-------|
| 25 | `explicit CanBus(CanDeviceId id = CAN1, QObject *parent = nullptr)` | Constructor |
| 26 | `~CanBus()` | Destructor |
| 28 | `void initialize()` | |
| 30 | `void setXferEnabled(bool enable)` | |
| 31 | `bool isXferEnabled() const` | Inline |
| 33 | `void setPower(bool on)` | |
| 34 | `bool isEnabled() const` | Inline |
| 36 | `bool setBaudRate(int baudRate)` | |
| 37 | `int baudRate() const` | Inline |
| 39 | `void addRequest(quint32 id, const QByteArray &ba, quint32 interval)` | |
| 40 | `QList<Request> getRequests()` | Non-const, returns by value |
| 41 | `void clearRequests()` | |
| 43 | `void addFilter(quint32 identifier)` | |
| 44 | `void clearFilters()` | |
| 45 | `void applyFilters()` | |
| 47 | `void writeFrameDirect(quint32 id, const QByteArray &ba)` | |
| 49 | `void removeRequests(quint32 id)` | |
| 54 | `void error(QCanBusDevice::CanBusError canBusError)` | Signal |
| 55 | `void read(quint32 identifier, const QByteArray &ba)` | Signal |
| 58 | `void sendRequest()` | Protected |
| 61 | `void readFrame()` | Private |
| 62 | `void handleError(QCanBusDevice::CanBusError error)` | Private |

**Commented-out code in header:**
- Line 22: `//int timerId;` — commented-out struct field inside `Request`
- Line 51: `//QCanBusDevice* canBusDevice() const {return m_canBusDevice;}` — commented-out accessor

---

### `platform/canbus.cpp`

**Macros / Constants defined:**

| Name | Value | Line |
|------|-------|------|
| `REQUEST_TIMER` | `100` | 14 |
| `CANBUS_DEBUG` | `0` | 15 |

**Methods (all are implementations of `EM070::CanBus`):**

| Line | Signature |
|------|-----------|
| 17 | `CanBus::CanBus(CanDeviceId id, QObject *parent)` |
| 28 | `CanBus::~CanBus()` |
| 34 | `void CanBus::initialize()` |
| 51 | `void CanBus::sendRequest()` |
| 89 | `void CanBus::setXferEnabled(bool enable)` |
| 105 | `void CanBus::setPower(bool on)` |
| 178 | `bool CanBus::setBaudRate(int baudRate)` |
| 193 | `void CanBus::addRequest(quint32 id, const QByteArray &ba, quint32 interval)` |
| 208 | `void CanBus::clearRequests()` |
| 214 | `void CanBus::addFilter(quint32 identifier)` |
| 219 | `void CanBus::clearFilters()` |
| 224 | `void CanBus::applyFilters()` |
| 258 | `void CanBus::writeFrameDirect(quint32 id, const QByteArray &ba)` |
| 264 | `void CanBus::readFrame()` |
| 274 | `void CanBus::handleError(QCanBusDevice::CanBusError canBusError)` |
| 285 | `void CanBus::removeRequests(quint32 id)` |

**Commented-out code in .cpp:**
- Line 116: `//return;` inside `setPower()` after gpio36 open failure
- Line 120: `//return;` inside `setPower()` after gpio38 open failure
- Line 148: `// return;` inside `setPower()` after `ip link set` failure

---

### `platform/gnssreceiver.h`

**Class:** `EM070::GnssReceiver` (extends `QObject`)

**Macros / Constants:**

| Name | Value | Line |
|------|-------|------|
| `MAX_POINTS` | `8` | 7 |

**Methods (public unless noted):**

| Line | Signature | Notes |
|------|-----------|-------|
| 17 | `explicit GnssReceiver(QObject *parent = nullptr)` | Constructor |
| 18 | `void portStateChanged(bool open)` | |
| 19 | `void reset()` | |
| 20 | `void changeUpdateTime()` | |
| 22 | `quint8 satelliteCount() const` | Inline |
| 23 | `qint32 latitude() const` | Inline |
| 24 | `qint32 longitude() const` | Inline |
| 25 | `qint32 lastLatitude() const` | Inline |
| 26 | `qint32 lastLongitude() const` | Inline |
| 27 | `qint16 speed() const` | Inline |
| 28 | `qint16 course() const` | Inline |
| 29 | `quint32 distance() const` | Inline |
| 30 | `quint32 sumOfDistance() const` | Inline |
| 31 | `quint32 altitude() const` | Inline |
| 32 | `bool locked() const` | Inline |
| 33 | `quint32 hpe() const` | Inline — performs HDOP-to-accuracy conversion inline |
| 34 | `quint32 hdop() const` | Inline |
| 35 | `qint64 age()` | Non-const |
| 36 | `quint8 warn() const` | Inline |
| 37 | `void setWarn(quint8 n)` | Inline |
| 38 | `quint8 quality() const` | Inline |
| 39 | `void setQuality(quint8 n)` | Inline |
| 40 | `quint16 markerCnt() const` | Inline |
| 41 | `void setMarkerCnt(quint16 n)` | Inline |
| 42 | `quint32 pathLatitude(int n)` | |
| 43 | `void setPathLatitude(int n, quint32 lat)` | |
| 44 | `quint32 pathLongitude(int n)` | |
| 45 | `void setPathLongitude(int n, quint32 lon)` | |
| 46 | `void gpsDebugPrint()` | |
| 47 | `bool inPoly2(const CIGCONF::gpsPosStruct *gpsPos, const CIGCONF::polygonStruct *polygon)` | **Declared, never defined — dead/broken** |
| 48 | `bool pointInPolygon(int polyCorners, CIGCONF::position me, CIGCONF::position *points)` | |
| 49 | `double degrees2radians(double degrees)` | |
| 51 | `void timerEvent(QTimerEvent *)` | Protected |
| 54 | `void sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra = QByteArray())` | Signal |
| 57 | `void readData()` | Private |
| 58 | `void parseData(const QByteArray &ba)` | Private |
| 59 | `void cumulateDistance()` | Private |
| 60 | `static quint32 calculateDistance(qint32 lat1, qint32 lng1, qint32 lat2, qint32 lng2)` | Private static |

---

### `platform/gnssreceiver.cpp`

**Macros / Constants:**

| Name | Value | Line |
|------|-------|------|
| `FILE_GNSS_PORT` | `"/dev/ttyUSB1"` | 11 |
| `EARTH_R` | `6371000UL` | 13 |

**Methods:**

| Line | Signature |
|------|-----------|
| 17 | `GnssReceiver::GnssReceiver(QObject *parent)` |
| 44 | `void GnssReceiver::timerEvent(QTimerEvent *event)` |
| 51 | `void GnssReceiver::portStateChanged(bool open)` |
| 72 | `void GnssReceiver::readData()` |
| 101 | `void GnssReceiver::parseData(const QByteArray &ba)` |
| 192 | `void GnssReceiver::reset()` |
| 212 | `void GnssReceiver::changeUpdateTime()` |
| 222 | `void GnssReceiver::cumulateDistance()` |
| 339 | `quint32 GnssReceiver::calculateDistance(qint32 lat1, qint32 lng1, qint32 lat2, qint32 lng2)` |
| 369 | `quint32 GnssReceiver::pathLatitude(int n)` |
| 380 | `void GnssReceiver::setPathLatitude(int n, quint32 lat)` |
| 390 | `quint32 GnssReceiver::pathLongitude(int n)` |
| 401 | `void GnssReceiver::setPathLongitude(int n, quint32 lon)` |
| 409 | `void GnssReceiver::gpsDebugPrint()` |
| 424 | `double GnssReceiver::degrees2radians(double degrees)` |
| 428 | `bool GnssReceiver::pointInPolygon(int polyCorners, CIGCONF::position me, CIGCONF::position *points)` |
| 448 | `qint64 GnssReceiver::age()` |

**Commented-out code in .cpp:**
- Line 216: `//m_timerId = startTimer(gCfg->gpsUpdateTime() * 1000);` in `changeUpdateTime()`
- Line 224: `//qDebug() << ...` in `cumulateDistance()`
- Lines 123–126: Commented-out MK2 relay/geofence block inside `parseData()`
- Lines 314–317: Commented-out `MK2 RELAY CONTROL OP` block (first instance) in `cumulateDistance()`
- Lines 324–326: Commented-out `MK2 RELAY CONTROL OP` block (second instance) in `cumulateDistance()`
- Line 331: `//sendGmtpMessage(CIGCONF::GMTP_GPSE);` at bottom of `cumulateDistance()`

---

## Findings

---

**A13-1** · HIGH · `inPoly2()` declared in public interface but never implemented

**Description:** `gnssreceiver.h` line 47 declares `bool inPoly2(const CIGCONF::gpsPosStruct *gpsPos, const CIGCONF::polygonStruct *polygon)` as a public method. No definition exists anywhere in the codebase. Any translation unit that calls this method will fail to link. The declaration pollutes the public API with a broken contract and signals an incomplete or abandoned feature. This is classic dead/broken code — the linker will catch it at build time if called, but callers may rely on its presence in headers.

**Fix:** Either implement the function body in `gnssreceiver.cpp` or remove the declaration from `gnssreceiver.h` entirely. If it is intended future work, move it to a clearly-marked private stub or a separate feature branch.

---

**A13-2** · HIGH · `changeUpdateTime()` is functionally broken — timer restart is commented out

**Description:** `gnssreceiver.cpp` line 216 shows `//m_timerId = startTimer(gCfg->gpsUpdateTime() * 1000);` is commented out. The method kills the existing timer but never restarts it. Consequently, any caller invoking `changeUpdateTime()` (e.g., `backgroundworker.cpp` line 1275) permanently stops GPS update reporting without any indication of error. The public method name implies a configuration change, not a shutdown, making this a silent, misleading behaviour defect.

**Fix:** Uncomment line 216 in `gnssreceiver.cpp` so that `changeUpdateTime()` kills and restarts the timer with the updated period. If the intent is truly to stop reporting, rename the method to `stopUpdates()` and document accordingly.

---

**A13-3** · MEDIUM · Suppressed `return` statements after fatal GPIO failures in `setPower()`

**Description:** `canbus.cpp` lines 116, 120, and 148 each contain a commented-out `//return;` after critical failures: GPIO file open failures (lines 116, 120) and `ip link set` subprocess failure (line 148). When these failures occur, execution continues silently as if the setup succeeded. If gpio36 or gpio38 cannot be opened, write calls at lines 127–130 and 169–172 operate on a closed file handle. If the `ip link set` command fails, `connectDevice()` is still called, potentially on an interface that was never configured.

**Fix:** Uncomment and restore the `return` statements at lines 116, 120, and 148 so that `setPower()` aborts on unrecoverable hardware errors. At minimum, a function-level return should follow each critical failure, consistent with the already-present `qCritical()` log calls.

---

**A13-4** · MEDIUM · Signed/unsigned comparison: `quint32 last = -1` in `applyFilters()`

**Description:** `canbus.cpp` line 232 initialises `quint32 last = -1`. Assigning `-1` to an unsigned type is implementation-defined-safe in C++ (it wraps to `UINT_MAX`), but it is a style violation and triggers compiler warnings with `-Wsign-conversion` or `-Wall`. The intent is to represent "no previous value", which is a sentinel that happens to work only because no valid CAN ID equals `UINT_MAX`. This is fragile and non-obvious.

**Fix:** Replace with `quint32 last = UINT_MAX;` using the named constant, and add a comment explaining the sentinel value. Alternatively, use `std::optional<quint32>` to express "no prior value" without relying on a magic sentinel.

---

**A13-5** · MEDIUM · Magic number `47757857` in `calculateDistance()` with no explanation

**Description:** `gnssreceiver.cpp` lines 349 and 357 use the literal `47757857` as a scaling factor. The surrounding comment (`// dlng / 10000000 * PI / 180 * R << 32`) explains the intent, but the magic constant itself is the pre-computed product of `(1/10000000) * (PI/180) * 6371000 * 2^32` (approximately). Without this derivation in the code, maintainers cannot verify correctness, and the constant `EARTH_R` defined on line 13 is never used in the calculation despite its presence.

**Fix:** Replace `47757857` with a named compile-time constant or a `constexpr` expression that makes the derivation explicit, e.g.:
```cpp
// (PI / 180 / 10000000) * EARTH_R * (1 << 32)
constexpr qint64 kLatLngScaleFactor = 47757857;
```
Also either use `EARTH_R` in the derivation or remove the unused macro.

---

**A13-6** · MEDIUM · `EARTH_R` macro defined but never used

**Description:** `gnssreceiver.cpp` line 13 defines `#define EARTH_R 6371000UL` but this constant is never referenced anywhere in the file. `calculateDistance()` uses the hardcoded magic number `47757857` which implicitly incorporates the Earth radius. The unused macro misleads readers into thinking the radius is applied symbolically when it is not.

**Fix:** Remove the `EARTH_R` macro, or integrate it into a named `constexpr` expression for `kLatLngScaleFactor` (see A13-5) so the radius is both visible and used.

---

**A13-7** · MEDIUM · Leaky abstraction: CAN protocol bit constants exposed in `applyFilters()`

**Description:** `canbus.cpp` lines 241–249 directly manipulate raw CAN framing bits: `(1 << 29)` to detect extended frame format, mask values `0x3ffff00` and `0x3ff`, and the `MatchExtendedFormat` / `MatchBaseFormat` constants. These hardware-protocol details are embedded in the implementation without named constants or explanatory abstractions. The value `0x3ffff00` is particularly opaque — it is not a standard CAN mask and its derivation is not documented.

**Fix:** Replace magic bit masks with named constants (e.g., `kCanExtendedFrameBit`, `kExtendedFrameIdMask`, `kBaseFrameIdMask`) defined at file or class scope with comments explaining their purpose and derivation.

---

**A13-8** · MEDIUM · `getRequests()` is non-const and returns a mutable copy of internal state

**Description:** `canbus.h` line 40 declares `QList<Request> getRequests()` as non-const with no `const` qualifier. The method returns a full copy of `m_requests` by value. Callers cannot call this on a `const CanBus` reference, making it impossible to use in read-only contexts. The naming convention `getX()` is inconsistent with the rest of the class, which uses Qt-style accessors without the `get` prefix (e.g., `baudRate()`, `isXferEnabled()`).

**Fix:** Declare the method `const` and rename it to `requests()` to match the existing naming convention: `QList<Request> requests() const { return m_requests; }`.

---

**A13-9** · MEDIUM · Commented-out legacy MK2 relay control blocks in `cumulateDistance()`

**Description:** `gnssreceiver.cpp` contains two commented-out blocks of legacy MK2 relay control code at lines 314–317 and 324–326, both marked `/** MK2 RELAY CONTROL OP ... **/`. An additional commented-out block at lines 123–126 of `parseData()` also references legacy relay/geofence logic. These blocks reference undefined symbols (`RELAY3_MODE`, `RELAY3_MODE_GFNCE_NO`, `BSP_RLY3_STATE`, `BSP_RLY3_SET`, `BSP_RLY3_CLR`) and represent dead legacy code that should have been removed, not commented out. They increase maintenance burden and cause reader confusion about the current state of relay control.

**Fix:** Remove all commented-out legacy relay control blocks from `parseData()` and `cumulateDistance()`. If relay integration is needed in the future, it should be re-implemented cleanly against the current hardware abstraction layer, not resurrected from commented-out MK2 code.

---

**A13-10** · MEDIUM · `timerEvent()` handler is an empty stub — misleading dead code

**Description:** `gnssreceiver.cpp` lines 44–49 define `GnssReceiver::timerEvent(QTimerEvent *event)` with a guard `if (m_timerId != event->timerId()) return;` followed by an empty body. The handler starts the timer in `portStateChanged()` (line 60) but does nothing when the timer fires. This is dead code — the timer slot does not exist, and `timerEvent` is the Qt fallback mechanism. A reader may incorrectly assume periodic work occurs here.

**Fix:** Either remove `timerEvent()` entirely and implement a `QTimer`-based slot (consistent with the `CanBus` pattern), or add the intended periodic behaviour inside the handler body. At minimum, if the handler is intentionally empty, add a comment explaining why.

---

**A13-11** · LOW · `age()` is not declared `const` despite having no side effects

**Description:** `gnssreceiver.h` line 35 declares `qint64 age()` without the `const` qualifier, even though the method only reads `m_timestamp` and calls `QDateTime::currentMSecsSinceEpoch()`. All other read-only accessors in the same class are correctly declared `const`. This inconsistency prevents `age()` from being called on a `const GnssReceiver` reference and breaks const-correctness throughout the API.

**Fix:** Add `const` to the declaration: `qint64 age() const;` and to the definition in `gnssreceiver.cpp`.

---

**A13-12** · LOW · `Request::timer` field type mismatch: `qint32` vs `quint32 interval`

**Description:** In `canbus.h` lines 20–22, `Request::interval` is `quint32` but `Request::timer` is `qint32`. In `canbus.cpp` line 69, timer is decremented (`request.timer -= REQUEST_TIMER`) and compared against zero (`if (request.timer <= 0)`). The mixed signed/unsigned types are inconsistent; if `interval` is assigned to `timer` (line 204: `request.timer = interval`), a large `quint32` interval value could produce undefined behaviour or sign wrap when stored in `qint32`.

**Fix:** Make both fields the same type. Since the countdown logic requires signed comparison against zero, either change `interval` to `qint32` or keep both as `quint32` and use an explicit `== 0` comparison (ensuring the unsigned value wraps predictably by enforcing `REQUEST_TIMER` divides evenly into all valid intervals).

---

**A13-13** · LOW · Inconsistent indentation and brace style in `pointInPolygon()`

**Description:** `gnssreceiver.cpp` lines 428–446 (`pointInPolygon`) uses 2-space indentation and inconsistent spacing (notably the trailing spaces on lines 430, 444), while the rest of the file uses 4-space indentation with K&R-style braces. This suggests the function was copied from an external source without reformatting. The opening comment `//oddNodes = 1 means within the polygon` is also inconsistently positioned (inline with the opening brace on the same line).

**Fix:** Reformat `pointInPolygon()` to match the 4-space indentation convention used throughout the rest of `gnssreceiver.cpp`. Run `clang-format` with the project's `.clang-format` config if available.

---

**A13-14** · LOW · `#include <math.h>` and `#include <QtMath>` both present in `gnssreceiver.cpp`

**Description:** `gnssreceiver.cpp` lines 8–9 include both `<QtMath>` and `<math.h>`. `<QtMath>` already provides Qt wrappers around standard math functions, and `<math.h>` (C-style header) is redundant. Mixing C-style `<math.h>` with C++ headers is a style violation and can cause macro/function name conflicts in some toolchains.

**Fix:** Remove `#include <math.h>` from `gnssreceiver.cpp`. All required math functions (`M_PI`, `qCos`, `qSqrt`, etc.) are available via `<QtMath>`.

---

**A13-15** · LOW · `sendRequest()` declared `protected` but serves as a private timer slot

**Description:** `canbus.h` line 58 declares `sendRequest()` as `protected`. The method is connected exclusively as a `QTimer::timeout` slot (line 48 of `canbus.cpp`) and is not intended to be called or overridden by subclasses. `CanBus` is not designed as a base class (no virtual destructor, no other virtual methods). Exposing the timer slot as `protected` needlessly widens the access surface.

**Fix:** Move `sendRequest()` to the `private` section of `CanBus`. If subclassing is ever required, promote it back to `protected` deliberately.

---

**A13-16** · INFO · Commented-out struct field `//int timerId` in `Request`

**Description:** `canbus.h` line 22 contains `//int timerId;` commented out inside the `Request` struct. This suggests an earlier design where each request managed its own timer ID. The field is entirely unused and the comment has no explanatory text.

**Fix:** Remove the commented-out field. If the alternative design is of historical interest, document it in a git commit message rather than in source code.

---

**A13-17** · INFO · Commented-out `canBusDevice()` accessor in `canbus.h`

**Description:** `canbus.h` line 51 contains `//QCanBusDevice* canBusDevice() const {return m_canBusDevice;}` commented out. Exposing the raw `QCanBusDevice` pointer in the public interface would break encapsulation, so the accessor was presumably removed, but the commented line was left behind.

**Fix:** Remove the commented-out line entirely.

---

## Summary Table

| ID | Severity | Category | Location | Short Title |
|----|----------|----------|----------|-------------|
| A13-1 | HIGH | Dead / Broken Code | `gnssreceiver.h:47` | `inPoly2()` declared but never implemented |
| A13-2 | HIGH | Dead / Broken Code | `gnssreceiver.cpp:216` | `changeUpdateTime()` permanently stops GPS — timer restart commented out |
| A13-3 | MEDIUM | Error Handling | `canbus.cpp:116, 120, 148` | Suppressed `return` statements after fatal GPIO/subprocess failures |
| A13-4 | MEDIUM | Build Warning | `canbus.cpp:232` | Signed/unsigned: `quint32 last = -1` |
| A13-5 | MEDIUM | Magic Numbers | `gnssreceiver.cpp:349, 357` | Magic number `47757857` — derivation undocumented |
| A13-6 | MEDIUM | Dead Code | `gnssreceiver.cpp:13` | `EARTH_R` macro defined but never used |
| A13-7 | MEDIUM | Leaky Abstraction | `canbus.cpp:241–249` | Raw CAN protocol bit masks without named constants |
| A13-8 | MEDIUM | Style / API | `canbus.h:40` | `getRequests()` non-const and inconsistently named |
| A13-9 | MEDIUM | Commented-out Code | `gnssreceiver.cpp:123–126, 314–317, 324–326` | Legacy MK2 relay control blocks never removed |
| A13-10 | MEDIUM | Dead Code | `gnssreceiver.cpp:44–49` | `timerEvent()` is an empty stub — misleading dead code |
| A13-11 | LOW | Const-correctness | `gnssreceiver.h:35` | `age()` not declared `const` |
| A13-12 | LOW | Type Safety | `canbus.h:20–22` | `Request::timer` (qint32) vs `Request::interval` (quint32) mismatch |
| A13-13 | LOW | Style | `gnssreceiver.cpp:428–446` | Inconsistent indentation in `pointInPolygon()` |
| A13-14 | LOW | Style | `gnssreceiver.cpp:9` | Redundant C-style `<math.h>` alongside `<QtMath>` |
| A13-15 | LOW | Access Control | `canbus.h:58` | `sendRequest()` declared `protected` but should be `private` |
| A13-16 | INFO | Commented-out Code | `canbus.h:22` | Commented-out `timerId` field in `Request` struct |
| A13-17 | INFO | Commented-out Code | `canbus.h:51` | Commented-out `canBusDevice()` accessor |
