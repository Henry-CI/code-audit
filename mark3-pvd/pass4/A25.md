# Pass 4 Agent A25 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Auditor:** Agent A25
**Pass:** 4 — Code Quality

---

## 1. Reading Evidence

### 1.1 `ui/unlockreasondialog.h`

**Class:** `UnlockReasonDialog` (inherits `QDialog`)

| Element | Kind | Line |
|---------|------|------|
| `UnlockReasonDialog(QWidget *parent = 0)` | Constructor (public) | 16 |
| `~UnlockReasonDialog()` | Destructor (public) | 17 |
| `QString getReason()` | Public method | 18 |
| `void languageChanged(void)` | Public method | 19 |
| `Ui::UnlockReasonDialog *ui` | Private member | 22 |
| `void setReason()` | Private slot | 23 |
| `QString m_reason` | Private member | 24 |

Types/enums/constants defined: none.

Header guard macro: `UNLOCKREASONDIALOG_H` (guard comment at line 27 incorrectly reads `UNLOCKEDDIALOG_H`).

---

### 1.2 `ui/unlockreasondialog.cpp`

| Element | Kind | Lines |
|---------|------|-------|
| `UnlockReasonDialog::UnlockReasonDialog(QWidget *parent)` | Constructor | 5–32 |
| `UnlockReasonDialog::~UnlockReasonDialog()` | Destructor | 34–37 |
| `void UnlockReasonDialog::setReason()` | Private slot | 39–43 |
| `QString UnlockReasonDialog::getReason()` | Public method | 45–48 |
| `void UnlockReasonDialog::languageChanged(void)` | Public method | 50–71 |

Constants/magic values: none.

---

### 1.3 `ui/vorconfirmationdialog.h`

**Class:** `VORConfirmationDialog` (inherits `QDialog`)

| Element | Kind | Line |
|---------|------|------|
| `VORConfirmationDialog(QWidget *parent = 0)` | Constructor (public) | 15 |
| `~VORConfirmationDialog()` | Destructor (public) | 16 |
| `void isBeingTurnOn(bool on)` | Public method | 18 |
| `Ui::VORConfirmationDialog *ui` | Private member | 21 |
| `QTimer *m_timer` | Private member | 22 |
| `void hideEvent(QHideEvent *)` | Protected override | 25 |
| `void showEvent(QShowEvent *event = 0)` | Protected override | 26 |

Types/enums/constants defined: none.

---

### 1.4 `ui/vorconfirmationdialog.cpp`

| Element | Kind | Lines |
|---------|------|-------|
| `VORConfirmationDialog::VORConfirmationDialog(QWidget *parent)` | Constructor | 6–17 |
| `VORConfirmationDialog::showEvent(QShowEvent *event)` | Protected override | 19–23 |
| `VORConfirmationDialog::hideEvent(QHideEvent *)` | Protected override | 25–28 |
| `VORConfirmationDialog::~VORConfirmationDialog()` | Destructor | 30–33 |
| `void VORConfirmationDialog::isBeingTurnOn(bool on)` | Public method | 35–58 |

Magic numbers: `10000` (line 22 — 10-second timer).

---

### 1.5 `ui/vorwarningdialog.h`

**Class:** `VORWarningDialog` (inherits `QDialog`)

| Element | Kind | Line |
|---------|------|------|
| `VORWarningDialog(QWidget *parent = 0)` | Constructor (public) | 15 |
| `~VORWarningDialog()` | Destructor (public) | 16 |
| `Ui::VORWarningDialog *ui` | Private member | 19 |
| `QTimer *m_timer` | Private member | 20 |
| `void hideEvent(QHideEvent *)` | Protected override | 23 |
| `void showEvent(QShowEvent *event = 0)` | Protected override | 24 |

Types/enums/constants defined: none.

---

### 1.6 `ui/vorwarningdialog.cpp`

| Element | Kind | Lines |
|---------|------|-------|
| `VORWarningDialog::VORWarningDialog(QWidget *parent)` | Constructor | 5–15 |
| `VORWarningDialog::showEvent(QShowEvent *event)` | Protected override | 17–59 |
| `VORWarningDialog::hideEvent(QHideEvent *)` | Protected override | 61–64 |
| `VORWarningDialog::~VORWarningDialog()` | Destructor | 66–69 |

Magic numbers: `30000` (line 57 — 30-second timer).

---

## 2. Findings

---

**A25-1** · HIGH · Inverted boolean semantics in `isBeingTurnOn(bool on)`

**Description:** The public method `VORConfirmationDialog::isBeingTurnOn(bool on)` has inverted boolean semantics. The parameter name `isBeingTurnOn` reads as "is VOR being turned on", yet the implementation tests `if (!on)` to show the "turn ON" UI and `else` (i.e., `on == true`) to show the "turn OFF" UI. In plain terms: passing `true` produces the "turn OFF" confirmation and passing `false` produces the "turn ON" confirmation — the opposite of what the name implies.

The sole call site in `supervisordialog.cpp:132` passes `gCfg->convorStatus()`, which is non-zero when VOR is already active. Passing `1` (VOR currently on) therefore invokes the "turn OFF" branch, which happens to be the operationally correct flow (the user wants to toggle it off), but only because the inversion at the call site and the inversion in the implementation cancel each other out. Any future caller reading the method name and signature will expect `true` = "turning on" and will wire it correctly — but then get the wrong UI.

This is a logic-error / dead semantic: the method is named as a predicate query (`isBeing...`) but acts as a command setter, with its boolean parameter silently inverted relative to its name.

**Fix:** Rename the method to `setVORBeingTurnedOn(bool turningOn)` and correct the body so that `turningOn == true` shows the "turn ON" UI and `turningOn == false` shows the "turn OFF" UI. Update `supervisordialog.cpp:132` accordingly — the call should pass `!gCfg->convorStatus()` (i.e., VOR is currently off, so it is being turned on) to match the corrected semantics.

---

**A25-2** · MEDIUM · Method named as boolean predicate but used as a setter (misnaming / leaky abstraction)

**Description:** `isBeingTurnOn` (line 18 of `vorconfirmationdialog.h`) follows the `is...` naming convention that in C++ and Qt is reserved for boolean query functions returning `bool`. This method returns `void` and configures internal UI state. Callers reading the header cannot determine from the signature alone whether this is a getter or a setter. This constitutes a leaky abstraction: the public interface exposes the VOR on/off state as a raw bool rather than an enum or a named intent, and uses a misleading predicate name.

**Fix:** Replace the raw `bool` parameter with a scoped enum, e.g.:

```cpp
enum class VORAction { TurnOn, TurnOff };
void configureForAction(VORAction action);
```

This makes call sites self-documenting and removes the naming confusion entirely.

---

**A25-3** · MEDIUM · Deprecated Qt4 default constructor argument syntax (`QWidget *parent = 0`)

**Description:** All three dialog header files declare constructors with `QWidget *parent = 0` (null integer literal as a pointer default):

- `unlockreasondialog.h:16`
- `vorconfirmationdialog.h:15`
- `vorwarningdialog.h:15`

Similarly, `showEvent(QShowEvent *event = 0)` uses `= 0` in:

- `vorconfirmationdialog.h:26`
- `vorwarningdialog.h:24`

Using integer `0` as a null pointer constant is deprecated in C++11 and later and produces compiler warnings under `-Wzero-as-null-pointer-constant`. The correct idiom is `nullptr`.

**Fix:** Replace all `= 0` default pointer arguments with `= nullptr` across the three headers. The `showEvent` default argument is additionally questionable (see A25-4 below).

---

**A25-4** · MEDIUM · Default argument on `showEvent` overrides creates dead parameter path

**Description:** Both `VORConfirmationDialog::showEvent(QShowEvent *event = 0)` (h:26) and `VORWarningDialog::showEvent(QShowEvent *event = 0)` (h:24) declare a default argument on an override of a Qt protected virtual. Qt's event system always supplies a non-null `QShowEvent *` when it calls `showEvent`. The default argument `= 0` means a caller could invoke `dialog->showEvent()` directly (without an event object), which would produce undefined behaviour inside Qt's event dispatching chain and is never the intended usage. The matching `Q_UNUSED(event)` in `VORConfirmationDialog::showEvent` (cpp:21) makes this even clearer — the parameter is unused, so there is no legitimate reason to expose a default.

**Fix:** Remove the default argument from both `showEvent` overrides. The correct signature is `void showEvent(QShowEvent *event) override;`. Mark both overrides with `override` to catch future base-class signature changes.

---

**A25-5** · MEDIUM · Magic numbers for timer durations

**Description:** Timer start values are embedded as bare integer literals with no named constant:

- `vorconfirmationdialog.cpp:22` — `m_timer->start(10000)` (10-second auto-reject)
- `vorwarningdialog.cpp:57` — `m_timer->start(30000)` (30-second auto-reject, with an inline comment)

These magic numbers make it impossible to find or change all timeout values from a single location. The 10-second timeout in the confirmation dialog has no comment at all; a maintainer must derive its significance. The VOR confirmation dialog auto-rejects after 10 seconds, which is a safety-relevant timeout that could be accidentally changed.

**Fix:** Define named constants, either as `static constexpr int` members or in a shared constants header:

```cpp
static constexpr int kVORConfirmTimeoutMs  = 10'000;   // vorconfirmationdialog
static constexpr int kVORWarningTimeoutMs  = 30'000;   // vorwarningdialog
```

Replace the bare literals with the named constants and add a comment on `kVORConfirmTimeoutMs` explaining its safety rationale.

---

**A25-6** · LOW · Inconsistent `#include` of `QTimer` — missing from `vorconfirmationdialog.h`

**Description:** Both `VORConfirmationDialog` and `VORWarningDialog` hold a `QTimer *m_timer` private member. `vorwarningdialog.h` does not include `<QTimer>` directly (it is included only in the `.cpp`), and neither does `vorconfirmationdialog.h`. Both headers depend on a forward declaration being satisfied by a transitive include. If the include order in any translation unit changes, the headers will fail to compile in isolation. This is a fragility, not an immediate defect, but it violates the rule that each header should compile standalone.

**Fix:** Add `#include <QTimer>` (or at minimum `QT_FORWARD_DECLARE_CLASS(QTimer)`) to both `vorconfirmationdialog.h` and `vorwarningdialog.h`.

---

**A25-7** · LOW · Incorrect header guard comment in `unlockreasondialog.h`

**Description:** The closing `#endif` comment at line 27 of `unlockreasondialog.h` reads:

```cpp
#endif // UNLOCKEDDIALOG_H
```

but the guard macro defined at line 1 is `UNLOCKREASONDIALOG_H`. The comment is a copy-paste artefact and does not match the actual guard name.

**Fix:** Change line 27 to `#endif // UNLOCKREASONDIALOG_H`.

---

**A25-8** · LOW · Inline HTML template string hard-coded in `showEvent` — maintainability hazard

**Description:** `VORWarningDialog::showEvent` (cpp:25–53) constructs a multi-paragraph HTML string by concatenating six raw `QString` fragment literals, each containing full HTML 4.0 boilerplate including a `<!DOCTYPE>` declaration, inline `<style>`, and per-paragraph `<span>` wrappers. This HTML is hard-coded in an event handler that fires every time the dialog is shown, meaning the string allocation and construction happen on every show event. The content also hard-codes the font family `'MS Shell Dlg 2'` (Windows-specific shell font), which is inconsistent with the Ubuntu font specified inside the same snippet.

Additionally, the HTML construction is entirely separate from the translatable text strings (`text1`, `text2`, `text3`), but the HTML wrapper cannot itself be translated — if the UI ever needs different formatting per language, the function would require structural changes.

**Fix:** Move the static HTML wrapper text into the `.ui` file as the default rich-text content of `textEdit`, and replace the `showEvent` body with only the three `setText` calls for the translatable strings. Alternatively, use a `QTextDocument` with proper `setHtml` only once at construction and update only the translatable segments on language change.

---

**A25-9** · LOW · `setReason()` uses `sender()` cast without type guard

**Description:** `UnlockReasonDialog::setReason()` (cpp:41) casts `sender()` directly to `QPushButton *` without any runtime type check:

```cpp
m_reason = ((QPushButton *)sender())->text();
```

`QObject::sender()` returns `QObject *`. A C-style cast to `QPushButton *` bypasses Qt's type system. If the slot were ever accidentally connected to a non-`QPushButton` signal emitter, this would be undefined behaviour. The correct Qt idiom is `qobject_cast<QPushButton *>(sender())` with a null guard.

**Fix:** Replace with:

```cpp
QPushButton *btn = qobject_cast<QPushButton *>(sender());
if (btn) {
    m_reason = btn->text();
    emit accept();
}
```

---

**A25-10** · LOW · `override` keyword absent on all virtual overrides

**Description:** None of the overriding virtual methods in the three classes use the `override` specifier:

- `VORConfirmationDialog::hideEvent`, `showEvent` (h:25–26)
- `VORWarningDialog::hideEvent`, `showEvent` (h:23–24)

Without `override`, a typo in the method signature (e.g., wrong parameter type) silently creates a new virtual function rather than overriding the base class, and the base-class version is called instead. This is a standard C++11 best-practice violation.

**Fix:** Add `override` to all four method declarations in both headers.

---

**A25-11** · INFO · Style inconsistency: mixed indentation in `vorconfirmationdialog.cpp`

**Description:** `vorconfirmationdialog.cpp` mixes space-indentation (4 spaces, lines 35–57) with tab-indentation (lines 48 and 57 close-brace lines). The `isBeingTurnOn` function body at line 48 (`} else {`) and line 57 (`}`) uses a tab character while the surrounding code uses spaces. This is a minor style inconsistency indicating two different authors or editors touched this function.

**Fix:** Normalise the file to use 4-space indentation throughout, consistent with the rest of the `.cpp` files in the `ui/` directory.

---

**A25-12** · INFO · Typo in UI label name: `lblCornfirm` (missing 'f' in "confirm")

**Description:** `vorconfirmationdialog.cpp` references `ui->lblCornfirm` (lines 38, 41, 43, 50, 52) — the widget name in the `.ui` file is misspelled as `Cornfirm` instead of `Confirm`. This is a cosmetic defect in the form designer but it propagates into the C++ identifier, making the code harder to search and review.

**Fix:** Rename the widget in `vorconfirmationdialog.ui` from `lblCornfirm` to `lblConfirm` and update all references in the `.cpp` file. This requires a regeneration of the `ui_vorconfirmationdialog.h` auto-generated header.

---

## 3. Summary Table

| ID | Severity | Title | Location |
|----|----------|-------|----------|
| A25-1 | HIGH | Inverted boolean semantics in `isBeingTurnOn(bool on)` | `vorconfirmationdialog.h:18`, `vorconfirmationdialog.cpp:35–58` |
| A25-2 | MEDIUM | Method named as boolean predicate but used as a setter | `vorconfirmationdialog.h:18` |
| A25-3 | MEDIUM | Deprecated `= 0` null pointer default arguments | `unlockreasondialog.h:16`, `vorconfirmationdialog.h:15,26`, `vorwarningdialog.h:15,24` |
| A25-4 | MEDIUM | Default argument on `showEvent` override enables undefined-behaviour call path | `vorconfirmationdialog.h:26`, `vorwarningdialog.h:24` |
| A25-5 | MEDIUM | Magic numbers for safety-relevant timer durations | `vorconfirmationdialog.cpp:22`, `vorwarningdialog.cpp:57` |
| A25-6 | LOW | `<QTimer>` not included in headers that declare `QTimer *` members | `vorconfirmationdialog.h`, `vorwarningdialog.h` |
| A25-7 | LOW | Incorrect `#endif` guard comment | `unlockreasondialog.h:27` |
| A25-8 | LOW | Hard-coded inline HTML template built in `showEvent` on every show | `vorwarningdialog.cpp:25–53` |
| A25-9 | LOW | C-style cast of `sender()` without type guard | `unlockreasondialog.cpp:41` |
| A25-10 | LOW | `override` specifier absent on all virtual overrides | `vorconfirmationdialog.h:25–26`, `vorwarningdialog.h:23–24` |
| A25-11 | INFO | Mixed tab/space indentation in `vorconfirmationdialog.cpp` | `vorconfirmationdialog.cpp:48,57` |
| A25-12 | INFO | Typo `lblCornfirm` in widget name | `vorconfirmationdialog.cpp:38,41,43,50,52` |
