# Pass 4 Agent A19 — Code Quality

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `ui/checkcompleteddialog.h` + `ui/checkcompleteddialog.cpp`
- `ui/checkconfirmationdialog.h` + `ui/checkconfirmationdialog.cpp`
- `ui/checkquestiondialog.h` + `ui/checkquestiondialog.cpp`

---

## Reading Evidence

### `ui/checkcompleteddialog.h`

**Class:** `CheckCompletedDialog` (extends `QDialog`)

| Symbol | Kind | Line |
|--------|------|------|
| `CheckCompletedDialog(QWidget *parent = 0)` | constructor (public) | 17 |
| `~CheckCompletedDialog()` | destructor (public) | 18 |
| `languageChanged(void)` | method (public) | 20 |
| `isTimerActive()` | method (public) | 21 |
| `stopTimer()` | method (public) | 22 |
| `setCheckResponses(QList<CIGCONF::CheckResponse> &)` | inline method (public) | 23 |
| `openPreopNotes()` | signal | 31 |
| `showEvent(QShowEvent *event = 0)` | method (protected) | 33 |
| `ui` | member (`Ui::CheckCompletedDialog *`) | 36 |
| `m_timer` | member (`QTimer *`) | 37 |
| `m_checkResponses` | member (`QList<CIGCONF::CheckResponse>`) | 38 |

**Types/constants used:** `CIGCONF::CheckResponse` (from `app/cigconfigs.h`)

---

### `ui/checkcompleteddialog.cpp`

**Class:** `CheckCompletedDialog`

| Symbol | Kind | Line |
|--------|------|------|
| `CheckCompletedDialog(QWidget *parent)` | constructor | 7 |
| `~CheckCompletedDialog()` | destructor | 62 |
| `languageChanged()` | method | 67 |
| `showEvent(QShowEvent *event)` | method | 75 |
| `isTimerActive()` | method | 135 |
| `stopTimer()` | method | 140 |

**Macros defined:**
- `NO_ACTIVITY_TIME` — `10000` (milliseconds), defined at line 5

---

### `ui/checkconfirmationdialog.h`

**Class:** `CheckConfirmationDialog` (extends `QDialog`)

| Symbol | Kind | Line |
|--------|------|------|
| `CheckConfirmationDialog(QWidget *parent = 0)` | constructor (public) | 16 |
| `~CheckConfirmationDialog()` | destructor (public) | 17 |
| `confirm(bool yes)` | method (public) | 19 |
| `setQuestion(const QString &question)` | method (public) | 20 |
| `languageChanged(void)` | method (public) | 21 |
| `ui` | member (`Ui::CheckConfirmationDialog *`) | 24 |

No types, enums, or constants defined in this file.

---

### `ui/checkconfirmationdialog.cpp`

**Class:** `CheckConfirmationDialog`

| Symbol | Kind | Line |
|--------|------|------|
| `CheckConfirmationDialog(QWidget *parent)` | constructor | 4 |
| `~CheckConfirmationDialog()` | destructor | 24 |
| `confirm(bool yes)` | method | 29 |
| `setQuestion(const QString &question)` | method | 40 |
| `languageChanged()` | method | 45 |

The file is fully implemented with 54 lines of active code; no commented-out blocks are present.

---

### `ui/checkquestiondialog.h`

**Class:** `CheckQuestionDialog` (extends `QDialog`)

| Symbol | Kind | Line |
|--------|------|------|
| `CheckQuestionDialog(QWidget *parent = 0)` | constructor (public) | 17 |
| `~CheckQuestionDialog()` | destructor (public) | 18 |
| `question() const` | inline accessor (public) | 20 |
| `setQuestion(const QString &question, bool critical = false)` | method (public) | 21 |
| `shown()` | signal | 28 |
| `showEvent(QShowEvent *event)` | method (protected) | 31 |
| `ui` | member (`Ui::CheckQuestionDialog *`) | 34 |
| `m_question` | member (`QString`) | 35 |

No types, enums, or constants defined in this file.

---

### `ui/checkquestiondialog.cpp`

**Class:** `CheckQuestionDialog`

| Symbol | Kind | Line |
|--------|------|------|
| `CheckQuestionDialog(QWidget *parent)` | constructor | 4 |
| `~CheckQuestionDialog()` | destructor | 14 |
| `setQuestion(const QString &question, bool critical)` | method | 19 |
| `showEvent(QShowEvent *event)` | method | 39 |

---

## Findings

---

**A19-1** · HIGH · Deprecated `qrand()` used in `CheckQuestionDialog::setQuestion`

**Description:** `checkquestiondialog.cpp` line 24 calls `qrand() % 2` to randomly swap the YES/NO button positions. `qrand()` was deprecated in Qt 5.10 and is not available in Qt 6 without a compatibility shim. The replacement is `QRandomGenerator::global()->bounded(2)`. Beyond the deprecation issue, the intent of randomly swapping button positions on every question display is itself a usability concern (it prevents muscle-memory confirmation), but the immediate code-quality defect is the use of a deprecated API.

**Fix:** Replace `qrand() % 2` with `QRandomGenerator::global()->bounded(2)` and add `#include <QRandomGenerator>` to the translation unit.

---

**A19-2** · MEDIUM · Leaky abstraction — internal timer details exposed in `CheckCompletedDialog` public interface

**Description:** `checkcompleteddialog.h` declares `isTimerActive()` and `stopTimer()` as public methods, directly surfacing the existence and state of the internal `m_timer` to callers. At `dialog.cpp` lines 877–878 the caller must first query `isTimerActive()` before calling `stopTimer()`, reproducing guard logic that belongs inside the class. The `stopTimer()` implementation in `checkcompleteddialog.cpp` (lines 140–143) already performs the `isActive()` check internally, making the external check at the call site redundant. Exposing timer mechanics in the public API makes it harder to change the auto-dismiss mechanism in future without cascading changes to callers.

**Fix:** Remove `isTimerActive()` from the public interface. `stopTimer()` is idempotent (it already guards internally), so callers should call it unconditionally. Alternatively, rename the pair to a higher-level concept such as `cancelAutoDismiss()`.

---

**A19-3** · MEDIUM · Inconsistent member naming: `setCheckResponses` takes a non-const reference

**Description:** In `checkcompleteddialog.h` line 23 the inline setter is declared as `void setCheckResponses(QList<CIGCONF::CheckResponse> &responses)` — a non-const lvalue reference. This implies the method may modify the caller's list, which it does not (it merely copies into `m_checkResponses`). The other two dialog classes use `const QString &` for analogous setter parameters (`setQuestion` in both `CheckConfirmationDialog` and `CheckQuestionDialog`). The non-const reference is misleading and prevents callers from passing temporary or const objects.

**Fix:** Change the parameter to `const QList<CIGCONF::CheckResponse> &responses`.

---

**A19-4** · MEDIUM · Duplicated UI text setup between `languageChanged()` and `showEvent()` in `CheckCompletedDialog`

**Description:** `checkcompleteddialog.cpp` sets the same four UI strings (`label_2`, `btnSend_2`, `btnRepeat_2`, `btnNotes_2`) in both `languageChanged()` (lines 68–72) and `showEvent()` (lines 81–84). The duplication means any future translation change must be applied in two places and creates a risk of divergence. `CheckConfirmationDialog` and `CheckQuestionDialog` do not share this problem — they separate concerns cleanly.

**Fix:** Have `showEvent()` call `languageChanged()` for the text-setting portion, eliminating the duplicate block.

---

**A19-5** · LOW · Inconsistent constructor default-argument style across the three classes

**Description:** All three header files declare constructors with `QWidget *parent = 0` (null pointer as integer literal). Qt conventions and the C++11 standard prefer `nullptr`. `CheckCompletedDialog` and `CheckConfirmationDialog` also use `= 0` for the `showEvent` default parameter. `CheckQuestionDialog` (line 31) omits the default for `showEvent`, which is inconsistent with `CheckCompletedDialog` (line 33) and `Dialog` (line 93). None of the files uses `= nullptr`.

**Fix:** Replace all `= 0` pointer defaults with `= nullptr` throughout the three header files.

---

**A19-6** · LOW · `NO_ACTIVITY_TIME` macro defined in `.cpp` rather than as a typed constant

**Description:** `checkcompleteddialog.cpp` line 5 defines `NO_ACTIVITY_TIME` as a bare `#define` with value `10000`. This bypasses the type system (no `int` or `constexpr int` context), cannot be referenced from tests or related code without re-defining it, and contributes to the leaky-timer-abstraction problem noted in A19-2. The other two dialog files use no such macros.

**Fix:** Replace with a `static constexpr int kNoActivityTimeMs = 10000;` at class or file scope within `checkcompleteddialog.cpp`, or promote it to a named constant in `cigconfigs.h` if the timeout is a product-level configuration value.

---

**A19-7** · LOW · `showEvent` default parameter `= 0` on a protected override

**Description:** `checkcompleteddialog.h` line 33 declares `void showEvent(QShowEvent *event = 0)`. Adding a default argument to a virtual override (from `QWidget::showEvent(QShowEvent *)`) is unusual, potentially misleading, and the `= 0` form is discouraged in C++11 and later (see A19-5). The base class virtual does not declare a default argument for this parameter. `CheckQuestionDialog` correctly omits the default (line 31).

**Fix:** Remove the `= 0` default from the `showEvent` override declaration in `checkcompleteddialog.h`.

---

**A19-8** · INFO · Missing `languageChanged()` declaration in `CheckQuestionDialog`

**Description:** Both `CheckCompletedDialog` and `CheckConfirmationDialog` expose a public `languageChanged()` method used by the parent `Dialog` to update UI text when the language setting changes. `CheckQuestionDialog` has no `languageChanged()` method at all. Its `setQuestion()` method does call `tr("YES")` and `tr("NO")`, but those translations are only applied when a new question is set, not when the language changes mid-session. This is likely an oversight rather than intentional design.

**Fix:** Add a `languageChanged()` method to `CheckQuestionDialog` that re-applies `tr("YES")`/`tr("NO")` to the buttons, matching the pattern of the sibling classes.

---

## Summary Table

| ID | Severity | Title |
|----|----------|-------|
| A19-1 | HIGH | Deprecated `qrand()` in `CheckQuestionDialog::setQuestion` |
| A19-2 | MEDIUM | Leaky abstraction — timer details in `CheckCompletedDialog` public interface |
| A19-3 | MEDIUM | `setCheckResponses` takes non-const reference, inconsistent with sibling setters |
| A19-4 | MEDIUM | Duplicate UI text setup in `languageChanged()` and `showEvent()` |
| A19-5 | LOW | `= 0` pointer defaults should be `= nullptr` throughout |
| A19-6 | LOW | `NO_ACTIVITY_TIME` defined as untyped `#define` macro |
| A19-7 | LOW | `showEvent` protected override carries redundant default argument `= 0` |
| A19-8 | INFO | `CheckQuestionDialog` missing `languageChanged()` inconsistent with siblings |

**Total findings: 8** (1 HIGH, 3 MEDIUM, 3 LOW, 1 INFO)
