# Security Audit – Pass 2 (Test Coverage)
**Agent:** A03
**Audit Run:** 2026-02-28-01
**Branch Confirmed:** master
**Date:** 2026-02-28

---

## Assigned Files

| File | Lines |
|------|-------|
| `app/backgroundworker.cpp` | 3416 |
| `app/backgroundworker.h` | 195 |
| `app/checklist.cpp` | 242 |
| `app/checklist.h` | 49 |

**Primary test file:** `test/test_backgroundworker.cpp` + `test/test_backgroundworker.h`
**Additional test files examined:** `test/test_ota.cpp`, `test/test_canbus.cpp`, `test/test_dialog.cpp`

---

## Step 4 – Reading Evidence

### `app/backgroundworker.h`

**Class:** `OtaWorker` (line 38)
**Class:** `BackgroundWorker` (line 62)

#### `OtaWorker` – Public Methods
| Method | Line |
|--------|------|
| `OtaWorker(QObject *parent = nullptr)` (constructor) | 42 |
| `void unpack()` | 43 |

#### `OtaWorker` – Signals
| Signal | Line |
|--------|------|
| `sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra)` | 48 |
| `started()` | 49 |
| `ready()` | 50 |
| `failed()` | 51 |

#### `BackgroundWorker` – Public Methods
| Method | Line |
|--------|------|
| `BackgroundWorker(QObject *parent = nullptr)` (constructor) | 68 |
| `void setUI(Dialog *ui)` | 69 |
| `bool networkStatus()` | 70 |

#### `BackgroundWorker` – Signals
| Signal | Line |
|--------|------|
| `powerStateChanged(CIGCONF::PowerState state)` | 80 |
| `reboot()` | 81 |
| `lockScreen(CIGCONF::MaintLockedCode code, bool remote)` | 82 |
| `ambertImpactScreen()` | 83 |
| `cardAuthorised(bool yes, quint64 id)` | 84 |
| `updateStatusInfo(...)` | 85 |
| `cmdMsgReceived(CIGCONF::BroadcastMessage m)` | 86 |
| `onDemandStarted(quint32 start, quint32 end, quint64 id, ...)` | 87 |
| `onDemandExtended(quint32 start, quint32 end, quint64 id, ...)` | 88 |
| `onDemandEnded(quint32 end, quint64 id, ...)` | 89 |
| `sigLanguageChanged()` | 90 |
| `cmdLogin(quint64 id)` | 91 |
| `unpackOta()` | 92 |
| `cameraSettingsUpdated()` | 93 |
| `gmtpMessagePosted(const QByteArray &ba, bool highPriority)` (UNIT_TEST) | 95 |
| `leaderCmdResponse(const QByteArray &ba)` (UNIT_TEST) | 96 |

#### `BackgroundWorker` – Private Methods (slots/helpers)
| Method | Line |
|--------|------|
| `void initHash()` | 102 |
| `void ignitionStateChanged(bool on)` | 103 |
| `void parseLeaderCmd(const QByteArray &ba, bool local)` | 104 |
| `bool dispatchLeaderCmd(LeaderCmdType type, const QByteArray &header, const QByteArray &content)` | 105 |
| `void sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &ba)` | 106 |
| `void powerTimerEvent()` | 107 |
| `void onTimerEvent()` | 108 |
| `void changePowerState()` | 109 |
| `void updateFile(const QString &file)` | 110 |
| `void updateSelf(bool wait = false)` | 111 |
| `void updateFromRamdisk()` | 112 |
| `void timeChanged()` | 113 |
| `void quit(const QuitMode qm)` | 114 |
| `void quitWaitForAcks(const QuitMode qm)` | 115 |
| `void printDateBatt()` | 116 |
| `quint64 getKernelBuildDate()` | 117 |
| `quint64 convert2UTC(QString tzone, quint64 time)` | 118 |
| `bool pointInPolygon(int polyCorners, CIGCONF::position me, CIGCONF::position *points)` | 119 |
| `double degrees2radians(double degrees)` | 120 |
| `void testGeofence(qint32 lat, qint32 lon)` | 121 |
| `void checkAppCrash()` | 122 |
| `void checkSdSpace()` | 123 |
| `void checkFotaFail()` | 124 |
| `void dataTest()` | 126 |
| `void ethernetStateChanged(EthernetInterface interface, bool state)` | 128 |
| `QByteArray sendGmtpWifiPos()` | 129 |
| `void onAllAcksSent()` | 131 |
| `void handleModemConnection()` | 132 |
| `void handleNtpSynchronization(EthernetInterface interface, bool newState, bool &reconnect)` | 133 |
| `void handleWiFiConnection()` | 134 |
| `void monitTimer()` | 136 |
| `void initialiseCanbus1()` | 138 |
| `void initialiseCanbus2()` | 139 |

#### `backgroundworker.cpp` – File-scope functions
| Function | Line |
|----------|------|
| `QByteArray streamUncompress(QByteArray &chunk, z_stream &strm, bool &finished)` | 49 |
| `quint16 crc16(quint16& state, const QByteArray &chunk)` | 130 |

#### `backgroundworker.cpp` – Includes
```
backgroundworker.h, utils/logger.h, platform/blecentral.h, platform/canbus.h,
platform/gnssreceiver.h, platform/internalrtc.h, platform/modemport.h,
platform/powersupply.h, platform/pwmbacklight.h, platform/pwmbeeper.h,
platform/seriallogger.h, platform/userport.h, platform/wifi.h,
comm/bleexpansion.h, comm/bleinputhandler.h, comm/canmonitor.h,
comm/canexpansion.h, comm/canstatehandler.h, comm/modemchat.h,
comm/gmtpchat.h, comm/ntpsync.h, comm/ftpclient.h,
app/globalconfigs.h, ui/dialog.h, mytranslator.h,
QApplication, QProcess, QFileInfo, QDebug, QLoggingCategory,
QNetworkConfiguration, QFile, QStorageInfo, QThread, algorithm, math.h,
utils/zlib.h, fcntl.h
```

---

### `app/checklist.h`

**Class:** `Checklist` (line 6)

#### `Checklist` – Public Methods
| Method | Line |
|--------|------|
| `Checklist()` (constructor) | 23 |
| `static bool isValidCheckItem(const CheckItem &item)` | 25 |
| `void readChecklist()` | 27 |
| `void saveChecklist()` | 29 |
| `void clear()` | 30 |
| `void shuffleChecklist()` | 31 |
| `const CheckItem & checkItem(int index, bool query = false) const` | 34 |
| `bool setCheckItem(int index, const CheckItem &item)` | 35 |
| `quint32 checksum() const` | 36 |

#### `Checklist` – Private Methods
| Method | Line |
|--------|------|
| `bool readChecklist50()` | 39 |
| `bool readChecklist100()` | 40 |
| `quint8 copyAllRandomPreop(CheckItem *randomPreop)` | 41 |

#### `checklist.cpp` – Includes
```
checklist.h, QFile, QSaveFile, QDataStream, QTime, app/globalconfigs.h, algorithm
```

---

### `test/test_backgroundworker.h` – Test Slots

| Test Method | Line |
|-------------|------|
| `initTestCase()` | 11 |
| `cleanupTestCase()` | 12 |
| `init()` | 13 |
| `test_cmdIddeny()` | 15 |
| `test_cmdIdlelock()` | 16 |
| `test_cmdUnlkmode()` | 17 |
| `test_cmdShowtime()` | 18 |
| `test_cmdChktsum()` | 19 |
| `test_cmdVdimode()` | 20 |
| `test_cmdCamera()` | 21 |
| `test_cmdCameraFlip()` | 22 |

---

## Step 5 – Test Coverage Analysis

### Legend
- **Tested** = covered by at least one test assertion
- **Partial** = some paths tested, others not
- **None** = no test exercises this code

### `BackgroundWorker` – Coverage Summary

| Method / Command | Tested? | Notes |
|-----------------|---------|-------|
| Constructor | None | Object is instantiated in test setup but constructor logic (timer setup, OTA thread start, signal wiring) is not verified |
| `setUI()` | Partial | Called in test setup; signal connections not independently verified |
| `networkStatus()` | None | No test reads or asserts on this method |
| `initHash()` | Partial | Hash populated implicitly; individual entries exercised only for tested commands |
| `parseLeaderCmd()` – local AT echo | None | "AT" command path not tested |
| `parseLeaderCmd()` – AT^ prefix stripping | Partial | Tested implicitly for set commands; query path not separately tested |
| `parseLeaderCmd()` – RS-232 access guard | None | isRs232AccessoryActive() false path not tested |
| `dispatchLeaderCmd()` – CMD_SAVE (AT&W) | None | Not tested |
| `dispatchLeaderCmd()` – CMD_KALV | None | Not tested |
| `dispatchLeaderCmd()` – CMD_SHTD | None | Not tested |
| `dispatchLeaderCmd()` – CMD_IDNT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_PRFX | None | Not tested |
| `dispatchLeaderCmd()` – CMD_FTPF | None | Not tested |
| `dispatchLeaderCmd()` – CMD_IDBATCH / CMD_IDSAVE | None | Not tested |
| `dispatchLeaderCmd()` – CMD_CLRMEM | None | Not tested |
| `dispatchLeaderCmd()` – CMD_REBOOT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_MAINT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_FMTSD | None | Not tested |
| `dispatchLeaderCmd()` – CMD_PRFL | None | Not tested |
| `dispatchLeaderCmd()` – CMD_HOST / CMD_PORT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_RLY1 / CMD_RLY2 | None | Not tested |
| `dispatchLeaderCmd()` – CMD_RLY1TO / CMD_RLY2TO | None | Not tested |
| `dispatchLeaderCmd()` – CMD_MAC | None | Not tested |
| `dispatchLeaderCmd()` – CMD_FIDL / CMD_FIDM / CMD_FIDS / CMD_FIDT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_IDAUTH | None | Not tested |
| `dispatchLeaderCmd()` – CMD_IDDENY | Tested | test_cmdIddeny covers normal, master-only, driver+master, and error paths |
| `dispatchLeaderCmd()` – CMD_IDMAST / CMD_IDSMAST | None | Not tested |
| `dispatchLeaderCmd()` – CMD_IDCLEAR | None | Not tested |
| `dispatchLeaderCmd()` – CMD_IDTAUTH / CMD_IDTDENY | None | Not tested |
| `dispatchLeaderCmd()` – CMD_CHKT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_SURTO / CMD_SURV | None | Not tested |
| `dispatchLeaderCmd()` – CMD_CLR_CHKT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_CLEAR_LIST | None | Not tested |
| `dispatchLeaderCmd()` – CMD_PREC | None | Not tested |
| `dispatchLeaderCmd()` – CMD_OPCHK | Partial | test_dialog.cpp exercises set path via at^opchk but only one variant; error paths missing |
| `dispatchLeaderCmd()` – CMD_FSSS / CMD_FSSX / CMD_FSSP / CMD_FSST | None | Not tested |
| `dispatchLeaderCmd()` – CMD_TIME | None | Not tested |
| `dispatchLeaderCmd()` – CMD_TZONE / CMD_THOST | None | Not tested |
| `dispatchLeaderCmd()` – CMD_GPSR | None | Not tested |
| `dispatchLeaderCmd()` – CMD_TGFNCE / CMD_GFNCE | None | Not tested |
| `dispatchLeaderCmd()` – CMD_SATNUM | None | Not tested |
| `dispatchLeaderCmd()` – CMD_DEBUG | None | Not tested |
| `dispatchLeaderCmd()` – CMD_CLRCAN | Partial | Called in test_canbus setup; no response assertion in test_backgroundworker |
| `dispatchLeaderCmd()` – CMD_CANCFG / CMD_CANPGN / CMD_CANSPN / CMD_CANATT / CMD_CANLIN / CMD_CANBYD / CMD_CANLIN2 / CMD_CANCRC | Partial | Covered in test_canbus.cpp only |
| `dispatchLeaderCmd()` – CMD_IDLE | None | Not tested |
| `dispatchLeaderCmd()` – CMD_BATT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_POWEROFF / CMD_QUIT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_DBGPWR / CMD_DBGBLE / CMD_DBGRAM | None | Not tested |
| `dispatchLeaderCmd()` – CMD_CONVOR | None | Not tested |
| `dispatchLeaderCmd()` – CMD_MSG | None | Not tested |
| `dispatchLeaderCmd()` – CMD_WIFI / CMD_CLRWIFI / CMD_WIFIPOS | None | Not tested |
| `dispatchLeaderCmd()` – CMD_UNLKSCR | None | Not tested |
| `dispatchLeaderCmd()` – CMD_LOGLVL | None | Not tested |
| `dispatchLeaderCmd()` – CMD_SCRSAV | None | Not tested |
| `dispatchLeaderCmd()` – CMD_DIGCFG | None | Not tested |
| `dispatchLeaderCmd()` – CMD_SEENPAR | None | Not tested |
| `dispatchLeaderCmd()` – CMD_MDMAT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_GMTPTIMER | None | Not tested |
| `dispatchLeaderCmd()` – CMD_LANG | None | Not tested |
| `dispatchLeaderCmd()` – CMD_LOCKOUT | None | Not tested |
| `dispatchLeaderCmd()` – CMD_OPRNDM | None | Not tested |
| `dispatchLeaderCmd()` – CMD_SHOWNAMES | None | Not tested |
| `dispatchLeaderCmd()` – CMD_GPSMSG | None | Not tested |
| `dispatchLeaderCmd()` – CMD_SHOWPC | None | Not tested |
| `dispatchLeaderCmd()` – CMD_LOGIN | None | Not tested |
| `dispatchLeaderCmd()` – CMD_MDMRST | None | Not tested |
| `dispatchLeaderCmd()` – CMD_AMIMP | None | Not tested |
| `dispatchLeaderCmd()` – CMD_OPDCHK | None | Not tested |
| `dispatchLeaderCmd()` – CMD_UPDOTA | None | Not tested |
| `dispatchLeaderCmd()` – CMD_IDLELOCK | Tested | test_cmdIdlelock covers on/off/invalid |
| `dispatchLeaderCmd()` – CMD_CHKTSUM | Tested | test_cmdChktsum covers on/off/invalid |
| `dispatchLeaderCmd()` – CMD_UNLKMODE | Tested | test_cmdUnlkmode covers on/off/invalid |
| `dispatchLeaderCmd()` – CMD_SHOWTIME | Tested | test_cmdShowtime covers 0/1/2/3 |
| `dispatchLeaderCmd()` – CMD_VDIMODE | Tested | test_cmdVdimode covers on/off/invalid |
| `dispatchLeaderCmd()` – CMD_CAMERA | Tested | test_cmdCamera covers off/forced/on/invalid |
| `dispatchLeaderCmd()` – CMD_CAMERAFLIP | Tested | test_cmdCameraFlip covers on/off/invalid |
| `sendGmtpMessage()` (private) | Partial | Some message types exercised via integration; most switch branches untested in isolation |
| `powerTimerEvent()` | None | No test for power state transitions |
| `onTimerEvent()` | None | Not tested |
| `changePowerState()` | None | Returns early in UNIT_TEST mode; state machine transitions untested |
| `ignitionStateChanged()` | None | Not tested |
| `updateFile()` | None | Not tested |
| `updateSelf()` | Tested | test_ota.cpp::test_unpack exercises success and CRC-failure cases |
| `updateFromRamdisk()` | None | Not tested |
| `timeChanged()` | None | Not tested |
| `quit()` | None | Not tested |
| `quitWaitForAcks()` | None | Not tested |
| `onAllAcksSent()` | None | Not tested |
| `printDateBatt()` | None | Not tested |
| `getKernelBuildDate()` | None | Not tested |
| `convert2UTC()` | None | Not tested |
| `pointInPolygon()` | None | Not tested |
| `degrees2radians()` | None | Not tested |
| `testGeofence()` | None | Not tested |
| `checkAppCrash()` | None | Not tested |
| `checkSdSpace()` | None | Not tested |
| `checkFotaFail()` | None | Not tested |
| `dataTest()` | None | Debug function, no test |
| `ethernetStateChanged()` | None | Not tested |
| `handleModemConnection()` | None | Not tested |
| `handleWiFiConnection()` | None | Not tested |
| `handleNtpSynchronization()` | None | Not tested |
| `sendGmtpWifiPos()` | None | Not tested |
| `monitTimer()` | None | Not tested |
| `initialiseCanbus1()` | Partial | Called in test_canbus.cpp setup; guard (if m_canBus1 return) not tested |
| `initialiseCanbus2()` | Partial | Called in test_canbus.cpp setup; guard not tested |
| `streamUncompress()` (file-scope) | Partial | Exercised via test_unpack for success and truncated-data; Z_BUF_ERROR and multi-chunk paths untested |
| `crc16()` (file-scope) | Partial | Exercised via test_unpack for happy path and mismatch only |

### `Checklist` – Coverage Summary

| Method | Tested? | Notes |
|--------|---------|-------|
| `Checklist()` | None | No dedicated Checklist unit tests |
| `isValidCheckItem()` | None | Not directly tested |
| `readChecklist()` | None | Not directly tested |
| `readChecklist50()` | None | Not tested |
| `readChecklist100()` | None | Not tested |
| `saveChecklist()` | None | Not tested |
| `clear()` | None | gCfg->clearChecklist() is called in test_dialog but Checklist::clear() has no direct unit test |
| `shuffleChecklist()` | None | Not tested |
| `copyAllRandomPreop()` | None | Not tested |
| `checkItem()` | None | Not tested directly |
| `setCheckItem()` | None | Not tested directly |
| `checksum()` | None | Not tested |

---

## Findings

**A03-1** · HIGH · Missing Tests – Large Set of Untested Command Handlers
**File:** app/backgroundworker.cpp:512
**Description:** `dispatchLeaderCmd()` contains approximately 70 distinct command switch cases. Of these, only 8 are covered by tests in `test_backgroundworker.cpp` (IDLELOCK, CHKTSUM, UNLKMODE, SHOWTIME, VDIMODE, CAMERA, CAMERAFLIP, IDDENY). The remaining roughly 62 cases have zero test coverage including security-sensitive handlers: CMD_IDAUTH (add driver), CMD_IDMAST (add supervisor), CMD_REBOOT (force reboot), CMD_MAINT (force lock screen), CMD_FMTSD (format SD card), CMD_TIME (set RTC), CMD_CLRMEM (wipe all config), CMD_FTPF (initiate FTP download). Any regression, boundary violation, or format-string error in these handlers is undetectable by automated testing.
**Fix:** Add individual test methods for each untested command, covering the set path, the query path, the empty-content error path, and at least one out-of-range value. Prioritise commands that modify security-sensitive state (CMD_IDAUTH, CMD_IDMAST, CMD_REBOOT, CMD_MAINT, CMD_FMTSD, CMD_TIME, CMD_CLRMEM).

---

**A03-2** · HIGH · No Unit Tests for `Checklist` Class
**File:** app/checklist.cpp:1
**Description:** The entire `Checklist` class (9 public methods, 3 private methods) has no dedicated unit tests. The class handles binary file I/O for safety-critical pre-operation checklist data. Bugs in parsing, saving, shuffling, or checksum computation would not be caught by automated tests. The class is used directly by `GlobalConfigs` which is exercised in `test_dialog.cpp`, but only through high-level operations that do not validate the internal state of the `Checklist` object.
**Fix:** Create a `test_checklist.cpp` test file with tests for: (1) reading a well-formed v50 file, (2) reading a well-formed v100 file, (3) reading a missing file, (4) reading a truncated/corrupt file, (5) `saveChecklist` round-trip, (6) `shuffleChecklist` with zero/one/many items, (7) `setCheckItem` at boundary indices (0, MAX_IDX-1, -1, MAX_IDX), (8) `checksum` with empty list and with known items.

---

**A03-3** · HIGH · `streamUncompress()` Static Variable Causes Non-Reentrant Behavior and Incomplete Test Coverage
**File:** app/backgroundworker.cpp:58
**Description:** `streamUncompress()` uses `static bool headerSkipped = false` at line 58. This static local is shared across all calls within the same process lifetime. In `test_unpack`, Test 2 (corrupted file) runs immediately after Test 1 in the same process. If Test 1 exits an error path that does not reset `headerSkipped`, Test 2 will incorrectly skip the 4-byte header on the first chunk. More broadly, this design makes the function non-reentrant and prevents reliable isolated testing. The current tests do not cover: multi-chunk decompression across loop iterations, the Z_BUF_ERROR return from `inflate`, or correct behavior after a prior error call.
**Fix:** Eliminate the static variable by passing `headerSkipped` as a reference parameter or by encapsulating the entire stream state (`z_stream`, `headerSkipped`) in a caller-owned struct. Add tests that simulate multi-chunk decompression and the Z_BUF_ERROR return path.

---

**A03-4** · MEDIUM · `parseLeaderCmd()` RS-232 Access Guard and AT Echo Paths Not Tested
**File:** app/backgroundworker.cpp:462
**Description:** Lines 462-470 contain a guard that drops local set commands when `gCfg->isRs232AccessoryActive()` returns false. This security control is not exercised in any test. A regression in this condition could allow unauthorized local command execution. Additionally, the `"AT"` echo command path (line 448) is never tested.
**Fix:** Add a test that sets `isRs232AccessoryActive()` to false and confirms that a local set command (e.g., `at^kalv=10`) is silently dropped. Add a test for the `AT` echo that verifies `leaderCmdResponse("OK\r\n")` is emitted.

---

**A03-5** · MEDIUM · Power State Machine Completely Untested
**File:** app/backgroundworker.cpp:2604
**Description:** `powerTimerEvent()`, `onTimerEvent()`, `changePowerState()`, and `ignitionStateChanged()` implement the device power state machine (`NormalPowerState`, `PreDimState`, `DimState`, `SleepActiveState`, `SleepState`, `PowerOffState`). None of these functions has any test coverage. `changePowerState()` returns immediately in `UNIT_TEST` mode (line 2652), but the state transition logic in `powerTimerEvent()` and the initialisation sequence in `ignitionStateChanged()` remain exercisable.
**Fix:** Add tests that call `ignitionStateChanged(true)` and `ignitionStateChanged(false)` and verify the resulting `m_powerState` value and timer start/stop behavior. Test `powerTimerEvent()` by pre-setting `m_powerState` to each value and verifying the state transitions.

---

**A03-6** · MEDIUM · Geofence Logic Not Tested
**File:** app/backgroundworker.cpp:2446
**Description:** `degrees2radians()` (line 2446), `pointInPolygon()` (line 2450), and `testGeofence()` (line 2470) implement coordinate mathematics used to determine whether a vehicle is inside a restricted zone. None of these functions is exercised by any test. Edge cases such as zero-corner polygons, a point exactly on a boundary, polygons with the minimum valid corner count (3), and maximum coordinate values are untested.
**Fix:** Add unit tests for `degrees2radians` (0, 90, 180, 360, negative), `pointInPolygon` (point inside, point outside, point on edge, zero corners), and `testGeofence` against a known polygon and coordinate pair. Expose these as `friend` or make them free functions to allow direct testing.

---

**A03-7** · MEDIUM · `getKernelBuildDate()` and `convert2UTC()` Not Tested
**File:** app/backgroundworker.cpp:3060
**Description:** `getKernelBuildDate()` parses `/proc/version` using a regular expression and string manipulation. `convert2UTC()` applies a hard-coded timezone offset only for `"PDT"` and silently falls through for all other timezone strings (including an implicit `return time` that does not adjust at all for non-PDT zones). Both functions lack any tests. A malformed `/proc/version` produces a silent zero result sent to the server.
**Fix:** Test `convert2UTC` with `"PDT"`, an empty string, and an unrecognised timezone. Test `getKernelBuildDate` by temporarily providing a controlled fixture representing `/proc/version` content with a known date string, and verify the returned timestamp.

---

**A03-8** · MEDIUM · `checkAppCrash()`, `checkSdSpace()`, `checkFotaFail()` Not Tested
**File:** app/backgroundworker.cpp:3243
**Description:** These three startup-diagnostic functions interact with the filesystem and emit GMTP messages. They are called unconditionally at startup (lines 2790-2792). None has any test. Regressions (e.g., failure to remove the sentinel file, incorrect GMTP message format, `awk` output parsing failure in `checkSdSpace`) would go undetected.
**Fix:** Add tests that pre-create each sentinel file, call the function under test, and verify: (a) the correct GMTP message is emitted via `gmtpMessagePosted` signal spy, and (b) the sentinel file is removed. Also test each function when the sentinel file does not exist (no-op path).

---

**A03-9** · MEDIUM · `ethernetStateChanged()` and Network Helper Functions Not Tested
**File:** app/backgroundworker.cpp:3121
**Description:** `ethernetStateChanged()`, `handleModemConnection()`, `handleWiFiConnection()`, and `handleNtpSynchronization()` implement network failover logic. These are not exercised by any test. Regressions in the modem-vs-WiFi priority logic or NTP reconnection trigger would be undetectable.
**Fix:** Refactor network-setup shell calls (`QProcess::execute`) into a virtual or injectable helper so they can be suppressed in tests. Add tests that call `ethernetStateChanged` with modem-up, WiFi-up, modem-then-WiFi, and both-down scenarios and verify the resulting state of `m_modemState`, `m_wifiState`, and the GMTP chat ethernet state.

---

**A03-10** · MEDIUM · `CMD_OPCHK` Error Paths Not Tested
**File:** app/backgroundworker.cpp:1103
**Description:** `test_dialog.cpp` issues `at^opchk=1,1,0,"Test?"` which exercises only one happy-path variant of CMD_OPCHK. The following error paths have no test: (1) fewer than 4 arguments, (2) `qId == 0` rejection, (3) `type > CriticalByNo` rejection, (4) `doNotRandomize > 1` rejection, (5) `questionLen > CHECKLIST_QUESTION_LEN_100` rejection, (6) `index` out of range, (7) the query path that enumerates all items.
**Fix:** Add test cases for each rejection path in `dispatchLeaderCmd` for CMD_OPCHK, and add a query test that verifies the formatted response matches expected output.

---

**A03-11** · MEDIUM · `Checklist::checkItem()` Missing Bounds Check and No Tests
**File:** app/checklist.cpp:238
**Description:** `checkItem(int index, bool query)` performs a direct array access on `m_checkItems[index]` and `m_checkItems_shuffled[index]` without any bounds check on `index`. The companion `setCheckItem()` (line 178) does validate bounds. If a caller passes a negative value or a value >= `CHECKLIST_MAX_IDX`, the function will access memory out of the array bounds, causing undefined behaviour. No test exercises this function at all.
**Fix:** Add a bounds check in `checkItem()` consistent with the one in `setCheckItem()`. Add unit tests for `checkItem(-1)`, `checkItem(0)`, `checkItem(CHECKLIST_MAX_IDX - 1)`, and `checkItem(CHECKLIST_MAX_IDX)`, verifying a safe default is returned for out-of-bounds indices.

---

**A03-12** · MEDIUM · `Checklist::shuffleChecklist()` Potential Out-of-Bounds Write Not Tested
**File:** app/checklist.cpp:221
**Description:** In `shuffleChecklist()`, `randomPreopIndex` is incremented unconditionally at line 223 for every slot in `m_checkItems_shuffled` where `doNotRandomize == 0`. If the number of such slots exceeds `numberOfRandomPreop` (the count of items copied into the stack-allocated `randomPreop[CHECKLIST_MAX_IDX]` array), `randomPreopIndex` will exceed the bounds of that array causing an out-of-bounds read. There is no guard before the assignment. No test covers this scenario.
**Fix:** Add a guard `if (randomPreopIndex < numberOfRandomPreop)` before line 223. Add a unit test that constructs a checklist where the number of randomisable slots differs from the number populated, and verify no crash or data corruption occurs.

---

**A03-13** · MEDIUM · `Checklist::readChecklist50()` Returns `true` on Malformed File
**File:** app/checklist.cpp:22
**Description:** `readChecklist50()` returns `true` even if zero valid items were loaded (the loop body exits on the first iteration due to an invalid index or out-of-range type/len). A caller checking the return value to decide whether the checklist was successfully loaded will incorrectly treat an empty or malformed file as a successful read, potentially masking data corruption. No test verifies this behavior.
**Fix:** Consider returning `false` if zero items were loaded from a non-empty file. Add tests with: (a) a valid file containing one item, (b) a file whose first item has an invalid type (>2), and (c) a file whose first item has an invalid length. Verify the return value and the resulting state of `m_checkItems` for each case.

---

**A03-14** · LOW · `OtaWorker::unpack()` Mutex Re-Entry Guard Not Tested
**File:** app/backgroundworker.cpp:146
**Description:** `unpack()` calls `m_mutex.tryLock()` at line 148 and returns early if the lock is already held, preventing concurrent re-entry. This guard has no test. A test should confirm that a second simultaneous call is silently ignored and does not corrupt the in-progress unpack operation.
**Fix:** Add a test that initiates `updateSelf()` on a sufficiently large file and immediately calls `updateSelf()` again, verifying that `m_isRunning` remains 1 throughout and that only one `started()` signal is emitted.

---

**A03-15** · LOW · `networkStatus()` Not Tested
**File:** app/backgroundworker.h:70
**Description:** `networkStatus()` returns `m_wifiState || m_modemState`. This is a public API method with no test. If the underlying fields are refactored, breakage would go undetected.
**Fix:** Add a test that sets `m_wifiState` and `m_modemState` to known values (via friend access available in UNIT_TEST mode) and asserts the return value of `networkStatus()` for all four input combinations.

---

**A03-16** · LOW · `Checklist::checksum()` XOR Algorithm Does Not Detect Duplicate Question IDs
**File:** app/checklist.cpp:188
**Description:** `checksum()` XORs all valid `questionId` values. XOR checksums are insensitive to duplicate values (two identical IDs cancel each other out) and to reordering. A checklist with the same question listed twice produces the same checksum as a checklist missing both instances. No test documents or verifies this behavior.
**Fix:** Add a unit test that demonstrates the XOR cancellation behavior with duplicate IDs and either documents it as intentional or replaces the algorithm with a stronger accumulation method (e.g., additive checksum, CRC, or simple hash).

---

**A03-17** · LOW · Test Teardown Memory Leak – `BackgroundWorker` Worker Not Deleted
**File:** test/test_backgroundworker.cpp:48
**Description:** `cleanupTestCase()` has `delete m_worker` and `m_worker = nullptr` commented out (lines 56-57). The `m_worker` pointer is never freed. While this is a test-only issue, it masks potential object lifetime and signal/slot lifetime bugs and can cause spurious failures when all test suites run sequentially in a single process.
**Fix:** Re-enable the `delete m_worker` call, ensuring the worker thread is quit and waited before deletion, or document with a comment why deletion is suppressed and verify no use-after-free risk exists.

---

## Summary Table

| ID | Severity | Category | File | Brief Description |
|----|----------|----------|------|-------------------|
| A03-1 | HIGH | Missing Tests | backgroundworker.cpp:512 | ~62 of ~70 dispatchLeaderCmd cases have zero test coverage |
| A03-2 | HIGH | Missing Tests | checklist.cpp:1 | Entire Checklist class has no unit tests |
| A03-3 | HIGH | Test Isolation / Design | backgroundworker.cpp:58 | Static variable in streamUncompress causes non-reentrant behavior and incomplete coverage |
| A03-4 | MEDIUM | Missing Tests | backgroundworker.cpp:462 | RS-232 access guard and AT echo command paths untested |
| A03-5 | MEDIUM | Missing Tests | backgroundworker.cpp:2604 | Power state machine transitions not tested |
| A03-6 | MEDIUM | Missing Tests | backgroundworker.cpp:2446 | Geofence math functions have no tests |
| A03-7 | MEDIUM | Missing Tests | backgroundworker.cpp:3060 | getKernelBuildDate and convert2UTC not tested |
| A03-8 | MEDIUM | Missing Tests | backgroundworker.cpp:3243 | checkAppCrash, checkSdSpace, checkFotaFail not tested |
| A03-9 | MEDIUM | Missing Tests | backgroundworker.cpp:3121 | ethernetStateChanged and network helpers not tested |
| A03-10 | MEDIUM | Incomplete Tests | backgroundworker.cpp:1103 | CMD_OPCHK has one happy-path test only; all error paths missing |
| A03-11 | MEDIUM | Missing Tests / Defect | checklist.cpp:238 | checkItem() has no bounds check and no tests |
| A03-12 | MEDIUM | Missing Tests / Defect | checklist.cpp:221 | shuffleChecklist() can read out of bounds on randomPreop; not tested |
| A03-13 | MEDIUM | Missing Tests | checklist.cpp:22 | readChecklist50 returns true on malformed file; not tested |
| A03-14 | LOW | Missing Tests | backgroundworker.cpp:146 | OtaWorker mutex re-entry guard not tested |
| A03-15 | LOW | Missing Tests | backgroundworker.h:70 | networkStatus() not tested |
| A03-16 | LOW | Design / Documentation | checklist.cpp:188 | XOR checksum does not detect duplicate IDs; behavior not documented |
| A03-17 | LOW | Test Quality | test/test_backgroundworker.cpp:48 | BackgroundWorker worker leaked in test teardown |
