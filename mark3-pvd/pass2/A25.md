# Audit Report — Agent A25 — Pass 2: Test Coverage

**Agent ID:** A25
**Audit Run:** 2026-02-28-01
**Pass:** 2 — Test Coverage
**Branch confirmed:** master (verified via `git branch --show-current`)
**Date:** 2026-02-28

---

## Assigned Files

| File | Role |
|---|---|
| `ui/unlockreasondialog.cpp` | Implementation |
| `ui/unlockreasondialog.h` | Header |
| `ui/vorconfirmationdialog.cpp` | Implementation |
| `ui/vorconfirmationdialog.h` | Header |
| `ui/vorwarningdialog.cpp` | Implementation |
| `ui/vorwarningdialog.h` | Header |

---

## Reading Evidence

### UnlockReasonDialog

**Class:** `UnlockReasonDialog` extends `QDialog`

**Includes (cpp):**
- `unlockreasondialog.h` (line 1)
- `ui_unlockreasondialog.h` (line 2)
- `<QPushButton>` (line 3)

**Includes (h):**
- `<QDialog>` (line 4)
- `<QString>` (line 5)

**Public methods:**
- `explicit UnlockReasonDialog(QWidget *parent = 0)` — h:16, cpp:5
- `~UnlockReasonDialog()` — h:17, cpp:34
- `QString getReason()` — h:18, cpp:45
- `void languageChanged(void)` — h:19, cpp:50

**Private methods:**
- `void setReason()` — h:23, cpp:39

**Private members:**
- `Ui::UnlockReasonDialog *ui` — h:22
- `QString m_reason` — h:24 (initialised to `""` at cpp:8)

**Signal/slot wiring in constructor (cpp:12–31):**
- 10 x `QPushButton::clicked` -> `setReason` for Red Impact buttons (R1–R10)
- 2 x `QPushButton::clicked` -> `setReason` for Checklist Timeout buttons (R1–R2)
- 2 x `QPushButton::clicked` -> `setReason` for Checklist Lockout buttons (R1–R2)
- `btnDone::clicked` -> `reject` (cpp:31)

**Key logic:**
- `setReason()` (cpp:39–43): casts `sender()` to `QPushButton*` via C-style cast and reads `.text()`, then calls `emit accept()`.
- `getReason()` (cpp:45–48): returns `m_reason`.
- `languageChanged()` (cpp:50–71): retranslates all button labels.
- No `accept()` signal override; the class calls `emit accept()` directly inside `setReason()`. The `m_reason` default is `""` if the dialog is dismissed via `btnDone` (which calls `reject()`).

**Caller context:** `ui/commentdialog.cpp:205–211` — `onUnlkReasonSelected()` calls `getReason()` and guards against the empty-string case. The `UnlockReasonDialog` is instantiated and managed by `CommentDialog`.

---

### VORConfirmationDialog

**Class:** `VORConfirmationDialog` extends `QDialog`

**Includes (cpp):**
- `vorconfirmationdialog.h` (line 1)
- `ui_vorconfirmationdialog.h` (line 2)
- `../mytranslator.h` (line 3)
- `<QTimer>` (line 4)

**Includes (h):**
- `<QDialog>` (line 4)

**Public methods:**
- `explicit VORConfirmationDialog(QWidget *parent = 0)` — h:15, cpp:6
- `~VORConfirmationDialog()` — h:16, cpp:30
- `void isBeingTurnOn(bool on)` — h:18, cpp:35

**Protected methods:**
- `void hideEvent(QHideEvent *)` — h:25, cpp:25
- `void showEvent(QShowEvent *event = 0)` — h:26, cpp:19

**Private members:**
- `Ui::VORConfirmationDialog *ui` — h:21
- `QTimer *m_timer` — h:22

**Signal/slot wiring (cpp:13–15):**
- `btnCancel::clicked` -> `reject`
- `btnTurnOn::clicked` -> `accept`
- `m_timer::timeout` -> `reject`

**Key logic:**
- Timer is single-shot (cpp:16), starts at 10 000 ms on `showEvent` (cpp:22), stopped on `hideEvent` (cpp:27).
- `isBeingTurnOn(bool on)` sets UI label text differently for turn-on vs. turn-off. Note: the `on == false` branch (VOR being turned ON) and the `on == true` branch (VOR being turned OFF) both set the same `lblCornfirm` text when language is English (`langEnglish`) — both show `"Please confirm that you want to turn VOR mode"` (missing "on"/"off") due to the logic inversion at cpp:40 vs. cpp:49.

**Caller context:** `ui/supervisordialog.cpp:16,26–28` — `VORConfirmationDialog` is embedded in `SupervisorDialog`; `accepted` -> `onActivateVOR`, `rejected` -> `showEvent()` (return to supervisor screen), `finished` -> `reset`.

---

### VORWarningDialog

**Class:** `VORWarningDialog` extends `QDialog`

**Includes (cpp):**
- `vorwarningdialog.h` (line 1)
- `ui_vorwarningdialog.h` (line 2)
- `<QTimer>` (line 3)

**Includes (h):**
- `<QDialog>` (line 4)

**Public methods:**
- `explicit VORWarningDialog(QWidget *parent = 0)` — h:15, cpp:5
- `~VORWarningDialog()` — h:16, cpp:66

**Protected methods:**
- `void hideEvent(QHideEvent *)` — h:23, cpp:61
- `void showEvent(QShowEvent *event = 0)` — h:24, cpp:17

**Private members:**
- `Ui::VORWarningDialog *ui` — h:19
- `QTimer *m_timer` — h:20

**Signal/slot wiring (cpp:12–13):**
- `btnACK::clicked` -> `accept`
- `m_timer::timeout` -> `reject`

**Key logic:**
- Timer is single-shot (cpp:14), started at 30 000 ms on `showEvent` (cpp:57), stopped on `hideEvent` (cpp:63).
- `showEvent` (cpp:17–58): builds full HTML body with three translated strings and sets them into `textEdit`.
- No Cancel button — user can only acknowledge (accept) or let the timer expire (reject). There is no explicit way to cancel without waiting.

**Caller context:** `ui/dialog.cpp:75,183` — instantiated in `Dialog`, with `accepted` signal connected to `openMenuDialog`.

---

## Test Coverage Analysis

### Primary test file examined

- `test/test_dialog.h` — declares `TestDialog` with slots: `test_enums`, `test_globalConfigs`, `test_idleLockout`, `test_showPreopSummary`, `test_unlockMode1`, `test_showTime`.
- `test/test_dialog.cpp` — full implementation read.

### Grep results — all test files

Grep for `UnlockReasonDialog`, `VORConfirmationDialog`, `VORWarningDialog` across all files under `test/`: **zero matches**.

Grep for method names `getReason`, `setReason`, `languageChanged`, `isBeingTurnOn`, `showEvent`, `hideEvent` across `test/`: only three hits, all for `m_checkCompletedDialog->showEvent(nullptr)` in `test_showPreopSummary` — unrelated to the three audited classes.

**Conclusion: none of the three dialog classes has any test coverage whatsoever.**

---

## Findings

---

**A25-1** · HIGH · Missing Test Coverage
**File:** `ui/unlockreasondialog.cpp:39–43`
**Description:** `UnlockReasonDialog` has zero test coverage. The core interaction — a user clicking a reason button triggering `setReason()`, which casts `sender()` to `QPushButton*` and calls `emit accept()` — is completely untested. The 14 distinct reason buttons across three categories (10 Red Impact, 2 Checklist Timeout, 2 Checklist Lockout) are never exercised. No test verifies that `getReason()` returns the expected button text after each click, nor that the `accept()` signal is actually emitted.
**Fix:** Add a `TestUnlockReasonDialog` test class. Instantiate the dialog; for each of the 14 buttons, simulate a click (or call `setReason()` via a `QTest::mouseClick` / direct `clicked()` emission), then assert `getReason()` equals the expected localised string and that `QSignalSpy` on `accepted()` fires exactly once per click.

---

**A25-2** · HIGH · Missing Test Coverage — Empty/No-Selection Path
**File:** `ui/unlockreasondialog.cpp:45–48`, `ui/commentdialog.cpp:205–211`
**Description:** When the user presses the BACK button (`btnDone`), the dialog calls `reject()` without setting `m_reason`, leaving `m_reason` as the empty string `""`. The caller (`CommentDialog::onUnlkReasonSelected`) guards against this, but no test verifies that: (a) `getReason()` returns `""` when rejected, (b) the guard in `onUnlkReasonSelected` correctly suppresses text insertion, or (c) the `rejected()` signal fires when BACK is pressed.
**Fix:** Add a test case that calls `reject()` on the dialog (or simulates a `btnDone` click) and asserts `getReason() == ""`. Add a companion test for `CommentDialog::onUnlkReasonSelected` to confirm no text is inserted into `pteMessageBox` on empty reason.

---

**A25-3** · HIGH · Missing Test Coverage
**File:** `ui/vorconfirmationdialog.cpp`
**Description:** `VORConfirmationDialog` has zero test coverage. No test exercises: (a) the confirm (TURN ON / TURN OFF) accept path; (b) the cancel path (`btnCancel` emitting `rejected`); (c) the auto-timeout path (10-second timer expiring and calling `reject`); (d) `isBeingTurnOn(true)` vs. `isBeingTurnOn(false)` label states; or (e) the interaction between `showEvent` starting the timer and `hideEvent` stopping it. The VOR mode is a safety-critical feature that locks out drivers, making untested confirmation flow a significant risk.
**Fix:** Add a `TestVORConfirmationDialog` class. Use `QSignalSpy` on `accepted()` and `rejected()`. Test: (1) calling `isBeingTurnOn(false)` then clicking TURN ON — spy on `accepted`; (2) clicking CANCEL — spy on `rejected`; (3) calling `showEvent`, advancing timer via `QTest::qWait(10100)`, asserting `rejected` fires. Check label text for both `isBeingTurnOn` states.

---

**A25-4** · HIGH · Missing Test Coverage
**File:** `ui/vorwarningdialog.cpp`
**Description:** `VORWarningDialog` has zero test coverage. No test exercises: (a) the acknowledge path (`btnACK` accepted signal); (b) the 30-second auto-timeout path (timer expiry calling `reject`); (c) the HTML content construction in `showEvent` (three translated strings assembled with inline HTML templates — a bug in string escaping or template concatenation would be silent); or (d) the timer start/stop lifecycle across `showEvent`/`hideEvent`. This dialog is displayed to a driver when VOR mode is active, serving as a mandatory safety warning.
**Fix:** Add a `TestVORWarningDialog` class. Instantiate the dialog, call `showEvent(nullptr)`, use `QSignalSpy` to verify the timer eventually fires `rejected()` after ~30 s (or short-circuit with `m_timer->setInterval(50)` before `showEvent`). Separately test that clicking `btnACK` emits `accepted()`. Inspect `ui->textEdit->toHtml()` to confirm all three warning paragraphs are present.

---

**A25-5** · MEDIUM · Missing Test Coverage — `languageChanged` Not Tested
**File:** `ui/unlockreasondialog.cpp:50–71`
**Description:** `UnlockReasonDialog::languageChanged()` retranslates 15 UI elements (header label, BACK button, group box titles, and all 14 reason buttons). No test verifies that after calling `languageChanged()`, the button texts match the expected translated strings, or that `setReason()` returns the post-translation text (since it reads from `sender()->text()` at call time, this is a live dependency).
**Fix:** In the `TestUnlockReasonDialog` class, call `languageChanged()` on a freshly constructed dialog and assert each button's `text()` matches the expected English string. After simulating a button click, assert `getReason()` equals the (potentially translated) button text.

---

**A25-6** · MEDIUM · Logic Inversion Bug in `isBeingTurnOn` — Not Caught by Tests
**File:** `ui/vorconfirmationdialog.cpp:35–57`
**Description:** The parameter `on` is documented (by the method name `isBeingTurnOn`) to represent whether VOR is currently on. However, the branch `if (!on)` (cpp:39) sets the label "turn on VOR mode" and "TURN ON", while `else` (cpp:48) sets "turn off VOR mode". This means `on = false` displays "TURN ON" and `on = true` displays "TURN OFF" — which is inverted relative to the method name's implication. Furthermore, in the English-language branch, both `if (!on)` and `else` set the same truncated `lblCornfirm` text: `"Please confirm that you want to turn VOR mode"` (missing "on" or "off") — making it impossible to distinguish turn-on from turn-off intent on an English device. Because no tests exist for this method, this logical defect has gone undetected.
**Fix:** Write tests for both `isBeingTurnOn(true)` and `isBeingTurnOn(false)` that assert: (1) `btnTurnOn->text()` is "TURN OFF" when `on=true` and "TURN ON" when `on=false`; (2) `lblCornfirm->text()` contains "off" when `on=true` and "on" when `on=false` in the non-English path; (3) review whether the English label logic is intentional (i.e., deliberate omission of "on"/"off" per spec) or is a copy-paste bug.

---

**A25-7** · LOW · No Integration Test for VOR Flow in `test_dialog.cpp`
**File:** `test/test_dialog.cpp`
**Description:** `test_dialog.cpp` tests `SupervisorDialog` interactions indirectly (e.g., `m_supervisorDialog->onUnlkVehicle()` in `test_unlockMode1`), but never exercises the VOR path through `SupervisorDialog` that triggers `VORConfirmationDialog::accepted` -> `onActivateVOR`. The end-to-end VOR activation sequence (supervisor presses VOR toggle, confirmation dialog appears, supervisor confirms, VOR mode is set) has no integration-level coverage.
**Fix:** Extend `test_dialog.cpp` with a `test_vorActivation` test. Use `QSignalSpy`, trigger the VOR button in `SupervisorDialog`, then call `m_vorConfirmationDialog->accept()` and assert the correct GMTP message is posted and VOR state is set in `gCfg`.

---

## Summary Table

| ID | Severity | Category | File | Summary |
|---|---|---|---|---|
| A25-1 | HIGH | Missing Test Coverage | `ui/unlockreasondialog.cpp:39–43` | No tests for any of 14 reason buttons or `setReason`/`getReason` |
| A25-2 | HIGH | Missing Test Coverage | `ui/unlockreasondialog.cpp:45–48` | No test for empty-reason / BACK-button (reject) path |
| A25-3 | HIGH | Missing Test Coverage | `ui/vorconfirmationdialog.cpp` | Zero coverage: confirm, cancel, timeout, and label state paths |
| A25-4 | HIGH | Missing Test Coverage | `ui/vorwarningdialog.cpp` | Zero coverage: acknowledge, timeout, and HTML construction |
| A25-5 | MEDIUM | Missing Test Coverage | `ui/unlockreasondialog.cpp:50–71` | `languageChanged()` retranslation never verified |
| A25-6 | MEDIUM | Logic Bug (undetected by tests) | `ui/vorconfirmationdialog.cpp:35–57` | Parameter inversion in `isBeingTurnOn`; English label missing "on"/"off" |
| A25-7 | LOW | Missing Integration Test | `test/test_dialog.cpp` | No end-to-end test for VOR activation flow through supervisor dialog |

**Total findings: 7** (4 HIGH, 2 MEDIUM, 1 LOW)

---

## Coverage Summary by Class

| Class | Any Tests? | Constructor tested? | Core logic tested? | Timer behaviour tested? | All paths tested? |
|---|---|---|---|---|---|
| `UnlockReasonDialog` | NO | NO | NO | N/A | NO |
| `VORConfirmationDialog` | NO | NO | NO | NO | NO |
| `VORWarningDialog` | NO | NO | NO | NO | NO |
