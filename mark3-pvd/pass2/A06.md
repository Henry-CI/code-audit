# Audit Report – A06 · Pass 2 · Test Coverage
**Agent:** A06
**Audit run:** 2026-02-28-01
**Pass:** 2 – Test Coverage
**Branch confirmed:** master (verified via `git branch --show-current`)

---

## Files Audited

| # | File |
|---|------|
| 1 | `comm/bleexpansion.cpp` |
| 2 | `comm/bleexpansion.h` |
| 3 | `comm/bleexpansionuuid.cpp` |
| 4 | `comm/bleexpansionuuid.h` |

---

## Reading Evidence

### bleexpansion.h — Class: `BleExpansion : QObject`

**Includes:**
- `app/cigconfigs.h` (line 4)
- `<QObject>` (line 5)
- `<QDateTime>` (line 6)
- `<QBluetoothAddress>` (line 7)
- `<QBluetoothUuid>` (line 8)
- `<QQueue>` (line 9)
- `<QTimer>` (line 10)

**Public methods:**

| Line | Signature |
|------|-----------|
| 32 | `explicit BleExpansion(EM070::BleCentral *bleCentral)` |
| 34 | `void setEnabled(bool enable)` |
| 36 | `const QByteArray &deviceName() const` (inline) |
| 37 | `const QByteArray &bleVersion() const` (inline) |
| 38 | `const QByteArray &mainVersion() const` (inline) |
| 39 | `const QByteArray &manufacture() const` (inline) |
| 40 | `const QByteArray &modelNumber() const` (inline) |
| 42 | `bool digitalInput(CIGCONF::BleExpansionDI di) const` (inline) |
| 44 | `bool relayOutput(CIGCONF::BleExpansionRelay relay) const` (inline) |
| 47 | `void setRelayOutput(CIGCONF::BleExpansionRelay relay, bool state)` |
| 49 | `void setShockThreshold(quint32 threshold)` |
| 50 | `void setShockPeriod(quint32 period)` |
| 52 | `bool isShockQueueEmpty()` (inline) |
| 53 | `ShockEvent shockEvent()` (inline) |
| 55 | `void setCurrentTime(const QDateTime &time)` |
| 57 | `bool generateShockMessage(bool force)` |

**Signals:**

| Line | Signal |
|------|--------|
| 60 | `void accessible(bool yes)` |
| 61 | `void inputStateChanged(CIGCONF::BleExpansionDI input, bool state)` |
| 62 | `void shockOccurred()` |
| 63 | `void amberImpactOccurred()` |
| 64 | `void redImpactOccurred()` |

**Protected slots/events:**

| Line | Signature |
|------|-----------|
| 67 | `void timerEvent(QTimerEvent *)` |

**Private slots/methods:**

| Line | Signature |
|------|-----------|
| 103 | `void setAccessible(bool yes)` |
| 104 | `void readDeviceInfo()` |
| 105 | `void resetInputTimer()` |
| 106 | `void resetOutput()` |
| 107 | `void initRelays()` |
| 108 | `void clearShockEvent()` |
| 109 | `void popShockEvent(const QByteArray &ba)` |
| 110 | `void allowShockCountNotify(bool yes)` |
| 111 | `void characteristicRead(const quint128 &uuid, const QByteArray &ba)` |
| 112 | `void characteristicWritten(const quint128 &uuid, const QByteArray &ba)` |
| 113 | `void descriptorRead(const quint128 &uuid, const QByteArray &ba)` |
| 114 | `void descriptorWritten(const quint128 &uuid, const QByteArray &ba)` |

---

### bleexpansionuuid.h — Class: `BleExpansionUuid`

**Includes:**
- `<QBluetoothUuid>` (line 4)

**Public methods:**

| Line | Signature |
|------|-----------|
| 9 | `static inline bool equals128(const quint128 *v1, const quint128 *v2)` |

**Private static members (all `quint128`):**
`authUuid`, `deviceName`, `appearance`, `bleVersion`, `mainVersion`, `manufactureName`, `modelNumber`, `currentRtc`, `inputTimerReset`, `inputD0`–`inputD3`, `inputPullUp0`–`inputPullUp3`, `outputReset`, `outputRelay0`–`outputRelay1`, `relay0Timeout`–`relay1Timeout`, `outputD0`–`outputD3`, `openCollector0`–`openCollector3`, `shockCount`, `shockPeek`, `shockPop`, `shockThreshold`, `shockPeriod`, `shockMaxMagnitude`, `shockCountNotifyDesc` (lines 20–56)

**Friend class:** `BleExpansion` (line 58)

---

### bleexpansionuuid.cpp

Defines all 28+ `quint128` static members via `QBluetoothUuid(QStringLiteral(...)).toUInt128()`. No procedural logic — purely constant initialisation.

---

### bleexpansion.cpp — Key implementation notes

**Constructor** (line 17): Connects five signals from `BleCentral` to internal slots. Calls `m_bleCentral->setPeripheralAddress()` and `m_bleCentral->setAuthorizationCode()` with a hard-coded auth string `"uS8MgpklMx"` (line 9, `#define AUTH_CODE`).

**`timerEvent`** (line 43): Fires every 1000 ms when accessible. Reads six characteristics per tick; calls `generateShockMessage(false)`.

**`setAccessible`** (line 81): On `true`, calls `readDeviceInfo()`, `setCurrentTime()`, `setShockThreshold()`, `setShockPeriod()`, `clearShockEvent()`, `initRelays()`, reads all four digital inputs, starts the 1 s poll timer, emits `accessible(true)`.

**`characteristicRead`** (line 308): Dispatches on UUID to handle `shockCount`, `shockPeek`, `inputD0`–`inputD3`, `outputRelay0`–`outputRelay1`, and six read-only device-info UUIDs. Minimum-size guards are applied inconsistently (see findings).

**`characteristicWritten`** (line 427): Clears the appropriate `m_pending` bit-field after each confirmed write.

**`popShockEvent`** (line 200): Deserialises an 8-byte shock record via `reinterpret_cast`. Emits `amberImpactOccurred` and/or `redImpactOccurred` based on magnitude thresholds.

**`generateShockMessage`** (line 237): Accumulates the peak shock event and enqueues it when the shock timer expires.

---

## Test Coverage Search Results

The test suite (`C:/Projects/cig-audit/repos/mark3-pvd/test/`) contains four files:

| File | Purpose |
|------|---------|
| `test_backgroundworker.cpp` | AT-command parsing, background worker logic |
| `test_canbus.cpp` | CAN bus configuration and VDI mode |
| `test_dialog.cpp` | UI dialog behaviour, config file I/O |
| `test_ota.cpp` | OTA firmware update flow |

**Grep results for `BleExpansion` / `BleExpansionUuid` and all method names:**

- `CIGCONF::BleExpansionDI` is registered as a Qt meta-type in all four test files (boilerplate `qRegisterMetaType` call only — not a functional test).
- Zero occurrences of: `BleExpansion`, `BleExpansionUuid`, `characteristicRead`, `characteristicWritten`, `descriptorWritten`, `descriptorRead`, `popShockEvent`, `generateShockMessage`, `setRelayOutput`, `setShockThreshold`, `setShockPeriod`, `setAccessible`, `initRelays`, `clearShockEvent`, `allowShockCountNotify`, `equals128`.

**Conclusion: `BleExpansion` and `BleExpansionUuid` have zero test coverage.**

---

## Findings

---

**A06-1** · CRITICAL · No Test Coverage – Entire Module
**File:** `comm/bleexpansion.cpp`, `comm/bleexpansionuuid.cpp`
**Description:** Neither `BleExpansion` nor `BleExpansionUuid` has any unit or integration test. The entire BLE expansion module — covering relay control, shock event ingestion, digital input state changes, RTC sync, characteristic read/write dispatch, descriptor handling, and the UUID equality utility — executes exclusively during hardware-on-device runs with no automated regression safety net. Defects in any of these paths can only be discovered through manual testing or field failures.
**Fix:** Create a `test_bleexpansion.cpp` test class. Use a mock or stub for `BleCentral` (injectable via the existing constructor parameter). Test each UUID dispatch branch in `characteristicRead` and `characteristicWritten` with both valid and under-length payloads.

---

**A06-2** · HIGH · No Test Coverage – `generateShockMessage` Logic
**File:** `comm/bleexpansion.cpp` lines 237–252
**Description:** `generateShockMessage` contains time-comparison logic including a special backward-time case (`ts < m_shockTimestamp`, line 247) to handle clock-sync rollback. This branch enqueues a shock event based on `gCfg->shockTimer()`. None of these branches — normal expiry, forced emission, time-rollback correction — are tested. A regression in shock-timer arithmetic would go undetected until field reports of missed or duplicated shock alerts.
**Fix:** Unit-test `generateShockMessage` with fabricated `m_shockEvent1` state and controlled `gCfg->shockTimer()` values covering: (a) timer not yet expired, (b) timer expired (normal), (c) `force=true`, (d) `ts < m_shockTimestamp` rollback.

---

**A06-3** · HIGH · No Test Coverage – `popShockEvent` Threshold and Signal Emission
**File:** `comm/bleexpansion.cpp` lines 200–235
**Description:** `popShockEvent` emits `amberImpactOccurred` and `redImpactOccurred` based on configured thresholds. The amber-alert condition (`shockRedImpact / 2 < magnitude < shockRedImpact`, lines 208–210) involves integer division with no rounding guarantee and no test verifying the boundary values. A magnitude exactly equal to `shockRedImpact / 2` or `shockRedImpact` is silently excluded, which may differ from documented intent. No `QSignalSpy` tests exist for any of the three signals.
**Fix:** Add signal-spy tests using `QSignalSpy` on `amberImpactOccurred`, `redImpactOccurred`, and `shockOccurred`. Cover: magnitude below threshold, magnitude in amber zone (boundary values), magnitude exactly at red threshold, magnitude above red threshold.

---

**A06-4** · HIGH · No Test Coverage – `characteristicRead` Minimum-Size Guards
**File:** `comm/bleexpansion.cpp` lines 308–424
**Description:** `inputD0`–`inputD3` branches each require `ba.size() >= 9` (lines 331, 341, 352, 363) but the payload described in the UUID comment is nine bytes (`"\x00\x00\x00\x00\x00\x04\x00\x00\x00"`). The `shockCount` branch requires `ba.size() >= 2` (line 315). The `shockMaxMagnitude` branch requires `ba.size() >= 4` (line 421). The `outputRelay0`/`outputRelay1` branches only check `!ba.isEmpty()` (lines 375, 383). There are no tests for under-length payloads on any branch, so a malformed BLE notification with a short payload could silently discard valid data or trigger a misparse.
**Fix:** Test each `characteristicRead` UUID branch with: (a) a valid-length payload, (b) a payload one byte shorter than the minimum guard, (c) an empty payload. Confirm that short payloads are silently skipped and no state mutation occurs.

---

**A06-5** · HIGH · No Test Coverage – `characteristicWritten` Pending-Bit Clearing
**File:** `comm/bleexpansion.cpp` lines 427–506
**Description:** `characteristicWritten` manages the `m_pending` bit-field which is the sole mechanism for detecting stalled writes (checked in `timerEvent`, line 50–54). The bit-mask operations for `outputRelay` (lines 441, 448) use `&= 0x2` and `&= 0x1` respectively — but these constants are bitmasks, not the complement that would be expected for clearing a single bit (e.g., `&= ~0x1`). For a 2-bit field, `&= 0x2` correctly clears bit 0, and `&= 0x1` correctly clears bit 1 in practice, but this is non-obvious and fragile if the field width changes. No test verifies that a confirmed relay write actually clears the pending bit and that a mismatched-value confirmation leaves the bit set.
**Fix:** Test `characteristicWritten` for `outputRelay0` and `outputRelay1` with: (a) a payload matching the expected relay state (bit should clear), (b) a mismatched payload (bit should remain set), (c) an empty payload (bit should remain set).

---

**A06-6** · MEDIUM · No Test Coverage – `equals128` UUID Comparison Utility
**File:** `comm/bleexpansionuuid.h` lines 9–17
**Description:** `equals128` is the sole UUID-matching function used throughout the dispatch logic in `characteristicRead`, `characteristicWritten`, `descriptorRead`, and `descriptorWritten`. It performs a four-word `quint32` comparison via pointer reinterpretation. No test verifies correct equality detection, inequality detection, or that pointer aliasing is handled safely (i.e., that the function returns `true` when both pointers reference the same object).
**Fix:** Add unit tests for `equals128`: (a) equal UUIDs, (b) UUIDs differing in each of the four 32-bit words, (c) a pointer compared against itself.

---

**A06-7** · MEDIUM · No Test Coverage – `setCurrentTime` RTC Struct Packing
**File:** `comm/bleexpansion.cpp` lines 154–173
**Description:** `setCurrentTime` serialises a `QDateTime` into the `RtcTime` union using a `__attribute__((packed))` struct (`bleexpansion.h` line 82). The `char data[10]` array is written directly to the BLE characteristic. No test verifies that the byte-level serialisation matches the expected 10-byte GATT Current Time format (year as `quint16` LE, then month, day, hour, minute, second, dayOfWeek, reserved `quint16`). A platform alignment difference or a struct layout change would silently corrupt the device clock.
**Fix:** Test `setCurrentTime` by capturing the `QByteArray` passed to `writeCharacteristic` (via a mock `BleCentral`) and asserting each byte against expected values for a known `QDateTime` input.

---

**A06-8** · MEDIUM · No Test Coverage – `setAccessible(false)` / BLE Disconnection Path
**File:** `comm/bleexpansion.cpp` lines 81–112
**Description:** `setAccessible` handles the `yes=false` case by only emitting `accessible(false)` (line 111). It does not stop the poll timer (`m_timerId`), meaning `timerEvent` continues to fire and attempt reads on a disconnected peripheral. No test exercises the disconnection path or verifies that the timer is (or is not) stopped, or that `m_readingShocks` and `m_popTimer` are properly cleaned up on reconnect versus disconnect.
**Fix:** Test `setAccessible(false)`: verify `accessible(false)` signal is emitted, and audit whether `timerEvent` firing while `m_accessible == false` causes any unintended side effects (the `generateShockMessage(false)` call on line 72 runs unconditionally regardless of accessibility state).

---

**A06-9** · MEDIUM · No Test Coverage – `initRelays` Hardcoded Timeout Constants
**File:** `comm/bleexpansion.cpp` lines 265–287
**Description:** `initRelays` always writes `RELAY1_TIMEOUT = 60` and `RELAY2_TIMEOUT = 60` (macros defined at lines 12–13). These values are not configurable at runtime and are not tested. No test verifies the byte ordering of the little-endian 16-bit timeout encoding (low byte first, high byte second, lines 268–269, 273–274), nor that `characteristicWritten` correctly clears the `relayTimeout` pending bits when the confirmed value matches.
**Fix:** Test `initRelays` by capturing the written `QByteArray` and asserting `ba[0] == 0x3C` and `ba[1] == 0x00` (60 in little-endian). Test the matching `characteristicWritten` handler with the correct and incorrect timeout values.

---

**A06-10** · LOW · No Test Coverage – `descriptorRead` / `descriptorWritten`
**File:** `comm/bleexpansion.cpp` lines 508–526
**Description:** Both `descriptorRead` and `descriptorWritten` update `m_shockCountNotifyEnabled` based on a two-byte CCCD value. Neither function is tested. In particular, `descriptorRead` is never called from `BleCentral` connections set up in the constructor (the constructor only connects `descriptorWritten`, not `descriptorRead`), making `descriptorRead` effectively dead code. This also means `m_shockCountNotifyEnabled` can never be set to `true` through the `descriptorRead` path in production.
**Fix:** Investigate whether `descriptorRead` is intentionally excluded from the `BleCentral` signal connections. If it is needed, connect it. Add tests for both `descriptorWritten` with `0x0100` payload (enable) and `0x0000` payload (disable), and for `descriptorRead` if it is re-connected.

---

**A06-11** · LOW · No Test Coverage – `allowShockCountNotify` Is Never Called
**File:** `comm/bleexpansion.cpp` lines 300–306
**Description:** `allowShockCountNotify` is declared private and defined but is never invoked anywhere in the codebase (confirmed by source inspection). The function writes a CCCD descriptor to enable or disable BLE notifications for `shockCount`. Because it is never called, BLE notification mode for shock count is never configured at runtime. This may be intentional (poll-only design) but is undocumented and untested.
**Fix:** Determine whether notification-driven shock count is a future feature or dead code. If dead code, remove the function. If intended, add a call site and a test verifying the descriptor write payload (`0x0100` for enable, `0x0000` for disable).

---

## Summary Table

| ID | Severity | Category | Tested? |
|----|----------|----------|---------|
| A06-1 | CRITICAL | No tests – entire module | No |
| A06-2 | HIGH | `generateShockMessage` logic uncovered | No |
| A06-3 | HIGH | `popShockEvent` signal emission uncovered | No |
| A06-4 | HIGH | `characteristicRead` short-payload edge cases | No |
| A06-5 | HIGH | `characteristicWritten` pending-bit logic | No |
| A06-6 | MEDIUM | `equals128` UUID utility | No |
| A06-7 | MEDIUM | `setCurrentTime` RTC struct packing | No |
| A06-8 | MEDIUM | `setAccessible(false)` disconnection path | No |
| A06-9 | MEDIUM | `initRelays` timeout byte encoding | No |
| A06-10 | LOW | `descriptorRead` / `descriptorWritten` | No |
| A06-11 | LOW | `allowShockCountNotify` dead code | No |

**Total findings: 11**
**Tested public/private methods: 0 of 16**
**Test files examined: 4** (`test_backgroundworker.cpp`, `test_canbus.cpp`, `test_dialog.cpp`, `test_ota.cpp`)
