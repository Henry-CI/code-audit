# Audit Report — Agent A24 — Pass 2: Test Coverage

**Agent:** A24
**Audit Run:** 2026-02-28-01
**Pass:** 2 — Test Coverage
**Branch confirmed:** master (verified via `git branch --show-current`)
**Date:** 2026-02-28

---

## Files Under Audit

| # | Source File | Header File |
|---|-------------|-------------|
| 1 | `ui/preopscreenoverlay.cpp` | `ui/preopscreenoverlay.h` |
| 2 | `ui/supervisordialog.cpp` | `ui/supervisordialog.h` |
| 3 | `ui/unlockeddialog.cpp` | `ui/unlockeddialog.h` |

**Primary test file read:** `test/test_dialog.cpp` + `test/test_dialog.h`
**Additional test files searched:** `test/test_backgroundworker.cpp`, `test/test_canbus.cpp`, `test/test_ota.cpp`

---

## Reading Evidence

### File Set 1 — PreopScreenOverlay

**Class:** `PreopScreenOverlay` extends `QDialog`

**Includes (preopscreenoverlay.cpp):**
- `"preopscreenoverlay.h"` (line 1)
- `"ui_preopscreenoverlay.h"` (line 2)

**Public methods:**

| Method | .h line | .cpp line | Notes |
|--------|---------|-----------|-------|
| `explicit PreopScreenOverlay(QWidget *parent = 0)` | 15 | 4 | Constructor; calls `ui->setupUi(this)` |
| `~PreopScreenOverlay()` | 16 | 16 | Deletes `ui` |
| `void onUpdatePreopTimer(QString time)` | 18 | 11 | Sets `lblPreopTimer` text to `tr("Time Remaining") + ": " + time` |

**Signals:** None declared.
**Slots:** None declared (no `Q_OBJECT` slots; `onUpdatePreopTimer` is a plain public method used as a slot target via `connect` in `dialog.cpp:142`).
**Private members:** `Ui::PreopScreenOverlay *ui` (line 21, .h)
**No `#ifdef UNIT_TEST` friend class declared.**

---

### File Set 2 — SupervisorDialog

**Class:** `SupervisorDialog` extends `QDialog`

**Includes (supervisordialog.cpp):**
- `"supervisordialog.h"` (line 1)
- `"ui_supervisordialog.h"` (line 2)
- `"app/globalconfigs.h"` (line 3)
- `"ui/vorconfirmationdialog.h"` (line 4)
- `"ui/warningdialog.h"` (line 5)

**Includes (supervisordialog.h):**
- `"app/cigconfigs.h"` (line 4)
- `<QDialog>` (line 5)
- `<QTimer>` (line 6)

**Public methods:**

| Method | .h line | .cpp line | Notes |
|--------|---------|-----------|-------|
| `explicit SupervisorDialog(QWidget *parent = nullptr)` | 20 | 10 | Constructor; wires all button connections and timers |
| `~SupervisorDialog()` | 21 | 47 | Deletes `ui` |
| `void setMasterOptions(CIGCONF::MasterId m)` | 23 | 172 | Sets button visibility by option bitmask |
| `void setTransportOptions()` | 24 | 202 | Hides VOR/Unlock/Maintenance; shows NormalDriver |

**Signals:**

| Signal | .h line | Notes |
|--------|---------|-------|
| `void startMasterSession()` | 31 | Emitted on unlock vehicle / normal driver confirm |
| `void startMaintenanceSession()` | 32 | Emitted on maintenance mode confirm |
| `void onVORUpdate()` | 33 | Emitted after VOR toggled |

**Protected slots:**

| Method | .h line | .cpp line | Notes |
|--------|---------|-----------|-------|
| `void showEvent(QShowEvent *event = 0)` | 49 | 52 | Refreshes UI text, starts 10 s inactivity timer |

**Private slots:**

| Method | .h line | .cpp line | Notes |
|--------|---------|-----------|-------|
| `void onUnlkVehicle()` | 52 | 88 | Two-tap confirm pattern; emits `startMasterSession` on confirm |
| `void onNormalDriverAccess()` | 53 | 106 | Two-tap confirm pattern; opens warning dialog, emits `startMasterSession` |
| `void onActivateVOR()` | 54 | 144 | Toggles VOR via `gCfg->setConvor`; emits `onVORUpdate` |
| `void openConfirmationDialog()` | 55 | 126 | Two-tap confirm pattern; opens VOR confirmation dialog |
| `void on_btnMaintenanceMode_clicked()` | 56 | 211 | Two-tap confirm pattern; opens maintenance warning dialog |

**Private methods:**

| Method | .h line | .cpp line | Notes |
|--------|---------|-----------|-------|
| `bool debounce()` | 37 | 155 | Returns false if < 200 ms since last press |
| `void reset()` | 38 | 166 | Resets `m_lastPress = 0`; calls `showEvent()` |

**Private members:** `Ui::SupervisorDialog *ui`, `QTimer *m_timer` (10 s inactivity), `QTimer *m_resetTimer` (2 s confirm reset), `quint32 m_lastPress`, `CIGCONF::MasterId m_master`, `VORConfirmationDialog *m_vorConfirmationDialog`, `WarningDialog *m_maintWarningDialog`, `WarningDialog *m_warningDialog`

**`#ifdef UNIT_TEST` friend class `TestDialog` declared at line 27, .h.**

**Defined constants:**
- `NO_ACTIVITY_TIME 10000` ms (line 7, .cpp)
- `RESET_TIME 2000` ms (line 8, .cpp)

---

### File Set 3 — UnlockedDialog

**Class:** `UnlockedDialog` extends `QDialog`

**Includes (unlockeddialog.cpp):**
- `"unlockeddialog.h"` (line 1)
- `"ui_unlockeddialog.h"` (line 2)
- `"app/globalconfigs.h"` (line 3)

**Includes (unlockeddialog.h):**
- `<QDialog>` (line 4)

**Public enum:**

| Enum value | .h line | Meaning |
|------------|---------|---------|
| `UnlockNoChecklist` | 15 | No checklist needed — hide labels, show "No questions" tip |
| `UnlockChecklist` | 15 | Checklist required — show unlock and warning labels |
| `UnlockOnly` | 15 | Unlock only — show unlock and warning labels, return-to-login tip |

**Public methods:**

| Method | .h line | .cpp line | Notes |
|--------|---------|-----------|-------|
| `explicit UnlockedDialog(QWidget *parent = 0)` | 17 | 5 | Constructor; sets OK icon; connects `btnOk` to `accept()` |
| `~UnlockedDialog()` | 18 | 18 | Deletes `ui` |
| `void setMode(Mode m)` | 20 | 23 | Switches label text/visibility by mode |
| `void languageChanged()` | 21 | 42 | Updates `label_3` text to `tr("OK")` |

**Signals:** None.
**Slots:** None explicitly declared; `accept()` is inherited from `QDialog`.
**Private members:** `Ui::UnlockedDialog *ui`
**`#ifdef UNIT_TEST` friend class `TestDialog` declared at line 23, .h.**

---

## Test Coverage Analysis

### Test Suite Inventory

`test/test_dialog.h` declares the following test slots:
- `test_enums()` — enum value checks
- `test_globalConfigs()` — config read/write/reset
- `test_idleLockout()` — idle lockout lock/unlock flow
- `test_showPreopSummary()` — checklist summary display
- `test_unlockMode1()` — unlock mode 0 and mode 1 flows (main test touching all three dialogs)
- `test_showTime()` — time display formats

No additional test files in `test/` contain references to `PreopScreenOverlay`, `SupervisorDialog`, or `UnlockedDialog`.

### SupervisorDialog — Coverage Matrix

| Method / Behaviour | Tested | Test Location |
|--------------------|--------|---------------|
| Constructor | Indirectly (via `m_dialog` setup) | `initTestCase` |
| `setMasterOptions()` | **No** | — |
| `setTransportOptions()` | **No** | — |
| `showEvent()` | **No** (never called directly) | — |
| `onUnlkVehicle()` — first tap (set "Confirm?") | **No** | — |
| `onUnlkVehicle()` — second tap (emit `startMasterSession`) | Partial (button text pre-set by test) | `test_unlockMode1` lines 477–478, 494–495 |
| `onNormalDriverAccess()` | **No** | — |
| `openConfirmationDialog()` / `onActivateVOR()` | **No** | — |
| `on_btnMaintenanceMode_clicked()` | **No** | — |
| `debounce()` | **No** | — |
| `reset()` | **No** | — |
| Inactivity timer auto-dismiss (10 s) | **No** | — |
| `startMasterSession` signal verified | **No** (signal not spy'd) | — |
| `startMaintenanceSession` signal verified | **No** | — |
| `onVORUpdate` signal verified | **No** | — |
| Two-tap confirm resets on timer | **No** | — |

### UnlockedDialog — Coverage Matrix

| Method / Behaviour | Tested | Test Location |
|--------------------|--------|---------------|
| `setMode(UnlockOnly)` | Indirectly (checked `isVisible()` + label text) | `test_unlockMode1` lines 497–498 |
| `setMode(UnlockChecklist)` | **No** | — |
| `setMode(UnlockNoChecklist)` | **No** | — |
| `languageChanged()` | **No** | — |
| `accept()` triggers correct downstream state | Partial (mode 0 and mode 1 post-accept states checked) | `test_unlockMode1` lines 481–484, 499–504 |
| `setMode(UnlockOnly)` label hide/show verified | **No** (only text checked, not visibility of labelLocked/labelWarning) | — |
| Dialog visibility after accept (locked back to login) | Checked indirectly | `test_unlockMode1` lines 501–502 |

### PreopScreenOverlay — Coverage Matrix

| Method / Behaviour | Tested | Test Location |
|--------------------|--------|---------------|
| Constructor | **No** | — |
| `onUpdatePreopTimer()` — valid time string | **No** | — |
| `onUpdatePreopTimer()` — empty string | **No** | — |
| `onUpdatePreopTimer()` — very long string | **No** | — |
| Dialog show / hide lifecycle | **No** | — |

---

## Findings

---

**A24-1** · HIGH · Missing Test Coverage — Security-Sensitive Flow
**File:** `ui/supervisordialog.cpp:88` / `test/test_dialog.cpp` (absent)
**Description:** The `onUnlkVehicle()` two-tap confirmation path is never tested starting from the first tap. The test suite pre-sets `ui->btnUnlkVehicle->setText("Confirm?")` before calling `onUnlkVehicle()`, bypassing the first-tap code path (lines 96–99 of `supervisordialog.cpp`). This means the normal user-facing flow — where the first tap changes the label to "Confirm?" and the confirm reset timer arms — is entirely untested. An error in this branch (e.g., the reset timer failing to arm, or the UI string comparison failing under a locale change) would go undetected.
**Fix:** Add a test case that calls `onUnlkVehicle()` twice in sequence without pre-setting the button text, verifying the intermediate "Confirm?" state after the first call and the `startMasterSession` signal emission after the second call.

---

**A24-2** · HIGH · Missing Test Coverage — Security-Sensitive Flow
**File:** `ui/supervisordialog.cpp:106` / `test/test_dialog.cpp` (absent)
**Description:** `onNormalDriverAccess()` is never exercised by any test. This slot both emits `startMasterSession` (granting normal driver access) and opens a `WarningDialog`. Neither the two-tap confirmation pattern, nor the signal emission, nor the warning dialog interaction, is verified. A regression in this code path could grant unauthorised access silently.
**Fix:** Add a dedicated test that simulates both taps of the Normal Driver Access button, uses `QSignalSpy` to confirm `startMasterSession` is emitted exactly once, and checks that the `m_warningDialog` is opened.

---

**A24-3** · HIGH · Missing Test Coverage — Security-Sensitive Flow
**File:** `ui/supervisordialog.cpp:211` / `test/test_dialog.cpp` (absent)
**Description:** `on_btnMaintenanceMode_clicked()` is completely untested. This slot triggers `startMaintenanceSession`, which is a privileged session type. The two-tap confirmation, the `m_maintWarningDialog` interaction, and the `startMaintenanceSession` signal are all untested. A defect here could allow unintended elevation to maintenance mode or prevent legitimate maintenance access.
**Fix:** Add a test case that triggers `on_btnMaintenanceMode_clicked()` twice, spies on `startMaintenanceSession`, and verifies the maintenance warning dialog is shown before the session starts.

---

**A24-4** · HIGH · Missing Test Coverage — Security-Sensitive Flow
**File:** `ui/supervisordialog.cpp:126` / `test/test_dialog.cpp` (absent)
**Description:** `openConfirmationDialog()` and `onActivateVOR()` are never tested. VOR (Vehicle Off Road) status is a safety-critical system flag. Neither the toggle logic (`gCfg->setConvor`) nor the `onVORUpdate` signal emission is verified. The `VORConfirmationDialog` interaction path (both accepted and rejected) is also untested.
**Fix:** Add tests that: (1) invoke `openConfirmationDialog()` twice to reach the VOR confirmation dialog; (2) simulate accept and reject on `m_vorConfirmationDialog`; (3) use `QSignalSpy` to confirm `onVORUpdate` is emitted only on accept; (4) verify the `convorStatus` toggled correctly via `gCfg`.

---

**A24-5** · MEDIUM · Missing Test Coverage — Inactivity Timer Dismiss
**File:** `ui/supervisordialog.cpp:38-41, 85` / `test/test_dialog.cpp` (absent)
**Description:** The 10-second inactivity timer that auto-dismisses the SupervisorDialog via `reject()` is never tested. If this timer fires incorrectly (e.g., during an active two-tap confirmation sequence), it would reset the dialog and potentially allow a partial-confirm state to persist undetected. No test verifies that the dialog is dismissed after inactivity.
**Fix:** Add a test that shows the `SupervisorDialog`, waits at least `NO_ACTIVITY_TIME` (10 000 ms) or directly calls `m_timer->timeout()`, and asserts `isVisible()` returns false.

---

**A24-6** · MEDIUM · Missing Test Coverage — Confirm Reset Timer
**File:** `ui/supervisordialog.cpp:102, 121, 141, 228` / `test/test_dialog.cpp` (absent)
**Description:** The 2-second reset timer (`m_resetTimer`) that cancels the "Confirm?" state (via `reset()`) is never tested. If this timer fires prematurely or fails to fire, a stale "Confirm?" label would allow a single tap to complete a privileged action, bypassing the intended two-tap confirmation guard.
**Fix:** Add a test that initiates the first tap (entering "Confirm?" state), waits at least `RESET_TIME` (2 000 ms) or directly triggers `m_resetTimer->timeout()`, and verifies the button text has reverted to its original value.

---

**A24-7** · MEDIUM · Missing Test Coverage — `debounce()` Not Tested
**File:** `ui/supervisordialog.cpp:155` / `test/test_dialog.cpp` (absent)
**Description:** The `debounce()` function, which rejects any button press within 200 ms of the last, is never directly exercised. All tests call `onUnlkVehicle()` once with a pre-set button label, so the debounce guard is passed only incidentally. There is no test that sends two rapid calls and confirms the second is rejected, nor one that confirms the function returns `true` after the 200 ms window.
**Fix:** Add a test that calls an action slot twice within < 200 ms and verifies the second call is a no-op (e.g., `startMasterSession` spy count remains 0); then call again after > 200 ms and verify the action proceeds.

---

**A24-8** · MEDIUM · Missing Test Coverage — `setMasterOptions()` Bitmask Permutations
**File:** `ui/supervisordialog.cpp:172` / `test/test_dialog.cpp` (absent)
**Description:** `setMasterOptions()` controls which action buttons are visible based on a `CIGCONF::MasterId.option` bitmask (`UnlockVehicle=1`, `NormalDriverAccess=2`, `ActivateVOR=4`, `MaintenanceMode=8`). No test exercises this method with any permutation of the bitmask. If a button is incorrectly made visible (or hidden) for a given master role, the error is invisible to the test suite.
**Fix:** Add tests covering at least: (a) `option = 0` (all buttons hidden); (b) each single-bit option (one button visible); (c) `DefaultMasterMenu=7` (UnlockVehicle + NormalDriverAccess + ActivateVOR visible, MaintenanceMode hidden); (d) `UnassignedMasterMenu=255` (all visible).

---

**A24-9** · MEDIUM · Missing Test Coverage — `setTransportOptions()`
**File:** `ui/supervisordialog.cpp:202` / `test/test_dialog.cpp` (absent)
**Description:** `setTransportOptions()` is never tested. This method hides VOR, UnlockVehicle, and MaintenanceMode buttons and shows only NormalDriverAccess. An error here could expose restricted controls to transport-mode operators.
**Fix:** Add a test that calls `setTransportOptions()` and asserts visibility: `btnActivateVOR` = hidden, `btnUnlkVehicle` = hidden, `btnMaintenanceMode` = hidden, `btnNormalDriver` = visible.

---

**A24-10** · MEDIUM · Missing Test Coverage — `UnlockedDialog::setMode()` All Modes
**File:** `ui/unlockeddialog.cpp:23` / `test/test_dialog.cpp` (absent)
**Description:** `setMode()` has three branches (`UnlockOnly`, `UnlockChecklist`, `UnlockNoChecklist`). Only `UnlockOnly` is exercised in `test_unlockMode1`, and even that test only checks label text — not the visibility of `labelLocked` and `labelWarning`. The `UnlockChecklist` and `UnlockNoChecklist` modes are completely untested. A regression in label visibility logic (e.g., `hide()` / `show()`) would not be caught.
**Fix:** Add three dedicated sub-cases within a test for `UnlockedDialog::setMode()`: verify text content and `isVisible()` state of `labelLocked`, `labelWarning`, and `labelTip` for each of the three modes.

---

**A24-11** · MEDIUM · Missing Test Coverage — `UnlockedDialog::languageChanged()`
**File:** `ui/unlockeddialog.cpp:42` / `test/test_dialog.cpp` (absent)
**Description:** `languageChanged()` is never called in any test. This method updates `label_3` with `tr("OK")`. If a Qt translation install causes the wrong widget to be updated (e.g., a refactor changes the UI object name from `label_3`), the bug would go undetected.
**Fix:** Call `languageChanged()` in a test and verify that `ui->label_3->text()` equals the expected "OK" string.

---

**A24-12** · LOW · Missing Test Coverage — `PreopScreenOverlay` Completely Untested
**File:** `ui/preopscreenoverlay.cpp:11` / `test/test_dialog.cpp` (absent)
**Description:** `PreopScreenOverlay` has zero test coverage. The class has no `#ifdef UNIT_TEST` friend declaration, and no test file anywhere in `test/` references `PreopScreenOverlay`, `m_overlay`, or `onUpdatePreopTimer`. The single substantive method — `onUpdatePreopTimer(QString time)` — concatenates the raw `time` parameter directly into a label without validation. There is no test for: normal time string display; empty string behaviour; or a pathologically long string that could break UI layout.
**Fix:** Add `#ifdef UNIT_TEST friend class TestDialog; #endif` to `preopscreenoverlay.h`, then add tests verifying: (1) `onUpdatePreopTimer("5:23")` results in label text `"Time Remaining: 5:23"`; (2) empty string `""` results in label `"Time Remaining: "`; (3) the overlay is visible when shown by `Dialog`.

---

**A24-13** · LOW · Missing Signal Emission Verification — `startMasterSession`
**File:** `ui/supervisordialog.cpp:94, 114` / `test/test_dialog.cpp:478, 495`
**Description:** Although `test_unlockMode1` calls `onUnlkVehicle()` and observes downstream effects (e.g., `m_unlockedDialog->isVisible()`), it never uses `QSignalSpy` to directly verify that `startMasterSession` is emitted. Downstream dialog state may change for reasons other than the signal (e.g., a direct method call), masking a missing signal emission.
**Fix:** Wrap each `onUnlkVehicle()` call in the test with a `QSignalSpy` on `startMasterSession` and assert `spy.count() == 1` after the action.

---

## Summary Table

| ID | Severity | Category | Affected Class | Method / Behaviour |
|----|----------|----------|----------------|--------------------|
| A24-1 | HIGH | Missing Coverage — Security | `SupervisorDialog` | `onUnlkVehicle()` first-tap path untested |
| A24-2 | HIGH | Missing Coverage — Security | `SupervisorDialog` | `onNormalDriverAccess()` entirely untested |
| A24-3 | HIGH | Missing Coverage — Security | `SupervisorDialog` | `on_btnMaintenanceMode_clicked()` entirely untested |
| A24-4 | HIGH | Missing Coverage — Security | `SupervisorDialog` | `openConfirmationDialog()` / `onActivateVOR()` untested |
| A24-5 | MEDIUM | Missing Coverage — Timer | `SupervisorDialog` | Inactivity auto-dismiss timer untested |
| A24-6 | MEDIUM | Missing Coverage — Timer | `SupervisorDialog` | Confirm reset timer untested |
| A24-7 | MEDIUM | Missing Coverage — Logic | `SupervisorDialog` | `debounce()` rapid-fire rejection untested |
| A24-8 | MEDIUM | Missing Coverage — Logic | `SupervisorDialog` | `setMasterOptions()` bitmask permutations untested |
| A24-9 | MEDIUM | Missing Coverage — Logic | `SupervisorDialog` | `setTransportOptions()` entirely untested |
| A24-10 | MEDIUM | Missing Coverage — Logic | `UnlockedDialog` | `setMode()` — only 1 of 3 modes partially tested |
| A24-11 | MEDIUM | Missing Coverage — Logic | `UnlockedDialog` | `languageChanged()` entirely untested |
| A24-12 | LOW | Missing Coverage — Display | `PreopScreenOverlay` | Entire class has zero test coverage |
| A24-13 | LOW | Missing Coverage — Signal | `SupervisorDialog` | `startMasterSession` signal never spy-verified |

**Totals: 4 HIGH, 6 MEDIUM, 3 LOW — 13 findings**

---

## Notes on Test Architecture

- `SupervisorDialog` and `UnlockedDialog` both declare `friend class TestDialog` under `#ifdef UNIT_TEST`, giving the test class access to private members and UI internals. This infrastructure is in place but is used only for `m_supervisorDialog->ui->btnUnlkVehicle` manipulation.
- `PreopScreenOverlay` has no `UNIT_TEST` friend declaration, making direct white-box testing of its `ui` members impossible without modifying the header.
- The test pattern of pre-setting `ui->btnUnlkVehicle->setText("Confirm?")` before calling `onUnlkVehicle()` bypasses the first confirmation tap. This is a structural test design weakness: the test exercises only the post-confirmation path, not the full two-tap user journey.
- No `QSignalSpy` usage is present for any of the three dialogs' emitted signals in any test file.
