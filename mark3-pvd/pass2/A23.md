# Audit Report — Agent A23 — Pass 2: Test Coverage

**Agent:** A23
**Audit run:** 2026-02-28-01
**Branch confirmed:** master (verified via `git branch --show-current`)
**Date:** 2026-02-28

---

## Files Reviewed

| File | Lines |
|------|-------|
| `ui/ondemanddialog.h` | 49 |
| `ui/ondemanddialog.cpp` | 139 |
| `ui/optionalcheckconfirmationdialog.h` | 28 |
| `ui/optionalcheckconfirmationdialog.cpp` | 49 |
| `ui/pindialog.h` | 35 |
| `ui/pindialog.cpp` | 126 |
| `test/test_dialog.h` | 34 |
| `test/test_dialog.cpp` | 683 |

---

## Reading Evidence

### OnDemandDialog (`ui/ondemanddialog.h` + `ui/ondemanddialog.cpp`)

**Class:** `OnDemandDialog` — inherits `QDialog`

**Includes:**
- header: `<QDialog>`, `<QMap>`, `<QString>`, `<QPushButton>`, `<QTimer>`, `app/cigconfigs.h`
- cpp: `ondemanddialog.h`, `ui_ondemanddialog.h`, `app/globalconfigs.h`, `<QPalette>`

**Public methods:**

| Method | Line (header) | Notes |
|--------|--------------|-------|
| `OnDemandDialog(QWidget *parent = 0)` | h:20 | Constructor |
| `~OnDemandDialog()` | h:21 | Destructor |
| `setSuperMasterId(quint64 id)` | h:23 | Inline setter |
| `reset()` | h:24 | Resets state and calls `showEvent()` |
| `setTimeRemaining(quint32 secs)` | h:25 | Updates UI label |
| `showCustomTimeFormat(quint32 time)` | h:26 | Formats HH:MM:SS string |

**Signals:**

| Signal | Line |
|--------|------|
| `onDemandStarted(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src)` | h:29 |
| `onDemandExtended(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src)` | h:30 |
| `onDemandEnded(quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src)` | h:31 |

**Protected methods (connected as slots):**

| Method | Line (cpp) | Notes |
|--------|-----------|-------|
| `showEvent(QShowEvent *event = 0)` | cpp:31 | Sets UI text, enables/disables buttons based on active session, starts inactivity timer |
| `onStart()` | cpp:57 | Two-tap confirm pattern; emits `onDemandStarted` |
| `onExtend()` | cpp:74 | Two-tap confirm pattern; emits `onDemandExtended` |
| `onEnd()` | cpp:91 | Two-tap confirm pattern; emits `onDemandEnded` |

**Private methods:**

| Method | Line (cpp) | Notes |
|--------|-----------|-------|
| `debounce()` | cpp:106 | Returns false if same button pressed within 200 ms |

**Constants:** `NO_ACTIVITY_TIME = 10000` (10-second inactivity timer causes dialog to reject/close)

---

### OptionalCheckConfirmationDialog (`ui/optionalcheckconfirmationdialog.h` + `ui/optionalcheckconfirmationdialog.cpp`)

**Class:** `OptionalCheckConfirmationDialog` — inherits `QDialog`

**Includes:**
- header: `<QDialog>`
- cpp: `optionalcheckconfirmationdialog.h`, `ui_optionalcheckconfirmationdialog.h`, `<QTimer>`, `<QDebug>`

**Public methods:**

| Method | Line (header) | Notes |
|--------|--------------|-------|
| `OptionalCheckConfirmationDialog(QWidget *parent = 0)` | h:15 | Constructor |
| `~OptionalCheckConfirmationDialog()` | h:16 | Destructor |
| `onRefreshLanguage(void)` | h:17 | Refreshes all UI label text via `tr()` |

**Protected methods:**

| Method | Line | Notes |
|--------|------|-------|
| `hideEvent(QHideEvent *)` | h:24 / cpp:31 | Stops the 5-second auto-close timer |
| `showEvent(QShowEvent *event = 0)` | h:25 / cpp:19 | Sets UI labels, starts 5-second single-shot timer |

**Constants:** 5000 ms auto-reject timer (cpp:28)

---

### PinDialog (`ui/pindialog.h` + `ui/pindialog.cpp`)

**Class:** `PinDialog` — inherits `QDialog`; **security-critical** (controls vehicle access)

**Includes:**
- header: `<QDialog>`, forward-decl `QTimer`
- cpp: `pindialog.h`, `ui_pindialog.h`, `app/globalconfigs.h`, `<QDebug>`, `<QTimer>`, `<QThread>`, `<QApplication>`

**Public methods:**

| Method | Line (header) | Notes |
|--------|--------------|-------|
| `PinDialog(QWidget *parent = 0)` | h:17 | Constructor; connects btn0-btn9, btnStar, btnClear, btnBack to `keyPressed()`; btnHash and btnEnter to `accept()`; btnCancel to `reject()`; timer to `reject()` |
| `~PinDialog()` | h:18 | Destructor |
| `pinCode() const` | h:20 / cpp:97 | Returns `quint32`; iterates chars, stops at first non-digit (handles trailing '#') |
| `clearPinCode()` | h:21 / cpp:112 | Clears `lineEdit` and `labelPin` |
| `languageChanged()` | h:22 / cpp:118 | Refreshes UI button labels via `tr()` |

**Protected methods:**

| Method | Line |
|--------|------|
| `showEvent(QShowEvent *)` | cpp:92 — starts 30-second activity timer |
| `hideEvent(QHideEvent *)` | cpp:87 — stops activity timer |

**Private methods:**

| Method | Line (cpp) | Notes |
|--------|-----------|-------|
| `keyPressed()` | cpp:47 | Static debounce (50 ms). Handles btnClear, btnBack, digit/star insertion. Auto-accepts when `maxLength` (5) reached. Star ('*') can be inserted as a character. |

**UI-level constraints:**
- `lineEdit` `maxLength` = 5 (set in `pindialog.ui`:503)
- `lineEdit` `echoMode` = `QLineEdit::PasswordEchoOnEdit` (ui:506)

**Constants:**
- `PIN_MAX_LENGTH = 5` (cpp:9) — defined but not used in code; actual limit comes from `ui->lineEdit->maxLength()` which is also 5
- `ACTIVITY_TIME = 30000` ms auto-reject (cpp:10)

**Authentication flow:**
- `onPinDialogAccepted()` in `dialog.cpp:319` calls `pinCode()`, converts to `quint64`, passes to `login()` via `WiegandRfid::wiegandData(0, code)` (dialog.cpp:322)
- No attempt-counter, no PIN-level lockout, no rate-limiting beyond the 50 ms debounce in `keyPressed()`
- `btnEnter` and `btnHash` are wired directly to `QDialog::accept()`, bypassing `keyPressed()` entirely — so they can submit with an empty PIN field

---

## Test Coverage Analysis

**Primary test file:** `test/test_dialog.cpp` + `test/test_dialog.h`

**Test cases declared in `test_dialog.h`:**
- `test_enums`
- `test_globalConfigs`
- `test_idleLockout`
- `test_showPreopSummary`
- `test_unlockMode1`
- `test_showTime`

**Grep for `OnDemandDialog`, `OptionalCheckConfirmationDialog`, `PinDialog` in `test/`:** **Zero matches found.**

**Grep for method names** (`pinCode`, `clearPinCode`, `languageChanged`, `keyPressed`, `onStart`, `onExtend`, `onEnd`, `debounce`, `setTimeRemaining`, `showCustomTimeFormat`, `onRefreshLanguage`) **in `test/`:** **Zero matches found.**

All other test files (`test_backgroundworker.cpp`, `test_canbus.cpp`, `test_ota.cpp`) also contain no references to any of the three dialog classes.

**Conclusion:** None of the three assigned classes have any automated test coverage whatsoever.

---

## Findings

---

**A23-1** · CRITICAL · Missing Test Coverage — Security-Critical Class Entirely Untested
**File:** `ui/pindialog.cpp:1` (entire class)
**Description:** `PinDialog` is the sole software mechanism by which a driver enters a PIN code to authenticate with the vehicle control system. A correct PIN causes `Dialog::login()` to be called with a Wiegand-encoded credential, granting access to vehicle relays. The entire class — including `pinCode()`, `clearPinCode()`, `keyPressed()`, the auto-accept-on-max-length behaviour at `cpp:81-84`, the 30-second activity timeout, and the full submission path — has zero test coverage. There is not a single reference to `PinDialog`, `pinCode`, `clearPinCode`, or `keyPressed` anywhere in the `test/` directory.
**Fix:** Add a dedicated `TestPinDialog` test suite in `test/test_dialog.cpp` or a new `test/test_pindialog.cpp` that instantiates `PinDialog` directly and exercises: (1) correct PIN accepted and `pinCode()` returns expected value; (2) incorrect/wrong PIN results in a downstream rejection; (3) PIN with non-digit characters (especially `*`) returns only the numeric prefix from `pinCode()`; (4) PIN exactly at max-length (5 digits) triggers auto-accept; (5) entering more than 5 characters is blocked by `maxLength`; (6) the 30-second inactivity timeout fires `reject()`; (7) `clearPinCode()` resets both `lineEdit` and `labelPin`; (8) `languageChanged()` updates label text.

---

**A23-2** · HIGH · Missing Test Coverage — No Wrong-PIN Rejection Test
**File:** `ui/dialog.cpp:319` (`onPinDialogAccepted`)
**Description:** There is no test verifying that entering a wrong PIN causes login to fail and access to be denied. `onPinDialogAccepted()` calls `login()` unconditionally with whatever `pinCode()` returns; it is the `login()` function's `isValidId()` check that rejects unknown IDs. No test exercises the path where a PIN is entered, `pinCode()` returns a value not in the configured driver/master lists, and the system correctly shows "Not Authorised" without granting vehicle access.
**Fix:** Add a test that configures a known valid PIN driver ID, has the PIN dialog accept with a different (wrong) PIN value, and then verifies the rejection message dialog is shown and the authorised screen is not visible.

---

**A23-3** · HIGH · Missing Test Coverage — No Brute-Force / Max-Attempts / Lockout Test
**File:** `ui/pindialog.cpp:47` (`keyPressed`) and `ui/dialog.cpp:319` (`onPinDialogAccepted`)
**Description:** There is no lockout mechanism for repeated wrong PIN attempts, and consequently no test for one. A physical attacker with access to the touchscreen can try all 100,000 possible 5-digit PINs (00000-99999) limited only by the 50 ms debounce, permitting approximately 20 attempts per second. At that rate exhaustive search takes under 90 minutes. No test verifies any rate-limiting, attempt-counting, or lockout policy after N consecutive wrong PINs.
**Fix:** Implement a failed-attempt counter in `Dialog::onPinDialogAccepted()` or in `PinDialog`; lock out further PIN attempts (e.g., clear and disable the dialog for a configurable duration) after a threshold such as 5 failures. Add tests that simulate reaching the threshold and verify the lockout is applied, and that it resets correctly after the timeout or supervisor intervention.

---

**A23-4** · HIGH · Missing Test Coverage — Star ('*') Character Insertable into PIN Field
**File:** `ui/pindialog.cpp:29` + `cpp:70-71`
**Description:** `btnStar` (UI text `"*"`) is connected to `keyPressed()`. Inside `keyPressed()`, only `btnClear` and `btnBack` are handled specially; all other buttons — including `btnStar` — call `ui->lineEdit->insert(btn->text())` without digit validation (cpp:71). `pinCode()` (cpp:101-103) stops parsing at the first non-digit, so a PIN of `"1*234"` (5 characters, maxLength satisfied) would auto-accept the dialog and yield `pinCode() == 1` — a value that may match a configured driver ID of `1`, bypassing the intended PIN. No test covers this non-digit-insertion path.
**Fix:** In `keyPressed()`, validate that the sender's button text is a single decimal digit before calling `insert()`; alternatively apply a `QIntValidator` on `lineEdit`. Add tests that simulate pressing `btnStar` followed by digits and verify the star is not inserted and `pinCode()` returns the correct value.

---

**A23-5** · HIGH · Missing Test Coverage — Empty PIN Submission via ENTER / HASH
**File:** `ui/pindialog.cpp:34-35`
**Description:** `btnEnter` and `btnHash` are connected directly to `QDialog::accept()`, not to `keyPressed()`. This means a user can press ENTER or `#` with an empty `lineEdit` (zero characters), which emits `accepted` and causes `onPinDialogAccepted()` to call `pinCode()`, which returns `0` for an empty field. If a driver with the Wiegand-encoded form of PIN `0` exists in configuration, the vehicle is unlocked with a zero-length PIN entry. No test validates that an empty-PIN submission is either prevented or correctly rejected downstream.
**Fix:** Either disable `btnEnter`/`btnHash` when the PIN field is empty (connect to a slot that checks `lineEdit->text().isEmpty()` before calling `accept()`), or validate in `onPinDialogAccepted()` that `pinCode() != 0` or that `lineEdit` is non-empty before calling `login()`. Add a test simulating ENTER with an empty PIN and verifying no authorised screen appears.

---

**A23-6** · MEDIUM · Missing Test Coverage — OnDemandDialog Entirely Untested
**File:** `ui/ondemanddialog.cpp:1` (entire class)
**Description:** `OnDemandDialog` controls On Demand mode — a high-privilege operation that starts, extends, or ends a 24-hour operational session that enables vehicle use. The two-tap confirm pattern in `onStart()`, `onExtend()`, `onEnd()` (cpp:62,79,96), the 10-second inactivity auto-close (cpp:54), `debounce()` (cpp:106-115), `setTimeRemaining()` (cpp:131-138), and `showCustomTimeFormat()` (cpp:123-129) all have zero test coverage. In particular the two-tap confirm guard is a security-relevant UI pattern preventing accidental session activation and is never tested.
**Fix:** Add tests covering: (1) single tap sets button to "Confirm?" but does not emit the signal; (2) two taps in succession emit the correct signal with correct timestamps; (3) the 10-second inactivity timer cancels a pending "Confirm?" state; (4) `debounce()` suppresses a double-tap within 200 ms; (5) `setTimeRemaining(0)` and `setTimeRemaining(N)` display correct label text; (6) `showCustomTimeFormat()` correctly formats boundary values (0, 3599, 3600, 86399).

---

**A23-7** · MEDIUM · Missing Test Coverage — OnDemandDialog Button State Logic Untested
**File:** `ui/ondemanddialog.cpp:44-52` (`showEvent`)
**Description:** `showEvent()` enables/disables Start, Extend, and End buttons based on whether `gCfg->onDemandStartTime()` is set and whether `gCfg->onDemandEndTime() > gCfg->localTimestamp()`. No test verifies that the correct button combination is enabled when a session is active versus when no session exists. A bug in this logic could allow operators to start duplicate sessions or prevent ending an active session.
**Fix:** In the `OnDemandDialog` test suite, configure global config to simulate an active session and verify `btnStart` is disabled while `btnExtend` and `btnEnd` are enabled; then do the inverse with no active session.

---

**A23-8** · MEDIUM · Missing Test Coverage — OptionalCheckConfirmationDialog Entirely Untested
**File:** `ui/optionalcheckconfirmationdialog.cpp:1` (entire class)
**Description:** `OptionalCheckConfirmationDialog` is presented to ask a driver whether they wish to perform an optional pre-operation safety check. It has a 5-second auto-reject timer (cpp:28) that silently skips the optional check if it fires. The `onRefreshLanguage()` method, the `showEvent` timer start, and the `hideEvent` timer stop are all untested. No test verifies that the 5-second timeout produces a `rejected()` signal, that YES produces `accepted()`, or that NO produces `rejected()`.
**Fix:** Add tests for: (1) YES button emits `accepted()`; (2) NO button emits `rejected()`; (3) 5-second timer expiry emits `rejected()`; (4) `onRefreshLanguage()` correctly updates label text; (5) hiding the dialog stops the timer so it does not fire after the dialog is already closed.

---

**A23-9** · LOW · Missing Test Coverage — `showCustomTimeFormat` Boundary and Overflow Values
**File:** `ui/ondemanddialog.cpp:123`
**Description:** `showCustomTimeFormat()` is public and performs integer arithmetic with a `quint32` input. The method is used in both `OnDemandDialog` (cpp:136) and `Dialog` (dialog.cpp:1052, 1212). For very large values (e.g., near `UINT32_MAX`), the hours division could produce a value exceeding the `qint32` signed range since `h` is declared `qint32` (cpp:124). No test exercises boundary values, zero, large values, or exactly 3600 seconds.
**Fix:** Add unit tests for `showCustomTimeFormat(0)` == `"00:00:00"`, `showCustomTimeFormat(59)` == `"00:00:59"`, `showCustomTimeFormat(3600)` == `"01:00:00"`, `showCustomTimeFormat(86399)` == `"23:59:59"`, and `showCustomTimeFormat(UINT32_MAX)` to verify correct output and absence of overflow or formatting errors. Consider changing `h`, `m`, `s` to `quint32` to avoid signed/unsigned mismatch.

---

## Summary Table

| ID | Severity | Category | File | Description |
|----|----------|----------|------|-------------|
| A23-1 | CRITICAL | Missing Coverage | `ui/pindialog.cpp:1` | Entire `PinDialog` class has zero tests |
| A23-2 | HIGH | Missing Coverage | `ui/dialog.cpp:319` | No test for wrong-PIN rejection |
| A23-3 | HIGH | Missing Coverage | `ui/pindialog.cpp:47` | No brute-force / max-attempts / lockout test |
| A23-4 | HIGH | Missing Coverage | `ui/pindialog.cpp:29,70` | Star ('*') insertable into PIN field; not tested |
| A23-5 | HIGH | Missing Coverage | `ui/pindialog.cpp:34` | Empty PIN submittable via ENTER/HASH; not tested |
| A23-6 | MEDIUM | Missing Coverage | `ui/ondemanddialog.cpp:1` | Entire `OnDemandDialog` class has zero tests |
| A23-7 | MEDIUM | Missing Coverage | `ui/ondemanddialog.cpp:44` | Button enable/disable state logic on `showEvent` untested |
| A23-8 | MEDIUM | Missing Coverage | `ui/optionalcheckconfirmationdialog.cpp:1` | Entire `OptionalCheckConfirmationDialog` has zero tests |
| A23-9 | LOW | Missing Coverage | `ui/ondemanddialog.cpp:123` | `showCustomTimeFormat()` not tested for boundary/overflow values |
