# Audit Report — Agent A20 · Pass 2 (Test Coverage)

**Audit run:** 2026-02-28-01
**Agent:** A20
**Branch confirmed:** master (verified: `git branch --show-current` returned `master`)

---

## Files Examined

| Source file | Lines | Role |
|---|---|---|
| `ui/checkstartdialog.h` | 28 | Header for pre-op check start prompt dialog |
| `ui/checkstartdialog.cpp` | 42 | Implementation of CheckStartDialog |
| `ui/commentdialog.h` | 56 | Header for unlock-reason / preop-comment text-entry dialog |
| `ui/commentdialog.cpp` | 218 | Implementation of CommentDialog |
| `ui/dialog.h` | 219 | Header for the central UI orchestrator class |
| `ui/dialog.cpp` | ~1326 | Implementation of Dialog |
| `test/test_dialog.h` | 34 | Test class declaration |
| `test/test_dialog.cpp` | 683 | Test implementations |

---

## Step 4 – Reading Evidence

### CheckStartDialog (`ui/checkstartdialog.h`, `ui/checkstartdialog.cpp`)

**Class:** `CheckStartDialog : public QDialog`

**Includes:** `<QDialog>`, `"ui_checkstartdialog.h"`, `<QDebug>`

**Public methods:**

| Line | Method |
|---|---|
| h:15 | `explicit CheckStartDialog(QWidget *parent = 0)` |
| h:16 | `~CheckStartDialog()` |
| h:17 | `void setMandatory(bool mandatory)` |
| h:18 | `void languageChanged(void)` |

**Signals:** none declared (inherits `QDialog::accepted`, `QDialog::rejected`, `QDialog::finished`)

**Key behaviour:**
- Constructor (cpp:15): sets up UI, sets icon, connects `btnStart::clicked` → `accept()`.
- `setMandatory(bool)` (cpp:23): toggles two UI labels to show "optional" or "mandatory".
- `languageChanged()` (cpp:34): re-translates five label strings.

**UNIT_TEST friend class:** `TestDialog` (h:21)

---

### CommentDialog (`ui/commentdialog.h`, `ui/commentdialog.cpp`)

**Class:** `CommentDialog : public QDialog`

**Includes:** `<QDialog>`, `<QTimer>`, `"ui/onScreenKeyboard.h"`, `"app/cigconfigs.h"`, `<QString>`, `<QListWidgetItem>`, `"ui/unlockreasondialog.h"`

**Preprocessor constants:**
- `NO_ACTIVITY_TIME 10000` (h:12)
- `MAX_CHARACTER 100` (h:13)

**Enum:** `CommentDialogType { Unlock, Preop }` (h:15)

**Public methods:**

| Line | Method |
|---|---|
| h:26 | `explicit CommentDialog(CommentDialogType type, QWidget *parent = nullptr)` |
| h:27 | `~CommentDialog()` |
| h:29 | `void UpdateTextInput(QString str, onScreenKeyboard::CtrlButton ctrl)` |
| h:30 | `void onkeyboardClosed()` |
| h:31 | `void onUnlkReasonSelected()` |
| h:32 | `void languageChanged()` |

**Protected overrides:** `showEvent(QShowEvent*)` (h:47), `hideEvent(QHideEvent*)` (h:48)

**Private slots:** `run_keyboard_lineEdit()` (h:51), `onDone()` (h:52), `onSkip()` (h:53)

**Private helpers:** `debounce()` (h:37), `reset()` (h:38), `showWidgets()` (h:39)

**Key signals used:** inherits `QDialog::accepted` (emitted from `onDone()` via `accept()`), `QDialog::rejected` (emitted from `onSkip()` via `reject()`).

**Key behaviour:**
- Dual-mode: `Unlock` vs `Preop`, controlled by `m_dlgType`.
- `onDone()` (cpp:134): double-tap confirm pattern; validates non-empty text; writes to `gCfg->setUnlkReasonString()` / `gCfg->setPreopCommentString()`; debounced.
- `onSkip()` (cpp:168): double-tap confirm; clears config strings; calls `reject()`.
- `debounce()` (cpp:188): rejects calls within 200 ms of previous press.
- `reset()` (cpp:199): fires on 10-second inactivity timer; re-runs `showWidgets()`.
- `UpdateTextInput()` (cpp:104): handles Backspace / Delete / character insert with MAX_CHARACTER cap.
- `onUnlkReasonSelected()` (cpp:205): populates text box from `UnlockReasonDialog`.

---

### Dialog (`ui/dialog.h`, `ui/dialog.cpp`)

**Class:** `Dialog : public QDialog`

**Includes (dialog.cpp):** `"dialog.h"`, `"ui_dialog.h"`, all child dialog headers, platform headers (`wiegandrfid.h`, `internalrfid.h`, `pwmbeeper.h`), `<QMouseEvent>`, `<QTimer>`, `<QTime>`, `<QDebug>`, `<QApplication>`, `<QPixmap>`, `"ui/keyfilter.h"`, `"ui/vorwarningdialog.h"`, `"mytranslator.h"`, `"ui/preopscreenoverlay.h"`, `"ui/amberimpactalertdialog.h"`

**Public methods (dialog.h):**

| Line | Method |
|---|---|
| h:44 | `explicit Dialog(QWidget *parent = 0)` |
| h:45 | `~Dialog()` |
| h:47 | `void onPowerChanged(CIGCONF::PowerState powerState)` |
| h:48 | `void onReboot()` |
| h:49 | `void onBleReady(bool yes)` |
| h:50 | `void onNetworkReady(bool yes)` |
| h:51 | `void onCardAuthorised(bool yes, quint64)` |
| h:52 | `void onCmdLogin(quint64 id)` |
| h:53 | `void onIdleTimeout()` |
| h:54 | `void lockScreen(CIGCONF::MaintLockedCode code, bool remote)` |
| h:55 | `void ambertImpactScreen()` |
| h:57 | `void updateLux(int lux)` |
| h:58 | `void updateStatus(...)` |
| h:59 | `void updateBatteryStatus(...)` |
| h:60 | `void updateExpModInfo(QByteArray mainVersion)` |
| h:61 | `void onBroadcastMsgReceived(CIGCONF::BroadcastMessage m)` |
| h:62 | `void showInformationScreen()` |
| h:63 | `void updateLoginImage()` |
| h:64 | `void quickPowerUpdate(bool on)` |
| h:66 | `void onDemandStarted(quint32, quint32, quint64, CIGCONF::OnDemandCmdSrc)` |
| h:67 | `void onDemandExtended(quint32, quint32, quint64, CIGCONF::OnDemandCmdSrc)` |
| h:68 | `void onDemandEnded(quint32, quint64, CIGCONF::OnDemandCmdSrc)` |
| h:70 | `void onLanguageChanged(void)` |
| h:72 | `void updateCamera()` |

**Signals (dialog.h):**

| Line | Signal |
|---|---|
| h:79 | `driverChanged(quint64 id)` |
| h:80 | `lastCheckDriverChanged(quint64 id)` |
| h:81 | `screenLocked(CIGCONF::MaintLockedCode code)` |
| h:82 | `setRelayOut(bool on1, bool on2)` |
| h:83 | `setRelay2Out(bool on)` |
| h:84 | `sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra)` |
| h:85 | `resetCanStates(bool resetLast)` |
| h:86 | `forceBroadcastUIClose()` |
| h:87 | `log(QByteArray &msg)` |
| h:88 | `updatePreopTimer(QString timeout)` |
| h:89 | `amberDialogAboutToShow(bool isLocked)` |

**Private methods (dialog.h, implemented in dialog.cpp):**

| Approx. line | Method |
|---|---|
| h:99 | `onPinCode()` |
| h:100 | `onCardSwiped(...)` |
| h:102 | `onPinDialogAccepted()` |
| h:103 | `onAuthorisedDialogAccepted()` |
| h:104 | `onAuthorisedUserLogout()` |
| h:105 | `onOptionalCheckConfirmed()` |
| h:106 | `onCheckStartDialogAccepted()` |
| h:107 | `onCheckQuestionDialogFinished(int)` |
| h:108 | `onCheckConfirmationDialogFinished(int)` |
| h:109 | `onCheckCompletedDialogAccepted()` |
| h:110 | `onCheckCompletedDialogRejected()` |
| h:111 | `onUnlockedDialogAccepted()` |
| h:112 | `onProcessUnlock()` |
| h:113 | `onPreopCommentDone()` |
| h:114 | `onBroadcastDialogDone(int)` |
| h:116 | `isValidId(quint64)` |
| h:117 | `isChecklistEmpty(bool)` |
| h:118 | `bypassChecklist()` |
| h:119 | `clearWidgets()` |
| h:121 | `login(quint64)` |
| h:122 | `postLogin()` |
| h:123 | `postMaintenanceLogin()` |
| h:124 | `logout()` |
| h:125 | `openMenuDialog()` |
| h:127 | `startCheck(bool restartTimer=true)` |
| h:128 | `sendStartCheck()` |
| h:130 | `superListUpdated(bool)` |
| h:131 | `updateOnDemand()` |
| h:133 | `convorStatusUpdated()` |
| h:135 | `isOnDemandExpired()` |
| h:137 | `fullLockStart()` |
| h:138 | `updateFullLock()` |
| h:140 | `updateTime()` |
| h:201 | `writeMsgToQueue(CIGCONF::BroadcastMessage)` |
| h:202 | `displayNextBroadcastMessage()` |
| h:203 | `clearMsgQueue()` |
| h:207 | `initOnScreenPreopTimer(quint16)` |
| h:208 | `showCustomTimeFormat(quint32)` |
| h:212 | `adjustPreopDialogs(bool)` |
| h:214 | `updateBLEConSpinner(quint8)` |

---

## Step 5 – Findings

### Coverage Summary for Dialog

**Test cases in `test_dialog.cpp`:** `test_enums`, `test_globalConfigs`, `test_idleLockout`, `test_showPreopSummary`, `test_unlockMode1`, `test_showTime` (6 tests).

#### Dialog public methods – coverage status

| Method | Covered | Notes |
|---|---|---|
| `Dialog()` constructor | YES | `initTestCase()` constructs Dialog |
| `onPowerChanged()` | NO | Never called in any test |
| `onReboot()` | NO | Never called in any test |
| `onBleReady()` | NO | Never called in any test |
| `onNetworkReady()` | NO | Never called in any test |
| `onCardAuthorised()` | NO | Never called in any test |
| `onCmdLogin()` | NO | Never called in any test |
| `onIdleTimeout()` | PARTIAL | Called in `test_idleLockout` – idle-lock and no-lock paths tested; MaintIdle GMTP payload verified |
| `lockScreen()` | PARTIAL | Called in `test_idleLockout` and `test_unlockMode1`; only `MaintRedImpact` and `MaintIdle` codes tested; `MaintNormal` remote-unlock path untested |
| `ambertImpactScreen()` | NO | Never called in any test |
| `updateLux()` | NO | Never called |
| `updateStatus()` | NO | Never called |
| `updateBatteryStatus()` | NO | Never called |
| `updateExpModInfo()` | NO | Never called |
| `onBroadcastMsgReceived()` | NO | Never called |
| `showInformationScreen()` | NO | Never called |
| `updateLoginImage()` | INDIRECT | Called internally by `showEvent()` on Dialog show |
| `quickPowerUpdate()` | NO | Never called |
| `onDemandStarted()` | NO | Never called |
| `onDemandExtended()` | NO | Never called |
| `onDemandEnded()` | NO | Never called |
| `onLanguageChanged()` | NO | Never called |
| `updateCamera()` | NO | Never called |

#### Dialog signals – coverage status

| Signal | Verified in tests |
|---|---|
| `driverChanged` | NO |
| `lastCheckDriverChanged` | NO |
| `screenLocked` | NO |
| `setRelayOut` | NO |
| `setRelay2Out` | NO |
| `sendGmtpMessage` | PARTIAL – spy verifies IDLE and MAINT GMTP payloads in `test_idleLockout` only |
| `resetCanStates` | NO |
| `forceBroadcastUIClose` | NO |
| `log` | NO |
| `updatePreopTimer` | NO |
| `amberDialogAboutToShow` | NO |

#### Untested major state transitions in Dialog

1. **Power-off / reboot flow** – `onPowerChanged(DimState)`, `onPowerChanged(SleepActiveState)`, `onReboot()`.
2. **Card/PIN authentication** – `onCardSwiped()`, `onPinDialogAccepted()`, `onCardAuthorised()`.
3. **Preop comment flow** – `m_preopCommentDlg` open/accept/reject cycle; `onPreopCommentDone()` is an empty stub.
4. **Broadcast message flow** – `onBroadcastMsgReceived()`, `displayNextBroadcastMessage()`, `onBroadcastDialogDone()`, queue management (`writeMsgToQueue`, `clearMsgQueue`).
5. **On-demand mode** – `onDemandStarted()`, `onDemandExtended()`, `onDemandEnded()`, `updateOnDemand()`, `isOnDemandExpired()`.
6. **BLE readiness** – `onBleReady()`, `updateBLEConSpinner()`.
7. **Check confirmation dialog** – `onCheckConfirmationDialogFinished()` is called indirectly via `onCheckQuestionDialogFinished()` in `test_showPreopSummary`, but the rejected path is not tested.
8. **Check completed dialog rejected** (restart checklist path) – `onCheckCompletedDialogRejected()`.
9. **Language change** – `onLanguageChanged()`.
10. **Supervisor / maintenance login path** – `postMaintenanceLogin()`.
11. **Preop timer / overlay** – `initOnScreenPreopTimer()`, `adjustPreopDialogs()`, timer countdown lambda.
12. **Convor (VOR) status** – `convorStatusUpdated()`, related `bypassChecklist()` branch.
13. **Full lockout** – `fullLockStart()`, `updateFullLock()` (declared in header but no implementation visible; suggests dead/stub code).

### CheckStartDialog coverage

- `CheckStartDialog` is **included** (`test_dialog.cpp:10`) and its `m_checkStartDialog` pointer is accessed at lines 508 and 511.
- `isVisible()` is asserted once (line 508) and `accept()` is called once (line 511) inside `test_unlockMode1` to simulate the user pressing Start.
- **`setMandatory()`** is called in production code (`dialog.cpp:645`) but is **never called or asserted in any test**. The `mandatory=false` path is entirely untested.
- **`languageChanged()`** is called in production code (`dialog.cpp:1278`) but is **never exercised in any test**.
- No test constructs a standalone `CheckStartDialog` or verifies its UI state changes.

### CommentDialog coverage

- `CommentDialog` header is **not included** in `test_dialog.cpp`.
- `m_unlockReasonDlg` and `m_preopCommentDlg` (both `CommentDialog*`) are referenced only through `Dialog`'s private members; neither is accessed directly by any test.
- No test opens, accepts, rejects, or inspects a `CommentDialog` instance.
- The signal connections for `CommentDialog::accepted` → `Dialog::onProcessUnlock()` and `CommentDialog::rejected` → `Dialog::onProcessUnlock()` are **completely untested**.
- The preop comment path (`m_preopCommentDlg` → `onCheckCompletedDialogAccepted()`) is **untested**.
- The `Unlock` vs `Preop` type distinction, double-tap confirm logic, debounce logic, inactivity timer, MAX_CHARACTER cap, and the `UnlockReasonDialog` dropdown integration are all **untested**.

---

## Findings

**A20-1** · HIGH · Missing Test Coverage
**File:** `ui/commentdialog.cpp:134` (`onDone()`), `ui/commentdialog.cpp:168` (`onSkip()`)
**Description:** `CommentDialog` has zero test coverage. Its header is not included in `test_dialog.cpp` and no test accesses either of its two `Dialog`-member instances (`m_unlockReasonDlg`, `m_preopCommentDlg`). The double-tap confirm pattern in both `onDone()` and `onSkip()` is a custom UI contract that is entirely unverified. Both `accept()` and `reject()` paths go untested, meaning the unlock-reason and preop-comment flows – which gate machine unlock – carry no automated regression protection.
**Fix:** Add test cases that construct a `CommentDialog` in `Unlock` and `Preop` modes, simulate first and second button presses for both Done and Skip, assert the correct `gCfg` side-effects (`setUnlkReasonString`, `setUnlkOption`, `setPreopCommentString`), and verify `accepted`/`rejected` signals fire appropriately.

---

**A20-2** · HIGH · Missing Test Coverage
**File:** `ui/commentdialog.cpp:188` (`debounce()`), `ui/commentdialog.cpp:199` (`reset()`)
**Description:** The debounce guard (200 ms minimum between presses) and the 10-second inactivity reset timer are untested. If the debounce threshold is regressed to zero or the timer interval changed, no test would catch it. The `reset()` path (which wipes partial input and re-runs `showWidgets()`) could silently discard a user's in-progress unlock reason.
**Fix:** Add timed tests using `QTest::qWait()` to verify that rapid double-calls to `onDone()` are rejected by debounce, and that after `NO_ACTIVITY_TIME` ms the dialog resets to its initial state.

---

**A20-3** · HIGH · Missing Test Coverage
**File:** `ui/commentdialog.cpp:104` (`UpdateTextInput()`), `ui/commentdialog.h:13` (`MAX_CHARACTER 100`)
**Description:** The `MAX_CHARACTER` cap (100 characters) that limits the unlock-reason text entry is untested. If this constant or the guard condition is accidentally removed or changed, no test will detect the regression. Backspace and Delete handling paths are similarly untested.
**Fix:** Add unit tests that fill the text box to exactly 100 characters, attempt to insert a 101st character, and verify the text length does not exceed the limit. Also test Backspace and Delete control paths.

---

**A20-4** · MEDIUM · Missing Test Coverage
**File:** `ui/checkstartdialog.cpp:23` (`setMandatory()`)
**Description:** `setMandatory(false)` is never exercised in any test. Only the `mandatory=true` branch is reachable in `test_unlockMode1` (via the indirect path through `Dialog::postLogin()` at `dialog.cpp:645`), and even that branch is not explicitly asserted on the label visibility. The optional-vs-mandatory label toggle is purely UI state that should be verified.
**Fix:** In a test that exercises the optional checklist path, assert `m_checkStartDialog->ui->labelTip12->isVisible()` is `true` and `ui->labelTip21->isVisible()` is `false` (and vice versa for mandatory). Alternatively, call `setMandatory()` directly on a standalone instance.

---

**A20-5** · MEDIUM · Missing Test Coverage
**File:** `ui/checkstartdialog.cpp:34` (`languageChanged()`), `ui/commentdialog.cpp:214` (`languageChanged()`), `ui/dialog.cpp:1260` (`onLanguageChanged()`)
**Description:** `onLanguageChanged()` in `Dialog` (which delegates to `m_checkStartDialog->languageChanged()` at line 1278 and `m_unlockReasonDlg->languageChanged()` at line 1281) is never called in any test. Language-change regressions – such as missing `tr()` calls or incorrect string assignments – cannot be caught.
**Fix:** Add a test that calls `m_dialog->onLanguageChanged()` and verifies that key labels on child dialogs are non-empty strings.

---

**A20-6** · MEDIUM · Missing Test Coverage
**File:** `ui/dialog.cpp:481` (`onProcessUnlock()`)
**Description:** `onProcessUnlock()` orchestrates the transition from locked → unlocked and decides whether to show the unlock-reason `CommentDialog`. The path where `gCfg->unlkScr()` is non-zero (i.e., `m_unlockReasonDlg->open()` is called) is never tested. The test `test_unlockMode1` uses `gCfg->setUnlkScr(CIGCONF::Disabled)` precisely to bypass this path. A regression here could allow unlock without a required reason being collected.
**Fix:** Add a test scenario with `gCfg->setUnlkScr()` set to a non-Disabled value, trigger a supervisor unlock, and verify that `m_unlockReasonDlg` becomes visible, that its acceptance causes `onProcessUnlock()` to proceed, and that the correct GMTP messages are emitted.

---

**A20-7** · MEDIUM · Missing Test Coverage
**File:** `ui/dialog.cpp:517` (`onBroadcastDialogDone()`), `ui/dialog.cpp:1155` (`onBroadcastMsgReceived()`), `ui/dialog.cpp:1177` (`displayNextBroadcastMessage()`), `ui/dialog.cpp:1169` (`writeMsgToQueue()`)
**Description:** The entire broadcast message flow – receiving a message, enqueueing it, displaying it, and recording the GMTP response – has zero test coverage. This flow includes priority queue ordering (urgent vs normal) and the no-driver edge case (`MsgResultNoDriver` response).
**Fix:** Add tests that call `onBroadcastMsgReceived()` with urgent and normal message types, verify queue ordering via `displayNextBroadcastMessage()`, simulate `BroadcastUIDialog::finished`, and assert the `sendGmtpMessage` signal carries the correct `GMTP_MSG_RSP` payload.

---

**A20-8** · MEDIUM · Missing Test Coverage
**File:** `ui/dialog.cpp:899` (`onPowerChanged()`), `ui/dialog.cpp:927` (`onReboot()`)
**Description:** Power-state transitions are never exercised. `DimState` triggers `clearWidgets()`, `logout()`, and a re-lock; `SleepActiveState` opens a PowerOff message; `NormalPowerState` re-enables RFID. `onReboot()` shows a Reboot message and logs out. All are zero-coverage.
**Fix:** Add tests calling `onPowerChanged()` with each `PowerState` enum value and `onReboot()`, asserting the correct child dialog visibility and that relay-out and GMTP messages are emitted appropriately.

---

**A20-9** · MEDIUM · Missing Test Coverage
**File:** `ui/dialog.cpp:934` (`onBleReady()`), `ui/dialog.cpp:212` (`updateBLEConSpinner()`)
**Description:** `onBleReady(false)` and `onBleReady(true)` are never called in tests. The BLE-not-ready state blocks PIN-code login (`onPinCode()` at line 271 checks `m_bleReady`). If this guard is removed, unauthenticated logins could succeed silently.
**Fix:** Add tests that call `onBleReady(false)`, attempt a pin-dialog open, verify it does not open, then call `onBleReady(true)` and verify it does open.

---

**A20-10** · LOW · Missing Test Coverage
**File:** `ui/dialog.cpp:792` (`bypassChecklist()`)
**Description:** `bypassChecklist()` contains complex logic covering time-slot, driver-based, once-per-day, master-only-driver, and convor-status checks. Only the `forceChecklist=1` path is exercised via `test_unlockMode1`. The time-slot evaluation loop, `preopOncePerDayEn()` branch, and driver-based 24-hour window logic are all untested.
**Fix:** Parameterise tests over different `checkTimeSlot` configurations and `preopOncePerDayEn` settings to exercise all branches of `bypassChecklist()`.

---

**A20-11** · LOW · Declared but Unimplemented Method
**File:** `ui/dialog.h:137`, `ui/dialog.cpp:513` (`onPreopCommentDone()`); `ui/dialog.h:137-138` (`fullLockStart()`, `updateFullLock()`)
**Description:** `onPreopCommentDone()` has a body that is completely empty (cpp:513–515). `fullLockStart()` and `updateFullLock()` are declared in the header but no corresponding implementation is visible anywhere in `dialog.cpp`. These are either dead code or incomplete features. In both cases there are no tests, and the absence of tests means the dead/stub status is invisible to CI.
**Fix:** Either implement or remove these methods. Add a test that verifies the full-lockout timeout signal (`setRelayOut(false, false)`) fires from the `LockedDialog::fullLockoutTimerEnded` connection, which is the closest covered path.

---

**A20-12** · HIGH · Missing Test Coverage — Pre-op Comment Dialog Signal Paths
**File:** `ui/dialog.cpp:108–127` (constructor signal connections for `m_preopCommentDlg`), `ui/dialog.cpp:412` (`onCheckCompletedDialogAccepted()`)
**Description:** Two signal paths for `m_preopCommentDlg` (CommentDialog, Preop type) are wired in the constructor but never exercised in tests. First, the `openPreopNotes` signal from `m_checkCompletedDialog` opens `m_preopCommentDlg` and hides `m_checkCompletedDialog` (cpp:108–111). Second, `m_preopCommentDlg->rejected` re-opens `m_checkCompletedDialog` (cpp:122–124). Third, `m_preopCommentDlg->accepted` calls `onCheckCompletedDialogAccepted()` (cpp:125–127), which at line 412–413 emits `sendGmtpMessage(CIGCONF::GMTP_AUTH_OPCMNT)` when a preop comment string is present. The condition `gCfg->showPreopComment()` is also never exercised.
**Fix:** Add a test that: (1) completes a checklist and triggers `openPreopNotes` on `m_checkCompletedDialog`; (2) verifies `m_preopCommentDlg->isVisible()`; (3) accepts with a non-empty comment, then verifies `sendGmtpMessage(GMTP_AUTH_OPCMNT)` was emitted; (4) repeats the flow and rejects on `m_preopCommentDlg`, verifying `m_checkCompletedDialog` re-appears.

---

**A20-13** · MEDIUM · Dialog Signals Never Verified with QSignalSpy
**File:** `ui/dialog.h:79–89`
**Description:** Nine of the eleven signals emitted by `Dialog` are never verified with `QSignalSpy` in `test_dialog.cpp`: `driverChanged`, `lastCheckDriverChanged`, `screenLocked`, `setRelay2Out`, `resetCanStates`, `forceBroadcastUIClose`, `log`, `updatePreopTimer`, and `amberDialogAboutToShow`. Only `sendGmtpMessage` (partially, through the BackgroundWorker wrapper spy) is checked at all. The `setRelayOut` signal is emitted directly from `test_canbus.cpp` to test downstream effects — it is never verified as an *output* of `Dialog`. The absence of signal spies means that lock transitions, relay switching, and GMTP emission can silently regress with no test failure.
**Fix:** For each safety-relevant signal add a `QSignalSpy` in the appropriate test: `driverChanged` on every `login()` / `logout()` call; `screenLocked` on every `lockScreen()` call; `setRelayOut` on checklist-complete and unlock paths; `setRelay2Out` on lock transitions. The `updatePreopTimer` signal path can be verified by checking its connection to `PreopScreenOverlay::onUpdatePreopTimer` via a spy on the overlay slot.

---

## Summary Table

| ID | Severity | Category | Subject |
|---|---|---|---|
| A20-1 | HIGH | Missing Coverage | CommentDialog – zero test coverage; unlock/preop gating untested |
| A20-2 | HIGH | Missing Coverage | CommentDialog debounce and inactivity-reset timer untested |
| A20-3 | HIGH | Missing Coverage | CommentDialog MAX_CHARACTER cap and keyboard control paths untested |
| A20-12 | HIGH | Missing Coverage | Pre-op comment dialog signal paths (openPreopNotes, accepted, rejected) untested |
| A20-4 | MEDIUM | Missing Coverage | CheckStartDialog::setMandatory(false) path untested |
| A20-5 | MEDIUM | Missing Coverage | languageChanged() for all three classes untested |
| A20-6 | MEDIUM | Missing Coverage | onProcessUnlock() unlock-reason dialog path untested |
| A20-7 | MEDIUM | Missing Coverage | Broadcast message receive/queue/response flow untested |
| A20-8 | MEDIUM | Missing Coverage | onPowerChanged() / onReboot() power-state transitions untested |
| A20-9 | MEDIUM | Missing Coverage | onBleReady() / BLE-gated login path untested |
| A20-13 | MEDIUM | Missing Coverage | Dialog signals (9 of 11) never verified with QSignalSpy |
| A20-10 | LOW | Missing Coverage | bypassChecklist() time-slot and once-per-day branches untested |
| A20-11 | LOW | Dead / Stub Code | onPreopCommentDone() is empty; fullLockStart/updateFullLock unimplemented |

**Total findings: 13 (4 HIGH, 6 MEDIUM, 3 LOW)**

**Overall assessment:** Of the 23 public methods on `Dialog`, only 3 (`onIdleTimeout`, `lockScreen`, and the constructor) have meaningful direct test coverage. `CommentDialog` has zero test coverage despite guarding a safety-critical flow — machine unlock requires collection of an unlock reason. `CheckStartDialog` coverage is superficial (visibility assertion and accept signal only). Of the 11 `Dialog` signals, 9 are never verified with `QSignalSpy`. The test suite covers approximately 10–15% of the behavioural surface area of these three files combined, and 0% of `CommentDialog`.
