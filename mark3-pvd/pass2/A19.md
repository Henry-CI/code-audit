# Audit Report – Agent A19 – Pass 2: Test Coverage

**Agent ID:** A19
**Audit Run:** 2026-02-28-01
**Pass:** 2 – Test Coverage
**Branch confirmed:** master (verified via `git branch --show-current`)
**Date:** 2026-02-28

---

## Files Under Audit

| Source File | Header File |
|---|---|
| `ui/checkcompleteddialog.cpp` | `ui/checkcompleteddialog.h` |
| `ui/checkconfirmationdialog.cpp` | `ui/checkconfirmationdialog.h` |
| `ui/checkquestiondialog.cpp` | `ui/checkquestiondialog.h` |

**Primary test file examined:** `test/test_dialog.cpp` + `test/test_dialog.h`
**Other test files checked:** `test/test_backgroundworker.cpp`, `test/test_canbus.cpp`, `test/test_ota.cpp` (no relevant references found in any of these).

---

## Reading Evidence

### CheckCompletedDialog (`ui/checkcompleteddialog.h` / `ui/checkcompleteddialog.cpp`)

**Includes:**
- `<QDialog>`, `<QTimer>`, `"app/cigconfigs.h"` (header)
- `"checkcompleteddialog.h"`, `"ui_checkcompleteddialog.h"`, `"app/globalconfigs.h"` (implementation)

**Class:** `CheckCompletedDialog : public QDialog`

**`UNIT_TEST` friend:** `friend class TestDialog;` (line 26 of header)

**Public methods (with line numbers in header/implementation):**

| Method | Header Line | Implementation Line |
|---|---|---|
| `CheckCompletedDialog(QWidget *parent = 0)` | 17 | cpp:7 |
| `~CheckCompletedDialog()` | 18 | cpp:62 |
| `void languageChanged(void)` | 20 | cpp:67 |
| `bool isTimerActive()` | 21 | cpp:135 |
| `void stopTimer()` | 22 | cpp:140 |
| `void setCheckResponses(QList<CIGCONF::CheckResponse> &responses)` | 23 (inline) | — |

**Signals:**
| Signal | Header Line |
|---|---|
| `void openPreopNotes()` | 31 |

**Protected methods:**
| Method | Header Line | Implementation Line |
|---|---|---|
| `void showEvent(QShowEvent *event = 0)` | 33 | cpp:75 |

**Internal timer constant:** `NO_ACTIVITY_TIME 10000` (10-second auto-accept timer, cpp:5)

**Button connections in constructor (implementation):**
- `btnSend` clicked → stop timer + `accept()` (cpp:28–31)
- `btnRepeat` clicked → stop timer + `reject()` (cpp:33–36)
- `btnSend_2` clicked → stop timer + `accept()` (cpp:38–41)
- `btnRepeat_2` clicked → stop timer + `reject()` (cpp:43–46)
- `btnNotes` clicked → stop timer + emit `openPreopNotes()` (cpp:48–51)
- `btnNotes_2` clicked → stop timer + emit `openPreopNotes()` (cpp:53–56)
- `m_timer` timeout → `accept()` (cpp:58)

---

### CheckConfirmationDialog (`ui/checkconfirmationdialog.h` / `ui/checkconfirmationdialog.cpp`)

**Includes:**
- `<QDialog>`, `"ui/dialog.h"` (header)
- `"checkconfirmationdialog.h"`, `"ui_checkconfirmationdialog.h"` (implementation)

**Class:** `CheckConfirmationDialog : public QDialog`

**No `UNIT_TEST` friend class declared.**

**No signals declared.**

**Public methods:**

| Method | Header Line | Implementation Line |
|---|---|---|
| `CheckConfirmationDialog(QWidget *parent = 0)` | 16 | cpp:4 |
| `~CheckConfirmationDialog()` | 17 | cpp:24 |
| `void confirm(bool yes)` | 19 | cpp:29 |
| `void setQuestion(const QString &question)` | 20 | cpp:40 |
| `void languageChanged(void)` | 21 | cpp:45 |

**Button connections in constructor:**
- `btnBack` clicked → `reject()` (cpp:18)
- `btnNext` clicked → `accept()` (cpp:19)
- `btnNext_2` clicked → `accept()` (cpp:20)
- `btnBack_2` clicked → `reject()` (cpp:21)

**Note:** The constructor body in `dialog.cpp` (line 349–356) shows that `CheckConfirmationDialog` usage is entirely commented out. The dialog's `confirm()` and `setQuestion()` are no longer called from any active code path; `onCheckQuestionDialogFinished` now bypasses `CheckConfirmationDialog` entirely and calls `onCheckConfirmationDialogFinished` directly.

---

### CheckQuestionDialog (`ui/checkquestiondialog.h` / `ui/checkquestiondialog.cpp`)

**Includes:**
- `<QDialog>`, `<QTimer>`, `"ui/dialog.h"` (header)
- `"checkquestiondialog.h"`, `"ui_checkquestiondialog.h"` (implementation)

**Class:** `CheckQuestionDialog : public QDialog`

**`UNIT_TEST` friend:** `friend class TestDialog;` (line 23 of header)

**Public methods:**

| Method | Header Line | Implementation Line |
|---|---|---|
| `CheckQuestionDialog(QWidget *parent = 0)` | 17 | cpp:4 |
| `~CheckQuestionDialog()` | 18 | cpp:14 |
| `const QString &question() const` | 20 (inline) | — |
| `void setQuestion(const QString &question, bool critical = false)` | 21 | cpp:19 |

**Signals:**
| Signal | Header Line |
|---|---|
| `void shown(void)` | 28 |

**Protected methods:**
| Method | Header Line | Implementation Line |
|---|---|---|
| `void showEvent(QShowEvent *event)` | 31 | cpp:39 |

**Button connections in constructor:**
- `btnYes` clicked → `accept()` (cpp:10)
- `btnNo` clicked → `reject()` (cpp:11)

**Notable behavior:** `setQuestion()` calls `qrand() % 2` (cpp:24) to randomly swap Yes/No button positions.

---

## Test Coverage Analysis

### Test file: `test/test_dialog.cpp`

**Relevant test slots declared in `test/test_dialog.h`:**
```
void test_enums();
void test_globalConfigs();
void test_idleLockout();
void test_showPreopSummary();
void test_unlockMode1();
void test_showTime();
```

No dedicated test slot exists for `CheckCompletedDialog`, `CheckConfirmationDialog`, or `CheckQuestionDialog` in isolation. Coverage is only incidental through integration-level tests.

---

### CheckCompletedDialog – Coverage Detail

| Item | Covered? | Evidence |
|---|---|---|
| Construction | Indirect only | Created as `m_dialog->m_checkCompletedDialog` inside `Dialog` constructor; no direct standalone construction test |
| `setCheckResponses()` | Yes | `test_dialog.cpp:433, 442, 451` |
| `showEvent()` with `showPreopSummary OFF` | Yes | `test_dialog.cpp:424–425` (via `onCheckConfirmationDialogFinished`) |
| `showEvent()` with `showPreopSummary ON`, 0 failures | Yes | `test_dialog.cpp:434–437` |
| `showEvent()` with `showPreopSummary ON`, 1 failure | Yes | `test_dialog.cpp:443–446` |
| `showEvent()` with `showPreopSummary ON`, 2 failures | Yes | `test_dialog.cpp:451–455` |
| `showEvent()` with `showPreopComment ON` | No | Branch at `checkcompleteddialog.cpp:86` (`gCfg->showPreopComment()`) never exercised in tests |
| `isTimerActive()` | No | Method never called in any test |
| `stopTimer()` | No | Method never called in any test (only called from `dialog.cpp:878`) |
| `languageChanged()` | No | Method never called in any test |
| Auto-accept timer fires (`m_timer` timeout → `accept()`) | No | The 10-second auto-accept timer is never tested |
| `openPreopNotes` signal emission | No | Signal never captured by a `QSignalSpy` in any test |
| `btnNotes` / `btnNotes_2` click | No | Not exercised |
| `btnRepeat` / `btnRepeat_2` click (reject) | Indirect | `test_dialog.cpp:520` uses `btnSend->clicked()` (accept path); reject path untested at button level |
| `accept()` on `btnSend` | Yes (indirect) | `test_dialog.cpp:520` emits `btnSend->clicked()` |
| Singular vs plural summary text | Yes | 0, 1, 2 failure cases verified |
| Red/black stylesheet on `lblSummaryCritical` | No | Stylesheet value never asserted |
| Button layout for `showPreopComment` on vs off | No | Pixel positions never verified |

---

### CheckConfirmationDialog – Coverage Detail

| Item | Covered? | Evidence |
|---|---|---|
| Construction | Indirect only | Created inside `Dialog` constructor (`dialog.cpp:46`); no standalone test |
| `confirm(true)` | No | Never called in any test |
| `confirm(false)` | No | Never called in any test |
| `setQuestion()` | No | Never called in any test |
| `languageChanged()` | No | Never called in any test |
| `btnNext` / `btnNext_2` click → accept | No | Never exercised |
| `btnBack` / `btnBack_2` click → reject | No | Never exercised |
| No `UNIT_TEST` friend class | — | This class has no `friend class TestDialog;` guard, so internals cannot be inspected in tests |
| Active code path | No | The entire dialog is bypassed: `dialog.cpp:349–356` (the calls to `confirm()`, `setQuestion()`, `open()`) are commented out |

---

### CheckQuestionDialog – Coverage Detail

| Item | Covered? | Evidence |
|---|---|---|
| Construction | Indirect only | Created inside `Dialog` constructor (`dialog.cpp:45`); no standalone test |
| `setQuestion()` with `critical = false` | No | Not directly tested; only via integration (`dialog.cpp:384, 747`) |
| `setQuestion()` with `critical = true` | No | Not directly tested |
| `question()` accessor | No | Never called in any test |
| `showEvent()` → emits `shown` | No | Signal never captured by a `QSignalSpy` |
| `shown` signal | No | Never captured |
| Random button swap (`qrand() % 2`) | No | Never tested for either position |
| `btnYes` click → accept | Indirect | `test_dialog.cpp:516` calls `m_checkQuestionDialog->accept()` directly, bypassing button |
| `btnNo` click → reject | No | Not exercised in any test |
| `isVisible()` check after `open()` | Yes | `test_dialog.cpp:514` |
| Empty question string | No | Not tested |
| Very long question string | No | Not tested |
| Special characters in question | No | Not tested |
| `lblCritical` show/hide logic | No | Not asserted in any test |

---

## Findings

**A19-1** · HIGH · Missing Coverage – Untested Signal
**File:** `ui/checkcompleteddialog.cpp:48–55` / `ui/checkcompleteddialog.h:31`
**Description:** The `openPreopNotes` signal is emitted when either `btnNotes` or `btnNotes_2` is clicked. No test uses a `QSignalSpy` to verify this signal is emitted, nor are either button's click events exercised in any test. This signal drives navigation to the pre-op notes screen; an untested signal path could silently break under refactoring.
**Fix:** Add a dedicated test that creates a `CheckCompletedDialog`, calls `showEvent()` with `gCfg->showPreopComment()` returning true so the Notes buttons are shown, attaches a `QSignalSpy` to `openPreopNotes`, programmatically clicks `btnNotes` (and separately `btnNotes_2`), and asserts that the spy count reaches 1 in each case.

---

**A19-2** · HIGH · Missing Coverage – Auto-Accept Timer Never Tested
**File:** `ui/checkcompleteddialog.cpp:58–59` / `ui/checkcompleteddialog.h:21–22`
**Description:** The 10-second `QTimer` auto-accepts the dialog (`m_timer` timeout → `accept()`). The methods `isTimerActive()` and `stopTimer()` also exist to manage this timer. No test verifies that: (a) the timer starts on `showEvent()`, (b) `isTimerActive()` correctly reflects timer state, (c) `stopTimer()` halts the timer, or (d) expiry causes `accept()` to be signalled. A regression that accidentally removed the timer start or broke the connection would go undetected.
**Fix:** Add tests that call `showEvent()` and immediately assert `isTimerActive() == true`; call `stopTimer()` and assert `isTimerActive() == false`; separately let the timer fire (using `QTest::qWait(11000)` or a shorter test-only timeout) and verify the dialog emits `accepted`.

---

**A19-3** · HIGH · Missing Coverage – CheckConfirmationDialog Entirely Untested
**File:** `ui/checkconfirmationdialog.cpp` / `ui/checkconfirmationdialog.h`
**Description:** `CheckConfirmationDialog` has zero direct test coverage. None of its three public methods (`confirm()`, `setQuestion()`, `languageChanged()`) appear in any test. No button interaction is exercised. Additionally, the class has no `UNIT_TEST` friend guard, so private internals remain inaccessible to tests. While the dialog is currently bypassed in production code (the call site in `dialog.cpp:349–356` is commented out), the class is still compiled and shipped. If the code path is re-enabled, there is no safety net.
**Fix:** Add a dedicated test slot (e.g., `test_checkConfirmationDialog`) that: constructs `CheckConfirmationDialog` directly; calls `setQuestion()` with a normal string and verifies the label text; calls `confirm(true)` and verifies `labelYes` is visible and `labelNo` is hidden; calls `confirm(false)` and verifies the inverse; calls `languageChanged()` without crashing; simulates button clicks for accept and reject paths. Also add `friend class TestDialog;` inside a `#ifdef UNIT_TEST` guard to allow widget inspection.

---

**A19-4** · HIGH · Missing Coverage – CheckQuestionDialog `shown` Signal Never Tested
**File:** `ui/checkquestiondialog.cpp:39–43` / `ui/checkquestiondialog.h:28`
**Description:** `showEvent()` emits the `shown` signal, which in production is used by `dialog.cpp:187` to trigger an idle timer. No test attaches a `QSignalSpy` to this signal to verify it is emitted on `show()`. A regression disconnecting or removing this emission would be undetectable.
**Fix:** Add a test that constructs a `CheckQuestionDialog`, attaches `QSignalSpy spy(dlg, &CheckQuestionDialog::shown)`, calls `dlg->show()`, calls `QTest::qWait()`, and asserts `spy.count() == 1`.

---

**A19-5** · MEDIUM · Missing Coverage – `setQuestion()` Critical vs Non-Critical Path
**File:** `ui/checkquestiondialog.cpp:19–37`
**Description:** `setQuestion()` has two distinct branches controlled by the `critical` parameter: `lblCritical` is shown when `critical == true` and hidden when `false`. No test verifies either branch. The `critical` label visibility is safety-relevant (it visually alerts the driver that a question has critical consequences). Additionally the random button position swap (`qrand() % 2`, line 24) is never tested.
**Fix:** Add tests that call `setQuestion("Question?", false)` and assert `lblCritical` is not visible; call `setQuestion("Question?", true)` and assert `lblCritical` is visible. For the button swap, seed `qsrand` with a known value or test both swap outcomes across multiple calls, asserting that both button positions are encountered.

---

**A19-6** · MEDIUM · Missing Coverage – `languageChanged()` on CheckCompletedDialog Never Tested
**File:** `ui/checkcompleteddialog.cpp:67–73`
**Description:** `languageChanged()` updates four UI labels. This method is never called in any test. A typo or missing label update would be undetected. Note that `showEvent()` also sets the same labels (lines 81–84), so there is also a risk of divergence between the two paths.
**Fix:** Add a test that calls `languageChanged()` on a `CheckCompletedDialog` instance (with a known locale) and asserts each of the four label texts: `label_2`, `btnSend_2`, `btnRepeat_2`, `btnNotes_2`.

---

**A19-7** · MEDIUM · Missing Coverage – `showPreopComment` Branch in `showEvent()` Never Tested
**File:** `ui/checkcompleteddialog.cpp:86–102`
**Description:** `showEvent()` branches on `gCfg->showPreopComment()`. All tests call `showEvent()` with `showPreopComment` returning false (its default reset value). The true branch (which shows Notes buttons and repositions all buttons) is never tested. This means button visibility changes and layout calculations for the notes-enabled configuration are entirely untested.
**Fix:** Add a test that sets `gCfg->showPreopComment()` to true before calling `showEvent()` and asserts that `btnNotes->isVisible() == true` and `btnNotes_2->isVisible() == true`. Conversely assert these are hidden when the flag is false.

---

**A19-8** · MEDIUM · Missing Coverage – `setQuestion()` Input Validation Not Tested
**File:** `ui/checkconfirmationdialog.cpp:40–43` / `ui/checkquestiondialog.cpp:19–37`
**Description:** Neither `CheckConfirmationDialog::setQuestion()` nor `CheckQuestionDialog::setQuestion()` is tested with boundary inputs: empty string (`""`), a very long string (e.g., 10,000 characters), or strings containing special/HTML characters (e.g., `"<b>Test</b>"`, `"\n\t"`). Qt's `QLabel::setText()` interprets some HTML by default depending on the label's `textFormat` setting; unexpected rich-text injection could cause display corruption.
**Fix:** Add parameterised tests for each `setQuestion()` with empty string, a 10,000-character string, and a string containing `<b>`, `&`, and newline characters. Assert that the label's `text()` matches the input exactly (or is safely escaped).

---

**A19-9** · MEDIUM · Missing Coverage – `btnNo` Click on CheckQuestionDialog Never Exercised
**File:** `ui/checkquestiondialog.cpp:11`
**Description:** `test_unlockMode1` calls `m_checkQuestionDialog->accept()` directly (line 516) rather than simulating a button click. This means `btnNo->clicked()` → `reject()` path is never exercised, and the button connection itself is never tested.
**Fix:** Add a test that calls `setQuestion()`, then programmatically emits `ui->btnNo->clicked()` (accessible via `UNIT_TEST` friend), and asserts the dialog result is `QDialog::Rejected`.

---

**A19-10** · LOW · Missing Coverage – `question()` Accessor Never Tested
**File:** `ui/checkquestiondialog.h:20` / `ui/checkquestiondialog.cpp:35`
**Description:** The inline `question()` const accessor returns `m_question`, which is set by `setQuestion()`. This accessor is used by the (now commented-out) confirmation flow in `dialog.cpp:350`. No test verifies that calling `setQuestion("text")` causes `question()` to return `"text"`.
**Fix:** Add an assertion `QCOMPARE(dlg->question(), QString("text"))` immediately after calling `dlg->setQuestion("text", false)`.

---

**A19-11** · LOW · Missing Coverage – `btnRepeat` / `btnRepeat_2` (Reject Path) Not Button-Tested
**File:** `ui/checkcompleteddialog.cpp:33–46`
**Description:** The test at line 520 of `test_dialog.cpp` only exercises the accept path via `btnSend->clicked()`. The reject path (`btnRepeat` / `btnRepeat_2` clicked → `reject()`) is never triggered by any button simulation in any test. This leaves the timer-stop-on-reject branch unverified.
**Fix:** Add a test that programmatically emits `btnRepeat->clicked()` on a visible `CheckCompletedDialog`, uses `QSignalSpy` on the `rejected()` signal, and asserts the spy count reaches 1 and `isTimerActive()` returns false afterward.

---

**A19-12** · LOW · Dead / Commented-Out Code Path Masks Coverage Gap
**File:** `ui/dialog.cpp:349–356`
**Description:** The entire `CheckConfirmationDialog` integration flow is commented out in `onCheckQuestionDialogFinished()`. The dialog is constructed, connected, and resized/moved but is never actually opened in production. This means any test of the integrated flow (e.g., `test_unlockMode1`) can never reach `CheckConfirmationDialog`'s UI, so any coverage of that dialog through integration routes is structurally impossible without first restoring or redesigning the commented code. The commented block also leaves `m_checkConfirmationDialog` as a permanently unused allocated object.
**Fix:** Either remove `CheckConfirmationDialog` and its allocations from `dialog.cpp` entirely (and mark it for deletion), or restore and test its integration path. If kept, add a clear `// DEAD CODE` comment with a ticket reference and ensure the unit tests cover the class standalone (see A19-3).

---

## Summary Table

| Finding | Severity | Category | Dialog |
|---|---|---|---|
| A19-1 | HIGH | Untested Signal (`openPreopNotes`) | CheckCompletedDialog |
| A19-2 | HIGH | Untested Auto-Accept Timer | CheckCompletedDialog |
| A19-3 | HIGH | Class Entirely Untested | CheckConfirmationDialog |
| A19-4 | HIGH | Untested Signal (`shown`) | CheckQuestionDialog |
| A19-5 | MEDIUM | Critical Label Branch Untested | CheckQuestionDialog |
| A19-6 | MEDIUM | `languageChanged()` Untested | CheckCompletedDialog |
| A19-7 | MEDIUM | `showPreopComment` Branch Untested | CheckCompletedDialog |
| A19-8 | MEDIUM | No Input Validation / Boundary Tests | CheckConfirmationDialog, CheckQuestionDialog |
| A19-9 | MEDIUM | `btnNo` Click Path Untested | CheckQuestionDialog |
| A19-10 | LOW | `question()` Accessor Untested | CheckQuestionDialog |
| A19-11 | LOW | Reject Button Path Untested | CheckCompletedDialog |
| A19-12 | LOW | Commented-Out Code Masks Coverage Gap | CheckConfirmationDialog |

**Total findings: 12** (4 HIGH, 5 MEDIUM, 3 LOW)

---

## Coverage Summary by Dialog

| Dialog | Construction Tested | Signals Tested | Public Methods Tested | Button Paths Tested | Input Validation |
|---|---|---|---|---|---|
| CheckCompletedDialog | No (indirect only) | No | Partial (setCheckResponses, showEvent partially) | Accept only | None |
| CheckConfirmationDialog | No (indirect only) | N/A (no signals) | None | None | None |
| CheckQuestionDialog | No (indirect only) | No | None directly | Accept only (via direct call) | None |
