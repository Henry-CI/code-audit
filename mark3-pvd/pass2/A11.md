# Audit Report – Agent A11 (Test Coverage)
**Audit Run:** 2026-02-28-01
**Pass:** 2 – Test Coverage
**Agent:** A11
**Branch confirmed:** master
**Date:** 2026-02-28

---

## Files Assigned

| File | Path |
|------|------|
| main.cpp | `C:/Projects/cig-audit/repos/mark3-pvd/main.cpp` |
| mytranslator.cpp | `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.cpp` |
| mytranslator.h | `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.h` |

---

## Step 1 – Branch Verification

```
git branch --show-current → master
```

Confirmed: working on branch **master**.

---

## Step 2 – Reading Evidence

### main.cpp

**Class:** None (free functions + `main` entry point)

**Includes:**
- `<QApplication>`
- `<QDateTime>`
- `<QThread>`
- `<QFile>`
- `<QDebug>`
- `<QTranslator>`
- `<QProcess>`
- `"utils/logger.h"`
- `"ui/keyfilter.h"`
- `"ui/dialog.h"`
- `"app/backgroundworker.h"`
- `"mytranslator.h"`
- `<sys/mman.h>`

**Functions:**

| Line | Signature |
|------|-----------|
| 24 | `void hideBootProgress()` |
| 38 | `void configureCrashLogging()` |
| 71 | `int main(int argc, char *argv[])` |

**Key observations:**
- `hideBootProgress()` writes directly to `/sys/module/nuc970fb/parameters/progress` (ARM-only, `#ifdef __arm__`).
- `configureCrashLogging()` writes a shell script to `/mnt/sd/app_monitor` and launches it with `QProcess::startDetached`; it is currently **commented out** at the call site (line 101).
- `main()` calls six `QProcess::execute()` shell commands to configure GPIO pins via `/sys/class/gpio` (lines 109–115), unconditionally on all platforms.
- `main()` constructs `QApplication`, `KeyFilter`, `Dialog`, `BackgroundWorker`, and a `QThread`, wires signals/slots, and enters the Qt event loop.
- `loadLocalLanguage()` is called at line 81 before any UI is shown.
- A commented-out `TODO` (lines 92–96) notes that production log redirection is not yet enabled.
- `CONSTRAINED_MEMORY_TEST` dead code block (lines 19–22, 102–105) locks a 10 MB memory region; it is compiled out by default but the dead code remains.

---

### mytranslator.h

**Class:** None (C-style free-function header)

**Includes:**
- `<QtGlobal>`

**Declarations:**

| Line | Signature |
|------|-----------|
| 11 | `const QString langEnglish = "EN"` |
| 12 | `const QString langSpanish = "ES"` |
| 14 | `extern QTranslator mTranslator` |
| 15 | `void loadLocalLanguage(void)` |
| 16 | `void updateLocalLanguage(const QString &arg1)` |
| 17 | `QString getCurrentLanguage(void)` |
| 18 | `int queryLanguage(void)` |
| 19 | `int setLanguage(int local)` |
| 20 | `void removeTranslator()` |

**Key observation:** `const QString langEnglish` and `const QString langSpanish` are defined in the header (not `inline`). Any translation unit that includes this header gets its own copy, which causes **ODR (One Definition Rule) violations** at link time if multiple translation units include it.

---

### mytranslator.cpp

**Class:** None (free functions)

**Includes:**
- `<QApplication>`
- `<QFile>`
- `<QDebug>`
- `<QTranslator>`
- `"mytranslator.h"`

**Functions:**

| Line | Signature |
|------|-----------|
| 15 | `void loadLocalLanguage(void)` |
| 74 | `void updateLocalLanguage(const QString &arg1)` |
| 132 | `QString getCurrentLanguage(void)` |
| 167 | `int queryLanguage(void)` |
| 177 | `int setLanguage(int local)` |
| 190 | `void removeTranslator()` |

**Global state:** `QTranslator mTranslator` at file scope (line 10).

**Key observations:**
- All file I/O is against hardcoded paths: `"local.dat"` (relative, CWD-dependent) and `":/lang.dat"` (Qt resource).
- `loadLocalLanguage()` silently deletes `local.dat` if no matching language is found (line 62), making repeated calls destructive.
- `updateLocalLanguage()` opens `localFile` with `QIODevice::ReadWrite` but does not truncate first; if the new language string is shorter than the old one, stale bytes remain.
- `queryLanguage()` returns `-1` for any language that is not English or Spanish; callers receive a sentinel with no named constant.
- `setLanguage()` returns `-1` for an unsupported locale integer without any error signal or documented contract.
- `removeTranslator()` depends on the global `mTranslator` singleton being the one that was installed; a second translator loaded from elsewhere would not be removed.

---

## Step 3 – Test Coverage Search

**Search targets:** `MyTranslator`, `mytranslator`, `loadLocalLanguage`, `updateLocalLanguage`, `getCurrentLanguage`, `queryLanguage`, `setLanguage`, `removeTranslator`, `mTranslator`, `langEnglish`, `langSpanish`

**Search path:** `C:/Projects/cig-audit/repos/mark3-pvd/test/`

**Result:** **Zero matches** across all test files.

**Test files present:**
- `test/test_backgroundworker.cpp` / `.h`
- `test/test_canbus.cpp` / `.h`
- `test/test_dialog.cpp` / `.h`
- `test/test_ota.cpp` / `.h`

**Project file confirmation:**
- `mk3.pro` lists `main.cpp` (production build, no test runner).
- `mk3-test.pro` lists `mytranslator.cpp` in `SOURCES` (line 44) and `mytranslator.h` in `HEADERS` (line 107) — meaning the translation unit is **compiled into the test binary** — but no test class or test function references any of its symbols.
- `main.cpp` is deliberately absent from `mk3-test.pro`, which is correct practice (the test binary supplies its own `main()`).

---

## Step 4 – Findings

---

**A11-1** · HIGH · Missing Test Coverage – Complete Absence
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.cpp`
**Description:** No test file exercises any function in `mytranslator.cpp`. The module is compiled into the test binary (`mk3-test.pro` line 44) but none of its six public functions (`loadLocalLanguage`, `updateLocalLanguage`, `getCurrentLanguage`, `queryLanguage`, `setLanguage`, `removeTranslator`) are called from any test case. Language selection is a user-visible feature and file-system-mutating code; the absence of any test coverage means regressions will not be detected.
**Fix:** Create `test/test_translator.cpp` and `test/test_translator.h` with a `TestTranslator` QObject test class. Add it to `mk3-test.pro`. Use `QTemporaryDir` to sandbox file I/O so tests are hermetic. Register the class in the test runner in `test_backgroundworker.cpp` (lines 370–386). Minimum cases: happy path load, missing `local.dat`, unrecognised language token, empty `local.dat`, `lang.dat` resource missing or empty, `updateLocalLanguage` with unknown language, `queryLanguage` English/Spanish/unknown, `setLanguage` no-op when language matches.

---

**A11-2** · HIGH · Missing Test – `loadLocalLanguage` Silently Deletes State File
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.cpp:55-62`
**Description:** When a language is read from `local.dat` but no matching entry is found in `lang.dat`, `loadLocalLanguage()` calls `local.remove()` (line 62), permanently deleting the persisted setting. There is no test that verifies whether this destructive fallback is intentional and behaves correctly (e.g., whether the application then defaults to English on next boot, and whether partial `local.dat` content triggers deletion). A regression here could silently reset the language for all devices on a firmware update that changes `lang.dat` entries.
**Fix:** In `TestTranslator`, write a `local.dat` containing a language code that is absent from a mock `lang.dat`, call `loadLocalLanguage()`, and assert that `local.dat` is removed and that a subsequent `getCurrentLanguage()` returns `langEnglish`.

---

**A11-3** · MEDIUM · Missing Test – `updateLocalLanguage` File Truncation Bug (No Test Catches It)
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.cpp:112-118`
**Description:** `local.dat` is opened with `QIODevice::ReadWrite | QIODevice::Text` without `QIODevice::Truncate`. If a previously-written language string is longer than the new one (e.g., switching from a future 10-char code back to `"EN"`), stale trailing bytes remain in the file. A subsequent `loadLocalLanguage()` would read the full corrupt line, fail to match any language, and delete `local.dat`. There is no test that catches this corruption path because the module has zero test coverage.
**Fix:** Add a test that writes a long language string, then calls `updateLocalLanguage("EN")`, then reads back `local.dat` directly and asserts it contains exactly `"EN\n"` with no trailing characters. Also fix the production code by adding `QIODevice::Truncate` to the open flags.

---

**A11-4** · MEDIUM · Missing Test – `queryLanguage` Returns Undocumented Sentinel `-1`
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.cpp:167-175`
**Description:** `queryLanguage()` returns `-1` for any language that is not English or Spanish. There is no named constant for this sentinel and no test that verifies callers handle it. `setLanguage()` (line 177) also returns `-1` for unsupported locale integers. Callers that treat the return value as a `QLocale::Language` enum would interpret `-1` as `QLocale::AnyLanguage` (value 0 in some Qt versions) or cause undefined behaviour. No test currently validates the boundary conditions or return semantics.
**Fix:** Define a named constant (e.g., `const int langUnknown = -1`) and add tests asserting that `queryLanguage()` returns it for unsupported languages, and that `setLanguage()` with an unknown locale returns `-1` without modifying `local.dat`.

---

**A11-5** · MEDIUM · Missing Test – `getCurrentLanguage` with Corrupt or Multi-Line `local.dat`
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.cpp:132-165`
**Description:** `getCurrentLanguage()` reads only the first line of `local.dat` (`in.readLine()`, line 141) and uses a case-insensitive match. There is no test for: an empty first line, a line with only whitespace, a file containing multiple lines, or a file with a BOM. These edge cases are especially relevant because `updateLocalLanguage()` may write stale bytes (see A11-3) that corrupt the first line.
**Fix:** Add parametrised tests in `TestTranslator` for each of: empty file, whitespace-only first line, multi-line file (second line is valid language), BOM-prefixed content. Verify that `getCurrentLanguage()` returns `langEnglish` for all invalid-input cases.

---

**A11-6** · MEDIUM · main.cpp – Startup Logic Not Testable Due to Hardwired Side Effects
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/main.cpp:71-135`
**Description:** `main()` cannot be unit tested (correctly excluded from `mk3-test.pro`). However, the two free functions `hideBootProgress()` and `configureCrashLogging()` are also not covered by any test, and both contain side effects (file writes to `/sys/...` and `/mnt/sd/...`, and `QProcess::startDetached`). The six `QProcess::execute()` GPIO calls (lines 109–115) in `main()` are not wrapped or abstracted, making it impossible to test initialization logic without real hardware. The dead `CONSTRAINED_MEMORY_TEST` block (lines 17–22, 102–105) also calls `mlock()` which would affect test environments if accidentally enabled.
**Fix:** Extract GPIO setup and boot-progress toggling into an abstracted platform interface (or at minimum a standalone free function guarded by `#ifndef UNIT_TEST`) so the logic can be exercised in the test build without requiring `/sys/class/gpio`. Add unit tests for `hideBootProgress()` and `configureCrashLogging()` that mock the file system. Remove or formally document the `CONSTRAINED_MEMORY_TEST` dead code.

---

**A11-7** · LOW · ODR Violation Risk – `const QString` Definitions in Header
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.h:11-12`
**Description:** `langEnglish` and `langSpanish` are defined as `const QString` objects in a header file. In C++, `const` variables at namespace scope have internal linkage, so each translation unit gets its own copy. For plain types this is harmless, but `QString` has a non-trivial constructor; the duplicated static objects increase binary size and may cause subtle lifetime issues in translation units that outlive the destructor order. No test validates the string values or detects silent redefinition.
**Fix:** Move the definitions to `mytranslator.cpp` and declare them `extern const QString` in the header, or use `inline const QString` (C++17) / `constexpr char[]` literals.

---

**A11-8** · LOW · Missing Test – `removeTranslator` with No Translator Installed
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/mytranslator.cpp:190-198`
**Description:** `removeTranslator()` guards removal with `!mTranslator.isEmpty()`, but there is no test that calls it before any translator is installed, verifying the guard works correctly and does not crash. There is also no test for the path where `QCoreApplication::removeTranslator()` returns `false` (translator not found), which triggers a debug print but no error handling.
**Fix:** Add tests: (1) call `removeTranslator()` with no translator loaded and verify no crash; (2) install a translator, call `removeTranslator()`, verify the translator is no longer active; (3) call `removeTranslator()` twice and verify the second call is a no-op.

---

## Step 5 – Summary Table

| ID | Severity | Category | File | Brief Description |
|----|----------|----------|------|-------------------|
| A11-1 | HIGH | Missing Coverage | `mytranslator.cpp` | Zero test coverage across all six public functions |
| A11-2 | HIGH | Missing Coverage | `mytranslator.cpp:55-62` | No test for `loadLocalLanguage` destructive file deletion on language mismatch |
| A11-3 | MEDIUM | Missing Coverage / Bug | `mytranslator.cpp:112-118` | No test for `updateLocalLanguage` file-truncation bug |
| A11-4 | MEDIUM | Missing Coverage | `mytranslator.cpp:167-175` | No test for `queryLanguage`/`setLanguage` sentinel `-1` return |
| A11-5 | MEDIUM | Missing Coverage | `mytranslator.cpp:132-165` | No test for `getCurrentLanguage` with corrupt or edge-case `local.dat` content |
| A11-6 | MEDIUM | Testability / Design | `main.cpp:71-135` | Startup side effects (GPIO, file writes, process launch) are not abstracted or tested |
| A11-7 | LOW | Design / ODR | `mytranslator.h:11-12` | `const QString` constants defined in header — ODR risk and binary bloat |
| A11-8 | LOW | Missing Coverage | `mytranslator.cpp:190-198` | No test for `removeTranslator` edge cases (uninstalled translator, double-remove) |

---

*End of report – Agent A11, Pass 2 (Test Coverage), Audit 2026-02-28-01*
