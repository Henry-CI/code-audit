# Audit Report — Agent A18 — Pass 2: Test Coverage

**Agent:** A18
**Audit Run:** 2026-02-28-01
**Branch confirmed:** master
**Date:** 2026-02-28

---

## Files Assigned

| File | Role |
|---|---|
| `ui/amberimpactalertdialog.h` | Header |
| `ui/amberimpactalertdialog.cpp` | Implementation |
| `ui/authoriseddialog.h` | Header |
| `ui/authoriseddialog.cpp` | Implementation |
| `ui/broadcastuidialog.h` | Header |
| `ui/broadcastuidialog.cpp` | Implementation |

Primary test files examined:
- `test/test_dialog.cpp`
- `test/test_dialog.h`

All other test files also searched: `test/test_backgroundworker.cpp`, `test/test_canbus.cpp`, `test/test_ota.cpp`.

---

## Reading Evidence

### AmberImpactAlertDialog (`ui/amberimpactalertdialog.h` / `.cpp`)

**Class:** `AmberImpactAlertDialog : public QDialog`

**Includes:**
- `amberimpactalertdialog.h`
- `ui_amberimpactalertdialog.h`
- `app/globalconfigs.h`
- `<QDebug>`

**Public methods:**

| Line | Method |
|---|---|
| h:15 / cpp:6 | `explicit AmberImpactAlertDialog(QWidget *parent = nullptr)` — constructor |
| h:16 / cpp:14 | `~AmberImpactAlertDialog()` — destructor |
| h:18 / cpp:49 | `bool isOpen() const` — returns `dialogOpenFlag` |
| h:19 / cpp:31 | `void closeWindow()` — closes if `dialogOpenFlag == true` |
| h:20 / cpp:19 | `void languageChanged()` — updates UI label text via `tr()` |

**Public slots:**

| Line | Slot |
|---|---|
| h:23 / cpp:54 | `void amberAlertDialogShowEvent(bool isLocked)` — conditionally calls `exec()` when not locked and amber alert is active |

**Protected overrides:**

| Line | Method |
|---|---|
| h:26 / cpp:25 | `void mouseReleaseEvent(QMouseEvent *)` — calls `closeWindow()` |
| h:27 / cpp:39 | `void showEvent(QShowEvent *event = 0)` — sets `dialogOpenFlag = true` if alert active |

**Private members:**
- `Ui::AmberImpactAlertDialog *ui`
- `bool dialogOpenFlag`

**Signals:** None declared.

**Key logic notes:**
- `dialogOpenFlag` is the sole guard preventing double-open; it is set in `showEvent()` and cleared in `closeWindow()`.
- `amberAlertDialogShowEvent(bool isLocked)` calls `exec()` (blocking modal); it also re-checks `amberImpactAlertActive()` and `dialogOpenFlag` independently of `showEvent()`, creating a secondary code path.

---

### AuthorisedDialog (`ui/authoriseddialog.h` / `.cpp`)

**Class:** `AuthorisedDialog : public QDialog`

**Includes:**
- `app/globalconfigs.h`
- `authoriseddialog.h`
- `ui_authoriseddialog.h`
- `ui/optionalcheckconfirmationdialog.h`
- `<QMouseEvent>`, `<QTimer>`, `app/driverlist.h`, `<QDebug>`, `<QFile>`

**Public methods:**

| Line | Method |
|---|---|
| h:17 / cpp:13 | `explicit AuthorisedDialog(QWidget *parent = 0)` — constructor; wires all signals/slots, creates timer |
| h:18 / cpp:44 | `~AuthorisedDialog()` — destructor |
| h:19 / cpp:56 | `void setHasChecklist(bool yes)` — shows/hides `btnStart` and `labelStart` |
| h:20 / cpp:67 | `void setDriverId(quint64 id)` — stores `m_pendingDriverId` |
| h:21 / cpp:178 | `void setTime(const QString s)` — updates `labelTime` text |
| h:22 / cpp:211 | `void setPower(bool on)` — stores `m_power` and calls `updateCamera()` |
| h:23 / cpp:217 | `void updateCamera()` — writes GPIO-based camera enable/flip to sysfs |

**Signals:**

| Line | Signal |
|---|---|
| h:30 | `void userLogout()` |

**Protected overrides:**

| Line | Method |
|---|---|
| h:33 / cpp:71 | `void showEvent(QShowEvent *)` — populates UI labels, calls `screensaverOff()` |
| h:34 / cpp:113 | `void hideEvent(QHideEvent *)` — sets `m_showCamera = false`, calls `updateCamera()` |

**Private methods:**

| Line | Method |
|---|---|
| h:43 / cpp:148 | `bool debounce()` — 200 ms debounce on button presses |
| h:44 / cpp:120 | `void screensaverOff()` — hides screensaver button; starts 5 s timer for `screensaverOn()` if config active |
| h:45 / cpp:138 | `void screensaverPressed()` — debounces press, disables button, fires `screensaverOff()` after 200 ms |
| h:46 / cpp:50 | `void onButtonConfirmStart()` — opens `OptionalCheckConfirmationDialog` |
| h:47 / cpp:130 | `void screensaverOn()` — shows screensaver button, calls `updateCamera()` |
| h:48 / cpp:188 | `void setCamera(bool on, bool flip)` — writes directly to `/sys/class/gpio/gpio37/value` and `/sys/class/gpio/gpio39/value` |

**Private slots:**

| Line | Slot |
|---|---|
| h:54 / cpp:172 | `void rstLogout()` — resets `m_lastPress` and restores logout button text |
| h:55 / cpp:156 | `void onLogoutRequest()` — two-press confirm pattern; emits `userLogout()` and calls `reject()` on second press |

**UNIT_TEST friend:** `friend class TestDialog` when `UNIT_TEST` is defined (h:26-27).

---

### BroadcastUIDialog (`ui/broadcastuidialog.h` / `.cpp`)

**Class:** `BroadcastUIDialog : public QDialog`

**Includes:**
- `broadcastuidialog.h`
- `ui_broadcastuidialog.h`
- `app/cigconfigs.h`
- `<QDialog>`, `<QTimer>`

**Public enum:**

| Line | Values |
|---|---|
| h:17 | `enum MessageResult { MsgResultOK, MsgResultYes, MsgResultNo, MsgResultTimeout, MsgResultLogout, MsgResultNoDriver }` |

**Public methods:**

| Line | Method |
|---|---|
| h:19 / cpp:4 | `explicit BroadcastUIDialog(QWidget *parent = nullptr)` — constructor; connects buttons and timer |
| h:20 / cpp:19 | `~BroadcastUIDialog()` — destructor |
| h:22 / cpp:24 | `void setUIParam(CIGCONF::BroadcastMessage m)` — populates text (truncated to 100 chars), toggles warning label, shows Yes/No or OK button, starts optional timer |

**Signals:**

| Line | Signal |
|---|---|
| h:25 | `void messageClosed(CIGCONF::BroadcastMessage m)` — declared but **never emitted** in the implementation |

**Private slots:**

| Line | Slot |
|---|---|
| h:32 / cpp:48 | `void onYes()` — stops timer, emits `done(MsgResultYes)` |
| h:33 / cpp:54 | `void onNo()` — stops timer, emits `done(MsgResultNo)` |
| h:34 / cpp:60 | `void onOK()` — stops timer, emits `done(MsgResultOK)` |

**Note on `done` signal:** The slots emit `done(int)` which is `QDialog::finished(int)` inherited from `QDialog`. `dialog.cpp:133` connects `BroadcastUIDialog::finished` (the `QDialog` signal) to `Dialog::onBroadcastDialogDone`. The declared `messageClosed` signal is unused dead code.

---

## Test Coverage Analysis

### Test file structure

`test/test_dialog.h` declares six test slots:
- `test_enums()`
- `test_globalConfigs()`
- `test_idleLockout()`
- `test_showPreopSummary()`
- `test_unlockMode1()`
- `test_showTime()`

**`AmberImpactAlertDialog` is never mentioned in any test file** (grep across all `.cpp`/`.h` in `test/` found zero matches).

**`BroadcastUIDialog` is never mentioned in any test file** (grep across all `.cpp`/`.h` in `test/` found zero matches).

**`AuthorisedDialog`** is exercised indirectly through `m_dialog->m_authorisedDialog->isVisible()` checks and one direct method call (`screensaverOn()` at line 613). No dedicated construction test, no signal spy for `userLogout()`, no direct method-level tests for `setHasChecklist`, `setDriverId`, `setTime`, `setPower`, `updateCamera`, `closeWindow`, `debounce`, `onLogoutRequest`, or `rstLogout`.

---

## Findings

---

**A18-1** · HIGH · Missing Tests — Zero Coverage
**File:** `ui/amberimpactalertdialog.cpp:1` / `ui/amberimpactalertdialog.h:1`
**Description:** `AmberImpactAlertDialog` has no test coverage whatsoever. The class is not referenced in any file under `test/`. None of the following are tested: construction with null vs valid parent; `isOpen()` state machine; `closeWindow()` guard (calling when `dialogOpenFlag == false` vs `true`); `languageChanged()` label updates; `mouseReleaseEvent()` triggering close; `showEvent()` guard against double-open when `amberImpactAlertActive()` is false; `amberAlertDialogShowEvent()` behaviour when `isLocked == true` vs `false`.
**Fix:** Add a `TestAmberImpactAlertDialog` test class (or extend `TestDialog`). At minimum: (1) construct with `nullptr` parent; (2) verify `isOpen()` is `false` before show; (3) call `amberAlertDialogShowEvent(true)` and verify `exec()` is not called (i.e., `isOpen()` remains `false`); (4) mock `gCfg->amberImpactAlertActive()` to return `true`, call `amberAlertDialogShowEvent(false)`, verify `isOpen()` becomes `true`; (5) call `closeWindow()` and verify `isOpen()` returns `false`; (6) call `closeWindow()` again and verify no crash (double-close guard); (7) call `languageChanged()` and verify label text.

---

**A18-2** · HIGH · Missing Tests — Zero Coverage
**File:** `ui/broadcastuidialog.cpp:1` / `ui/broadcastuidialog.h:1`
**Description:** `BroadcastUIDialog` has no test coverage whatsoever. The class is not referenced in any file under `test/`. None of the following are tested: construction; `setUIParam()` with `res == 0` (OK button path) vs `res != 0` (Yes/No path); `setUIParam()` with `type == 0` (no warning) vs `type != 0` (warning label); text truncation to `BROADCASTMSG_TEXT_LEN` (100 chars); `onYes()`, `onNo()`, `onOK()` signal emission (all emit `done(int)` = `QDialog::finished`); timer-based `MsgResultTimeout` emission when `timeout > 0`; timer stop when button pressed before timeout.
**Fix:** Add a `TestBroadcastUIDialog` test class. At minimum: (1) construct with `nullptr` parent; (2) call `setUIParam` with `res=0, type=0, timeout=0` and verify OK button visible, Yes/No hidden, warning hidden; (3) `setUIParam` with `res=1, type=1` and verify Yes/No visible, OK hidden, warning visible; (4) use `QSignalSpy` on `finished(int)` to verify `MsgResultOK`, `MsgResultYes`, `MsgResultNo` each emitted correctly; (5) `setUIParam` with `text` longer than 100 characters and verify `pEditMsgBox` contains only 100 characters; (6) `setUIParam` with `timeout=1`, wait >1000 ms, verify `MsgResultTimeout` emitted via spy; (7) press a button before timeout expires and verify timer stopped (no subsequent `MsgResultTimeout`).

---

**A18-3** · HIGH · Missing Tests — Signal Not Tested
**File:** `ui/authoriseddialog.cpp:162` / `ui/authoriseddialog.h:30`
**Description:** The `userLogout()` signal emitted by `onLogoutRequest()` is never captured by a `QSignalSpy` in any test. The logout two-press confirmation flow (`onLogoutRequest()` first press changes button text to "Confirm?", second press emits `userLogout()` and calls `reject()`) is not tested at all. The `rstLogout()` timer reset path (which resets button text after 2000 ms if second press does not come) is also untested.
**Fix:** Add a test case that: (1) constructs or reuses `AuthorisedDialog`; (2) attaches `QSignalSpy` to `userLogout()`; (3) calls `onLogoutRequest()` once and verifies spy count is 0 and button text becomes "Confirm?"; (4) calls `onLogoutRequest()` again within the debounce window (artificially advance `m_lastPress`) and verifies spy count is 1; (5) tests the `rstLogout()` path by calling `onLogoutRequest()` once and then waiting 2100 ms or calling `rstLogout()` directly and verifying button text reverts to "Logout".

---

**A18-4** · MEDIUM · Missing Tests — Public API Not Tested
**File:** `ui/authoriseddialog.cpp:56` / `ui/authoriseddialog.h:19`
**Description:** `setHasChecklist(bool yes)` is never called in any test. This method controls visibility of `btnStart` and `labelStart`. There is no test verifying that `btnStart` is hidden when `yes == false` or shown when `yes == true`.
**Fix:** Add assertions that call `setHasChecklist(false)` and verify `btnStart->isVisible() == false`, then `setHasChecklist(true)` and verify `btnStart->isVisible() == true`. This is straightforward UI state verification.

---

**A18-5** · MEDIUM · Missing Tests — Public API Not Tested
**File:** `ui/authoriseddialog.cpp:67` / `ui/authoriseddialog.h:20`
**Description:** `setDriverId(quint64 id)` is never called directly in tests. The method stores `m_pendingDriverId` which is subsequently used in `showEvent()` to look up and display the driver name via `gCfg->getDriverName()`. The name-display branch (lines 78–97) and the no-name branch (lines 89–97) in `showEvent()` are never exercised independently in the test suite.
**Fix:** Add tests that: (1) call `setDriverId(knownId)` and trigger `showEvent()` with `gCfg->showDriverName()` returning `true` and a non-empty name — verify `lblDriverName` is visible; (2) call `setDriverId(0)` or use an ID returning an empty name — verify `lblDriverName` is hidden.

---

**A18-6** · MEDIUM · Missing Tests — Camera Control Not Tested
**File:** `ui/authoriseddialog.cpp:217` / `ui/authoriseddialog.h:23`
**Description:** `updateCamera()` and `setCamera()` are not tested. `setCamera()` writes directly to hardware GPIO sysfs paths (`/sys/class/gpio/gpio37/value`, `/sys/class/gpio/gpio39/value`). `updateCamera()` has four distinct branches: `CameraForced`, `CameraOff`, camera on with power and screensaver state. None of these branches are verified. The `setPower(bool on)` method, which gates camera output, is also never called in tests.
**Fix:** The sysfs writes make direct unit testing of `setCamera()` impractical on non-target hardware, but `updateCamera()` can be tested by mocking `gCfg` camera mode. At minimum: (1) override camera mode to `CameraForced` and call `updateCamera()` — verify no crash; (2) set `CameraOff` and call `updateCamera()`; (3) call `setPower(false)` and verify camera is disabled. Long-term, `setCamera()` should be extracted to a hardware abstraction layer injectable for testing.

---

**A18-7** · MEDIUM · Missing Tests — Debounce Logic Not Tested
**File:** `ui/authoriseddialog.cpp:148` / `ui/authoriseddialog.h:43`
**Description:** The `debounce()` method (200 ms guard on button actions) is declared `private` and never exercised in tests. When `debounce()` returns `false`, `onLogoutRequest()` silently returns without action. There is no test verifying that a second rapid call to `onLogoutRequest()` within 200 ms is suppressed.
**Fix:** Using the `UNIT_TEST` friend relationship (`friend class TestDialog`), add a test that: (1) calls `onLogoutRequest()` at time T; (2) immediately calls it again at T+50 ms; (3) verifies the button text did not transition to "Confirm?" on the second call (debounce suppressed it).

---

**A18-8** · MEDIUM · Dead Code / Missing Tests — Unused Signal
**File:** `ui/broadcastuidialog.h:25` / `ui/broadcastuidialog.cpp`
**Description:** `BroadcastUIDialog` declares a signal `void messageClosed(CIGCONF::BroadcastMessage m)` at header line 25. This signal is **never emitted** anywhere in `broadcastuidialog.cpp` or any other file in the repository. The button slots (`onYes`, `onNo`, `onOK`) and the timer lambda all emit `done(int)` (the inherited `QDialog::finished` signal) rather than `messageClosed`. This dead signal is misleading: callers who connect to `messageClosed` receive no callbacks.
**Fix:** Either (a) remove `messageClosed` entirely if it is confirmed unused by all callers (verified: `dialog.cpp` connects to `finished`, not `messageClosed`), or (b) emit `messageClosed` with the appropriate `BroadcastMessage` in each slot if the richer data is needed. Add a test with `QSignalSpy` on `messageClosed` to confirm it fires (currently it would fail, making the dead code visible).

---

**A18-9** · LOW · Missing Tests — Edge Case: Empty / Oversized Text
**File:** `ui/broadcastuidialog.cpp:26`
**Description:** `setUIParam()` truncates `m.text` to `BROADCASTMSG_TEXT_LEN` (100 chars) via `m.text.mid(0, 100)`. There is no test verifying that a message with exactly 100 characters passes through untruncated, a message of 101+ characters is truncated, and an empty `text` field produces an empty text box without crashing.
**Fix:** Add parameterised test cases in `TestBroadcastUIDialog`: (1) empty string; (2) string of exactly 100 chars; (3) string of 200 chars — verify `pEditMsgBox->toPlainText().length() == 100`.

---

**A18-10** · LOW · Missing Tests — Edge Case: Null Parent Construction
**File:** `ui/amberimpactalertdialog.cpp:6` / `ui/broadcastuidialog.cpp:4` / `ui/authoriseddialog.cpp:13`
**Description:** All three dialogs declare `QWidget *parent = nullptr` (or `= 0`) as default. None are ever constructed with an explicit `nullptr` parent in unit tests. Qt dialogs exhibit different lifetime and window-management behaviour when constructed without a parent (no implicit destruction when parent destroyed, no centering on parent, different modal behaviour). This edge case is untested for all three.
**Fix:** Add test cases that construct each dialog with an explicit `nullptr` parent, call their primary methods, and verify there is no crash or assertion failure.

---

**A18-11** · LOW · Missing Tests — `languageChanged()` Not Tested
**File:** `ui/amberimpactalertdialog.cpp:19`
**Description:** `AmberImpactAlertDialog::languageChanged()` updates two UI labels. It is never called in tests. If the translation strings are malformed or the label pointers are invalid, no test would catch it.
**Fix:** After constructing the dialog in tests, call `languageChanged()` and verify `ui->label_3->text()` contains "Amber Impact Alert" and `ui->labelTip->text()` is non-empty.

---

## Summary Table

| ID | Severity | Category | Dialog | Finding |
|---|---|---|---|---|
| A18-1 | HIGH | Missing Tests — Zero Coverage | AmberImpactAlertDialog | No tests exist for any method or state |
| A18-2 | HIGH | Missing Tests — Zero Coverage | BroadcastUIDialog | No tests exist for any method or signal |
| A18-3 | HIGH | Missing Tests — Signal Not Tested | AuthorisedDialog | `userLogout` signal and logout two-press flow untested |
| A18-4 | MEDIUM | Missing Tests — Public API Not Tested | AuthorisedDialog | `setHasChecklist()` never called in tests |
| A18-5 | MEDIUM | Missing Tests — Public API Not Tested | AuthorisedDialog | `setDriverId()` / showEvent name-display branches untested |
| A18-6 | MEDIUM | Missing Tests — Camera Control Not Tested | AuthorisedDialog | `updateCamera()`, `setPower()`, `setCamera()` branches untested |
| A18-7 | MEDIUM | Missing Tests — Debounce Logic Not Tested | AuthorisedDialog | `debounce()` suppression behaviour untested |
| A18-8 | MEDIUM | Dead Code / Missing Tests | BroadcastUIDialog | `messageClosed` signal declared but never emitted |
| A18-9 | LOW | Missing Tests — Edge Case | BroadcastUIDialog | Text truncation at boundary (empty / 100 / 101+ chars) untested |
| A18-10 | LOW | Missing Tests — Edge Case | All three | Null-parent construction untested for all three dialogs |
| A18-11 | LOW | Missing Tests — Method Not Called | AmberImpactAlertDialog | `languageChanged()` never called in tests |

**Total findings: 11** (3 HIGH, 5 MEDIUM, 3 LOW)
