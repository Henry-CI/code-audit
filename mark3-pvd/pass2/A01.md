# Pass 2 – Test Coverage Audit
**Agent ID:** A01
**Audit Run:** 2026-02-28-01
**Branch confirmed:** master
**Files assigned:**
- `.gitignore`
- `run_tests`
- `netcfg.json`

---

## Reading Evidence

### 1. `.gitignore`

**Purpose:** Specifies intentionally untracked files that Git should ignore for this repository.

**All entries (line numbers):**

| Line | Rule | Effect |
|------|------|--------|
| 1 | `Makefile` | Ignores the generated `Makefile` (qmake output) |
| 2 | `FleetFocus` | Ignores the compiled test binary produced by `mk3-test.pro` |
| 3 | `.*` | Ignores all dot-files/dot-directories (except those explicitly negated) |
| 5 | `/tmp` | Ignores a top-level `tmp/` directory |
| 7 | `!.gitignore` | Negation — un-ignores `.gitignore` itself (overrides line 3) |
| 8 | `*.bak` | Ignores all backup files |

**Coverage gap observations:**
- `netcfg.json` is NOT listed in `.gitignore`. It is tracked in git and contains plaintext Wi-Fi credentials. There is no rule that would prevent future credential files of the same type from being committed.
- The `.*` wildcard on line 3 would suppress any attempt to add a `.env` or similar secrets file, but it has no bearing on `netcfg.json`.
- No test file in `test/` references `.gitignore`. There are no tests that verify the ignore rules protect sensitive file patterns.

---

### 2. `run_tests`

**Purpose:** Shell convenience script that executes the compiled `FleetFocus` test binary and colorises its output via `awk`.

**All script commands (line numbers):**

| Line | Command / construct | Description |
|------|---------------------|-------------|
| 1 | `#!/bin/sh` | POSIX sh shebang |
| 2 | `./FleetFocus \| awk '...'` | Runs test binary, pipes stdout to awk for colourisation |
| 3 | `/PASS/ {print "\033[32m" $0 "\033[0m"}` | Colours PASS lines green |
| 4 | `/FAIL/ {print "\033[31m" $0 "\033[0m"}` | Colours FAIL lines red |
| 5 | `/DEBUG/ {print $0}` | Passes DEBUG lines through unchanged |
| 6 | `/WARN/ {print $0}` | Passes WARN lines through unchanged |
| 7 | `!/PASS\|FAIL\|DEBUG\|WARN/ {print $0}` | Passes all other lines through unchanged |

**Coverage gap observations:**
- The script exits with the exit code of `awk` (always 0 on normal completion), not the exit code of `FleetFocus`. The pipe `./FleetFocus | awk` causes the shell to lose the test binary's exit code. A CI system invoking `run_tests` would always see exit 0 regardless of test failures.
- There are no tests that exercise or verify `run_tests` itself.
- No CI/CD pipeline configuration file (`.yml`, `.yaml`, Jenkinsfile, Bitbucket pipeline, etc.) was found in the repository. `run_tests` is not integrated into any automated pipeline.
- The `FleetFocus` binary (the target of the script) is not present in the working tree — it is produced at build time and correctly excluded by `.gitignore` line 2. However, the absence of the binary means `run_tests` would silently fail if executed without a prior build step; there is no guard or error message for this case.
- The script has CRLF line endings (`\r\n`) despite the `#!/bin/sh` shebang. On Linux/embedded targets this may cause `run_tests: not found` or syntax errors when the shebang line is parsed with a trailing `\r`.

---

### 3. `netcfg.json`

**Purpose:** Wi-Fi network provisioning configuration. Embedded into the Qt resource bundle (`mk3.qrc`) and listed in DISTFILES in both `mk3.pro` and `mk3-test.pro`. Provides the SSID and pre-shared key for the device's Wi-Fi connection.

**All configuration entries (line numbers):**

| Line | Key | Value |
|------|-----|-------|
| 2 | `password` | `P@ssMK3!` (plaintext Wi-Fi pre-shared key) |
| 3 | `ssid` | `cigSecureConnect` |

**Coverage gap observations:**
- No test file in `test/` references `netcfg.json`, its keys (`password`, `ssid`), or its values. There are zero tests for the parsing, loading, validation, or application of this file's contents.
- The file has been present in git history since commit `5fdc821` and was updated in commit `2adcd83`. Both commits embed the same plaintext credential.
- There are no tests that verify the credential is not empty, meets a minimum length/complexity policy, or that the JSON is well-formed before use.
- There are no tests that confirm the file is not accessible at runtime to unprivileged processes.

---

## Findings

**A01-1** · HIGH · Test Coverage – Missing test for `run_tests` exit code propagation
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/run_tests:2`
**Description:** The script pipes `./FleetFocus` through `awk` for colourisation. Because the pipeline's exit status is the exit code of `awk` (always 0 on normal exit), any CI invocation of `run_tests` will report success even when all tests fail. The test binary's exit code is silently discarded. There is no test or automated check that verifies the runner correctly signals failure to its caller.
**Fix:** Use `pipefail` (`set -o pipefail` at the top of the script, then change shebang to `#!/bin/bash` or verify the target shell supports it) so the script exits non-zero if `FleetFocus` exits non-zero. Alternatively, capture the exit code manually: run `./FleetFocus > /tmp/test_out 2>&1; rc=$?; awk '...' /tmp/test_out; exit $rc`. Add a smoke test to the CI pipeline that runs `run_tests` with a known-failing binary and asserts exit code is non-zero.

---

**A01-2** · HIGH · Test Coverage – No tests for `netcfg.json` parsing or validation
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/netcfg.json:1`
**Description:** The Wi-Fi provisioning file `netcfg.json` is embedded in the Qt resource bundle and used at runtime, but no test in the `test/` directory references this file, its keys, or the code that reads it. There are no tests verifying the file is valid JSON, that required fields (`ssid`, `password`) are present and non-empty, or that the loaded values are applied correctly to the Wi-Fi subsystem.
**Fix:** Write unit tests (e.g., in `test_dialog.cpp` or a new `test_netcfg.cpp`) that: (1) parse `netcfg.json` and assert the required keys exist and are non-empty strings; (2) test the consumer code (wifi configuration logic) with valid and invalid inputs; (3) assert graceful failure when the file is absent or malformed.

---

**A01-3** · MEDIUM · Test Coverage – `netcfg.json` not excluded from version control; no `.gitignore` rule protects secrets files
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/.gitignore:1`
**Description:** `netcfg.json` contains a plaintext Wi-Fi password and is committed to the repository (tracked since `5fdc821`). The `.gitignore` file contains no rule that would prevent credential or secrets files (e.g., `*.json`, `netcfg.json`, `*.secret`) from being committed. There are no tests or pre-commit hooks that scan for secrets before they enter the repository. All git hooks in `.git/hooks/` are `.sample` files only — none are active.
**Fix:** (1) Remove `netcfg.json` from version control with `git rm --cached netcfg.json` and add `netcfg.json` (or `*cfg.json`) to `.gitignore`. (2) Add a pre-commit hook (e.g., using `detect-secrets` or `git-secrets`) to block credential patterns from being committed. (3) Rotate the exposed credential `P@ssMK3!` immediately as it is now in git history on a shared remote.

---

**A01-4** · MEDIUM · Test Coverage – `run_tests` has CRLF line endings; no cross-platform execution test
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/run_tests:1`
**Description:** Despite having a `#!/bin/sh` shebang and being a POSIX shell script, `run_tests` has Windows CRLF (`\r\n`) line endings. On Linux or embedded targets (where the device firmware runs), executing this script will result in a `bad interpreter: /bin/sh\r: no such file or directory` error or similar, making the test runner completely non-functional on the target platform. There is no test or CI check verifying the script executes successfully on the deployment platform.
**Fix:** Convert the file to Unix LF line endings: `dos2unix run_tests` or `sed -i 's/\r//' run_tests`. Add a `.gitattributes` rule (`run_tests text eol=lf`) to enforce LF line endings for this file in all future checkouts. Add a CI step that runs `run_tests` on a Linux host to confirm it executes without error.

---

**A01-5** · LOW · Test Coverage – No guard in `run_tests` for missing `FleetFocus` binary
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/run_tests:2`
**Description:** The script unconditionally executes `./FleetFocus` without first checking that the binary exists. If the repository has not been built, the script fails with a shell error message but no informative guidance. The `FleetFocus` binary is not present in the working tree (it is `.gitignore`-excluded). There is no test that validates the precondition check.
**Fix:** Add a pre-execution guard at the top of the script:
```sh
if [ ! -x ./FleetFocus ]; then
    echo "ERROR: FleetFocus binary not found. Run 'make -f Makefile.test' first." >&2
    exit 1
fi
```

---

**A01-6** · LOW · Test Coverage – No tests for `.gitignore` rule correctness
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/.gitignore:1`
**Description:** The `.gitignore` rules (including the negation `!.gitignore` and the broad `.*` pattern) are not tested. There is no automated check that verifies the ignore rules correctly exclude build artifacts and do not accidentally ignore required source files. The broad `.*` rule on line 3 suppresses all dot-files, which could silently hide untracked configuration files from `git status`.
**Fix:** Add a CI step that runs `git status --short` after a clean build and asserts that no unexpected files appear as untracked. Consider using a tool such as `git check-ignore` in a test script to validate that key build artifacts (`Makefile`, `FleetFocus`) are ignored and that source files are not.

---

**A01-7** · INFO · Test Coverage – No CI/CD pipeline configuration found
**File:** `C:/Projects/cig-audit/repos/mark3-pvd/run_tests:1`
**Description:** No CI/CD pipeline configuration file was found in the repository (no `.yml`/`.yaml` pipeline files, no Jenkinsfile, no Bitbucket Pipelines config). The `run_tests` script exists as a manual convenience wrapper with no automated invocation. This means tests are only run when a developer manually executes the script, providing no safety net against regressions on merge.
**Fix:** Add a CI pipeline configuration (e.g., `bitbucket-pipelines.yml` for Bitbucket, which is where this repository appears to be hosted based on commit merge messages). The pipeline should build the test binary (`make -f Makefile.test`) and then invoke `run_tests` (after fixing the exit code and line ending issues noted above), failing the build if any test fails.

---

## Summary Table

| ID | Severity | Category | File | Description |
|----|----------|----------|------|-------------|
| A01-1 | HIGH | Test Coverage | `run_tests:2` | Exit code of `FleetFocus` silently discarded by pipe to `awk`; CI always sees success |
| A01-2 | HIGH | Test Coverage | `netcfg.json:1` | No tests for JSON parsing, field validation, or Wi-Fi config application |
| A01-3 | MEDIUM | Test Coverage | `.gitignore:1` | No `.gitignore` rule guards against secrets files; no active pre-commit hooks |
| A01-4 | MEDIUM | Test Coverage | `run_tests:1` | CRLF line endings break execution on Linux/embedded targets; no platform test |
| A01-5 | LOW | Test Coverage | `run_tests:2` | No guard for missing `FleetFocus` binary before execution |
| A01-6 | LOW | Test Coverage | `.gitignore:1` | No automated tests verify `.gitignore` rule correctness |
| A01-7 | INFO | Test Coverage | `run_tests:1` | No CI/CD pipeline configuration found in repository |

**Total findings: 7** (2 HIGH, 2 MEDIUM, 2 LOW, 1 INFO)
