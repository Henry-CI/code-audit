# Audit Report – Agent A02 (Test Coverage)

**Agent ID:** A02
**Audit Run:** 2026-02-28-01
**Pass:** 2 – Test Coverage
**Files Assigned:** `mk3.pro`, `mk3-test.pro`
**Branch Confirmed:** `master` (verified via `git branch --show-current`)
**Date:** 2026-02-28

---

## Reading Evidence

### File 1: `mk3.pro`

**Purpose:** Production Qt project file. Defines the FleetFocus application build for the mark3-pvd embedded platform. Pulls in all production source, header, form, and resource files.

#### SOURCES entries (mk3.pro)

| Line | File |
|------|------|
| 39 | `main.cpp` |
| 40 | `mytranslator.cpp` |
| 41 | `platform/internalrfid.cpp` |
| 42 | `platform/wiegandrfid.cpp` |
| 43 | `platform/pwmbeeper.cpp` |
| 44 | `platform/pwmbacklight.cpp` |
| 45 | `platform/internalrtc.cpp` |
| 46 | `platform/powersupply.cpp` |
| 47 | `platform/blecentral.cpp` |
| 48 | `app/globalconfigs.cpp` |
| 49 | `ui/amberimpactalertdialog.cpp` |
| 50 | `ui/languagedialog.cpp` |
| 51 | `ui/onScreenKeyboard.cpp` |
| 52 | `ui/broadcastuidialog.cpp` |
| 53 | `ui/pindialog.cpp` |
| 54 | `ui/authoriseddialog.cpp` |
| 55 | `ui/checkstartdialog.cpp` |
| 56 | `ui/checkquestiondialog.cpp` |
| 57 | `ui/checkconfirmationdialog.cpp` |
| 58 | `ui/checkcompleteddialog.cpp` |
| 59 | `ui/lockeddialog.cpp` |
| 60 | `ui/supervisordialog.cpp` |
| 61 | `ui/unlockeddialog.cpp` |
| 62 | `ui/warningdialog.cpp` |
| 63 | `utils/logger.cpp` |
| 64 | `platform/canbus.cpp` |
| 65 | `app/checklist.cpp` |
| 66 | `app/driverlist.cpp` |
| 67 | `app/crctable.cpp` |
| 68 | `platform/gnssreceiver.cpp` |
| 69 | `comm/canmonitor.cpp` |
| 70 | `comm/canstatehandler.cpp` |
| 71 | `comm/bleexpansion.cpp` |
| 72 | `comm/bleexpansionuuid.cpp` |
| 73 | `comm/bleinputhandler.cpp` |
| 74 | `platform/modemport.cpp` |
| 75 | `comm/modemchat.cpp` |
| 76 | `app/backgroundworker.cpp` |
| 77 | `platform/userport.cpp` |
| 78 | `comm/gmtpchat.cpp` |
| 79 | `comm/ntpsync.cpp` |
| 80 | `ui/messagedialog.cpp` |
| 81 | `ui/dialog.cpp` |
| 82 | `comm/ftpclient.cpp` |
| 83 | `platform/seriallogger.cpp` |
| 84 | `platform/aescrypto.cpp` |
| 85 | `comm/canexpansion.cpp` |
| 86 | `ui/keyfilter.cpp` |
| 87 | `ui/informationdialog.cpp` |
| 88 | `utils/barcode128.cpp` |
| 89 | `ui/ondemanddialog.cpp` |
| 90 | `ui/optionalcheckconfirmationdialog.cpp` |
| 91 | `platform/wifi.cpp` |
| 92 | `ui/vorwarningdialog.cpp` |
| 93 | `ui/vorconfirmationdialog.cpp` |
| 94 | `ui/commentdialog.cpp` |
| 95 | `ui/preopscreenoverlay.cpp` |
| 96 | `ui/unlockreasondialog.cpp` |

**Total production SOURCES: 57** (including `main.cpp`)

#### HEADERS entries (mk3.pro) — selected notable items

| Line | File | Note |
|------|------|------|
| 99 | `mytranslator.h` | |
| 100–157 | (all platform/ui/app/comm/utils headers) | Full list in file |
| 122 | `utils/logger.h` | **Duplicate** – also listed at line 112 |

#### DEFINES entries (mk3.pro)

| Line | Define |
|------|--------|
| 6 | `TEST_MODE=0` |
| 30 | `QT_DEPRECATED_WARNINGS` |

#### LIBS / INCLUDEPATH entries (mk3.pro)

| Line | Entry |
|------|-------|
| 13 | `INCLUDEPATH += ../sdk/kernel_include` (linux only) |
| 14 | `INCLUDEPATH += ../sdk/3rd/include` (linux only) |
| 15 | `LIBS += -L../sdk/3rd/lib` (linux only) |

#### QT modules (mk3.pro)

```
core gui serialport serialbus bluetooth network
```
(line 8); `widgets` added conditionally at line 10.

---

### File 2: `mk3-test.pro`

**Purpose:** Qt test project file. Mirrors the production build and adds the four Qt Test suite source files plus the `UNIT_TEST` define and the `testlib` Qt module.

#### SOURCES entries (mk3-test.pro)

| Line | File | Classification |
|------|------|----------------|
| 40 | `test/test_ota.cpp` | Test source |
| 41 | `test/test_dialog.cpp` | Test source |
| 42 | `test/test_backgroundworker.cpp` | Test source (contains `main()`) |
| 43 | `test/test_canbus.cpp` | Test source |
| 44–100 | (identical to mk3.pro lines 40–96, minus `main.cpp`) | Production sources |

`main.cpp` is **absent** from mk3-test.pro SOURCES. The test harness main() lives in `test/test_backgroundworker.cpp` lines 359–387.

#### HEADERS entries (mk3-test.pro)

| Line | File | Classification |
|------|------|----------------|
| 103 | `test/test_ota.h` | Test header |
| 104 | `test/test_dialog.h` | Test header |
| 105 | `test/test_backgroundworker.h` | Test header |
| 106 | `test/test_canbus.h` | Test header |
| 107–165 | (identical to mk3.pro HEADERS) | Production headers |
| 130 | `utils/logger.h` | **Duplicate** – also at line 120 (same as mk3.pro) |

#### DEFINES entries (mk3-test.pro)

| Line | Define | In mk3.pro? |
|------|--------|-------------|
| 6 | `TEST_MODE=0` | Yes |
| 7 | `UNIT_TEST` | **No – test-only** |
| 31 | `QT_DEPRECATED_WARNINGS` | Yes |

#### LIBS / INCLUDEPATH entries (mk3-test.pro)

| Line | Entry |
|------|-------|
| 14 | `INCLUDEPATH += ../sdk/kernel_include` (linux only) |
| 15 | `INCLUDEPATH += ../sdk/3rd/include` (linux only) |
| 16 | `LIBS += -L../sdk/3rd/lib` (linux only) |

#### QT modules (mk3-test.pro)

```
core gui serialport serialbus bluetooth network testlib
```
(line 9); `widgets` added conditionally at line 11.

---

### Test directory contents

Files found in `C:/Projects/cig-audit/repos/mark3-pvd/test/`:

```
test_backgroundworker.cpp / .h
test_canbus.cpp / .h
test_dialog.cpp / .h
test_ota.cpp / .h
FleetIQ360App_5.2.2F.h        (OTA firmware blob for test_ota)
```

No `.pro` or build configuration fragments were found in the test directory. All build configuration is consolidated in `mk3-test.pro`.

### Test methods identified

| Test class | Methods |
|------------|---------|
| `TestBackgroundWorker` | `test_cmdIddeny`, `test_cmdIdlelock`, `test_cmdUnlkmode`, `test_cmdShowtime`, `test_cmdChktsum`, `test_cmdVdimode`, `test_cmdCamera`, `test_cmdCameraFlip` |
| `TestDialog` | `test_enums`, `test_globalConfigs`, `test_idleLockout`, `test_showPreopSummary`, `test_unlockMode1`, `test_showTime` |
| `TestCanbus` | `test_vdiMode` |
| `TestOta` | `test_unpack` |

---

## Findings

---

**A02-1** · HIGH · Coverage Gap – `main.cpp` excluded from test build
**File:** `mk3-test.pro`:39–43 / `mk3.pro`:39
**Description:** `main.cpp` is the application entry point and is listed in mk3.pro SOURCES (line 39) but is deliberately omitted from mk3-test.pro. The test project replaces it with an inline `main()` at `test/test_backgroundworker.cpp:359`. This means application startup logic in `main.cpp` – including any early initialisation, command-line argument handling, QApplication construction options, and platform setup – is never exercised by the test suite. Any bugs in startup sequencing (e.g. Qt::AA_Use96Dpi ARM path, resource initialisation order) are completely invisible to automated testing.
**Fix:** Extract startup logic from `main.cpp` into a testable `AppInit` function or class. Add a `TestMain` test case in mk3-test.pro that verifies the initialisation path. At minimum, document the deliberate exclusion with a comment in mk3-test.pro so auditors can verify the omission is intentional.

---

**A02-2** · HIGH · Coverage Gap – `app/crctable.cpp` has no associated header and is untested
**File:** `mk3.pro`:67 / `mk3-test.pro`:71
**Description:** `app/crctable.cpp` is included in both project files but there is no corresponding `app/crctable.h` in either HEADERS list and no header file exists on disk. No test method in any of the four test classes directly invokes CRC table functions. The CRC logic is safety-relevant: it is used for checklist and config integrity. Because it has no header, the implementation is accessed only via internal linkage or via `extern` declarations embedded in callers, making it impossible to unit-test in isolation. The test suite provides no standalone CRC correctness coverage.
**Fix:** Create `app/crctable.h` and add it to both `.pro` HEADERS sections. Write a dedicated `TestCrc` test class covering boundary values, known-good CRC vectors, and error cases. Add the class to the test runner in `test_backgroundworker.cpp`.

---

**A02-3** · HIGH · Coverage Gap – Large surface of platform and comm sources have no direct unit tests
**File:** `mk3.pro`:41–96 (platform/ and comm/ sources)
**Description:** The following 30+ production source files are compiled into the test binary but have no dedicated test class and are not directly exercised by any test method:

- `platform/internalrfid.cpp`, `platform/wiegandrfid.cpp`, `platform/pwmbeeper.cpp`, `platform/pwmbacklight.cpp`, `platform/internalrtc.cpp`, `platform/powersupply.cpp`, `platform/blecentral.cpp`, `platform/gnssreceiver.cpp`, `platform/modemport.cpp`, `platform/userport.cpp`, `platform/seriallogger.cpp`, `platform/aescrypto.cpp`, `platform/wifi.cpp`
- `comm/bleexpansion.cpp`, `comm/bleexpansionuuid.cpp`, `comm/bleinputhandler.cpp`, `comm/modemchat.cpp`, `comm/gmtpchat.cpp`, `comm/ntpsync.cpp`, `comm/ftpclient.cpp`, `comm/canexpansion.cpp`
- `utils/logger.cpp`, `utils/barcode128.cpp`
- `mytranslator.cpp`

These are included for compilation completeness (so that the linked test binary matches the production binary's symbol set) but no test case calls into them. Security-sensitive modules such as `platform/aescrypto.cpp` (encryption), `comm/ftpclient.cpp` (file transfer), and `comm/ntpsync.cpp` (time synchronisation) have zero test coverage. `utils/barcode128.cpp` contains a pure-function barcode encoder that is trivially unit-testable yet is untested.
**Fix:** At minimum add unit tests for `platform/aescrypto.cpp` (encrypt/decrypt round-trip, key length edge cases), `utils/barcode128.cpp` (known barcode vectors), and `comm/ntpsync.cpp` (timestamp parsing). Flag remaining platform HAL files for hardware-in-the-loop or mock-based coverage.

---

**A02-4** · MEDIUM · Coverage Gap – UI source files included but only partially exercised through integration-style tests
**File:** `mk3.pro`:49–96 (ui/ sources) / `mk3-test.pro`:53–100
**Description:** All 23 UI source files are compiled into the test project. The test suite exercises several dialogs (Dialog, AuthorisedDialog, LockedDialog, CheckStartDialog, CheckQuestionDialog, CheckCompletedDialog, SupervisorDialog, UnlockedDialog) through `TestDialog`. However, the following dialog implementations are compiled but never instantiated or tested:

- `ui/amberimpactalertdialog.cpp`
- `ui/languagedialog.cpp`
- `ui/onScreenKeyboard.cpp`
- `ui/broadcastuidialog.cpp`
- `ui/pindialog.cpp`
- `ui/warningdialog.cpp`
- `ui/messagedialog.cpp`
- `ui/keyfilter.cpp`
- `ui/informationdialog.cpp`
- `ui/ondemanddialog.cpp`
- `ui/optionalcheckconfirmationdialog.cpp`
- `ui/vorwarningdialog.cpp`
- `ui/vorconfirmationdialog.cpp`
- `ui/commentdialog.cpp`
- `ui/preopscreenoverlay.cpp`
- `ui/unlockreasondialog.cpp`

This includes safety-relevant dialogs (`vorwarningdialog`, `amberimpactalertdialog`, `unlockreasondialog`) and the PIN entry dialog (`pindialog`).
**Fix:** Add targeted test cases for the VOR warning and amber impact alert dialogs (state machine coverage). Add a `TestPinDialog` test verifying PIN validation logic. At minimum add `show()`/`hide()` smoke tests for each untested dialog to catch regression crashes.

---

**A02-5** · MEDIUM · `TestCanbus` has only a single test method for a complex multi-class subsystem
**File:** `test/test_canbus.cpp`:73 / `test/test_canbus.h`:15
**Description:** The CAN subsystem spans four production files: `platform/canbus.cpp`, `comm/canmonitor.cpp`, `comm/canstatehandler.cpp`, and `comm/canexpansion.cpp`. `TestCanbus` contains exactly one test method (`test_vdiMode`) that verifies CAN rule configuration in VDI mode. There is no coverage for: CAN frame parsing, canstatehandler state machine transitions, canexpansion message handling, error/timeout paths, or the second CAN bus (the test calls `initialiseCanbus1()` and `initialiseCanbus2()` but only reads `m_canBus1`). CAN communication failures are a known safety vector on vehicle-mounted devices.
**Fix:** Add test methods covering `CanStateHandler` state transitions, `CanExpansion` message parsing, `CanBus` error-frame handling, and multi-bus (canBus2) request validation.

---

**A02-6** · MEDIUM · `TestOta` is hardware-path-only and will silently pass/skip on non-Linux/non-ARM hosts
**File:** `test/test_ota.cpp`:53–55, 67
**Description:** `TestOta::init()` removes hardcoded Linux filesystem paths (`/home/FleetFocusTemp`, `/home/FleetFocusOTA`, `/mnt/sd/FleetIQ360App`). `test_unpack()` writes to `/mnt/sd/FleetIQ360App` and expects decompressed output at `/home/FleetFocusOTA`. On a Windows build host these paths either silently resolve to incorrect locations or fail the `QFile::open()` with no test assertion checking the return value of `QFile::remove()`. The firmware blob is embedded from `test/FleetIQ360App_5.2.2F.h` (only found in the test directory, not the production project). The OTA test is therefore platform-specific but has no compile-time or runtime guard to skip gracefully on non-Linux systems.
**Fix:** Wrap OTA tests with `#ifdef Q_OS_LINUX` or use `QSKIP` with a runtime `QSysInfo::productType()` check. Use `QTemporaryDir` and `QTemporaryFile` for path independence. Add a `QVERIFY(file.open(...))` assertion before writing the firmware blob.

---

**A02-7** · MEDIUM · Duplicate `utils/logger.h` entry in both project files
**File:** `mk3.pro`:112 and 122 / `mk3-test.pro`:120 and 130
**Description:** `utils/logger.h` appears twice in the HEADERS list of both `mk3.pro` (lines 112 and 122) and `mk3-test.pro` (lines 120 and 130). While qmake silently deduplicates header entries during MOC processing, the duplication is a maintenance hazard: it indicates a copy-paste error, makes the file harder to audit, and could produce duplicate MOC output in some qmake versions, causing linker errors if the header ever gains Q_OBJECT.
**Fix:** Remove one of the duplicate `utils/logger.h` lines from both project files.

---

**A02-8** · LOW · `UNIT_TEST` define present in mk3-test.pro has no confirmed counterpart guards in production code
**File:** `mk3-test.pro`:7
**Description:** `mk3-test.pro` adds `DEFINES += UNIT_TEST` (line 7) but `mk3.pro` does not define it. This define is typically used to stub out hardware-dependent code paths (e.g. `#ifdef UNIT_TEST ... #endif`). The test project sets `TEST_MODE=0` identically to production (both line 6 in their respective files), meaning `TEST_MODE` provides no differentiation. If `UNIT_TEST` is not consistently guarded across all platform HAL files, hardware initialisation code may execute in the test environment and cause non-deterministic failures. If it is not used at all, the define is dead and misleading.
**Fix:** Grep for `UNIT_TEST` usage across all source files. Where hardware calls occur unconditionally, wrap them with `#ifndef UNIT_TEST` guards or use dependency injection/mock interfaces. If the define is unused, remove it to reduce confusion.

---

**A02-9** · LOW · `TEST_MODE=0` is identical in both project files – the flag is non-functional
**File:** `mk3.pro`:6 / `mk3-test.pro`:6
**Description:** Both project files set `DEFINES += "TEST_MODE=0"`. If `TEST_MODE` was intended to enable/disable test-only code paths (e.g. `#if TEST_MODE`), setting it to `0` in both projects means it never activates test behaviour. The define appears to have been added for future use but never wired up, providing no coverage differentiation between test and production builds.
**Fix:** Either set `TEST_MODE=1` in mk3-test.pro and add appropriate guards in source where needed, or remove the define from both files and rely solely on `UNIT_TEST`.

---

**A02-10** · LOW · No coverage runner or CI invocation script references either `.pro` file
**File:** `mk3-test.pro` (general)
**Description:** Neither project file references a CI pipeline script, Makefile target, or test runner script. There is no evidence of automated test execution (no `.gitlab-ci.yml`, no `Jenkinsfile`, no `CMakeLists.txt` wrapping the test project). Without a CI gate the test project may not be compiled or run regularly, making all coverage gaps more severe in practice.
**Fix:** Add a CI pipeline step that builds `mk3-test.pro` and invokes the resulting test binary with `-o result.xml,xunitxml`. Enforce a failing build if any `TestXxx` method reports failure.

---

## Summary Table

| ID | Severity | Category | Short Description |
|----|----------|----------|-------------------|
| A02-1 | HIGH | Coverage Gap | `main.cpp` excluded from test build; startup logic untested |
| A02-2 | HIGH | Coverage Gap | `app/crctable.cpp` has no header and no direct unit tests |
| A02-3 | HIGH | Coverage Gap | 30+ platform/comm/utils sources compiled but never directly tested |
| A02-4 | MEDIUM | Coverage Gap | 16 UI dialog sources compiled but not tested, including safety dialogs |
| A02-5 | MEDIUM | Coverage Gap | CAN subsystem has only one test method for four source files |
| A02-6 | MEDIUM | Test Quality | OTA test uses hardcoded Linux paths; silently broken on non-Linux hosts |
| A02-7 | MEDIUM | Project Hygiene | `utils/logger.h` duplicated in HEADERS of both project files |
| A02-8 | LOW | Build Config | `UNIT_TEST` define in mk3-test.pro lacks verified usage across source files |
| A02-9 | LOW | Build Config | `TEST_MODE=0` identical in both files; define provides no differentiation |
| A02-10 | LOW | Process | No CI invocation evidence; test suite may not run regularly |

**Overall assessment:** The test project correctly mirrors the production source surface (57 production sources compiled, minus `main.cpp`, plus 4 test sources). However, only 4 of the 56 compiled production modules (`backgroundworker`, `dialog`, `canbus`/`canmonitor`, and indirectly the OTA path in `backgroundworker`) have any meaningful direct test method coverage. The remaining 52+ modules are compiled for linkage completeness only. Critical security-adjacent modules (`aescrypto`, `ftpclient`, `crctable`) have zero test coverage.
