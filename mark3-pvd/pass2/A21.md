# Audit Report — Agent A21 — Pass 2: Test Coverage

**Agent:** A21
**Audit run:** 2026-02-28-01
**Branch confirmed:** master (verified via `git branch --show-current`)
**Date:** 2026-02-28
**Pass:** 2 — Test Coverage

---

## Files Under Audit

| # | Source file | Header |
|---|-------------|--------|
| 1 | `ui/informationdialog.cpp` | `ui/informationdialog.h` |
| 2 | `ui/keyfilter.cpp` | `ui/keyfilter.h` |
| 3 | `ui/languagedialog.cpp` | `ui/languagedialog.h` |

**Primary test file read:** `test/test_dialog.cpp` + `test/test_dialog.h`
**Additional test files searched:** `test/test_backgroundworker.cpp/.h`, `test/test_canbus.cpp/.h`, `test/test_ota.cpp/.h`

---

## Step 4 — Reading Evidence

### 4.1 `ui/informationdialog.h` / `ui/informationdialog.cpp`

**Includes (h):** `<QDialog>`, `<QMap>`, `<QString>`, `<QByteArray>`, `<QObject>`, `<QLabel>`, `<QTimer>`

**Includes (cpp):** `informationdialog.h`, `ui_informationdialog.h`, `app/globalconfigs.h`, `utils/barcode128.h`, `<QBluetoothAddress>`, `<QProcess>`, `<QFile>`

**Class:** `InformationDialog : public QDialog` (h:16) — `Q_OBJECT`

**Public methods:**

| Line (h) | Line (cpp) | Method |
|----------|------------|--------|
| 21 | 11 | `explicit InformationDialog(QWidget *parent = 0)` |
| 22 | 101 | `~InformationDialog()` |
| 23 | 233 | `void updateInformationScreen()` |
| 24 | 106 | `void setLux(int lux)` |
| 25 | 111 | `void setStatus(QByteArray IO, bool Rly1, bool Rly2, QByteArray can, const QByteArray &rssi, const QByteArray &moni, bool netStat, bool mdemStat, bool wifiStat, qint8 sat, qint32 lat, qint32 lon)` |
| 26 | 137 | `void setConfigParam()` |
| 27 | 126 | `void setBatteryStatus(bool avail, int state, int fault, quint16 voltage, qint16 current, quint16 temp, quint16 remainingCapacity)` |
| 28 | 195 | `void setExpModInfo(QByteArray mainVersion)` |
| 29 | 200 | `void setSuperMasterStatus()` |
| 30 | 220 | `void setVOR()` |
| 31 | 228 | `void setLastWiegand(quint64 id)` |
| 32 | 240 | `void languageChanged()` |

**Protected methods:**

| Line (h) | Line (cpp) | Method |
|----------|------------|--------|
| 35 | 89 | `void showEvent(QShowEvent *)` |
| 36 | 94 | `void hideEvent(QHideEvent *)` |

**Signals/Slots:** None declared explicitly. `accept()` connected to `btnHide` click (cpp:38). `updateInformationScreen` connected to `m_updateConfigTmr` timeout (cpp:39).

**Private members:** `Ui::InformationDialog *ui`, `QMap<int,QString> m_chargeStatusMap`, `QMap<int,QString> m_chargeFaultMap`, `QTimer *m_updateConfigTmr`

**Notable constructor behaviour (cpp:11–87):**
- Reads `/proc/version` (cpp:44) and `/home/root_version` (cpp:58) from the filesystem.
- Computes `qChecksum` over a concatenated Latin-1 string and generates a barcode pixmap (cpp:74–76).
- Charge status/fault maps populated with keys 0–3 (cpp:78–86); out-of-range keys return `tr("Unknown")` via `QMap::value` default.

**Notable `showEvent` behaviour (cpp:94–100):** Calls `languageChanged()`, `setConfigParam()`, `setSuperMasterStatus()`, starts 5 000 ms timer.

**Notable `setSuperMasterStatus` behaviour (cpp:200–218):** Unsigned subtraction `end - gCfg->localTimestamp()` at cpp:209 — underflows when session has expired.

**Notable `languageChanged` behaviour (cpp:240–310):** Retranslates all labels; also opens `/sys/class/net/wlan0/address` and sets the WiFi MAC label to `tr("na")` if the file is absent (cpp:306–309) — duplicating logic already in `setConfigParam` (cpp:164–169) with inconsistent fallback behaviour.

---

### 4.2 `ui/keyfilter.h` / `ui/keyfilter.cpp`

**Includes (h):** `<QObject>`, `<QSet>`, `<QTimer>`

**Includes (cpp):** `keyfilter.h`, `<QEvent>`, `<QKeyEvent>`, `<QTimer>`

**Class:** `KeyFilter : public QObject` (h:8) — `Q_OBJECT`

**Public methods:**

| Line (h) | Line (cpp) | Method |
|----------|------------|--------|
| 12 | 8 | `explicit KeyFilter(QObject *parent = nullptr)` |
| 13 | — (inline) | `static bool isPowerKeyPressed()` |

**Signal:**

| Line (h) | Signal |
|----------|--------|
| 16 | `void showInfoDialog()` |

**Protected method:**

| Line (h) | Line (cpp) | Method |
|----------|------------|--------|
| 18 | 20 | `bool eventFilter(QObject *obj, QEvent *event)` |

**Private methods:**

| Line (h) | Line (cpp) | Method |
|----------|------------|--------|
| 34 | 66 | `void resetKeyCount()` |
| 35 | 76 | `void incrementKeyCount(int key)` |
| 36 | 101 | `int getKeyCount(int key)` |
| 37 | 114 | `void resetKeyCounter(int key)` |
| 39 | 126 | `void setPressState(int key, bool state)` |
| 38 | 145 | `bool getPressState(int key)` |

**Private members:** `static bool m_powerKeyPressed`, `QSet<int> m_pressedKeys`, `QTimer *m_timer`, `int m_leftKeyCount`, `int m_rightKeyCount`, `int m_upKeyCount`, `int m_downKeyCount`, `bool m_leftKeyPressed`, `bool m_rightKeyPressed`, `bool m_upKeyPressed`, `bool m_downKeyPressed`

**Constructor initializer list (cpp:8–14):** Initializes `m_timer`, `m_leftKeyCount(0)`, `m_rightKeyCount(0)`, `m_upKeyCount(0)`, `m_downKeyCount(0)`, `m_leftKeyPressed(false)`. Members `m_rightKeyPressed` (h:30), `m_upKeyPressed` (h:31), and `m_downKeyPressed` (h:32) are **absent** from the initializer list and hold indeterminate values until first written.

**`eventFilter` logic (cpp:20–63):**
- Two trigger paths for `showInfoDialog` signal:
  1. Three keys simultaneously: `Key_Left + Key_Up + Key_Down` (cpp:26–30).
  2. Same single arrow key pressed 4 times within 1.5 s (cpp:31–43); `incrementKeyCount` is mutually exclusive — pressing a different arrow resets all other counters (cpp:76–98).
- `Key_Return` press sets `m_powerKeyPressed = true` (cpp:46–47); release sets `false` (cpp:55–56).
- Returns `true` for every `KeyPress` and every `KeyRelease` (cpp:49, 60) — consuming all keyboard events regardless of key code. Non-key events delegated to base class (cpp:63).

---

### 4.3 `ui/languagedialog.h` / `ui/languagedialog.cpp`

**Includes (h):** `<QDialog>`

**Includes (cpp):** `languagedialog.h`, `ui_languagedialog.h`, `app/globalconfigs.h`, `mytranslator.h`, `ui/dialog.h`, `<QTimer>`, `<QLocale>`, `<QDebug>`

**Class:** `LanguageDialog : public QDialog` (h:10) — `Q_OBJECT`

**Public methods:**

| Line (h) | Line (cpp) | Method |
|----------|------------|--------|
| 15 | 12 | `explicit LanguageDialog(QWidget *parent = nullptr)` |
| 16 | 25 | `~LanguageDialog()` |
| 17 | 76 | `void languageChanged()` |
| 18 | 84 | `void startScreenTimeout()` |

**Signal:**

| Line (h) | Signal |
|----------|--------|
| 21 | `void sigLanguageChanged()` |

**Private slots:**

| Line (h) | Line (cpp) | Slot |
|----------|------------|------|
| 24 | 30 | `void on_btnEnglish_clicked()` |
| 25 | 42 | `void on_btnSpanish_clicked()` |
| 26 | 54 | `void on_btnQuit_clicked()` |

**Protected method:**

| Line (h) | Line (cpp) | Method |
|----------|------------|--------|
| 29 | 59 | `void showEvent(QShowEvent *event = 0)` |

**Private members/methods:** `Ui::LanguageDialog *ui`, `QTimer *m_timer`, `bool debounce()` (cpp:65), `quint32 m_lastPress`

**Key logic:**
- Timer connected to `reject()` (cpp:20) — 10 s inactivity auto-dismisses dialog.
- `on_btnEnglish_clicked` / `on_btnSpanish_clicked`: debounce guard (200 ms via `gCfg->clockTime()`); emits `sigLanguageChanged` only if `setLanguage` returns >= 0 (cpp:35, 47).
- `setLanguage` (mytranslator.cpp:177–188): returns -1 for any locale other than `QLocale::English` or `QLocale::Spanish`.
- `on_btnQuit_clicked`: calls `accept()` directly (cpp:56).

---

## Step 3/5 — Coverage Search Results

Grep searches performed across `C:/Projects/cig-audit/repos/mark3-pvd/test/` for:

- Class names: `InformationDialog`, `KeyFilter`, `LanguageDialog`
- All public method names: `setLux`, `setStatus`, `setConfigParam`, `setBatteryStatus`, `setExpModInfo`, `setSuperMasterStatus`, `setVOR`, `setLastWiegand`, `updateInformationScreen`, `languageChanged`, `showInfoDialog`, `isPowerKeyPressed`, `eventFilter`, `resetKeyCount`, `incrementKeyCount`, `getKeyCount`, `resetKeyCounter`, `setPressState`, `getPressState`, `sigLanguageChanged`, `startScreenTimeout`, `debounce`, `on_btnEnglish`, `on_btnSpanish`, `on_btnQuit`

**Result: zero matches in any test file.**

The four test classes in the suite (`TestDialog`, `TestBackgroundWorker`, and the canbus/OTA suites) do not reference `InformationDialog`, `KeyFilter`, or `LanguageDialog` by any name. No method, signal, or slot from any of the three audited classes is invoked from any test.

---

## Findings

---

**A21-1** · HIGH · Missing Test Coverage
**File:** `ui/informationdialog.cpp` / `ui/informationdialog.h` (all lines)
**Description:** `InformationDialog` has zero test coverage. None of its twelve public methods are exercised in any test. The class is instantiated in production code (`ui/dialog.cpp:51`) and used throughout the application lifecycle. Untested behaviors include: constructor handling of absent or malformed `/proc/version` and `/home/root_version` filesystem entries; `setBatteryStatus` map lookup with out-of-range `state`/`fault` values (expected to return `tr("Unknown")` — never verified); `updateInformationScreen` periodic timer start/stop lifecycle; `setVOR`, `setLux`, `setExpModInfo`, `setLastWiegand` label-update paths; and the `languageChanged` retranslation of all 30+ UI labels.
**Fix:** Add a `TestInformationDialog` test class. Cover: (1) construct with null `gCfg` or controlled stub — verify no crash when proc files absent; (2) call `setBatteryStatus` with `state`/`fault` values 0–3 and verify correct label text; (3) call `setBatteryStatus` with value 99 and verify "Unknown" fallback; (4) call `setLux(0)`, `setLux(INT_MAX)`, `setLux(-1)` and verify label text; (5) verify timer starts on `showEvent` and stops on `hideEvent`.

---

**A21-2** · HIGH · Missing Test Coverage — Key Event Filtering
**File:** `ui/keyfilter.cpp:20–63`
**Description:** `KeyFilter::eventFilter()` — the application's sole keyboard security gate — has zero test coverage. This method controls access to the diagnostic information screen and manages the power-key state flag read elsewhere in production code. Specific untested paths include:
- The three-key chord (`Key_Left + Key_Up + Key_Down` simultaneously) triggering `showInfoDialog` (cpp:26–30).
- The four-sequential-press path for each arrow key within 1.5 s triggering `showInfoDialog` (cpp:31–43).
- The mutual-exclusion counter reset: pressing a different arrow key resets all other counters (cpp:76–98). No test verifies that interleaving arrow keys does not erroneously trigger the signal.
- `Key_Return` press/release state machine for `isPowerKeyPressed()` (cpp:46–47, 55–56).
- The 1.5 s timer reset path (cpp:66–73) — timer expiry before the 4th press should reset the counter and prevent the signal.
- Partial key sequences (2 of 3 chord keys, 3 of 4 sequential presses) must not emit the signal.
**Fix:** Add a `TestKeyFilter` test class. Use `QSignalSpy` on `showInfoDialog`. Use `QTest::keyPress`/`QTest::keyRelease` or construct `QKeyEvent` directly. Cover all four arrow keys for the 4-press path, the chord path, the timer-reset path, and the `Key_Return` state machine.

---

**A21-3** · MEDIUM · Uninitialized Member Variables — Undefined Behavior
**File:** `ui/keyfilter.cpp:8–14`
**Description:** The `KeyFilter` constructor initializer list at cpp:8–14 initializes `m_leftKeyPressed(false)` but does not initialize `m_rightKeyPressed` (h:30), `m_upKeyPressed` (h:31), or `m_downKeyPressed` (h:32). These are `bool` members of a `QObject` subclass. In C++ they hold indeterminate values until explicitly written. `getPressState()` (cpp:145–156) reads all four before any `KeyPress` event has occurred. The `eventFilter` at cpp:31 guards `setPressState` calls with `!getPressState(key)` — if any of the three uninitialized flags happens to hold a non-zero value at startup, the very first press of that key will not call `setPressState` and will not start the counter, silently breaking the 4-press detection path. This is undefined behavior per the C++ standard and is not covered by any test.
**Fix:** Add `m_rightKeyPressed(false)`, `m_upKeyPressed(false)`, `m_downKeyPressed(false)` to the constructor member-initializer list at `ui/keyfilter.cpp:14`. Add a test that constructs a fresh `KeyFilter`, sends one press of `Key_Right` / `Key_Up` / `Key_Down` without any prior events, and verifies the count increments correctly.

---

**A21-4** · HIGH · Missing Test Coverage — Language Selection
**File:** `ui/languagedialog.cpp:30–57` / `ui/languagedialog.h`
**Description:** `LanguageDialog` has zero test coverage. The three button slots, the debounce guard, the inactivity timer, and the `sigLanguageChanged` signal are all untested. Critical untested behaviors:
- `on_btnEnglish_clicked` and `on_btnSpanish_clicked`: `sigLanguageChanged` is only emitted when `setLanguage` returns >= 0. No test verifies the signal fires on a valid selection or does not fire on a failed one.
- `debounce()`: 200 ms guard (cpp:65–73) silently discards rapid presses. No test documents this as intentional behavior.
- Inactivity timer: 10 s timeout calls `reject()` (cpp:20). `startScreenTimeout()` (cpp:84–87) restarts the timer. Neither is tested.
- `showEvent` (cpp:59–63) calls `languageChanged()` to retranslate UI labels. No test verifies labels are set correctly.
- `on_btnQuit_clicked` (cpp:54–57) calls `accept()`. Not tested.
**Fix:** Add a `TestLanguageDialog` test class. Cover: (1) click English/Spanish buttons — spy on `sigLanguageChanged`, verify emitted exactly once per click; (2) rapid double-click within 200 ms — verify signal emitted exactly once; (3) `startScreenTimeout()` then advance time 10+ s — verify dialog no longer visible; (4) `on_btnQuit_clicked` — verify dialog accepted; (5) `show()` dialog — verify all labels non-empty in English and after switching to Spanish.

---

**A21-5** · MEDIUM · Unsigned Integer Underflow — Untested Edge Case
**File:** `ui/informationdialog.cpp:208–215`
**Description:**
```cpp
quint32 end = gCfg->onDemandEndTime();
quint32 timeRemaining = end - gCfg->localTimestamp();   // cpp:209
QDateTime d = QDateTime::fromSecsSinceEpoch(timeRemaining);
```
When an on-demand session has expired (`end < localTimestamp()`), this `quint32` subtraction wraps to approximately 4 294 967 295, and `QDateTime::fromSecsSinceEpoch` receives a value corresponding to the year ~2106. The resulting time string displayed on screen is meaningless. No test exercises this path. The condition `gCfg->onDemandActive() && gCfg->onDemandVehicleEnabled()` must both be true to reach the subtraction, so the bug is reachable in production when a session expires while the information dialog is visible.
**Fix:** Add an expiry guard before the subtraction: `quint32 timeRemaining = (end > gCfg->localTimestamp()) ? (end - gCfg->localTimestamp()) : 0;`. Add a test setting `onDemandEndTime()` to a value less than `localTimestamp()` and verifying the displayed string does not show a year in the far future.

---

**A21-6** · MEDIUM · Duplicate Inconsistent WiFi MAC Label Logic — Untested
**File:** `ui/informationdialog.cpp:164–169` (in `setConfigParam`) and `cpp:306–309` (in `languageChanged`)
**Description:** `setConfigParam` (cpp:164–169) opens `/sys/class/net/wlan0/address` and, if successful, sets `ui->lblMacAddress_2` to the MAC address; if the file is absent the label is left with whatever text it previously held. `languageChanged` (cpp:306–309) opens the same file and, if it cannot be opened, sets the same label to `tr("na")`. Both methods are called from `showEvent` (cpp:96–98), meaning the label is set twice on every show event with inconsistent fallback semantics. A test environment where the file is absent would see "na" from `languageChanged` regardless of what `setConfigParam` had just set. No test covers either branch.
**Fix:** Extract WiFi MAC address label update into a single private method. Define the authoritative fallback value ("na") in one place. Add tests for both file-present and file-absent branches verifying the label shows the MAC address or "na" respectively.

---

**A21-7** · LOW · `qChecksum` Length Argument Mismatch — Latent Out-of-Bounds Read
**File:** `ui/informationdialog.cpp:74`
**Description:**
```cpp
quint16 checksum = qChecksum(string.toLatin1().constData(), string.size());
```
`string.size()` returns the number of UTF-16 `QChar` code units in the `QString`. The buffer passed is `string.toLatin1()` — a `QByteArray` whose size is `string.toLatin1().size()`. For pure ASCII content these are equal. However if any component of the concatenated version string (hardware version, kernel version, rootfs version, app version) ever contains a non-ASCII character, `string.size()` exceeds `string.toLatin1().size()`, causing `qChecksum` to read past the end of the allocated byte array — an out-of-bounds read producing undefined behavior and a different checksum than intended. No test covers this code path.
**Fix:** Store the `QByteArray` in a named local variable and use its `size()`: `QByteArray la = string.toLatin1(); quint16 checksum = qChecksum(la.constData(), la.size());`. Add a test using a version string containing at least one non-ASCII character and verify the checksum is computed without crash.

---

**A21-8** · LOW · `showEvent` Default Argument on Virtual Override — API Misuse
**File:** `ui/languagedialog.h:29`
**Description:**
```cpp
protected:
    void showEvent(QShowEvent *event = 0);
```
The base class `QWidget::showEvent(QShowEvent*)` declares no default argument. Adding a default argument to a virtual function override compiles but is semantically misleading: the default applies only when the method is called directly through the derived type, not through the base class vtable. The `Q_UNUSED(event)` annotation in the implementation (cpp:61) confirms the argument is not used, but the default `= 0` invites callers to pass a null pointer directly without realizing it. No test calls `showEvent(nullptr)` to verify null-safety.
**Fix:** Remove the `= 0` default argument from the `showEvent` override declaration in `ui/languagedialog.h:29`. If null-safety for direct calls is required, add a null check in the implementation.

---

## Coverage Summary

| Class | Test files referencing it | Public methods with any test | Signals tested | Total public methods/signals |
|-------|--------------------------|------------------------------|----------------|------------------------------|
| `InformationDialog` | 0 | 0 / 12 | 0 / 0 | 12 |
| `KeyFilter` | 0 | 0 / 2 | 0 / 1 | 2 + 1 signal |
| `LanguageDialog` | 0 | 0 / 4 | 0 / 1 | 4 + 1 signal |

**Overall test coverage for all three audited classes: 0%.**

All three classes are instantiated and connected in production code (`ui/dialog.cpp:51,57`; `main.cpp:79,130`) and are active throughout the application's critical UI path. No automated regression protection exists for any of their behaviors.

---

## Summary Table

| ID | Severity | Category | File | Lines | Description |
|----|----------|----------|------|-------|-------------|
| A21-1 | HIGH | Missing Coverage | `ui/informationdialog.cpp/.h` | all | All 12 public methods of `InformationDialog` untested |
| A21-2 | HIGH | Missing Coverage | `ui/keyfilter.cpp` | 20–63 | `eventFilter` key-event logic entirely untested |
| A21-3 | MEDIUM | Uninitialized Members / UB | `ui/keyfilter.cpp` | 8–14 | `m_rightKeyPressed`, `m_upKeyPressed`, `m_downKeyPressed` not in initializer list |
| A21-4 | HIGH | Missing Coverage | `ui/languagedialog.cpp/.h` | 30–87 | All slots, signal, debounce, and timer behavior of `LanguageDialog` untested |
| A21-5 | MEDIUM | Defect / Unsigned Underflow | `ui/informationdialog.cpp` | 208–215 | `quint32` underflow in `setSuperMasterStatus` when session expired; untested |
| A21-6 | MEDIUM | Code Quality / Defect | `ui/informationdialog.cpp` | 164–169, 306–309 | Duplicate, inconsistent WiFi MAC label logic with differing fallback; untested |
| A21-7 | LOW | Latent Defect | `ui/informationdialog.cpp` | 74 | `qChecksum` passed `QString::size()` instead of `QByteArray::size()` |
| A21-8 | LOW | Code Quality | `ui/languagedialog.h` | 29 | Default argument on virtual override is misleading |

**Total findings: 8**
- HIGH: 3 (A21-1, A21-2, A21-4)
- MEDIUM: 3 (A21-3, A21-5, A21-6)
- LOW: 2 (A21-7, A21-8)

---

*End of report — Agent A21*
