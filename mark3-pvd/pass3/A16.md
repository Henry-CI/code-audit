# Pass 3 Agent A16 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `platform/pwmbacklight.h` / `platform/pwmbacklight.cpp`
- `platform/pwmbeeper.h` / `platform/pwmbeeper.cpp`
- `platform/seriallogger.h` / `platform/seriallogger.cpp`

---

## Reading Evidence

### `platform/pwmbacklight.h` — Class `EM070::PwmBacklight`

**Class:** `EM070::PwmBacklight` (inherits `QObject`)

**Enums / Types / Constants:**
- `enum State { NoChange, Brighter, Darker }` — line 15

**Public methods (with line numbers):**

| Line | Declaration |
|------|-------------|
| 16 | `explicit PwmBacklight(QObject *parent = nullptr)` |
| 17 | `~PwmBacklight()` |
| 18 | `void setAutoBrightness(bool enable)` |
| 19 | `bool isAutoBrightness() const` (inline) |
| 21 | `static quint8 brightness()` |
| 22 | `static void setBrightness(quint8 val)` |

**Signals:**
- `void luxRead(int lux)` — line 25

**Protected methods:**
- `void timerEvent(QTimerEvent *)` — line 28

**Private methods:**
- `void parse(int lux)` — line 31
- `void adjust(int lux)` — line 32
- `int readLux()` — line 33

**Doc comments present:** None. Not a single comment appears above any declaration in the header.

---

### `platform/pwmbeeper.h` — Class `EM070::PwmBeeper`

**Class:** `EM070::PwmBeeper` (inherits `QObject`)

**Enums / Types / Constants:**
- `enum BeepType { BeepOn, BeepSilent, BeepOff }` — line 15

**Public methods (with line numbers):**

| Line | Declaration |
|------|-------------|
| 18 | `explicit PwmBeeper(bool autoDelete = false, QObject *parent = nullptr)` |
| 19 | `~PwmBeeper()` |
| 20 | `void setFrequency(quint16 frequency)` (inline) |
| 21 | `void beep(quint16 milliseconds)` |
| 22 | `void beep(quint16 frequency, quint16 milliseconds)` |
| 23 | `void beep(qint16 count, quint16 msecOn, quint16 msecOff)` |
| 24 | `void stop()` |

**Signals:** None.

**Private methods:**
- `void timeout()` — line 27
- `void setBeep(bool on)` — line 28

**Doc comments present:**
- Line 17: `// if autoDelete is enabled, instance will be deleted when beep time is expired` — an inline comment above the constructor describing the `autoDelete` parameter.
- No other doc comments.

---

### `platform/seriallogger.h` — Class `SerialLogger`

**Class:** `SerialLogger` (plain class, no QObject)

**Public methods (with line numbers):**

| Line | Declaration |
|------|-------------|
| 9 | `static void log(const QByteArray &message)` |
| 10 | `static void setSerialPort(EM070::UserPort *serial)` |

**Signals:** None.

**Enums / Types / Constants:**
- `ENABLE_SL_FILE` (preprocessor macro, value `0`) — defined in `.cpp`, line 5
- `SERIAL_LOG_FILE` (`"/mnt/sd/sl.log"`) — defined in `.cpp`, line 6

**Doc comments present:** None.

---

## Findings

**A16-1** · LOW · No doc comment on `PwmBacklight::setAutoBrightness`
**Description:** `setAutoBrightness(bool enable)` starts or stops the ambient-light-sensor polling loop, powers the ALS sensor on or off via sysfs, and immediately adjusts the backlight level. None of this behaviour is documented in the header. A caller has no indication that enabling auto-brightness powers up hardware, clears internal state, or fires an immediate brightness adjustment.
**Fix:** Add a comment above the declaration explaining that `enable = true` powers up the ALS sensor, resets the lux queue and state machine, performs an initial brightness adjustment, and starts a 250 ms polling timer; that `enable = false` kills the timer and powers down the sensor.

---

**A16-2** · INFO · No doc comment on `PwmBacklight::isAutoBrightness`
**Description:** Trivial const getter; the name is self-describing. Missing documentation is minor.
**Fix:** A one-line comment `// Returns true if the automatic brightness adjustment loop is currently active.` is sufficient.

---

**A16-3** · LOW · No doc comment on `static PwmBacklight::brightness()`
**Description:** `brightness()` reads the current backlight level directly from the sysfs node `/sys/devices/platform/pwm-backlight.0/…/brightness`. The implementation returns `255` on failure to open the file (a valid brightness value, not an error sentinel), which is non-obvious behaviour. No documentation exists.
**Fix:** Document the return range (0–255), the sysfs source, and the error-return convention (returns 255 if the sysfs file cannot be opened).

---

**A16-4** · LOW · No doc comment on `static PwmBacklight::setBrightness(quint8 val)`
**Description:** `setBrightness` writes directly to sysfs to control the hardware backlight. Callers need to know the valid range, the absence of range-clamping, and the silent failure mode (write failures are logged to `qCritical` but not propagated). None of this is documented.
**Fix:** Add a comment stating the valid range (0–255), that the value is written directly to the PWM backlight sysfs node without clamping, and that failures are logged but not returned to the caller.

---

**A16-5** · LOW · No doc comment on `PwmBacklight::luxRead` signal
**Description:** The signal `void luxRead(int lux)` is emitted on every 250 ms timer tick with the raw lux value from the sensor. The header carries no description of when it fires, the unit of the argument, or its range. Slot writers have no guidance.
**Fix:** Add a comment: `// Emitted every ~250 ms with the raw ambient light level in lux (0–4000) when auto-brightness is active.`

---

**A16-6** · MEDIUM · Guard macro mismatch in `pwmbacklight.h`
**Description:** The include guard at line 1 is `#ifndef PWMBACKLIGHT_H` but the macro defined at line 2 is `#define BRIGHTNESS_H`. These do not match, so the guard is non-functional: the `#define BRIGHTNESS_H` never satisfies the `#ifndef PWMBACKLIGHT_H` check on re-inclusion. This is a documentation / correctness defect in the guard itself. While not a doc-comment issue, it falls squarely in the header's structural documentation.
**Fix:** Change line 2 to `#define PWMBACKLIGHT_H` so the guard macro matches the `#ifndef` condition, and update the closing comment on line 48 if needed.

---

**A16-7** · LOW · `BeepType` enum is declared but never used
**Description:** `enum BeepType { BeepOn, BeepSilent, BeepOff }` is defined in the public interface at line 15 of `pwmbeeper.h`. It is not referenced anywhere in `pwmbeeper.cpp` or in any `beep()` overload signature. There is no comment explaining its intended purpose or whether it is reserved for future use. This creates confusion for integrators who may attempt to pass `BeepType` values to the beep API and find no accepting overload.
**Fix:** Either add a comment stating the enum is reserved / unused (e.g., `// Reserved for future use; not yet accepted by any beep() overload.`), or remove the enum if it serves no purpose.

---

**A16-8** · LOW · No doc comment on `PwmBeeper::beep(quint16 milliseconds)`
**Description:** The single-argument `beep` overload is undocumented. From the implementation it plays one beep at the previously configured frequency (`m_frequency`, default 4000 Hz) for `milliseconds` milliseconds. The relationship to `setFrequency` and the default frequency is invisible to callers.
**Fix:** Add a comment noting that this plays a single beep at the current frequency (set via `setFrequency`, default 4000 Hz) for the specified duration.

---

**A16-9** · LOW · No doc comment on `PwmBeeper::beep(quint16 frequency, quint16 milliseconds)`
**Description:** Two-argument overload that sets the frequency and plays one beep. No documentation. The side-effect of permanently updating `m_frequency` (i.e., subsequent calls to the one-argument `beep()` will use the new frequency) is invisible.
**Fix:** Document parameters and note that calling this overload permanently updates the object's stored frequency.

---

**A16-10** · LOW · No doc comment on `PwmBeeper::beep(qint16 count, quint16 msecOn, quint16 msecOff)`
**Description:** The three-argument overload is the most complex: it plays `count` beep pulses separated by `msecOff` silent gaps. The sign of `count` (it is `qint16`, not `quint16`) is undocumented. From the implementation `count` is decremented to zero; negative or zero values are never clamped, which means passing `count <= 0` results in no beep but also triggers `deleteLater()` if `autoDelete` is set. None of this is documented.
**Fix:** Document all three parameters, note that `count` must be positive, explain the beep/pause cycle, and warn that `count <= 0` causes immediate silent deletion when `autoDelete` is true.

---

**A16-11** · LOW · No doc comment on `PwmBeeper::stop()`
**Description:** `stop()` silences the beeper, cancels both timers, and — if `autoDelete` is set — schedules `deleteLater()`. The auto-delete side-effect is a memory-management concern that callers must know about. No documentation is present.
**Fix:** Add a comment explaining that `stop()` immediately silences the beeper and, when `autoDelete` was set on construction, schedules the object for deletion.

---

**A16-12** · LOW · No doc comment on `PwmBeeper::setFrequency(quint16 frequency)`
**Description:** Inline setter with no comment. The valid range, unit (Hz), and the default value (4000 Hz, set in the constructor) are not described.
**Fix:** Add a comment: `// Sets the beep frequency in Hz. Default is 4000 Hz. Takes effect on the next call to beep().`

---

**A16-13** · LOW · No doc comment on `SerialLogger::log(const QByteArray &message)`
**Description:** `log()` prepends a millisecond-epoch timestamp to `message` and forwards it via `UserPort::response()`. It is conditionally compiled to also write to `/mnt/sd/sl.log` (controlled by `ENABLE_SL_FILE`). The header has no comment describing the timestamp format, the output destination, null-safety (silently no-ops if `setSerialPort` was never called), or the file-logging capability. Because this is used for serial-level diagnostic logging, incomplete documentation can lead to misuse in field diagnostics.
**Fix:** Document the timestamp format (`[<epoch_ms>]`), the requirement to call `setSerialPort` before use, the silent no-op behaviour when no port is set, and the compile-time file-log option.

---

**A16-14** · LOW · No doc comment on `SerialLogger::setSerialPort(EM070::UserPort *serial)`
**Description:** `setSerialPort` sets the single static destination for all subsequent `log()` calls. Passing `nullptr` is allowed and silences logging (log becomes a no-op). There is no documentation of nullptr semantics, thread-safety, or whether the class takes ownership of the pointer.
**Fix:** Add a comment noting: accepts nullptr to disable logging; the class does not take ownership of the pointer; not thread-safe (static state with no locking).

---

## Summary Table

| ID | Severity | File | Subject |
|----|----------|------|---------|
| A16-1 | LOW | `pwmbacklight.h` | Missing doc on `setAutoBrightness` |
| A16-2 | INFO | `pwmbacklight.h` | Missing doc on `isAutoBrightness` |
| A16-3 | LOW | `pwmbacklight.h` | Missing doc on `brightness()` — non-obvious error return |
| A16-4 | LOW | `pwmbacklight.h` | Missing doc on `setBrightness()` — range and failure mode |
| A16-5 | LOW | `pwmbacklight.h` | Missing doc on `luxRead` signal |
| A16-6 | MEDIUM | `pwmbacklight.h` | Include guard macro mismatch (`PWMBACKLIGHT_H` vs `BRIGHTNESS_H`) |
| A16-7 | LOW | `pwmbeeper.h` | `BeepType` enum declared but never used, no comment |
| A16-8 | LOW | `pwmbeeper.h` | Missing doc on `beep(quint16 milliseconds)` |
| A16-9 | LOW | `pwmbeeper.h` | Missing doc on `beep(quint16 frequency, quint16 milliseconds)` — permanent frequency side-effect |
| A16-10 | LOW | `pwmbeeper.h` | Missing doc on `beep(qint16 count, …)` — signed count, auto-delete edge case |
| A16-11 | LOW | `pwmbeeper.h` | Missing doc on `stop()` — auto-delete side-effect |
| A16-12 | LOW | `pwmbeeper.h` | Missing doc on `setFrequency()` — unit and default undocumented |
| A16-13 | LOW | `seriallogger.h` | Missing doc on `log()` — timestamp format, null-port no-op, file log option |
| A16-14 | LOW | `seriallogger.h` | Missing doc on `setSerialPort()` — nullptr semantics, ownership, thread-safety |

**Totals:** 1 MEDIUM, 12 LOW, 1 INFO
