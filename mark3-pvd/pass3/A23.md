# Pass 3 Agent A23 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Auditor:** Agent A23
**Files reviewed:**
- `ui/ondemanddialog.h` / `ui/ondemanddialog.cpp`
- `ui/optionalcheckconfirmationdialog.h` / `ui/optionalcheckconfirmationdialog.cpp`
- `ui/pindialog.h` / `ui/pindialog.cpp`

---

## Reading Evidence

### `OnDemandDialog` (`ui/ondemanddialog.h`)

**Class:** `OnDemandDialog` (extends `QDialog`)

**Public methods:**

| Line | Method | Doc comment present? |
|------|--------|----------------------|
| 20 | `explicit OnDemandDialog(QWidget *parent = 0)` | No |
| 21 | `~OnDemandDialog()` | No |
| 23 | `void setSuperMasterId(quint64 id)` | No |
| 24 | `void reset()` | No |
| 25 | `void setTimeRemaining(quint32 secs)` | No |
| 26 | `QString showCustomTimeFormat(quint32 time)` | No |

**Signals:**

| Line | Signal |
|------|--------|
| 29 | `onDemandStarted(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src)` |
| 30 | `onDemandExtended(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src)` |
| 31 | `onDemandEnded(quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src)` |

**Protected methods (slots/overrides):**

| Line | Method |
|------|--------|
| 34 | `void showEvent(QShowEvent *event = 0)` |
| 36 | `void onStart()` |
| 37 | `void onExtend()` |
| 38 | `void onEnd()` |

**Private methods:**

| Line | Method |
|------|--------|
| 41 | `bool debounce()` |

**Types, enums, constants defined in translation unit:**
- `#define NO_ACTIVITY_TIME 10000` (cpp, line 7) — inactivity timeout in milliseconds (10 seconds)

**No doc comments exist anywhere in this file pair.**

---

### `OptionalCheckConfirmationDialog` (`ui/optionalcheckconfirmationdialog.h`)

**Class:** `OptionalCheckConfirmationDialog` (extends `QDialog`)

**Public methods:**

| Line | Method | Doc comment present? |
|------|--------|----------------------|
| 15 | `explicit OptionalCheckConfirmationDialog(QWidget *parent = 0)` | No |
| 16 | `~OptionalCheckConfirmationDialog()` | No |
| 17 | `void onRefreshLanguage(void)` | No |

**Signals:** None declared.

**Protected methods:**

| Line | Method |
|------|--------|
| 24 | `void hideEvent(QHideEvent *)` |
| 25 | `void showEvent(QShowEvent *event = 0)` |

**Types, enums, constants:** None.

**No doc comments exist anywhere in this file pair.**

---

### `PinDialog` (`ui/pindialog.h`)

**Class:** `PinDialog` (extends `QDialog`)

**Public methods:**

| Line | Method | Doc comment present? |
|------|--------|----------------------|
| 17 | `explicit PinDialog(QWidget *parent = 0)` | No |
| 18 | `~PinDialog()` | No |
| 20 | `quint32 pinCode() const` | No |
| 21 | `void clearPinCode()` | No |
| 22 | `void languageChanged()` | No |

**Signals:** None declared.

**Protected methods:**

| Line | Method |
|------|--------|
| 25 | `void showEvent(QShowEvent *)` |
| 26 | `void hideEvent(QHideEvent *)` |

**Private methods:**

| Line | Method |
|------|--------|
| 29 | `void keyPressed()` |

**Types, enums, constants defined in translation unit:**
- `#define PIN_MAX_LENGTH 5` (cpp, line 9) — maximum number of PIN digits accepted
- `#define ACTIVITY_TIME 30000` (cpp, line 10) — inactivity auto-dismiss timeout in milliseconds (30 seconds)

**No doc comments exist anywhere in this file pair.**

---

## Findings

**A23-1** · HIGH · `PinDialog::pinCode()` has no documentation

**Description:** `pinCode()` is the sole public accessor that retrieves the numeric PIN value entered by the user. It is called by callers after `exec()` returns `Accepted` to perform vehicle-access authentication. The method has non-obvious behaviour: it silently stops accumulating digits at the first non-digit character (e.g. `#`), effectively stripping any trailing `#` that the hardware keypad appends when `btnHash` triggers `accept()`. This silent truncation is critical to understand for any caller verifying the PIN value and is completely undocumented. There is no description of the parameter, return value, the accepted character set, or the truncation rule.

**Fix:** Add a doc comment above the declaration in `pindialog.h` explaining: (1) what value is returned (the numeric portion of the PIN as entered via the keypad); (2) that trailing non-digit characters (e.g. `#`) are silently discarded; (3) that the return value is `0` when the field is empty; (4) that `clearPinCode()` must be called before re-showing the dialog if the previous result is to be discarded.

---

**A23-2** · HIGH · `PinDialog::clearPinCode()` has no documentation

**Description:** `clearPinCode()` resets both the internal `QLineEdit` and the masking `QLabel` to empty. Callers must invoke this before re-presenting the dialog to a new authentication attempt; failure to do so would leave the previous PIN pre-populated in the input, potentially granting unintended access. The method has no doc comment explaining when it must be called or what state it clears.

**Fix:** Add a doc comment above the declaration in `pindialog.h` stating that this method clears the entered PIN from both the input field and the display mask and that it should be called before each new authentication session.

---

**A23-3** · HIGH · `PinDialog::languageChanged()` has no documentation

**Description:** `languageChanged()` repopulates all UI button and label text using `tr()` for runtime locale switching. It is part of the `PinDialog` public API and must be called by the parent at the correct time (after language selection but before or while the dialog is visible). The method has no doc comment, no explanation of when it must be called, and no indication of what UI elements it modifies. Calling it at the wrong time (e.g. while `pinCode()` is being read) could produce a race condition on the display state.

**Fix:** Add a doc comment in `pindialog.h` stating that this method refreshes all translatable UI strings and should be called when the application language changes, ideally while the dialog is hidden.

---

**A23-4** · LOW · `OnDemandDialog::setSuperMasterId()` has no documentation

**Description:** `setSuperMasterId()` stores a `quint64` identifier that is subsequently embedded in every emitted signal (`onDemandStarted`, `onDemandExtended`, `onDemandEnded`) as the `id` parameter. The name "super master ID" is opaque and the relationship between this stored value and the signals is not documented anywhere. There is no indication that the dialog must be configured with this value before it is shown, nor what value `0` or an unset ID would mean to the backend.

**Fix:** Add a doc comment above the declaration explaining that this sets the super-master device identifier to be reported in On Demand lifecycle signals, and that it should be set before the dialog is shown.

---

**A23-5** · LOW · `OnDemandDialog::reset()` has no documentation

**Description:** `reset()` clears `m_lastPress` (debounce timestamp) and then calls `showEvent()` directly to rebuild UI state. This means it re-evaluates `gCfg->onDemandStartTime()` and re-enables or disables buttons accordingly. Calling `showEvent()` directly (rather than relying on Qt's normal show mechanism) is an unusual pattern. There is no doc comment describing the intended use case, what state is reset, or the side-effect of internally calling `showEvent()`.

**Fix:** Add a doc comment above the declaration describing that `reset()` reinitialises the dialog to reflect the current on-demand session state and resets the debounce timer, and that it is intended for use when the dialog is re-shown without being destroyed and recreated.

---

**A23-6** · LOW · `OnDemandDialog::setTimeRemaining()` has no documentation

**Description:** `setTimeRemaining()` accepts a `quint32` value in seconds and updates the status label. When `secs == 0` it shows a generic header string; otherwise it appends a formatted time string. The units (seconds), the zero-case behaviour, and the label update mechanism are all undocumented.

**Fix:** Add a doc comment above the declaration in `ondemanddialog.h` stating: (1) the parameter is in seconds; (2) passing `0` reverts the label to the default "On Demand Mode Control Panel" text; (3) non-zero values append the remaining time in `HH:MM:SS` format.

---

**A23-7** · LOW · `OnDemandDialog::showCustomTimeFormat()` has no documentation

**Description:** `showCustomTimeFormat()` converts a `quint32` number of seconds into a zero-padded `HH:MM:SS` string. The method name suggests it may be intended as a display-only utility. Its return type, parameter units, and formatting contract are all undocumented. The method is public, making it part of the class API surface.

**Fix:** Add a doc comment above the declaration stating that the parameter is a duration in seconds and the return value is a formatted string in `HH:MM:SS` notation with zero-padded fields.

---

**A23-8** · LOW · `OnDemandDialog` signals have no documentation

**Description:** The three signals `onDemandStarted`, `onDemandExtended`, and `onDemandEnded` carry `quint32 start`, `quint32 end`, and `quint64 id` parameters, plus a `CIGCONF::OnDemandCmdSrc` default argument. There is no documentation describing the epoch or time base for `start`/`end` (local Unix timestamp per the implementation), the meaning of `id`, or the purpose of `src`. These signals are consumed by backend components to control vehicle access scheduling; the lack of documentation makes correct consumption error-prone.

**Fix:** Add doc comments above each signal declaration describing the time base (local Unix timestamp in seconds), the role of `id` (super-master device identifier), and the purpose of `src` (command source for local vs remote origination).

---

**A23-9** · INFO · `OptionalCheckConfirmationDialog::onRefreshLanguage()` has no documentation

**Description:** `onRefreshLanguage()` re-applies all `tr()` translated strings to the dialog's UI widgets. It duplicates the same assignments made in `showEvent()`. The method has no doc comment explaining when it is called or why it is needed in addition to `showEvent()`.

**Fix:** Add a brief comment above the declaration noting that this method refreshes translatable strings and is called when the application locale changes at runtime.

---

**A23-10** · INFO · Constructor and destructor doc comments absent across all three classes

**Description:** None of the three constructors or destructors in `OnDemandDialog`, `OptionalCheckConfirmationDialog`, or `PinDialog` have doc comments. For the constructors this is low risk, but noting it for completeness per the audit scope.

**Fix:** At minimum, add a brief comment to `PinDialog(QWidget *parent)` noting that the constructor wires all keypad button signals and sets up the inactivity timer (30 s). Constructors for the other two classes are straightforward enough that an INFO classification is appropriate.

---

## Summary Table

| ID | Severity | Location | Title |
|----|----------|----------|-------|
| A23-1 | HIGH | `pindialog.h:20` | `PinDialog::pinCode()` has no documentation |
| A23-2 | HIGH | `pindialog.h:21` | `PinDialog::clearPinCode()` has no documentation |
| A23-3 | HIGH | `pindialog.h:22` | `PinDialog::languageChanged()` has no documentation |
| A23-4 | LOW | `ondemanddialog.h:23` | `OnDemandDialog::setSuperMasterId()` has no documentation |
| A23-5 | LOW | `ondemanddialog.h:24` | `OnDemandDialog::reset()` has no documentation |
| A23-6 | LOW | `ondemanddialog.h:25` | `OnDemandDialog::setTimeRemaining()` has no documentation |
| A23-7 | LOW | `ondemanddialog.h:26` | `OnDemandDialog::showCustomTimeFormat()` has no documentation |
| A23-8 | LOW | `ondemanddialog.h:29-31` | `OnDemandDialog` signals have no documentation |
| A23-9 | INFO | `optionalcheckconfirmationdialog.h:17` | `onRefreshLanguage()` has no documentation |
| A23-10 | INFO | All three headers | Constructor and destructor doc comments absent |

**Totals:** 3 HIGH, 5 LOW, 2 INFO
