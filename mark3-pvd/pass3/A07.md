# Pass 3 Agent A07 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `comm/bleinputhandler.h` + `comm/bleinputhandler.cpp`
- `comm/canexpansion.h` + `comm/canexpansion.cpp`

---

## Reading Evidence

### File: `comm/bleinputhandler.h` / `comm/bleinputhandler.cpp`

**Class name:** `BleInputHandler`

**Public methods (header line numbers):**

| Line | Method |
|------|--------|
| 20 | `explicit BleInputHandler(CanExpansion *canExpansion)` — constructor |
| 22 | `void updateIgnition(CIGCONF::PowerState state)` |
| 23 | `void updateBleInput(CIGCONF::BleExpansionDI input, bool state)` |
| 24 | `void changeBleState(bool connected)` |
| 26 | `void updateIdleTimer()` |
| 28 | `QByteArray digitalInputs(DigitalFormat format, bool autoReset)` |

**Signals:**

| Line | Signal |
|------|--------|
| 31 | `void idleTimeout()` |
| 32 | `void sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra = QByteArray())` |

**Slots:** None declared explicitly. `updateBleInput` and `changeBleState` are connected as slots via `connect()` calls in the constructor (bleinputhandler.cpp lines 18–19), but are not declared with `public slots:` — they are ordinary public methods wired as slots.

**Types, enums, and constants defined:**

| Kind | Name | Line |
|------|------|------|
| enum | `DigitalFormat { SessionFormat, UsageFormat, OnDemandFormat }` | 18 |
| private struct | `InputState` | 39–48 |

**File-level comment (bleinputhandler.h, lines 1–4):**
```
/*
 * Besides the 4 inputs of BLE expansion module,
 * ignition input is handled here
 */
```
This is the only descriptive comment in the entire header/source pair.

---

### File: `comm/canexpansion.h` / `comm/canexpansion.cpp`

**Class name:** `CanExpansion`

**Public methods (header line numbers):**

| Line | Method |
|------|--------|
| 42 | `explicit CanExpansion(EM070::CanBus *canBus, EM070::PowerSupply *ps)` — constructor |
| 44 | `void setEnabled(bool enable)` |
| 46 | `const QByteArray &deviceName() const` — inline getter |
| 47 | `const QByteArray &bleVersion() const` — inline getter |
| 48 | `const QByteArray &mainVersion() const` — inline getter |
| 49 | `const QByteArray &manufacture() const` — inline getter |
| 50 | `const QByteArray &modelNumber() const` — inline getter |
| 52 | `bool relayOutput(CIGCONF::BleExpansionRelay relay) const` — inline getter |
| 55 | `void setRelayOutput(CIGCONF::BleExpansionRelay relay, bool state)` |
| 57 | `quint16 relayTimeout(CIGCONF::BleExpansionRelay relay) const` — inline getter |
| 60 | `void setRelayTimeout(CIGCONF::BleExpansionRelay relay, quint16 timeout_in_sec)` |
| 62 | `void setCurrentTime(quint32 time)` |
| 64 | `bool digitalInput(CIGCONF::BleExpansionDI di) const` — inline getter |
| 66 | `void setShockThreshold(quint32 threshold)` |
| 67 | `void setShockPeriod(quint32 period)` |
| 69 | `bool isShockQueueEmpty()` — inline |
| 70 | `ShockEvent shockEvent()` — inline, dequeues |
| 72 | `bool generateShockMessage(bool force)` |
| 74 | `void setGnssReceiver(EM070::GnssReceiver* gnss)` |

**Signals:**

| Line | Signal |
|------|--------|
| 77 | `void inputStateChanged(CIGCONF::BleExpansionDI input, bool state)` |
| 78 | `void shockOccurred()` |
| 79 | `void amberImpactOccurred()` |
| 80 | `void redImpactOccurred()` |
| 81 | `void accessible(bool yes)` |
| 82 | `void expModInfo(QByteArray mainVersion)` |
| 83 | `void inactiveNotification(bool inactive, quint32 secs)` |
| 84 | `void relayStateChanged(bool relay1, bool relay2)` |

**Types, enums, and constants defined:**

| Kind | Name | Line |
|------|------|------|
| public struct | `ShockEvent` | 25–40 |

**No file-level or class-level comment exists** in either `canexpansion.h` or `canexpansion.cpp`. There is a single inline comment at canexpansion.cpp line 194 (`// initial or re-assign clock`) and one at line 110 (`// Start reconection process quickly`). No method has any doc comment.

---

## Documentation Checks

### BleInputHandler

#### `BleInputHandler(CanExpansion *canExpansion)` (line 20)
- Doc comment: No.
- The constructor wires three signal-slot connections (canExpansion::inputStateChanged, canExpansion::accessible, m_digInputModeTimer::timeout), sets up a single-shot timer, and calls resetStates(). The side-effects and ownership of the passed pointer are not described anywhere.

#### `void updateIgnition(CIGCONF::PowerState state)` (line 22)
- Doc comment: No.
- Non-trivial: accumulates on/off time, manages rising edge count, conditionally resets all state, starts/stops the idle timer depending on configuration. The `m_bypassReset` interaction in particular is subtle and undocumented.

#### `void updateBleInput(CIGCONF::BleExpansionDI input, bool state)` (line 23)
- Doc comment: No.
- Non-trivial: accumulates per-input timing and rising counts, triggers the seen-safety debounce timer for input 2 if the digital mode is `SeenSafety`, and manages the idle timer. All of this behaviour is undocumented.

#### `void changeBleState(bool connected)` (line 24)
- Doc comment: No.
- Non-trivial: when `connected` is false, finalises elapsed time for all four BLE inputs before the device goes offline. The accounting freeze-and-resume semantics are entirely undocumented.

#### `void updateIdleTimer()` (line 26)
- Doc comment: No.
- Non-trivial: creates or destroys the idle QTimer according to current configuration, maps the encoded `idleInputSource()` integer values (1, 2, 4, 8, 16) to specific inputs, and starts the timer only when the polarity condition is met. No documentation exists for the bitmask encoding scheme or the conditions under which the timer is created/destroyed.

#### `QByteArray digitalInputs(DigitalFormat format, bool autoReset)` (line 28)
- Doc comment: No.
- Non-trivial: produces a formatted ASCII byte array representing on/off time and rising edge counts for ignition and four BLE inputs in one of three serialisation formats. The `autoReset` flag side-effectfully zeroes counters. The output format itself (e.g., `"0: %d %x %x 1: %d %x %x ... 10: 0 0 0"`) is undocumented, as are the special-cased slots 5 and 10 in the output.

#### `DigitalFormat` enum (line 18)
- Doc comment: No.
- The three values (`SessionFormat`, `UsageFormat`, `OnDemandFormat`) are not explained; the difference between session, usage, and on-demand formatting is not obvious from the names alone.

#### Signal `idleTimeout()` (line 31)
- Doc comment: No. No description of what triggers it or what consumers are expected to do.

#### Signal `sendGmtpMessage(...)` (line 32)
- Doc comment: No. The GMTP protocol, the meaning of the `msg` parameter types, and when this signal fires are undocumented.

---

### CanExpansion

#### `CanExpansion(EM070::CanBus *canBus, EM070::PowerSupply *ps)` (line 42)
- Doc comment: No.
- Constructor defers CAN bus initialisation by 500 ms via a single-shot timer. This is a non-obvious design choice with no documentation.

#### `void setEnabled(bool enable)` (line 44)
- Doc comment: No.
- Non-trivial: when disabling, cuts CAN power and signals `accessible(false)`. When enabling, restores power and immediately begins re-handshake sequence. The asymmetry (disable is fully synchronous; enable is asynchronous) is undocumented.

#### Inline getters: `deviceName`, `bleVersion`, `mainVersion`, `manufacture`, `modelNumber` (lines 46–50)
- Doc comment: No. Acceptable for simple getters (INFO severity).

#### `bool relayOutput(CIGCONF::BleExpansionRelay relay) const` (line 52)
- Doc comment: No. Inline getter; acceptable at INFO severity.

#### `void setRelayOutput(CIGCONF::BleExpansionRelay relay, bool state)` (line 55)
- Doc comment: No.
- Non-trivial: writes to the CAN bus if transfer is enabled, emits `relayStateChanged` for both relays regardless of which was changed, and updates local shadow state. The unconditional dual-relay emission in the signal and the silent no-op when CAN is disabled are undocumented.

#### `quint16 relayTimeout(CIGCONF::BleExpansionRelay relay) const` (line 57)
- Doc comment: No. Inline getter; acceptable at INFO severity.

#### `void setRelayTimeout(CIGCONF::BleExpansionRelay relay, quint16 timeout_in_sec)` (line 60)
- Doc comment: No.
- Non-trivial: silently does not write to the CAN bus when transfer is disabled, but does update shadow state (unlike `setRelayOutput`, which also updates shadow state when disabled). Units are not documented in the parameter name alone.

#### `void setCurrentTime(quint32 time)` (line 62)
- Doc comment: No.
- Non-trivial: silently no-ops if CAN transfer is disabled. The `time` parameter type, epoch, and encoding are not documented.

#### `bool digitalInput(CIGCONF::BleExpansionDI di) const` (line 64)
- Doc comment: No. Inline getter; acceptable at INFO severity.

#### `void setShockThreshold(quint32 threshold)` (line 66)
- Doc comment: No.
- Non-trivial: silently no-ops if CAN transfer is disabled. The units and meaning of the threshold value are undocumented.

#### `void setShockPeriod(quint32 period)` (line 67)
- Doc comment: No.
- Non-trivial: same silent-no-op pattern. The units and meaning of `period` are undocumented.

#### `bool isShockQueueEmpty()` (line 69)
- Doc comment: No. Simple delegation; INFO severity.

#### `ShockEvent shockEvent()` (line 70)
- Doc comment: No.
- Non-trivial: dequeues and returns by value, so the queue is destructively modified. The caller must check `isShockQueueEmpty()` first to avoid undefined behaviour from dequeuing an empty QQueue. This precondition is undocumented.

#### `bool generateShockMessage(bool force)` (line 72)
- Doc comment: No.
- Non-trivial and safety-relevant: controls whether a pending shock event is promoted to the outbound queue. The `force` flag bypasses normal timing/counter guards. The conditions under which `true` is returned (enqueue occurred), the interaction with `m_redImpactCounter`, and the time-sync regression guard are all undocumented.

#### `void setGnssReceiver(EM070::GnssReceiver* gnss)` (line 74)
- Doc comment: No. Simple setter but the pointer ownership and lifetime contract (the object does not take ownership) is not documented.

#### `ShockEvent` struct (lines 25–40)
- Doc comment: No. None of the 13 fields carry any description. Units for `magnitude`, `speed`, `sumOfDistance`, `course`, and coordinate fields are not documented.

#### Signals: all 8 signals (lines 77–84)
- Doc comments: None. Signals like `amberImpactOccurred`, `redImpactOccurred`, `accessible`, and `inactiveNotification` carry safety or connectivity semantics that are not described.

---

## Findings

**A07-1** · LOW · No doc comments on any `BleInputHandler` public methods
**Description:** None of the six public methods of `BleInputHandler` (`BleInputHandler()`, `updateIgnition()`, `updateBleInput()`, `changeBleState()`, `updateIdleTimer()`, `digitalInputs()`) carries any doc comment. Parameters and return values are entirely undescribed. The only documentation in the file is a four-line file-level comment that partially describes the class purpose.
**Fix:** Add at minimum a single-line comment above each declaration describing purpose, non-obvious parameters, and any side-effects. For `digitalInputs()` in particular, document the output format string, the meaning of `autoReset`, and each `DigitalFormat` variant.

---

**A07-2** · LOW · `DigitalFormat` enum values undocumented
**Description:** The `DigitalFormat` enum (bleinputhandler.h line 18) defines `SessionFormat`, `UsageFormat`, and `OnDemandFormat`. The distinction between session and usage counters (session counters reset per ignition cycle; usage counters persist across cycles) is critical to correct interpretation of the `digitalInputs()` output, but is explained nowhere in the header or source.
**Fix:** Add a comment above the enum and/or above each enumerator explaining what data subset each format serialises and when each should be used.

---

**A07-3** · LOW · `updateIdleTimer()` input-source encoding undocumented
**Description:** `updateIdleTimer()` interprets the integer returned by `gCfg->idleInputSource()` as a bitmask-like encoding where 1 = ignition, 2 = BLE DI1, 4 = BLE DI2, 8 = BLE DI3, 16 = BLE DI4. This encoding is non-obvious (it is a power-of-two positional scheme, not a true bitmask). The internal comment in the `.cpp` (`// per spec., 1 for ignition; 2,4,8,16 for BLE expansion module input`) exists only in the implementation and is not surfaced in the header. Callers reading only the header have no indication of valid values.
**Fix:** Move or duplicate the encoding explanation into a comment above the `updateIdleTimer()` declaration in the header, or at minimum reference the specification by name.

---

**A07-4** · MEDIUM · `digitalInputs()` output format is undocumented; `autoReset` side-effect is invisible
**Description:** `digitalInputs()` (bleinputhandler.h line 28) returns a structured ASCII payload whose format is defined only by the implementation. The output contains fixed slot indices (0 for ignition, 1–4 for BLE inputs, 5 as a constant zero entry, 6–9 for rising-edge counts, 10 as a constant zero entry). The `autoReset` parameter destructively zeroes session or usage counters, a side-effect that is invisible from the declaration. A caller who passes `autoReset = true` without understanding this will lose accumulated telemetry data.
**Fix:** Document the output format in a comment above the declaration, list the slot layout, and explicitly warn that `autoReset = true` clears the corresponding counters. This is the primary data-export method of the class and requires full documentation.

---

**A07-5** · LOW · No doc comments on any `CanExpansion` public methods
**Description:** None of the 19 public methods of `CanExpansion` carries any doc comment. The header file has no file-level or class-level comment at all. The `.cpp` implementation contains only two brief inline remarks and serial-log strings.
**Fix:** Add doc comments to all non-trivial public methods. At minimum: `setEnabled()`, `setRelayOutput()`, `setRelayTimeout()`, `setCurrentTime()`, `setShockThreshold()`, `setShockPeriod()`, `generateShockMessage()`, and the constructor.

---

**A07-6** · LOW · `ShockEvent` struct fields undocumented
**Description:** The `ShockEvent` struct (canexpansion.h lines 25–40) contains 13 fields including `magnitude`, `speed`, `sumOfDistance`, `course`, `longitude`, `latitude`, `distance`, and `satelliteCount`. None of the fields carries a comment describing units, encoding, or range. For example: whether coordinates are in millionths of a degree or another fixed-point encoding, what units `speed` is in, and what `distance` vs `sumOfDistance` represent are all opaque.
**Fix:** Add a comment to each field in the struct specifying units and encoding. At minimum document `magnitude` (acceleration units), coordinate fields (fixed-point encoding and resolution), `speed` (units), and `distance`/`sumOfDistance` (units and semantic distinction).

---

**A07-7** · LOW · `generateShockMessage(bool force)` preconditions and return semantics undocumented
**Description:** `generateShockMessage()` (canexpansion.h line 72) returns `true` when a shock event has been enqueued and `false` otherwise. It has a non-trivial internal state machine involving `m_redImpactCounter` and `m_shockTimestamp`. The `force` parameter bypasses normal deferral logic. Neither the return value meaning, the `force` semantics, the precondition (a pending shock must exist in `m_shockEvent1`), nor the interaction with `isShockQueueEmpty()`/`shockEvent()` is documented.
**Fix:** Add a doc comment explaining: what `force = true` does relative to `force = false`, the return value meaning, and that callers should drain the queue via `shockEvent()` after a `true` return.

---

**A07-8** · LOW · `shockEvent()` missing precondition documentation
**Description:** `shockEvent()` (canexpansion.h line 70) is an inline method that calls `m_shockEvents.dequeue()`. Calling `QQueue::dequeue()` on an empty queue is undefined behaviour. The contract that callers must first check `isShockQueueEmpty()` is not documented anywhere.
**Fix:** Add a comment stating that this method must only be called when `isShockQueueEmpty()` returns `false`.

---

**A07-9** · INFO · Inline getters lack doc comments
**Description:** The five string-returning getters (`deviceName`, `bleVersion`, `mainVersion`, `manufacture`, `modelNumber` — lines 46–50) and the two query methods (`relayOutput`, `relayTimeout`, `digitalInput`, `isShockQueueEmpty` — lines 52, 57, 64, 69) have no doc comments. These are trivial accessors; absence of documentation is low risk.
**Fix:** At minimum add a one-line comment describing the provenance of each value (e.g., that `deviceName` and `bleVersion` are populated during the CAN handshake sequence and may be empty until the module becomes accessible).

---

**A07-10** · LOW · Signals in both classes carry no documentation
**Description:** All 8 signals in `CanExpansion` (lines 77–84) and both signals in `BleInputHandler` (lines 31–32) have no doc comments. Several carry safety-relevant semantics: `redImpactOccurred`, `amberImpactOccurred`, `accessible`, `inactiveNotification`, and `sendGmtpMessage` all affect vehicle-safety or reporting behaviour. Consumers connecting to these signals have no in-code description of when they fire or what the parameters mean.
**Fix:** Add a one-line comment above each signal declaration describing the emission condition and, for signals with parameters, the meaning of each parameter.

---

## Summary Table

| ID | Severity | Location | Title |
|----|----------|----------|-------|
| A07-1 | LOW | `bleinputhandler.h` lines 20–28 | No doc comments on any `BleInputHandler` public methods |
| A07-2 | LOW | `bleinputhandler.h` line 18 | `DigitalFormat` enum values undocumented |
| A07-3 | LOW | `bleinputhandler.h` line 26 | `updateIdleTimer()` input-source encoding undocumented in header |
| A07-4 | MEDIUM | `bleinputhandler.h` line 28 | `digitalInputs()` output format and `autoReset` side-effect invisible |
| A07-5 | LOW | `canexpansion.h` lines 42–74 | No doc comments on any `CanExpansion` public methods |
| A07-6 | LOW | `canexpansion.h` lines 25–40 | `ShockEvent` struct fields undocumented (units and encoding) |
| A07-7 | LOW | `canexpansion.h` line 72 | `generateShockMessage()` preconditions and return semantics undocumented |
| A07-8 | LOW | `canexpansion.h` line 70 | `shockEvent()` missing precondition (empty-queue UB) |
| A07-9 | INFO | `canexpansion.h` lines 46–50, 52, 57, 64, 69 | Inline getters lack doc comments |
| A07-10 | LOW | `bleinputhandler.h` lines 31–32; `canexpansion.h` lines 77–84 | Signals carry no documentation |

**Totals:** 1 MEDIUM, 7 LOW, 1 INFO
