# Pass 3 Agent A13 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `platform/canbus.h` (80 lines)
- `platform/canbus.cpp` (295 lines)
- `platform/gnssreceiver.h` (93 lines)
- `platform/gnssreceiver.cpp` (455 lines)

---

## Reading Evidence

### canbus.h / canbus.cpp

**Class:** `EM070::CanBus` (inherits `QObject`)

**Enum defined:**

| Name | Line (header) | Values |
|------|--------------|--------|
| `CanDeviceId` | 16 | `CAN2 = 0`, `CAN1 = 1` |

**Struct defined:**

| Name | Line (header) | Fields |
|------|--------------|--------|
| `Request` | 18–23 | `QCanBusFrame frame`, `quint32 interval`, `qint32 timer` |

**Public methods — header line numbers:**

| Line | Declaration |
|------|-------------|
| 25 | `explicit CanBus(CanDeviceId id = CAN1, QObject *parent = nullptr)` |
| 26 | `~CanBus()` |
| 28 | `void initialize()` |
| 30 | `void setXferEnabled(bool enable)` |
| 31 | `bool isXferEnabled() const` (inline) |
| 33 | `void setPower(bool on)` |
| 34 | `bool isEnabled() const` (inline) |
| 36 | `bool setBaudRate(int baudRate)` |
| 37 | `int baudRate() const` (inline) |
| 39 | `void addRequest(quint32 id, const QByteArray &ba, quint32 interval)` |
| 40 | `QList<Request> getRequests()` (inline) |
| 41 | `void clearRequests()` |
| 43 | `void addFilter(quint32 identifier)` |
| 44 | `void clearFilters()` |
| 45 | `void applyFilters()` |
| 47 | `void writeFrameDirect(quint32 id, const QByteArray &ba)` |
| 49 | `void removeRequests(quint32 id)` |

**Protected methods:**

| Line | Declaration |
|------|-------------|
| 58 | `void sendRequest()` |

**Signals:**

| Line | Name | Signature |
|------|------|-----------|
| 54 | `error` | `void error(QCanBusDevice::CanBusError canBusError)` |
| 55 | `read` | `void read(quint32 identifier, const QByteArray &ba)` |

**Macro constants (canbus.cpp):**

| Name | Value | Meaning |
|------|-------|---------|
| `REQUEST_TIMER` | 100 | Timer interval in ms between CAN send attempts |
| `CANBUS_DEBUG` | 0 | Debug logging toggle (compile-time) |

---

### gnssreceiver.h / gnssreceiver.cpp

**Class:** `EM070::GnssReceiver` (inherits `QObject`)

**Macro constant (header):**

| Name | Value | Meaning |
|------|-------|---------|
| `MAX_POINTS` | 8 | Maximum number of GPS path waypoints stored |

**Macro constants (gnssreceiver.cpp):**

| Name | Value | Meaning |
|------|-------|---------|
| `FILE_GNSS_PORT` | `/dev/ttyUSB1` | Default serial port for GNSS on ARM |
| `EARTH_R` | 6371000UL | Earth radius in metres |

**Public methods — header line numbers:**

| Line | Declaration |
|------|-------------|
| 17 | `explicit GnssReceiver(QObject *parent = nullptr)` |
| 18 | `void portStateChanged(bool open)` |
| 19 | `void reset()` |
| 20 | `void changeUpdateTime()` |
| 22 | `quint8 satelliteCount() const` (inline) |
| 23 | `qint32 latitude() const` (inline) |
| 24 | `qint32 longitude() const` (inline) |
| 25 | `qint32 lastLatitude() const` (inline) |
| 26 | `qint32 lastLongitude() const` (inline) |
| 27 | `qint16 speed() const` (inline) |
| 28 | `qint16 course() const` (inline) |
| 29 | `quint32 distance() const` (inline) |
| 30 | `quint32 sumOfDistance() const` (inline) |
| 31 | `quint32 altitude() const` (inline) |
| 32 | `bool locked() const` (inline) |
| 33 | `quint32 hpe() const` (inline, with embedded comment) |
| 34 | `quint32 hdop() const` (inline) |
| 35 | `qint64 age()` |
| 36 | `quint8 warn() const` (inline) |
| 37 | `void setWarn(quint8 n)` (inline) |
| 38 | `quint8 quality() const` (inline) |
| 39 | `void setQuality(quint8 n)` (inline) |
| 40 | `quint16 markerCnt() const` (inline) |
| 41 | `void setMarkerCnt(quint16 n)` (inline) |
| 42 | `quint32 pathLatitude(int n)` |
| 43 | `void setPathLatitude(int n, quint32 lat)` |
| 44 | `quint32 pathLongitude(int n)` |
| 45 | `void setPathLongitude(int n, quint32 lon)` |
| 46 | `void gpsDebugPrint()` |
| 47 | `bool inPoly2(const CIGCONF::gpsPosStruct *gpsPos, const CIGCONF::polygonStruct *polygon)` |
| 48 | `bool pointInPolygon(int polyCorners, CIGCONF::position me, CIGCONF::position *points)` |
| 49 | `double degrees2radians(double degrees)` |

**Protected methods:**

| Line | Declaration |
|------|-------------|
| 51 | `void timerEvent(QTimerEvent *)` |

**Signals:**

| Line | Name | Signature |
|------|------|-----------|
| 54 | `sendGmtpMessage` | `void sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra = QByteArray())` |

---

## Documentation Audit

### Documentation present per method

The following table records whether any doc comment exists above each public declaration in the header, and whether it is accurate.

#### CanBus (canbus.h)

| Method | Has Doc Comment | Comment Text / Location | Accurate? | Params/Return Described? |
|--------|----------------|------------------------|-----------|--------------------------|
| `CanBus()` constructor | Inline only — `// if m_canBusDevice allocated in constructor, it can't moveToThread` is on `initialize()`, not the constructor | No comment on constructor itself | N/A | No |
| `~CanBus()` | No | — | N/A | No |
| `initialize()` | Partial — inline trailing comment `// if m_canBusDevice allocated in constructor, it can't moveToThread` | Partially accurate (explains the deferred-allocation design decision) but is a single trailing remark, not a proper doc comment; does not describe behaviour on second call (idempotent) | Partially | No |
| `setXferEnabled(bool)` | No | — | N/A | No |
| `isXferEnabled() const` | No | — | N/A | No |
| `setPower(bool on)` | No | — | N/A | No |
| `isEnabled() const` | No | — | N/A | No |
| `setBaudRate(int)` | No | — | N/A | No |
| `baudRate() const` | No | — | N/A | No |
| `addRequest(quint32, QByteArray&, quint32)` | No | — | N/A | No |
| `getRequests()` | No | — | N/A | No |
| `clearRequests()` | No | — | N/A | No |
| `addFilter(quint32)` | No | — | N/A | No |
| `clearFilters()` | No | — | N/A | No |
| `applyFilters()` | No | — | N/A | No |
| `writeFrameDirect(quint32, QByteArray&)` | No | — | N/A | No |
| `removeRequests(quint32)` | No | — | N/A | No |
| `sendRequest()` (protected) | No | — | N/A | No |
| Signal: `error` | No | — | N/A | No |
| Signal: `read` | No | — | N/A | No |

#### GnssReceiver (gnssreceiver.h)

| Method | Has Doc Comment | Comment Text / Location | Accurate? | Params/Return Described? |
|--------|----------------|------------------------|-----------|--------------------------|
| `GnssReceiver()` constructor | No | — | N/A | No |
| `portStateChanged(bool)` | No | — | N/A | No |
| `reset()` | No | — | N/A | No |
| `changeUpdateTime()` | No | — | N/A | No |
| `satelliteCount()` through `locked()` (8 simple getters) | No | — | N/A | No |
| `hpe()` | Inline trailing comment: `// Convert HDOP to 68% (1 stddev) accuracy. LE910C1 accuracy is 0.8m.` | Present and accurate for the formula intent, but inaccurate about the units returned (returns a `quint32` expressing metres, not described). The formula `m_hdop*0.8/(2.0*100.0)` produces a value in metres CEP but the `qRound` and integer cast suppress fractional precision — this is not mentioned. | Partially accurate | No — return unit not stated |
| `hdop()` | Private field comment `// (0.5~99.9) * 100` is on the member variable, not the accessor | Explains the encoding scale but is on the data member, not the getter declaration | N/A | No |
| `age()` | No | — | N/A | No |
| `warn()` / `setWarn()` | No | — | N/A | No |
| `quality()` / `setQuality()` | No | — | N/A | No |
| `markerCnt()` / `setMarkerCnt()` | No | — | N/A | No |
| `pathLatitude(int n)` | `/** @brief GnssReceiver::pathLatitude @param n @return */` (in .cpp, lines 365–368) | Stub-only: `@param n` and `@return` have no descriptions whatsoever | Not useful | No — param and return are blank |
| `setPathLatitude(int n, quint32 lat)` | `/** @brief GnssReceiver::setPathLatitude @param n @param lat */` (in .cpp, lines 376–379) | Stub-only | Not useful | No |
| `pathLongitude(int n)` | `/** @brief GnssReceiver::pathLongitude @param n @return */` (in .cpp, lines 386–389) | Stub-only | Not useful | No |
| `setPathLongitude(int n, quint32 lon)` | `/** @brief GnssReceiver::setPathLongitude @param n @param lon */` (in .cpp, lines 397–400) | Stub-only | Not useful | No |
| `gpsDebugPrint()` | `/** @brief GnssReceiver::gpsDebugPrint */` (in .cpp, line 407–408) | Stub-only | Not useful | No |
| `inPoly2(...)` | No | — | N/A — **no implementation exists** | No |
| `pointInPolygon(...)` | No | — | N/A | No |
| `degrees2radians(double)` | No | — | N/A | No |
| Signal: `sendGmtpMessage` | No | — | N/A | No |

---

## Findings

**A13-1** · INFO · No doc comments on any `CanBus` public methods
**Description:** The `CanBus` class (platform/canbus.h) has 17 public methods, one protected method, and two signals. None has any form of doc comment. The only comment present is a single trailing inline remark on `initialize()` (`// if m_canBusDevice allocated in constructor, it can't moveToThread`) which explains an implementation constraint but does not describe the method's contract. For simple getters (`isXferEnabled`, `isEnabled`, `baudRate`) the absence of comments is a minor issue.
**Fix:** Add at minimum a one-line description above each non-trivial public method. Getters may remain undocumented if their names are fully self-explaining.

---

**A13-2** · LOW · Missing doc comment on `CanBus::initialize()`
**Description:** `initialize()` has a non-trivial contract: it must be called after construction (before the object is moved to a thread), it is idempotent (silently returns if `m_canBusDevice` is already allocated), and failure to call it leaves the bus permanently inoperative. None of this is documented. The single trailing inline comment explains only the threading constraint. Callers have no indication that the method is idempotent or that omitting it is a silent failure.
**Fix:** Add a doc comment above the declaration in canbus.h explaining: (1) that it must be called before use, (2) that it is idempotent, and (3) what happens on device creation failure.

---

**A13-3** · LOW · Missing doc comment on `CanBus::setPower(bool)`
**Description:** `setPower` performs several non-obvious side effects: it silently forces `on = false` when `m_baudRate <= 0`; it executes `ifconfig` and a proprietary `ip link` command via `QProcess`, writing to two GPIO sysfs paths; and it connects or disconnects the `QCanBusDevice`. None of this is documented. A caller who passes `true` without first calling `setBaudRate` will not achieve the expected result and will receive no error.
**Fix:** Document the pre-condition (baud rate must be set), the side-effect of bringing the network interface up/down, and the GPIO pin manipulation.

---

**A13-4** · LOW · Missing doc comment on `CanBus::applyFilters()`
**Description:** `applyFilters()` silently does nothing when `m_canBusDevice` is null. It also deduplicates filter IDs internally, which is a meaningful behaviour callers should know about. Additionally, it inspects bit 29 of the identifier to determine whether to apply an extended-format filter with a different mask (`0x3ffff00`) versus a base-format filter (`0x3ff`). This bit-field protocol is not documented anywhere in the header.
**Fix:** Document the null-device early return, the deduplication, and the bit-29 convention for extended-frame identifiers.

---

**A13-5** · LOW · Missing doc comment on `CanBus::addRequest()`
**Description:** `addRequest` silently auto-detects extended frame format (sets extended format if `id > 0x7ff`). The `interval` parameter is in milliseconds (governed by `REQUEST_TIMER = 100 ms`), but this is not stated. Setting `interval = 0` is a valid way to enqueue a one-shot frame (the scheduler only counts down when `request.interval != 0`), but this is undocumented.
**Fix:** Document the auto-detection of extended frame format, the unit of `interval`, and the meaning of `interval = 0`.

---

**A13-6** · LOW · Missing doc comment on `CanBus::writeFrameDirect()`
**Description:** `writeFrameDirect` bypasses the request queue and sends immediately, but only when `m_xferEnabled` is true. If `m_xferEnabled` is false the frame is silently discarded with no error or return value. This silent discard on a write call is a significant contract detail that is completely undocumented.
**Fix:** Document that the method is a direct (queue-bypassing) write, that it silently discards the frame if transfer is disabled, and that no error is reported.

---

**A13-7** · INFO · `CanBus` signal names are ambiguous — no doc comments
**Description:** The signal `read(quint32 identifier, const QByteArray &ba)` uses the name `read`, which shadows the common Qt/C++ concept of a read operation but gives no indication of what triggered it (frame received from bus). The signal `error(QCanBusDevice::CanBusError)` is similarly bare. Neither signal has a doc comment. While the parameter types partially convey meaning, the rate-limiting behaviour in `handleError` (suppresses repeated reports within 10 seconds) is invisible to slots connected to `error`.
**Fix:** Add doc comments to both signals describing when they are emitted and, for `error`, noting the 10-second suppression window.

---

**A13-8** · LOW · Missing doc comment on `GnssReceiver::portStateChanged(bool)`
**Description:** `portStateChanged` is the primary lifecycle method that opens/closes the serial port and starts/stops the internal timer. When `open = true` it opens the port, clears buffers, and starts a timer whose period comes from `gCfg->gpsUpdateTime()`. When `open = false` it closes the port and stops the timer. None of this is documented, including the dependency on the global config object.
**Fix:** Document both branches, the timer start/stop behaviour, and the dependency on `gCfg->gpsUpdateTime()`.

---

**A13-9** · LOW · Missing doc comment on `GnssReceiver::changeUpdateTime()`
**Description:** `changeUpdateTime()` kills the existing timer but contains a commented-out line that would restart it with the new period (`//m_timerId = startTimer(gCfg->gpsUpdateTime() * 1000)`). The method therefore currently does nothing useful beyond stopping updates permanently. This silent, incomplete behaviour is not documented at all. A caller invoking this method to change the update rate will inadvertently stop GPS reporting entirely.
**Fix:** At minimum document the current (broken) behaviour. The commented-out restart line should be either restored or removed, and the method's intent should be stated clearly.

---

**A13-10** · LOW · Missing doc comment on `GnssReceiver::reset()`
**Description:** `reset()` zeroes all position, speed, distance, and state fields. It is called from the constructor and may be called externally to reinitialise the receiver mid-operation. The scope of what is reset — notably that `m_positionValid`, `m_satelliteCount`, and `m_locked` are all cleared — is not documented. Callers need to know this will trigger the "location acquired" log path again on next valid fix.
**Fix:** Document that `reset()` clears all accumulated position and distance data and that `m_positionValid` is set to false, which will cause a new "location acquired" event to be emitted.

---

**A13-11** · MEDIUM · Stub-only Doxygen comments on `pathLatitude`, `pathLongitude`, `setPathLatitude`, `setPathLongitude`, `gpsDebugPrint` give no information
**Description:** Five methods in gnssreceiver.cpp have `/** @brief ... @param n @return */` Doxygen blocks where every tag is present but contains no text. Examples:
```cpp
/**
 * @brief GnssReceiver::pathLatitude
 * @param n
 * @return
 */
```
These comments are syntactically valid Doxygen but are informationally empty — they are worse than no comment because they create the false appearance of documentation. For `pathLatitude(int n)` and `pathLongitude(int n)` there is a meaningful bound check (`if((n < MAX_POINTS) && (n > -1))`) and an out-of-range fallback return of `0` that is not described. For the setter variants, writing to an out-of-range index is silently ignored, which is also not described.
**Fix:** Fill in the `@brief`, `@param`, and `@return` fields with real content. For `pathLatitude`/`pathLongitude`, document the valid range of `n` (0 to `MAX_POINTS - 1`) and the `0` return on out-of-range. For setters, document the silent no-op on out-of-range input.

---

**A13-12** · MEDIUM · `GnssReceiver::hpe()` inline comment is partially inaccurate
**Description:** The inline comment on `hpe()` (gnssreceiver.h, line 33) reads:
```cpp
// Convert HDOP to 68% (1 stddev) accuracy. LE910C1 accuracy is 0.8m.
```
The formula is `qRound((double)m_hdop * 0.8 / (2.0 * 100.0))`. `m_hdop` is stored as HDOP × 100 (per the member variable comment `// (0.5~99.9) * 100`), so the actual computation is `HDOP × 0.8 / 2.0` metres, rounded to the nearest integer metre. The comment says "68% (1 stddev)" but the divisor of 2 in the formula corresponds to 50th-percentile CEP, not 68th-percentile (1σ). The two conventions differ by approximately 1.2×. The comment therefore misrepresents the statistical confidence level of the output. Additionally, the return unit (metres, integer) is not stated.
**Fix:** Correct the statistical claim: the divisor of 2.0 yields a CEP (50th percentile) estimate, not 1σ (68%). If 68% accuracy is intended, the divisor should be approximately 1.67. State the return unit (integer metres).

---

**A13-13** · HIGH · `GnssReceiver::inPoly2()` is declared but has no implementation and no documentation
**Description:** `inPoly2(const CIGCONF::gpsPosStruct *gpsPos, const CIGCONF::polygonStruct *polygon)` is declared as a public method in gnssreceiver.h (line 47) but has no corresponding definition anywhere in the codebase. A search of the entire repository confirms only the single declaration. Any translation unit that calls this method will produce an unresolved-symbol linker error. The method name suggests it is a geofence point-in-polygon test — directly safety-critical for fleet tracking. There is no doc comment, no rationale, and no indication of whether this is intentionally stubbed, accidentally omitted, or a dead placeholder.
**Fix:** Either (1) provide a correct implementation with full documentation of parameters and return value, or (2) remove the declaration if the method is no longer intended. Do not leave an unimplemented safety-critical function silently in a public API.

---

**A13-14** · LOW · Missing doc comment on `GnssReceiver::pointInPolygon()`
**Description:** `pointInPolygon` implements a ray-casting (Jordan curve) algorithm to determine whether a GPS coordinate is inside a polygon. This is a security- and safety-relevant method (geofence enforcement). The algorithm has a known edge-case limitation: points exactly on a polygon edge can produce unpredictable results. There is a single inline comment `//oddNodes = 1 means within the polygon, oddNodes = 0 outside the polygon.` inside the function body, but no doc comment above the declaration in the header. The coordinate system (radian-space, not degree-space), parameter ownership of `points`, and the edge-case behaviour are not documented.
**Fix:** Add a doc comment above the declaration describing: the algorithm (ray-casting), the coordinate space expected (radian-space `latrad`/`lonrad` fields of `CIGCONF::position`), the edge-case limitation, and the meaning of the return value.

---

**A13-15** · LOW · Missing doc comment on `GnssReceiver::degrees2radians()`
**Description:** `degrees2radians` is a simple utility function but its presence in the public interface of a `QObject` subclass without any documentation means callers have no indication of expected input range or precision. It is trivially self-evident, so this is low severity.
**Fix:** Either move it to a private or static utility scope, or add a minimal one-line doc comment.

---

**A13-16** · LOW · Missing doc comment on `GnssReceiver::age()`
**Description:** `age()` returns the time in milliseconds since the last valid NMEA sentence was parsed, computed from `QDateTime::currentMSecsSinceEpoch() - m_timestamp`. The return value is clamped to `0` for negative results (which would occur before the first fix). The unit (milliseconds) is not stated, the clamping behaviour is not documented, and the initial state (`m_timestamp` is uninitialised in the reset path — `reset()` does not zero `m_timestamp`) is not addressed.
**Fix:** Document the return unit (milliseconds), the zero-clamp for pre-first-fix state, and note that `m_timestamp` is not reset by `reset()`.

---

**A13-17** · MEDIUM · `GnssReceiver::age()` — `m_timestamp` not initialised by `reset()`, undocumented
**Description:** `reset()` (gnssreceiver.cpp, lines 192–210) zeroes all position and state fields but does not initialise `m_timestamp`. `m_timestamp` is first set during `parseData` when a valid GPRMC sentence is received (line 168). If `age()` is called before the first valid fix, `m_timestamp` contains an uninitialised or stale value, causing `age()` to return an arbitrary large number (which is then clamped to 0 only if negative). This is a documentation deficiency compounded by a latent bug: the negative-clamp guard protects against future timestamps but not against a very large stale positive value that would make the data appear fresh when it is not. Neither the initialisation gap nor the clamping logic is documented.
**Fix:** Document that `age()` is unreliable before the first valid fix, and separately fix the initialisation by setting `m_timestamp = 0` in `reset()` and updating the clamp condition to also handle the zero case.

---

## Summary Table

| ID | Severity | Title | Location |
|----|----------|-------|----------|
| A13-1 | INFO | No doc comments on any `CanBus` public methods | `platform/canbus.h` (all public methods) |
| A13-2 | LOW | Missing doc comment on `CanBus::initialize()` | `platform/canbus.h:28` |
| A13-3 | LOW | Missing doc comment on `CanBus::setPower()` | `platform/canbus.h:33` |
| A13-4 | LOW | Missing doc comment on `CanBus::applyFilters()` | `platform/canbus.h:45` |
| A13-5 | LOW | Missing doc comment on `CanBus::addRequest()` | `platform/canbus.h:39` |
| A13-6 | LOW | Missing doc comment on `CanBus::writeFrameDirect()` | `platform/canbus.h:47` |
| A13-7 | INFO | `CanBus` signals undocumented; `error` suppression window invisible | `platform/canbus.h:54–55` |
| A13-8 | LOW | Missing doc comment on `GnssReceiver::portStateChanged()` | `platform/gnssreceiver.h:18` |
| A13-9 | LOW | Missing doc comment on `GnssReceiver::changeUpdateTime()` — method silently broken | `platform/gnssreceiver.h:20` |
| A13-10 | LOW | Missing doc comment on `GnssReceiver::reset()` | `platform/gnssreceiver.h:19` |
| A13-11 | MEDIUM | Stub-only Doxygen blocks on five methods — informationally empty | `platform/gnssreceiver.cpp:365–408` |
| A13-12 | MEDIUM | `hpe()` comment claims 68% (1σ) accuracy but formula computes CEP (50th pct) | `platform/gnssreceiver.h:33` |
| A13-13 | HIGH | `inPoly2()` declared, no implementation anywhere, no documentation | `platform/gnssreceiver.h:47` |
| A13-14 | LOW | Missing doc comment on safety-critical `pointInPolygon()` | `platform/gnssreceiver.h:48` |
| A13-15 | LOW | Missing doc comment on `degrees2radians()` | `platform/gnssreceiver.h:49` |
| A13-16 | LOW | Missing doc comment on `age()` — unit and clamping undocumented | `platform/gnssreceiver.h:35` |
| A13-17 | MEDIUM | `m_timestamp` not initialised by `reset()`; `age()` unreliable before first fix, undocumented | `platform/gnssreceiver.cpp:192–210`, `448–455` |

**Totals:** 2 HIGH, 3 MEDIUM, 10 LOW, 2 INFO
