# Pass 3 Agent A20 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `ui/checkstartdialog.h` + `ui/checkstartdialog.cpp`
- `ui/commentdialog.h` + `ui/commentdialog.cpp`
- `ui/dialog.h` + `ui/dialog.cpp`

---

## Reading Evidence

### `ui/checkstartdialog.h` / `ui/checkstartdialog.cpp`

**Class:** `CheckStartDialog` (extends `QDialog`)

**Public methods:**

| Line (header) | Method | Doc comment present? |
|---|---|---|
| 15 | `explicit CheckStartDialog(QWidget *parent = 0)` | No |
| 16 | `~CheckStartDialog()` | No |
| 17 | `void setMandatory(bool mandatory)` | No |
| 18 | `void languageChanged(void)` | No |

**Signals:** None declared.

**Slots:** None declared (uses `QDialog::accept` directly via `connect`).

**Types, enums, constants:** None.

**Implementation notes:**
- `setMandatory(bool mandatory)`: Shows/hides two UI label widgets (`labelTip12` for optional, `labelTip21` for mandatory) to change the on-screen message that precedes the pre-op safety check start prompt. This has a direct safety implication — it controls whether the operator sees "optional" or "mandatory" wording before a pre-op check.
- `languageChanged()`: Updates all translatable strings in the dialog.

---

### `ui/commentdialog.h` / `ui/commentdialog.cpp`

**Class:** `CommentDialog` (extends `QDialog`)

**Public methods:**

| Line (header) | Method | Doc comment present? |
|---|---|---|
| 26 | `explicit CommentDialog(CommentDialogType type, QWidget *parent = nullptr)` | No |
| 27 | `~CommentDialog()` | No |
| 29 | `void UpdateTextInput(QString str, onScreenKeyboard::CtrlButton ctrl)` | No |
| 30 | `void onkeyboardClosed()` | No |
| 31 | `void onUnlkReasonSelected()` | No |
| 32 | `void languageChanged()` | No |

**Signals:** None explicitly declared (inherits `QDialog::accepted` / `QDialog::rejected`).

**Private slots:**
- `run_keyboard_lineEdit()` (line 51)
- `onDone()` (line 52)
- `onSkip()` (line 53)

**Protected overrides:**
- `showEvent(QShowEvent *event = 0)` (line 47)
- `hideEvent(QHideEvent *)` (line 48)

**Types, enums, constants:**
- `enum CommentDialogType { Unlock, Preop }` (line 15) — no doc comment
- `#define NO_ACTIVITY_TIME 10000` (line 12) — no doc comment (units are milliseconds; value is 10 seconds inactivity timeout)
- `#define MAX_CHARACTER 100` (line 13) — no doc comment (maximum text input length)

**Implementation notes:**
- Constructor takes a `CommentDialogType` to configure the dialog for either unlock-reason or pre-op comment entry.
- `UpdateTextInput` is called by the on-screen keyboard to insert or delete characters; it enforces `MAX_CHARACTER` limit.
- `onkeyboardClosed()` is called as a signal handler to reconnect the selection-changed signal after the keyboard closes; it is declared `public` but functions as an event sink.
- `onUnlkReasonSelected()` is called when the user picks a reason from the `UnlockReasonDialog` dropdown and copies the selected text into the text box; declared `public` but functions as a slot.
- `onDone()` and `onSkip()` implement a two-tap confirm pattern and a 200 ms debounce. `onDone` persists the unlock reason or pre-op comment string to `gCfg` before accepting. `onSkip` clears the stored strings and rejects.
- `reset()`: Resets `m_lastPress` to zero and re-runs `showEvent()` after the `NO_ACTIVITY_TIME` inactivity timer fires.

---

### `ui/dialog.h` / `ui/dialog.cpp`

**Class:** `Dialog` (extends `QDialog`) — central UI orchestrator for the entire application.

**Public methods:**

| Line (header) | Method | Doc comment present? |
|---|---|---|
| 44 | `explicit Dialog(QWidget *parent = 0)` | No |
| 45 | `~Dialog()` | No |
| 47 | `void onPowerChanged(CIGCONF::PowerState powerState)` | No |
| 48 | `void onReboot()` | No |
| 49 | `void onBleReady(bool yes)` | No |
| 50 | `void onNetworkReady(bool yes)` | No |
| 51 | `void onCardAuthorised(bool yes, quint64)` | No |
| 52 | `void onCmdLogin(quint64 id)` | No |
| 53 | `void onIdleTimeout()` | No |
| 54 | `void lockScreen(CIGCONF::MaintLockedCode code, bool remote)` | No |
| 55 | `void ambertImpactScreen()` (note: typo — "ambert") | No |
| 57 | `void updateLux(int lux)` | No |
| 58 | `void updateStatus(QByteArray IO, bool Rly1, bool Rly2, QByteArray can, const QByteArray &rssi, const QByteArray &moni, bool netStat, bool modemStat, bool wifiStat, qint8 sat, qint32 lat, qint32 lon)` | No |
| 59 | `void updateBatteryStatus(bool avail, int state, int fault, quint16 voltage, qint16 current, quint16 temp, quint16 remainingCapacity)` | No |
| 60 | `void updateExpModInfo(QByteArray mainVersion)` | No |
| 61 | `void onBroadcastMsgReceived(CIGCONF::BroadcastMessage m)` | No |
| 62 | `void showInformationScreen()` | No |
| 63 | `void updateLoginImage()` | No |
| 64 | `void quickPowerUpdate(bool on)` | No |
| 66 | `void onDemandStarted(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src)` | No |
| 67 | `void onDemandExtended(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src)` | No |
| 68 | `void onDemandEnded(quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc src)` | No |
| 70 | `void onLanguageChanged(void)` | No |
| 72 | `void updateCamera()` | No |

Total public methods (excluding constructor/destructor): 23.

**Signals (lines 79–89):**

| Line | Signal | Doc comment present? |
|---|---|---|
| 79 | `void driverChanged(quint64 id)` | No |
| 80 | `void lastCheckDriverChanged(quint64 id)` | No |
| 81 | `void screenLocked(CIGCONF::MaintLockedCode code)` | No |
| 82 | `void setRelayOut(bool on1, bool on2)` | No |
| 83 | `void setRelay2Out(bool on)` | No |
| 84 | `void sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra = QByteArray())` | No |
| 85 | `void resetCanStates(bool resetLast)` | No |
| 86 | `void forceBroadcastUIClose()` | No |
| 87 | `void log(QByteArray &msg)` | No |
| 88 | `void updatePreopTimer(QString timeout)` | No |
| 89 | `void amberDialogAboutToShow(bool isLocked)` | No |

Total signals: 11. None have doc comments.

**Types, enums, constants defined:** None directly in `dialog.h` (all referenced types are from `app/globalconfigs.h` and other headers).

**Private struct:**
- `BroadcastMessageResponse { quint32 id; quint64 driverId; quint32 dispTimestamp; }` — no doc comment.

**Key implementation notes for safety/security-critical public methods:**
- `lockScreen(CIGCONF::MaintLockedCode code, bool remote)`: Controls vehicle lock/unlock state. When `code != MaintNormal`, sets `m_locked = true`, opens the locked dialog, de-asserts relay 2, and emits `screenLocked`. When `code == MaintNormal` and `remote == true` and already locked, performs logout and clears the lock state. Skips locking if a power-off/reboot message is displayed or if convor status is active.
- `onCardAuthorised(bool yes, quint64 id)`: Processes the authorisation response from the server. Only acts if the pending message type is `WaitForAuthorised` and the ID matches the pending driver. Grants access (`openMenuDialog`) or sets `NotAuthorised`.
- `onCmdLogin(quint64 id)`: Simulates a card swipe by forwarding to `onCardSwiped` with `beep = false`; allows remote command login.
- `onIdleTimeout()`: Clears all UI widgets, logs an idle timeout GMTP message, optionally locks the screen (`MaintIdle`), and logs out the driver.
- `quickPowerUpdate(bool on)`: Directly gates card-reading capability by setting `m_power`; if `m_power == false`, `onCardSwiped` returns immediately without processing.
- `onDemandStarted/Extended/Ended`: Manage a timed vehicle access window; emit GMTP messages and mutate `gCfg` on-demand state.
- `setRelayOut(bool on1, bool on2)` (signal): Controls physical output relays that gate vehicle power/start.

---

## Findings

**A20-1** · HIGH · No documentation on any `Dialog` public method

**Description:** The `Dialog` class is the central UI orchestrator of the entire application. It exposes 23 public methods and 11 signals, none of which have any form of doc comment in the header. Several of these methods have direct safety and security implications: `lockScreen` controls the physical vehicle lock state and relay outputs; `onCardAuthorised` processes driver authorisation results; `onCmdLogin` accepts a remote login command; `quickPowerUpdate` gates whether card swipes are processed; and the relay signals `setRelayOut`/`setRelay2Out` directly control hardware that enables vehicle operation. The absence of documentation makes it impossible to verify intended preconditions, parameter semantics, or expected caller behaviour from the header alone.

**Fix:** Add a doc comment above every public method declaration in `ui/dialog.h`. At minimum, describe: (1) the purpose of the method; (2) the meaning and valid range of each parameter; (3) any preconditions or state the caller must ensure; (4) what side-effects or signals are emitted as a result. For safety-critical methods (`lockScreen`, `onCardAuthorised`, `onCmdLogin`, `quickPowerUpdate`, relay signals), include explicit notes about security boundaries and failure modes.

---

**A20-2** · HIGH · No documentation on `Dialog` signals

**Description:** All 11 signals emitted by `Dialog` are undocumented. These signals cross the boundary between the UI layer and the application/hardware layer: `setRelayOut` and `setRelay2Out` control physical vehicle relays; `sendGmtpMessage` sends protocol messages over the communications stack; `screenLocked` propagates lock-state changes to subscribers; `driverChanged` and `lastCheckDriverChanged` notify subscribers of driver identity changes. Without documentation, callers cannot determine the sequence in which signals are expected to fire, what state invariants hold when they fire, or whether they may fire from non-main threads.

**Fix:** Add a doc comment above each signal in `ui/dialog.h` describing: what event triggers the signal; what each parameter represents; whether the signal is guaranteed to fire on the main/GUI thread; and any ordering constraints relative to other signals.

---

**A20-3** · HIGH · No documentation on `lockScreen` — safety-critical access-control method

**Description:** `lockScreen(CIGCONF::MaintLockedCode code, bool remote)` is the single entry point that transitions the device between locked and unlocked physical states. Its behaviour is non-trivial and non-obvious: the `remote` parameter changes the method's logic significantly (a remote `MaintNormal` lock triggers a full logout; a local `MaintNormal` code is silently ignored if the device is not already locked). The conditions under which locking is suppressed (active power-off message, convor status active) are invisible to callers reading only the header. A maintenance engineer reading the header cannot determine safe calling conventions.

**Fix:** Document `lockScreen` with: the meaning of `code` (reference the `CIGCONF::MaintLockedCode` enum values and their effect); the meaning of `remote` (remote vs local trigger path, and how it affects `MaintNormal` handling); the conditions under which the call is a no-op; which signals are emitted as a result; and any preconditions (e.g. must be called from the main thread).

---

**A20-4** · HIGH · No documentation on `onCmdLogin` — remote login entry point

**Description:** `onCmdLogin(quint64 id)` accepts a driver ID from an external command source and directly invokes the card-swipe login path (`onCardSwiped`) with the beeper suppressed. There is no documentation indicating: the source of the `id`; whether the `id` has been validated or sanitised by the caller; what authentication or authorisation checks are applied; or what happens if the device is in a locked state when the command arrives. The method's public visibility means it is part of the class's contract surface, yet it performs security-relevant actions without any explanatory text.

**Fix:** Document the caller contract: specify who may call this method (e.g. GMTP command handler); state whether `id` is expected to be a pre-validated identifier; clarify that the same `isValidId` / authorisation flow as a physical card swipe is applied; and note that no beep is emitted.

---

**A20-5** · HIGH · No documentation on `setRelayOut` / `setRelay2Out` signals — hardware control

**Description:** `setRelayOut(bool on1, bool on2)` and `setRelay2Out(bool on)` are signals that, when connected in the application, directly control physical output relays governing vehicle power or start circuits. They are emitted from multiple call sites inside `Dialog` with varying `on1`/`on2` values (e.g. `(true, false)` during checklist, `(true, true)` after authorisation, `(false, false)` on logout or lock). There is no documentation explaining what relay 1, relay 2, or the second relay-only signal control in hardware terms, nor any description of the safety implications of incorrect emission.

**Fix:** Document each signal to explain what physical output each boolean controls, what the safe default state is, and under what application conditions each relay should be asserted or de-asserted.

---

**A20-6** · MEDIUM · `onkeyboardClosed` and `onUnlkReasonSelected` declared public but function as internal event sinks

**Description:** In `ui/commentdialog.h`, `onkeyboardClosed()` (line 30) and `onUnlkReasonSelected()` (line 31) are declared `public`. Both are wired up solely via `connect()` in the constructor and are never intended to be called directly by external code. Their public visibility is misleading — a caller may attempt to invoke them directly, which would reconnect a signal/slot pair that should only be reconnected once the keyboard closes, or copy the selected unlock reason value at an unexpected time. No documentation warns against direct invocation.

**Fix:** Move `onkeyboardClosed` and `onUnlkReasonSelected` to `private slots:` (they are already effectively slots). If the public visibility is required for the `connect` call, add a comment explaining the coupling. At minimum, add a doc comment on each stating "Do not call directly; connected as a signal handler."

---

**A20-7** · MEDIUM · `CommentDialogType` enum and `NO_ACTIVITY_TIME` / `MAX_CHARACTER` macros are undocumented

**Description:** The `CommentDialogType` enum (`Unlock`, `Preop`) at line 15 of `commentdialog.h` controls whether the dialog collects an unlock reason (persisted to `gCfg->unlkReasonString`) or a pre-op comment (persisted to `gCfg->preopCommentString`). The distinction affects which GMTP messages are sent and whether the "real impact" buttons are shown. The macros `NO_ACTIVITY_TIME` (10000 ms inactivity before reset) and `MAX_CHARACTER` (100 character input limit) impose security-relevant constraints with no explanation. Without documentation, a developer modifying the timeout or character limit may not appreciate the downstream effects.

**Fix:** Add a brief comment above the `CommentDialogType` enum explaining the two modes. Add inline comments on the macros explaining their units (`NO_ACTIVITY_TIME` is in milliseconds) and the rationale for the chosen values (e.g. why 100 characters, why 10 seconds).

---

**A20-8** · LOW · `setMandatory` in `CheckStartDialog` is undocumented

**Description:** `setMandatory(bool mandatory)` (line 17 of `checkstartdialog.h`) controls whether the pre-op check start dialog displays "optional" or "mandatory" text to the operator. This has a direct operator-facing safety implication: showing the wrong label may cause an operator to believe a mandatory safety check is optional. There is no doc comment explaining the parameter or the UI effect.

**Fix:** Add a comment above the declaration, e.g.: `// Sets whether the pre-op check is presented as mandatory (true) or optional (false). // Controls which tip label is shown on the start dialog.`

---

**A20-9** · LOW · `UpdateTextInput` in `CommentDialog` is undocumented

**Description:** `UpdateTextInput(QString str, onScreenKeyboard::CtrlButton ctrl)` (line 29 of `commentdialog.h`) is the keyboard input handler. It processes Backspace, Delete, and character insertion, and silently truncates input beyond `MAX_CHARACTER`. The parameter types are non-obvious to a caller who is not familiar with the `onScreenKeyboard::CtrlButton` enum. No documentation describes expected values or the truncation behaviour.

**Fix:** Add a doc comment describing the `ctrl` parameter values and their effect, the role of `str` (text to insert for non-control keys), and the `MAX_CHARACTER` truncation behaviour.

---

**A20-10** · LOW · `quickPowerUpdate` is undocumented and its gating role is non-obvious

**Description:** `quickPowerUpdate(bool on)` (line 64 of `dialog.h`) sets `m_power` and forwards the state to `m_authorisedDialog`. What is non-obvious from the name alone is that when `on == false`, the `onCardSwiped` handler returns immediately without processing any card data, effectively disabling all RFID authentication. This is a security-relevant side effect that is invisible without reading the implementation.

**Fix:** Add a doc comment clarifying that this method controls whether the device accepts card-swipe authentication events, in addition to updating the authorised-dialog power indicator.

---

**A20-11** · LOW · `onBroadcastMsgReceived` is undocumented and has a non-obvious no-driver path

**Description:** `onBroadcastMsgReceived(CIGCONF::BroadcastMessage m)` (line 61 of `dialog.h`) silently discards broadcast message display and sends a `MsgResultNoDriver` GMTP response when no driver is logged in, instead of queuing the message for later display. This behaviour is a deliberate design decision but is completely invisible from the header.

**Fix:** Add a doc comment noting the no-driver fast-path: when no driver is currently logged in, the message is not queued and an immediate no-driver response is emitted.

---

**A20-12** · INFO · `languageChanged` methods are undocumented across all three classes

**Description:** `CheckStartDialog::languageChanged()`, `CommentDialog::languageChanged()`, and `Dialog::onLanguageChanged()` all re-translate UI strings but have no doc comment. These are low-risk but form part of the public/notification API.

**Fix:** Add a one-line comment on each stating that the method must be called when the application locale changes to refresh all displayed strings.

---

## Summary Table

| ID | Severity | Title |
|---|---|---|
| A20-1 | HIGH | No documentation on any `Dialog` public method (23 methods) |
| A20-2 | HIGH | No documentation on any `Dialog` signal (11 signals) |
| A20-3 | HIGH | `lockScreen` — safety-critical access-control method undocumented |
| A20-4 | HIGH | `onCmdLogin` — remote login entry point undocumented |
| A20-5 | HIGH | `setRelayOut` / `setRelay2Out` — hardware relay control signals undocumented |
| A20-6 | MEDIUM | `onkeyboardClosed` and `onUnlkReasonSelected` misleadingly public without documentation |
| A20-7 | MEDIUM | `CommentDialogType` enum and `NO_ACTIVITY_TIME` / `MAX_CHARACTER` macros undocumented |
| A20-8 | LOW | `setMandatory` in `CheckStartDialog` undocumented |
| A20-9 | LOW | `UpdateTextInput` in `CommentDialog` undocumented |
| A20-10 | LOW | `quickPowerUpdate` gating role undocumented |
| A20-11 | LOW | `onBroadcastMsgReceived` no-driver discard path undocumented |
| A20-12 | INFO | `languageChanged` methods undocumented across all three classes |

**Totals:** 5 HIGH, 2 MEDIUM, 4 LOW, 1 INFO
