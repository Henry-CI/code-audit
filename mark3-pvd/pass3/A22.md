# Pass 3 Agent A22 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `ui/lockeddialog.h` + `ui/lockeddialog.cpp`
- `ui/messagedialog.h` + `ui/messagedialog.cpp`
- `ui/onScreenKeyboard.h` + `ui/onScreenKeyboard.cpp`

---

## Reading Evidence

### File: `ui/lockeddialog.h` + `ui/lockeddialog.cpp`

**Class:** `LockedDialog` (extends `QDialog`)

**Public methods (header line numbers):**

| Line | Method | Signature |
|------|--------|-----------|
| 18 | Constructor | `explicit LockedDialog(QWidget *parent = 0)` |
| 19 | Destructor | `~LockedDialog()` |
| 20 | `setLockedReason` | `void setLockedReason(CIGCONF::MaintLockedCode lockedCode)` |
| 21 | `languageChanged` | `void languageChanged(void)` |
| 22 | `setTimeRemaining` | `void setTimeRemaining(quint32 secs)` |
| 23 | `clearTimerText` | `void clearTimerText()` |
| 24 | `stopTimer` | `void stopTimer()` |
| 25 | `startTimer` | `void startTimer()` |

**Protected methods:**

| Line | Method |
|------|--------|
| 36 | `mouseReleaseEvent(QMouseEvent *)` — inline; calls `accept()` |

**Signals:**

| Name | Signature |
|------|-----------|
| `fullLockoutTimerEnded` | `void fullLockoutTimerEnded(bool on1, bool on2)` |
| `beeperOn` | `void beeperOn()` |

**Private methods:**

| Name | Purpose (from implementation) |
|------|-------------------------------|
| `updateFullLock()` | Per-second timer tick; decrements counter, emits `fullLockoutTimerEnded` when expired |
| `fullLockStart()` | Initialises `m_timeCntr` from config, starts 1-second `m_fullLockTimer` |

**Private members:**
- `Ui::LockedDialog *ui`
- `QTimer *m_fullLockTimer`
- `quint32 m_timeCntr`

**Types / enums referenced (defined in `app/cigconfigs.h`):**
- `CIGCONF::MaintLockedCode` — enum with values: `MaintNormal`, `MaintIdle (0xea)`, `MaintCriticalQuestion (0xfb)`, `MaintRedImpact (0xfd)`, `MaintSurveyTimeout (0xfe)`

**Doc comments present:** None on any declaration.

---

### File: `ui/messagedialog.h` + `ui/messagedialog.cpp`

**Class:** `MessageDialog` (extends `QDialog`)

**Enum defined in class (header lines 18-27):**

```
enum MessageType {
    NoMessage,
    ExpansionConnecting,
    WaitForAuthorised,
    NotAuthorised,
    OnDemandNotAuthorised,
    PowerOff,
    Reboot,
    VehicleOutOfService
};
```

**Public methods (header line numbers):**

| Line | Method | Signature |
|------|--------|-----------|
| 29 | Constructor | `explicit MessageDialog(QWidget *parent = 0)` |
| 30 | Destructor | `~MessageDialog()` |
| 31 | `openWithMessage` | `void openWithMessage(MessageType type)` — inline; calls `setMessageType(type); open()` |
| 33 | `setMessageType` | `void setMessageType(MessageType type)` |
| 34 | `messageType` | `MessageType messageType() const` — inline getter |

**Protected methods:**

| Line | Method |
|------|--------|
| 37 | `hideEvent(QHideEvent *)` — stops timer and movie, resets `m_messageType` to `NoMessage` |

**Signals:** None declared.

**Private members:**
- `Ui::MessageDialog *ui`
- `QTimer *m_timer`
- `QMovie *m_movie`
- `MessageType m_messageType`

**Macro constants (defined in `messagedialog.cpp`):**
- `WAIT_AUTH_TIME 10000` — timeout (ms) before transitioning `WaitForAuthorised` to `NotAuthorised`
- `NOT_AUTH_TIME 5000` — auto-dismiss timeout (ms) for `NotAuthorised`, `OnDemandNotAuthorised`, `VehicleOutOfService`

**Doc comments present:** None on any declaration.

---

### File: `ui/onScreenKeyboard.h` + `ui/onScreenKeyboard.cpp`

**Class:** `onScreenKeyboard` (extends `QWidget`)

**Enums defined in class (header lines 17-19):**

```
enum KeyToggleState { Normal, Upper, Lower };
enum CaseButton     { AllButtons, CapsButton, ShiftButton, SymbolButton };
enum CtrlButton     { None, Backspace, Delete };
```

**Public members:**
- `QPushButton *enterButton` — public raw pointer (no encapsulation), line 22

**Public methods (header line numbers):**

| Line | Method | Signature |
|------|--------|-----------|
| 20 | Constructor | `explicit onScreenKeyboard(QWidget *parent = 0)` |
| 21 | Destructor | `~onScreenKeyboard()` |
| 24 | `setInitialText` | `void setInitialText(QString str)` |
| 25 | `languageChanged` | `void languageChanged(void)` |

**Signals:**

| Name | Signature |
|------|-----------|
| `updateText` | `void updateText(QString str, CtrlButton ctrl)` |
| `onScreenKeyboardClose` | `void onScreenKeyboardClose()` |

**Private slots:**

| Name |
|------|
| `keyboardHandler()` |
| `on_btnShift_clicked(bool checked)` |
| `on_btnEnter_clicked()` |
| `on_btnBack_clicked()` |
| `on_btnCaps_toggled(bool checked)` |
| `on_btnHideKeyboard_clicked()` |
| `on_btnDelete_clicked()` |

**Protected methods:**
- `closeEvent(QCloseEvent *event)` — emits `onScreenKeyboardClose()` then accepts

**Private methods:**

| Name | Purpose |
|------|---------|
| `toggle()` | Redraws all alpha key labels based on current Caps/Shift state |
| `dualCharCase(QString ch, int toggleState)` | Returns symbol vs. digit representation for number-row dual-label keys |
| `singleCharCase(QString ch, int toggleState)` | Returns upper or lower case of a single character |
| `setCaseButton(CaseButton btn, bool set)` | Applies/removes highlight border stylesheet on Caps or Shift buttons |

**Private members:**
- `Ui::onScreenKeyboard *ui`
- `QString outputText`
- `QString m_capsStylesheet`
- `QString m_symbolStylesheet`
- `QString m_shiftStylesheet`

**Doc comments present:** None on any declaration.

---

## Findings

**A22-1** · HIGH · No documentation on `startTimer()` — safety-critical vehicle shutdown initiator

**Description:** `LockedDialog::startTimer()` (header line 25, implemented in `lockeddialog.cpp` lines 21-28) does three distinct safety-critical things in sequence: it clears any displayed countdown text, emits the `beeperOn()` signal to activate an audible alert, and — when `fullLockoutEnable` is set in configuration — calls `fullLockStart()`, which begins a countdown that ultimately emits `fullLockoutTimerEnded(false, false)` to shut down both output relays on the vehicle. There is no comment of any kind above the declaration. A caller reading only the header has no indication that invoking this method can trigger an irreversible vehicle shutdown sequence.

**Fix:** Add a doc comment above the declaration in `lockeddialog.h` that states: the method arms the beeper, and when full-lockout is enabled and not already running, starts a countdown whose expiry will emit `fullLockoutTimerEnded(false, false)` to de-energise both relays. Document the precondition that `setLockedReason` should have already been called, and that calling `stopTimer()` before expiry is the only way to abort the shutdown.

---

**A22-2** · HIGH · No documentation on `fullLockoutTimerEnded` signal — relay-control contract undocumented

**Description:** The signal `fullLockoutTimerEnded(bool on1, bool on2)` (header line 32) is always emitted with `(false, false)` (cpp line 88), meaning both relay outputs are to be de-energised. The parameter names `on1` and `on2` provide no indication of what physical outputs they control, what the `false` value means in each case, or whether any future caller could legitimately emit this signal with `(true, …)`. No comment exists anywhere in either file explaining these parameters or the physical effect of this signal.

**Fix:** Add a doc comment above the signal in `lockeddialog.h` describing: what `on1` and `on2` represent (the two relay channels), that `false` means the relay should be opened (de-energised), and that this signal is always emitted at the end of the full-lockout countdown. Cross-reference `startTimer()` and `stopTimer()`.

---

**A22-3** · HIGH · No documentation on `setLockedReason()` — lockout-code-to-UI mapping undocumented

**Description:** `setLockedReason(CIGCONF::MaintLockedCode lockedCode)` (header line 20) controls which safety lockout message is shown to the operator. The `CIGCONF::MaintLockedCode` enum contains values representing different operational failure modes (critical checklist failure, red-level safety impact, survey timeout, idle timeout). There is no comment explaining what the parameter represents, the expected set of valid values, or the consequence of passing an unrecognised code (the `default` branch silently shows a generic "Unit Locked" message). The enum value names themselves (`0xea`, `0xfb`, `0xfd`, `0xfe`) are not self-explanatory to maintainers reading the header in isolation.

**Fix:** Add a doc comment above the declaration referencing `CIGCONF::MaintLockedCode` enum values and noting that any value not matching a known enum case will produce the generic "Unit Locked" message. Describe the intended call ordering (call before `startTimer()`).

---

**A22-4** · MEDIUM · `stopTimer()` documentation absent — abort-of-shutdown semantics invisible

**Description:** `stopTimer()` (header line 24) not only stops `m_fullLockTimer` but also calls `clearTimerText()`. More importantly, calling it is the only mechanism to abort the full-lockout countdown before it fires. There is no comment indicating that this method is the cancellation path for a vehicle shutdown sequence, nor that it also clears the displayed countdown text as a side effect.

**Fix:** Add a doc comment stating: stops the full-lockout countdown timer (aborting a pending shutdown if active) and clears the countdown display label. Note that this is the only abort path once `startTimer()` has been called.

---

**A22-5** · LOW · No documentation on `setTimeRemaining()` — parameter unit and UI side-effect undescribed

**Description:** `setTimeRemaining(quint32 secs)` (header line 22) updates the on-screen countdown label with a translated string of the form "CAUTION: This vehicle will shut down in N seconds". The parameter name `secs` is reasonable but neither the unit, the expected range, nor the fact that this method only modifies a label (it does not affect the timer) is documented. It is not obvious from the header alone whether this method also starts/resets any timer.

**Fix:** Add a brief comment stating the parameter is a count in seconds, that it only updates the display label, and that callers should not rely on this method to drive the timer countdown (which is driven by `m_fullLockTimer`).

---

**A22-6** · LOW · No documentation on `MessageDialog::setMessageType()` — timer side-effects and auto-dismiss behaviour undocumented

**Description:** `setMessageType(MessageType type)` (header line 33) does far more than set a field: depending on the `type` value it reconfigures UI geometry, starts/stops a `QMovie`, and starts a `QTimer` that will either auto-transition from `WaitForAuthorised` to `NotAuthorised` after 10 seconds or auto-dismiss the dialog after 5 seconds. None of these side effects — including the automatic state machine transition and the auto-dismiss timers — are described anywhere in the header or above the implementation.

**Fix:** Add a doc comment above the declaration describing: (a) that this method also reconfigures the UI and movie; (b) which `MessageType` values start a timer and what the timer does (`WaitForAuthorised` transitions to `NotAuthorised` after `WAIT_AUTH_TIME` ms; `NotAuthorised`, `OnDemandNotAuthorised`, and `VehicleOutOfService` auto-dismiss after `NOT_AUTH_TIME` ms); (c) that the timer constants are defined in the .cpp file.

---

**A22-7** · LOW · `MessageDialog::openWithMessage()` inline convenience method undocumented

**Description:** `openWithMessage(MessageType type)` (header line 31) is a convenience method that composes `setMessageType` and `open()`. Because `setMessageType` carries timer-starting side effects, callers who use `openWithMessage` vs. calling the two separately may be surprised that the timer starts before the dialog is fully visible. There is no comment explaining the call order or the interaction with `hideEvent`, which resets `m_messageType` to `NoMessage` and stops the timer when the dialog is hidden.

**Fix:** Add a one-line comment noting that this method sets the message type (which may start an auto-dismiss timer) and then opens the dialog modally. Cross-reference `hideEvent` as the teardown path.

---

**A22-8** · LOW · `onScreenKeyboard::updateText` signal — `CtrlButton` parameter semantics undocumented

**Description:** The signal `updateText(QString str, CtrlButton ctrl)` (header line 36) is emitted in three distinct scenarios: a regular character key (emits the character with `ctrl = None`), the backspace key (emits empty string with `ctrl = Backspace`), and the delete key (emits empty string with `ctrl = Delete`). When `ctrl` is `Backspace` or `Delete`, the `str` parameter is always an empty string, but there is no documentation stating this convention. Receivers must inspect the implementation to understand when `str` is meaningful.

**Fix:** Add a doc comment above the signal declaration stating: `str` carries the character to append when `ctrl == None`; `str` is empty and should be ignored when `ctrl` is `Backspace` or `Delete`. Clarify that `Backspace` removes the previous character and `Delete` removes the next character (consistent with implementation in `on_btnBack_clicked` and `on_btnDelete_clicked`).

---

**A22-9** · LOW · `onScreenKeyboard::setInitialText()` — purpose and relationship to `outputText` undocumented

**Description:** `setInitialText(QString str)` (header line 24) sets the private `outputText` member. The name implies it pre-populates the keyboard's internal text buffer. However, there is no comment explaining: whether the dialog will echo this initial text back via `updateText` on the next keypress, whether callers should call this before or after `show()`, or how it interacts with the `on_btnEnter_clicked` handler that resets `outputText` to empty. Without a comment, callers cannot safely predict the behaviour of the first keypress after initialisation.

**Fix:** Add a doc comment stating: sets the internal output-text buffer to `str`; the next character key press will replace this value (not append to it), and calling `on_btnEnter_clicked` resets the buffer to empty regardless. Clarify the intended call order relative to `show()`.

---

**A22-10** · INFO · `LockedDialog::languageChanged()` and `onScreenKeyboard::languageChanged()` undocumented

**Description:** Both classes expose a `languageChanged()` method (lockeddialog.h line 21; onScreenKeyboard.h line 25) with no comments. These are simple retranslation methods that update displayed strings when the application locale changes. They are low-risk but follow no established calling convention visible from the headers.

**Fix:** Add a brief `// Call when the application language changes to retranslate all visible strings.` comment above each declaration.

---

**A22-11** · INFO · `MessageDialog::messageType()` getter undocumented

**Description:** The inline getter `messageType() const` (header line 34) has no comment. It is a simple accessor; the omission is minor.

**Fix:** Add a one-line comment: `// Returns the currently displayed message type, or NoMessage when the dialog is hidden.`

---

**A22-12** · INFO · `onScreenKeyboard::enterButton` public raw pointer undocumented

**Description:** `enterButton` (header line 22) is a public raw `QPushButton *` with no comment explaining its purpose, who owns it, or why it is exposed publicly rather than accessed through a method. It appears to be used by an external caller to connect to the enter button's signal directly, but this intent is entirely undocumented.

**Fix:** Add a comment above the member stating its purpose (e.g., exposed to allow callers to connect directly to the enter button's signals) and clarifying ownership (owned by the UI, not by the caller).

---

## Summary Table

| ID | Severity | Title |
|----|----------|-------|
| A22-1 | HIGH | No documentation on `startTimer()` — safety-critical vehicle shutdown initiator |
| A22-2 | HIGH | No documentation on `fullLockoutTimerEnded` signal — relay-control contract undocumented |
| A22-3 | HIGH | No documentation on `setLockedReason()` — lockout-code-to-UI mapping undocumented |
| A22-4 | MEDIUM | `stopTimer()` documentation absent — abort-of-shutdown semantics invisible |
| A22-5 | LOW | No documentation on `setTimeRemaining()` — parameter unit and UI side-effect undescribed |
| A22-6 | LOW | No documentation on `MessageDialog::setMessageType()` — timer side-effects and auto-dismiss behaviour undocumented |
| A22-7 | LOW | `MessageDialog::openWithMessage()` inline convenience method undocumented |
| A22-8 | LOW | `onScreenKeyboard::updateText` signal — `CtrlButton` parameter semantics undocumented |
| A22-9 | LOW | `onScreenKeyboard::setInitialText()` — purpose and relationship to `outputText` undocumented |
| A22-10 | INFO | `languageChanged()` methods undocumented in both `LockedDialog` and `onScreenKeyboard` |
| A22-11 | INFO | `MessageDialog::messageType()` getter undocumented |
| A22-12 | INFO | `onScreenKeyboard::enterButton` public raw pointer undocumented |

**Totals:** 3 HIGH, 1 MEDIUM, 5 LOW, 3 INFO
