# Pass 3 Agent A12 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `platform/aescrypto.h` + `platform/aescrypto.cpp`
- `platform/blecentral.h` + `platform/blecentral.cpp`

---

## Reading Evidence

### `platform/aescrypto.h` / `platform/aescrypto.cpp`

**Class:** `EM070::AesCrypto`

**Public methods (header):**

| Line | Signature |
|------|-----------|
| 16 | `static QByteArray encrypt(const QByteArray &in)` |
| 17 | `static QByteArray descrypt(const QByteArray &in)` |

**Private methods (header):**

| Line | Signature |
|------|-----------|
| 20 | `bool enableMtp()` |
| 21 | `QByteArray aes(const QByteArray &in, bool encrypt)` |

**Private static data members:**

| Line | Name | Type |
|------|------|------|
| 22 | `m_mtpEnabled` | `static bool` |

**Types, enums, constants defined:** None in header. The `.cpp` defines two non-standard preprocessor macros:
- `AF_ALG 38` (line 10)
- `SOL_ALG 279` (line 13)

**Signals / Slots:** None. `AesCrypto` does not inherit from `QObject`.

**Existing comments:**

- Lines 11–15: Block comment above `encrypt` stating that only some segments are encrypted rather than the whole file, for performance reasons.

---

### `platform/blecentral.h` / `platform/blecentral.cpp`

**Classes:**

1. `EM070::CharacteristicInfo` (inner helper, inherits `QObject`)
2. `EM070::DescriptorInfo` (inner helper, inherits `QObject`)
3. `EM070::BleCentral` (main class, inherits `QObject`)

**`CharacteristicInfo` — public methods (header):**

| Line | Signature |
|------|-----------|
| 17–18 | Constructor: `CharacteristicInfo(const QLowEnergyCharacteristic &, QLowEnergyService *parent)` |
| 20 | `QBluetoothUuid uuid() const` |
| 21 | `bool isReadable() const` |
| 22 | `bool isWritable() const` |
| 23 | `const QLowEnergyCharacteristic &characteristic() const` |
| 24 | `QLowEnergyService *parentService() const` |

**`DescriptorInfo` — public methods (header):**

| Line | Signature |
|------|-----------|
| 34–35 | Constructor: `DescriptorInfo(const QLowEnergyDescriptor &, CharacteristicInfo *parent)` |
| 37 | `QBluetoothUuid uuid() const` |
| 38 | `const QLowEnergyDescriptor &descriptor() const` |
| 39 | `const CharacteristicInfo *parentInfo() const` |

**`BleCentral` — public methods (header):**

| Line | Signature |
|------|-----------|
| 51 | `explicit BleCentral(QObject *parent = nullptr)` |
| 52 | `~BleCentral()` |
| 54 | `void setEnabled(bool enable)` |
| 56 | `void setPeripheralAddress(const quint64 &address)` |
| 57 | `void setAuthorizationCode(const quint128 &uuid, const QByteArray &code)` |
| 59 | `State state() const` |
| 61 | `QByteArrayList servicesUuid() const` |
| 62 | `QByteArrayList characteristicsUuid() const` |
| 63 | `QByteArrayList descriptionsUuid() const` |
| 65 | `bool readCharacteristic(const quint128 &uuid)` |
| 66 | `bool writeCharacteristic(const quint128 &uuid, const QByteArray &ba)` |
| 67 | `bool readDescriptor(const quint128 &uuid)` |
| 68 | `bool writeDescriptor(const quint128 &uuid, const QByteArray &ba)` |

**`BleCentral` — enum:**

| Line | Name | Values |
|------|------|--------|
| 49 | `State` | `Disabled`, `Discovering`, `Ready` |

**`BleCentral` — signals:**

| Line | Signature |
|------|-----------|
| 71 | `void accessible(bool yes)` |
| 74 | `void error(QBluetoothDeviceDiscoveryAgent::Error newError)` |
| 77 | `void error(QLowEnergyController::Error newError)` |
| 80 | `void error(QLowEnergyService::ServiceError newError)` |
| 81 | `void characteristicChanged(const quint128 &uuid, const QByteArray &newValue)` |
| 82 | `void characteristicRead(const quint128 &uuid, const QByteArray &value)` |
| 83 | `void characteristicWritten(const quint128 &uuid, const QByteArray &newValue)` |
| 84 | `void descriptorRead(const quint128 &uuid, const QByteArray &value)` |
| 85 | `void descriptorWritten(const quint128 &uuid, const QByteArray &newValue)` |

**Existing comments in header:**

- Lines 73, 76, 79: Category comments (`// for QBluetoothDeviceDiscoveryAgent`, `// for QLowEnergyController`, `// for QLowEnergyService`) group the overloaded `error` signals. These are organisational, not doc comments.

**Macros defined in `.cpp`:**

| Line | Name | Value |
|------|------|-------|
| 7 | `DISCOVERY_RETRY_WAIT` | `3000` |
| 8 | `RECONNECT_RETRY_WAIT` | `2000` |
| 9 | `WAIT_FOR_CONNECTED` | `10000` |
| 10 | `WAIT_FOR_READY` | `30000` |

---

## Findings

**A12-1** · HIGH · No documentation on `AesCrypto::encrypt`

**Description:** The public static method `encrypt` (aescrypto.h line 16) is the primary encryption entry point for the `AesCrypto` class. No doc comment exists directly above its declaration. The only comment present (lines 11–15) is a general design note explaining *why* partial encryption is used; it does not describe the method contract: what the input format/size constraints are, what the return value represents on failure (an empty `QByteArray`), that the method is a no-op on non-ARM builds, that it is backed by CBC-AES using a fixed IV, or any thread-safety considerations. For a security-critical API this is a significant documentation gap.

**Fix:** Add a doc comment immediately above the declaration that describes: (1) the input data format and any size/alignment requirements; (2) that the method returns an empty `QByteArray` on failure (including on non-ARM platforms); (3) that encryption uses CBC-AES with a hardware-managed key via the AF_ALG kernel interface; (4) that a fixed IV is employed (with a cross-reference to the security implications of IV reuse); (5) thread-safety guarantees or lack thereof (the static `m_mtpEnabled` flag is not protected).

---

**A12-2** · HIGH · No documentation on `AesCrypto::descrypt`

**Description:** The public static method `descrypt` (aescrypto.h line 17) has no doc comment at all. The same concerns as A12-1 apply. Additionally, the method name itself is a misspelling of "decrypt", which makes the API harder to use correctly without documentation. There is nothing to alert callers that calling `descrypt` on data that was not produced by `encrypt` will silently return garbage output rather than an error.

**Fix:** Add a doc comment above the declaration describing: (1) the expected input (output of `encrypt`); (2) failure return value; (3) platform restriction; (4) the IV reuse note. Also consider renaming the method to `decrypt` in a future API cleanup (though that is a separate issue).

---

**A12-3** · MEDIUM · Existing comment on `AesCrypto::encrypt` is inaccurate / misleading

**Description:** The block comment at lines 11–15 of aescrypto.h states:

> "Normally, don't need to encrypt the whole file in case file has big size, as which costs much time and memory, choose some segments to encrypt is sufficient for secure purpose"

This comment is misleading for three reasons. First, it implies the method encrypts only a subset ("some segments") of the input, but the implementation in aescrypto.cpp lines 131–141 processes the entire input buffer in 1024-byte chunks — the whole input is encrypted. Second, the comment was apparently written for a different design and retained in error. Third, it sits above both `encrypt` and `descrypt` without being tied to either, creating ambiguity. A reader trusting this comment could incorrectly assume the ciphertext covers only partial plaintext.

**Fix:** Remove or replace this comment with accurate documentation for both methods as described in A12-1 and A12-2.

---

**A12-4** · LOW · No documentation on `BleCentral::setAuthorizationCode`

**Description:** `setAuthorizationCode` (blecentral.h line 57) is a non-trivial security-relevant method that stores a UUID and a byte-array credential used to authenticate to the BLE peripheral (see blecentral.cpp line 274–275, where the stored `m_authCode` is automatically written to the characteristic matching `m_authUuid` during service discovery). No doc comment explains: (1) the intended call sequence relative to `setEnabled`; (2) whether the code is written in plaintext over the BLE link; (3) what happens if called while the device is already connected (the new values are stored but the write to the peripheral does not re-trigger until the next reconnect).

**Fix:** Add a comment above the declaration describing the parameter semantics, the automatic write-on-discovery behaviour, and any security implications of transmitting the code over an unencrypted BLE channel.

---

**A12-5** · LOW · No documentation on `BleCentral::setEnabled`

**Description:** `setEnabled` (blecentral.h line 54) controls the entire BLE lifecycle: when `true` it starts device discovery and begins a connection attempt chain; when `false` it stops all timers, halts discovery, and disconnects the controller. The method is idempotent (repeated calls with the same value are no-ops). None of this is documented. The side effects on internal state machine transitions are non-obvious to a caller.

**Fix:** Add a comment above the declaration describing the state transitions triggered, the idempotency guarantee, and that disabling resets the device to the `Disabled` state emitting `accessible(false)`.

---

**A12-6** · LOW · No documentation on `BleCentral::setPeripheralAddress`

**Description:** `setPeripheralAddress` (blecentral.h line 56) accepts a `quint64` raw address. No comment documents: (1) the expected byte order or encoding; (2) that passing a null address is silently ignored; (3) that passing a different address while connected causes an implicit disable/re-enable cycle that drops the existing connection.

**Fix:** Add a comment describing address format expectations, null-address behaviour, and the implicit reconnect side effect.

---

**A12-7** · LOW · No documentation on `BleCentral::readCharacteristic` / `writeCharacteristic` / `readDescriptor` / `writeDescriptor`

**Description:** The four GATT I/O methods (blecentral.h lines 65–68) return `bool` to indicate whether the operation was submitted, but there is no documentation stating: (1) that `false` can mean the UUID was not found, the characteristic is not readable/writable, or the parent service is unavailable; (2) that the actual data is returned asynchronously via the corresponding signal rather than as a return value; (3) that the UUID parameter must be a 128-bit GATT UUID in the same byte order used by Qt's `QLowEnergyCharacteristic::uuid().toUInt128()`.

**Fix:** Add a doc comment to each method describing the `false` failure cases and the asynchronous result delivery via signals.

---

**A12-8** · LOW · No documentation on `BleCentral::accessible` signal

**Description:** The `accessible(bool yes)` signal (blecentral.h line 71) is the primary connectivity status signal for consumers of `BleCentral`. No comment explains: when `true` is emitted (after all services and characteristics are discovered, line 291); that `false` is emitted both on disable and on disconnect; or that it may fire multiple times with `false` during a discovery/reconnect cycle.

**Fix:** Add a comment above the signal declaration explaining both the `true` and `false` emission conditions.

---

**A12-9** · INFO · No documentation on `CharacteristicInfo` and `DescriptorInfo` helper classes

**Description:** `CharacteristicInfo` and `DescriptorInfo` (blecentral.h lines 13–43) are thin wrapper classes with no class-level comment explaining their purpose or ownership model. Their public accessor methods (`uuid`, `isReadable`, `isWritable`, `characteristic`, `descriptor`, `parentService`, `parentInfo`) are all simple one-liners and individually undocumented, though their names are reasonably self-explanatory.

**Fix:** Add a brief class-level comment to each wrapper class explaining that they are cache objects built during service discovery and owned by the `BleCentral` instance. Individual accessor documentation is not strictly required given the clarity of the names, but a note on ownership (parent is the associated `QLowEnergyService` or `CharacteristicInfo`) would be helpful.

---

**A12-10** · INFO · No documentation on `BleCentral::State` enum values

**Description:** The `State` enum (blecentral.h line 49) has three values — `Disabled`, `Discovering`, `Ready` — with no comment on each value's semantics or the valid transition order. While the names are readable in isolation, it is not clear from the header alone that `Discovering` covers both the device-scan phase and the GATT service-discovery phase, or that `Ready` means all services and characteristics have been enumerated and `accessible(true)` has been emitted.

**Fix:** Add inline comments or a preceding block comment on the enum clarifying each state's meaning and valid transitions.

---

## Summary Table

| ID | Severity | Location | Title |
|----|----------|----------|-------|
| A12-1 | HIGH | aescrypto.h:16 | No documentation on `AesCrypto::encrypt` |
| A12-2 | HIGH | aescrypto.h:17 | No documentation on `AesCrypto::descrypt` |
| A12-3 | MEDIUM | aescrypto.h:11–15 | Existing comment is inaccurate — implies partial encryption but full input is encrypted |
| A12-4 | LOW | blecentral.h:57 | No documentation on `BleCentral::setAuthorizationCode` |
| A12-5 | LOW | blecentral.h:54 | No documentation on `BleCentral::setEnabled` |
| A12-6 | LOW | blecentral.h:56 | No documentation on `BleCentral::setPeripheralAddress` |
| A12-7 | LOW | blecentral.h:65–68 | No documentation on GATT I/O methods (readCharacteristic, writeCharacteristic, readDescriptor, writeDescriptor) |
| A12-8 | LOW | blecentral.h:71 | No documentation on `accessible` signal emission conditions |
| A12-9 | INFO | blecentral.h:13–43 | No class-level comment on `CharacteristicInfo` / `DescriptorInfo` helper classes |
| A12-10 | INFO | blecentral.h:49 | No documentation on `BleCentral::State` enum values |

**Totals:** 2 HIGH, 1 MEDIUM, 4 LOW, 2 INFO
