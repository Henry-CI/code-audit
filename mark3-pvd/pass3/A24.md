# Pass 3 Agent A24 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Auditor:** Agent A24
**Files reviewed:**
- `ui/preopscreenoverlay.h` / `ui/preopscreenoverlay.cpp`
- `ui/supervisordialog.h` / `ui/supervisordialog.cpp`
- `ui/unlockeddialog.h` / `ui/unlockeddialog.cpp`

---

## Reading Evidence

### 1. `PreopScreenOverlay` (`ui/preopscreenoverlay.h`)

**Class:** `PreopScreenOverlay` (inherits `QDialog`)

**Public methods:**

| Line | Method |
|------|--------|
| 15 | `explicit PreopScreenOverlay(QWidget *parent = 0)` |
| 16 | `~PreopScreenOverlay()` |
| 18 | `void onUpdatePreopTimer(QString time)` |

**Signals:** none declared

**Slots:** none declared

**Types / enums / constants:** none

**Implementation notes (`preopscreenoverlay.cpp`):**
- Constructor initialises the Qt Designer UI.
- `onUpdatePreopTimer(QString time)` sets a label to `"Time Remaining: <time>"`.

---

### 2. `SupervisorDialog` (`ui/supervisordialog.h`)

**Class:** `SupervisorDialog` (inherits `QDialog`)

**Public methods:**

| Line | Method |
|------|--------|
| 20 | `explicit SupervisorDialog(QWidget *parent = nullptr)` |
| 21 | `~SupervisorDialog()` |
| 23 | `void setMasterOptions(CIGCONF::MasterId m)` |
| 24 | `void setTransportOptions()` |

**Signals (line 31–33):**
- `startMasterSession()` — emitted when the supervisor authorises a master/normal-driver session or unlocks the vehicle.
- `startMaintenanceSession()` — emitted when maintenance mode is confirmed.
- `onVORUpdate()` — emitted after VOR (Vehicle Out of Repair) status is toggled.

**Protected method:**
- `showEvent(QShowEvent *event = 0)` (line 49)

**Private slots:**
- `onUnlkVehicle()` — handles two-tap unlock-vehicle confirmation.
- `onNormalDriverAccess()` — handles two-tap normal-driver-access confirmation; also opens a transport warning dialog.
- `onActivateVOR()` — writes the new VOR state to config and saves.
- `openConfirmationDialog()` — handles two-tap VOR activate/deactivate, then opens `VORConfirmationDialog`.
- `on_btnMaintenanceMode_clicked()` — handles two-tap maintenance-mode confirmation; opens a maintenance warning dialog.

**Private methods:**
- `debounce()` — returns false if two presses occur within 200 ms.
- `reset()` — resets `m_lastPress` to 0 and calls `showEvent()`.

**Private members:**
- `Ui::SupervisorDialog *ui`
- `QTimer *m_timer` — auto-dismiss timer (10 000 ms inactivity).
- `QTimer *m_resetTimer` — button-text reset timer (2 000 ms).
- `quint32 m_lastPress` — timestamp of last button press for debounce.
- `CIGCONF::MasterId m_master` — the authenticated master record (contains `id` and `option` bitmask).
- `VORConfirmationDialog *m_vorConfirmationDialog`
- `WarningDialog *m_maintWarningDialog`
- `WarningDialog *m_warningDialog`

**Types / enums / constants used (from `app/cigconfigs.h`):**

`CIGCONF::MasterId` struct:
```cpp
struct MasterId {
    quint64 id;
    quint8  option;   // bitmask of MasterMenuOptions
    QString name;
};
```

`CIGCONF::MasterMenuOptions` enum:
```cpp
enum MasterMenuOptions {
    UnlockVehicle       = 1,
    NormalDriverAccess  = 2,
    ActivateVOR         = 4,
    MaintenanceMode     = 8,
    DefaultMasterMenu   = 7,
    UnassignedMasterMenu= 255
};
```

Macro constants defined in `supervisordialog.cpp`:
- `NO_ACTIVITY_TIME` = 10 000 (ms)
- `RESET_TIME` = 2 000 (ms)

---

### 3. `UnlockedDialog` (`ui/unlockeddialog.h`)

**Class:** `UnlockedDialog` (inherits `QDialog`)

**Public methods:**

| Line | Method |
|------|--------|
| 17 | `explicit UnlockedDialog(QWidget *parent = 0)` |
| 18 | `~UnlockedDialog()` |
| 20 | `void setMode(Mode m)` |
| 21 | `void languageChanged()` |

**Signals:** none declared

**Slots:** none declared

**Types / enums / constants:**

`Mode` enum (line 15):
```cpp
enum Mode { UnlockNoChecklist, UnlockChecklist, UnlockOnly };
```

**Implementation notes (`unlockeddialog.cpp`):**
- `setMode(Mode m)` configures visible labels based on the three `Mode` values:
  - `UnlockOnly`: "Machine unlocked" + warning visible; tip = "Press OK to return to login screen".
  - `UnlockChecklist`: "Machine unlocked" + warning visible; tip = "Operational check list required\nPress OK to continue".
  - `UnlockNoChecklist` (default): locked/warning labels hidden; tip = "No questions available.\nPress OK to continue".
- `languageChanged()` updates the OK label text for locale changes.

---

## Findings

**A24-1** · INFO · Missing doc comment on `PreopScreenOverlay` constructor

**Description:** The constructor `PreopScreenOverlay(QWidget *parent = 0)` has no doc comment. The implementation only sets up the designer UI. This is a trivial boilerplate constructor with no non-obvious behaviour.

**Fix:** Add a brief one-line comment noting the parent widget requirement, e.g.:
```cpp
// Constructs the pre-op screen overlay dialog; parent is passed to QDialog.
explicit PreopScreenOverlay(QWidget *parent = 0);
```

---

**A24-2** · LOW · Missing doc comment on `PreopScreenOverlay::onUpdatePreopTimer`

**Description:** `onUpdatePreopTimer(QString time)` has no doc comment. The method is non-trivial in context: it is the sole mechanism for updating the on-screen pre-operation countdown timer displayed to the driver. Neither the expected format of `time`, nor the fact that it sets the label text as `"Time Remaining: <time>"`, is described anywhere in the header.

**Fix:** Add a comment above the declaration describing the parameter and its expected format:
```cpp
// Updates the countdown label with the remaining pre-op time.
// @param time Formatted time string (e.g., "MM:SS") to display.
void onUpdatePreopTimer(QString time);
```

---

**A24-3** · HIGH · No documentation on any public method of `SupervisorDialog`

**Description:** `SupervisorDialog` is the primary security-critical UI component in the system. It controls:
- Unlocking a vehicle for a master session (`startMasterSession` signal).
- Granting normal driver access (`startMasterSession` signal).
- Activating or deactivating VOR (Vehicle Out of Repair) status (`onVORUpdate` signal; calls `gCfg->setConvor()`).
- Entering maintenance mode (`startMaintenanceSession` signal).

Neither public method (`setMasterOptions` or `setTransportOptions`) has any doc comment of any kind in the header. There is no class-level comment describing the dialog's role, the security model it enforces, the expected call order, or what the `CIGCONF::MasterId` parameter means in `setMasterOptions`. A maintainer reading only the header cannot determine:
- That `setMasterOptions` must be called before showing the dialog (the option bitmask controls which buttons are visible and the `m_master.id` is used as the authorising master ID when persisting the VOR state).
- That `setTransportOptions` hides all privileged actions except Normal Driver Access, configuring the dialog for transport/non-privileged-master context.
- The consequence of not calling either method before `show()`.

**Fix:** Add a class-level doc comment and per-method doc comments to the header:
```cpp
/**
 * SupervisorDialog — Security-critical dialog for supervisor/master actions.
 *
 * Must be configured before display by calling either setMasterOptions() or
 * setTransportOptions(). Controls vehicle unlock, normal driver access,
 * VOR (Vehicle Out of Repair) activation/deactivation, and maintenance mode.
 * Auto-dismisses after NO_ACTIVITY_TIME ms of inactivity.
 */

/**
 * Configures which action buttons are visible based on the authenticated
 * master's permission bitmask (CIGCONF::MasterMenuOptions).
 * The supplied MasterId is stored and used as the authorising ID when
 * persisting a VOR state change.
 * @param m  The authenticated master record; m.option is a bitmask of
 *           CIGCONF::MasterMenuOptions flags.
 */
void setMasterOptions(CIGCONF::MasterId m);

/**
 * Configures the dialog for a transport/non-privileged context:
 * only the Normal Driver Access button is shown; VOR, Unlock Vehicle,
 * and Maintenance Mode buttons are hidden.
 */
void setTransportOptions();
```

---

**A24-4** · HIGH · No documentation on any signal of `SupervisorDialog`

**Description:** The three signals — `startMasterSession()`, `startMaintenanceSession()`, and `onVORUpdate()` — carry security-critical semantics. No comments exist on any of them. Specifically:
- `startMasterSession()` is emitted in two distinct code paths (Unlock Vehicle and Normal Driver Access), meaning callers cannot distinguish which action triggered the session start from the signal alone.
- `onVORUpdate()` is emitted after `gCfg->saveConfigs()` has already committed the VOR state change; callers connecting to this signal cannot roll back.
- The naming `onVORUpdate` violates Qt convention (signals should not be named with `on` prefix, which is reserved for slots), which is a secondary documentation/naming clarity issue.

**Fix:** Add comments above each signal declaration:
```cpp
signals:
    // Emitted when the supervisor authorises either an Unlock Vehicle or
    // Normal Driver Access action. Callers should begin a master session.
    void startMasterSession();

    // Emitted when the supervisor confirms entry into Maintenance Mode.
    void startMaintenanceSession();

    // Emitted after VOR status has been toggled and configuration saved.
    // The new status can be read from gCfg->convorStatus().
    void onVORUpdate();
```

---

**A24-5** · HIGH · Missing documentation on `SupervisorDialog::showEvent` (protected)

**Description:** `showEvent(QShowEvent *event = 0)` is overridden in `SupervisorDialog` but carries no comment. Its role is non-obvious and security-relevant: it not only performs UI reset (button text, visibility, last-session labels) but also starts the inactivity auto-dismiss timer (`m_timer`). Any subclass or test code that overrides or calls this method without understanding the timer side-effect could inadvertently disable the inactivity lockout. The default parameter `= 0` on a Qt event handler is unusual and unexplained.

**Fix:** Add a comment above the declaration:
```cpp
// Resets dialog UI state and (re)starts the NO_ACTIVITY_TIME inactivity
// auto-dismiss timer. Called on every show and on internal state resets.
// Note: event may be nullptr when called internally (e.g., from reset()).
void showEvent(QShowEvent *event = 0);
```

---

**A24-6** · LOW · Missing doc comment on `UnlockedDialog::setMode`

**Description:** `setMode(Mode m)` controls which combination of warning labels and instructional text is shown to the driver after a machine-unlock event. The `Mode` enum has three values but no doc comment explains what each value means in operational terms or when each should be used. In particular, the distinction between `UnlockNoChecklist` and `UnlockOnly` is not self-evident from names alone (`UnlockNoChecklist` hides the lock/warning labels entirely, whereas `UnlockOnly` shows them).

**Fix:** Add comments to the enum and the method:
```cpp
enum Mode {
    UnlockNoChecklist,  // No checklist available; shows minimal tip only.
    UnlockChecklist,    // Checklist required; shows unlock confirmation + checklist prompt.
    UnlockOnly          // Unlock without checklist; shows unlock confirmation + login tip.
};

// Configures the dialog's displayed message for the given unlock scenario.
// Must be called before the dialog is shown.
void setMode(Mode m);
```

---

**A24-7** · INFO · Missing doc comment on `UnlockedDialog::languageChanged`

**Description:** `languageChanged()` has no doc comment. Its implementation updates a single label (`label_3`) with the translated "OK" string. It is a locale-refresh hook but nothing in the header or implementation describes when it should be called, which labels it refreshes, or why only `label_3` is updated (other translatable strings are handled via `tr()` on construction or in `setMode`).

**Fix:** Add a brief one-line comment:
```cpp
// Re-applies translated strings to UI elements after a language change.
void languageChanged();
```

---

## Summary Table

| ID | Severity | File | Subject |
|----|----------|------|---------|
| A24-1 | INFO | `preopscreenoverlay.h` | Missing doc comment on constructor |
| A24-2 | LOW | `preopscreenoverlay.h` | Missing doc comment on `onUpdatePreopTimer` — parameter format undocumented |
| A24-3 | HIGH | `supervisordialog.h` | No documentation on any public method of security-critical `SupervisorDialog` |
| A24-4 | HIGH | `supervisordialog.h` | No documentation on any signal of `SupervisorDialog`; ambiguous `startMasterSession` semantics |
| A24-5 | HIGH | `supervisordialog.h` | Missing documentation on `showEvent` — inactivity lockout side-effect undocumented |
| A24-6 | LOW | `unlockeddialog.h` | Missing doc comment on `setMode`; `Mode` enum values not explained |
| A24-7 | INFO | `unlockeddialog.h` | Missing doc comment on `languageChanged` |

**Totals:** 3 HIGH, 2 LOW, 2 INFO
