# Pass 3 Agent A06 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `comm/bleexpansion.h`
- `comm/bleexpansion.cpp`
- `comm/bleexpansionuuid.h`

---

## Reading Evidence

### `comm/bleexpansion.h` — class `BleExpansion : public QObject`

#### Public Methods / Functions

| Line | Name | Signature |
|------|------|-----------|
| 32 | Constructor | `explicit BleExpansion(EM070::BleCentral *bleCentral)` |
| 34 | `setEnabled` | `void setEnabled(bool enable)` |
| 36 | `deviceName` | `const QByteArray &deviceName() const` (inline) |
| 37 | `bleVersion` | `const QByteArray &bleVersion() const` (inline) |
| 38 | `mainVersion` | `const QByteArray &mainVersion() const` (inline) |
| 39 | `manufacture` | `const QByteArray &manufacture() const` (inline) |
| 40 | `modelNumber` | `const QByteArray &modelNumber() const` (inline) |
| 42 | `digitalInput` | `bool digitalInput(CIGCONF::BleExpansionDI di) const` (inline) |
| 44 | `relayOutput` | `bool relayOutput(CIGCONF::BleExpansionRelay relay) const` (inline) |
| 47 | `setRelayOutput` | `void setRelayOutput(CIGCONF::BleExpansionRelay relay, bool state)` |
| 49 | `setShockThreshold` | `void setShockThreshold(quint32 threshold)` |
| 50 | `setShockPeriod` | `void setShockPeriod(quint32 period)` |
| 52 | `isShockQueueEmpty` | `bool isShockQueueEmpty()` (inline) |
| 53 | `shockEvent` | `ShockEvent shockEvent()` (inline) |
| 55 | `setCurrentTime` | `void setCurrentTime(const QDateTime &time)` |
| 57 | `generateShockMessage` | `bool generateShockMessage(bool force)` |

#### Signals

| Line | Name | Signature |
|------|------|-----------|
| 60 | `accessible` | `void accessible(bool yes)` |
| 61 | `inputStateChanged` | `void inputStateChanged(CIGCONF::BleExpansionDI input, bool state)` |
| 62 | `shockOccurred` | `void shockOccurred()` |
| 63 | `amberImpactOccurred` | `void amberImpactOccurred()` |
| 64 | `redImpactOccurred` | `void redImpactOccurred()` |

#### Protected Slots / Overrides

| Line | Name |
|------|------|
| 67 | `timerEvent(QTimerEvent *)` |

#### Types, Structs, and Unions Defined

| Location | Name | Description |
|----------|------|-------------|
| Header line 27 | `struct ShockEvent` | Public aggregate: `quint32 timestamp`, `quint32 magnitude` |
| Header line 71 | `union RtcTime` (private) | BLE GATT Current Time characteristic layout (10 bytes) |
| Header line 85 | `union WritePending` (private) | Bit-map of outstanding BLE writes awaiting confirmation |

#### Macros / Constants (defined in `bleexpansion.cpp`)

| Name | Value | Purpose |
|------|-------|---------|
| `AUTH_CODE` | `"uS8MgpklMx"` | Hard-coded authentication token written to `authUuid` characteristic |
| `MAX_SHOCK_COUNT` | `10000` | Maximum number of shock events (declared but not referenced in visible code) |
| `RELAY1_TIMEOUT` | `60` | Relay 1 auto-off timeout in seconds |
| `RELAY2_TIMEOUT` | `60` | Relay 2 auto-off timeout in seconds |

---

### `comm/bleexpansionuuid.h` — class `BleExpansionUuid`

#### Public Methods / Functions

| Line | Name | Signature |
|------|------|-----------|
| 9 | `equals128` | `static inline bool equals128(const quint128 *v1, const quint128 *v2)` |

#### Private Static Members (BLE GATT UUIDs, all `quint128`)

`authUuid`, `deviceName`, `appearance`, `bleVersion`, `mainVersion`, `manufactureName`, `modelNumber`, `currentRtc`, `inputTimerReset`, `inputD0`–`inputD3`, `inputPullUp0`–`inputPullUp3`, `outputReset`, `outputRelay0`, `outputRelay1`, `relay0Timeout`, `relay1Timeout`, `outputD0`–`outputD3`, `openCollector0`–`openCollector3`, `shockCount`, `shockPeek`, `shockPop`, `shockThreshold`, `shockPeriod`, `shockMaxMagnitude`, `shockCountNotifyDesc`

All 36 UUID members are declared in lines 20–56. No definitions (actual UUID values) appear in the header; definitions reside in an unreviewed `.cpp` file.

---

## Documentation Findings

---

**A06-1** · LOW · No doc comment on constructor `BleExpansion(EM070::BleCentral *)`

**Description:** The constructor at line 32 has no comment of any kind. It performs several non-trivial side effects on construction: it sets the peripheral MAC address from global config, writes an authorization code to the BLE central, wires up multiple signal–slot connections, and initialises a pop-timer with a 10-second timeout. A caller reading only the header cannot know any of this from the declaration alone.

**Fix:** Add a comment above the declaration explaining that `bleCentral` must already exist and be configured, that the constructor installs the peripheral MAC and auth code immediately, and that the caller must subsequently call `setEnabled(true)` to start scanning (as shown in the existing usage block at lines 12–17).

---

**A06-2** · INFO · File-level usage comment exists but is incomplete

**Description:** Lines 12–17 of `bleexpansion.h` show a brief usage snippet. It correctly shows construction order but omits that `setShockThreshold`, `setShockPeriod`, and `setCurrentTime` are called automatically when the device becomes accessible, which could mislead a caller into calling them redundantly (or relying on the order).

**Fix:** Expand the usage comment to note automatic initialisation performed inside `setAccessible(true)` so callers know which manual setup steps are already handled.

---

**A06-3** · LOW · No doc comment on `setEnabled(bool enable)` (line 34)

**Description:** This method delegates directly to `m_bleCentral->setEnabled(enable)`. The header gives no hint that this controls BLE scanning/advertising on the underlying central, nor what the consequences of calling it `false` mid-session are. No comment at all is present.

**Fix:** Add a short comment: explain that `true` starts BLE scanning for the configured peripheral and `false` stops it; note that accessibility state is preserved until the next connection attempt.

---

**A06-4** · INFO · No doc comments on accessor group `deviceName`, `bleVersion`, `mainVersion`, `manufacture`, `modelNumber` (lines 36–40)

**Description:** These five inline getters return cached `QByteArray` values read from the BLE peripheral after connection. No comment explains when these values become valid (i.e., only after the `accessible(true)` signal has been emitted and `readDeviceInfo()` has completed asynchronously). A caller inspecting these values before the device is accessible will receive empty byte arrays silently.

**Fix:** Add a single group comment above the accessors noting that values are populated after `accessible(true)` is signalled and may be empty before that point.

---

**A06-5** · LOW · No doc comment on `digitalInput(CIGCONF::BleExpansionDI di)` (line 42)

**Description:** The parameter type `CIGCONF::BleExpansionDI` is an enum with values `BleExpDI1`–`BleExpDI4` (defined in `app/cigconfigs.h` line 156). The inline body uses `di - CIGCONF::BleExpDI1` as an array index, which means passing a value outside the `BleExpDI1`–`BleExpDI4` range will produce an out-of-bounds array access. There is no precondition documented and no range check in the implementation.

**Fix:** Add a comment stating the valid range of `di` is `BleExpDI1` through `BleExpDI4`, that the return reflects the last polled value (updated every 1-second timer tick when accessible), and that an out-of-range argument causes undefined behaviour.

---

**A06-6** · LOW · No doc comment on `relayOutput(CIGCONF::BleExpansionRelay relay)` (line 44)

**Description:** Returns the locally cached relay state, not a live read from hardware. There is no comment indicating this is a cached value, nor that the cache may lag the physical relay state until the 1-second timer polls `outputRelay0`/`outputRelay1` and reconciles. The parameter's valid range (`BleExpRelay1` or `BleExpRelay2`) is also undocumented.

**Fix:** Document that this returns the cached desired state, that discrepancies between desired and physical state are corrected by the polling loop, and list the two valid `relay` enum values.

---

**A06-7** · LOW · No doc comment on `setRelayOutput(CIGCONF::BleExpansionRelay relay, bool state)` (line 47)

**Description:** This is a functional control method that writes to physical hardware over BLE. The implementation silently logs a debug warning if called while not accessible but still updates the local cache (`m_outputRelay`), so the desired state will be applied when `initRelays()` is called upon reconnection. This silent queuing behaviour is not documented and could surprise a caller.

**Fix:** Document the relay enum parameter, the boolean state (true = closed, false = open), and the queuing behaviour: the desired state is cached and applied on BLE reconnection even if the device is not currently accessible.

---

**A06-8** · MEDIUM · No doc comment on `setShockThreshold(quint32 threshold)` (line 49); units and range undocumented

**Description:** No comment exists at all. The implementation writes a raw `quint32` to the `shockThreshold` BLE characteristic. Without documentation, callers cannot know the units (the value is compared directly against `event.magnitude` in `popShockEvent`), the valid range, or the effect of setting zero. A zero threshold would cause every shock event to pass the `event.magnitude > m_shockThreshold` comparison. This is a safety-relevant parameter for impact alerting.

**Fix:** Document the units (should match whatever the expansion module hardware reports — likely raw ADC counts or mg), the valid range, and that setting zero effectively disables threshold filtering. Note that the write is silently skipped if `m_accessible` is false at call time (the threshold is then not applied to the device until the next reconnection).

---

**A06-9** · MEDIUM · No doc comment on `setShockPeriod(quint32 period)` (line 50); units undocumented

**Description:** No comment exists. The parameter `period` is written directly to the `shockPeriod` BLE characteristic. It is distinct from `gCfg->shockTimer()` (the debounce window used in `generateShockMessage`). Without documentation, callers cannot distinguish the two concepts or know the units for this parameter.

**Fix:** Document what `period` configures on the expansion module hardware (the hardware-side shock detection window), its units (seconds, milliseconds, or counts), and its relationship to the software-side `shockTimer()` debounce.

---

**A06-10** · LOW · No doc comment on `shockEvent()` (line 53); destructive dequeue behaviour undocumented

**Description:** `ShockEvent shockEvent()` dequeues and returns the front element of `m_shockEvents`. The name alone does not convey that the call is destructive (removing the item from the queue). A caller who calls this without first calling `isShockQueueEmpty()` on an empty queue will call `QQueue::dequeue()` on an empty container, which asserts in Qt debug builds and is undefined behaviour in release.

**Fix:** Add a comment stating that this method dequeues (removes and returns) the oldest shock event, that the queue must be non-empty before calling (check with `isShockQueueEmpty()`), and that calling on an empty queue is undefined.

---

**A06-11** · MEDIUM · No doc comment on `setCurrentTime(const QDateTime &time)` (line 55); timezone contract undocumented

**Description:** No comment exists. The implementation formats the `QDateTime` directly into the GATT Current Time struct fields using `.date().year()`, `.date().month()`, etc. with no timezone conversion. The call site in `setAccessible()` passes `QDateTime::currentDateTimeUtc()`, correctly using UTC. However, the public API does not document the expected timezone, so a different caller could pass a local-time `QDateTime`, silently setting the peripheral RTC to the wrong time. An incorrect RTC time directly affects shock event timestamps stored on the device.

**Fix:** Document that `time` must be in UTC, that the method silently returns if the device is not accessible, and that the RTC is used to timestamp shock events on the hardware.

---

**A06-12** · MEDIUM · No doc comment on `generateShockMessage(bool force)` (line 57); side-effect and return value semantics undocumented

**Description:** This is a non-trivial public method with complex state mutation. It inspects `m_shockEvent1`, compares timestamps against `gCfg->shockTimer()`, enqueues a `ShockEvent` into `m_shockEvents`, and resets the accumulator fields. The `bool` return value (`true` = a message was enqueued) is also what the timer loop uses to emit `shockOccurred()`. The `force` parameter bypasses the timer check. None of this is documented.

**Fix:** Document: (1) return value semantics — `true` if a shock event was enqueued and the caller should emit `shockOccurred()`; (2) `force = true` flushes any pending shock event immediately regardless of debounce period; (3) the method is idempotent if no shock has been accumulated (`m_shockEvent1.timestamp == 0`); (4) callers are responsible for subsequently draining the queue via `shockEvent()`.

---

**A06-13** · LOW · No doc comment on signal `accessible(bool yes)` (line 60)

**Description:** This signal conveys a critical lifecycle event: whether the BLE expansion peripheral is reachable. Callers need to know that `yes = true` means the peripheral is connected and initialised (RTC set, shock config applied, relays initialised), while `yes = false` means the connection was lost. No comment documents this.

**Fix:** Add a comment noting the signal is emitted when the expansion module connects (`true`) or disconnects (`false`), and that when `true` is emitted the RTC time, shock threshold/period, and relay states have already been applied to the hardware.

---

**A06-14** · LOW · No doc comment on signals `amberImpactOccurred()` and `redImpactOccurred()` (lines 63–64)

**Description:** These two signals represent distinct severity tiers for impact events. The logic in `popShockEvent()` defines amber as `(redImpact/2 < magnitude < redImpact)` and red as `magnitude > redImpact`, but this threshold logic is nowhere documented at the signal declarations.

**Fix:** Add comments to each signal declaration explaining the magnitude range that triggers it and its relationship to the `shockRedImpact()` configuration value.

---

**A06-15** · LOW · No doc comment on `equals128` in `BleExpansionUuid` (line 9)

**Description:** This utility function performs a 128-bit UUID comparison by casting to four `quint32` words and comparing sequentially. No comment explains the purpose, the expected byte layout of `quint128`, or why a manual loop is used instead of `memcmp`. The function is inline in the header and used extensively throughout `bleexpansion.cpp`.

**Fix:** Add a comment explaining that it compares two 128-bit Bluetooth UUIDs for equality by comparing four 32-bit words, and that the `quint128` layout is assumed to be 16 contiguous bytes in the platform-native representation used by Qt's Bluetooth stack.

---

**A06-16** · LOW · UUID constants in `BleExpansionUuid` have no documentation

**Description:** All 36 private `quint128` static UUID members (lines 20–56) are named only. No comment associates any UUID name with its actual 128-bit value, its GATT characteristic description, its read/write/notify properties, or which BLE peripheral service it belongs to. The actual values reside in an unreviewed `.cpp` definition file with no documentation. Because `BleExpansionUuid` is a friend-access-only class, this is an internal concern, but it significantly hampers maintainability.

**Fix:** Add a header-level comment block describing the UUID naming convention and peripheral service layout. Individually, each UUID member should have a brief comment giving the full UUID value and the characteristic's access type (R/W/Notify). At minimum, `authUuid` (used for authentication) and `shockCount`, `shockPeek`, `shockPop` (used for safety-critical impact data) should have values documented inline.

---

**A06-17** · HIGH · Authentication credential `AUTH_CODE` is a hard-coded plain-text string with no documentation

**Description:** Line 9 of `bleexpansion.cpp` defines `#define AUTH_CODE "uS8MgpklMx"`. This token is written verbatim to the `authUuid` BLE characteristic to authenticate with the expansion module (line 40 of the constructor). There is no comment explaining what the value is, how it was derived, whether it is shared across all deployed units, how it can be rotated, or what the consequences of its compromise are. Given that authentication controls access to relay outputs and shock threshold configuration, this is a security-relevant credential.

**Fix:** At minimum add a comment above the `#define` explaining its role, that it is a shared secret for the EM070 peripheral, and referencing any key-management process or hardware documentation. Longer-term, the credential should be moved out of source code into a configuration or provisioning mechanism, and this finding should be tracked as a security issue.

---

**A06-18** · INFO · `MAX_SHOCK_COUNT` macro is defined but apparently unused

**Description:** Line 11 of `bleexpansion.cpp` defines `#define MAX_SHOCK_COUNT 10000`. No usage of this constant was found in the file. There is no comment explaining its intended use or whether it was planned as a cap for the `m_shockEvents` queue or the hardware shock counter.

**Fix:** Either add a comment documenting its purpose and where it should be enforced, or remove it if it is a dead constant.

---

## Summary Table

| ID | Severity | Title |
|----|----------|-------|
| A06-1 | LOW | No doc comment on constructor |
| A06-2 | INFO | File-level usage comment is incomplete |
| A06-3 | LOW | No doc comment on `setEnabled` |
| A06-4 | INFO | No doc comments on device-info accessor group |
| A06-5 | LOW | No doc comment on `digitalInput`; out-of-range precondition missing |
| A06-6 | LOW | No doc comment on `relayOutput`; cached-value nature undocumented |
| A06-7 | LOW | No doc comment on `setRelayOutput`; silent-queue behaviour undocumented |
| A06-8 | MEDIUM | `setShockThreshold` units and range undocumented; safety-relevant |
| A06-9 | MEDIUM | `setShockPeriod` units and relationship to software timer undocumented |
| A06-10 | LOW | `shockEvent()` destructive dequeue behaviour undocumented |
| A06-11 | MEDIUM | `setCurrentTime` timezone contract undocumented; RTC accuracy affected |
| A06-12 | MEDIUM | `generateShockMessage` return-value and side-effect semantics undocumented |
| A06-13 | LOW | Signal `accessible` lifecycle semantics undocumented |
| A06-14 | LOW | Signals `amberImpactOccurred`/`redImpactOccurred` threshold logic undocumented |
| A06-15 | LOW | `BleExpansionUuid::equals128` has no doc comment |
| A06-16 | LOW | All 36 UUID constants undocumented |
| A06-17 | HIGH | Hard-coded authentication credential `AUTH_CODE` undocumented and unmanaged |
| A06-18 | INFO | `MAX_SHOCK_COUNT` defined but apparently unused and undocumented |

**Totals:** 1 HIGH, 4 MEDIUM, 9 LOW, 4 INFO
