# Pass 3 Agent A21 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Repo root:** C:/Projects/cig-audit/repos/mark3-pvd
**Files reviewed:**
- `ui/informationdialog.h` + `ui/informationdialog.cpp`
- `ui/keyfilter.h` + `ui/keyfilter.cpp`
- `ui/languagedialog.h` + `ui/languagedialog.cpp`

---

## Reading Evidence

### `ui/informationdialog.h` — Class: `InformationDialog`

Inherits: `QDialog`

**Public methods (header line numbers):**

| Line | Method |
|------|--------|
| 21 | `explicit InformationDialog(QWidget *parent = 0)` |
| 22 | `~InformationDialog()` |
| 23 | `void updateInformationScreen()` |
| 24 | `void setLux(int lux)` |
| 25 | `void setStatus(QByteArray IO, bool Rly1, bool Rly2, QByteArray can, const QByteArray &rssi, const QByteArray &moni, bool netStat, bool mdemStat, bool wifiStat, qint8 sat, qint32 lat, qint32 lon)` |
| 26 | `void setConfigParam()` |
| 27 | `void setBatteryStatus(bool avail, int state, int fault, quint16 voltage, qint16 current, quint16 temp, quint16 remainingCapacity)` |
| 28 | `void setExpModInfo(QByteArray mainVersion)` |
| 29 | `void setSuperMasterStatus()` |
| 30 | `void setVOR()` |
| 31 | `void setLastWiegand(quint64 id)` |
| 32 | `void languageChanged()` |

**Protected methods:**

| Line | Method |
|------|--------|
| 35 | `void showEvent(QShowEvent *)` |
| 36 | `void hideEvent(QHideEvent *)` |

**Signals:** None declared.

**Slots:** None declared (timer slot is connected anonymously via `connect`).

**Types / enums / constants defined:** None in header.
`UPDATE_CONFIG_TIMER_MS` (value: 5000) defined in `.cpp` at line 9 as a `#define`.

**Private members:**
- `Ui::InformationDialog *ui`
- `QMap<int, QString> m_chargeStatusMap` — maps charge state integer to translated string
- `QMap<int, QString> m_chargeFaultMap` — maps fault integer to translated string
- `QTimer *m_updateConfigTmr` — periodic refresh timer

---

### `ui/keyfilter.h` — Class: `KeyFilter`

Inherits: `QObject`

**Public methods (header line numbers):**

| Line | Method |
|------|--------|
| 12 | `explicit KeyFilter(QObject *parent = nullptr)` |
| 13 | `static bool isPowerKeyPressed()` — inline, returns `m_powerKeyPressed` |

**Signals:**

| Line | Signal |
|------|--------|
| 16 | `void showInfoDialog()` |

**Protected methods:**

| Line | Method |
|------|--------|
| 18 | `bool eventFilter(QObject *obj, QEvent *event)` |

**Private methods:**

| Line | Method |
|------|--------|
| 34 | `void resetKeyCount()` |
| 35 | `void incrementKeyCount(int key)` |
| 36 | `int getKeyCount(int key)` |
| 37 | `void resetKeyCounter(int key)` |
| 38 | `bool getPressState(int key)` |
| 39 | `void setPressState(int key, bool state)` |

**Private static members:**
- `static bool m_powerKeyPressed` — tracks whether the Return key (mapped to power key) is currently held

**Private instance members:**
- `QSet<int> m_pressedKeys` — set of currently depressed key codes
- `QTimer *m_timer` — 1.5-second debounce/sequence timer
- `int m_leftKeyCount`, `m_rightKeyCount`, `m_upKeyCount`, `m_downKeyCount` — consecutive single-key press counters
- `bool m_leftKeyPressed`, `m_rightKeyPressed`, `m_upKeyPressed`, `m_downKeyPressed` — per-key press state flags (note: `m_rightKeyPressed`, `m_upKeyPressed`, `m_downKeyPressed` are not initialised in constructor)

**Types / enums / constants defined:** None.

---

### `ui/languagedialog.h` — Class: `LanguageDialog`

Inherits: `QDialog`

**Public methods (header line numbers):**

| Line | Method |
|------|--------|
| 15 | `explicit LanguageDialog(QWidget *parent = nullptr)` |
| 16 | `~LanguageDialog()` |
| 17 | `void languageChanged()` |
| 18 | `void startScreenTimeout()` |

**Signals:**

| Line | Signal |
|------|--------|
| 21 | `void sigLanguageChanged()` |

**Private slots:**

| Line | Slot |
|------|------|
| 24 | `void on_btnEnglish_clicked()` |
| 25 | `void on_btnSpanish_clicked()` |
| 26 | `void on_btnQuit_clicked()` |

**Protected methods:**

| Line | Method |
|------|--------|
| 29 | `void showEvent(QShowEvent *event = 0)` |

**Private methods:**

| Line | Method |
|------|--------|
| 34 | `bool debounce()` |

**Types / enums / constants defined:** None in header.
`NO_ACTIVITY_TIME` (value: 10000) defined in `.cpp` at line 10 as a `#define`.

**Private members:**
- `Ui::LanguageDialog *ui`
- `QTimer *m_timer` — auto-reject timer fired after `NO_ACTIVITY_TIME` ms of inactivity
- `quint32 m_lastPress` — timestamp of last button press, used by `debounce()`

---

## Documentation Checks

### InformationDialog

1. **`InformationDialog(QWidget *parent = 0)`** — No doc comment. Constructor initialises the UI, reads `/proc/version` and `/home/root_version` from the filesystem, generates a version barcode, and sets up a periodic refresh timer. Non-trivial behaviour; not documented.
2. **`~InformationDialog()`** — No doc comment. Simple destructor; INFO-level only.
3. **`updateInformationScreen()`** — No doc comment. Called periodically by `m_updateConfigTmr`; refreshes config params, super-master status, and VOR status.
4. **`setLux(int lux)`** — No doc comment. Simple setter displaying lux value.
5. **`setStatus(...)`** — No doc comment. 12-parameter method updating relay state, signal strength, network/modem/WiFi connection state, digital IO, CAN, MONI, and GPS data. Very non-trivial; none of the parameters are described.
6. **`setConfigParam()`** — No doc comment. Reads from global config and populates the Configuration tab; also reads `/sys/class/net/wlan0/address` directly. Non-trivial side effects not documented.
7. **`setBatteryStatus(...)`** — No doc comment. 7-parameter method covering battery presence, charge state, fault code, voltage, current, temperature, and remaining capacity. None described.
8. **`setExpModInfo(QByteArray mainVersion)`** — No doc comment. Simple one-line setter.
9. **`setSuperMasterStatus()`** — No doc comment. Reads on-demand/super-master state from global config and derives remaining time; non-trivial logic.
10. **`setVOR()`** — No doc comment. Simple display toggle for VOR (Vehicle Off Road?) status.
11. **`setLastWiegand(quint64 id)`** — No doc comment. Displays last scanned Wiegand credential ID. Wiegand IDs are security-relevant data.
12. **`languageChanged()`** — No doc comment. Retranslates all UI strings and also re-opens `/sys/class/net/wlan0/address`; the file I/O side effect is not obvious from the signature.

### KeyFilter

1. **`KeyFilter(QObject *parent = nullptr)`** — No doc comment. Sets up a 1.5-second key-sequence timer.
2. **`isPowerKeyPressed()`** — No doc comment. Returns static flag tracking whether the Return/power key is currently held. The mapping of Qt::Key_Return to a "power key" concept is entirely undocumented; this is safety-relevant (vehicle power control).
3. **`showInfoDialog` (signal)** — No doc comment. Emitted under two conditions: (a) simultaneous Left+Up+Down chord, or (b) any single directional key pressed 4 times within 1.5 seconds. Neither trigger condition is documented.
4. **`eventFilter(QObject *obj, QEvent *event)`** — No doc comment. This is the core logic method; handles both key-press and key-release events, drives the power-key state machine, and triggers the info dialog. Completely undocumented.

### LanguageDialog

1. **`LanguageDialog(QWidget *parent = nullptr)`** — No doc comment. Standard constructor.
2. **`~LanguageDialog()`** — No doc comment. Simple destructor.
3. **`languageChanged()`** — No doc comment. Re-applies translated strings to all UI elements.
4. **`startScreenTimeout()`** — No doc comment. Starts a 10-second single-shot timer that calls `reject()` on expiry (closing the dialog). The caller-facing behaviour (auto-dismiss after 10 s) is not documented.
5. **`sigLanguageChanged` (signal)** — No doc comment. Emitted when English or Spanish is successfully set.

---

## Findings

**A21-1** · LOW · No documentation on `InformationDialog` constructor

**Description:** The constructor (`informationdialog.h` line 21) has no doc comment. Its behaviour extends well beyond field initialisation: it reads two system files (`/proc/version`, `/home/root_version`), generates a barcode checksum from combined version strings, populates charge-status and fault lookup maps, and wires the periodic refresh timer. None of these responsibilities are signalled by the declaration.

**Fix:** Add a comment above the declaration summarising the constructor's responsibilities, particularly the filesystem reads and barcode generation, so maintainers understand why the constructor can fail or produce different visual output in restricted environments.

---

**A21-2** · LOW · No documentation on `updateInformationScreen()`

**Description:** `updateInformationScreen()` (`informationdialog.h` line 23) is called on a timer every 5 seconds. There is no comment explaining its purpose, its trigger mechanism, or which subset of the display it refreshes (config params, super-master status, VOR — but not hardware versions or battery status).

**Fix:** Add a brief comment noting that this is the periodic-refresh callback and listing which sub-methods it invokes.

---

**A21-3** · LOW · No documentation on `setStatus()` — 12-parameter method with no parameter descriptions

**Description:** `setStatus()` (`informationdialog.h` line 25) takes 12 parameters covering physically distinct subsystems: relay states, CAN bus attributes, RSSI (supplied as a hex-encoded `QByteArray`), MONI data, network/modem/WiFi connection booleans, and GPS coordinates encoded as raw `qint32` values. None of the parameters are described. The encoding of `rssi` as a hex-ASCII `QByteArray` (converted via `.toInt(nullptr,16)` at runtime) is particularly opaque.

**Fix:** Add a parameter-level comment block describing each argument, including the hex-encoding convention for `rssi` and the raw fixed-point/integer units for `lat`/`lon`.

---

**A21-4** · LOW · No documentation on `setBatteryStatus()` — 7-parameter method with no parameter descriptions

**Description:** `setBatteryStatus()` (`informationdialog.h` line 27) accepts battery presence flag, charge-state code, fault code, voltage (mV), current (mA), temperature (degC), and remaining capacity (%). The units and the expected integer ranges for `state` and `fault` (valid values 0–3 per the lookup maps) are not documented anywhere in the header.

**Fix:** Add a comment above the declaration enumerating the valid range and unit for each parameter, particularly the integer code parameters `state` and `fault`.

---

**A21-5** · LOW · No documentation on `setConfigParam()`

**Description:** `setConfigParam()` (`informationdialog.h` line 26) populates the entire Configuration tab from the global config object. A notable undocumented side effect is that it also reads `/sys/class/net/wlan0/address` directly to populate the WiFi MAC label. This filesystem access is not apparent from the declaration.

**Fix:** Add a comment noting that this method reads from `gCfg` for most fields, but also directly reads the WiFi MAC address from the sysfs interface.

---

**A21-6** · LOW · No documentation on `setSuperMasterStatus()`

**Description:** `setSuperMasterStatus()` (`informationdialog.h` line 29) implements non-trivial logic: it checks on-demand active state, vehicle-enabled state, and computes remaining time by subtracting the local timestamp from the end time. The result is formatted as a `QDateTime` from `fromSecsSinceEpoch(timeRemaining)` — a potentially confusing calculation that treats a duration as an epoch. None of this is documented.

**Fix:** Add a comment describing the three display states (Inactive / Active-Vehicle-Disabled / Active-with-countdown) and note the timestamp arithmetic.

---

**A21-7** · MEDIUM · `languageChanged()` documentation omits file I/O side effect

**Description:** `languageChanged()` (`informationdialog.h` line 32) is named and appears to only re-translate UI strings. However, the implementation (`informationdialog.cpp` lines 306–309) also opens `/sys/class/net/wlan0/address` and sets the WiFi MAC label to `"na"` if the file cannot be opened. This file I/O side effect is entirely absent from the declaration and from any comment. Additionally, this is the second place this file is read (the first being `setConfigParam()`), but the two calls handle the absent-interface case differently: `setConfigParam()` simply skips the label update, while `languageChanged()` actively writes `"na"`.

**Fix:** Add a comment documenting the file I/O side effect and the divergent fallback behaviour relative to `setConfigParam()`. Ideally the inconsistency should be resolved, but at minimum it must be documented.

---

**A21-8** · HIGH · `isPowerKeyPressed()` has no documentation; Qt::Key_Return mapped to power key silently

**Description:** `isPowerKeyPressed()` (`keyfilter.h` line 13) is the sole public API by which other components determine whether the physical power key is currently held. There is no comment anywhere explaining that `Qt::Key_Return` is the hardware mapping for the power button on this device. A developer unfamiliar with the hardware would have no reason to associate the Return key with power state. The function is also a static accessor on `m_powerKeyPressed`, yet the class name and method name give no hint about this mapping. This is safety-relevant: incorrect interpretation of this flag could affect vehicle power management decisions.

**Fix:** Add a doc comment above the declaration stating that on this hardware platform Qt::Key_Return is the power key, explaining what "pressed" means (key held down, not a single press event), and noting the static scope.

---

**A21-9** · HIGH · `eventFilter()` has no documentation; dual trigger conditions for `showInfoDialog` are undocumented

**Description:** `eventFilter()` (`keyfilter.h` line 18) is the class's core logic method. It intercepts all key events for the application and implements two separate activation sequences for `showInfoDialog`: (1) simultaneous chord of Left+Up+Down, and (2) any single directional key pressed 4 consecutive times within 1.5 seconds. It also manages the power-key state machine. None of this is documented. The security implication is that an undocumented key sequence grants access to the information/diagnostic dialog, which could expose sensitive system configuration (GMTP server addresses, APN credentials, maintenance codes, Wiegand IDs).

**Fix:** Add a doc comment above the declaration describing both activation sequences, the power-key tracking responsibility, and a note that the method always returns `true` for all key events (consuming them, preventing propagation), which has UI-wide implications.

---

**A21-10** · LOW · `showInfoDialog` signal has no documentation

**Description:** The `showInfoDialog` signal (`keyfilter.h` line 16) is emitted under two distinct key-sequence conditions that are opaque from the name alone. There is no comment.

**Fix:** Add a comment above the signal declaration listing both trigger conditions (Left+Up+Down chord; 4× single directional key within 1.5 s).

---

**A21-11** · LOW · `startScreenTimeout()` has no documentation

**Description:** `startScreenTimeout()` (`languagedialog.h` line 18) starts a timer that auto-dismisses the dialog via `reject()` after 10 seconds of inactivity. The timeout duration and the dismissal mechanism (`reject()` vs `accept()`) are not documented. Callers cannot determine the timeout period or the returned dialog result code without reading the implementation.

**Fix:** Add a comment stating the timeout period (10 s, sourced from `NO_ACTIVITY_TIME`) and that expiry calls `reject()`.

---

**A21-12** · LOW · `sigLanguageChanged` signal has no documentation

**Description:** `sigLanguageChanged` (`languagedialog.h` line 21) is emitted only when `setLanguage()` returns a non-negative value (success). The condition for emission (successful language change, not merely a button click) is not documented.

**Fix:** Add a brief comment noting that the signal is emitted only when the language change succeeds (i.e., `setLanguage()` returns >= 0).

---

**A21-13** · INFO · Destructor, simple setter, and trivial accessor declarations lack doc comments

**Description:** The following declarations have no doc comments but are simple enough that the omission is informational only:
- `InformationDialog::~InformationDialog()` (line 22) — standard UI delete
- `InformationDialog::setLux(int lux)` (line 24) — single-label setter
- `InformationDialog::setExpModInfo(QByteArray mainVersion)` (line 28) — single-label setter
- `InformationDialog::setLastWiegand(quint64 id)` (line 31) — single-label setter
- `InformationDialog::setVOR()` (line 30) — binary display toggle
- `LanguageDialog::~LanguageDialog()` (line 16) — standard UI delete
- `LanguageDialog::languageChanged()` (line 17) — retranslates UI strings
- `KeyFilter::KeyFilter(...)` (line 12) — standard constructor

**Fix:** No immediate action required; consider adding one-line comments if a project-wide documentation standard is adopted.

---

## Summary Table

| ID | Severity | Location | Title |
|----|----------|----------|-------|
| A21-1 | LOW | `informationdialog.h:21` | No documentation on constructor |
| A21-2 | LOW | `informationdialog.h:23` | No documentation on `updateInformationScreen()` |
| A21-3 | LOW | `informationdialog.h:25` | No documentation on 12-parameter `setStatus()` |
| A21-4 | LOW | `informationdialog.h:27` | No documentation on 7-parameter `setBatteryStatus()` |
| A21-5 | LOW | `informationdialog.h:26` | No documentation on `setConfigParam()` (hidden sysfs read) |
| A21-6 | LOW | `informationdialog.h:29` | No documentation on `setSuperMasterStatus()` |
| A21-7 | MEDIUM | `informationdialog.h:32` | `languageChanged()` has undocumented file I/O side effect inconsistent with `setConfigParam()` |
| A21-8 | HIGH | `keyfilter.h:13` | `isPowerKeyPressed()` undocumented; Qt::Key_Return → power key mapping invisible |
| A21-9 | HIGH | `keyfilter.h:18` | `eventFilter()` undocumented; dual info-dialog trigger sequences and key-consumption policy invisible |
| A21-10 | LOW | `keyfilter.h:16` | `showInfoDialog` signal trigger conditions undocumented |
| A21-11 | LOW | `languagedialog.h:18` | `startScreenTimeout()` timeout period and dismissal mode undocumented |
| A21-12 | LOW | `languagedialog.h:21` | `sigLanguageChanged` emission condition undocumented |
| A21-13 | INFO | multiple | Simple getters/setters/destructors lack doc comments |
