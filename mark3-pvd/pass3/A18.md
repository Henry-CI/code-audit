# Pass 3 Agent A18 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Repo root:** C:/Projects/cig-audit/repos/mark3-pvd

---

## Reading Evidence

### File: `ui/amberimpactalertdialog.h` + `ui/amberimpactalertdialog.cpp`

**Class:** `AmberImpactAlertDialog` (extends `QDialog`)

**Public methods (header line numbers):**

| Line | Method | Has Doc Comment? |
|------|--------|-----------------|
| 15 | `explicit AmberImpactAlertDialog(QWidget *parent = nullptr)` | No |
| 16 | `~AmberImpactAlertDialog()` | No |
| 18 | `bool isOpen() const` | Yes — `// Method to check if the dialog is open` |
| 19 | `void closeWindow()` | No |
| 20 | `void languageChanged()` | No |

**Signals:** None declared.

**Public slots:**

| Line | Slot | Has Doc Comment? |
|------|------|-----------------|
| 23 | `void amberAlertDialogShowEvent(bool isLocked)` | No |

**Protected overrides:**

| Line | Method |
|------|--------|
| 26 | `void mouseReleaseEvent(QMouseEvent *)` |
| 27 | `void showEvent(QShowEvent *event = 0)` |

**Types, enums, constants defined:** None.

**Private data members:** `bool dialogOpenFlag`

**Implementation notes relevant to documentation accuracy:**
- `isOpen()` comment says "check if the dialog is open" — returns `dialogOpenFlag`, which is set to `true` only after `showEvent` confirms `gCfg->amberImpactAlertActive()` is true. So the flag does not strictly reflect `QDialog::isVisible()`; it is a safety interlock state flag. The comment is incomplete/potentially misleading.
- `closeWindow()` guards on `dialogOpenFlag` before calling `close()`. Without documentation this guard condition is invisible to callers.
- `amberAlertDialogShowEvent(bool isLocked)` is the primary safety-critical entry point: it suppresses the dialog when the system is locked. No documentation exists.
- `languageChanged()` updates UI strings for localisation; no comment.

---

### File: `ui/authoriseddialog.h` + `ui/authoriseddialog.cpp`

**Class:** `AuthorisedDialog` (extends `QDialog`)

**Public methods (header line numbers):**

| Line | Method | Has Doc Comment? |
|------|--------|-----------------|
| 17 | `explicit AuthorisedDialog(QWidget *parent = 0)` | No |
| 18 | `~AuthorisedDialog()` | No |
| 19 | `void setHasChecklist(bool yes)` | No |
| 20 | `void setDriverId(quint64 id)` | No |
| 21 | `void setTime(const QString s)` | No |
| 22 | `void setPower(bool on)` | No |
| 23 | `void updateCamera()` | No |

**Signals:**

| Line | Signal | Has Doc Comment? |
|------|--------|-----------------|
| 30 | `void userLogout()` | No |

**Protected overrides:**

| Line | Method |
|------|--------|
| 33 | `void showEvent(QShowEvent *)` |
| 34 | `void hideEvent(QHideEvent *)` |

**Private slots:**

| Line | Slot |
|------|------|
| 54 | `void rstLogout()` |
| 55 | `void onLogoutRequest()` |

**Types, enums, constants defined:**
- `#define RESET_TIMEOUT 2000` (in .cpp, not header)

**Private data members:** `m_waking`, `m_resetTimer`, `m_lastPress`, `m_pendingDriverId`, `m_showCamera`, `m_power`

**Implementation notes relevant to documentation accuracy:**
- `setDriverId(quint64 id)` stores the ID into `m_pendingDriverId`; it is consumed in `showEvent` to look up the driver name. The "pending" semantics — that the ID is buffered and applied on show — are not documented.
- `setPower(bool on)` affects camera state indirectly via `updateCamera()`; the camera control side-effect is undocumented.
- `updateCamera()` is public and writes directly to Linux sysfs GPIO paths (`/sys/class/gpio/gpio37/value`, `/sys/class/gpio/gpio39/value`). This hardware interaction is entirely undocumented.
- `setHasChecklist(bool yes)` controls visibility of the optional pre-op check button; no comment.
- `setTime(const QString s)` conditionally shows/hides the time label based on config; no comment.
- `userLogout()` signal is the primary authorisation exit path; emitted after two-press confirmation with debounce. No documentation.

---

### File: `ui/broadcastuidialog.h` + `ui/broadcastuidialog.cpp`

**Class:** `BroadcastUIDialog` (extends `QDialog`)

**Public methods (header line numbers):**

| Line | Method | Has Doc Comment? |
|------|--------|-----------------|
| 19 | `explicit BroadcastUIDialog(QWidget *parent = nullptr)` | No |
| 20 | `~BroadcastUIDialog()` | No |
| 22 | `void setUIParam(CIGCONF::BroadcastMessage m)` | No |

**Signals:**

| Line | Signal | Has Doc Comment? |
|------|--------|-----------------|
| 25 | `void messageClosed(CIGCONF::BroadcastMessage m)` | No |

**Private slots:** `onYes()`, `onNo()`, `onOK()`

**Types, enums, constants defined:**

| Line | Name | Values |
|------|------|--------|
| 17 | `enum MessageResult` | `MsgResultOK`, `MsgResultYes`, `MsgResultNo`, `MsgResultTimeout`, `MsgResultLogout`, `MsgResultNoDriver` |

**Implementation notes relevant to documentation accuracy:**
- `setUIParam(CIGCONF::BroadcastMessage m)` configures the entire dialog from a `BroadcastMessage` struct: truncates text to `BROADCASTMSG_TEXT_LEN`, shows a warning label based on `m.type`, toggles Yes/No vs OK buttons based on `m.res`, and starts an auto-dismiss timer if `m.timeout` is non-zero. None of this behaviour is documented.
- `MessageResult` enum contains `MsgResultLogout` and `MsgResultNoDriver` values that are never emitted within this file; callers may not know they can be returned. The enum is entirely uncommented.
- `messageClosed` signal carries back the `BroadcastMessage` but the relationship between signal and `done()` is non-obvious (the slots emit `done(int)` using enum values — the overload `done(int)` emits `finished(int)` from `QDialog`, not `messageClosed`). The signal `messageClosed` is declared but appears to never be emitted in the implementation; this is a documentation gap that could mislead callers who connect to it.

---

## Findings

**A18-1** · LOW · Missing doc comment on `AmberImpactAlertDialog::closeWindow()`
**Description:** `closeWindow()` is a public method that only closes the dialog if `dialogOpenFlag` is true. The guard condition is invisible to callers. There is no comment explaining when calling this method will have no effect.
**Fix:** Add a comment explaining that the method is a no-op when the dialog has not been opened via the safety interlock (`amberAlertDialogShowEvent`), e.g., `// Closes the dialog only if it was opened via amberAlertDialogShowEvent; no-op otherwise.`

---

**A18-2** · MEDIUM · Inaccurate doc comment on `AmberImpactAlertDialog::isOpen()`
**Description:** The comment `// Method to check if the dialog is open` (header line 18) implies it reflects general visibility state. The implementation returns `dialogOpenFlag`, which is only set to `true` when `showEvent` confirms `gCfg->amberImpactAlertActive()`. It can return `false` even when the `QDialog` is currently visible (e.g., if the dialog was opened by another code path). The comment misleads callers about what "open" means.
**Fix:** Replace the comment with an accurate description, e.g., `// Returns true if the dialog was opened through the amber alert safety interlock and has not yet been acknowledged.`

---

**A18-3** · HIGH · No documentation on `AmberImpactAlertDialog::amberAlertDialogShowEvent(bool isLocked)`
**Description:** This public slot is the safety-critical entry point for the amber impact alert. When `isLocked` is `true`, the alert is suppressed; when `false` and the global amber alert is active, `exec()` is called blocking the UI until the driver acknowledges. The `isLocked` parameter enforces a key safety precondition. None of this is documented — not the parameter meaning, not the blocking call behaviour, and not the guard on `gCfg->amberImpactAlertActive()`.
**Fix:** Add a doc comment explaining the parameter, the precondition check, and that the method blocks via `exec()`. E.g.:
```cpp
// Conditionally displays the amber impact alert dialog in a blocking modal loop.
// isLocked: when true, the alert is suppressed (vehicle is locked/unavailable).
// The dialog is only shown if the global amber alert is currently active and the
// dialog is not already open. Blocks until the driver acknowledges by tapping the screen.
```

---

**A18-4** · LOW · Missing doc comment on `AmberImpactAlertDialog::languageChanged()`
**Description:** The public `languageChanged()` method updates UI label text for localisation. There is no comment indicating this method must be called when the application language changes or that it retranslates the two primary visible labels.
**Fix:** Add a brief comment: `// Retranslates UI labels to the current application language. Call when the locale changes.`

---

**A18-5** · LOW · Missing doc comment on `AuthorisedDialog::setHasChecklist(bool yes)`
**Description:** This method shows or hides the optional pre-operation check button. The parameter name `yes` is non-descriptive and there is no comment explaining what a "checklist" is in this context or how the visibility change affects the driver workflow.
**Fix:** Add a comment: `// Shows the optional pre-op checklist button if yes is true; hides it otherwise.`

---

**A18-6** · LOW · Missing doc comment on `AuthorisedDialog::setDriverId(quint64 id)`
**Description:** The method stores the driver ID as `m_pendingDriverId`. The ID is only consumed during `showEvent` to look up the driver's display name. This deferred/pending semantics is entirely undocumented.
**Fix:** Add a comment: `// Sets the driver ID used to look up the driver name displayed on show. Must be set before the dialog is shown.`

---

**A18-7** · LOW · Missing doc comment on `AuthorisedDialog::setTime(const QString s)`
**Description:** The method updates the time label but also conditionally shows or hides it based on the global configuration `showTime()`. The conditional hide behaviour is undocumented; callers may not realise the label can be suppressed regardless of what value is passed.
**Fix:** Add a comment: `// Updates the displayed time string. The label is hidden if ShowTime is configured off, regardless of the value passed.`

---

**A18-8** · HIGH · No documentation on `AuthorisedDialog::setPower(bool on)` and `updateCamera()`
**Description:** `setPower(bool on)` and `updateCamera()` together control hardware GPIO lines on the target device (`/sys/class/gpio/gpio37/value` and `/sys/class/gpio/gpio39/value`) that switch a physical camera on or off, including a flip control. Both methods are public with no documentation. The hardware side-effect (raw sysfs GPIO writes) is critical for safety — incorrect use could leave a reversing camera disabled. Neither method has a comment, parameter description, or explanation of the GPIO pin mapping or the conditions under which the camera is forced on regardless of arguments (`CameraForced` mode).
**Fix:** Add doc comments to both methods describing the hardware interaction, the GPIO pin semantics, the CameraForced mode override behaviour, and the role of `m_power`/`m_showCamera` flags. Example for `setPower`:
```cpp
// Sets the power state used in camera visibility decisions.
// on: true when vehicle power is on. When false, camera is turned off via GPIO
// regardless of other settings (unless CameraForced mode is active).
// See updateCamera() for full decision logic.
```

---

**A18-9** · LOW · No documentation on `AuthorisedDialog::userLogout()` signal
**Description:** The `userLogout()` signal is the primary authorisation exit event. It is emitted only after a two-press confirmation sequence with a 200 ms debounce and a 2-second confirm-state reset timer. These preconditions and the confirmation flow are not documented anywhere in the header.
**Fix:** Add a comment above the signal declaration: `// Emitted after the driver confirms logout via a two-press confirmation sequence. Connected to the main application to revoke driver authorisation.`

---

**A18-10** · LOW · Missing doc comment on `BroadcastUIDialog::setUIParam(CIGCONF::BroadcastMessage m)`
**Description:** This is the only non-trivial public configuration method on `BroadcastUIDialog`. It controls text content, warning visibility, button layout (OK vs Yes/No), and auto-dismiss timeout — all derived from fields of the `BroadcastMessage` struct. None of these behaviours are documented.
**Fix:** Add a doc comment:
```cpp
// Configures the dialog from a BroadcastMessage:
//   m.text    - message body (truncated to BROADCASTMSG_TEXT_LEN)
//   m.type    - non-zero shows the warning icon
//   m.res     - non-zero shows Yes/No buttons; zero shows OK button
//   m.timeout - non-zero starts an auto-dismiss timer (value in seconds)
```

---

**A18-11** · MEDIUM · `MessageResult` enum values `MsgResultLogout` and `MsgResultNoDriver` are undocumented and never emitted
**Description:** The `MessageResult` enum (header line 17) declares six values. `MsgResultLogout` and `MsgResultNoDriver` are never emitted in `broadcastuidialog.cpp`. There are no comments on any enum values. Callers connecting to `done(int)` or iterating result codes have no guidance on when these values can occur, which can lead to incomplete result handling.
**Fix:** Add inline comments on each enum value explaining its meaning and which code path produces it. Clarify in the header (or in associated documentation) that `MsgResultLogout` and `MsgResultNoDriver` are reserved for use by external callers or future expansion.

---

**A18-12** · MEDIUM · `messageClosed` signal declared but never emitted; no documentation
**Description:** The `messageClosed(CIGCONF::BroadcastMessage m)` signal (header line 25) is declared as the public notification interface for dialog closure. However, the implementation slots (`onYes`, `onNo`, `onOK`, and the timer lambda) all emit `done(int)` (the `QDialog` base-class mechanism), not `messageClosed`. There is no documentation explaining this discrepancy. Callers who connect to `messageClosed` will never receive the notification, silently losing message results.
**Fix:** Either emit `messageClosed` from the relevant slots or remove the signal and document that callers should connect to `QDialog::finished(int)` using `MessageResult` cast values. Add a comment regardless so the design intent is clear.

---

## Summary Table

| ID | Severity | File | Short Title |
|----|----------|------|-------------|
| A18-1 | LOW | amberimpactalertdialog.h/.cpp | Missing doc on `closeWindow()` — guard condition undocumented |
| A18-2 | MEDIUM | amberimpactalertdialog.h/.cpp | Inaccurate comment on `isOpen()` — misrepresents flag semantics |
| A18-3 | HIGH | amberimpactalertdialog.h/.cpp | No documentation on safety-critical slot `amberAlertDialogShowEvent()` |
| A18-4 | LOW | amberimpactalertdialog.h/.cpp | Missing doc on `languageChanged()` |
| A18-5 | LOW | authoriseddialog.h/.cpp | Missing doc on `setHasChecklist()` |
| A18-6 | LOW | authoriseddialog.h/.cpp | Missing doc on `setDriverId()` — pending/deferred semantics undocumented |
| A18-7 | LOW | authoriseddialog.h/.cpp | Missing doc on `setTime()` — conditional hide behaviour undocumented |
| A18-8 | HIGH | authoriseddialog.h/.cpp | No documentation on `setPower()`/`updateCamera()` — hardware GPIO side-effects |
| A18-9 | LOW | authoriseddialog.h/.cpp | No documentation on `userLogout()` signal — two-press confirmation undocumented |
| A18-10 | LOW | broadcastuidialog.h/.cpp | Missing doc on `setUIParam()` — all configuration fields undocumented |
| A18-11 | MEDIUM | broadcastuidialog.h/.cpp | `MessageResult` enum values undocumented; two values never emitted |
| A18-12 | MEDIUM | broadcastuidialog.h/.cpp | `messageClosed` signal declared but never emitted — silent connection failure |

**Totals:** 2 HIGH, 3 MEDIUM, 7 LOW
