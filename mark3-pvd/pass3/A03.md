# Pass 3 Agent A03 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `app/backgroundworker.h` + `app/backgroundworker.cpp`
- `app/checklist.h` + `app/checklist.cpp`

---

## 1. Reading Evidence

### 1.1 `backgroundworker.h`

#### Class: `OtaWorker` (line 38)
Inherits `QObject`.

**Public methods:**

| Line | Method |
|------|--------|
| 42 | `explicit OtaWorker(QObject *parent = nullptr)` |
| 43 | `void unpack()` |

**Public member variables:**

| Line | Name | Type |
|------|------|------|
| 45 | `m_isRunning` | `QAtomicInteger<quint32>` |

**Signals:**

| Line | Signal |
|------|--------|
| 48 | `sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra)` |
| 49 | `started()` |
| 50 | `ready()` |
| 51 | `failed()` |

**Types / Enums / Constants:** None defined within this class.

---

#### Class: `BackgroundWorker` (line 62)
Inherits `QObject`.

**Public methods:**

| Line | Method |
|------|--------|
| 68 | `explicit BackgroundWorker(QObject *parent = nullptr)` |
| 69 | `void setUI(Dialog *ui)` |
| 70 | `bool networkStatus()` (inline) |

**Public enums:**

| Line | Enum | Values |
|------|------|--------|
| 66 | `QuitMode` | `QuitReboot`, `QuitPowerOff`, `QuitApp` |

**Signals:**

| Line | Signal |
|------|--------|
| 80 | `powerStateChanged(CIGCONF::PowerState state)` |
| 81 | `reboot()` |
| 82 | `lockScreen(CIGCONF::MaintLockedCode code, bool remote)` |
| 83 | `ambertImpactScreen()` |
| 84 | `cardAuthorised(bool yes, quint64 id)` |
| 85 | `updateStatusInfo(QByteArray IO, bool Rly1, bool Rly2, QByteArray can, const QByteArray& rssi, const QByteArray& moni, bool netStat, bool modemStat, bool wifiStat, qint8 sat, qint32 lat, qint32 lon)` |
| 86 | `cmdMsgReceived(CIGCONF::BroadcastMessage m)` |
| 87 | `onDemandStarted(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc)` |
| 88 | `onDemandExtended(quint32 start, quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc)` |
| 89 | `onDemandEnded(quint32 end, quint64 id, CIGCONF::OnDemandCmdSrc)` |
| 90 | `sigLanguageChanged()` |
| 91 | `cmdLogin(quint64 id)` |
| 92 | `unpackOta()` |
| 93 | `cameraSettingsUpdated()` |

**Private enum (internal):**

| Line | Enum | Values |
|------|------|--------|
| 100 | `EthernetInterface` | `EthModem`, `EthWifi` |

**Slots:** All slots are private (no explicit `slots:` label in the public interface; private methods wired via `connect()` serve as slots).

---

### 1.2 `checklist.h`

#### Class: `Checklist` (line 6)
Plain C++ class (no `QObject`).

**Nested type:**

| Line | Type | Description |
|------|------|-------------|
| 9 | `struct CheckItem` | Represents a single checklist question. Contains a union with a bitfield (`qId:31`, `doNotRandomize:1`) aliased over `questionId`, a `CIGCONF::ChecklistType type`, `quint8 questionLen`, and `char question[CHECKLIST_QUESTION_LEN_100+1]`. |

**Public methods:**

| Line | Method |
|------|--------|
| 23 | `Checklist()` (constructor) |
| 25 | `static bool isValidCheckItem(const CheckItem &item)` (inline) |
| 27 | `void readChecklist()` |
| 29 | `void saveChecklist()` |
| 30 | `void clear()` |
| 31 | `void shuffleChecklist()` |
| 34 | `const CheckItem & checkItem(int index, bool query = false) const` |
| 35 | `bool setCheckItem(int index, const CheckItem &item)` |
| 36 | `quint32 checksum() const` |

**Types / Enums / Constants:** None additional beyond `CheckItem` struct. Uses `CIGCONF::ChecklistType` (defined elsewhere).

**Signals / Slots:** None (not a `QObject`).

---

## 2. Documentation Findings

### 2.1 `backgroundworker.h` / `backgroundworker.cpp`

**A03-1** · LOW · `OtaWorker::unpack()` has no doc comment

**Description:** `unpack()` is a public method that decompresses a downloaded OTA firmware file, verifies its CRC-16, and emits `started`/`ready`/`failed` signals. It is the primary entry point for triggering an over-the-air update and involves file I/O, zlib decompression, and CRC validation. No comment of any kind appears above the declaration on line 43.

**Fix:** Add a doc comment above line 43 explaining the purpose, the precondition (firmware file must be present on disk), the signals emitted on each outcome, and that the method is re-entry-safe via `m_mutex.tryLock()`.

---

**A03-2** · INFO · `OtaWorker::OtaWorker()` constructor has no doc comment

**Description:** The constructor on line 42 has no doc comment. It is a trivial delegating constructor; the absence of documentation is low impact.

**Fix:** A one-line `// Constructs an OtaWorker; call unpack() from a worker thread.` is sufficient.

---

**A03-3** · HIGH · `OtaWorker::m_isRunning` public atomic member has no doc comment

**Description:** `m_isRunning` (line 45) is a publicly exposed `QAtomicInteger<quint32>` that is read and written by `unpack()` to signal whether the OTA operation is in progress. Public mutable state that is shared across threads (the `OtaWorker` runs in `m_otaThread`) warrants clear documentation of ownership, valid values (0 = idle, 1 = running), thread-safety guarantees, and intended readers. None is present.

**Fix:** Add a comment such as:
```cpp
// Atomic flag indicating whether unpack() is currently executing.
// 0 = idle, 1 = running. Read-only from outside this class.
QAtomicInteger<quint32> m_isRunning;
```

---

**A03-4** · LOW · `BackgroundWorker::setUI(Dialog *ui)` has no doc comment

**Description:** `setUI()` (line 69) is a non-trivial public method that wires all Qt signal/slot connections between `BackgroundWorker` and the `Dialog` UI. It must be called exactly once after construction and before the background worker's event loop starts processing events. The order-of-call constraint and the side-effect of establishing all cross-thread connections are undocumented.

**Fix:** Add a doc comment noting the precondition (must be called before event processing begins), the parameter (`ui` must be non-null and already constructed), and the fact that this call establishes all UI-to-worker signal/slot wiring.

---

**A03-5** · INFO · `BackgroundWorker::networkStatus()` inline method has no doc comment

**Description:** `networkStatus()` (line 70) is a simple public getter returning `m_wifiState || m_modemState`. It is trivially understandable from its name and body, but no description of what "network status" means (true = at least one WAN interface is up) appears at the call site.

**Fix:** A one-line comment such as `// Returns true if at least one WAN interface (Wi-Fi or modem) is currently connected.` would be sufficient.

---

**A03-6** · LOW · `BackgroundWorker::QuitMode` enum values have no doc comments

**Description:** The `QuitMode` enum (line 66) has three values — `QuitReboot`, `QuitPowerOff`, `QuitApp` — with no explanation of the difference in behaviour between them. Callers invoking `quit()` (private) need to know when each mode is appropriate. The difference between `QuitReboot` (reboot the OS), `QuitPowerOff` (power down the hardware), and `QuitApp` (exit the Qt application without a system-level shutdown) is not self-evident from the names alone.

**Fix:** Add inline comments for each enumerator:
```cpp
enum QuitMode {
    QuitReboot,    // Reboot the OS after ACKs are sent
    QuitPowerOff,  // Power off the hardware after ACKs are sent
    QuitApp        // Exit the Qt application only (no OS-level shutdown)
};
```

---

**A03-7** · LOW · `BackgroundWorker` constructor has no doc comment

**Description:** The constructor (line 68) initialises numerous subsystem objects and timers, and wires OTA-related signal/slot connections. No comment explains the construction sequence, ownership model, or the fact that `setUI()` must be called separately before the object is fully operational.

**Fix:** Add a brief doc comment noting that `setUI()` must be called before the worker is ready to process events.

---

**A03-8** · LOW · All `BackgroundWorker` signals lack doc comments

**Description:** None of the 13 signals declared in lines 80-93 have any documentation. Several carry non-obvious semantics:
- `lockScreen(CIGCONF::MaintLockedCode code, bool remote)` — the meaning of the `remote` flag is undocumented.
- `onDemandStarted` / `onDemandExtended` / `onDemandEnded` — the `start`/`end` parameters are Unix timestamps, and the default `CIGCONF::OnDemandCmdSrc` values are silent.
- `updateStatusInfo` — carries 12 parameters with abbreviated names (`IO`, `Rly1`, `Rly2`, `rssi`, `moni`) whose semantics are not explained.

**Fix:** Add at minimum a one-line comment per signal. For signals with non-trivial parameter semantics (`lockScreen`, `updateStatusInfo`, `onDemandStarted`/`Extended`/`Ended`), describe each parameter.

---

### 2.2 `checklist.h` / `checklist.cpp`

**A03-9** · HIGH · `Checklist::CheckItem` struct and its bitfield union have no doc comment

**Description:** `CheckItem` (line 9) uses a union containing a named bitfield (`qId:31`, `doNotRandomize:1`) aliased over `questionId`. This pattern is non-trivial: `doNotRandomize` occupies bit 31 of `questionId`, meaning any code that reads `questionId` as a plain 32-bit integer will silently include the randomization flag in the value. There is no comment explaining this aliasing, the meaning of `doNotRandomize`, the significance of the 31-bit question ID space, or the fact that `questionId` and the bitfield struct must not be used simultaneously without masking.

**Fix:** Add a block comment above the struct and inline comments on each union member explaining the layout, the purpose of `doNotRandomize`, and how callers should read the question ID (via `qId`, not `questionId`, when the flag needs to be excluded).

---

**A03-10** · MEDIUM · `Checklist::checkItem()` `query` parameter behaviour is undocumented and potentially misleading

**Description:** `checkItem(int index, bool query = false)` (line 34) has a one-line comment `//Moved the implementation in the cpp file to fix circular dependency` which describes an implementation detail unrelated to the method's semantics. The `query` parameter controls whether the method returns the canonical (unshuffled) item or respects the shuffle/randomisation state. When `query == true`, the raw unshuffled item is always returned regardless of the `preopRandom()` setting; when `query == false`, the shuffled array is used if randomisation is enabled. This distinction is safety-relevant for checklist integrity: callers that intend to present questions to the driver must use `query = false`, while callers that need to inspect the configured question (e.g., for saving or transmitting) must use `query = true`. The existing comment does not mention any of this.

**Fix:** Replace the existing comment with one that documents:
- The `index` valid range (0 to `CHECKLIST_MAX_IDX - 1`).
- The meaning of `query`: `true` returns the unshuffled source item; `false` returns the item as it should be presented to the driver (shuffled if `preopRandom()` is active).
- The return value (a const reference — callers must not store it past the object's lifetime).

---

**A03-11** · LOW · `Checklist::shuffleChecklist()` has no doc comment

**Description:** `shuffleChecklist()` (line 31) populates the internal `m_checkItems_shuffled` array using a cryptographically seeded Mersenne Twister (`std::random_device` + `std::mt19937`). It only shuffles items where `doNotRandomize == 0`. No comment explains when this must be called relative to `readChecklist()`, whether it is idempotent, or what effect it has on the `checkItem()` accessor.

**Fix:** Add a doc comment explaining the shuffle algorithm preconditions, post-conditions, and the relationship to `checkItem(index, false)`.

---

**A03-12** · LOW · `Checklist::checksum()` has no doc comment

**Description:** `checksum()` (line 36) computes an XOR of all valid `questionId` values. The choice of XOR as a checksum is weak (it does not detect reordering or even-number substitutions) and the purpose of the checksum — used to detect whether the checklist has changed — is not stated. No documentation explains what value callers should compare against, when stale checksums indicate a sync problem, or the limitations of the algorithm.

**Fix:** Add a doc comment describing the return value, the algorithm (XOR fold over valid question IDs), the intended use (change detection), and the known limitation that XOR does not detect all substitution attacks.

---

**A03-13** · INFO · `Checklist::readChecklist()`, `saveChecklist()`, and `clear()` have no doc comments

**Description:** These three methods (lines 27, 29, 30) are public lifecycle operations with no documentation. `readChecklist()` silently does nothing if `m_dirty` is true; `saveChecklist()` silently does nothing if `m_dirty` is false and also deletes the legacy v50 file on a successful save; `clear()` marks the object dirty without saving. These side-effects are not documented.

**Fix:**
- `readChecklist()`: document the `m_dirty` guard (reads are skipped if unsaved changes exist) and the v50 fallback behaviour.
- `saveChecklist()`: document the no-op guard, the atomic-save via `QSaveFile`, and the legacy-file deletion.
- `clear()`: document that this marks the in-memory state dirty and that `saveChecklist()` must be called to persist the clear.

---

**A03-14** · INFO · `Checklist::setCheckItem()` has no doc comment

**Description:** `setCheckItem(int index, const CheckItem &item)` (line 35) returns a `bool` indicating success or failure (returns `false` for out-of-bounds index). No documentation describes the valid index range, the return value semantics, or the fact that the change is only persisted after a subsequent `saveChecklist()` call.

**Fix:** Add a doc comment describing the index range, the return value, and the deferred-persistence model.

---

**A03-15** · INFO · `Checklist::isValidCheckItem()` inline has no doc comment

**Description:** The static inline `isValidCheckItem(const CheckItem &item)` (line 25) returns `item.questionLen` treated as a boolean. This implies that an item with `questionLen == 0` is considered invalid (empty/unpopulated slot). This is used as the canonical emptiness test throughout the class but is not documented.

**Fix:** Add a one-line comment: `// Returns true if item is populated (questionLen > 0).`

---

## 3. Summary Table

| ID | Severity | File | Location | Title |
|----|----------|------|----------|-------|
| A03-1 | LOW | `backgroundworker.h` | line 43 | `OtaWorker::unpack()` missing doc comment |
| A03-2 | INFO | `backgroundworker.h` | line 42 | `OtaWorker` constructor missing doc comment |
| A03-3 | HIGH | `backgroundworker.h` | line 45 | Public atomic `m_isRunning` missing thread-safety documentation |
| A03-4 | LOW | `backgroundworker.h` | line 69 | `BackgroundWorker::setUI()` missing doc comment |
| A03-5 | INFO | `backgroundworker.h` | line 70 | `BackgroundWorker::networkStatus()` missing doc comment |
| A03-6 | LOW | `backgroundworker.h` | line 66 | `QuitMode` enum values undocumented |
| A03-7 | LOW | `backgroundworker.h` | line 68 | `BackgroundWorker` constructor missing doc comment |
| A03-8 | LOW | `backgroundworker.h` | lines 80-93 | All signals missing doc comments |
| A03-9 | HIGH | `checklist.h` | line 9 | `CheckItem` bitfield union aliasing undocumented |
| A03-10 | MEDIUM | `checklist.h` | line 34 | `checkItem()` `query` parameter semantics undocumented / misleading comment |
| A03-11 | LOW | `checklist.h` | line 31 | `shuffleChecklist()` missing doc comment |
| A03-12 | LOW | `checklist.h` | line 36 | `checksum()` missing doc comment; algorithm weakness unstated |
| A03-13 | INFO | `checklist.h` | lines 27/29/30 | `readChecklist()`, `saveChecklist()`, `clear()` side-effects undocumented |
| A03-14 | INFO | `checklist.h` | line 35 | `setCheckItem()` return value and persistence model undocumented |
| A03-15 | INFO | `checklist.h` | line 25 | `isValidCheckItem()` validity criterion undocumented |
