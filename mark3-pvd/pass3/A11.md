# Pass 3 Agent A11 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:** `main.cpp`, `mytranslator.h`, `mytranslator.cpp`

---

## Reading Evidence

### `main.cpp`

**File purpose:** Application entry point. Initialises `QApplication`, installs a key event filter, loads the locale, registers Qt meta-types for cross-thread signals, configures hardware GPIOs for video switch and flip, creates the main `Dialog` window and a `BackgroundWorker` on a dedicated thread, then enters the Qt event loop.

**Free functions defined in this file:**

| Name | Line | Notes |
|---|---|---|
| `hideBootProgress()` | 24 | Writes `-1` to the NUC970 framebuffer `progress` sysfs node to suppress the boot animation |
| `configureCrashLogging()` | 38 | Writes and launches a shell watchdog script to `/mnt/sd/app_monitor`; call is commented-out in `main` |
| `main(int argc, char *argv[])` | 71 | Entry point |

**Signals / slots:** None defined in this file.

**Types / enums / constants defined:** None; uses types from included headers (`CIGCONF::PowerState`, `CIGCONF::GmtpMessage`, etc. are only registered here via `qRegisterMetaType`).

**Preprocessor symbols used:**
- `CONSTRAINED_MEMORY_TEST` (line 17, commented out) — reserves and locks 10 MB with `mlock`
- `__arm__` — guards ARM-specific DPI attribute and `hideBootProgress` sysfs write

---

### `mytranslator.h` + `mytranslator.cpp`

**File purpose:** Manages application locale/translation: loading a saved language preference on startup, switching languages at runtime, querying the current language, and removing the active translator.

**Constants defined (header, lines 11–12):**

| Name | Value | Line |
|---|---|---|
| `langEnglish` | `"EN"` | 11 |
| `langSpanish` | `"ES"` | 12 |

**Global variable declared (header, line 14):**

| Name | Type | Line |
|---|---|---|
| `mTranslator` | `QTranslator` | 14 |

**Free functions declared (header) / defined (implementation):**

| Name | Header line | Impl line | Brief purpose |
|---|---|---|---|
| `loadLocalLanguage(void)` | 15 | 15 | Reads `local.dat`, looks up the language code in `lang.dat`, loads the matching `.qm` file; deletes `local.dat` if the code is not found |
| `updateLocalLanguage(const QString &arg1)` | 16 | 74 | Searches `lang.dat` for `arg1`; if found, loads the translator and writes the code to `local.dat`; if not found, removes the translator and deletes `local.dat` |
| `getCurrentLanguage(void)` | 17 | 132 | Returns the current language code string (defaults to `"EN"` when no valid preference is stored) |
| `queryLanguage(void)` | 18 | 167 | Returns `QLocale::English`, `QLocale::Spanish`, or `-1` based on the stored preference |
| `setLanguage(int local)` | 19 | 177 | Changes the stored language to the given `QLocale` integer value; no-ops if already set; returns the value applied or `-1` for unsupported locales |
| `removeTranslator()` | 20 | 190 | Removes `mTranslator` from `QCoreApplication` if it is non-empty |

**Signals / slots:** None (not a QObject subclass).

**Types / enums:** None beyond the constants listed above.

---

## Documentation Findings

### A11-1 · LOW · `main.cpp` has no file-level comment explaining the startup sequence

**Description:** The file contains no file-level block or line comment describing its purpose, the overall startup sequence, or the threading model. Readers must trace through the entire body of `main()` to understand that a `BackgroundWorker` is moved to a separate thread, that GPIO lines are driven unconditionally on every launch, and that `configureCrashLogging` is intentionally disabled. The two helper functions `hideBootProgress` and `configureCrashLogging` also lack any comment above their definitions.

**Fix:** Add a file-level block comment (or `/** @file */` Doxygen header) at the top of `main.cpp` summarising: (1) the application entry point, (2) the startup sequence (locale load -> meta-type registration -> hardware GPIO init -> UI creation -> background thread launch), and (3) the threading model. Add a one-line comment above each helper function explaining what it does and on which platform it is active.

---

### A11-2 · INFO · `hideBootProgress()` has no doc comment

**Description:** The function is defined in `main.cpp` at line 24 without any comment above it. Its purpose (disabling the NUC970 framebuffer boot-progress animation by writing `-1` to a sysfs node) and its ARM-only scope are not documented. The function name is reasonably self-describing, which limits severity.

**Fix:** Add a short comment above the definition: what sysfs node is written, what value and effect, and that the function is a no-op on non-ARM builds.

---

### A11-3 · LOW · `configureCrashLogging()` has no doc comment and is dead code with no explanation

**Description:** The function at line 38 has no comment above it. Its call at line 101 is commented out with no explanation of why it is disabled. The function writes a shell watchdog script to `/mnt/sd/app_monitor` and then launches it with `QProcess::startDetached`. The absence of a comment leaves it unclear whether this is intentionally disabled for a release build, a work-in-progress, or dead code that should be removed.

**Fix:** Add a doc comment above the definition explaining its purpose, the crash-detection mechanism, and the reason the call is commented out in `main`. If permanently disabled, add an inline comment at the call site (e.g., `// disabled: see <ticket> — watchdog conflicts with systemd supervisor`).

---

### A11-4 · MEDIUM · Doc comment for `loadLocalLanguage` is empty (stub only)

**Description:** The implementation at `mytranslator.cpp` lines 12–14 contains:
```cpp
/**
 * @brief loadLocalLanguage
 */
```
This provides no information beyond the function name. The function has a non-trivial side-effect: it reads `local.dat`, validates the language code against `lang.dat`, installs a Qt translator, and — importantly — **deletes `local.dat`** if the stored language code is not found. None of this behaviour, nor the two data files it depends on, is documented. There are no `@param` or `@return` annotations (though both are `void`, the file-dependency side-effect warrants description).

**Fix:** Expand the comment to describe: what `local.dat` and `lang.dat` contain, the fallback-to-English behaviour, and the destructive side-effect of removing `local.dat` on an unrecognised language code.

---

### A11-5 · MEDIUM · Doc comment for `updateLocalLanguage` is empty (stub only)

**Description:** The implementation at `mytranslator.cpp` lines 71–73 contains:
```cpp
/**
 * @brief updateLocalLanguage
 */
```
The `@param arg1` is not described. The function performs two distinct actions — installing a new translator into `QCoreApplication` and persisting the choice to `local.dat` — and also has a destructive fallback (removes the translator and deletes `local.dat` for unknown codes). None of this is documented.

**Fix:** Add `@param arg1` description (language code string, e.g. `"EN"` or `"ES"`), describe the persistence mechanism, and note the fallback behaviour when the code is not found in `lang.dat`.

---

### A11-6 · MEDIUM · Doc comment for `getCurrentLanguage` is incomplete (missing `@return`)

**Description:** The implementation at `mytranslator.cpp` lines 128–131 contains:
```cpp
/**
 * @brief getCurrentLanguage
 * @return
 */
```
The `@return` tag is present but its value is blank — it documents nothing. The function returns the stored language code string (e.g. `"EN"`) or defaults to `langEnglish` (`"EN"`) when no valid preference exists. The default-to-English fallback behaviour is not noted.

**Fix:** Complete the `@return` annotation: `@return The current language code string (e.g. "EN", "ES"); defaults to "EN" if no valid preference is stored.`

---

### A11-7 · LOW · `queryLanguage()` has no doc comment

**Description:** The function is declared in the header at line 18 and defined at `mytranslator.cpp` line 167 with no comment of any kind. It returns a `QLocale` enum integer (`QLocale::English`, `QLocale::Spanish`, or `-1`), which is non-obvious from the name alone. The sentinel value `-1` for unsupported/unknown languages is undocumented.

**Fix:** Add a comment above the declaration in `mytranslator.h` and/or above the definition in `mytranslator.cpp` describing the return type semantics: `@return QLocale::English, QLocale::Spanish, or -1 if the current language is unrecognised.`

---

### A11-8 · LOW · `setLanguage()` has no doc comment

**Description:** The function is declared in the header at line 19 and defined at `mytranslator.cpp` line 177 with no comment. The parameter is a `QLocale` integer, the no-op condition (`local == queryLanguage()`), the unsupported-language sentinel return of `-1`, and the fact that it delegates to `updateLocalLanguage` are all undocumented. The distinction between `setLanguage` and `updateLocalLanguage` (public API vs. internal implementation) is unclear without comments.

**Fix:** Add `@param local` (QLocale integer, e.g. `QLocale::English`), `@return` (the value applied, or `-1` for unsupported locales), and note the no-op behaviour when the language is already set.

---

### A11-9 · INFO · `removeTranslator()` has no doc comment

**Description:** The function is declared in the header at line 20 and defined at `mytranslator.cpp` line 190 with no comment. The function is simple — it removes `mTranslator` from `QCoreApplication` if non-empty — but it is a public API function and its pre-condition (the translator must already have been loaded) and side-effect are undocumented.

**Fix:** Add a brief one-line comment: when this should be called (e.g. before a language switch or application shutdown) and what it does if the translator is already empty (silent no-op).

---

### A11-10 · INFO · Constants `langEnglish` and `langSpanish` have no doc comments

**Description:** The two string constants declared in `mytranslator.h` at lines 11–12 have no comments. Their values (`"EN"`, `"ES"`) are clear from inspection, but the format convention (ISO 639-1 two-letter codes, case-insensitive as used in comparisons) is not documented.

**Fix:** Add a brief inline or block comment noting that these constants represent ISO 639-1 language codes used in `local.dat` and `lang.dat`, and that comparisons are case-insensitive.

---

### A11-11 · INFO · Global `mTranslator` has no doc comment

**Description:** The global `QTranslator mTranslator` is declared `extern` in `mytranslator.h` line 14 and defined in `mytranslator.cpp` line 10 with no comment. Its scope (global, shared across all translation functions), ownership (managed by `mytranslator.cpp`), and lifetime are undocumented.

**Fix:** Add a brief comment explaining that this is the single application-wide translator instance managed by the `mytranslator` module, and that callers should not install or remove it directly.

---

## Summary Table

| ID | Severity | File | Symbol | Issue |
|---|---|---|---|---|
| A11-1 | LOW | `main.cpp` | (file level) | No file-level comment; no comments on helper functions |
| A11-2 | INFO | `main.cpp` | `hideBootProgress()` | No doc comment |
| A11-3 | LOW | `main.cpp` | `configureCrashLogging()` | No doc comment; disabled call unexplained |
| A11-4 | MEDIUM | `mytranslator.cpp` | `loadLocalLanguage()` | Stub `@brief` only; destructive side-effect undocumented |
| A11-5 | MEDIUM | `mytranslator.cpp` | `updateLocalLanguage()` | Stub `@brief` only; param and side-effects undocumented |
| A11-6 | MEDIUM | `mytranslator.cpp` | `getCurrentLanguage()` | `@return` tag present but blank; default behaviour undocumented |
| A11-7 | LOW | `mytranslator.h/.cpp` | `queryLanguage()` | No doc comment; `-1` sentinel undocumented |
| A11-8 | LOW | `mytranslator.h/.cpp` | `setLanguage()` | No doc comment; param, return, and no-op condition undocumented |
| A11-9 | INFO | `mytranslator.h/.cpp` | `removeTranslator()` | No doc comment |
| A11-10 | INFO | `mytranslator.h` | `langEnglish`, `langSpanish` | No comment on format convention |
| A11-11 | INFO | `mytranslator.h/.cpp` | `mTranslator` | No comment on ownership or lifetime |

**Totals:** 3 MEDIUM, 3 LOW, 5 INFO
