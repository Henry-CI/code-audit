# Pass 3 Agent A09 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `comm/ftpclient.h`
- `comm/ftpclient.cpp`
- `comm/gmtpchat.h`
- `comm/gmtpchat.cpp`

---

## Reading Evidence

### File: `comm/ftpclient.h` + `comm/ftpclient.cpp`

**Class:** `FtpClient` (extends `QObject`)

**Public methods (header line numbers):**

| Method | Line | Doc comment present? |
|--------|------|----------------------|
| `FtpClient(BackgroundWorker *parent)` | 17 | No |
| `void download(const QUrl &url)` | 18 | No |
| `void startTransfer()` | 19 | No |
| `void writeQueue()` | 21 | No |
| `void readQueue()` | 22 | No |
| `void setPowerState(CIGCONF::PowerState state)` | 24 | No |

**Signals:**

| Signal | Line |
|--------|------|
| `void fileUpdated(const QString &fileName)` | 27 |
| `void sendGmtpMessage(CIGCONF::GmtpMessage msg, const QByteArray &extra)` | 28 |
| `void nextTransfer()` | 29 |

**Slots:** None declared (private methods are connected internally via `connect()`)

**Types, enums, constants (defined in `.cpp`):**

| Name | Value | Location |
|------|-------|----------|
| `MAX_FILE_SIZE` | `16 * 1024 * 1024` (16 MB) | `ftpclient.cpp` line 14 |
| `FTP_QUEUE_FILE` | `"/home/ftpqueue.txt"` | `ftpclient.cpp` line 15 |
| `FTP_RETRIES` | `5` | `ftpclient.cpp` line 16 |

**No doc comments exist anywhere in ftpclient.h or ftpclient.cpp** (the only inline comment is a note on line 33: `// note: QNetworkReply::setReadBufferSize doesn't work`).

---

### File: `comm/gmtpchat.h` + `comm/gmtpchat.cpp`

**Class:** `GmtpChat` (extends `QObject`)

**Enums:**

| Enum | Values |
|------|--------|
| `Priority` | `NormalPriority = 0`, `HighPriority` |
| `PduType` | `PduId = 1`, `PduData = 2`, `PduIdExt = 3`, `PduDataExt = 4`, `PduAck = 5` |

**Public methods (header line numbers):**

| Method | Line | Doc comment present? |
|--------|------|----------------------|
| `GmtpChat(ModemChat *parent)` | 21 | No |
| `void setPowerState(CIGCONF::PowerState state)` | 22 | No |
| `void connectServer()` | 23 | No |
| `void sendMessage(const QByteArray &msgData, Priority priority = NormalPriority)` | 24 | No |
| `void sendAck(quint16 msgId)` | 25 | No |
| `void clearGMTPMsgQueue()` | 26 | No |
| `bool sleeping()` | 27 | No |
| `void setEthernetState(bool up)` | 28 | No |
| `bool acksRemaining()` | 29 | No |

**Signals:**

| Signal | Line |
|--------|------|
| `void cmdReceived(const QByteArray &ba)` | 32 |
| `void socketStateChanged(bool state)` | 33 |
| `void allMessagesSent()` | 34 |
| `void allAcksSent()` | 35 |
| `void gmtpHotStartReconnect()` | 36 |
| `void disconnectSocket()` | 37 |

**Slots:** None declared in the public interface (private methods wired internally).

**Constants (defined in `.cpp`):**

| Name | Value | Location |
|------|-------|----------|
| `MAX_MESSAGE_CNT` | `1000` | `gmtpchat.cpp` line 16 |
| `MAX_RETRIES` | `3` | `gmtpchat.cpp` line 17 |
| `DEF_MSOCKET_TIMEOUT` | `10000` (ms) | `gmtpchat.cpp` line 18 |
| `MAX_GMTP_RECONNECT_CNT` | `20` | `gmtpchat.cpp` line 19 |

**Doc comments in the implementation:** One Doxygen-style block comment exists above `disconnectFromHost()` in `gmtpchat.cpp` (lines 521–524): `/** @brief Gracefully disconnect from socket if connected */`. This is a private method; no equivalent comment appears in the header. All public methods and signals are undocumented.

---

## Findings

**A09-1** · LOW · `FtpClient::download()` — no documentation on queueing behaviour or network precondition

**Description:** `download(const QUrl &url)` enqueues the URL but silently returns without starting the transfer when the network is unavailable (checked via `m_worker->networkStatus()`). The caller receives no indication that the download was deferred. The parameter `url` is not described, and the silent-defer behaviour is not documented anywhere.

**Fix:** Add a doc comment above the declaration in `ftpclient.h` explaining that the URL is enqueued for download, that the transfer is deferred when the network is offline, and that the `fileUpdated` signal is emitted on success.

---

**A09-2** · LOW · `FtpClient::startTransfer()` — no documentation on power-state guard or retry logic

**Description:** `startTransfer()` is a public method that is also called internally via the `nextTransfer` signal. It silently returns when `m_powerState >= SleepState`, when a transfer is already in progress, or when the queue is empty. It also triggers a file-system read of the persistent queue (`readQueue()`) if the queue-file flag is set. None of this behaviour is described for callers.

**Fix:** Add a doc comment explaining the idempotency guarantee, the power-state precondition, and that it reads the persistent queue on startup.

---

**A09-3** · LOW · `FtpClient::writeQueue()` / `FtpClient::readQueue()` — no documentation on persistent queue file contract

**Description:** These two public methods implement persistence of the pending download queue to `/home/ftpqueue.txt`. `writeQueue()` appends URLs to the file and clears the in-memory queue; `readQueue()` restores the queue from the file and deletes the file. The fact that `readQueue()` is destructive (removes the file) and that it resets `m_retries` to zero is not documented. Callers that invoke these methods directly (or indirectly via `setPowerState`) are given no guidance on ordering or side-effects.

**Fix:** Add doc comments to both declarations noting the file path used, the destructive read behaviour, and the retry-counter reset performed by `readQueue()`.

---

**A09-4** · HIGH · `FtpClient::setPowerState()` — safety-critical method, no documentation

**Description:** `setPowerState(CIGCONF::PowerState state)` is called by the system to signal impending sleep. When `state >= SleepState`, it calls `writeQueue()`, which persists pending downloads and clears the in-memory queue. Calling this method with the wrong state value or at the wrong time can result in queued file transfers (including firmware updates identified by `FILE_FLEETMS_FW`) being silently discarded or persisted incomplete. There is no doc comment explaining what states are valid, what side-effects are triggered, or that the persistent queue is modified.

**Fix:** Add a doc comment to the declaration that enumerates valid `CIGCONF::PowerState` values, explicitly states that calling with `state >= SleepState` flushes the queue to disk, and warns that no further transfers will be initiated until the power state is restored.

---

**A09-5** · HIGH · `GmtpChat::setPowerState()` — safety-critical method, no documentation

**Description:** `GmtpChat::setPowerState(CIGCONF::PowerState state)` aborts the TCP socket (`m_tcpSocket->abort()`), flushes both the upload and recent message queues to disk, and stops all timers when `state >= SleepState`. An abrupt socket abort (rather than graceful disconnect) and queue flushing have direct consequences for message delivery. No doc comment exists to describe the state transition, the abort-vs-disconnect choice, or the file-system side-effects.

**Fix:** Add a doc comment explaining the abort behaviour, that both upload and recent message queues are written to persistent storage, and which power states trigger the shutdown path.

---

**A09-6** · LOW · `GmtpChat::connectServer()` — no documentation on server rotation or mutex guard

**Description:** `connectServer()` selects the GMTP server using `m_serverIndex` (rotated on each reconnect attempt) and is guarded by a mutex to prevent concurrent connection attempts. The public interface gives no indication of these semantics, nor of the fact that calling this when already connected or connecting is handled silently.

**Fix:** Add a doc comment explaining that server selection is managed internally, that the method is safe to call from any thread (mutex-guarded), and that duplicate calls are silently ignored.

---

**A09-7** · LOW · `GmtpChat::sendMessage()` — no documentation on priority semantics or queue overflow behaviour

**Description:** `sendMessage()` accepts an optional `Priority` parameter whose effect is non-obvious: `HighPriority` prepends the message to the in-memory queue, bypassing the 1000-message limit and the file-based overflow. When `NormalPriority` is used and the queue is full, messages are spilled to disk via `writeQueue(true)`. None of this is described in a comment, nor are the `msgData` format expectations or the sleep-state guard.

**Fix:** Add a doc comment describing the `Priority` enum semantics, the in-memory queue limit (`MAX_MESSAGE_CNT = 1000`), the disk-spill behaviour for normal priority messages, and the sleep-state early return.

---

**A09-8** · LOW · `GmtpChat::sendAck()` — no documentation on parameter meaning

**Description:** `sendAck(quint16 msgId)` enqueues a PDU-Ack frame for the given `msgId`. The parameter name `msgId` matches what a caller might interpret as the outgoing message ID, when in fact it is the server-assigned ID being acknowledged. This inversion is a common source of misuse. No doc comment clarifies the direction (server-to-device message ID being acknowledged).

**Fix:** Add a doc comment clarifying that `msgId` is the ID of an inbound server message being acknowledged, not an outbound message ID.

---

**A09-9** · INFO · `GmtpChat::clearGMTPMsgQueue()` — no documentation on scope of clearing

**Description:** `clearGMTPMsgQueue()` clears the in-memory file-index list, the recent message queue, and the upload message queue. It does not remove any files already persisted to disk. This distinction is not documented, which could mislead a caller into thinking the operation is complete.

**Fix:** Add a brief comment noting that only in-memory queues are cleared, and that already-persisted queue files on disk are not removed.

---

**A09-10** · INFO · `GmtpChat::sleeping()` / `GmtpChat::acksRemaining()` / `GmtpChat::setEthernetState()` — inline one-liner methods, no doc comments

**Description:** These three inline public methods are defined directly in the header without any explanatory comments. While individually simple, `sleeping()` returns `!m_connect` (not a power-state check as the name implies), and `setEthernetState(bool up)` emits `disconnectSocket()` when `up` is false, which is a non-obvious side-effect for a setter.

**Fix:** At minimum, add a brief comment to `setEthernetState()` noting the side-effect of emitting `disconnectSocket()` when the link goes down. Add a comment to `sleeping()` clarifying that it reflects the GMTP connection intent flag, not the system power state.

---

**A09-11** · MEDIUM · `disconnectFromHost()` is documented only in the `.cpp`, not in the header; the sole Doxygen comment in the codebase is misplaced

**Description:** The only formal doc comment in either file pair is the Doxygen `/** @brief ... */` block on `disconnectFromHost()` in `gmtpchat.cpp` (lines 521–524). However, `disconnectFromHost()` is a private method, so the doc comment is not attached to any declaration that an IDE or documentation tool would surface to API consumers. All public methods that callers actually use remain undocumented. This illustrates an inverted documentation priority.

**Fix:** Move or duplicate the Doxygen comment to the private declaration in the header if desired, but more importantly apply the same documentation discipline to the public API.

---

## Summary Table

| ID | Severity | Location | Title |
|----|----------|----------|-------|
| A09-1 | LOW | `ftpclient.h:18` | `download()` — no documentation on queueing or network precondition |
| A09-2 | LOW | `ftpclient.h:19` | `startTransfer()` — no documentation on power-state guard or retry logic |
| A09-3 | LOW | `ftpclient.h:21-22` | `writeQueue()` / `readQueue()` — persistent queue file contract undocumented |
| A09-4 | HIGH | `ftpclient.h:24` | `setPowerState()` — safety-critical method, fully undocumented |
| A09-5 | HIGH | `gmtpchat.h:22` | `GmtpChat::setPowerState()` — safety-critical method, fully undocumented |
| A09-6 | LOW | `gmtpchat.h:23` | `connectServer()` — server rotation and mutex guard undocumented |
| A09-7 | LOW | `gmtpchat.h:24` | `sendMessage()` — priority semantics and overflow behaviour undocumented |
| A09-8 | LOW | `gmtpchat.h:25` | `sendAck()` — parameter direction ambiguous, undocumented |
| A09-9 | INFO | `gmtpchat.h:26` | `clearGMTPMsgQueue()` — disk-vs-memory clearing distinction undocumented |
| A09-10 | INFO | `gmtpchat.h:27-29` | Inline methods `sleeping()`, `acksRemaining()`, `setEthernetState()` undocumented |
| A09-11 | MEDIUM | `gmtpchat.cpp:521-524` | Only doc comment in codebase is on a private method; public API has none |

**Total findings: 11** (2 HIGH, 5 LOW, 2 LOW/INFO boundary, 2 INFO, 1 MEDIUM)
