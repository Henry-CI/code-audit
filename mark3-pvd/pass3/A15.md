# Pass 3 Agent A15 — Documentation

**Audit run:** 2026-02-28-01
**Branch:** master
**Files reviewed:**
- `platform/modemport.h`
- `platform/modemport.cpp`
- `platform/powersupply.h`
- `platform/powersupply.cpp`

---

## Reading Evidence

### modemport.h / modemport.cpp

**Class:** `EM070::ModemPort` (extends `QObject`)

**Public methods (header line numbers):**

| Line | Method / Inline definition |
|------|---------------------------|
| 14 | `explicit ModemPort(QObject *parent = nullptr)` |
| 15 | `bool sendCmd(const QByteArray &cmd)` |
| 16 | `void resetModem()` |
| 17 | `void setEnabled(bool enable)` |
| 18 | `void setEcho(bool enable)` (inline) |
| 19 | `bool isWwx()` (inline) |
| 20 | `void setWwx(bool isWwx)` (inline) |

**Signals:**

| Line | Signal |
|------|--------|
| 23 | `void portStateChanged(bool open)` |
| 24 | `void response(bool ok, const QByteArrayList &content)` |

**Private methods:**

| Line | Method |
|------|--------|
| 27 | `void openPort()` |
| 28 | `void portError()` |
| 29 | `void readData()` |
| 30 | `void parseData(const QByteArray &line)` |

**Types / enums / constants:** None defined in the header. The implementation file defines two file-path macros:
- `FILE_MODEM_PORT_WWX` — `/dev/ttyUSB2`
- `FILE_MODEM_PORT` — `/dev/ttyUSB3`

**Doc comments present:** None. There are no `///`, `/**`, or descriptive `//` comments above any public declaration in the header.

---

### powersupply.h / powersupply.cpp

**Class:** `EM070::PowerSupply` (extends `QObject`)

**Enumerations (header lines 16–18):**

| Line | Enum | Values |
|------|------|--------|
| 16 | `BlankMode` | `UnBlank = 0`, `BlankPowerDown = 4` |
| 17 | `ChargeState` | `NotCharging = 0`, `PreCharging = 1`, `FastCharging = 2`, `ChargeDone = 3` |
| 18 | `ChargeFault` | `NoFault = 0`, `InputFault = 1`, `ThermalShutdown = 2`, `ChargeTimerExpired = 3` |

**Public methods (header line numbers):**

| Line | Method / Inline definition |
|------|---------------------------|
| 19 | `explicit PowerSupply(QObject *parent = nullptr)` |
| 21 | `bool isIgnitionOn() const` (inline) |
| 23 | `bool isPowerGood() const` (inline) |
| 24 | `bool isBatteryAvailable() const` (inline) |
| 25 | `ChargeState chargeState() const` (inline) |
| 26 | `ChargeFault chargeFault() const` (inline) |
| 27 | `quint16 voltage() const` (inline) |
| 28 | `qint16 current() const` (inline) |
| 29 | `quint16 temperature() const` (inline) |
| 30 | `quint16 remainingCapacity() const` (inline) |
| 31 | `quint16 designCapacity() const` (inline) |
| 32 | `quint16 timeToEmpty() const` (inline) |
| 33 | `quint16 timeToFull() const` (inline) |
| 35 | `static void reboot()` |
| 36 | `static void poweroff()` |
| 37 | `static void setBlankMode(BlankMode mode)` |
| 38 | `static void setTouchPower(bool on)` |
| 39 | `static void charge(bool enable)` |
| 40 | `static void setBatteryEnabled(bool enable)` |

**Signals:**

| Line | Signal |
|------|--------|
| 43 | `void ignitionStateChanged(bool on)` |
| 44 | `void batteryStatusRead(bool avail, int state, int fault, quint16 voltage, qint16 current, quint16 temp, quint16 remainingCapacity)` |

**Private methods:**

| Line | Method |
|------|--------|
| 47 | `void readIgnitionState()` |
| 48 | `void readChargerStatus()` |
| 49 | `void readGaugeStatus()` |

**Types / enums / constants defined in implementation file:**

- `QUERY_INTERVAL` — `6000` (ms), the polling interval for charger/gauge status.
- Sysfs path macros: `FILE_IGNITION`, `FILE_FB_BLANK`, `FILE_TOUCH_POWER`, `FILE_CHARGE_EN`, `FILE_BATFET_DISABLE`, `FILE_PG_STAT`, `FILE_VSYS_STAT`, `FILE_CHRG_STAT`, `FILE_CHRG_FAULT`, `FILE_NTC_FAULT`, `FILE_GAUGE_REGS`.

**Doc comments present (partial):**

- Line 37: Inline comment `// will turn off lcd/backlight/touch` on `setBlankMode` declaration — only comment on any public method in this header.
- Line 40: Inline comment `// enable == false will turn off BAT FET` on `setBatteryEnabled` declaration.
- Private member comments in header (lines 57, 60–66) document units for the data fields.
- Implementation of `reboot()` (cpp lines 183–203) contains a block comment describing the script that is executed.

---

## Findings

**A15-1** · LOW · No doc comment on `ModemPort::sendCmd`
**Description:** `sendCmd(const QByteArray &cmd)` is the primary public interface for issuing AT commands to the modem. The method is non-trivial: it requires the port to be open, trims the command, stores it internally for echo-matching, clears the previous response buffer, and writes the command with a `\r\n` terminator. None of this behaviour is described anywhere in the header. There is no indication that the method returns `false` when the port is closed, or that the caller must wait for the `response` signal to get the result.
**Fix:** Add a doc comment above the declaration explaining the method's preconditions (port must be open), the meaning of the return value (`false` if port is closed, `true` if the write was dispatched), and that results are delivered asynchronously via the `response` signal.

---

**A15-2** · LOW · No doc comment on `ModemPort::resetModem`
**Description:** `resetModem()` has significant side effects: it runs `ps` to detect whether the mobile process is already running, calls `setEnabled(false)` to close the serial port, and launches `/etc/pvd/mobile -r` as a detached process before restarting the reconnect timer. None of this is described in the header. A caller has no way to know about the external process execution or the guard against double-reset from the header alone.
**Fix:** Add a doc comment describing the guard condition (no-op if `/etc/pvd/mobile` is already running), the side effects (closes the port, launches a detached reset process), and the subsequent automatic reconnect attempt.

---

**A15-3** · LOW · No doc comment on `ModemPort::setEnabled`
**Description:** `setEnabled(bool enable)` controls whether the serial port is open and the reconnect timer is active. When `enable` is `false` it closes the port and emits `portStateChanged(false)`; when `enable` is `true` it starts the reconnect timer (but is a no-op if the port is already open or the timer is already active). These semantics, including the idempotency behaviour and the emitted signal, are undocumented.
**Fix:** Add a doc comment describing both branches, the idempotency guard, and the fact that disabling emits `portStateChanged(false)`.

---

**A15-4** · INFO · No doc comments on `ModemPort` inline getters/setters (`setEcho`, `isWwx`, `setWwx`)
**Description:** The inline methods `setEcho`, `isWwx`, and `setWwx` are simple one-liner getters/setters with no doc comments. Their purpose is inferable from their names and the member variable names, but the `m_wwx` flag has no explanation of what "wwx" means anywhere in the header.
**Fix:** Add a brief comment explaining the meaning of the "wwx" flag (appears to indicate a Huawei EM070W/WWX modem variant that uses `/dev/ttyUSB2` instead of `/dev/ttyUSB3`).

---

**A15-5** · LOW · No doc comment on `ModemPort` signals `portStateChanged` and `response`
**Description:** Neither signal has any documentation. `response(bool ok, const QByteArrayList &content)` has a non-obvious contract: it is emitted both for normal command completions (where `content` contains intermediate response lines, not including the echo or the final OK/ERROR) and also for unsolicited `+CGEV:` events (where `ok` is always `false` and `content` has one element). This dual-purpose use is invisible at the signal declaration.
**Fix:** Document both signals. For `response`, describe the two emission contexts (command reply vs unsolicited `+CGEV:` event), the meaning of `ok`, and what `content` contains in each case. For `portStateChanged`, document that it is emitted both when the port opens and when it closes or encounters an error.

---

**A15-6** · HIGH · No doc comment on `PowerSupply::reboot` and `PowerSupply::poweroff` — safety-critical methods
**Description:** `reboot()` and `poweroff()` are static methods that invoke `/etc/pvd/reboot` (and `/etc/pvd/reboot -p` respectively), which performs a controlled modem shutdown sequence before issuing a system reboot or poweroff. These are safety-critical operations for an in-vehicle device. Neither method has a doc comment in the header. Callers have no documented indication that these calls are synchronous and blocking (via `QProcess::execute`), that they take several seconds to complete, or that calling them will terminate all running services on the device.
**Fix:** Add doc comments to both methods stating: (1) the call is blocking and may take several seconds, (2) the method triggers a full device reboot/poweroff, (3) callers should ensure any pending state has been persisted before calling, and (4) the method does not return to the caller in normal operation.

---

**A15-7** · MEDIUM · Inaccurate/misleading inline comment on `PowerSupply::setBlankMode`
**Description:** The header comment on line 37 reads `// will turn off lcd/backlight/touch`. However, the implementation of `setBlankMode` only writes to `FILE_FB_BLANK` (the framebuffer blank sysfs node). It does not control the touchscreen power — that is a separate method (`setTouchPower`). The comment creates a false impression that a single call to `setBlankMode` is sufficient to power down the display system including touch input.
**Fix:** Correct the comment to describe only what the method actually does: writes to the framebuffer blank sysfs node to blank or unblank the LCD and backlight. Note that touch power must be managed separately via `setTouchPower`. Also document the `BlankMode` enum values so callers understand what `UnBlank` vs `BlankPowerDown` actually do.

---

**A15-8** · LOW · No doc comment on `PowerSupply::charge` — inverted polarity undocumented
**Description:** `charge(bool enable)` has an inverted hardware polarity: calling `charge(true)` writes `"0"` to the charge-enable GPIO, and `charge(false)` writes `"1"`. This is a low-active signal. The method name and parameter suggest straightforward enable/disable semantics, but the inversion is hidden in the implementation with no explanatory comment on the declaration. Only the inline comment `// enable == false will turn off BAT FET` on `setBatteryEnabled` hints that this pattern exists in the file, but `charge` itself has no such note.
**Fix:** Add a doc comment to the declaration explaining that the enable parameter maps to an active-low hardware GPIO (writing `0` enables charging, writing `1` disables it), and document the sysfs path or hardware component being controlled (bq24190 charger chip, charge-enable GPIO).

---

**A15-9** · LOW · No doc comment on `PowerSupply::setBatteryEnabled` — hardware consequence undocumented
**Description:** The inline comment `// enable == false will turn off BAT FET` describes only the false case. The declaration does not document: (1) that this controls the battery FET on the bq24190 charger via the `f_batfet_disable` sysfs node, (2) that disabling the battery FET (`enable=false`) disconnects the battery from the system entirely, which is a destructive hardware action, or (3) that the method is automatically called with `enable=true` whenever ignition turns on (see `readIgnitionState`).
**Fix:** Expand the comment to describe both states, the underlying hardware mechanism (battery FET on the bq24190), and the consequence of disabling (battery physically disconnected from the system bus).

---

**A15-10** · INFO · Units missing from getter declarations in `PowerSupply` header
**Description:** The inline getters `voltage()`, `current()`, `temperature()`, `remainingCapacity()`, `designCapacity()`, `timeToEmpty()`, and `timeToFull()` have no doc comments on their declarations. The units are documented only in the private member variable comments further down in the header (e.g., `// in mV`, `// in mA`, `// in Celsius degree`, `// in minitues`). Callers who see only the public interface lack unit information without scrolling to the private section.
**Fix:** Add brief unit annotations to each getter declaration (e.g., `// Returns voltage in mV`). This is especially important for `temperature()` since its unit (Celsius) differs from the raw sensor value, and for `timeToEmpty()`/`timeToFull()` where the misspelling "minitues" in the private comment also needs correction to "minutes".

---

**A15-11** · INFO · `batteryStatusRead` signal parameters are unnamed/undescribed
**Description:** The `batteryStatusRead` signal (line 44) has seven parameters, several of which are untyped `int` rather than the enum types used internally (`ChargeState`, `ChargeFault`). There is no doc comment explaining which parameter corresponds to which measured value or what units they carry. Callers connecting to this signal must cross-reference the private member variables and their comments to understand what each argument contains.
**Fix:** Add a doc comment listing each parameter name, its type semantics (e.g., that `state` maps to `ChargeState` and `fault` maps to `ChargeFault`), and units where applicable. Consider whether `state` and `fault` should be typed as their respective enums rather than `int`.

---

**A15-12** · INFO · Typo "minitues" in private member comments (`powersupply.h`)
**Description:** Lines 65 and 66 in the header contain the comment `// in minitues` for both `m_timeToEmpty` and `m_timeToFull`. While these are private member comments rather than public API documentation, the typo ("minitues" instead of "minutes") is present in two places and would propagate into any documentation generated from the header.
**Fix:** Correct both occurrences of `// in minitues` to `// in minutes`.

---

## Summary Table

| ID | Severity | Location | Title |
|----|----------|----------|-------|
| A15-1 | LOW | `modemport.h:15` | No doc comment on `ModemPort::sendCmd` |
| A15-2 | LOW | `modemport.h:16` | No doc comment on `ModemPort::resetModem` |
| A15-3 | LOW | `modemport.h:17` | No doc comment on `ModemPort::setEnabled` |
| A15-4 | INFO | `modemport.h:18-20` | No doc comments on inline getters/setters; "wwx" meaning unexplained |
| A15-5 | LOW | `modemport.h:23-24` | No doc comments on signals `portStateChanged` and `response` |
| A15-6 | HIGH | `powersupply.h:35-36` | No doc comments on safety-critical `reboot` and `poweroff` |
| A15-7 | MEDIUM | `powersupply.h:37` | Inaccurate comment on `setBlankMode` claims touch is also controlled |
| A15-8 | LOW | `powersupply.h:39` | No doc comment on `charge`; inverted GPIO polarity undocumented |
| A15-9 | LOW | `powersupply.h:40` | `setBatteryEnabled` comment incomplete; hardware consequence undocumented |
| A15-10 | INFO | `powersupply.h:27-33` | Units absent from getter declarations in public interface |
| A15-11 | INFO | `powersupply.h:44` | `batteryStatusRead` signal parameters unnamed and undescribed |
| A15-12 | INFO | `powersupply.h:65-66` | Typo "minitues" in private member comments |
