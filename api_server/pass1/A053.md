# Audit Report A053
**Agent:** A053
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Files assigned:**
- `lib/api_server.ex`
- `lib/api_server/application.ex`
- `lib/api_server/fortynine/calamppositionevents.ex`

---

## Reading Evidence

### File 1: `lib/api_server.ex`

**Module name:** `ApiServer`

**Public functions (def):** None.

**defstruct / defexception / schema:** None.

**use / import / alias:** None.

**Notes:** This is a bare module containing only a `@moduledoc` string. It serves as the top-level namespace placeholder generated by Phoenix. No logic is present.

---

### File 2: `lib/api_server/application.ex`

**Module name:** `ApiServer.Application`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `start` | 2 | 6 |
| `config_change` | 3 | 36 |

**defstruct / defexception / schema:** None.

**use / import / alias:**
- `use Application` (line 2)
- `import Supervisor.Spec` (line 7, inside `start/2`)

**Child specifications registered in supervisor tree:**
- `ApiServer.FortyNineRepo` (Ecto repo, supervisor)
- `ApiServer.Repo` (Ecto repo, supervisor)
- `ApiServerWeb.Endpoint` (Phoenix endpoint, supervisor)
- `ApiServer.Scheduler` (cron scheduler)
- `Task.Supervisor` named `ApiServer.TCP.TaskSupervisor`
- `Task` running `ApiServer.TCP.accept(tcp_port)` with `restart: :permanent`
- `ConCache` named `:geocode_store` with `ttl_check_interval: false`

**Environment variable usage:**
- `TCP_PORT` read at line 9 via `System.get_env/1`, defaulting to `"4001"`.

---

### File 3: `lib/api_server/fortynine/calamppositionevents.ex`

**Module name:** `ApiServer.FortyNine.CalampPositionEvents`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 91 |

**defstruct / defexception / schema:**
- `schema "calamppositionevents"` defined at line 7.
  Fields (88 total, selected notable ones):
  - `:datetimesaved`, `:gmtdatetime`, `:timeoffix` — datetime
  - `:hardwareid` — integer (device identifier)
  - `:latitude`, `:longitude` — float (GPS coordinates / PII)
  - `:driverid`, `:mifaredriverid` — string (PII / driver identity data)
  - `:wsusername`, `:wspassword` — string (credentials stored in schema)
  - `:originalmsg` — binary (raw device message payload)
  - `:prestartchecklist`, `:appmsgtext`, `:appmsgtext2` — freeform strings
  - Engine/telemetry floats: `:rpm`, `:engcoolanttemp`, `:engoilpressure`, etc.

**use / import / alias:**
- `use Ecto.Schema` (line 2)
- `use Bitwise` (line 3)
- `use Timex` (line 4)
- `import Ecto.Changeset` (line 5)

---

## Security Review

### §1: Secrets and Configuration

**A053-1 — CRITICAL — Credential fields (`wsusername`, `wspassword`) persisted to database via Ecto schema**

File: `lib/api_server/fortynine/calamppositionevents.ex`, lines 31–32 (schema) and line 93 (changeset cast list).

The schema `[REDACTED-AWS-SMTP-PASSWORD]` declares `:wsusername` and `:wspassword` as first-class fields on the schema, and `changeset/2` includes both in the `cast/3` call with no exclusion or transformation. This means:

1. Credentials arrive from the CALAmp device/parser and are written to the database as plaintext.
2. Any code that reads a `[REDACTED-AWS-SMTP-PASSWORD]` struct will carry the password in memory alongside telemetry data.
3. Any logging, inspection, or serialisation of these structs (e.g., error reports, `IO.inspect`, JSON serialisation of query results) will leak the plaintext password.

The checklist requires that credentials not appear in tracked code as module attributes or application defaults, and the broader fleet-data guidance requires that sensitive data not leak across boundaries. Storing device credentials inside a telemetry event row violates both principles. There is no hashing, masking, or redaction anywhere in this file.

**A053-2 — LOW — `TCP_PORT` default hardcoded in application source**

File: `lib/api_server/application.ex`, line 9.

```elixir
tcp_port = String.to_integer(System.get_env("TCP_PORT") || "4001")
```

The fallback port `4001` is hardcoded in source. In isolation this is low severity (it is a non-privileged port and the real value should come from the environment variable), but it means a deployment that omits `TCP_PORT` silently binds on 4001 rather than failing fast, which could mask a misconfiguration.

---

### §2: Authentication and Authorization

**A053-3 — HIGH — Raw device credentials in telemetry schema with no validation or access controls**

File: `lib/api_server/fortynine/calamppositionevents.ex`, lines 31–32, 93.

`wsusername` and `wspassword` are included in the `cast` list inside `changeset/2` with no `validate_format`, `validate_length`, or any other constraint. Because the changeset accepts these fields from any attrs map passed to it, a caller can supply arbitrary credential values and they will be accepted without validation. The only `validate_required` check is on `:hardwareid`, leaving credential fields completely unconstrained.

Additionally, because these credentials are embedded in a telemetry event row, there are no access-control boundaries: any code path that can query `[REDACTED-AWS-SMTP-PASSWORD]` for GPS/telemetry data will also retrieve associated credentials, widening the blast radius of any SQL injection or IDOR vulnerability elsewhere in the application.

---

### §3: Input Validation and Injection

**A053-4 — MEDIUM — Changeset casts all 88 fields with only a single `validate_required` check**

File: `lib/api_server/fortynine/calamppositionevents.ex`, lines 91–95.

`changeset/2` casts every field in the schema (including freeform strings such as `:appmsgtext`, `:appmsgtext2`, `:prestartchecklist`, `:errormsg`, `:location`, `:city`, `:state`, `:postcode`) with no length validation, format validation, or content sanitisation. While Ecto's type casting provides some type coercion, there are no upper-bound length constraints on string fields. Overly long values could cause downstream issues (database column overflow, memory pressure when building large changesets, or injection if any of these strings are later interpolated into queries or log messages without escaping).

No `String.to_atom/1` or unsafe deserialisation was observed in these three files.

---

### §4: Session and CSRF

§4: No issues found.

These three files contain no session, cookie, CSRF token, or WebSocket/channel configuration. Session and CSRF concerns belong to the endpoint and router modules, which are not assigned to this agent.

---

### §5: File and Data Handling

**A053-5 — HIGH — GPS coordinates and driver identity fields (PII) stored in a schema with no field-level access logging or redaction indication**

File: `lib/api_server/fortynine/calamppositionevents.ex`, lines 12–13 (`:latitude`, `:longitude`), line 55 (`:driverid`), line 56 (`:mifaredriverid`).

The schema stores vehicle GPS coordinates, driver IDs, and Mifare RFID card IDs alongside all other telemetry. The checklist requires verifying that fleet/driver/location data is scoped to the authenticated user's organisation and not returned across customer boundaries. This schema itself cannot enforce that boundary — the enforcement must occur in query code — but the presence of PII fields here means that any unscoped query returning `[REDACTED-AWS-SMTP-PASSWORD]` rows will expose PII across tenants. This finding is raised for visibility; the reviewer of query/controller modules must confirm tenant scoping is applied when this schema is queried.

**A053-6 — MEDIUM — Raw binary device message (`:originalmsg`) stored and cast without size or content constraints**

File: `lib/api_server/fortynine/calamppositionevents.ex`, line 58 (schema), line 93 (cast list).

The `:originalmsg` field is typed as `:binary` and is included in the cast list with no size limit. A malformed or abnormally large device message could be stored as-is. If this binary is later decoded or processed by application code (e.g., replayed through the parser), unvalidated binary content could trigger parser vulnerabilities. No size validation was observed.

---

### §6: Dependencies

§6: No issues found.

No `mix.exs` or `mix.lock` files are within the assigned file set. Dependency review is deferred to the agent assigned those files. The three files reviewed import only standard Elixir/OTP modules (`Application`, `Supervisor`), Hex-distributed libraries (`Ecto`, `Timex`, `Bitwise`), and project-internal modules. No `git:` URL dependencies are visible in these files.

---

### §7: Infrastructure Exposure

**A053-7 — LOW — TCP listener port binding is permanent and unconditionally started**

File: `lib/api_server/application.ex`, lines 21–22.

```elixir
{Task.Supervisor, name: ApiServer.TCP.TaskSupervisor},
Supervisor.child_spec({Task, fn -> ApiServer.TCP.accept(tcp_port) end}, restart: :permanent),
```

The TCP acceptor task is started with `restart: :permanent` and is part of the application's top-level supervisor. There is no environment-gated condition that would prevent the TCP listener from starting in a non-production environment (e.g., CI or test). This means the TCP port is always opened unless the caller explicitly sets `TCP_PORT` and controls network access. Combined with finding A053-2 (hardcoded default port), any deployment that does not set `TCP_PORT` will silently open port 4001. The TCP server is a direct network ingress point; its security depends entirely on `ApiServer.TCP.accept/1` (not reviewed in this pass).

**A053-8 — INFO — `ConCache` started with `ttl_check_interval: false`**

File: `lib/api_server/application.ex`, line 25.

```elixir
{ConCache, [name: :geocode_store, ttl_check_interval: false]}
```

TTL checking is disabled for the geocode store. If cached geocode results are ever associated with a specific user or tenancy context, stale entries will never expire automatically, potentially serving one customer's location data for a query that should return another's. This is flagged for awareness; the actual risk depends on how `:geocode_store` is populated and consumed (not visible in assigned files).

---

## Summary of Findings

| ID | Severity | File | Summary |
|----|----------|------|---------|
| A053-1 | CRITICAL | `calamppositionevents.ex` | Plaintext credentials (`wsusername`, `wspassword`) persisted in telemetry schema and cast without masking or hashing |
| A053-2 | LOW | `application.ex` | Hardcoded TCP port fallback (`4001`) masks misconfiguration |
| A053-3 | HIGH | `calamppositionevents.ex` | Device credentials in schema with no validation; all credential data co-located with queryable telemetry |
| A053-4 | MEDIUM | `calamppositionevents.ex` | 88-field mass-cast changeset with no length/format validation on string fields |
| A053-5 | HIGH | `calamppositionevents.ex` | PII (GPS coordinates, driver IDs) in schema; tenant scoping cannot be verified from schema alone — must be confirmed in query/controller layer |
| A053-6 | MEDIUM | `calamppositionevents.ex` | Raw binary device message (`:originalmsg`) stored with no size constraint |
| A053-7 | LOW | `application.ex` | TCP listener always started with `restart: :permanent`; no env-gate for non-production environments |
| A053-8 | INFO | `application.ex` | `ConCache` geocode store has TTL checking disabled — stale cached entries never expire |
