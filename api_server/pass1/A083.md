# Audit Report A083
**Agent:** A083
**Run:** 2026-02-27-01
**Branch:** master
**Stack:** Elixir/Phoenix — api_server
**Assigned files:**
- `lib/api_server/vx/vx_thing.ex`
- `lib/api_server/vx/vx_thing_event.ex`
- `lib/api_server/vx/vx_thing_event_omega.ex`

---

## File 1: `lib/api_server/vx/vx_thing.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThing`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `convert_json_to_changeset` | 1 | 60 |
| `changeset` | 2 | 75 |

**Schema defined — `schema "aad_thing"`:**

Fields:
- `:aadid` (primary key, autogenerate)
- `:aadcustcode` (:string)
- `:aaddesc` (:string)
- `:aadintext` (:string)
- `:aadaddr` (:string)
- `:aadcustomerid` (:integer)
- `:aadcat` (:integer)
- `:aadhardwareid` (:integer)
- `:aadhw_type` (:integer)
- `:aadmake` (:string)
- `:aadmodel` (:string)
- `:aadserialno` (:string)
- `:aadmobile` (:string)
- `:aadimei` (:string)
- `:aadhourmeter` (:float)
- `:aadhourmeter1` (:float)
- `:aadhourmeter2` (:float)
- `:aadhourmeter3` (:float)
- `:aadhourmeter4` (:float)
- `:aadhourmeterprnt` (:float)
- `:aadodometer` (:integer)
- `:aadhourmeteromega` (:float)
- `:aadhourmeterothcan` (:float)
- `:aaddateintoservice` (:date)
- `:aadlastservice` (:date)
- `:aadvalid` (:string)
- `:aadserviceoffset` (:float)
- `:aadsvchrs` (:integer)
- `:aadrange_lat` (:float)
- `:aadrange_long` (:float)
- `:aadrange_dist` (:integer)
- `:aadrange_unit` (:string)
- `:service_calculation_input` (:string)
- `:reference_1` (:string)
- `:reference_2` (:string)
- `:reference_3` (:string)
- `:notes` (:string)
- `:equipment_date_into_service` (:date)

Associations:
- `has_many :fleet_thing_joins` (VXFleetAssociation)
- `has_many :rentals` (VXRental)
- `has_many :events` (VXThingEvent, via `:aadhardwareid`)
- `has_one :summary` (VXThingSummary, via `:aadhardwareid`)
- `has_one :info` (VXThingInfo, via `:aadhardwareid`)
- `has_one :customer` (VXCustomer, via `:aadcustomerid`)

**`use` / `import` / `alias` at module level:**
- Line 1: `require Ecto.Query` (file-level, outside module)
- Line 2: `require Ecto.Adapters.SQL` (file-level, outside module)
- Line 6: `use Ecto.Schema`
- Line 7: `import Ecto.Changeset`
- Line 8: `alias ApiServer.Vx`

---

### Checklist Review — `vx_thing.ex`

**§1: Secrets and Configuration**
No hardcoded credentials, API keys, or secrets. No config references. §1: No issues found.

**§2: Authentication and Authorization**
This is a schema/context module. No direct auth logic. The `changeset/2` does not include `:aadcustomerid` in its cast list, which is the correct defensive posture — customer ID cannot be changed through the standard changeset. However, `convert_json_to_changeset/1` builds a raw map from user-supplied JSON with no validation of types or bounds, and the `changeset/2` does not call `validate_required/2` for any field — no field is marked required. The absence of `validate_required` is a data-quality issue but not a direct security finding. The customer-scoping concern is addressed in the controller layer (reviewed separately). §2: No issues found in this file.

**§3: Input Validation and Injection**
`convert_json_to_changeset/1` (lines 60–73) directly maps user-supplied JSON values into a changeset map via `Vx.update_key_if_value/3`. There is no type coercion or validation in this function itself — that is deferred to `changeset/2` which uses `cast/3`. No raw SQL interpolation in this file. No `String.to_atom/1`, `binary_to_term`, or `Code.eval_string` calls. `require Ecto.Adapters.SQL` is present at the top of the file (line 2) but is never used within the module body — a dead `require`. §3: No exploitable issues in this file.

**§4: Session and CSRF**
Schema module — not applicable. §4: No issues found.

**§5: File and Data Handling**
No `Logger` calls. The schema contains GPS range fields (`:aadrange_lat`, `:aadrange_long`) and IMEI (`:aadimei`) and mobile number (`:aadmobile`) — these are PII/device-identity fields. No Logger calls emit these fields in this file. §5: No issues found in this file.

**§6: Dependencies**
No dependency declarations. §6: No issues found.

**§7: Infrastructure Exposure**
No hardcoded hostnames, IPs, or TLS config. §7: No issues found.

---

## File 2: `lib/api_server/vx/vx_thing_event.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingEvent`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `map_xml` | 1 | 71 |
| `changeset` | 2 | 111 |

**Schema defined — `schema "thingevents"`:**

Fields:
- `:id` (default integer primary key, auto)
- `:gmtdatetime` (:utc_datetime)
- `:hardwareid` (:integer)
- `:eventtype` (:integer)
- `:eventcode` (:integer)
- `:latitude` (:float)
- `:longitude` (:float)
- `:driverid` (:string)
- `:engineonelapsed` (:integer)
- `:totalengineseconds` (:integer)
- `:custcode` (:string)
- `:hardwaretype` (:integer)
- `:datetimesaved` (:utc_datetime)
- `:dateinqueue` (:utc_datetime)
- `:timeoffix` (:utc_datetime)
- `:altitude` (:integer)
- `:heading` (:float)
- `:speed` (:float)
- `:rssi` (:integer)
- `:gpsfixquality` (:integer)
- `:odometer` (:integer)
- `:mifaredriverid` (:string)
- `:ignition` (:integer)
- `:ignitionstatus` (:string)
- `:calcengineseconds` (:integer)
- `:input1elapsed` (:integer)
- `:input1status` (:string)
- `:input1totalseconds` (:integer)
- `:input1calctotalseconds` (:integer)
- `:input2elapsed` (:integer)
- `:input2status` (:string)
- `:input2totalseconds` (:integer)
- `:input2calctotalseconds` (:integer)
- `:input3elapsed` (:integer)
- `:input3status` (:string)
- `:input3totalseconds` (:integer)
- `:input3calctotalseconds` (:integer)
- `:input4elapsed` (:integer)
- `:input4status` (:string)
- `:input4totalseconds` (:integer)
- `:input4calctotalseconds` (:integer)
- `:prntelapsed` (:integer)
- `:prntstatus` (:string)
- `:prnttotalseconds` (:integer)
- `:prntcalctotalseconds` (:integer)
- `:rhmprestartchecklist` (:string)
- `:geofence` (:string)

Associations:
- `has_one :thingeventomega` (VXThingEventOmega, foreign_key: :id, references: :id)
- `belongs_to :thing` (VXThing, foreign_key: :hardwareid, references: :aadhardwareid, define_field: false)

**`use` / `import` / `alias` at module level:**
- Line 2: `use Ecto.Schema`
- Line 3: `import Ecto.Changeset`

---

### Checklist Review — `vx_thing_event.ex`

**§1: Secrets and Configuration**
No credentials or secrets. §1: No issues found.

**§2: Authentication and Authorization**
Schema/context module. The `map_xml/1` function (lines 71–108) processes an incoming XML-sourced data map. It sets `:custcode` directly from `data["custcode"]` (line 99) with no validation — a device-submitted message can declare any customer code string. The calling context (verified in `calamp_controller.ex` and `digital_matter_controller.ex`, outside audit scope) determines whether this is validated; however the schema itself provides no guard. The `changeset/2` includes `:custcode` as castable, meaning any caller who passes `:custcode` via attrs can write any customer code. This is flagged as a data-integrity / IDOR risk — see A083-2.

**§3: Input Validation and Injection**
`map_xml/1` uses `String.to_integer/1` and `String.to_float/1` directly on external device input (lines 79–98). These functions raise `ArgumentError` if the input is not parseable — they are not the safe `Integer.parse/1` / `Float.parse/1` variants that return `{:ok, val} | :error`. A device or attacker sending a malformed field value (e.g., an empty string or a non-numeric string) will crash the calling process. See A083-1. No raw SQL, no `String.to_atom`, no `binary_to_term`. §3: A083-1 raised.

**§4: Session and CSRF**
Not applicable. §4: No issues found.

**§5: File and Data Handling**
The schema stores GPS coordinates (`:latitude`, `:longitude`, `:altitude`, `:heading`, `:speed`), driver identity (`:driverid`, `:mifaredriverid`), and vehicle tracking data. No `Logger` calls are present in this file. No PII leakage via Logger in this file. §5: No issues found in this file.

**§6: Dependencies**
No dependency declarations. §6: No issues found.

**§7: Infrastructure Exposure**
No hardcoded hostnames or IPs. §7: No issues found.

---

## File 3: `lib/api_server/vx/vx_thing_event_omega.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingEventOmega`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `changeset` | 2 | 72 |

**Schema defined — `schema "thingomega"`:**

Fields:
- `:id` (default integer primary key — note: also used as the join key to `thingevents.id`)
- `:accelerometerx` (:float)
- `:accelerometery` (:float)
- `:accelerometerz` (:float)
- `:distancesincelastevent` (:integer)
- `:omegadriverid` (:string)
- `:seatbelt` (:integer)
- `:seated` (:integer)
- `:parkbrakerequest` (:integer)
- `:parkbreakreleased` (:integer)
- `:vehicleload` (:float)
- `:tilt` (:integer)
- `:height` (:integer)
- `:overload` (:integer)
- `:attretracted` (:integer)
- `:yellowled` (:integer)
- `:redled` (:integer)
- `:greenled` (:integer)
- `:liftenable` (:integer)
- `:safetyoverride` (:integer)
- `:doorclosed` (:integer)
- `:parkbrakerror` (:integer)
- `:batterynotcharged` (:integer)
- `:lowengineoil` (:integer)
- `:accnotcharged` (:integer)
- `:hydraulicfilgerblocked` (:integer)
- `:airfilterblocked` (:integer)
- `:attpressure` (:integer)
- `:oilcoolerfan` (:integer)
- `:lowerinterruption` (:integer)
- `:undersafetyheight` (:integer)
- `:joystickliftposition` (:integer)
- `:hydraulicoiltemperature` (:float)
- `:md3temperature` (:float)
- `:fuellevel` (:integer)
- `:md3status` (:integer)
- `:xa2status` (:integer)
- `:batteryvoltage` (:float)
- `:xa2temperature` (:float)
- `:boomangle` (:float)
- `:boomextension` (:integer)
- `:lift` (:integer)
- `:extension` (:integer)
- `:totalfuelconsumption` (:float)
- `:fuelrate` (:float)
- `:totalfuelidle` (:float)
- `:totalidlehour` (:float)
- `:totalenginehour` (:float)
- `:enginerpm` (:integer)
- `:capacity` (:integer)
- `:coolanttemperature` (:float)
- `:oiltemperature` (:float)
- `:engineerrorcode` (:string)
- `:vehiclespeed` (:integer)
- `:gearselection` (:integer)
- `:transerrorcode` (:string)
- `:prestartchecklist` (:integer)
- `:truckerrorcode` (:string)
- `:mc43status` (:integer)
- `:mc43temperature` (:integer)
- `:lc5status` (:integer)
- `:lc5temperature` (:integer)
- `:truckangle` (:float)

Association:
- `belongs_to :thingevent` (VXThingEvent, foreign_key: :id, references: :id, primary_key: true, define_field: false)

**`use` / `import` / `alias` at module level:**
- Line 2: `use Ecto.Schema`
- Line 3: `import Ecto.Changeset`

---

### Checklist Review — `vx_thing_event_omega.ex`

**§1: Secrets and Configuration**
No credentials or secrets. §1: No issues found.

**§2: Authentication and Authorization**
Schema module. `changeset/2` (line 72–76) includes `:id` in the cast list (line 74). The `:id` field is the primary key of `thingomega` and is also the foreign key linking to `thingevents.id`. Casting `:id` from user/device-supplied attrs means an external caller can supply an arbitrary event ID to force the omega record to associate with any event row in the database — a direct IDOR/record-hijacking vector. See A083-3.

**§3: Input Validation and Injection**
`changeset/2` casts a very large set of fields (line 74) including `:id`. `validate_required/2` only requires `:id`. No type validation beyond what Ecto's `cast/3` provides. No raw SQL, no `String.to_atom`, no `binary_to_term`. The only security concern is the castable `:id` — see A083-3.

**§4: Session and CSRF**
Not applicable. §4: No issues found.

**§5: File and Data Handling**
The schema records rich forklift telemetry: accelerometer axes, vehicle load, driver ID (`:omegadriverid`), safety override state (`:safetyoverride`), boom angles, engine RPM, fuel consumption, error codes. No `Logger` calls present in this file. §5: No issues found in this file.

**§6: Dependencies**
No dependency declarations. §6: No issues found.

**§7: Infrastructure Exposure**
No hardcoded hostnames or IPs. §7: No issues found.

---

## Cross-File and Controller-Layer Findings

The following findings arise from reviewing the assigned schema files in conjunction with their direct consumers (the controllers that use these schemas), which is required to fully evaluate §2 and §5 per the checklist.

### §2 — Unauthenticated Routes Serving Fleet Data

From `lib/api_server_web/router.ex` (lines 29–31), two routes are placed **before** `pipe_through([:api, :authenticated])` in the `/api/v1` scope:

```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)

  pipe_through([:api, :authenticated])
  ...
```

`combined_engine_usage` (controller lines 453–601) and `monday_hour_meters` (lines 377–436) both accept a `customers` query parameter as a comma-separated string, iterate over the supplied customer codes, call `Vx.list_vxthings_full(customer)` / `Vx.list_vxthings(customer)`, and return vehicle-level data including GPS coordinates (`:latitude`, `:longitude`), hour meter readings, serial numbers, and vehicle names — with **no authentication at all**. See A083-4.

### §2 — Unscoped `show` Action on VXThing

`VXThingController.show/2` (controller line 83–85) calls `Vx.get_vx_thing_with_hardware_id!(hardwareid)` — the **single-arity overload** (vx.ex line 1337–1345) which does **not** accept a `customer` prefix, querying the default schema with no customer scoping. This means a hardwareid from any customer can be retrieved by any authenticated user. See A083-5.

### §2 — Unscoped `VXThingEventController.index`

`VXThingEventController.index/2` (controller lines 9–12) calls `Vx.list_vxthingevents()` with no customer parameter, returning all `thingevents` rows across all customers to any authenticated user. This exposes GPS, driver, and vehicle data across customer boundaries. See A083-6.

### §5 — Internal Details Leaked in Error Responses

`VXThingController.create_thing/2` (line 250) and `VXThingController.update_thing/2` (line 278) return the full `inspect(changeset)` / `inspect(result)` in the HTTP response body on error:

```elixir
send_resp(conn, :internal_server_error,
  "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")
```

An Ecto changeset inspect output contains the schema struct with all field values, the repo module name, and potentially the full SQL error string from the database driver. This discloses internal schema structure, table/column names, and data values to API clients. See A083-7.

### §5 — `IO.puts` / `IO.inspect` Logging Device and Vehicle Data

`VXThingEventController.add_calculated_fields/2` (lines 78–80) uses `IO.puts/1` to write device hardware ID and hourmeter values to stdout. In production this goes to the Erlang VM log which may be captured by log aggregators without the controls applied to `Logger`. `write_partial_record/3` (line 67) calls `IO.inspect(changeset)` on error — again potentially emitting vehicle event data to stdout. While these are not `Logger` calls, they represent uncontrolled data emission. See A083-8.

---

## Findings Summary

### A083-1 — HIGH — Unsafe Parse Functions on Device Input in `map_xml/1`

**File:** `lib/api_server/vx/vx_thing_event.ex`, lines 79–98
**Section:** §3 Input Validation

`VXThingEvent.map_xml/1` uses `String.to_integer/1` and `String.to_float/1` on multiple fields sourced from external device-submitted data (`data["hardwareId"]`, `data["latitude"]`, `data["longitude"]`, etc.). Both functions raise `ArgumentError` (not `{:error, reason}`) when the input is not a valid numeric string. If a device or a man-in-the-middle submits a blank, `nil`, or non-numeric value for any mapped field, the calling process crashes.

In an OTP supervisor tree this means the process restarts, but in high-frequency device event ingestion the crashes will be logged and may exhaust supervisor restart budgets (max_restarts), causing the ingestion pipeline to go down. This is a denial-of-service vector against device data ingestion.

**Evidence:**
```elixir
hardwareid: String.to_integer(data["hardwareId"]),   # line 79
latitude:   String.to_float(data["latitude"]),       # line 82
longitude:  String.to_float(data["longitude"]),      # line 83
altitude:   String.to_integer(data["altitude"]),     # line 84
speed:      String.to_float(data["speed"]),          # line 85
```

**Recommendation:** Replace `String.to_integer/1` with `Integer.parse/1` and `String.to_float/1` with `Float.parse/1`, handling the `:error` return. Alternatively use a dedicated parsing/validation step that returns `{:ok, event} | {:error, reason}` before inserting.

---

### A083-2 — MEDIUM — Customer Code Accepted from Device-Submitted Payload in `map_xml/1`

**File:** `lib/api_server/vx/vx_thing_event.ex`, line 99
**Section:** §2 Authorization / §3 Input Validation

`map_xml/1` assigns `:custcode` directly from the device payload:

```elixir
custcode: data["custcode"],
```

The `changeset/2` also includes `:custcode` in the castable field list (line 143). This means any device or service that can POST to the event ingestion endpoint can declare an arbitrary customer code in the persisted event record. If downstream queries use `:custcode` to scope data retrieval, a tampered device message could cause event records to appear under a different customer's namespace.

**Recommendation:** The `:custcode` on an ingested event should be derived from the authenticated device/hardware identity (looked up from `aad_thing.aadcustcode`), not taken verbatim from the submitted payload. Remove `:custcode` from the `map_xml/1` mapping and from the castable field list if it is derived server-side.

---

### A083-3 — HIGH — Primary Key `:id` Is Castable in `VXThingEventOmega.changeset/2`

**File:** `lib/api_server/vx/vx_thing_event_omega.ex`, line 74
**Section:** §2 Authorization / IDOR

The `changeset/2` function includes `:id` in the `cast/3` field list:

```elixir
|> cast(attrs, [:accelerometerx, ..., :id, ...])
|> validate_required([:id])
```

The `:id` field is both the primary key of the `thingomega` table and the foreign key linking the omega record to `thingevents.id`. Because `:id` is castable from `attrs`, a caller who constructs the attrs map (e.g., from a device message or a crafted API call) can supply an arbitrary integer ID. This allows:

1. **Record hijacking:** associating an omega data payload with any event in `thingevents`, potentially overwriting or spoofing sensor data for another customer's vehicle event.
2. **IDOR:** if the omega record insert/update path does not independently verify the referenced `thingevents.id` belongs to the same customer, cross-customer data can be written.

**Recommendation:** Remove `:id` from the `cast/3` list. The `:id` for a new omega record should be set equal to the parent `thingevents.id` by the caller after that event is created, not from user/device-controlled input. Use `put_change/3` server-side rather than `cast/3`.

---

### A083-4 — CRITICAL — Unauthenticated Endpoints Return Multi-Customer Fleet and GPS Data

**File:** `lib/api_server_web/router.ex`, lines 29–32
**Controllers:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 377–436, 453–601
**Section:** §2 Authentication and Authorization / §5 Fleet Data Scoping

Two routes are registered in the `/api/v1` scope **before** the `pipe_through([:api, :authenticated])` call, making them publicly accessible with no authentication:

```
GET /api/v1/rhm/engine_usage
GET /api/v1/rhm/monday_hour_meters
```

`combined_engine_usage` accepts a `customers` query parameter (comma-separated customer code list) and returns per-vehicle daily engine usage data including customer code and hardware ID for all listed customers.

`monday_hour_meters` returns per-vehicle weekly GPS coordinates (latitude, longitude), vehicle names, hourmeter readings, and last-reported timestamps for all listed customers.

Neither action validates the caller's identity or verifies that the requesting party is authorised to access the listed customer codes. Any unauthenticated party on the network who can reach the API can enumerate vehicle GPS positions, names, and hour meters for any customer code they can guess or enumerate.

The comment in the router — `# Avoid authentication, locking to a specific database` — suggests this was intentional but does not justify the absence of authentication for endpoints that expose live GPS and fleet data.

**Recommendation:** Move these routes inside the `pipe_through([:api, :authenticated])` block. Add customer-scope validation so the authenticated user's `customer` claim is verified against the requested customer codes, or restrict these endpoints to an admin/internal role.

---

### A083-5 — HIGH — Unscoped `VXThingController.show/2` Queries Across Customer Boundaries

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 83–86
**Callee:** `lib/api_server/vx/vx.ex`, line 1337
**Section:** §2 IDOR / §5 Fleet Data Scoping

`VXThingController.show/2` calls the single-arity `Vx.get_vx_thing_with_hardware_id!(hardwareid)` which does not apply a customer prefix:

```elixir
def show(conn, %{"id" => hardwareid}) do
  vx_thing = Vx.get_vx_thing_with_hardware_id!(hardwareid)
  render(conn, "show.json", vx_thing: vx_thing)
end
```

```elixir
def get_vx_thing_with_hardware_id!(hardwareid) do
  VXThing
    |> Ecto.Query.where(aadhardwareid: ^hardwareid)
    ...
    |> Repo.one   # no prefix: customer
end
```

An authenticated user from customer A can query `GET /vx/things/:hardwareid` (or equivalent REST resource route) with a hardware ID belonging to customer B and receive that customer's vehicle data. The two-arity variant `get_vx_thing_with_hardware_id!(hardwareid, customer)` exists and is used by the majority of other actions — the `show/2` action appears to have been an oversight in using the unscoped variant.

**Recommendation:** Change `show/2` to extract `customer` from `Guardian.Plug.current_claims(conn)["customer"]` and call the two-arity `Vx.get_vx_thing_with_hardware_id!(hardwareid, customer)`.

---

### A083-6 — HIGH — `VXThingEventController.index/2` Returns All Events Across All Customers

**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, lines 9–12
**Section:** §2 IDOR / §5 Fleet Data Scoping

```elixir
def index(conn, _params) do
  vxthingevents = Vx.list_vxthingevents()
  render(conn, "index.json", vxthingevents: vxthingevents)
end
```

`Vx.list_vxthingevents/0` (not inspected in the assigned files, but the pattern is consistent with other `list_*` functions) almost certainly performs an unscoped `Repo.all(VXThingEvent)` across all customer schemas or the default schema. The `thingevents` table contains GPS coordinates, driver IDs, ignition status, speed, altitude, heading, and vehicle usage data. Any authenticated user — regardless of their customer — can call this endpoint and receive all event records.

**Recommendation:** Remove or gate this endpoint. If it is needed, scope it by extracting the customer from the JWT claims and applying the customer prefix via `Repo.all(prefix: customer)`.

---

### A083-7 — MEDIUM — Ecto Changeset / Internal Error Details Returned to API Client

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 250, 278
**Section:** §5 Information Disclosure

On insertion or update failure, the full `inspect(changeset)` or `inspect(result)` is interpolated directly into the HTTP 500 response body:

```elixir
send_resp(conn, :internal_server_error,
  "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")
```

`inspect` on an Ecto changeset produces a string that includes: module names, table/schema names, all field values present at the time of the changeset, the changeset errors map, and any database constraint error messages from the underlying MySQL driver. This information assists an attacker in mapping internal data structures and understanding database schema details.

**Recommendation:** Replace `inspect(changeset)` with a sanitised error message. Ecto changeset errors can be safely extracted with `changeset.errors` and rendered without leaking internal struct details. Log the full changeset internally via `Logger.error/2` and return only a generic error description to the client.

---

### A083-8 — LOW — `IO.puts` / `IO.inspect` Emitting Device and Vehicle Data Outside Logger

**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, lines 62, 67, 78–80
**Section:** §5 Data Handling

`IO.puts("Inserted")` (line 62), `IO.inspect(changeset)` (line 67), and `IO.puts("totalengineseconds is nil for #{record_to_add.hardwareid} but aadhourmeter is set to #{vx_thing.aadhourmeter}...")` (lines 78–80) write to stdout directly rather than via `Logger`.

The `IO.puts` on lines 78–80 emits a hardware ID and an aadhourmeter float value. The `IO.inspect(changeset)` call on line 67 can emit a full event changeset struct including latitude, longitude, driverid, and custcode on insert failure.

`Logger` calls respect the configured log level, can be compiled out in production, and are captured by log management tooling (e.g., CloudWatch Logs with structured filtering). Raw `IO` calls bypass all of these controls and go directly to the BEAM console/stdout stream, potentially landing in unfiltered log aggregators or operator terminals without PII controls applied.

**Recommendation:** Replace all `IO.puts` and `IO.inspect` calls in production code paths with `Logger.debug/2`, `Logger.info/2`, or `Logger.error/2` as appropriate. For the changeset error case, avoid logging full struct values — log only the error reason map.

---

## Summary Table

| ID | Severity | Section | File | Description |
|---|---|---|---|---|
| A083-1 | HIGH | §3 | vx_thing_event.ex | `String.to_integer/1` / `String.to_float/1` raise on malformed device input — DoS vector in event ingestion pipeline |
| A083-2 | MEDIUM | §2/§3 | vx_thing_event.ex | `:custcode` accepted verbatim from device payload in `map_xml/1`; should be derived server-side from hardware identity |
| A083-3 | HIGH | §2 | vx_thing_event_omega.ex | Primary key `:id` is castable in `changeset/2`, enabling IDOR / record hijacking on the `thingomega` table |
| A083-4 | CRITICAL | §2/§5 | router.ex / vx_thing_controller.ex | Two endpoints (`engine_usage`, `monday_hour_meters`) are fully unauthenticated and return multi-customer GPS and fleet data |
| A083-5 | HIGH | §2/§5 | vx_thing_controller.ex | `show/2` uses unscoped `get_vx_thing_with_hardware_id!/1` — any authenticated user can retrieve any customer's vehicle record |
| A083-6 | HIGH | §2/§5 | vx_thing_event_controller.ex | `index/2` calls unscoped `list_vxthingevents()` — returns GPS, driver, and vehicle event data across all customers |
| A083-7 | MEDIUM | §5 | vx_thing_controller.ex | `inspect(changeset)` / `inspect(result)` returned in HTTP 500 body — discloses internal schema structure and data values |
| A083-8 | LOW | §5 | vx_thing_event_controller.ex | `IO.puts` / `IO.inspect` emit hardware ID, hourmeter, and changeset data to stdout outside Logger controls |
