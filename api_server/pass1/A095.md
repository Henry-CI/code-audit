# Audit Report A095
**Agent:** A095
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Run:** 2026-02-27-01
**Checklist:** PASS1-CHECKLIST-api_server.md

---

## Assigned Files

1. `lib/api_server_web/controllers/calamp_controller.ex`
2. `lib/api_server_web/controllers/digital_matter_controller.ex`
3. `lib/api_server_web/controllers/fallback_controller.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/calamp_controller.ex`

**Module name:** `ApiServerWeb.CalampController`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `recieve_calamp_data` | 2 | 4 |

**Private functions (defp):**
| Name | Arity | Line |
|------|-------|------|
| `validate` | 3 | 31 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)

**Notes:** The function name `recieve_calamp_data` contains a spelling error ("recieve" instead of "receive"). No corresponding route for `CalampController` exists in `router.ex`; the controller is defined but unreachable via HTTP.

---

### File 2: `lib/api_server_web/controllers/digital_matter_controller.ex`

**Module name:** `ApiServerWeb.DigitalMatterController`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `get_g62_data` | 2 | 4 |

**Private functions (defp):** None.

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)

**Router registration (from router.ex):**
- `POST /` routed via `:api_xml` pipeline — no `:authenticated` plug.

---

### File 3: `lib/api_server_web/controllers/fallback_controller.ex`

**Module name:** `ApiServerWeb.FallbackController`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `call` | 2 | 9 (clause 1: `{:error, %Ecto.Changeset{}}`) |
| `call` | 2 | 15 (clause 2: `{:error, :not_found}`) |

**Private functions (defp):** None.

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 7)

---

## Checklist Review

### §1: Secrets and Configuration

**CalampController:** No secrets or hardcoded credentials observed in this file.

**DigitalMatterController (lines 9–11):**
- `email_to = ["graham.oconnell@trackingsolutions.com.au"]` — a real personal email address is hardcoded as a literal string in production controller code.
- `email_from = "no-reply@mobilehourmeter.com"` — hardcoded sender address.
- `subject = "Digital Matter - Raw Data"` — hardcoded string; minor, but consistent with the email block being development/debug code left in production.

The email-sending lines are commented out (`# ApiServer.Email.send_digital_matter_email(...)`), so the address is not currently transmitted, but the PII remains in source and will appear in version control history.

**FallbackController:** No secrets or hardcoded credentials.

---

### §2: Authentication and Authorization

**CalampController — `recieve_calamp_data/2`:**
- There is no route for `CalampController` in `router.ex`. The controller cannot be reached via HTTP. This may indicate dead code or an incomplete feature.
- The function hardcodes `customer = "vx_dev"` (line 5). If a route were ever added, there would be no customer scoping from the authenticated user.

**DigitalMatterController — `get_g62_data/2`:**
- Registered as `POST /` under the `:api_xml` pipeline only. The `:authenticated` plug (`ApiServer.Guardian.AuthPipeline`) is NOT applied to this route.
- Any caller can POST data to the root endpoint without any authentication token. The `hardware_id` comes directly from `params["SerNo"]` with no authentication check.
- The customer is hardcoded as `"vx_dev"` (line 200). There is no mechanism for the caller to identify which customer's data should be updated, and no check that the device belongs to any authenticated customer. Because the endpoint is unauthenticated, this is effectively an unauthenticated write endpoint to a fixed (development) customer database prefix.

**FallbackController:** Renders error responses. No authentication logic; §2 not applicable to this file directly.

---

### §3: Input Validation and Injection

**CalampController — `recieve_calamp_data/2`:**
- Input arrives as `%{xml: calamp_data}` (pattern-matched from parsed XML). No validation of the structure or field values within `calamp_data` is performed before it is passed to `ApiServer.Vx.VXThingEvent.map_xml/1`.
- `hardwareid` is extracted from the result of `map_xml` (external XML field) and passed directly to `ApiServer.Vx.get_most_recent_thingevent/2` and `ApiServer.Vx.get_vx_thing_with_hardware_id!/2`. From inspection of `vx.ex`, these functions use Ecto parameterized queries (`^hardwareid`), so there is no SQL injection risk at the query level. However, there is no prior validation that `hardwareid` is a non-nil, correctly typed value before it reaches the context.
- `IO.inspect` (line 10) and `IO.puts` (lines 34, 40, 43) are present in what appears to be production code. `IO.inspect new_event` will log the full deserialized GPS/telemetry event struct to stdout. This is a data leak in logs (see §5).
- The `validate/3` private function does not return a value; its result is discarded. It only performs `IO.puts` of computed diffs. No actual validation decision is made — the comment "# 2. Save the record if valid" is never reached by any save logic visible in this controller. This means the validation function is a no-op stub.

**DigitalMatterController — `get_g62_data/2`:**
- `hardware_id = params["SerNo"]` (line 5): raw string from unauthenticated HTTP POST, no validation or sanitization.
- `records = params["Records"]` (line 7): raw list from unauthenticated HTTP POST, no nil check or type check.
- `Enum.each(records, ...)` (line 20): if `records` is `nil` (i.e., the `Records` key is absent from the POST body), this will raise `Protocol.UndefinedError` at runtime because `Enum.each/2` does not accept `nil`.
- `record["Fields"]` (line 24): no nil-check; if `Fields` is absent, `Enum.find/2` will receive `nil` and raise `Protocol.UndefinedError`.
- `gps["Alt"]`, `gps["Head"]`, `gps["Spd"]` (lines 151, 158, 165): if `gps` is `nil` (no FType==0 field found), these will raise `KeyError` / `ArgumentError` at runtime.
- `driver_id["DriverID"]` (line 172): if `driver_id` is `nil` (no FType==3 field found), this will raise at runtime.
- `trip_hours["Dur"]` (line 139): if `trip_hours` is `nil` (no FType==26 field found), this will raise at runtime.
- `run_hours["RH"]` (line 197): inside `thing_event` map construction; `run_hours` nil case is handled for `odometer` (lines 142–148) but `totalengineseconds: run_hours["RH"]` (line 197) has no nil guard — if `run_hours` is `nil`, this will raise.
- None of the extracted fields pass through an Ecto changeset or any parameter schema before being written to the database via `ApiServer.Vx.create_thingevent_record/2`.
- `IO.inspect(error)` (line 218): Ecto changeset errors are logged to stdout in production code.
- The `customer` value used in the database prefix (`"vx_dev"`, line 200) is hardcoded. No injection risk from user input, but this is a hardcoded development value in what appears to be a production path.

**FallbackController:**
- Clause 1 renders changeset errors through `ApiServerWeb.ChangesetView`, which uses `Ecto.Changeset.traverse_errors/2`. This is the standard safe pattern; no user input is echoed unsanitized.
- Clause 2 renders a generic 404. No user input echoed.
- §3: No issues found.

---

### §4: Session and CSRF

**CalampController / DigitalMatterController:** Both controllers are under XML/API pipelines which do not include `plug(:protect_from_forgery)`. For machine-to-machine device endpoints receiving telemetry this is expected, but the absence of any authentication token requirement on the DigitalMatterController endpoint means there is no session or token mechanism protecting this write path at all.

**FallbackController:** §4: No issues found.

---

### §5: File and Data Handling

**CalampController:**
- `IO.inspect` on line 10 logs the complete deserialized `new_event` struct, which contains GPS coordinates, timestamps, engine data, and a `hardwareid`. This constitutes uncontrolled logging of fleet telemetry PII/location data.
- `IO.puts "GPS Diff: #{inspect gps_diff}"` (line 34), `IO.puts "Time since current: #{inspect event_time_diff}"` (line 40), `IO.puts "Accum diff: #{inspect accum_diff}"` (line 43) log computed values derived from device events to stdout.

**DigitalMatterController:**
- `IO.inspect(error)` (line 218) logs Ecto changeset error details to stdout. Changeset error structs may contain field names and rejected values, potentially including GPS coordinates or driver IDs.
- The `thing_event` map built at lines 178–198 includes `latitude`, `longitude`, `hardwareid`, `driverid` and other fleet data. These are passed to `create_thingevent_record/2` without validation. If the changeset fails, the full error (including the attempted values) is written to stdout via `IO.inspect`.

**Cross-customer data scoping (checklist §5, device-data section):**
- Both `CalampController.recieve_calamp_data/2` and `DigitalMatterController.get_g62_data/2` use the hardcoded string `"vx_dev"` as the customer/schema prefix. This means:
  - All incoming device data is written exclusively to the `vx_dev` schema, regardless of which actual customer the device belongs to.
  - There is no mapping from `hardware_id` (device serial) to the correct customer schema.
  - If this code were to be used with real customer data, all telemetry would be siloed into a single development namespace.
  - Conversely, data from different customers' devices could be commingled if they share hardware IDs across the `vx_dev` prefix.

**FallbackController:** §5: No issues found.

---

### §6: Dependencies

Not directly assessable from these three controller files. No dependency calls outside the application's own modules are made in these files beyond `Timex.parse/2` (DigitalMatterController line 108), `Poison.encode!/1`, and standard Phoenix/Plug functions. Dependency audit is covered by other agents reviewing `mix.exs` / `mix.lock`.

§6: No issues found specific to these files.

---

### §7: Infrastructure Exposure

**DigitalMatterController (lines 9–11):**
- Hardcoded email address `"graham.oconnell@trackingsolutions.com.au"` and domain `"mobilehourmeter.com"` are present in source. The email sending code is commented out, but these values are present in the repository and represent unnecessary exposure of an individual's email address and a service domain in version history.

**CalampController / DigitalMatterController:** No hardcoded IPs, hostnames, or infrastructure endpoints found in these files.

**FallbackController:** §7: No issues found.

---

## Findings

---

### A095-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** Router `scope "/"` — no `:authenticated` plug
**Section:** §2 Authentication and Authorization

`DigitalMatterController.get_g62_data/2` is registered at `POST /` under the `:api_xml` pipeline, which contains only `fetch_session` and `accepts`. The `:authenticated` plug (`ApiServer.Guardian.AuthPipeline`) is not in this pipeline. Any unauthenticated party on the network can POST arbitrary JSON/XML to the root URL and trigger a write to the `vx_dev` database schema. There is no API key, bearer token, shared secret, or device certificate check. This is an unauthenticated write endpoint to a production database.

---

### A095-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 5–7, 20, 24, 139, 151, 158, 165, 172, 197
**Section:** §3 Input Validation and Injection

No input validation is performed on any field received from the HTTP POST body before use. The following crash paths exist when fields are absent:
- `records` is `nil` → `Enum.each(nil, ...)` raises `Protocol.UndefinedError` (line 20).
- `record["Fields"]` is `nil` → `Enum.find(nil, ...)` raises `Protocol.UndefinedError` (line 24).
- `gps` is `nil` (no FType==0 record) → `gps["Alt"]` raises at lines 151, 158, 165, 184, 189, 190, 193.
- `driver_id` is `nil` → `driver_id["DriverID"]` raises at line 172.
- `trip_hours` is `nil` → `trip_hours["Dur"]` raises at line 139.
- `run_hours` is not `nil` but `run_hours["RH"]` is `nil` → `totalengineseconds: nil` is passed to the changeset without validation at line 197.

Because the endpoint is unauthenticated (see A095-1), any external caller can trivially trigger unhandled exceptions by omitting required fields. Depending on error handling upstream, this may result in 500 responses that expose stack traces or changeset details.

---

### A095-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 200
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Lines:** 5
**Section:** §2 Authorization / §5 Data Handling — Cross-customer scoping

Both device-data ingestion controllers hardcode `customer = "vx_dev"`. The customer schema prefix is never derived from the authenticated user, a device registration table, or any configuration. All telemetry from all devices is written to the `vx_dev` Postgres schema prefix. This violates the per-customer data isolation requirement. If this code path is active in production:
- Data belonging to different customers' devices could be commingled in a single schema.
- The correct per-customer schema is never selected, meaning the data is not associated with the correct customer at the database layer.

---

### A095-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Lines:** 10, 34, 40, 43
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 218
**Section:** §5 File and Data Handling — PII / Fleet Data in Logs

`IO.inspect` and `IO.puts` calls are present in production controller code and will write fleet telemetry to stdout (and thus to any configured log aggregator):

- `calamp_controller.ex` line 10: `IO.inspect new_event` — logs the complete deserialized GPS/engine event struct including GPS coordinates, engine seconds, hardware ID, and timestamps.
- `calamp_controller.ex` lines 34, 40, 43: `IO.puts` of GPS time diffs, event time diffs, and accumulated engine seconds.
- `digital_matter_controller.ex` line 218: `IO.inspect(error)` — logs Ecto changeset error structs that may contain rejected field values including GPS coordinates, driver IDs, and hardware IDs.

GPS coordinates, hardware IDs, and driver IDs constitute fleet PII and location data. Uncontrolled logging of this data may violate data handling policies and creates unnecessary exposure in log storage systems.

---

### A095-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 9
**Section:** §1 Secrets and Configuration / §7 Infrastructure Exposure

A personal email address (`graham.oconnell@trackingsolutions.com.au`) is hardcoded as a string literal in the production controller. Although the code block that uses it is commented out, the value is committed to version control and will persist in git history. This constitutes unnecessary PII exposure of an individual's email address in source code.

---

### A095-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Lines:** 4, 31–44
**Section:** §3 Input Validation / §2 Authorization

`recieve_calamp_data/2` has no corresponding route in `router.ex`. The controller is defined but unreachable via HTTP. This appears to be dead/incomplete code. The `validate/3` private function it calls is a stub that only performs `IO.puts` and returns no value; its result is unused and there is no save logic. If this controller is ever wired to a route in the future, it would:
1. Accept unauthenticated inbound XML data (no `:authenticated` pipeline in the XML scope).
2. Hardcode the customer as `"vx_dev"`.
3. Perform no actual validation (the `validate/3` result is discarded).
4. Not save any data (the save step is commented out/incomplete).

The controller's existence as dead code with these properties is a latent risk if a route is inadvertently added.

---

### A095-7
**Severity:** LOW
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 246
**Section:** §5 File and Data Handling — Internal error detail in response

On line 246, when `create_thingevent_record` fails and returns an error, the controller responds to the HTTP client with:

```elixir
Plug.Conn.send_resp(400, Poison.encode!(%{message: Kernel.inspect(event_id)}))
```

`event_id` at this point holds `error.errors` (line 219), which is the Ecto changeset error keyword list. `Kernel.inspect/1` will render the full list including field names and validation error messages. This serializes internal database schema details (field names and validation rules) into the HTTP 400 response body visible to the caller.

---

### A095-8
**Severity:** LOW
**File:** `lib/api_server_web/controllers/fallback_controller.ex`
**Lines:** 9–13
**Section:** §5 File and Data Handling — Changeset error detail in response

`FallbackController.call/2` clause 1 renders Ecto changeset errors via `ApiServerWeb.ChangesetView.render("error.json", ...)`, which calls `Ecto.Changeset.traverse_errors/2` and returns all field-level validation errors as a JSON object. This is a common Phoenix pattern and the errors are typically user-facing validation messages, but it does expose internal schema field names to the client. This is LOW severity as it is standard Phoenix behaviour and the changeset errors are unlikely to reveal sensitive information, but it should be confirmed that no sensitive field names appear in error responses for the routes that use this fallback.

---

### A095-9
**Severity:** INFO
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Lines:** 4
**Section:** Code quality

The public function is named `recieve_calamp_data` — "recieve" is a misspelling of "receive". This is a cosmetic issue but could cause confusion if external callers or route helpers reference the function name by atom. Not a security issue.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A095-1 | HIGH | digital_matter_controller.ex | `POST /` endpoint has no authentication |
| A095-2 | HIGH | digital_matter_controller.ex | No input validation; multiple nil-crash paths on missing fields |
| A095-3 | HIGH | digital_matter_controller.ex, calamp_controller.ex | Customer hardcoded as `"vx_dev"` — no cross-customer data scoping |
| A095-4 | MEDIUM | calamp_controller.ex, digital_matter_controller.ex | `IO.inspect`/`IO.puts` log GPS coordinates, hardware IDs, driver IDs to stdout |
| A095-5 | MEDIUM | digital_matter_controller.ex | Personal email address hardcoded in source / version control |
| A095-6 | MEDIUM | calamp_controller.ex | Dead controller with no route, incomplete validation stub — latent risk |
| A095-7 | LOW | digital_matter_controller.ex | Ecto changeset error detail (`error.errors`) serialized into HTTP 400 response body |
| A095-8 | LOW | fallback_controller.ex | Changeset field names exposed in error JSON responses |
| A095-9 | INFO | calamp_controller.ex | Misspelled function name `recieve_calamp_data` |
