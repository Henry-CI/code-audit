# Pass 1 Security Audit — A056
**Agent:** A056
**Stack:** Elixir/Phoenix — api_server
**Branch:** master
**Run:** 2026-02-27-01

---

## Assigned Files

1. `lib/api_server/fortynine/webservicepositionqueue.ex`
2. `lib/api_server/guardian.ex`
3. `lib/api_server/operators/file.ex`

Supporting config files read for context:
- `config/config.exs` (Guardian config, secret_key_base)
- `config/prod.exs` (database credentials, SMTP credentials)
- `config/prod.secret.exs` (secret_key_base override)
- `.gitignore` (secret exclusion verification)
- `mix.exs` (guardian dependency version)
- `mix.lock` (guardian pinned version)

---

## Reading Evidence

### File 1: `lib/api_server/fortynine/webservicepositionqueue.ex`

**Module name:** `ApiServer.FortyNine.WebServicePositionQueue`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 37 |

**Schema defined:** `"webservicepositionqueue"` (line 7)

Fields: `:RECORDID`, `:datetimequeued`, `:utctimestamp`, `:HARDWAREID`, `:MOBILENAME`, `:driverID`, `:LATITUDE`, `:LONGITUDE`, `:HEADING`, `:SPEED`, `:GPSLOCK`, `:OLD`, `:PING`, `:MOTION`, `:SPEEDING`, `:IGNITION`, `:IGNITIONSTATUS`, `:RSSI`, `:SATS`, `:SENSOR1`, `:SENSOR2`, `:WSUSERNAME`, `:WSPASSWORD`, `:ERROR`, `:ERRORMSG`, `:CONNECTIONNAME`

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Ecto.Schema` | 2 |
| `use` | `Bitwise` | 3 |
| `use` | `Timex` | 4 |
| `import` | `Ecto.Changeset` | 5 |

---

### File 2: `lib/api_server/guardian.ex`

**Module name:** `ApiServer.Guardian`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `subject_for_token` | 2 | 6 |
| `subject_for_token` | 2 | 14 (fallback clause) |
| `resource_from_claims` | 1 | 18 |
| `resource_from_claims` | 1 | 24 (fallback clause) |

**defstruct / defexception / schema:** None

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Guardian, otp_app: :api_server` | 2 |
| `alias` | `ApiServer.Vx` | 4 |

**Guardian runtime configuration (from `config/config.exs` lines 132–136):**

```elixir
config :api_server, ApiServer.Guardian,
  issuer: "rhmapi",
  ttl: {52, :weeks},
  secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

No `allowed_algos` key is explicitly set. Guardian 1.x defaults to `["HS512"]` when no algorithm is specified.

---

### File 3: `lib/api_server/operators/file.ex`

**Module name:** `ApiServer.Operators.File`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 14 |

**Schema defined:** `"files"` (line 6)

Fields: `:custcode`, `:esn`, plus Ecto timestamps.

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Ecto.Schema` | 2 |
| `import` | `Ecto.Changeset` | 3 |

---

## Checklist Review

### §1: Secrets and Configuration

**config/config.exs — Hardcoded secret_key_base (line 15):**

```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh"
```

**config/config.exs — Hardcoded Guardian signing key (line 136):**

```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

**config/prod.secret.exs — Hardcoded production secret_key_base (line 12):**

```elixir
secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```

**config/prod.exs — Hardcoded production database credentials (lines 13–25):**

```elixir
config :api_server, ApiServer.FortyNineRepo,
  username: "svr49_hi_x_user",
  password: "Q973bFtc9z/cVW#mA",
  hostname: "svr49.tracking-intelligence.com",
```

**config/prod.exs — Hardcoded AWS RDS endpoint and credentials (lines 27–37):**

```elixir
config :api_server, ApiServer.Repo,
  username: "vxaurorasyduser",
  password: "TRxbixk9fuZc",
  hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
  port: 3306
```

**config/prod.exs — Hardcoded AWS SES SMTP credentials (lines 39–53):**

```elixir
config :api_server, ApiServer.Mailer,
  username: "[REDACTED-AWS-KEY-ID]",
  password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

Note: a commented-out second AWS IAM access key ID is also present: `[REDACTED-AWS-KEY-ID]`. Even in a comment, a rotated key ID in version control reveals historical credential usage and may be a target for automated secret scanners querying AWS for key status.

**config/prod.secret.exs — Commented-out database credentials (lines 15–22):**

```elixir
#   username: "vxaurorasyduser",
#   password: "TRxbixk9fuZc",
#   hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
```

Same RDS credentials appear here in comment form, confirming they are persisted in VCS history.

**.gitignore — `prod.secret.exs` exclusion is commented out (line 27):**

```
# /config/*.secret.exs
```

The comment explicitly acknowledges the pattern but leaves it disabled. `prod.secret.exs` is therefore tracked by git, meaning all secrets it contains are committed to version control.

**webservicepositionqueue.ex — Schema fields `:WSUSERNAME` and `:WSPASSWORD` (lines 29–30):**

These fields are cast without restriction in the changeset. The schema mirrors columns that appear to hold plaintext web-service credentials. This is a data-model concern, not a code defect by itself, but it is flagged as a data-handling risk.

---

### §2: Authentication and Authorization

**Guardian algorithm not explicitly configured:**

No `allowed_algos` key is present in the Guardian config block. Guardian 1.x defaults to `["HS512"]`, which is an acceptable symmetric algorithm. However, the absence of an explicit declaration means the algorithm is implicitly inherited from library defaults, and a future library upgrade could silently change the accepted set. The `"none"` algorithm is not configured.

**Guardian TTL is 52 weeks (1 year):**

```elixir
ttl: {52, :weeks},
```

A one-year JWT lifetime means a compromised token remains valid for up to 52 weeks with no ability to revoke it (Guardian 1.x has no built-in token revocation unless a `GuardianDb` or custom revocation store is wired in). No refresh policy is visible in the configuration.

**`resource_from_claims/1` trusts the `customer` claim without validation (guardian.ex line 19–21):**

```elixir
def resource_from_claims(claims) do
  id = claims["sub"]
  customer = claims["customer"]
  user = Vx.get_vx_user!(id, customer)
  {:ok, user}
end
```

The `customer` value is extracted directly from the JWT claims and passed to `Vx.get_vx_user!/2` without any allowlist check or cross-reference against the authenticated user's own customer record. If the JWT signing key is compromised, or if a token is issued with an attacker-controlled `customer` claim, the lookup can return users belonging to a different customer organisation. This is a cross-tenant IDOR vector.

---

### §3: Input Validation and Injection

**webservicepositionqueue.ex — No injection issues found.** The changeset uses `cast/3` with an explicit field list and `validate_required/2`. No raw SQL fragments or unsafe atom creation observed.

**operators/file.ex — No injection issues found.** The changeset uses `cast/3` and `validate_required/2`. No raw SQL or unsafe operations observed.

**guardian.ex — No direct injection issues in module code.** The `Vx.get_vx_user!/2` call is where the risk materialises (see §2 note above); the guardian module itself does not do raw SQL.

§3: No additional issues found beyond the cross-tenant concern noted in §2.

---

### §4: Session and CSRF

Not directly applicable to the three assigned files (schema modules and guardian callback module). No session, cookie, or CSRF configuration is present in these files.

§4: No issues found in assigned files.

---

### §5: File and Data Handling

**webservicepositionqueue.ex — GPS and driver PII in schema:**

The schema includes `:LATITUDE`, `:LONGITUDE`, `:HARDWAREID`, `:MOBILENAME`, `:driverID`, `:SPEED`, `:HEADING`, and `:IGNITION`. These are fleet vehicle tracking fields. The module itself does not log or expose this data, but consumers of this schema must be confirmed to scope data access per customer organisation. This is an advisory note for downstream review.

**webservicepositionqueue.ex — `:WSPASSWORD` field in position-queue schema:**

The `[REDACTED-AWS-SMTP-PASSWORD]` table stores plaintext web-service credentials (`:WSUSERNAME`, `:WSPASSWORD`) alongside GPS position records. Storing credentials in a queue table alongside telemetry data widens the blast radius of any database breach; those credentials are not isolated to a secrets store.

§5: No stack-trace disclosure or path traversal issues found in assigned files. The schema-level concerns above are flagged as findings.

---

### §6: Dependencies

Guardian is pinned in `mix.exs` as `{:guardian, "~> 1.0"}` and resolves to `1.2.1` in `mix.lock`. Guardian 1.2.1 is the final release of the 1.x series; the project has since moved to 2.x with breaking changes. No published CVEs against guardian 1.2.1 are on record, but the library is effectively unmaintained at this version.

§6: No critical dependency vulnerabilities identified in guardian 1.2.1. The version is outdated; flagged as LOW.

---

### §7: Infrastructure Exposure

**config/prod.exs — Hardcoded AWS RDS hostname (line 36):**

```
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com"
```

The RDS cluster identifier and AWS region (`ap-southeast-2`) are embedded in a tracked config file. This exposes infrastructure topology.

**config/prod.exs — Hardcoded external database hostname (line 17):**

```
hostname: "svr49.tracking-intelligence.com"
```

An external third-party service hostname is committed in plaintext.

**config/prod.exs — AWS SES endpoint reveals region (line 41):**

```
server: "email-smtp.us-west-2.amazonaws.com"
```

AWS region `us-west-2` for the SES endpoint is hardcoded.

§7: CORS and TLS configuration are not present in the three assigned files; those are assessed elsewhere.

---

## Findings

---

### A056-1 — CRITICAL: Guardian JWT signing key hardcoded in tracked config file

**File:** `config/config.exs` line 136
**Section:** §1 Secrets and Configuration / §2 Authentication and Authorization

```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The HMAC-SHA signing key used to sign and verify all JWTs is committed in plaintext to the repository. Any party with read access to the repository can forge arbitrary JWTs, bypass authentication entirely, and impersonate any user including administrators. This key must be treated as fully compromised, rotated immediately, and replaced with a reference to a runtime environment variable or secrets manager value (e.g., `System.fetch_env!("GUARDIAN_SECRET_KEY")`).

---

### A056-2 — CRITICAL: Production database credentials hardcoded in tracked config file

**File:** `config/prod.exs` lines 13–25 and lines 27–37
**Section:** §1 Secrets and Configuration

Two separate database credentials are committed in plaintext:

1. FortyNine repo — `username: "svr49_hi_x_user"`, `password: "Q973bFtc9z/cVW#mA"`, host `svr49.tracking-intelligence.com`
2. Main repo (AWS RDS) — `username: "vxaurorasyduser"`, `password: "TRxbixk9fuZc"`, host `vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com`

Both `prod.exs` and `prod.secret.exs` are committed to version control (the `.gitignore` exclusion for `*.secret.exs` is commented out — see A056-5). All credentials must be rotated immediately and replaced with environment variable references.

---

### A056-3 — CRITICAL: AWS SES SMTP credentials (IAM access key + secret) hardcoded in tracked config file

**File:** `config/prod.exs` lines 44–48
**Section:** §1 Secrets and Configuration

```elixir
username: "[REDACTED-AWS-KEY-ID]",
password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

An AWS IAM access key ID and secret access key for SES SMTP are committed in plaintext. These credentials can be used to send email as the account and may carry broader IAM permissions. They must be treated as compromised, revoked immediately in IAM, and replaced with environment variable references. A second (now-commented) key ID `[REDACTED-AWS-KEY-ID]` is also present, indicating at least one prior rotation that did not remove the old value from VCS history.

---

### A056-4 — CRITICAL: `prod.secret.exs` committed to version control — secret_key_base exposed

**File:** `config/prod.secret.exs` line 12; `.gitignore` line 27
**Section:** §1 Secrets and Configuration

```
# /config/*.secret.exs     ← exclusion is commented out in .gitignore
```

```elixir
secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```

The Phoenix `secret_key_base` used for session cookie signing and encryption is committed to VCS. An attacker with repository access can forge session cookies. The `.gitignore` comment explicitly notes the file should be excluded but the exclusion line is disabled. The file must be removed from tracking (`git rm --cached`), the exclusion re-enabled, and the `secret_key_base` rotated.

---

### A056-5 — HIGH: `.gitignore` excludion for `*.secret.exs` is commented out

**File:** `.gitignore` line 27
**Section:** §1 Secrets and Configuration

```
# /config/*.secret.exs
```

The inline comment in `.gitignore` acknowledges the pattern's purpose but the line is disabled. This is the root-cause configuration error that allowed `prod.secret.exs` (and any future `*.secret.exs` file) to be committed. The line must be uncommented.

---

### A056-6 — HIGH: Guardian JWT TTL is 52 weeks with no visible revocation mechanism

**File:** `config/config.exs` lines 133–136
**Section:** §2 Authentication and Authorization

```elixir
ttl: {52, :weeks},
```

A one-year token lifetime means a stolen JWT remains valid for up to 52 weeks. Guardian 1.x does not include built-in server-side revocation; without a token store (e.g., GuardianDb), there is no way to invalidate tokens on logout, password change, or account suspension. The TTL should be reduced to a short-lived access token (e.g., 15 minutes to 1 hour) combined with a refresh token strategy, or a revocation store must be implemented.

---

### A056-7 — HIGH: Cross-tenant IDOR — `customer` claim used without validation in `resource_from_claims/1`

**File:** `lib/api_server/guardian.ex` lines 18–23
**Section:** §2 Authentication and Authorization

```elixir
def resource_from_claims(claims) do
  id = claims["sub"]
  customer = claims["customer"]
  user = Vx.get_vx_user!(id, customer)
  {:ok, user}
end
```

The `customer` value is taken directly from the JWT claims and used as a lookup parameter without validation against any authoritative record. If the signing key is known (see A056-1, which confirms it is committed to VCS), an attacker can craft a JWT with an arbitrary `customer` claim and load any user from any customer organisation. Even absent key compromise, if the claim can be manipulated through any other path, this becomes a cross-tenant data access vulnerability. The `customer` claim must be independently validated — for example, by verifying it matches the customer associated with the `sub` user in the database, rather than being accepted from the token at face value.

---

### A056-8 — HIGH: Guardian signing algorithm not explicitly configured — defaults silently

**File:** `config/config.exs` lines 133–136
**Section:** §2 Authentication and Authorization

No `allowed_algos` key is set in the Guardian configuration. Guardian 1.x defaults to `["HS512"]`. While `"none"` is not the default and is not configured, the lack of an explicit declaration means the accepted algorithm set is determined solely by library defaults. A future upgrade or misconfiguration could silently admit weaker or unintended algorithms. Best practice is to explicitly declare:

```elixir
allowed_algos: ["HS512"],
```

---

### A056-9 — HIGH: Hardcoded `secret_key_base` in `config/config.exs`

**File:** `config/config.exs` line 15
**Section:** §1 Secrets and Configuration

```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh"
```

A `secret_key_base` is hardcoded in the base config file. Even if this is intended as a development default, the value is committed to VCS. If production configuration fails to override it (e.g., during a misconfigured deployment), session cookies and signed URLs will be signed with a publicly known key. This value must be replaced with a fallback that fails loudly if no environment variable is set.

---

### A056-10 — MEDIUM: Plaintext web-service credentials stored in position-queue schema

**File:** `lib/api_server/fortynine/webservicepositionqueue.ex` lines 29–30
**Section:** §5 File and Data Handling

```elixir
field :WSUSERNAME, :string
field :WSPASSWORD, :string
```

The `[REDACTED-AWS-SMTP-PASSWORD]` schema persists web-service credentials (`:WSUSERNAME`, `:WSPASSWORD`) in the same table as GPS telemetry records. Storing credentials in an operational queue table alongside vehicle location data means any database query or ORM access to position records also exposes credentials. Credentials should be stored separately in a dedicated secrets store, with the queue referencing a credential identifier rather than the raw values.

---

### A056-11 — MEDIUM: AWS RDS hostname and region exposed in tracked config file

**File:** `config/prod.exs` line 36
**Section:** §7 Infrastructure Exposure

```
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com"
```

The full RDS cluster DNS name exposes the AWS account's RDS cluster identifier, the region (`ap-southeast-2`), and the environment context ("sandbox"). This should be moved to an environment variable.

---

### A056-12 — MEDIUM: Commented-out IAM access key ID persisted in VCS history

**File:** `config/prod.exs` lines 43, 55–57
**Section:** §1 Secrets and Configuration

```elixir
# username: "[REDACTED-AWS-KEY-ID]", # Existing username
```

A rotated (but not necessarily disabled) AWS IAM access key ID remains in a code comment. Automated secret scanners that index public or leaked repositories will flag this as an active credential. The key ID should be verified as fully revoked in AWS IAM and the comment should be removed. VCS history containing the key should be assessed for scrubbing.

---

### A056-13 — LOW: Guardian 1.x is end-of-life; no security support

**File:** `mix.exs` line 54; `mix.lock` line 31
**Section:** §6 Dependencies

```elixir
{:guardian, "~> 1.0"}   # resolves to 1.2.1
```

Guardian 1.2.1 is the last release of the 1.x series. The library has moved to 2.x, which includes breaking API changes and ongoing maintenance. Guardian 1.x receives no security patches. The project should plan an upgrade to Guardian 2.x.

---

### A056-14 — LOW: No `allowed_algos` in Guardian config — "none" algorithm not explicitly rejected

**File:** `config/config.exs` lines 133–136
**Section:** §2 Authentication and Authorization

Checklist item explicitly requires confirming the signing algorithm is not `"none"`. Guardian 1.x does not default to `"none"` and JOSE (the underlying library) will reject unsigned tokens in normal usage. However, the absence of an explicit `allowed_algos` list means there is no defence-in-depth configuration preventing algorithm confusion. Explicitly setting `allowed_algos: ["HS512"]` satisfies the checklist requirement and adds a configuration-level control.

---

### A056-15 — INFO: GPS, driver, and vehicle telemetry fields in webservicepositionqueue schema

**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Section:** §5 File and Data Handling

The schema contains sensitive fleet-management PII including `:LATITUDE`, `:LONGITUDE`, `:MOBILENAME`, `:driverID`, `:SPEED`, and `:HEADING`. Any code paths that query, log, or return rows from this schema should be reviewed in subsequent passes to confirm data is scoped per customer organisation and not disclosed in logs or error responses.

---

## Summary Table

| ID | Severity | File | Issue |
|----|----------|------|-------|
| A056-1 | CRITICAL | config/config.exs:136 | Guardian JWT signing key hardcoded in VCS |
| A056-2 | CRITICAL | config/prod.exs:13–37 | Production database credentials hardcoded in VCS |
| A056-3 | CRITICAL | config/prod.exs:44–48 | AWS SES IAM access key + secret hardcoded in VCS |
| A056-4 | CRITICAL | config/prod.secret.exs:12 / .gitignore:27 | `prod.secret.exs` committed — secret_key_base exposed |
| A056-5 | HIGH | .gitignore:27 | `*.secret.exs` git-exclusion rule is commented out |
| A056-6 | HIGH | config/config.exs:135 | JWT TTL 52 weeks with no revocation mechanism |
| A056-7 | HIGH | lib/api_server/guardian.ex:18–23 | `customer` claim trusted from JWT without validation — cross-tenant IDOR |
| A056-8 | HIGH | config/config.exs:133–136 | Guardian signing algorithm not explicitly declared |
| A056-9 | HIGH | config/config.exs:15 | `secret_key_base` hardcoded in base config |
| A056-10 | MEDIUM | lib/api_server/fortynine/webservicepositionqueue.ex:29–30 | Plaintext web-service credentials in telemetry queue schema |
| A056-11 | MEDIUM | config/prod.exs:36 | AWS RDS hostname and region hardcoded in tracked config |
| A056-12 | MEDIUM | config/prod.exs:43 | Rotated IAM key ID persisted in comment in VCS |
| A056-13 | LOW | mix.exs:54 | Guardian 1.x is end-of-life |
| A056-14 | LOW | config/config.exs:133–136 | `allowed_algos` not explicitly configured |
| A056-15 | INFO | lib/api_server/fortynine/webservicepositionqueue.ex | GPS/driver PII in schema — downstream data-scoping review needed |
