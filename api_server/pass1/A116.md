# Audit Report A116 — api_server Pass 1
**Agent:** A116
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Date:** 2026-02-27

Assigned files:
- `lib/api_server_web/controllers/vx_user_function_controller.ex`
- `lib/api_server_web/endpoint.ex`
- `lib/api_server_web/gettext.ex`

Supporting files read for context (not assigned but required for accurate analysis):
- `lib/api_server_web/router.ex`
- `config/config.exs`
- `config/prod.exs`
- `config/prod.secret.exs`
- `mix.exs`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/vx_user_function_controller.ex`

**Module name:** `ApiServerWeb.VXUserFunctionController`

**Public functions (`def`):** None. All action functions (index, create, show, update, delete) are commented out. No active public functions.

**defstruct / defexception / schema:** None.

**Plugs and pipelines:** None.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXUserFunction` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

---

### File 2: `lib/api_server_web/endpoint.ex`

**Module name:** `ApiServerWeb.Endpoint`

**Public functions (`def`):**
- `init/2` — arity 2, line 51

**defstruct / defexception / schema:** None.

**Plugs (in order):**
1. `plug Plug.Static` — at `/`, from `:api_server`, gzip: false (line 10–12)
2. `socket "/socket", ApiServerWeb.UserSocket` (line 4)
3. (dev only) `socket "/phoenix/live_reload/socket", Phoenix.LiveReloader.Socket` (line 17)
4. (dev only) `plug Phoenix.LiveReloader` (line 18)
5. (dev only) `plug Phoenix.CodeReloader` (line 19)
6. `plug Plug.Logger` (line 22)
7. `plug Plug.Parsers` — parsers: `[:urlencoded, :multipart, :json, :xml, Absinthe.Plug.Parser]`, pass: `["*/*"]`, json_decoder: Poison, xml_decoder: `:xmerl_scan` (lines 24–28)
8. `plug Plug.MethodOverride` (line 30)
9. `plug Plug.Head` (line 31)
10. `plug Plug.Session` — store: `:cookie`, key: `"_api_server_key"`, signing_salt: `"5CSDVUtC"` (lines 36–39)
11. `plug CORSPlug` — no arguments, default configuration (line 42)
12. `plug ApiServerWeb.Router` (line 43)

**use / import / alias at module level:**
- `use Phoenix.Endpoint, otp_app: :api_server` (line 2)

---

### File 3: `lib/api_server_web/gettext.ex`

**Module name:** `ApiServerWeb.Gettext`

**Public functions (`def`):** None. This module only uses the `Gettext` macro to inject translation helpers.

**defstruct / defexception / schema:** None.

**Plugs and pipelines:** None.

**use / import / alias at module level:**
- `use Gettext, otp_app: :api_server` (line 23)

---

## Checklist Findings

### §1: Secrets and Configuration

**A116-1** CRITICAL — Hardcoded `secret_key_base` in tracked source file
**File:** `config/config.exs`, line 15
```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh"
```
A 64-character production-quality secret key base is hardcoded directly in `config/config.exs`, which is committed to version control. This key is used to sign session cookies and other cryptographic material. Any party with repository read access can forge signed session cookies.

**A116-2** CRITICAL — Hardcoded AWS SES SMTP credentials in tracked source file
**File:** `config/config.exs`, lines 117–120
```elixir
username: "[REDACTED-AWS-KEY-ID]",
password: "[REDACTED-AWS-SMTP-PASSWORD]",
```
AWS IAM access key `[REDACTED-AWS-KEY-ID]` and its secret are hardcoded in the base config file. These credentials are replicated identically in `config/prod.exs` (lines 45–48). The key ID prefix `AKIA` indicates a long-lived IAM user access key. This gives any repository reader full SES send-as capability and potentially broader AWS access depending on the IAM policy attached to this user.

**A116-3** CRITICAL — Hardcoded Guardian JWT signing secret in tracked source file
**File:** `config/config.exs`, line 136
```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```
The Guardian JWT signing secret is hardcoded in version control. Any party with repository access can mint arbitrary valid JWT tokens for any user identity, bypassing all authentication.

**A116-4** CRITICAL — Hardcoded database password in tracked source file
**File:** `config/prod.exs`, lines 17 and 35
```elixir
# FortyNineRepo:
password: "Q973bFtc9z/cVW#mA",
hostname: "svr49.tracking-intelligence.com",

# Main Repo:
password: "TRxbixk9fuZc",
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
```
Two separate database passwords are hardcoded in `prod.exs`, which is a tracked file (it imports `prod.secret.exs` but is itself committed). Additionally, the RDS hostname and a third-party hostname (`svr49.tracking-intelligence.com`) are embedded, disclosing infrastructure topology.

**A116-5** HIGH — Hardcoded `secret_key_base` in `prod.secret.exs`
**File:** `config/prod.secret.exs`, line 12
```elixir
secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```
`prod.secret.exs` contains a separate production `secret_key_base`. While this file is listed as untracked (referenced via `import_config`), it was present in the repository snapshot audited and its content could be exposed if `.gitignore` is not correctly maintained. The more serious issue is that two different key base values exist across `config.exs` and `prod.secret.exs`, indicating the `config.exs` value may have been the live production key at some point.

**A116-6** MEDIUM — Guardian configured with a very long token TTL (52 weeks)
**File:** `config/config.exs`, line 135
```elixir
ttl: {52, :weeks},
```
JWT tokens are valid for one full year with no apparent refresh-token rotation policy evident in the config. A compromised token cannot be revoked before expiry unless a token revocation list is maintained (not observed in the codebase from available files). This significantly extends the window of exposure for any stolen token.

**A116-7** INFO — AWS RDS endpoint and internal hostnames hardcoded
**File:** `config/prod.exs`, lines 36 and 22
```
vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com
svr49.tracking-intelligence.com
```
These hostnames disclose the AWS region (`ap-southeast-2`), the RDS cluster identifier, and a third-party server hostname. Exposure is limited if the repository is private, but these should be supplied via environment variables.

---

### §2: Authentication and Authorization

**A116-8** HIGH — Two unauthenticated routes serve fleet/vehicle data without authentication
**File:** `lib/api_server_web/router.ex`, lines 30–31
```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)
  ...
  pipe_through([:api, :authenticated])
```
The `pipe_through([:api, :authenticated])` call appears on line 33, **after** the two `get` route definitions on lines 30–31. In Phoenix, routes are matched in the order they are declared within a scope, but the `pipe_through` macro applies to all routes within the scope when placed anywhere in it — however, the comment `# Avoid authentication, locking to a specific database` confirms that bypassing authentication is intentional for these two endpoints. These routes return fleet engine usage data (vehicle operational data) without any authentication. This must be confirmed as intentional and the scope of data returned must be verified to ensure it does not expose cross-customer fleet data.

**A116-9** HIGH — Multiple unauthenticated routes in the `:api` scope expose potentially sensitive data
**File:** `lib/api_server_web/router.ex`, lines 156–177
The second `/api/v1` scope uses only `pipe_through(:api)` with no `:authenticated` pipeline. Unauthenticated routes include:
- `GET /vx/:customer/thing/with_checklists` — returns hardware with checklists per customer
- `GET /vx/:customer/thing/:hardwareid/checklists` — returns checklists for a specific vehicle
- `GET /vx/:customer/pmServicesAjax/:hardwareid` — PM (preventive maintenance) data
- `GET /vx/:customer/pmServicesAjax` — all PM data
- `GET /vx/:customer/rentalStats` — rental statistics
- `GET /rhm/:customer/fix_info` — fix (GPS fix) info
- `GET /files/getsize/:esn` and `GET /files/getfile/:esn` — file access by ESN

The `:customer` path parameter means a caller who guesses or enumerates a valid customer identifier can retrieve fleet, checklist, maintenance, rental and GPS data for any customer without authentication. This is a potential IDOR and cross-tenant data exposure issue.

**A116-10** MEDIUM — Guardian JWT TTL of 52 weeks with no evidence of refresh token rotation (see also A116-6)
Tokens issued at login remain valid for one year. Without a server-side revocation list, logging out, changing a password, or disabling a user account does not invalidate previously issued tokens.

---

### §3: Input Validation and Injection

**A116-11** MEDIUM — XML parser configured with `:xmerl_scan` in endpoint
**File:** `lib/api_server_web/endpoint.ex`, line 28
```elixir
xml_decoder: :xmerl_scan
```
Erlang's `:xmerl_scan` is vulnerable to XML External Entity (XXE) attacks by default. It processes `DOCTYPE` declarations and external entity references unless explicitly disabled. Any endpoint accepting XML input (the `:api_xml` pipeline routes: POST `/`, POST `/test-omega-data`, POST `/prodisplay/event`, POST `/erp-import`) is potentially vulnerable to XXE — enabling server-side request forgery, internal network scanning, or file disclosure from the server filesystem. This finding pertains to the `endpoint.ex` parser configuration.

§3: No other issues found in the three assigned files (VXUserFunctionController has no active code; Gettext performs no input handling).

---

### §4: Session and CSRF

**A116-12** HIGH — Session cookie missing `secure`, `http_only`, and `same_site` flags
**File:** `lib/api_server_web/endpoint.ex`, lines 36–39
```elixir
plug Plug.Session,
  store: :cookie,
  key: "_api_server_key",
  signing_salt: "5CSDVUtC"
```
The `Plug.Session` configuration omits all three security cookie flags:
- No `secure: true` — the session cookie can be transmitted over unencrypted HTTP connections, allowing interception.
- No `http_only: true` — the cookie is accessible to JavaScript, making it vulnerable to XSS-based session theft. (Note: Phoenix/Plug does default `http_only` to `true` in some versions, but it is not explicitly set here, which is a configuration hygiene concern.)
- No `same_site: :strict` or `:lax` — the cookie is sent on cross-site requests, enabling CSRF attacks via cookie tossing and increasing CSRF surface area.

**A116-13** HIGH — No `encryption_salt` on session cookie — session contents are signed but not encrypted
**File:** `lib/api_server_web/endpoint.ex`, comment at line 33–35, configuration lines 36–39
The code comment explicitly notes: "The session will be stored in the cookie and signed, this means its contents can be read but not tampered with. Set `:encryption_salt` if you would also like to encrypt it." The `encryption_salt` is not set. Any data placed into the session is readable by the client (base64-encoded) and by any network observer who captures the cookie. If session data contains user identifiers, roles, or any sensitive information, this constitutes information disclosure.

**A116-14** HIGH — CORSPlug applied globally with default configuration (origin: "*")
**File:** `lib/api_server_web/endpoint.ex`, line 42
```elixir
plug CORSPlug
```
`CORSPlug` version `~> 1.5` defaults to `origin: "*"` when no options are provided. This allows any web origin to make credentialed or uncredentialed cross-origin requests to all endpoints, including authenticated API routes. For a fleet management API where authenticated endpoints handle customer vehicle data, driver records, and location data, wildcard CORS with `origin: "*"` is a significant security weakness. This is flagged by checklist §7 for authenticated endpoints. The router comments `# plug CORSPlug, origin: "*"` in the pipeline definitions also confirm the team was aware of the wildcard origin concern.

**A116-15** MEDIUM — No `check_origin` configuration visible for the WebSocket endpoint
**File:** `lib/api_server_web/endpoint.ex`, line 4
```elixir
socket "/socket", ApiServerWeb.UserSocket
```
No `check_origin` option is specified on the `socket` declaration. Phoenix defaults `check_origin` to `true` in production (checking the `Origin` header against the endpoint's configured URL), but this has not been explicitly configured. If the endpoint `url` host is not correctly set in production, the default check may pass unexpectedly. Explicit configuration is required per checklist §4.

**A116-16** INFO — CSRF protection is enabled for the `:browser` pipeline
**File:** `lib/api_server_web/router.ex`, line 8
```elixir
plug(:protect_from_forgery)
```
The browser pipeline correctly includes CSRF protection. However, none of the API routes use the `:browser` pipeline — they use `:api` or `:api_xml`, which do not include CSRF protection. For a JSON API using JWT authentication (stateless), this is typically acceptable. However, because session cookies are also set (via `Plug.Session` in the endpoint), endpoints that rely on session-based state remain CSRF-vulnerable.

---

### §5: File and Data Handling

§5: No issues found in the three assigned files. `[REDACTED-AWS-SMTP-PASSWORD]` has no active code. `Gettext` performs no data handling. `Endpoint` does not implement file handling logic directly beyond the static file plug.

Note for subsequent agents: The file download routes `GET /files/getsize/:esn` and `GET /files/getfile/:esn` in the router are unauthenticated and accept an `esn` path parameter — these should be reviewed for path traversal in `FileController`, which is not an assigned file for this agent.

---

### §6: Dependencies

**A116-17** HIGH — `mariaex ~> 0.8.2` is deprecated with no security support
**File:** `mix.exs`, line 39
```elixir
{:mariaex, "~>0.8.2"},
```
The checklist explicitly flags Mariaex 0.8.2 as deprecated with no security support. This library is the MySQL/MariaDB adapter and handles all database query execution. Any unpatched vulnerability in this driver (query construction, protocol handling, TLS negotiation) has no upstream fix path.

**A116-18** MEDIUM — Multiple dependencies pinned to approximate (`~>`) versions with older major versions
**File:** `mix.exs`
Several dependencies use `~>` version constraints pointing to old versions:
- `{:phoenix, "~> 1.5.9"}` — Phoenix 1.5.x is significantly outdated; Phoenix 1.7+ contains security improvements.
- `{:guardian, "~> 1.0"}` — Guardian 1.x; current is 2.x.
- `{:cowboy, "~> 1.0"}` — Cowboy 1.x is end-of-life; Cowboy 2.x is the supported version.
- `{:absinthe, "~> 1.4.0"}` and `{:absinthe_plug, "~> 1.4.0"}` — outdated.
- `{:distillery, "~> 1.5"}` — outdated release tooling.
- `{:phoenix_ecto, "~> 3.2"}` — outdated.

All dependencies should be reviewed against hex.pm advisory database (`mix hex.audit`).

**A116-19** INFO — Local path dependency for `geonames`
**File:** `mix.exs`, line 56
```elixir
{:geonames, path: "geonames-elixir"},
```
A local path dependency is used rather than a published hex.pm package. This dependency is not subject to hex.pm security advisories and its exact version and provenance cannot be verified through the normal dependency audit process. The source at `geonames-elixir/` must be manually reviewed.

---

### §7: Infrastructure Exposure

**A116-20** HIGH — CORS wildcard origin on all endpoints including authenticated API routes (see A116-14)
Covered under §4/A116-14. Restated here per checklist §7: `plug CORSPlug` with default `origin: "*"` is applied globally in `endpoint.ex` before the router, meaning every route — including authenticated fleet management endpoints — accepts cross-origin requests from any origin.

**A116-21** MEDIUM — No security headers (Content Security Policy, X-Frame-Options, X-Content-Type-Options) configured in endpoint
**File:** `lib/api_server_web/endpoint.ex`
The endpoint does not configure any security response headers beyond what the `:browser` pipeline's `put_secure_browser_headers/2` provides (which only applies to the browser pipeline in the router). For API responses, no `Content-Security-Policy`, `X-Frame-Options`, `X-Content-Type-Options`, or `Strict-Transport-Security` headers are set. The checklist §7 flags Content Security Policy review in the endpoint module.

**A116-22** MEDIUM — No `force_ssl` or HSTS configured in endpoint or production config
**File:** `config/prod.exs`
The `force_ssl` option is commented out in `prod.exs` (lines 80–82). There is no `https:` configuration in `prod.exs` — only `http: [port: 4000]`. This means the application may be serving all traffic, including authentication tokens and session cookies, over unencrypted HTTP. If TLS termination is handled by a load balancer, this should be documented; otherwise `force_ssl: [hsts: true]` must be enabled.

**A116-23** INFO — AWS region disclosed via SES endpoint and RDS hostname
**Files:** `config/config.exs` line 113, `config/prod.exs` line 36
`email-smtp.us-west-2.amazonaws.com` and `ap-southeast-2.rds.amazonaws.com` disclose two different AWS regions in use (`us-west-2` for SES, `ap-southeast-2` for RDS). Disclosure risk is low if the repository is private but is worth noting as infrastructure topology information.

---

## Summary Table

| ID      | Severity | Section | Description |
|---------|----------|---------|-------------|
| A116-1  | CRITICAL | §1 | Hardcoded `secret_key_base` in `config/config.exs` |
| A116-2  | CRITICAL | §1 | Hardcoded AWS SES SMTP credentials (IAM key + secret) in `config/config.exs` and `config/prod.exs` |
| A116-3  | CRITICAL | §1 | Hardcoded Guardian JWT signing secret in `config/config.exs` |
| A116-4  | CRITICAL | §1 | Hardcoded database passwords for two repos in `config/prod.exs` |
| A116-5  | HIGH     | §1 | `secret_key_base` in `prod.secret.exs` (potentially tracked) |
| A116-6  | MEDIUM   | §1/§2 | Guardian JWT TTL of 52 weeks — excessive token lifetime |
| A116-7  | INFO     | §1/§7 | AWS region and RDS/external hostnames hardcoded in config |
| A116-8  | HIGH     | §2 | Two unauthenticated routes serving vehicle/engine usage data |
| A116-9  | HIGH     | §2 | Unauthenticated `:api` scope exposes per-customer fleet, checklist, PM, rental, GPS data |
| A116-10 | MEDIUM   | §2 | 52-week JWT with no apparent token revocation mechanism |
| A116-11 | MEDIUM   | §3 | `:xmerl_scan` XML decoder vulnerable to XXE by default |
| A116-12 | HIGH     | §4 | Session cookie missing `secure`, `http_only`, `same_site` flags |
| A116-13 | HIGH     | §4 | Session cookie signed but not encrypted — contents readable by client |
| A116-14 | HIGH     | §4/§7 | `CORSPlug` with default `origin: "*"` applied globally |
| A116-15 | MEDIUM   | §4 | No explicit `check_origin` for WebSocket endpoint |
| A116-16 | INFO     | §4 | CSRF protection present in `:browser` pipeline only |
| A116-17 | HIGH     | §6 | Mariaex 0.8.2 — deprecated, no security support |
| A116-18 | MEDIUM   | §6 | Multiple outdated major-version dependencies (Phoenix 1.5, Cowboy 1.x, Guardian 1.x) |
| A116-19 | INFO     | §6 | Local path dependency `geonames-elixir` — not subject to hex.pm advisories |
| A116-20 | HIGH     | §7 | CORS wildcard origin covers authenticated fleet management routes (restatement of A116-14) |
| A116-21 | MEDIUM   | §7 | No security response headers (CSP, X-Frame-Options, HSTS) in endpoint |
| A116-22 | MEDIUM   | §7 | No `force_ssl`/HSTS configured — traffic may be served over HTTP |
| A116-23 | INFO     | §7 | AWS region topology disclosed via hardcoded SES/RDS endpoints |

**CRITICAL findings: 4**
**HIGH findings: 7**
**MEDIUM findings: 6**
**LOW findings: 0**
**INFO findings: 4**
