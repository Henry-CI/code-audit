# Audit Report A107
**Agent:** A107
**Run:** 2026-02-27-01
**Stack:** Elixir/Phoenix
**Branch:** master
**Assigned files:**
- lib/api_server_web/controllers/vx_fleet_controller.ex
- lib/api_server_web/controllers/vx_rental_controller.ex
- lib/api_server_web/controllers/vx_restriction_controller.ex

---

## Reading Evidence

### File 1: lib/api_server_web/controllers/vx_fleet_controller.ex

**Module name:** `ApiServerWeb.VXFleetController`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `create` | 2 | 9 |
| `get_fleets` | 2 | 19 (clause 1: admin) |
| `get_fleets` | 2 | 27 (clause 2: default) |
| `get_fleets_with_equipment` | 2 | 35 |
| `create_fleet` | 2 | 68 |
| `delete_fleet` | 2 | 91 |
| `get_equipment_in_fleet` | 2 | 105 |
| `manage_fleet` | 2 | 110 |
| `update_fleet` | 2 | 119 |

**defstruct / defexception / schema:** None defined in this module.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXFleet`
- `action_fallback ApiServerWeb.FallbackController`

---

### File 2: lib/api_server_web/controllers/vx_rental_controller.ex

**Module name:** `ApiServerWeb.VXRentalController`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `get_rentals` | 2 | 9 (clause 1: closed=1) |
| `get_rentals` | 2 | 30 (clause 2: default) |
| `get_midpac_style_rental_report` | 2 | 51 |
| `get_rental_anniversaries` | 2 | 110 |
| `create_rental` | 2 | 158 |
| `update_rental` | 2 | 174 |
| `delete_rental` | 2 | 191 |
| `rhm_active_rental` | 2 | 206 |

**defstruct / defexception / schema:** None defined in this module.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXRental`
- `action_fallback ApiServerWeb.FallbackController`

---

### File 3: lib/api_server_web/controllers/vx_restriction_controller.ex

**Module name:** `ApiServerWeb.VXRestrictionController`

**Public functions (def):** None.

**defstruct / defexception / schema:** None.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXRestriction`
- `action_fallback ApiServerWeb.FallbackController`

---

## Checklist Review

### §1: Secrets and Configuration

No config files, hardcoded credentials, API keys, or secrets present in these three controller files. No module attributes referencing secrets.

§1: No issues found.

---

### §2: Authentication and Authorization

**Router context (from lib/api_server_web/router.ex):**

The `/api/v1` scope has two sub-blocks. The first two routes in the scope — `GET /rhm/engine_usage` and `GET /rhm/monday_hour_meters` — appear **before** the `pipe_through([:api, :authenticated])` call (line 33). All routes added after that call (lines 36 onward), which includes all fleet and rental routes, go through `:authenticated` (i.e., `ApiServer.Guardian.AuthPipeline`).

**IDOR analysis — fleet controller:**

The `get_fleets/2` (both clauses), `get_fleets_with_equipment/2`, `create_fleet/2` all read `customer` from the JWT claims (`current_claims(conn)["customer"]`) and pass it as a scoping parameter to the Vx context. This is correct: the organisation is derived from the token, not from user-supplied input.

However, the following functions accept `customer` directly from request parameters (URL path segment `/:customer/`) and pass it to data-layer calls **without verifying it matches the authenticated token's customer claim**:

- `delete_fleet/2` (line 91): `%{"customer" => customer, "id" => id}` — `customer` from path, not from JWT.
- `get_equipment_in_fleet/2` (line 105): `%{"customer" => customer, "id" => fleet_id}` — `customer` from path, not from JWT.
- `manage_fleet/2` (line 110): `%{"customer" => customer, "id" => fleet_id, ...}` — `customer` from path, not from JWT.
- `update_fleet/2` (line 119): `%{"customer" => customer, "fleet" => fleet_params}` — `customer` from path, not from JWT.
- `create_fleet/2` (line 68): pattern match includes `%{"customer" => cust, ...}` from the path. The variable `cust` is bound from the path parameter but is **never used**; instead `customer` is re-read from the JWT claims (line 69). While the data operations use the JWT-derived `customer`, the unused `cust` variable is a dead-code smell, but functionally this function is safe.

**IDOR analysis — rental controller:**

The following rental functions accept `customer` from the route path segment `/:customer/` and use it directly for data access without verifying it against the JWT customer claim:

- `create_rental/2` (line 158): `%{"customer" => customer, ...}` — `customer` from path parameter used directly in `Vx.create_rental/2` and `Vx.get_rental/2`.
- `update_rental/2` (line 174): `%{"customer" => customer, ...}` — same issue.
- `delete_rental/2` (line 191): `%{"customer" => customer, ...}` — same issue.

The following rental functions correctly derive `customer` from JWT claims:
- `get_rentals/2` both clauses: JWT-derived.
- `get_midpac_style_rental_report/2`: JWT-derived.
- `get_rental_anniversaries/2`: JWT-derived.
- `rhm_active_rental/2`: JWT-derived.

Note: `get_rentals/2` clause 1 (line 9) matches `%{"customer" => _customer, "closed" => "1"}` — the `_customer` path param is explicitly discarded and the JWT claim is used. Correct.

---

**A107-1 — HIGH — IDOR: fleet write/delete operations trust URL-supplied customer parameter**

Files: `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 91, 105, 110, 119.

`delete_fleet/2`, `get_equipment_in_fleet/2`, `manage_fleet/2`, and `update_fleet/2` all destructure `customer` from the URL path parameter and pass it directly to Vx context calls (`Vx.get_vx_fleet/2`, `Vx.delete_vx_fleet/2`, `Vx.get_equipment_in_fleet/2`, `Vx.update_fleet_assocs/3`, `Vx.update_vx_fleet/3`) without checking that the supplied customer code matches the authenticated user's organisation from the JWT claims (`current_claims(conn)["customer"]`).

An authenticated user who belongs to customer `CUST_A` can supply `CUST_B` in the URL path and perform delete, update, and fleet membership management operations against another customer's fleets. The only scoping is the user-supplied string, not the token-bound identity.

Affected routes (from router.ex):
- `DELETE /api/v1/rhm/:customer/fleet/:id` → `delete_fleet/2`
- `GET /api/v1/rhm/:customer/fleet/:id/equipment` → `get_equipment_in_fleet/2`
- `POST /api/v1/rhm/:customer/fleet/:id/manage` → `manage_fleet/2`
- `POST /api/v1/rhm/:customer/fleet/` → `update_fleet/2`

Fix direction: Extract the authenticated customer from `ApiServer.Guardian.Plug.current_claims(conn)["customer"]` in each function (as is already done in `get_fleets/2`) and discard or validate the path parameter against it.

---

**A107-2 — HIGH — IDOR: rental write/delete operations trust URL-supplied customer parameter**

File: `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 158, 174, 191.

`create_rental/2`, `update_rental/2`, and `delete_rental/2` all destructure `customer` from the URL path parameter and use it directly for every data access call without verifying it against the JWT customer claim.

An authenticated user from customer `CUST_A` can supply `CUST_B` in the URL and create rentals, update rentals, or delete rentals against another organisation's data.

Affected routes:
- `PUT /api/v1/rhm/:customer/rentals/` → `create_rental/2`
- `POST /api/v1/rhm/:customer/rentals/` → `update_rental/2`
- `DELETE /api/v1/rhm/:customer/rentals/:id` → `delete_rental/2`

Fix direction: Same as A107-1 — derive `customer` from the JWT, not from the URL.

---

**A107-3 — MEDIUM — Unauthenticated endpoints before pipe_through in same scope block**

File: `lib/api_server_web/router.ex`, lines 30-32 (context for these controllers).

The router's first `/api/v1` scope block places two GET routes (`/rhm/engine_usage` and `/rhm/monday_hour_meters`) before the `pipe_through([:api, :authenticated])` macro call. In Phoenix, `pipe_through` applies to routes that follow it in the same scope, so these two routes receive no authentication pipeline. While these specific routes dispatch to `VXThingController` (not the files under audit), the pattern demonstrates that route ordering controls authentication — a developer adding a new route above line 33 in this block would silently bypass authentication. This is an architectural fragility that affects the entire `/api/v1` scope.

This finding is included because the fleet and rental controllers' security depends on this pipeline structure.

---

§2: Issues found — see A107-1, A107-2, A107-3.

---

### §3: Input Validation and Injection

**String.to_integer usage:** `manage_fleet/2` at line 113 calls `String.to_integer(fleet_id)` where `fleet_id` comes from the URL path parameter. If `fleet_id` is not a valid integer string, `String.to_integer/1` raises an `ArgumentError` at runtime. This is not caught and will result in an unhandled exception propagating up. No user-controlled atom creation (`String.to_atom/1`) is present. No `Code.eval_string/1`, no `:erlang.binary_to_term/1`, no `Kernel.apply/3` with user-controlled module/function names.

No raw SQL fragments with user input interpolation are visible in controller code; queries are delegated to the `Vx` context module (not in scope for this audit).

**Changeset usage:** `create_fleet/2` and `update_fleet/2` use `ApiServer.Vx.VXFleet.convert_json_to_changeset/1`. `create_rental/2` and `update_rental/2` use `ApiServerWeb.VXRentalView.convert_json_to_changeset/1`. The safety of these conversions depends on those functions (not in scope), but the controller does not perform any raw parameter interpolation into queries itself.

**A107-4 — LOW — Unguarded String.to_integer on user input may cause 500 crash**

File: `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 113.

```elixir
|> Enum.map(fn(id) -> %{aafgroupid: String.to_integer(fleet_id), aafthingid: id} end)
```

`fleet_id` is a URL path parameter (string). `String.to_integer/1` raises `ArgumentError` if the value is not a valid integer (e.g., a non-numeric string or path traversal attempt). This is not caught; the exception will propagate to the fallback controller or cause a 500. An attacker can trivially trigger repeated 500 responses. The `FallbackController` does not handle raw exceptions (only `{:error, %Ecto.Changeset{}}` and `{:error, :not_found}`), so the crash surfaces as an unhandled exception to the Phoenix error handler.

§3: Issue found — see A107-4.

---

### §4: Session and CSRF

These are JSON API controllers. CSRF protection (`protect_from_forgery`) is present only in the `:browser` pipeline, not in `:api` or `:authenticated`. This is standard for JWT-authenticated JSON APIs and is acceptable. No WebSocket/channel usage in these controllers. No session reads or writes in these controllers (session is fetched in the pipeline but not used in fleet/rental/restriction controllers).

§4: No issues found.

---

### §5: File and Data Handling

**Information disclosure in error responses:**

`create_fleet/2` at line 86 returns `inspect changeset` in a 500 response body:
```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")
```

`update_fleet/2` at line 129 does the same:
```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }")
```

`update_rental/2` at line 184:
```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }")
```

`create_rental/2` at line 169:
```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"Unknown error creating rental\",\"reason\": \"An error occured while creating this rental\", \"changeset\": \"#{inspect changeset}\"}\" }")
```

Ecto changeset `inspect` output can include field names, constraint names, and in some cases partial data values that reveal internal database schema details to the API client.

**A107-5 — MEDIUM — Internal Ecto changeset details leaked to API clients in error responses**

Files:
- `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 86 and 129.
- `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 169 and 184.

All four locations use `#{inspect changeset}` or `#{inspect result}` directly in the HTTP response body. Ecto changeset inspect output reveals internal database constraint names, field names, and schema structure to unauthenticated-perspective API clients (the authenticated caller). This is an information disclosure issue that aids reconnaissance.

Additionally, `create_rental/2` at line 169 contains a syntax error in the JSON string: the literal `}\"` before the closing `}` produces malformed JSON (`...\"changeset\": \"...\"}\" }`), which will cause client-side JSON parse failures.

**No PII in Logger calls:** No `Logger` calls are present in any of the three controller files. Fleet data and rental data (vehicle descriptions, serial numbers, customer names) are not logged.

**Data scoping to organisation:** Addressed under §2 above. The read paths correctly use JWT-derived customer. The write/delete paths have IDOR issues already noted (A107-1, A107-2).

§5: Issue found — see A107-5.

---

### §6: Dependencies

No `mix.exs` or `mix.lock` changes are introduced by these controller files. Dependency review is out of scope for individual controller files.

§6: No issues found (dependency review deferred to designated pass).

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IPs, port numbers, or AWS resource identifiers appear in these three files. No CORS configuration is present in these controllers. No direct TLS configuration. No inter-service HTTP calls originate from these controllers; all data access is through the `ApiServer.Vx` context module.

§7: No issues found.

---

## Findings Summary

| ID | Severity | File(s) | Summary |
|----|----------|---------|---------|
| A107-1 | HIGH | vx_fleet_controller.ex:91,105,110,119 | IDOR: delete_fleet, get_equipment_in_fleet, manage_fleet, update_fleet trust URL customer param, not JWT |
| A107-2 | HIGH | vx_rental_controller.ex:158,174,191 | IDOR: create_rental, update_rental, delete_rental trust URL customer param, not JWT |
| A107-3 | MEDIUM | router.ex:30-32 | Two routes before pipe_through — unauthenticated by accident of ordering; architectural fragility |
| A107-4 | LOW | vx_fleet_controller.ex:113 | Unguarded String.to_integer on user-supplied path param causes unhandled 500 |
| A107-5 | MEDIUM | vx_fleet_controller.ex:86,129 / vx_rental_controller.ex:169,184 | Ecto changeset internals leaked verbatim to API clients; also malformed JSON in create_rental error |
