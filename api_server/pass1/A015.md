# Security Audit Report — A015
**Agent:** A015
**Run:** 2026-02-27-01
**Repo:** api_server
**Branch:** master
**Stack:** Elixir/Phoenix
**Scope:** Vendored geonames-elixir endpoint modules

---

## Assigned Files

1. `geonames-elixir/lib/geonames/endpoints/atergdem.ex`
2. `geonames-elixir/lib/geonames/endpoints/children.ex`
3. `geonames-elixir/lib/geonames/endpoints/cities.ex`

Supporting files read for full context (not in scope but necessary for accurate audit):
- `geonames-elixir/lib/geonames/endpoint.ex` (behaviour definition)
- `geonames-elixir/lib/geonames.ex` (macro-generated public API, HTTP dispatch)
- `geonames-elixir/lib/geonames/helpers.ex` (URL construction, credential injection)
- `geonames-elixir/mix.exs` (dependency manifest for vendored library)
- `config/config.exs` lines 138-140 (geonames runtime configuration)

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/atergdem.ex`

**Module name:** `Geonames.Endpoints.Astergdem`

Note: the filename is `atergdem.ex` but the module is named `Astergdem` — this is a pre-existing discrepancy in the vendored library (filename typo, not a security issue).

**Public functions (def, not defp):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 10 |
| `available_url_parameters/0` | 0 | 11 |
| `required_url_parameters/0` | 0 | 12 |
| `function_name/0` | 0 | 13 |
| `url_arguments/1` | 1 | 15 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attribute:**
```elixir
@default_arguments %{ lat: nil, lng: nil }
```

---

### File 2: `geonames-elixir/lib/geonames/endpoints/children.ex`

**Module name:** `Geonames.Endpoints.Children`

**Public functions (def, not defp):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 11 |
| `available_url_parameters/0` | 0 | 12 |
| `required_url_parameters/0` | 0 | 13 |
| `function_name/0` | 0 | 14 |
| `url_arguments/1` | 1 | 16 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attribute:**
```elixir
@default_arguments %{
  geonameId: nil,
  maxRows: 200,
  hierarchy: "tourism"
}
```

---

### File 3: `geonames-elixir/lib/geonames/endpoints/cities.ex`

**Module name:** `Geonames.Endpoints.Cities`

**Public functions (def, not defp):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 13 |
| `available_url_parameters/0` | 0 | 14 |
| `required_url_parameters/0` | 0 | 15 |
| `function_name/0` | 0 | 16 |
| `url_arguments/1` | 1 | 18 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attribute:**
```elixir
@default_arguments %{
  north: nil,
  south: nil,
  east: nil,
  west: nil,
  maxRows: 10
}
```

---

## Checklist Review

### §1: Secrets and Configuration

**Finding A015-1** — CRITICAL: Hardcoded GeoNames API username in tracked config file.

File: `config/config.exs`, lines 138–140:
```elixir
config :geonames,
  username: "vinxstudio",
  language: "en"
```

The GeoNames API username `"vinxstudio"` is committed in plaintext in a tracked source file. This is the credential used by `Geonames.Helpers.user_configuration/0` to authenticate every outbound API call to `api.geonames.org`. A hardcoded API credential in a tracked config file is a secret leakage: anyone with read access to the repository (including CI pipelines, audit tools, or future employees) can extract and abuse this credential. The correct pattern is to load it from an environment variable: `System.get_env("GEONAMES_USERNAME")`. Note that `Geonames.Helpers` already has fallback logic for `System.get_env("GEONAMES_USERNAME")` but this fallback is never reached because the application config is set first. The hardcoded value takes precedence over the environment-variable fallback.

**Finding A015-2** — CRITICAL: Hardcoded Guardian `secret_key` in the same tracked config file.

File: `config/config.exs`, line 136:
```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

While this is not part of the assigned endpoint files, it was discovered in the same config block immediately above the geonames config and is within scope of §1. This is the JWT signing secret for all authentication tokens issued by Guardian. A hardcoded secret_key in a tracked file means any JWT token can be forged by any party who has ever seen the repository. This must be loaded from a secrets manager or environment variable at runtime.

**Finding A015-3** — LOW: GeoNames `base_url` is hardcoded as a compile-time module attribute with no TLS scheme.

File: `geonames-elixir/lib/geonames/helpers.ex`, line 8:
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default base URL `"api.geonames.org/"` does not include a URI scheme. In `build_url_string/2` the URL is assembled as `@base_url <> endpoint <> "?" <> encoded_params`, yielding a string such as `api.geonames.org/citiesJSON?...`. HTTPoison will prepend `http://` as the scheme default when no scheme is present. All outbound calls to the GeoNames API therefore occur over plaintext HTTP rather than HTTPS. This is relevant for the username credential transmitted in every request query string (see A015-1). The username would be sent in cleartext to an external service. The base_url default should be `"https://api.geonames.org/"`.

---

### §2: Authentication and Authorization

The three assigned endpoint modules (`Astergdem`, `Children`, `Cities`) are pure data-descriptor modules. They define no HTTP handlers, no plug pipelines, no authentication checks, and no authorization logic. They are consumed by the macro loop in `Geonames` (geonames.ex) which generates wrapper functions for outbound calls to the external GeoNames API.

These modules are not Phoenix controllers; they do not receive inbound HTTP requests from application users. Authentication of inbound requests is handled by upstream Phoenix plugs that are outside the scope of these files.

No authentication or authorization issues arise directly from the three assigned files themselves.

**Finding A015-4** — MEDIUM: No caller-side authorization gate on `Children.url_arguments/1` for the `geonameId` parameter.

The `Children` endpoint accepts a caller-supplied `geonameId` and passes it through `Map.merge/2` with no validation. When this library is invoked from an application controller, there is no enforcement within this library layer that the `geonameId` belongs to or is accessible by the authenticated user. This is an IDOR risk if the calling application controller passes a user-supplied `geonameId` without first verifying the user is authorized to query that geographic entity. Authorization must be enforced at the controller layer; this finding is flagged here because the library provides no guard and callers must be reviewed. This finding should be corroborated by a review of the application controllers that call `Geonames.children/1`.

§2: No additional issues found in the assigned files beyond A015-4.

---

### §3: Input Validation and Injection

**Finding A015-5** — MEDIUM: No input validation or sanitization of caller-supplied parameters before URL construction.

All three endpoint modules implement `url_arguments/1` identically as a plain `Map.merge/2` of caller-supplied arguments over defaults:
```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

There is no type checking, range checking, or allowlisting of values. For example:
- `Cities` accepts `north`, `south`, `east`, `west` as latitude/longitude bounding box coordinates. These should be floats in the range -90..90 (lat) and -180..180 (lng). No such validation exists.
- `Children` accepts `maxRows` (default 200) and `hierarchy`. The `hierarchy` value is a free-form binary that is interpolated directly into the URL query string in `Geonames.Helpers.build_url_string/2` via `"#{k}=#{v}"` without encoding the value separately before joining with `&`.
- `Astergdem` accepts `lat` and `lng` with no bounds checking.

`URI.encode/1` is called on the full assembled query string in `build_url_string/2`:
```elixir
|> URI.encode
```

However, `URI.encode/1` encodes the entire string and only encodes characters outside the unreserved set. It does not encode `&`, `=`, or `?`. A crafted value such as `"tourism&username=attacker"` passed as `hierarchy` would not be fully neutralized: the `&` character would survive `URI.encode/1` because `&` is a valid URI character. This could permit parameter injection into the outbound GeoNames API request, potentially overriding the `username` parameter or injecting additional query parameters. The risk is contingent on whether the calling application passes user-supplied data to `Geonames.children/1` without sanitizing the `hierarchy` field.

**Finding A015-6** — LOW: `url_arguments/1` accepts arbitrary map keys beyond those in `available_url_parameters`.

`Map.merge(@default_arguments, provided_arguments)` will retain any keys in `provided_arguments` that are not in `@default_arguments`. The `available_url_parameters` list is informational only and is not enforced. Extra keys pass through to `build_url_string/2` and are included in the outbound URL. If user-controlled data is passed as the arguments map without strict allowlisting at the call site, arbitrary query parameters can be injected into the GeoNames API request.

§3: No raw SQL, no atom creation from user input, no `binary_to_term`, no `Code.eval_string`, no `Kernel.apply` with user-controlled inputs found in the three assigned files.

---

### §4: Session and CSRF

The assigned files are outbound HTTP client descriptor modules, not Phoenix controllers or channels. They handle no inbound sessions, cookies, CSRF tokens, or WebSocket connections.

§4: No issues found.

---

### §5: File and Data Handling

**Finding A015-7** — INFO: Outbound API response deserialized with `Poison.decode!/1` — no schema validation on received data.

In `geonames.ex` line 133:
```elixir
{ :ok, Poison.decode!(body) }
```

The raw JSON body from the external GeoNames API is decoded and returned without any schema validation or field filtering. If the GeoNames API response were tampered with (e.g., DNS hijack of `api.geonames.org`, or an MITM on the plaintext HTTP connection noted in A015-3), maliciously crafted JSON could propagate into the application's data layer. The bang form `Poison.decode!` also raises an exception on malformed JSON rather than returning an error tuple, which could produce unhandled runtime errors surfaced to API consumers.

**Finding A015-8** — LOW: `build_url_string/2` constructs the full outbound URL by string concatenation; the GeoNames `username` credential is transmitted as a plaintext query parameter over HTTP.

As established in A015-3, the scheme defaults to HTTP. The username credential appears as `username=vinxstudio` in every outbound request query string. Query parameters are logged by many HTTP proxies and intermediaries. Combined with A015-1 (credential hardcoded in tracked file) and A015-3 (cleartext HTTP), this represents a full credential exposure chain for the GeoNames API account.

§5: No file upload handling, no PII in Logger calls, no cross-customer data boundary issues found in the three assigned files (these modules make no database queries and return external geographic data, not fleet/driver/vehicle data).

---

### §6: Dependencies

The vendored `geonames-elixir` library declares the following runtime dependencies in `geonames-elixir/mix.exs`:

```elixir
{:poison, "~> 3.1"},
{:httpoison, "~> 1.0"},
```

**Finding A015-9** — MEDIUM: `poison ~> 3.1` is an outdated major version with known security history.

Poison 3.x is significantly outdated (current stable is 6.x as of 2026). Poison 3.x has had parsing edge-case issues. The `~>` constraint permits `>= 3.1.0, < 4.0.0` only — the library is locked to a 3.x series that received its last security-relevant patch years ago. The project should evaluate migrating to `Jason` (now the Phoenix default JSON library) or at minimum updating to a current Poison major version.

**Finding A015-10** — LOW: `httpoison ~> 1.0` is an outdated constraint.

HTTPoison 1.x is outdated (current is 2.x). The `~>` constraint pins to `>= 1.0.0, < 2.0.0`. HTTPoison is a wrapper over Hackney; version 1.x may depend on an older Hackney that has had TLS-related updates in later versions. This should be updated to current.

**Finding A015-11** — INFO: Vendored library has its own `mix.exs` with independent dependency constraints that may diverge from the host application's `mix.lock`.

The geonames-elixir library is vendored (source-included) rather than declared as a path or hex dependency. Its `mix.exs` declares its own `poison` and `httpoison` constraints. If the host application's `mix.lock` resolves different versions of these packages than what the vendored `mix.exs` targets, there may be silent version conflicts. The host application's `mix.lock` should be reviewed to confirm the resolved versions of `poison` and `httpoison` are compatible and current.

§6: No `git:` source URLs. No Mariaex found in this library. No missing `mix.lock` in the vendored library directory (the vendored library's own `mix.lock` should be confirmed as absent or consistent with the host).

---

### §7: Infrastructure Exposure

**Finding A015-12** — LOW: Outbound requests to `api.geonames.org` use plaintext HTTP (see A015-3) and transmit credentials in the query string.

The hardcoded base URL `"api.geonames.org/"` without an `https://` scheme means all outbound geographic API calls leave the application over unencrypted HTTP. The `username` parameter (a third-party API credential) is visible in the query string to any network intermediary on the path between the application server and GeoNames. In an AWS VPC environment, this traffic leaves the VPC boundary in cleartext. The `base_url` default should be corrected to `"https://api.geonames.org/"` and this should be enforced via configuration rather than relying on defaults.

**Finding A015-13** — INFO: The `base_url` is configurable via application config but the default exposes an infrastructure assumption.

`Application.get_env(:geonames, :base_url, "api.geonames.org/")` defaults to the public GeoNames API. If the application were configured to point at an internal proxy or alternative service, there is no validation that the configured URL uses HTTPS, which could silently downgrade security.

§7: No CORS configuration, no CSP, no inbound port exposure in these files. No hardcoded AWS endpoints, RDS hostnames, or EC2 identifiers found in the three assigned files or the supporting geonames-elixir library files.

---

## Summary of Findings

| ID | Severity | Section | Description |
|---|---|---|---|
| A015-1 | CRITICAL | §1 | GeoNames API username `"vinxstudio"` hardcoded in tracked `config/config.exs` |
| A015-2 | CRITICAL | §1 | Guardian `secret_key` hardcoded in tracked `config/config.exs` (discovered in same config block) |
| A015-3 | LOW | §1/§7 | Default `base_url` has no URI scheme; outbound calls default to HTTP not HTTPS |
| A015-4 | MEDIUM | §2 | No authorization gate in `Children` on `geonameId`; IDOR risk at call sites |
| A015-5 | MEDIUM | §3 | No input validation on URL parameters; `hierarchy` and other string fields susceptible to query-parameter injection via unencoded `&`/`=` characters |
| A015-6 | LOW | §3 | `url_arguments/1` passes arbitrary extra map keys through to outbound URL; no allowlist enforcement |
| A015-7 | INFO | §5 | Outbound API response deserialized via `Poison.decode!` with no schema validation; bang form raises on malformed JSON |
| A015-8 | LOW | §5 | API credential transmitted as plaintext query string parameter over HTTP |
| A015-9 | MEDIUM | §6 | `poison ~> 3.1` is an outdated major version; should migrate to Jason or current Poison |
| A015-10 | LOW | §6 | `httpoison ~> 1.0` is an outdated version constraint |
| A015-11 | INFO | §6 | Vendored library has independent `mix.exs`; dependency version resolution against host `mix.lock` unverified |
| A015-12 | LOW | §7 | All outbound GeoNames calls use plaintext HTTP; credential exposed in query string to network intermediaries |
| A015-13 | INFO | §7 | Configurable `base_url` has no enforcement of HTTPS scheme |

---

*Report generated by agent A015, pass 1, run 2026-02-27-01.*
