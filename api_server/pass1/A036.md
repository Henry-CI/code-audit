# Audit Report A036
**Agent:** A036
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Pass:** 1
**Date:** 2026-02-27

**Assigned files:**
- `geonames-elixir/lib/geonames/endpoints/hierarchy.ex`
- `geonames-elixir/lib/geonames/endpoints/neighbourhood.ex`
- `geonames-elixir/lib/geonames/endpoints/neighbours.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/hierarchy.ex`

**Module name:** `Geonames.Endpoints.Hierarchy`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 9 |
| `available_url_parameters` | 0 | 10 |
| `required_url_parameters` | 0 | 11 |
| `function_name` | 0 | 12 |
| `url_arguments` | 1 | 14 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None. (`@behaviour Geonames.Endpoint` declared at line 3.)

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{geonameId: nil}` (lines 5–7)

---

### File 2: `geonames-elixir/lib/geonames/endpoints/neighbourhood.ex`

**Module name:** `Geonames.Endpoints.Neighbourhood`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None. (`@behaviour Geonames.Endpoint` declared at line 3.)

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{lat: nil, lng: nil}` (lines 5–8)

---

### File 3: `geonames-elixir/lib/geonames/endpoints/neighbours.ex`

**Module name:** `Geonames.Endpoints.Neighbours`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None. (`@behaviour Geonames.Endpoint` declared at line 3.)

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{geonameId: nil, country: nil}` (lines 5–8)

---

## Checklist Review

All three files are thin behaviour-implementation modules for the vendored `geonames-elixir` library. Each module's sole runtime logic is `url_arguments/1`, which merges a caller-supplied map over a fixed default map using `Map.merge/2`. There are no HTTP calls, no database queries, no authentication logic, and no I/O in any of these files. The findings below reflect that narrow scope.

---

### §1: Secrets and Configuration

No config files, credentials, API keys, environment variable reads, or module attributes containing secret material are present in any of the three files.

§1: No issues found.

---

### §2: Authentication and Authorization

These modules contain no authentication or authorization logic. They are pure parameter-shaping helpers for an outbound HTTP library (geonames.org API). There are no plug pipelines, no Guardian calls, and no access-control decisions.

§2: No issues found.

---

### §3: Input Validation and Injection

**`url_arguments/1` in all three modules** accepts a caller-supplied map (`provided_arguments`) and merges it with the module's `@default_arguments` using `Map.merge/2`. No validation, no type coercion, and no allowlist enforcement is performed on the keys or values in `provided_arguments`.

Key observations per module:

- **Hierarchy** (`url_arguments/1`, line 14–16): merges arbitrary caller map over `%{geonameId: nil}`. The `:geonameId` value is passed directly to the GeoNames API URL by the library's HTTP layer. No range check, no integer coercion, no nil guard.
- **Neighbourhood** (`url_arguments/1`, line 15–17): merges arbitrary caller map over `%{lat: nil, lng: nil}`. Latitude and longitude values are passed as-is. No numeric range validation (lat must be −90..90, lng must be −180..180) is enforced here.
- **Neighbours** (`url_arguments/1`, line 15–17): merges arbitrary caller map over `%{geonameId: nil, country: nil}`. Additionally, `required_url_parameters/0` returns `[]` (line 12), meaning neither `geonameId` nor `country` is treated as required by this module's own contract, yet both are declared as `available_url_parameters`. The omission of any required parameter may cause silent failures or error responses from the upstream API.

No `String.to_atom/1` usage, no raw SQL, no `Code.eval_string`, and no `binary_to_term` are present.

**A036-1** — MEDIUM — `url_arguments/1` performs no input validation before forwarding caller-supplied values to the GeoNames API URL builder.

All three modules (`Hierarchy`, `Neighbourhood`, `Neighbours`) implement `url_arguments/1` by blindly merging the caller-supplied map with no key allowlisting, no type validation, and no value-range enforcement. Any unexpected key supplied by a caller will be forwarded as a URL query parameter to the upstream GeoNames API. For `Neighbourhood`, latitude and longitude are not range-checked (valid ranges: lat −90..90, lng −180..180); out-of-range or non-numeric values will produce a runtime error or a rejected upstream request whose error path must be handled by callers. Recommended: add an allowlist guard and type/range validation inside `url_arguments/1` or in the calling layer before parameters reach these modules.

Affected lines:
- `hierarchy.ex` line 14
- `neighbourhood.ex` line 15
- `neighbours.ex` line 15

**A036-2** — LOW — `Neighbours.required_url_parameters/0` returns an empty list despite both `:geonameId` and `:country` being listed as available parameters, creating an implicit contract mismatch.

`required_url_parameters/0` at line 12 of `neighbours.ex` returns `[]`. The GeoNames `neighboursJSON` endpoint requires either a `geonameId` or a `country` code to return any meaningful result; passing neither will produce an upstream API error. If the `Geonames.Endpoint` behaviour framework uses `required_url_parameters/0` to enforce presence before dispatching an HTTP call, this omission means no such enforcement occurs for this endpoint. Callers receive a runtime upstream error rather than a clear compile-time or changeset-level validation failure. Recommended: add at least one required parameter or document the at-least-one-of constraint explicitly and enforce it in the dispatch layer.

Affected line:
- `neighbours.ex` line 12

§3: 2 issues found (A036-1, A036-2).

---

### §4: Session and CSRF

These modules contain no session handling, no cookie configuration, no CSRF tokens, and no WebSocket/channel logic.

§4: No issues found.

---

### §5: File and Data Handling

No file I/O, no Logger calls, no PII handling, and no fleet/vehicle/driver data are present in any of the three files. These modules do not return HTTP responses to clients.

§5: No issues found.

---

### §6: Dependencies

These files are part of the vendored `geonames-elixir` library subtree. No `mix.exs` or `mix.lock` entries are contained within these individual source files. Dependency version auditing for this vendored library must be performed against the top-level `mix.lock` and `mix.exs` files, which are outside this agent's assigned scope.

§6: No issues found (in-scope files only).

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IP addresses, port numbers, CORS configuration, TLS settings, or inter-service call logic appear in any of the three files. The string literals `"hierarchyJSON"`, `"neighbourhoodJSON"`, and `"neighboursJSON"` are GeoNames API endpoint path fragments, not internal infrastructure identifiers.

§7: No issues found.

---

## Findings Summary

| ID | Severity | File | Line(s) | Summary |
|----|----------|------|---------|---------|
| A036-1 | MEDIUM | `hierarchy.ex`, `neighbourhood.ex`, `neighbours.ex` | 14, 15, 15 | `url_arguments/1` forwards caller-supplied map to upstream API with no key allowlisting, type coercion, or value-range validation |
| A036-2 | LOW | `neighbours.ex` | 12 | `required_url_parameters/0` returns `[]` despite both available parameters being effectively required for a meaningful API response; no enforcement prevents a no-parameter call |

---

## Notes

- All three modules are structurally identical thin wrappers implementing the `Geonames.Endpoint` behaviour. The only runtime logic in each is the `Map.merge/2` call in `url_arguments/1`.
- No secrets, no authentication, no direct I/O, no SQL, and no unsafe Elixir primitives (`String.to_atom/1`, `binary_to_term/1`, `Code.eval_string/1`) are present.
- The security posture of these modules depends heavily on what validation occurs in the calling layer (the `Geonames` dispatcher that ultimately passes URL parameters to an HTTP client). If callers validate before invoking these modules, A036-1 is mitigated at the call site. That calling-layer code is outside this agent's assigned files and should be reviewed separately.
