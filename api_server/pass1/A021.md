# Audit Report A021
**Agent:** A021
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Auditor model:** claude-sonnet-4-6

---

## Assigned Files

- `geonames-elixir/lib/geonames/endpoints/country_subdivision.ex`
- `geonames-elixir/lib/geonames/endpoints/earthquakes.ex`
- `geonames-elixir/lib/geonames/endpoints/find_nearby.ex`

Supporting context files read (not assigned but required to trace trust boundaries):
- `geonames-elixir/lib/geonames/endpoint.ex` (behaviour definition)
- `geonames-elixir/lib/geonames.ex` (public dispatch module)
- `geonames-elixir/lib/geonames/helpers.ex` (URL builder, credential resolution)
- `geonames-elixir/config/config.exs` (vendored library config)
- `geonames-elixir/mix.exs` and `mix.lock` (dependency graph)
- `config/config.exs` (parent project geonames config block, lines 138-140)
- `lib/api_server_web/controllers/utility_controller.ex` (caller, grepped for Geonames usage)

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/country_subdivision.ex`

**Module name:** `Geonames.Endpoints.CountrySubdivision`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `@behaviour Geonames.Endpoint` (line 3)

**Module-level attributes:**
- `@default_arguments` (line 5–10): `%{lat: nil, lng: nil, radius: nil, level: nil}`

---

### File 2: `geonames-elixir/lib/geonames/endpoints/earthquakes.ex`

**Module name:** `Geonames.Endpoints.Earthquakes`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 15 |
| `available_url_parameters` | 0 | 16 |
| `required_url_parameters` | 0 | 17 |
| `function_name` | 0 | 18 |
| `url_arguments` | 1 | 20 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `@behaviour Geonames.Endpoint` (line 3)

**Module-level attributes:**
- `@default_arguments` (lines 5–13): `%{north: nil, south: nil, east: nil, west: nil, date: nil, minMagnitude: nil, maxRows: 10}`

---

### File 3: `geonames-elixir/lib/geonames/endpoints/find_nearby.ex`

**Module name:** `Geonames.Endpoints.FindNearby`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 16 |
| `available_url_parameters` | 0 | 17 |
| `required_url_parameters` | 0 | 18 |
| `function_name` | 0 | 19 |
| `url_arguments` | 1 | 21 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `@behaviour Geonames.Endpoint` (line 3)

**Module-level attributes:**
- `@default_arguments` (lines 5–14): `%{lat: nil, lng: nil, featureClass: nil, featureCode: nil, radius: nil, maxRows: 10, style: "MEDIUM", localCountry: true}`

---

## Checklist Findings

### §1: Secrets and Configuration

**Finding A021-1 — MEDIUM: GeoNames API username hardcoded in vendored library config**

**File:** `geonames-elixir/config/config.exs`, lines 5–7
**Evidence:**
```elixir
config :geonames,
  username: "testuser",
  language: "es"
```

The vendored library's own `config/config.exs` contains a hardcoded GeoNames API username (`"testuser"`). Although this is a vendored `config/config.exs` that Mix does not load when used as a sub-dependency of the parent project (it is overridden by the parent project's config at `config/config.exs` lines 138–140), the value is committed to version control. The vendor config file carries a different hardcoded username than the parent project uses in production.

The parent project's `config/config.exs` (lines 138–140) sets:
```elixir
config :geonames,
  username: "vinxstudio",
  language: "en"
```

This `"vinxstudio"` username is also a hardcoded literal committed to a tracked config file rather than being sourced from an environment variable or secrets manager. The `Geonames.Helpers` module (line 53) does provide a fallback to `System.get_env("GEONAMES_USERNAME")` if the application env is nil, but the parent config assigns a literal value that pre-empts that fallback. A GeoNames API username is a credential granting access to a paid/rate-limited account; it should be stored in an environment variable or secrets manager and never committed to source.

**Recommendation:** Remove the literal username value from `config/config.exs`. Set `:username` to `nil` and rely exclusively on `System.get_env("GEONAMES_USERNAME")`, or inject via `runtime.exs` / deployment secrets.

---

**Finding A021-2 — INFO: Vendored library config uses `use Mix.Config` (deprecated API)**

**File:** `geonames-elixir/config/config.exs`, line 3
**Evidence:**
```elixir
use Mix.Config
```

`Mix.Config` was deprecated in Elixir 1.11 in favour of `Config`. This is a low-risk issue in a vendored library whose config is not loaded by the parent application, but it indicates the vendor library has not been updated.

---

### §2: Authentication and Authorization

The three assigned endpoint modules are pure data-definition modules implementing the `Geonames.Endpoint` behaviour. They define no routes, no plugs, no authentication logic, and no authorisation checks. They are called from `utility_controller.ex` in the parent application — authentication and authorisation at the controller level is out of scope for this report (not an assigned file), but is noted for completeness.

Within the assigned files themselves: §2: No issues found.

---

### §3: Input Validation and Injection

**Finding A021-3 — MEDIUM: `url_arguments/1` performs unrestricted map merge — caller-supplied keys outside the allowed parameter set are passed through to the URL**

**Files:**
- `geonames-elixir/lib/geonames/endpoints/country_subdivision.ex`, line 17–19
- `geonames-elixir/lib/geonames/endpoints/earthquakes.ex`, lines 20–22
- `geonames-elixir/lib/geonames/endpoints/find_nearby.ex`, lines 21–23

**Evidence (identical pattern in all three):**
```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`Map.merge/2` merges the caller-supplied map over the defaults without filtering. Any key present in `provided_arguments` that is not in `@default_arguments` will appear in the merged map. The merged map is then passed to `Geonames.Helpers.build_url_string/2` (in `helpers.ex`, lines 30–47), which iterates all key-value pairs and appends non-nil entries as `key=value` query string segments.

This means that if a caller passes extra keys (e.g. `%{lat: 1.0, lng: 2.0, username: "attacker"}`) those extra keys are appended to the outbound GeoNames API request URL. An attacker who controls the argument map (e.g. if arguments are derived from user-controlled HTTP parameters without strict filtering in the parent controller) could inject arbitrary GeoNames API parameters, including overriding the `username` parameter used for API authentication.

The practical severity depends on the trust boundary between HTTP input and the argument map at the call sites. The two observed call sites in `utility_controller.ex` pass hard-coded lat/lng values sourced from database records rather than raw user strings, which mitigates the risk at those specific sites. However, the library API itself provides no defence in depth — the absence of a whitelist in `url_arguments/1` means any future call site that passes user-controlled parameters is immediately vulnerable.

Additionally, `Geonames.Helpers.build_url_string/2` uses `URI.encode/1` (line 45 of helpers.ex), which percent-encodes the entire query string as a single string rather than encoding individual parameter values. This is semantically incorrect: `URI.encode` does not encode `&` or `=` characters (they are unreserved in the full URI context), so a value containing `&foo=bar` embedded in a parameter value would not be escaped and would be interpreted as an additional query parameter by the GeoNames server. This is a URL injection / parameter pollution vector.

**Recommendation:** In each endpoint's `url_arguments/1`, filter `provided_arguments` to only keys in `available_url_parameters` before merging. In `helpers.ex`, replace the manual string-building and `URI.encode/1` with `URI.encode_query/1` which correctly percent-encodes individual key and value components.

---

**Finding A021-4 — LOW: No type validation of latitude/longitude values before URL construction**

**Files:**
- `geonames-elixir/lib/geonames/endpoints/country_subdivision.ex` (required: `lat`, `lng`)
- `geonames-elixir/lib/geonames/endpoints/earthquakes.ex` (required: `north`, `south`, `east`, `west`)
- `geonames-elixir/lib/geonames/endpoints/find_nearby.ex` (required: `lat`, `lng`)

The `required_parameters_provided?` check in `Geonames.Helpers` (helpers.ex line 14) only verifies that the required keys are non-nil; it performs no type validation (e.g. that lat/lng values are floats in valid WGS-84 ranges, or that bounding-box coordinates are numerically coherent). A string value of arbitrary content passes the check and is appended to the URL. The URL builder in `helpers.ex` only handles `is_binary`, `is_float`, `is_boolean`, `is_integer`, and `is_list` guards; a value of an unexpected type (e.g. a PID, a struct) would cause the anonymous function to raise a `FunctionClauseError` rather than returning an error tuple, which may surface as an unhandled exception.

---

### §4: Session and CSRF

The three assigned files are endpoint definition modules with no session, cookie, or CSRF-related code. They do not implement any HTTP handlers.

§4: No issues found.

---

### §5: File and Data Handling

**Finding A021-5 — INFO: GeoNames API response is decoded with `Poison.decode!/1` (raises on malformed JSON)**

**File:** `geonames-elixir/lib/geonames.ex`, line 133
**Evidence:**
```elixir
{ :ok, Poison.decode!(body) }
```

`Poison.decode!/1` raises a `Poison.ParseError` if the GeoNames API returns a non-JSON body (e.g. an HTML error page, a plain-text rate-limit message, or a network interception response). The calling code in `Geonames` wraps the HTTPoison call but does not wrap this decode step in a rescue block. The `raise RuntimeError` path only covers HTTP-level errors; a malformed body from the upstream API will propagate an unhandled exception into the controller.

The three assigned endpoint modules do not directly handle this path; the issue is in the dispatch layer that uses them. Noted here because it affects the security-relevant behaviour (error handling / information disclosure) of all three assigned endpoint types.

---

**Finding A021-6 — INFO: No logging of outbound GeoNames requests or error responses**

The library makes no `Logger` calls. Absence of logging means failed or anomalous GeoNames API calls (e.g. repeated `401 Unauthorized` that might indicate credential theft, or unexpected `429 Too Many Requests`) are not recorded for audit purposes. This is an operational security observation.

---

### §6: Dependencies

**Finding A021-7 — HIGH: Severely outdated dependency versions with no security support**

**File:** `geonames-elixir/mix.lock`

The vendored library's lock file pins the following versions:

| Package | Locked version | Status |
|---|---|---|
| `httpoison` | 1.3.0 (2018) | Unsupported; current is 2.x |
| `hackney` | 1.13.0 (2018) | Outdated; current is 1.20.x |
| `poison` | 3.1.0 (2017) | Outdated; current is 5.x |
| `certifi` | 2.3.1 (2018) | Outdated; current is 2.12.x |
| `ssl_verify_fun` | 1.1.1 (2017) | Outdated |

`hackney` 1.13.0 is notably old and predates multiple TLS and connection handling fixes. `certifi` 2.3.1 contains a CA bundle from 2018; the parent project has already had to patch TLS issues (see commit `e486dd8`: "Fix Rayven TLS 'Unknown CA' error after Sectigo Root R46 cert renewal"), indicating that stale CA bundles are a real operational problem in this codebase. Relying on `certifi` 2.3.1 within the vendored Geonames library means outbound requests to `api.geonames.org` may fail certificate validation if the Geonames.org TLS chain is updated to use a newer root CA.

`httpoison` 1.3.0 and `hackney` 1.13.0 are not known to have specific published CVEs, but their age means they have not received security patches from the past six years. The `mix.exs` specifies `{:httpoison, "~> 1.0"}` and `{:poison, "~> 3.1"}` which use approximate version constraints; the `mix.lock` snapshot may diverge from what would be installed on a clean `mix deps.get` on a new host if these packages have been yanked or updated.

**Note:** Because this is a vendored directory (not fetched from hex.pm by the parent project's `mix.lock`), the parent project's own `mix audit` will not surface these issues automatically.

---

**Finding A021-8 — INFO: Vendored library's `mix.exs` pinned to `elixir: "~> 1.2"`**

**File:** `geonames-elixir/mix.exs`, line 6

The library requires only Elixir ~> 1.2, which was released in 2015. This is not a vulnerability in itself, but combined with all the other staleness indicators it confirms this vendored copy of geonames-elixir has not been maintained. The library should be either replaced with a current hex.pm dependency or the vendored copy should be updated.

---

### §7: Infrastructure Exposure

**Finding A021-9 — LOW: Base URL for GeoNames API is plain HTTP (no scheme specified) and hardcoded in library source**

**File:** `geonames-elixir/lib/geonames/helpers.ex`, line 8
**Evidence:**
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default base URL `"api.geonames.org/"` has no URL scheme. In `build_url_string/2` (helpers.ex line 47) it is concatenated directly:
```elixir
@base_url <> endpoint <> "?" <> encoded_params
```

The resulting string is passed directly to `HTTPoison.get/1`. When no scheme is present, HTTPoison/hackney will attempt to parse the URL and will either raise, treat it as a relative URL, or default to HTTP depending on the hackney version. The `config/config.exs` in the parent project does not override `:base_url`, so the default is used.

If hackney resolves this as `http://api.geonames.org/...`, then the GeoNames API username (a credential) is transmitted in plaintext over HTTP, exposing it to network interception. The GeoNames.org API does support HTTPS (`https://secure.geonames.org/`); the library should enforce HTTPS.

**Recommendation:** Set `@base_url` default to `"https://secure.geonames.org/"` and document that `:base_url` overrides in config must also use HTTPS.

---

## Summary Table

| ID | Severity | Section | Title |
|---|---|---|---|
| A021-1 | MEDIUM | §1 | GeoNames API username hardcoded in tracked config files |
| A021-2 | INFO | §1 | Vendored library uses deprecated `use Mix.Config` |
| A021-3 | MEDIUM | §3 | Unrestricted map merge in `url_arguments/1` enables parameter injection / username override |
| A021-4 | LOW | §3 | No type or range validation of coordinate parameters |
| A021-5 | INFO | §5 | `Poison.decode!/1` raises on malformed upstream response; unhandled exception path |
| A021-6 | INFO | §5 | No logging of outbound GeoNames requests or errors |
| A021-7 | HIGH | §6 | Vendored dependency lock pins severely outdated packages including stale CA bundle |
| A021-8 | INFO | §6 | Vendored library `mix.exs` requires Elixir ~> 1.2 (2015); unmaintained library |
| A021-9 | LOW | §7 | Default GeoNames base URL lacks HTTPS scheme; credentials potentially sent over HTTP |
