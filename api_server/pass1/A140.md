# Audit Report A140
**Run:** 2026-02-27-01
**Agent:** A140
**Scope:** api_server — Elixir/Phoenix — branch: master
**Pass:** 1

---

## Assigned Files

1. `lib/api_server_web/views/vx_thing_summary_view.ex`
2. `lib/api_server_web/views/vx_thing_view.ex`
3. `lib/api_server_web/views/vx_user_function_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_thing_summary_view.ex`

**Module name:** `ApiServerWeb.VXThingSummaryView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 (`"index.json"`, `%{vxthingsummaries: ...}`) | 5 |
| `render` | 2 (`"show.json"`, `%{vx_thing_summary: ...}`) | 9 |
| `render` | 2 (`"vx_thing_summary.json"`, `%{vx_thing_summary: ...}`) | 13 |
| `render` | 2 (`"rhm_thing_summary.json"`, `%{vx_thing_summary: ...}`) | 57 |

**defstruct / defexception / schema:** None defined.

**use / import / alias:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXThingSummaryView` (line 3)

---

### File 2: `lib/api_server_web/views/vx_thing_view.ex`

**Module name:** `ApiServerWeb.VXThingView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 (`"index.json"`, `%{vxthings: ...}`) | 8 |
| `render` | 2 (`"show.json"`, `%{vx_thing: ...}`) | 12 |
| `render` | 2 (`"fleet_map.json"`, `%{vxthings: ...}`) | 16 |
| `render` | 2 (`"fleet_map.json"`, `%{vx_thing: thing}`) | 20 |
| `render` | 2 (`"hardware_with_checklists.json"`, `%{vx_things: ...}`) | 105 |
| `render` | 2 (`"pm_data.json"`, `%{vx_things: ...}`) | 109 |
| `render` | 2 (`"pm_data.json"`, `%{vx_thing: ...}`) | 113 |
| `render` | 2 (`"movements.json"`, `%{movements: ...}`) | 147 |
| `render` | 2 (`"movement.json"`, `%{vx_thing: movement}`) | 150 |
| `render` | 2 (`"checklists.json"`, `%{checklists: ...}`) | 164 |
| `render` | 2 (`"vx_checklist.json"`, `%{vx_thing: checklist}`) | 168 |
| `render` | 2 (`"vx_thing.json"`, `%{vx_thing: ...}`) | 176 |
| `render` | 2 (`"rhm_thing_usage.json"`, `%{usage: ...}`) | 220 |
| `render` | 2 (`"rhm_thing_usage_manual.json"`, `%{usage: ..., hardwareid: ..., customer: ...}`) | 224 |
| `render` | 2 (`"usage_report.json"`, `%{vx_thing: [...]}`) | 228 |
| `render` | 2 (`"usage_report_many.json"`, `%{vx_thing: [...], hardwareid: ..., customer: ...}`) | 265 |
| `render` | 2 (`"rhm_things_usage.json"`, `%{usage_by_hardwareid: ...}`) | 292 |
| `render` | 2 (`"rhm_thing_events.json"`, `%{events: ...}`) | 315 |
| `render` | 2 (`"event_report.json"`, `%{vx_thing: event}`) | 318 |
| `render` | 2 (`"rhm_thing.json"`, `%{vx_things: ...}`) | 351 |
| `render` | 2 (`"rhm_thing.json"`, `%{vx_thing: {vx_thing, usage_data}}`) | 354 |
| `render` | 2 (`"basic_thing.json"`, `%{vx_thing: nil}`) | 359 |
| `render` | 2 (`"basic_thing.json"`, `%{vx_thing: ...}`) | 360 |
| `render` | 2 (`"sielift_wip_export.json"`, `%{vx_thing: ...}`) | 396 |
| `render` | 2 (`"pape_exports.json"`, `%{vx_thing: ...}`) | 434 |
| `render` | 2 (`"pape_export.json"`, `%{vx_thing: [...]}`) | 437 |
| `render` | 2 (`"rhm_things_names.json"`, `%{vx_things: ...}`) | 449 |
| `render` | 2 (`"things_only.json"`, `%{thing_records: ...}`) | 453 |
| `info_to_map` | 1 | 487 |
| `thing_to_map` | 2 | 499 |

**defstruct / defexception / schema:** None defined.

**use / import / alias:**
- `use ApiServerWeb, :view` (line 2)
- `use Timex` (line 3)
- `alias ApiServerWeb.VXThingView` (line 4)
- `alias ApiServerWeb.VXThingSummaryView` (line 5)

---

### File 3: `lib/api_server_web/views/vx_user_function_view.ex`

**Module name:** `ApiServerWeb.VXUserFunctionView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 (`"index.json"`, `%{vxaatuserfunctions: ...}`) | 5 |
| `render` | 2 (`"show.json"`, `%{vx_user_function: ...}`) | 9 |
| `render` | 2 (`"vx_user_function.json"`, `%{vx_user_function: ...}`) | 13 |

**defstruct / defexception / schema:** None defined.

**use / import / alias:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXUserFunctionView` (line 3)

---

## Checklist Review

### §1: Secrets and Configuration

No config files, hardcoded credentials, API keys, secret key bases, pipeline variables, or AWS infrastructure references appear in any of the three view files.

§1: No issues found.

---

### §2: Authentication and Authorization

**Context established from controller review (`vx_thing_controller.ex`):** Most controller actions that feed these views correctly extract `customer` and `user_id` from Guardian JWT claims (e.g. `ApiServer.Guardian.Plug.current_claims(conn)["customer"]`) before passing data to the views. The views themselves are pure serialisation layers that receive pre-fetched structs and maps.

However, two concerns are raised at the view layer:

**A140-1 — MEDIUM — VXThingView: `vx_thing.json` exposes `aadimei` (IMEI) and internal IDs to API consumers**

`render("vx_thing.json", ...)` at line 176–218 of `vx_thing_view.ex` serialises `aadimei` (device IMEI number), `aadmobile` (mobile/SIM number), and `aadcustomerid` to the JSON response unconditionally. IMEI and SIM numbers are sensitive device identifiers that could aid device cloning or social-engineering attacks against mobile carriers. Their inclusion in a general-purpose API response (used for the full `show.json` and `index.json` responses) should be reviewed. If these are not required by clients, they should be removed from the serialised output.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 188–189 (`aadimei`, `aadmobile`).

**A140-2 — MEDIUM — VXThingView: `fleet_map.json` exposes full GPS coordinates, heading, speed, and driver identifiers in a single response**

`render("fleet_map.json", %{vx_thing: thing})` at lines 20–103 serialises `vlat`, `vlong`, `vign`, `vhd`, `vsp`, GPS coordinates, the driver ID (`abmdriverid`/`operator`), and the full `usage` struct for every vehicle in a fleet. If the route serving this template is not scoped to the authenticated user's organisation (or if the `customer` parameter can be arbitrarily supplied by the caller), this response constitutes a complete fleet position and operator disclosure across customer boundaries. This is a data-isolation concern rather than a purely view-layer defect, but the view does not perform any filtering.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 38–99.

§2: Two issues raised (A140-1, A140-2).

---

### §3: Input Validation and Injection

No user-controlled input is interpolated into Ecto queries or shell commands in these view files. The view modules do not call `String.to_atom/1`, `:erlang.binary_to_term/1`, `Code.eval_string/1`, or `Kernel.apply/3`.

**A140-3 — MEDIUM — VXThingView: Non-exhaustive `case` on `category` integer — no catch-all clause**

`render("usage_report.json", ...)` at lines 228–263 and `render("usage_report_many.json", ...)` at lines 265–290 both contain:

```elixir
days_usage = case category do
  2 -> daily_usage_input0
  3 -> daily_usage_input1
  4 -> daily_usage_input2
  5 -> daily_usage_input3
  6 -> daily_usage_input4
end
```

No `_` (catch-all) clause is present. If `category` takes any value other than 2–6 (for example, if a device reports category 1, 7, or any unexpected integer), the `case` will raise a `CaseClauseError` at runtime, causing an unhandled exception in the view and potentially a 500 response. Although `category` originates from a database value rather than direct user input, the absence of a default makes this a robustness and potential information-disclosure risk (unhandled exceptions may leak stack traces depending on error handler configuration). The same pattern is duplicated in both render clauses.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 234–245 and 270–281.

§3: One issue raised (A140-3).

---

### §4: Session and CSRF

View modules do not configure sessions, CSRF tokens, WebSocket channels, or cookie parameters. Not applicable to these files.

§4: No issues found.

---

### §5: File and Data Handling

**A140-4 — HIGH — VXThingSummaryView and VXThingView: GPS coordinates, driver IDs, and operator identifiers exposed in multiple JSON templates**

The following templates serialise real-time GPS position data (latitude, longitude, heading, speed) along with driver/operator identifiers to API responses:

- `vx_thing_summary_view.ex`: `render("vx_thing_summary.json", ...)` lines 13–54 — exposes `abmlatitude`, `abmlongitude`, `abmheading`, `abmspeed`, `abmdriverid`, `abmmifaredriverid`, `abmcustcode`.
- `vx_thing_summary_view.ex`: `render("rhm_thing_summary.json", ...)` lines 57–122 — exposes the same GPS fields plus a dedicated `gps` sub-object and `current_operator` sub-object containing `driver_id` and `mifare_driver_id`.
- `vx_thing_view.ex`: `render("fleet_map.json", ...)` lines 20–103 — `vlat`, `vlong`, `vhd`, `vsp` for every vehicle in the fleet map response.
- `vx_thing_view.ex`: `render("movement.json", ...)` lines 150–162 — `latitude`, `longitude`, `speed`, `operator` (driver ID).
- `vx_thing_view.ex`: `render("event_report.json", ...)` lines 318–349 — `location.latitude`, `location.longitude`, `operator` (driver ID).

Per checklist §5, api_server is a fleet management backend. Any endpoint returning vehicle locations, driver records, or customer assets must be scoped to the authenticated user's organisation. The view layer itself cannot enforce this scoping — it blindly serialises whatever data it receives. The risk is that if the controller layer fails to enforce customer/organisation scoping (see A140-2 regarding the `customer` parameter being supplied by the caller in some `fleet_map` routes), these views will expose cross-customer GPS and PII data without any view-layer guard.

Additionally, `abmmifaredriverid` (a physical RFID/Mifare card ID) is serialised by both `vx_thing_summary.json` and `rhm_thing_summary.json`. This is a physical access credential identifier. Its inclusion in API responses should be reviewed to confirm it is necessary for the consuming client and that it is not being exposed to unauthorised roles.

- Files: `lib/api_server_web/views/vx_thing_summary_view.ex` (lines 43–44, 65–67) and `lib/api_server_web/views/vx_thing_view.ex` (lines 44–46, 160, 341).

**A140-5 — LOW — VXThingView: Commented-out `IO.puts` debug statements include hardware IDs and usage data in source**

`thing_to_map/2` at lines 507–531 of `vx_thing_view.ex` contains a large commented-out block with multiple `IO.puts` statements that would log hardware IDs, time-remaining values, and daily usage figures to stdout if uncommented. While currently inactive, their presence represents a maintenance risk: if any developer uncomments this block during debugging, sensitive fleet operational data would be written to application logs. Commented-out debug logging that includes PII or sensitive operational data should be removed.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 519–529.

**A140-6 — LOW — VXThingView: `pm_data.json` hardcodes placeholder values in live response**

`render("pm_data.json", %{vx_thing: vx_thing})` at lines 113–145 includes the following hardcoded stub values in the serialised JSON response:

```elixir
previousweek: 0.1,
thisweek: 0.2,
avgperweek: 0.2,
mtdraw: 0.3,
weekstoservice: 0.4
```

These are clearly placeholder/stub values that were never replaced with real computed values. Clients consuming this endpoint will receive fabricated data, which could lead to incorrect preventive-maintenance decisions. This is not a security vulnerability, but it is a data-integrity issue that warrants a finding.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 138–142.

§5: Three issues raised (A140-4, A140-5, A140-6).

---

### §6: Dependencies

View files do not declare dependencies. `mix.exs` and `mix.lock` are not in scope for this file assignment.

§6: No issues found.

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IP addresses, port numbers, CORS configuration, TLS settings, or inter-service authentication logic appear in these view files.

§7: No issues found.

---

## Summary of Findings

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A140-1 | MEDIUM | `vx_thing_view.ex` | `vx_thing.json` serialises IMEI (`aadimei`) and SIM (`aadmobile`) to all API consumers |
| A140-2 | MEDIUM | `vx_thing_view.ex` | `fleet_map.json` serialises full GPS + driver identity for entire fleet; relies solely on controller-layer scoping |
| A140-3 | MEDIUM | `vx_thing_view.ex` | Non-exhaustive `case` on `category` in `usage_report.json` and `usage_report_many.json` — no catch-all, will raise `CaseClauseError` on unexpected values |
| A140-4 | HIGH | `vx_thing_summary_view.ex`, `vx_thing_view.ex` | Multiple templates expose GPS coordinates, driver IDs, and Mifare card IDs with no view-layer scoping guard |
| A140-5 | LOW | `vx_thing_view.ex` | Commented-out `IO.puts` debug block in `thing_to_map/2` would log hardware IDs and operational data if re-enabled |
| A140-6 | LOW | `vx_thing_view.ex` | `pm_data.json` hardcodes placeholder numeric values (`0.1`, `0.2`, `0.3`, `0.4`) for five fields instead of real computed data |
