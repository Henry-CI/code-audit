# Audit Report A033
**Agent:** A033
**Run:** 2026-02-27-01
**Repository:** api_server
**Stack:** Elixir/Phoenix (vendored geonames-elixir library)
**Branch:** master
**Auditor model:** claude-sonnet-4-6

---

## Assigned Files

1. `geonames-elixir/lib/geonames/endpoints/find_nearest_intersection_osm.ex`
2. `geonames-elixir/lib/geonames/endpoints/get.ex`
3. `geonames-elixir/lib/geonames/endpoints/gtopo30.ex`

Supporting files read for full context (not assigned, but required to evaluate data flow):
- `geonames-elixir/lib/geonames/endpoint.ex` (behaviour definition)
- `geonames-elixir/lib/geonames/helpers.ex` (URL builder and username resolution)
- `geonames-elixir/lib/geonames.ex` (macro-generated public API and HTTP dispatch)
- `geonames-elixir/mix.exs` (dependency declarations)
- `geonames-elixir/mix.lock` (pinned dependency hashes)

---

## Reading Evidence

### File 1 — `geonames-elixir/lib/geonames/endpoints/find_nearest_intersection_osm.ex`

**Module name:** `Geonames.Endpoints.FindNearestIntersectionOSM`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attributes:**
```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  radius: nil,
  maxRows: nil
}
```

**Behaviour:** `@behaviour Geonames.Endpoint`

---

### File 2 — `geonames-elixir/lib/geonames/endpoints/get.ex`

**Module name:** `Geonames.Endpoints.Get`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attributes:**
```elixir
@default_arguments %{
  geonameId: nil,
  style: nil
}
```

**Behaviour:** `@behaviour Geonames.Endpoint`

---

### File 3 — `geonames-elixir/lib/geonames/endpoints/gtopo30.ex`

**Module name:** `Geonames.Endpoints.GTOPO30`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attributes:**
```elixir
@default_arguments %{
  lat: nil,
  lng: nil
}
```

**Behaviour:** `@behaviour Geonames.Endpoint`

---

## Checklist Review

The three assigned modules are pure endpoint-descriptor modules. They contain no HTTP logic, no config resolution, no authentication, and no direct I/O. All security-relevant behaviour flows through `Geonames.Helpers` and `Geonames` (the macro-generated dispatcher), which were read as supporting context to reach accurate conclusions on the data-flow findings below.

---

### §1: Secrets and Configuration

No hardcoded credentials, API keys, database passwords, or secret key bases are present in any of the three assigned files.

The `@default_arguments` maps contain only parameter-shape definitions (atoms mapped to `nil`); no credential values appear.

The GeoNames `username` credential is resolved in `Geonames.Helpers.user_configuration/0` (supporting file) via `Application.get_env(:geonames, :username)` with a `System.get_env("GEONAMES_USERNAME")` fallback. This is outside the assigned files but is relevant context: no hardcoded username value was observed.

**§1: No issues found in assigned files.**

---

### §2: Authentication and Authorization

These modules are endpoint-descriptor wrappers for an outbound third-party API (geonames.org). They are not Phoenix controllers, do not implement authentication logic, and do not handle inbound requests from end users. There are no plug pipelines, Guardian tokens, or session management present.

**§2: No issues found in assigned files.**

---

### §3: Input Validation and Injection

**Finding A033-1 is raised below (MEDIUM).**

The `url_arguments/1` function in all three modules performs a `Map.merge(@default_arguments, provided_arguments)` without any validation or sanitisation of the caller-supplied map:

```elixir
# find_nearest_intersection_osm.ex line 17-19
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

The merged result is passed directly to `Geonames.Helpers.build_url_string/2`, which encodes values into a URL query string using string interpolation (`"#{k}=#{v}"`), before passing the entire string to `URI.encode/1`:

```elixir
# helpers.ex line 34-44 (supporting context)
|> Enum.map(fn
  {_,nil}                    -> nil
  {k,v} when is_binary(v)    -> "#{k}=#{v}"
  {k,v} when is_float(v)     -> "#{k}=#{v}"
  {k,v} when is_boolean(v)   -> "#{k}=#{v}"
  {k,v} when is_integer(v)   -> "#{k}=#{v}"
  {k,arr} when is_list(arr)  -> Enum.map(arr, &"#{k}=#{&1}")
end)
|> ...
|> Enum.join("&")
|> URI.encode
```

No type coercion, range checking, or allowlist validation is applied to individual parameter values in any of the three endpoint modules before they reach the URL builder. There is no validation that:

- `lat`/`lng` are numeric and within valid geographic ranges (-90..90, -180..180).
- `maxRows` is a positive integer within a sane bound.
- `geonameId` is a non-negative integer.
- `radius` is a positive numeric value.
- Caller-supplied keys beyond the known `@default_arguments` keys are rejected (extra keys propagate through `Map.merge` because the caller's map is the right-hand operand and will overwrite defaults, but in practice only keys already in `@default_arguments` can appear since `Map.merge` preserves unknown keys from both sides — however unknown keys in `provided_arguments` will also be included in the merged result and thus serialised into the URL).

The `URI.encode/1` call provides percent-encoding at the byte level but does not strip control characters or validate that values are semantically correct for each parameter.

**Practical impact:** Because these modules wrap an outbound call to `api.geonames.org` (a third-party service not operated by CIG), the primary risk is SSRF-adjacent parameter injection — a caller could supply crafted `lat`/`lng` string values containing `&username=attacker` or similar query-string injection fragments. `URI.encode` will encode the `&` to `%26`, which mitigates naive query-string injection for most values, but it does not validate that string-typed values are actually numeric where numeric is expected.

**No `String.to_atom/1`** from user input, **no `Code.eval_string/1`**, and **no `binary_to_term/1`** are present in the assigned files.

---

### §4: Session and CSRF

Not applicable. These modules contain no Phoenix endpoint, router, channel, or session logic.

**§4: No issues found in assigned files.**

---

### §5: File and Data Handling

No file I/O, no Logger calls, no PII handling, and no error view rendering are present in the assigned files.

`Geonames.perform_geonames_request/1` (supporting context, `geonames.ex` line 130-141) returns raw parsed JSON from geonames.org directly to the caller without filtering. Geographic coordinate data (lat/lng) passed into these endpoint modules originates from the application and potentially from vehicle/asset records. The endpoint modules themselves do not log this data.

**§5: No issues found in assigned files.**

---

### §6: Dependencies

The assigned files themselves declare no dependencies. The supporting `mix.exs` and `mix.lock` were read to assess the vendored library's dependency tree.

**Finding A033-2 is raised below (MEDIUM).**

`mix.exs` pins dependencies with approximate version operators (`~>`), which is normal Elixir practice. `mix.lock` pins exact versions for reproducible builds, which is correct. However, the locked versions are substantially outdated:

| Package | Locked version | Notes |
|---------|---------------|-------|
| `httpoison` | 1.3.0 (2018) | Current release is 2.x; 1.3.0 is multiple major versions behind |
| `hackney` | 1.13.0 (2018) | Transitive dep of httpoison; multiple versions behind |
| `poison` | 3.1.0 (2017) | Current is 6.x; 3.1.0 is significantly outdated |
| `certifi` | 2.3.1 (2018) | CA bundle is stale; current is 2.12.x |
| `ssl_verify_fun` | 1.1.1 | Current is 1.1.7 |

**Finding A033-3 is raised below (LOW).**

The `elixir: "~> 1.2"` constraint in `mix.exs` accepts Elixir 1.2 or higher. Elixir 1.2 was released in January 2016 and has been end-of-life for many years. This is a floor constraint, not an enforcement of a modern version, but it signals the library has not been maintained to track current Elixir releases.

No `git:` source specifications are present in `mix.exs`; all dependencies are fetched from hex.pm. No Mariaex dependency is present.

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IPs, or port numbers are present in the assigned endpoint files.

The base URL for the geonames.org API is defined in `Geonames.Helpers` as a compile-time module attribute:

```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

This is a public third-party API hostname and is not a CIG internal infrastructure endpoint; no exposure issue arises from this specific value.

No TLS configuration, CORS configuration, Content Security Policy, or inter-service authentication logic is present in the assigned files or in the supporting library code.

**§7: No issues found in assigned files.**

---

## Findings Summary

### A033-1 — No input validation on URL parameters before outbound API call
**Severity:** MEDIUM
**Files:**
- `geonames-elixir/lib/geonames/endpoints/find_nearest_intersection_osm.ex` — `url_arguments/1` (line 17)
- `geonames-elixir/lib/geonames/endpoints/get.ex` — `url_arguments/1` (line 15)
- `geonames-elixir/lib/geonames/endpoints/gtopo30.ex` — `url_arguments/1` (line 15)

**Description:**
All three endpoint modules implement `url_arguments/1` as a plain `Map.merge(@default_arguments, provided_arguments)` with no type checking, range validation, or allowlisting of keys. The merged map is passed directly to `Geonames.Helpers.build_url_string/2` which interpolates values into a query string and applies only `URI.encode/1`. Callers can supply arbitrary keys (they will be included in the outbound URL) and non-numeric string values for parameters that the geonames.org API expects to be numeric (e.g. `lat`, `lng`, `maxRows`, `geonameId`).

**Risk:**
If any of these functions are called with data that has originated from user-controlled input (e.g. a driver or device supplying their own coordinates through the fleet API), crafted string values could produce malformed requests or, in edge cases, inject additional query parameters if `URI.encode` fails to encode a separator character in a specific runtime condition.

**Recommendation:**
Add parameter-level validation in each `url_arguments/1` implementation to assert that numeric parameters (`lat`, `lng`, `radius`, `maxRows`, `geonameId`) are of the expected Elixir type before merging. Reject unknown keys from `provided_arguments` rather than passing them through. Consider using a thin changeset or guard-clause pattern.

---

### A033-2 — Severely outdated transitive dependencies (httpoison, hackney, poison, certifi)
**Severity:** MEDIUM
**File:** `geonames-elixir/mix.lock`

**Description:**
The vendored library's locked dependency set is approximately 6-7 years old as of the audit date. Specifically:
- `httpoison 1.3.0` and `hackney 1.13.0` are the HTTP client stack; multiple security-relevant releases have been issued since 2018 in both packages.
- `certifi 2.3.1` contains a CA bundle from 2018. An outdated CA bundle increases the risk that outbound TLS connections to geonames.org (or any service) may fail to validate certificates issued under newer CAs, or conversely may trust certificates from CAs that have since been distrusted.
- `poison 3.1.0` is the JSON decoder; it is used with `Poison.decode!/1` on the raw HTTP response body. Versions since 3.1.0 have addressed edge-case denial-of-service behaviours on malformed input.

**Risk:**
Stale CA bundle (`certifi`) is the most directly exploitable item: if geonames.org rotates to a certificate signed by a CA not in the 2018 bundle, outbound TLS verification could fail in a way that causes the application to either error or — depending on hackney TLS configuration — silently proceed without full verification. The outdated HTTP client stack may also carry unpatched vulnerabilities.

**Recommendation:**
Update `mix.lock` by running `mix deps.update --all` within the `geonames-elixir` vendored directory and review the updated transitive dependency set. At minimum, `certifi`, `hackney`, and `httpoison` should be brought to current releases. If the library is vendored and not independently maintained, the parent `api_server` application's own `mix.lock` should verify it is not also locked to these old transitive versions.

---

### A033-3 — Minimum Elixir version floor is end-of-life (1.2)
**Severity:** LOW
**File:** `geonames-elixir/mix.exs` line 6

**Description:**
```elixir
elixir: "~> 1.2"
```
The `~> 1.2` constraint permits the library to compile against Elixir 1.2, which reached end-of-life in 2016. This is a floor constraint only; it does not enforce that a modern Elixir version is used. However, it signals the library has not been updated to declare a minimum supported version aligned with currently maintained Elixir releases, and may mask compatibility assumptions that break on newer versions.

**Risk:**
Low direct security risk. The risk is primarily one of maintenance hygiene: if the constraint is not updated, future Elixir upgrades in the parent application could silently run this library under an untested version.

**Recommendation:**
Update the constraint to reflect the minimum Elixir version actually in use by the parent `api_server` application (at least `~> 1.12` or higher).

---

## Checklist Section Results

| Section | Result |
|---------|--------|
| §1 Secrets and Configuration | No issues found. |
| §2 Authentication and Authorization | No issues found. |
| §3 Input Validation and Injection | A033-1 raised (MEDIUM) |
| §4 Session and CSRF | No issues found. |
| §5 File and Data Handling | No issues found. |
| §6 Dependencies | A033-2 raised (MEDIUM), A033-3 raised (LOW) |
| §7 Infrastructure Exposure | No issues found. |

---

*End of report A033.*
