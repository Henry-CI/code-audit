# Audit Report: A039
**Agent:** A039
**Run:** 2026-02-27-01
**Pass:** 1
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

**Assigned files (vendored geonames-elixir endpoint modules):**
- `geonames-elixir/lib/geonames/endpoints/oceans.ex`
- `geonames-elixir/lib/geonames/endpoints/postal_code_country_info.ex`
- `geonames-elixir/lib/geonames/endpoints/postal_code_lookup.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/oceans.ex`

**Module name:** `Geonames.Endpoints.Ocean`

**Public functions (def):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 11 |
| `available_url_parameters/0` | 0 | 12 |
| `required_url_parameters/0` | 0 | 13 |
| `function_name/0` | 0 | 14 |
| `url_arguments/1` | 1 | 16 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{lat: nil, lng: nil, radius: nil}` (line 5–9)

---

### File 2: `geonames-elixir/lib/geonames/endpoints/postal_code_country_info.ex`

**Module name:** `Geonames.Endpoints.PostalCodeCountryInfo`

**Public functions (def):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 8 |
| `available_url_parameters/0` | 0 | 9 |
| `required_url_parameters/0` | 0 | 10 |
| `function_name/0` | 0 | 11 |
| `url_arguments/1` | 1 | 13 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{}` (line 5–6)

---

### File 3: `geonames-elixir/lib/geonames/endpoints/postal_code_lookup.ex`

**Module name:** `Geonames.Endpoints.PostalCodeLookup`

**Public functions (def):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 11 |
| `available_url_parameters/0` | 0 | 12 |
| `required_url_parameters/0` | 0 | 13 |
| `function_name/0` | 0 | 14 |
| `url_arguments/1` | 1 | 16 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{postalcode: nil, country: nil, maxRows: 20}` (line 5–9)

---

## Checklist Review

### §1: Secrets and Configuration

No config files, credentials, API keys, environment variable references, hardcoded AWS endpoints, or secret material of any kind are present in these three files.

§1: No issues found.

---

### §2: Authentication and Authorization

These modules are pure data-configuration modules implementing the `Geonames.Endpoint` behaviour. They contain no route definitions, plug pipelines, Guardian configuration, password handling, or authorization logic. They define parameter shapes for outbound GeoNames API calls — authentication and authorization decisions are made at a higher layer not present in these files.

§2: No issues found.

---

### §3: Input Validation and Injection

The `url_arguments/1` function in all three modules merges a caller-supplied map into a module-level default map using `Map.merge/2`. No SQL queries, Ecto fragments, raw SQL, atom creation from user input (`String.to_atom/1`), unsafe deserialization (`:erlang.binary_to_term/1`), `Code.eval_string/1`, or `Kernel.apply/3` are present.

However, two observations are raised:

**A039-1** (LOW) — `url_arguments/1` performs no validation of the keys or values in `provided_arguments` before merging them into the parameter map that is ultimately forwarded to the GeoNames external HTTP API. If a caller passes unexpected keys (e.g., `username`, `token`, or other GeoNames API parameters), those keys will be silently included in the outbound URL query string. There is no whitelist enforcement at this layer. While the immediate risk is low because these modules do not themselves make HTTP calls, the contract is permissive and relies entirely on the calling layer to restrict inputs. If the calling layer ever exposes `provided_arguments` to user-controlled data (e.g., pass-through of request query params), unexpected GeoNames parameters could be injected into the outbound call.

**A039-2** (INFO) — `Geonames.Endpoints.PostalCodeLookup` line 12: `available_url_parameters/0` contains a typo — `:postcalcode` (transposed 'l' and 'c') instead of `:postalcode`. The corresponding `required_url_parameters/0` on line 13 correctly spells `:postalcode`. This inconsistency means the `available_url_parameters` list does not include the correctly spelled atom that is actually required, which could lead to a validation bypass if any caller uses `available_url_parameters` as an allowlist to gate what may be passed into `url_arguments/1`. This is a logic defect with a potential security implication if the endpoint framework enforces parameter filtering based on `available_url_parameters`.

---

### §4: Session and CSRF

No session handling, CSRF tokens, WebSocket/channel code, or cookie configuration is present in these files.

§4: No issues found.

---

### §5: File and Data Handling

No file uploads, file I/O, Logger calls, or data returned to clients are present in these files. These modules solely define static configuration maps and short pure functions.

§5: No issues found.

---

### §6: Dependencies

These files contain no `mix.exs` references, no `Mix.Project`, no external library calls, and no `git:` dependency specifications. Dependency review is not applicable to these individual source modules; it is addressed at the project level by the `mix.exs`/`mix.lock` review.

§6: No issues found.

---

### §7: Infrastructure Exposure

No hostnames, IP addresses, port numbers, CORS configuration, TLS settings, or inter-service call logic are present. The GeoNames endpoint name strings (e.g., `"oceanJSON"`, `"postalCodeCountryInfoJSON"`, `"postalCodeLookupJSON"`) are public GeoNames API endpoint identifiers and do not reveal internal infrastructure topology.

§7: No issues found.

---

## Findings Summary

| ID | Severity | File | Description |
|---|---|---|---|
| A039-1 | LOW | `postal_code_lookup.ex`, `oceans.ex`, `postal_code_country_info.ex` | `url_arguments/1` performs no key/value validation on `provided_arguments`; any key passed by the caller is forwarded to the outbound GeoNames API URL without whitelist enforcement at this layer. |
| A039-2 | INFO | `postal_code_lookup.ex` line 12 | Typo in `available_url_parameters/0`: `:postcalcode` should be `:postalcode`. Mismatch with `required_url_parameters/0` could allow a validation bypass if the framework uses `available_url_parameters` as an allowlist. |

---

## Detailed Findings

### A039-1 — LOW
**File(s):** All three modules (`oceans.ex` line 16–18, `postal_code_country_info.ex` line 13–15, `postal_code_lookup.ex` line 16–18)
**Description:** The `url_arguments/1` function in all three endpoint modules accepts an arbitrary map (`provided_arguments`) and merges it into the default arguments map with no filtering or validation:

```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`Map.merge/2` with the provided map as the second argument means caller-supplied keys override defaults and any additional keys are included verbatim. There is no check that keys belong to the set declared in `available_url_parameters/0`, no type validation, and no value sanitisation. The resulting map is what gets serialised into the outbound GeoNames HTTP query string.

If any upstream caller constructs `provided_arguments` from user-controlled input (e.g., pass-through of HTTP query parameters), an attacker could inject arbitrary GeoNames API parameters — most notably the `username` parameter used for GeoNames authentication, which if overridden could exhaust a different account's quota, or add parameters such as `style` or `lang` that alter the response shape in unexpected ways.

**Recommendation:** Either enforce key filtering in `url_arguments/1` using `Map.take(provided_arguments, available_url_parameters())` before merging, or ensure that calling code never passes user-controlled input to this function without its own whitelist enforcement.

---

### A039-2 — INFO
**File:** `geonames-elixir/lib/geonames/endpoints/postal_code_lookup.ex` line 12
**Description:** Typo in `available_url_parameters/0`:

```elixir
# Line 12 — as written (typo):
def available_url_parameters, do: [:postcalcode, :country, :maxRows]

# Line 13 — correct spelling used in required_url_parameters:
def required_url_parameters, do: [:postalcode, :country]
```

The atom `:postcalcode` does not match the `:postalcode` key used in `@default_arguments` and `required_url_parameters`. If any caller uses `available_url_parameters/0` as a validation allowlist before calling `url_arguments/1`, the correct `:postalcode` key would be rejected (not in the available list) while the misspelled `:postcalcode` would be accepted — effectively inverting the validation for the primary required parameter.

**Recommendation:** Correct the typo on line 12 from `:postcalcode` to `:postalcode`.
