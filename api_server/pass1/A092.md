# Audit Report A092
**Agent:** A092
**Run:** 2026-02-27-01
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server_web/auth_error_handler.ex`
2. `lib/api_server_web/auth_pipeline.ex`
3. `lib/api_server_web/channels/user_socket.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/auth_error_handler.ex`

**Module name:** `ApiServerWeb.AuthErrorHandler`

**Public functions:**
| Name | Arity | Line |
|------|-------|------|
| `auth_error` | 3 | 4 |

**defstruct / defexception / schema:** None

**Plugs / pipeline entries:** None (this module is used as an error handler, not a plug itself)

**use / import / alias at module level:**
- `import Plug.Conn` (line 2)

---

### File 2: `lib/api_server_web/auth_pipeline.ex`

**Module name:** `ApiServer.Guardian.AuthPipeline`

**Public functions:** None (plug pipeline only)

**defstruct / defexception / schema:** None

**Plugs:**
| Plug | Options | Line |
|------|---------|------|
| `Guardian.Plug.VerifyHeader` | `realm: "Bearer"` | 6 |
| `Guardian.Plug.EnsureAuthenticated` | *(commented out)* | 7 |
| `Guardian.Plug.LoadResource` | *(none)* | 8 |

**use / import / alias at module level:**
- `use Guardian.Plug.Pipeline, otp_app: :MyApi, module: ApiServer.Guardian, error_handler: ApiServerWeb.AuthErrorHandler` (lines 2–4)

---

### File 3: `lib/api_server_web/channels/user_socket.ex`

**Module name:** `ApiServerWeb.UserSocket`

**Public functions:**
| Name | Arity | Line |
|------|-------|------|
| `connect` | 2 | 22 |
| `id` | 1 | 36 |

**defstruct / defexception / schema:** None

**Plugs / pipeline entries:**
- `transport :websocket, Phoenix.Transports.WebSocket` (line 8)
- `transport :longpoll, Phoenix.Transports.LongPoll` (commented out, line 9)

**use / import / alias at module level:**
- `use Phoenix.Socket` (line 2)

---

## Findings

### A092-1 — CRITICAL: `Guardian.Plug.EnsureAuthenticated` is commented out in `auth_pipeline.ex`

**File:** `lib/api_server_web/auth_pipeline.ex`, line 7
**Checklist section:** §2 (Authentication and Authorization)

The plug that enforces authentication is commented out:

```elixir
plug Guardian.Plug.VerifyHeader, realm: "Bearer"
# plug Guardian.Plug.EnsureAuthenticated    <-- DISABLED
plug Guardian.Plug.LoadResource
```

`Guardian.Plug.VerifyHeader` only attempts to parse and verify a JWT from the `Authorization` header if one is present. It does not reject requests that omit the header entirely. `Guardian.Plug.LoadResource` will silently succeed with a `nil` resource when no token is present.

Without `EnsureAuthenticated`, any request to the `:authenticated` pipeline that simply omits the `Authorization` header will pass through as an unauthenticated request. All routes under the `pipe_through([:api, :authenticated])` block in `router.ex` — including user management, customer management, fleet operations, rental records, vehicle locations, geofences, and fleet map endpoints — are effectively unprotected.

This is a complete authentication bypass affecting every route in the `/api/v1` scope that calls `pipe_through([:api, :authenticated])` (router.ex lines 33–153).

**Affected routes include (non-exhaustive):**
- `GET /api/v1/rhm/:customer/users` — lists all users for a customer
- `DELETE /api/v1/rhm/:customer/user/:id` — deletes a user
- `GET /api/v1/rhm/customers` — lists all customers
- `DELETE /api/v1/rhm/customer/:id` — deletes a customer
- `GET /api/v1/rhm/fleetmap` — vehicle locations for all fleets
- `GET /api/v1/rhm/fleetmap/:fleetid` — vehicle locations for a fleet
- `PUT /api/v1/rhm/:customer/user/` — creates a user
- All fleet, rental, geofence, and export endpoints

---

### A092-2 — CRITICAL: `user_socket.ex` `connect/2` accepts all connections without any token validation

**File:** `lib/api_server_web/channels/user_socket.ex`, lines 22–24
**Checklist section:** §4 (Session and CSRF)

```elixir
def connect(_params, socket) do
  {:ok, socket}
end
```

The `connect/2` callback unconditionally returns `{:ok, socket}`, ignoring all parameters. Any WebSocket client can establish a socket connection without presenting any credentials. The params argument is explicitly ignored with the `_params` wildcard. The Phoenix-generated comment block (lines 15–21) acknowledges that token verification should be performed here but no implementation was added.

The `id/1` function returns `nil` (line 36), making all sockets anonymous, which means it is also impossible to forcibly disconnect a specific user's socket via `Endpoint.broadcast`.

---

### A092-3 — HIGH: `otp_app` atom mismatch in `auth_pipeline.ex` — `:MyApi` vs `:api_server`

**File:** `lib/api_server_web/auth_pipeline.ex`, line 2
**Checklist section:** §2 (Authentication and Authorization)

```elixir
use Guardian.Plug.Pipeline, otp_app: :MyApi,
```

The `otp_app` is set to `:MyApi` but the application's OTP app name is `:api_server` (as used in `endpoint.ex`, `guardian.ex`, and all config files). This is a copy-paste error from a template or example.

At runtime, Guardian's pipeline will attempt to read its configuration from the `:MyApi` OTP application environment, which does not exist. The Guardian secret key, issuer, and TTL are configured under `:api_server`. Depending on the Guardian version, this may cause the pipeline to fail open (treating tokens as valid when configuration cannot be loaded) or raise errors. In either case, the pipeline is not operating against its intended configuration.

---

### A092-4 — HIGH: WebSocket transport has no `check_origin` configuration in production

**File:** `lib/api_server_web/channels/user_socket.ex`, line 8
**Supporting file:** `lib/api_server_web/endpoint.ex`, line 4
**Config file:** `config/dev.exs`, line 13 (`check_origin: false`)
**Checklist section:** §4 (Session and CSRF)

The `transport :websocket` declaration carries no `check_origin` option:

```elixir
transport :websocket, Phoenix.Transports.WebSocket
```

`dev.exs` sets `check_origin: false` at the endpoint level, which disables origin checking for the dev environment. There is no corresponding `check_origin` setting found in `prod.exs` or `prod.secret.exs`. Because the `connect/2` callback also performs no authentication (A092-2), any cross-origin client can open a WebSocket connection from an arbitrary domain.

---

### A092-5 — HIGH: Two routes placed before `pipe_through` in the same scope block, bypassing all authentication

**File:** `lib/api_server_web/router.ex`, lines 28–33
**Checklist section:** §2 (Authentication and Authorization)

```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)

  pipe_through([:api, :authenticated])
  ...
end
```

In Phoenix, `pipe_through` applies only to routes defined after it in the same scope block. The two routes `GET /api/v1/rhm/engine_usage` and `GET /api/v1/rhm/monday_hour_meters` are defined before the `pipe_through([:api, :authenticated])` call and therefore receive no pipeline at all — not even the `:api` pipeline (no session, no content-type enforcement). These routes return fleet/engine data with no authentication whatsoever.

The comment "Avoid authentication, locking to a specific database" suggests this is intentional, but the security implication is that unauthenticated external callers can retrieve engine usage data for any hardware ID. These endpoints should be reviewed to confirm whether truly public access is acceptable, and if so, they should be moved to the unauthenticated scope (lines 156–177) for clarity.

---

### A092-6 — MEDIUM: Guardian token TTL is 52 weeks (one year) — excessively long

**File:** `config/config.exs`, line 135
**Checklist section:** §2 (Authentication and Authorization)

```elixir
config :api_server, ApiServer.Guardian,
  issuer: "rhmapi",
  ttl: {52, :weeks},
  secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

A JWT TTL of 52 weeks means a stolen or leaked token remains valid for up to one year. There is no evidence of a token revocation mechanism or refresh token policy in the codebase. Combined with the authentication bypass in A092-1, any token that has ever been issued remains exploitable for a full year.

---

### A092-7 — MEDIUM: Guardian `secret_key` is a hardcoded string in a tracked config file

**File:** `config/config.exs`, line 136
**Checklist section:** §1 (Secrets and Configuration)

```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The Guardian JWT signing secret is committed as a literal string in `config/config.exs`, which is tracked by version control. Anyone with read access to the repository (including historical commits) can obtain the signing secret and forge arbitrary JWTs. This secret should be loaded from an environment variable: `System.get_env("GUARDIAN_SECRET_KEY")`.

---

### A092-8 — MEDIUM: `auth_error_handler.ex` — discards error reason, but error type is still returned to client

**File:** `lib/api_server_web/auth_error_handler.ex`, lines 4–6
**Checklist section:** §5 (File and Data Handling — information disclosure in error responses)

```elixir
def auth_error(conn, {type, _reason}, _opts) do
  body = Poison.encode!(%{error: to_string(type)})
  send_resp(conn, 401, body)
end
```

The `_reason` is discarded (good), but `type` is serialised to a string and returned verbatim in the JSON response body. Guardian error types include atoms such as `:token_expired`, `:invalid_token`, `:unauthenticated`, `:no_resource_found`, `:already_authenticated`. Returning the specific error type enables an attacker to distinguish between "no token provided", "expired token", and "invalid token signature", which aids in probing the authentication system.

Additionally, the response has no `Content-Type: application/json` header set explicitly. The raw `send_resp/3` call bypasses Phoenix's view layer and will not set the content type, potentially causing clients to misparse the response.

---

### §1: Additional notes from context files

The following issues in context files are outside the three assigned files but are directly relevant to the security posture of the assigned modules and are noted for completeness:

- `config/prod.exs` contains hardcoded production database credentials (RDS hostname, username, password for both `FortyNineRepo` and `Repo`), an AWS SES SMTP access key ID, and SMTP password (lines 17, 35–36, 45, 48). This is a separate finding for the config-file audit agent but corroborates the pattern found in A092-7.
- `config/prod.secret.exs` contains a hardcoded `secret_key_base` (line 12). The file is intended to be excluded from version control per its own comment, but it was readable during this audit, suggesting it may be tracked.

---

## Checklist Section Summary

| Section | Status |
|---------|--------|
| §1 Secrets and Configuration | Issues found — A092-7 (Guardian secret hardcoded in tracked config) |
| §2 Authentication and Authorization | Issues found — A092-1 (EnsureAuthenticated commented out), A092-3 (otp_app mismatch), A092-5 (routes before pipe_through), A092-6 (52-week TTL) |
| §3 Input Validation and Injection | §3: No issues found in the three assigned files. |
| §4 Session and CSRF | Issues found — A092-2 (socket connect accepts all), A092-4 (no check_origin in production) |
| §5 File and Data Handling | Issues found — A092-8 (Guardian error type disclosed to client) |
| §6 Dependencies | §6: No issues found in the three assigned files. |
| §7 Infrastructure Exposure | §7: No issues found in the three assigned files. |

---

## Finding Index

| ID | Severity | File | Summary |
|----|----------|------|---------|
| A092-1 | CRITICAL | `auth_pipeline.ex:7` | `EnsureAuthenticated` plug commented out — authentication bypass on all protected routes |
| A092-2 | CRITICAL | `user_socket.ex:22` | `connect/2` returns `{:ok, socket}` unconditionally — no token validation on WebSocket connections |
| A092-3 | HIGH | `auth_pipeline.ex:2` | `otp_app: :MyApi` does not match application name `:api_server` — Guardian pipeline misconfigured |
| A092-4 | HIGH | `user_socket.ex:8` | No `check_origin` enforced for WebSocket transport in production |
| A092-5 | HIGH | `router.ex:30-31` | Two routes declared before `pipe_through` in authenticated scope — no pipeline applied |
| A092-6 | MEDIUM | `config/config.exs:135` | Guardian TTL is 52 weeks with no refresh/revocation policy |
| A092-7 | MEDIUM | `config/config.exs:136` | Guardian `secret_key` hardcoded as literal string in tracked config file |
| A092-8 | MEDIUM | `auth_error_handler.ex:5` | Guardian error type (`type` atom) returned verbatim in 401 response body |
