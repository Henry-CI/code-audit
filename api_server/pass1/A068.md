# Security Audit Pass 1 — A068
**Agent:** A068
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Run:** 2026-02-27-01
**Date:** 2026-02-27

---

## Assigned Files

- `lib/api_server/vx/geofence.ex`
- `lib/api_server/vx/mailer.ex`
- `lib/api_server/vx/rental_contracts.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server/vx/geofence.ex`

**Module name:** `ApiServer.Vx.Geofence`

**use / import / alias at module level:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)
- `import Ecto.Query, warn: false` (line 4)
- `alias ApiServer.Repo` (line 6)
- `alias ApiServer.Vx` (line 7)
- `alias ApiServer.Vx.VXThingEvent` (line 8)

**Schema defined:**
```
schema "geofences" do
  field :name, :string
  field :geojson, :string
end
@primary_key {:id, :id, autogenerate: true}
```

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 17 |
| `geojson_map_to_string` | 1 | 24 |
| `geojson_db_string_to_map` | 1 | 38 |

**Private functions (defp) — noted for context:**
- `does_event_cause_geofence_events_no_thing/5` (line 52)
- `check_event_for_left_events_no_thing/5` (line 69–70)
- `check_event_for_entered_events_no_thing/6` (line 86)
- `make_geofence_event_no_thing/5` (line 103)
- `engine_hours_at_event_no_thing/2` (line 119)

---

### File 2: `lib/api_server/vx/mailer.ex`

**Module name:** `ApiServer.Mailer`

**use / import / alias at module level:**
- `use Bamboo.Mailer, otp_app: :api_server` (line 2)

**Schema defined:** None

**Public functions (def):** None explicitly defined — all behaviour provided by Bamboo.Mailer macro (`deliver_now/1`, `deliver_later/1`).

---

### File 3: `lib/api_server/vx/rental_contracts.ex`

**Module name:** `ApiServer.Vx.RentalContract`

**use / import / alias at module level:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:**
```
@primary_key {:ID, :id, autogenerate: true}
schema "rental_contracts" do
  field :id, :integer, source: :id
  field :equipment_id, :integer, source: :equipment_id
  field :customer_id, :integer, source: :customer_id
  field :contract_reference, :string, source: :contract_reference
  field :contract_start, :date, source: :contract_start
  field :contract_end, :date, source: :contract_end
  field :billing_frequency, :string, source: :billing_frequency
  field :hours_per_billing_period, :integer, source: :hours_per_billing_period
  field :cost_units, :string, source: :cost_units
  field :cost_per_unit, :float, source: :cost_per_unit
  field :reporting_frequency, :string, source: :reporting_frequency
  field :created, :utc_datetime, source: :created
  field :sent_to_rayven, :integer, source: :sent_to_rayven
end
```

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 22 |

---

## Checklist Review

### §1: Secrets and Configuration

**A068-1 — CRITICAL: AWS SES SMTP credentials hardcoded in `config/config.exs` (tracked file)**

File: `config/config.exs`, lines 117–120.

```elixir
username: "[REDACTED-AWS-KEY-ID]",
password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

An AWS IAM access key ID (`[REDACTED-AWS-KEY-ID]`) and its SMTP secret are committed in plaintext in the base configuration file. This file is tracked by git and present from the initial commit (`e675b0b`). The same credentials are repeated verbatim in `config/prod.exs` (lines 45–48). Both files are tracked; git history cannot be cleaned without rewriting all commits. These credentials must be considered fully compromised and rotated immediately. Values must be moved to environment variables: `System.get_env("SES_SMTP_USERNAME")` and `System.get_env("SES_SMTP_PASSWORD")`.

**A068-2 — CRITICAL: Phoenix `secret_key_base` hardcoded in `config/config.exs` (tracked file)**

File: `config/config.exs`, line 15.

```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh",
```

A 64-byte `secret_key_base` is committed in the base config file. Any party with repository access can forge signed cookies and session tokens. This value must be rotated and loaded from `System.get_env("SECRET_KEY_BASE")`.

**A068-3 — CRITICAL: Guardian JWT `secret_key` hardcoded in `config/config.exs` (tracked file)**

File: `config/config.exs`, line 136.

```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The HMAC signing key used to issue and verify all JWTs is committed in plaintext. Any party with repository access can mint arbitrary valid authentication tokens for any user or customer, with full access to all fleet data. Rotate immediately and load from an environment variable.

**A068-4 — CRITICAL: Production database credentials hardcoded in `config/prod.exs` (tracked file)**

File: `config/prod.exs`, lines 13–25 and 27–37.

```elixir
# ApiServer.FortyNineRepo
username: "svr49_hi_x_user",
password: "Q973bFtc9z/cVW#mA",
hostname: "svr49.tracking-intelligence.com",

# ApiServer.Repo
username: "vxaurorasyduser",
password: "TRxbixk9fuZc",
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
```

Two sets of production database credentials are committed in plaintext in `prod.exs`, which is a tracked file present from the initial commit. This exposes direct database access to anyone with repository read access. Credentials must be rotated and loaded from environment variables.

**A068-5 — CRITICAL: `config/prod.secret.exs` committed to version control**

The `.gitignore` file (line 27) has the exclusion pattern `/config/*.secret.exs` commented out:

```
# /config/*.secret.exs
```

As a result, `config/prod.secret.exs` is tracked and was committed in the initial commit (`e675b0b`). That file contains an additional `secret_key_base`:

```elixir
secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```

The purpose of `prod.secret.exs` — to hold secrets outside version control — is entirely defeated. The `.gitignore` exclusion must be uncommented and git history reviewed.

**A068-6 — HIGH: AWS RDS hostname and internal service hostname reveal infrastructure topology in tracked config**

File: `config/prod.exs`, lines 18 and 36.

```elixir
hostname: "svr49.tracking-intelligence.com",
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
```

The AWS RDS cluster endpoint (including AWS account-specific subdomain `c4fwadrw9quy`) and an internal server hostname are committed in plaintext. Even after credential rotation, this reveals database topology and AWS account identifiers. Hostnames should be loaded from environment variables.

**A068-7 — HIGH: Geonames API username hardcoded in `config/config.exs`**

File: `config/config.exs`, lines 138–140.

```elixir
config :geonames,
  username: "vinxstudio",
```

A third-party service account credential is hardcoded in a tracked file. While less severe than database and JWT secrets, this credential belongs to an external account and should be loaded from an environment variable.

**A068-8 — HIGH: Guardian TTL set to 52 weeks**

File: `config/config.exs`, line 135.

```elixir
ttl: {52, :weeks},
```

JWT tokens are valid for one full year. In the event of token theft or the compromise of the `secret_key`, an attacker retains valid credentials for up to 52 weeks before expiry. Combined with A068-3 (the `secret_key` being committed to git), every token ever issued with this key must be considered compromised. Even after key rotation, a 52-week TTL is excessive for a fleet management API that holds GPS location and operator data. Recommended maximum is 24 hours with refresh tokens.

---

### §2: Authentication and Authorization

**A068-9 — MEDIUM: Two endpoints in `scope "/api/v1"` are placed before `pipe_through([:api, :authenticated])`**

File: `lib/api_server_web/router.ex`, lines 30–33.

```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)

  pipe_through([:api, :authenticated])
  ...
```

In Phoenix, `pipe_through` applies to all routes declared after it within the same scope block. The two routes declared before `pipe_through([:api, :authenticated])` — `/rhm/engine_usage` and `/rhm/monday_hour_meters` — are unauthenticated. These routes return fleet usage and meter data. Whether this is intentional should be documented. If these routes return any per-customer fleet data, they represent an information disclosure vulnerability.

Note: The geofence routes (`/rhm/geofences`, `/rhm/geofence`, `/rhm/reports/geofence_events`) and rental contract routes are all declared after `pipe_through([:api, :authenticated])` and are correctly authenticated.

§2: No further issues found for the three assigned files.

---

### §3: Input Validation and Injection

**A068-10 — MEDIUM: `Geofence.changeset/2` does not validate `:geojson` field**

File: `lib/api_server/vx/geofence.ex`, lines 17–21.

```elixir
def changeset(geofence, attrs) do
  geofence
  |> cast(attrs, [:name, :geojson])
  |> validate_required([:name])
end
```

The `:geojson` field is cast but not validated. There is no length limit, no format check, and no structural validation on the GeoJSON content. The `geojson_db_string_to_map/1` function deserialises this field via `Poison.decode/1` at query time; malformed or oversized payloads are silently turned into empty strings (`""`). While Poison decoding is safe against code injection, the absence of size limits means an authenticated user can store arbitrarily large GeoJSON blobs, creating a storage and memory pressure vector.

**A068-11 — MEDIUM: `RentalContract.changeset/2` has no `validate_required` calls**

File: `lib/api_server/vx/rental_contracts.ex`, lines 22–25.

```elixir
def changeset(rental_contracts, attrs) do
  rental_contracts
  |> cast(attrs, [:id, :equipment_id, :customer_id, :contract_reference, :contract_start,
                  :contract_end, :billing_frequency, :hours_per_billing_period, :cost_units,
                  :cost_per_unit, :reporting_frequency, :created, :sent_to_rayven])
end
```

The changeset casts all fields but performs no validation at all — no `validate_required`, no `validate_number`, no `validate_inclusion` for the `billing_frequency`, `cost_units`, or `reporting_frequency` enum-like string fields. This means:
- Rental contracts can be created with `nil` for all financial fields (`cost_per_unit`, `hours_per_billing_period`).
- Arithmetic operations performed downstream on these fields (e.g. rental overage calculations in the scheduler job) will encounter `nil` values and crash or produce incorrect results silently.
- String fields that likely represent bounded sets (`billing_frequency`, `reporting_frequency`) accept arbitrary input.

**A068-12 — LOW: `RentalContract.changeset/2` casts `:id` from user input**

File: `lib/api_server/vx/rental_contracts.ex`, line 24.

The `:id` field (which maps to the integer primary-key surrogate `id` column, separate from the declared `@primary_key {:ID, ...}`) is included in the cast list. Allowing callers to supply `:id` in attrs means a client can attempt to set or override the internal record identifier. This is redundant given the `@primary_key` declaration and could lead to confusion or unintended overwrites.

§3: No raw SQL fragment or atom-from-user-input issues found in the three assigned files.

---

### §4: Session and CSRF

§4: No issues found in the three assigned files. CSRF protection is applied via the `:browser` pipeline (`plug(:protect_from_forgery)`). The assigned files contain no session or channel logic.

---

### §5: File and Data Handling

**A068-13 — HIGH: Internal error detail returned to API clients in geofence create/update responses**

File: `lib/api_server_web/controllers/geofence_controller.ex`, lines 30–31 (referenced from context of `geofence.ex` public API).

```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error creating geofence\", \"reason\": \"#{inspect error}\" }")
```

and line 50:

```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }")
```

The full Ecto changeset error (or exception struct) is serialised via `inspect/1` and included verbatim in the HTTP 500 response body returned to the client. This can leak internal schema structure, field names, database constraint names, and stack trace fragments to an authenticated attacker. Additionally, line 30 calls `IO.inspect error` which echoes the same data to stdout/logs; in production this appears in the application log but confirms the pattern of treating internal errors as debug output.

**A068-14 — MEDIUM: GPS coordinates and vehicle location data included in geofence event responses without confirming cross-customer boundary protection**

File: `lib/api_server/vx/geofence.ex`, function `make_geofence_event_no_thing/5` (lines 103–116).

The returned geofence event maps include:
```elixir
latitude: event.latitude,
longitude: event.longitude
```

The data is correctly scoped to the authenticated customer's database prefix throughout (the `customer` value from JWT claims is passed as the Ecto prefix). However, the `does_event_cause_geofence_events_no_thing/5` and related private functions in `geofence.ex` are designed to operate independently of a `thing` struct — they accept raw `event` and `customer` arguments. If these functions are ever called from a context where the `customer` value is not verified against the authenticated user's claims (e.g. from the TCP ingestion pipeline), GPS data would flow without authorisation checks.

Inspection of `lib/api_server/tcp/tcp.ex` is outside this agent's file scope; this finding should be reviewed in conjunction with the TCP pipeline audit.

**A068-15 — LOW: `send_digital_matter_email` in `email.ex` (adjacent module) serialises raw fleet data via `Kernel.inspect/2` into email body**

File: `lib/api_server/vx/email.ex`, line 227 (not an assigned file, noted as adjacent context for the Mailer module).

```elixir
|> html_body("... "<> Kernel.inspect(data, limit: :infinity) <>"...")
```

This is an internal diagnostic/debug email function, but `limit: :infinity` means arbitrarily large Elixir terms — potentially containing full event structs with GPS data, hardware IDs, or customer identifiers — are serialised into an email. Email is an insecure transport and this pattern leaks fleet telemetry data outside the application boundary.

---

### §6: Dependencies

§6: The three assigned files do not introduce new dependencies directly. `ApiServer.Mailer` delegates entirely to `Bamboo.Mailer`. The use of `Poison` in `geofence.ex` (lines 29, 43) is noted — Poison is a legacy JSON library; Jason is the recommended replacement for Phoenix applications — however no known security advisory applies to the version in use at time of this audit. Dependency version checks are the responsibility of the mix.lock agent.

---

### §7: Infrastructure Exposure

**A068-16 — HIGH: AWS SES endpoint region hardcoded in tracked config files**

File: `config/config.exs`, line 113 and `config/prod.exs`, line 41.

```elixir
server: "email-smtp.us-west-2.amazonaws.com",
```

The AWS region `us-west-2` is hardcoded in tracked files. Combined with the RDS endpoint in `ap-southeast-2` (A068-6), this reveals that the application spans two AWS regions. While not directly exploitable on its own, this contributes to infrastructure topology disclosure in the git history.

§7: No CORS wildcard or permissive CSP issues found directly within the three assigned files. Router CORS status is noted at §2 (A068-9) for the unauthenticated routes.

---

## Summary of Findings

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A068-1 | CRITICAL | `config/config.exs` | AWS SES SMTP credentials hardcoded and committed |
| A068-2 | CRITICAL | `config/config.exs` | Phoenix `secret_key_base` hardcoded and committed |
| A068-3 | CRITICAL | `config/config.exs` | Guardian JWT `secret_key` hardcoded and committed |
| A068-4 | CRITICAL | `config/prod.exs` | Production database credentials hardcoded and committed |
| A068-5 | CRITICAL | `.gitignore` / `config/prod.secret.exs` | `prod.secret.exs` exclusion commented out; file committed to git |
| A068-6 | HIGH | `config/prod.exs` | AWS RDS hostname and internal hostname in tracked config |
| A068-7 | HIGH | `config/config.exs` | Geonames third-party API username hardcoded |
| A068-8 | HIGH | `config/config.exs` | Guardian JWT TTL of 52 weeks is excessive |
| A068-9 | MEDIUM | `router.ex` | Two routes declared before `pipe_through :authenticated` are unauthenticated |
| A068-10 | MEDIUM | `lib/api_server/vx/geofence.ex` | `changeset/2` does not validate or size-limit `:geojson` field |
| A068-11 | MEDIUM | `lib/api_server/vx/rental_contracts.ex` | `changeset/2` has no validation — all financial fields can be nil |
| A068-12 | LOW | `lib/api_server/vx/rental_contracts.ex` | `:id` field cast from user input in changeset |
| A068-13 | HIGH | `geofence_controller.ex` (context) | Internal Ecto error detail returned verbatim in HTTP 500 response |
| A068-14 | MEDIUM | `lib/api_server/vx/geofence.ex` | GPS data in `_no_thing` functions; TCP pipeline auth dependency unverified |
| A068-15 | LOW | `lib/api_server/vx/email.ex` (adjacent) | `inspect(data, limit: :infinity)` serialises fleet data into debug email |
| A068-16 | HIGH | `config/config.exs`, `config/prod.exs` | AWS region hardcoded in tracked files |

**Critical findings require immediate action before any further deployment: A068-1 through A068-5 represent fully committed, historically permanent exposure of credentials that must be rotated regardless of any code change.**
