# Audit Report A012
**Agent:** A012
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Scope:** geonames-elixir (vendored third-party library)

---

## Assigned Files

- `geonames-elixir/config/config.exs`
- `geonames-elixir/lib/geonames.ex`
- `geonames-elixir/lib/geonames/endpoint.ex`
- `geonames-elixir/lib/geonames/helpers.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/config/config.exs`

**Module name:** N/A (Mix configuration file using `use Mix.Config`)

**Public functions:** None (configuration DSL, not a module with functions)

**defstruct / defexception / schema:** None

**use / import / alias at module level:**
- `use Mix.Config` (line 3)

**Configuration values set:**
- `config :geonames, username: "testuser"` (line 6)
- `config :geonames, language: "es"` (line 7)

---

### File 2: `geonames-elixir/lib/geonames.ex`

**Module name:** `Geonames`

**Public functions** (all generated via metaprogramming `for endpoint <- endpoints do ... def unquote(endpoint.function_name)(args \\ %{})` — one per endpoint, arity 0..1, line 96):

The following public functions are generated at compile time (line 96), one per endpoint module listed lines 42–79:
- `astergdem/0..1`
- `children/0..1`
- `cities/0..1`
- `contains/0..1`
- `country_code/0..1`
- `country_info/0..1`
- `country_subdivision/0..1`
- `earthquakes/0..1`
- `find_nearby/0..1`
- `find_nearby_place_name/0..1`
- `find_nearby_postal_codes/0..1`
- `find_nearby_streets/0..1`
- `find_nearby_streets_osm/0..1`
- `find_nearby_weather/0..1`
- `find_nearby_wikipedia/0..1`
- `find_nearest_address/0..1`
- `find_nearest_intersection/0..1`
- `find_nearest_intersection_osm/0..1`
- `find_nearby_pois_osm/0..1`
- `get/0..1`
- `gtopo30/0..1`
- `hierarchy/0..1`
- `neighbourhood/0..1`
- `neighbours/0..1`
- `ocean/0..1`
- `postal_code_country_info/0..1`
- `postal_code_lookup/0..1`
- `postal_code_search/0..1`
- `search/0..1`
- `siblings/0..1`
- `srtm1/0..1`
- `srtm3/0..1`
- `timezone/0..1`
- `weather/0..1`
- `weather_icao/0..1`
- `wikipedia_bounding_box/0..1`
- `wikipedia_search/0..1`

Additionally:
- `perform_geonames_request/1` (line 130) — public, arity 1

**defstruct / defexception / schema:** None

**use / import / alias at module level:**
- `alias Geonames.Endpoints, as: EP` (line 38)
- `alias Geonames.Helpers` (line 39)

---

### File 3: `geonames-elixir/lib/geonames/endpoint.ex`

**Module name:** `Geonames.Endpoint`

**Public functions:** None (behaviour definition only, no `def`)

**Callbacks defined:**
- `@callback endpoint :: String.t` (line 10)
- `@callback available_url_parameters :: list(Atom.t)` (line 11)
- `@callback required_url_parameters :: list(Atom.t)` (line 12)
- `@callback function_name :: Atom.t` (line 13)
- `@callback url_arguments(map) :: map` (line 14)

**defstruct / defexception / schema:** None

**use / import / alias at module level:** None

---

### File 4: `geonames-elixir/lib/geonames/helpers.ex`

**Module name:** `Geonames.Helpers`

**Public functions:**
- `required_parameters_provided?/2` (line 14, arity 2)
- `build_url_string/2` (line 30, arity 2)

**Private functions:**
- `user_configuration/0` (line 51, `defp`)

**defstruct / defexception / schema:** None

**use / import / alias at module level:** None

**Module attributes:**
- `@base_url` (line 8) — set at compile time via `Application.get_env(:geonames, :base_url, "api.geonames.org/")`

---

## Security Findings

### §1: Secrets and Configuration

**A012-1** — MEDIUM — Hardcoded credential (GeoNames username) in vendored library config

**File:** `geonames-elixir/config/config.exs`, line 6
**Evidence:**
```elixir
config :geonames,
  username: "testuser",
  language: "es"
```
The GeoNames API username `"testuser"` is hardcoded as the default value in the library's `config.exs`. This credential would be present in source control. Although this is the vendored library's own config file (which Elixir does not load from sub-dependencies), the fact that the value is present in source creates a risk: if the parent application does not explicitly override `:geonames, :username`, this value may remain as the operative credential. The `Geonames.Helpers.user_configuration/0` function (helpers.ex, line 53) will fall back to `Application.get_env(:geonames, :username)` if the env var `GEONAMES_USERNAME` is not set. A tracked, non-overridden username is a credentials-in-source-control issue.

**Recommendation:** The parent application's production config must set `:geonames, :username` from an environment variable. Verify this is the case in the parent project's `runtime.exs` or `prod.exs`. The vendored file should not contain a live username.

---

**A012-2** — LOW — Hardcoded language default `"es"` in vendored library config

**File:** `geonames-elixir/config/config.exs`, line 7
**Evidence:**
```elixir
language: "es"
```
The language default is set to Spanish (`"es"`) in the vendored config rather than English (`"en"`). While not a secret, this is an unexpected default that differs from the library's own fallback in `helpers.ex` (line 54, which falls back to `"en"` if `GEONAMES_LANGUAGE` env var is unset). The vendored config value would silently override the code-level default. This is a configuration integrity issue introduced by vendoring.

---

**A012-3** — MEDIUM — `@base_url` resolved at compile time, preventing runtime override

**File:** `geonames-elixir/lib/geonames/helpers.ex`, line 8
**Evidence:**
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```
The base URL is captured into a module attribute at compile time. `Application.get_env/3` in a module attribute (`@`) is evaluated during compilation, not at runtime. This means the base URL cannot be changed without recompilation, and if the compile-time application environment does not include the `:geonames` app config being fully loaded, the default `"api.geonames.org/"` will be baked in regardless of any runtime configuration. Additionally, note the URL has no scheme — the assembled URL (line 47: `@base_url <> endpoint <> "?" <> encoded_params`) would produce a string like `api.geonames.org/searchJSON?...` with no `http://` or `https://` prefix. HTTPoison/hackney would reject or mishandle this URL unless the parent application overrides `base_url` to include a full scheme. This may cause silent failures in production.

---

### §2: Authentication and Authorization

**A012-4** — INFO — GeoNames API authentication uses only a username parameter, with no secret/password

**File:** `geonames-elixir/lib/geonames/helpers.ex`, lines 52–55
**Evidence:**
```elixir
defp user_configuration do
  %{
    username: Application.get_env(:geonames, :username) || System.get_env("GEONAMES_USERNAME"),
    language: Application.get_env(:geonames, :language, System.get_env("GEONAMES_LANGUAGE") || "en")
  }
end
```
The GeoNames API authenticates requests solely by embedding the username as a plain URL query parameter (not a token or signed request). This is by design for the geonames.org free/commercial API, but it means the credential is visible in any HTTP logs, proxy logs, or error messages. There is no HMAC signing or token-based authentication. This is a characteristic of the upstream API, not a library bug, but the parent application should be aware that the GeoNames username will appear in outbound HTTP request logs.

---

### §3: Input Validation and Injection

**A012-5** — MEDIUM — URL parameters are string-interpolated without URL-encoding individual values before joining

**File:** `geonames-elixir/lib/geonames/helpers.ex`, lines 34–46
**Evidence:**
```elixir
|> Enum.map(fn
  {_,nil}                    -> nil
  {k,v} when is_binary(v)    -> "#{k}=#{v}"
  {k,v} when is_float(v)     -> "#{k}=#{v}"
  {k,v} when is_boolean(v)   -> "#{k}=#{v}"
  {k,v} when is_integer(v)   -> "#{k}=#{v}"
  {k,arr} when is_list(arr)  -> Enum.map(arr, &"#{k}=#{&1}")
end)
|> List.flatten
|> Enum.filter(fn(k) -> !is_nil(k) end)
|> Enum.join("&")
|> URI.encode
```
Individual parameter values are interpolated directly into the query string with `"#{k}=#{v}"` before the final `URI.encode/1` is called on the entire assembled string. `URI.encode/1` (without specifying a custom encoder) encodes the full string but preserves characters that are legal in a URI — including `=` and `&`. This means a user-supplied string value containing `&` or `=` (e.g., a search query like `"London&username=attacker"`) would not be properly percent-encoded per key, allowing parameter injection into the GeoNames API request. The correct approach is to use `URI.encode_query/1` on the parameter map, which encodes each key-value pair individually. This is a query-parameter injection vulnerability affecting all endpoints that accept free-text string parameters (e.g., `search`, `wikipedia_search`, `postal_code_search`).

---

**A012-6** — LOW — No validation of parameter value types or content beyond type guards

**File:** `geonames-elixir/lib/geonames/helpers.ex`, lines 34–41; `geonames-elixir/lib/geonames.ex`, lines 96–110
The library performs only binary/float/boolean/integer/list type guards on parameter values before interpolation. There is no validation of value content (e.g., numeric range checks for latitude/longitude, format validation for dates). Malformed values will be forwarded directly to the GeoNames API, which may return unexpected responses. This is a low-severity issue in the context of a geo lookup library, but the parent application should validate inputs before calling these functions.

---

### §4: Session and CSRF

§4: No issues found. This is a stateless HTTP client library with no session management, cookies, or CSRF relevance.

---

### §5: File and Data Handling

**A012-7** — LOW — API responses are decoded with `Poison.decode!/1` (bang form — raises on error) and raw decoded maps are returned directly to callers

**File:** `geonames-elixir/lib/geonames.ex`, lines 131–141
**Evidence:**
```elixir
def perform_geonames_request(url) do
  case HTTPoison.get(url) do
    { :ok, %HTTPoison.Response{ status_code: 200, body: body }} ->
      { :ok, Poison.decode!(body) }

    { :ok, %HTTPoison.Response{ status_code: status_code, body: body }} ->
      { :error, "An unexpected #{status_code} response was received"}

    { :error, %HTTPoison.Error{ reason: reason }} ->
      { :error, "Request failed with the following error: #{to_string(reason)}" }
  end
end
```
`Poison.decode!/1` raises a `Poison.ParseError` exception if the response body is not valid JSON. This exception is not caught, so a malformed or unexpected response from the GeoNames API (or a network intermediary returning an HTML error page) will cause an unhandled exception to propagate to the caller. The generated endpoint functions (geonames.ex, lines 101–106) re-raise `RuntimeError` on `{:error, ...}` tuples but do not catch exceptions from `perform_geonames_request/1`. Callers must be prepared to handle both `RuntimeError` and `Poison.ParseError`. If this error propagates to a Phoenix controller, it may expose a stack trace in development, and in production it may result in a 500 error without graceful handling. The parent application should ensure `perform_geonames_request/1` calls are wrapped in `try/rescue` or the error path is converted to a safe `{:error, reason}` tuple.

**A012-8** — INFO — GeoNames API responses are passed through to callers without sanitization

The decoded JSON map from the GeoNames API is returned directly to callers without validation of field presence, type, or content. If the GeoNames API returns unexpected or malicious content (e.g., if DNS is hijacked or the API is compromised), the raw map is forwarded. The parent application should treat all GeoNames API response data as untrusted external input.

---

### §6: Dependencies

**A012-9** — HIGH — Vendored third-party library not managed via hex.pm

**Location:** `geonames-elixir/` directory (entire subtree present in the api_server repository)
The `geonames-elixir` library is vendored directly into the repository rather than being declared as a hex.pm dependency or a `git:` path dependency in the parent project's `mix.exs`. Vendoring has the following security implications:

1. **No automatic vulnerability notifications:** hex.pm provides security advisories for published packages. A vendored copy receives no such notifications; the team must manually monitor for vulnerabilities in the library and its transitive dependencies.
2. **Dependency version drift:** The vendored library has its own `mix.lock` (within `geonames-elixir/`). This lock file is independent of the parent project's `mix.lock`. The transitive dependencies (HTTPoison 1.3.0, Hackney 1.13.0, Poison 3.1.0, certifi 2.3.1) are pinned to versions from approximately 2018–2019 and have not been updated. These are significantly outdated.
3. **Modifications are invisible:** Any changes made to the vendored source are not tracked against the upstream library version, making security patch application and auditing difficult.
4. **Supply chain risk:** The library (`geonames-elixir` v1.0.3, originally from `https://github.com/pareeohnos/geonames-elixir`) is now under full control of whoever committed it to this repository. No hash-based integrity verification exists for the vendored source.

**Recommendation:** Replace the vendored copy with a declared hex.pm dependency (`{:geonames, "~> 1.0"}`) or a locked git dependency with a pinned commit SHA. The parent project's `mix.lock` should control all transitive dependency versions.

---

**A012-10** — HIGH — Significantly outdated transitive dependencies with potential unpatched CVEs

**File:** `geonames-elixir/mix.lock`
The vendored library's own `mix.lock` pins the following notably old versions:

| Package | Vendored Version | Notes |
|---|---|---|
| `httpoison` | 1.3.0 (2018) | Current is 2.x; multiple fixes since 1.3.0 |
| `hackney` | 1.13.0 (2018) | Current is 1.20.x; multiple TLS and HTTP fixes since 1.13.0 |
| `poison` | 3.1.0 (2017) | Current is 5.x; no active security support for 3.x |
| `certifi` | 2.3.1 (2018) | CA bundle from 2018 — may contain expired or revoked roots |
| `ssl_verify_fun` | 1.1.1 (2016) | Current is 1.1.7; SSL verification fixes applied since 1.1.1 |

The `certifi 2.3.1` CA bundle is particularly concerning: it is from 2018 and may not include current trusted roots or may include roots that have since been distrusted. The parent api_server project recently fixed a TLS issue (commit `e486dd8`: "Fix Rayven TLS 'Unknown CA' error after Sectigo Root R46 cert renewal"), suggesting TLS certificate chain validation is a live operational concern. The vendored library's outdated `certifi` bundle would cause similar failures for GeoNames API calls if the GeoNames API's certificate chain depends on roots added after 2018.

**Note:** Whether the vendored library's `mix.lock` is actually used at runtime depends on how the parent project integrates the vendored code. If the parent project's `mix.exs` includes the vendored library as a `path:` dependency, the parent's `mix.lock` controls all deps and the vendored `mix.lock` is ignored. If the vendored code is compiled independently (i.e., the directory is on the `$ELIXIR_LIB_PATH` or similar), the vendored lock file would be operative. This should be verified.

---

**A012-11** — LOW — Vendored library requires `elixir: "~> 1.2"` — compatible with very old Elixir versions

**File:** `geonames-elixir/mix.exs`, line 7
The library specifies `elixir: "~> 1.2"`, meaning it was written for and tested against Elixir 1.2 (released 2016). No minimum bound is set for current supported Elixir versions. This is informational but indicates the library has not been maintained for a long time.

---

### §7: Infrastructure Exposure

**A012-12** — MEDIUM — Base URL defaults to plain HTTP (no scheme), and TLS is not enforced

**File:** `geonames-elixir/lib/geonames/helpers.ex`, line 8 and line 47
**Evidence:**
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
# ...
@base_url <> endpoint <> "?" <> encoded_params
```
The default `@base_url` value is `"api.geonames.org/"` — a bare hostname with no URL scheme. The assembled URL string would be `"api.geonames.org/searchJSON?..."`. HTTPoison/hackney may treat this as a relative URL or fail to parse it, depending on version. Even if the parent application overrides `base_url` to `"http://api.geonames.org/"`, that would mean all GeoNames API requests — including those carrying the API username credential — are transmitted over plain HTTP with no TLS. The GeoNames API is available over HTTPS (`https://secure.geonames.org/`). The library does not enforce or document HTTPS usage. The GeoNames username (a credential) would be transmitted in cleartext over HTTP if the parent application uses the default or an HTTP base URL.

**Recommendation:** The parent application's configuration must set `:geonames, :base_url` to `"https://secure.geonames.org/"` to ensure HTTPS is used for all GeoNames API calls.

---

**A012-13** — INFO — `perform_geonames_request/1` is public — exposes internal HTTP client capability

**File:** `geonames-elixir/lib/geonames.ex`, line 130
`perform_geonames_request/1` accepts an arbitrary URL string and performs an HTTP GET, returning parsed JSON. This function is `def` (public), not `defp` (private). Any code with access to the `Geonames` module can call this function with an arbitrary URL, potentially making HTTP requests to internal services or infrastructure endpoints. While this is a library design issue (not a direct vulnerability in api_server), the parent application should not expose this function through any API surface.

---

## Summary Table

| ID | Severity | Section | Title |
|---|---|---|---|
| A012-1 | MEDIUM | §1 | Hardcoded GeoNames username `"testuser"` in vendored config |
| A012-2 | LOW | §1 | Unexpected language default `"es"` overrides library default |
| A012-3 | MEDIUM | §1 | `@base_url` compiled at build time — runtime override ineffective; no URL scheme |
| A012-4 | INFO | §2 | GeoNames authentication via plain URL parameter — credential in HTTP logs |
| A012-5 | MEDIUM | §3 | URL parameter injection via insufficient per-value encoding (`URI.encode` on full string) |
| A012-6 | LOW | §3 | No content validation of parameter values before dispatch to GeoNames API |
| A012-7 | LOW | §5 | `Poison.decode!/1` raises uncaught exception on non-JSON responses |
| A012-8 | INFO | §5 | GeoNames API responses passed through without sanitization |
| A012-9 | HIGH | §6 | Library vendored rather than managed via hex.pm — no vulnerability tracking |
| A012-10 | HIGH | §6 | Outdated transitive dependencies (hackney 1.13, certifi 2.3.1, ssl_verify_fun 1.1.1) |
| A012-11 | LOW | §6 | Library targets Elixir ~> 1.2 — unmaintained |
| A012-12 | MEDIUM | §7 | No TLS enforcement — default base URL lacks scheme, credentials sent in cleartext |
| A012-13 | INFO | §7 | `perform_geonames_request/1` is public — arbitrary URL HTTP client accessible to callers |
