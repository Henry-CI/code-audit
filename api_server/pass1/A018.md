# Audit Report A018
**Agent:** A018
**Run:** 2026-02-27-01
**Pass:** 1
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Auditor model:** claude-sonnet-4-6
**Date:** 2026-02-27

**Assigned files:**
- `geonames-elixir/lib/geonames/endpoints/contains.ex`
- `geonames-elixir/lib/geonames/endpoints/country_code.ex`
- `geonames-elixir/lib/geonames/endpoints/country_info.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/contains.ex`

**Module name:** `Geonames.Endpoints.Contains`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 11 |
| `available_url_parameters` | 0 | 12 |
| `required_url_parameters` | 0 | 13 |
| `function_name` | 0 | 14 |
| `url_arguments` | 1 | 16 |

**Structs / defexception / schema:** None.

**use / import / alias at module level:** None (no `use`, `import`, or `alias`).

**Behaviour:** `@behaviour Geonames.Endpoint`

**Module attributes:**
- `@default_arguments %{geonameId: nil, featureClass: nil, featureCode: nil}` (line 5–9)

---

### File 2: `geonames-elixir/lib/geonames/endpoints/country_code.ex`

**Module name:** `Geonames.Endpoints.CountryCode`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**Structs / defexception / schema:** None.

**use / import / alias at module level:** None.

**Behaviour:** `@behaviour Geonames.Endpoint`

**Module attributes:**
- `@default_arguments %{lat: nil, lng: nil, type: nil, radius: nil}` (lines 5–10)

---

### File 3: `geonames-elixir/lib/geonames/endpoints/country_info.ex`

**Module name:** `Geonames.Endpoints.CountryInfo`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 9 |
| `available_url_parameters` | 0 | 10 |
| `required_url_parameters` | 0 | 11 |
| `function_name` | 0 | 12 |
| `url_arguments` | 1 | 14 |

**Structs / defexception / schema:** None.

**use / import / alias at module level:** None.

**Behaviour:** `@behaviour Geonames.Endpoint`

**Module attributes:**
- `@default_arguments %{country: nil}` (lines 5–7)

---

## Supporting Context Read

Because these modules implement the `Geonames.Endpoint` behaviour and the `url_arguments/1` function's output feeds into URL construction, the following supporting files were also read to provide complete security context:

- `geonames-elixir/lib/geonames/endpoint.ex` — defines the behaviour callbacks
- `geonames-elixir/lib/geonames/helpers.ex` — contains `build_url_string/2` which consumes the output of `url_arguments/1`
- `geonames-elixir/mix.exs` — dependency declarations for the vendored library

---

## Findings by Checklist Section

### §1: Secrets and Configuration

**A018-1 — MEDIUM — Hardcoded external API base URL in compile-time module attribute**

File: `geonames-elixir/lib/geonames/helpers.ex`, line 8
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```
This is in a supporting file read for context, but it directly governs the base URL used when the three assigned endpoint modules construct their outbound HTTP requests. The default `"api.geonames.org/"` is evaluated at **compile time** via `Application.get_env/3` as a module attribute. In a release build where the application environment is not explicitly configured, this default silently takes effect. If the production configuration omits `:base_url`, the application will send all geolocation queries (which may include GPS coordinates derived from fleet/vehicle data) to the public geonames.org API rather than to an internal or validated endpoint. This is a misconfiguration risk with data-disclosure implications.

Note: No secrets were hardcoded in the three assigned endpoint files themselves. The endpoint files contain no credentials, API keys, or sensitive configuration.

---

### §2: Authentication and Authorization

These three modules are pure data-structure endpoint descriptors. They implement a behaviour interface (`Geonames.Endpoint`) and perform no authentication, session handling, or authorisation logic of their own. They do not make HTTP calls — they only define parameters to be assembled into a URL by `Geonames.Helpers.build_url_string/2`.

Specific observations:

- `Geonames.Endpoints.CountryCode` declares `:lat` and `:lng` as required parameters (line 14). The `url_arguments/1` function accepts an arbitrary caller-supplied map and merges it into the default arguments map with no type checking or range validation on the coordinate values. Whether those coordinates originate from authenticated user input or unauthenticated sources is entirely the concern of the caller — these modules impose no guard.
- The GeoNames API itself requires a `username` credential (injected by `Geonames.Helpers` from application config or `GEONAMES_USERNAME` env var). These endpoint modules do not touch that credential path; authentication to the upstream API is handled in the helper layer.

§2: No authentication or authorisation issues within the scope of these three files.

---

### §3: Input Validation and Injection

**A018-2 — MEDIUM — No input validation on caller-supplied URL parameters; URL construction uses unencoded string interpolation**

Files: all three assigned endpoints, and `geonames-elixir/lib/geonames/helpers.ex` (supporting context)

The `url_arguments/1` function in each module performs only a `Map.merge/2` of caller-supplied arguments into a default map. No type checking, range validation, or allow-list enforcement is performed on the values. The merged map is then passed to `Geonames.Helpers.build_url_string/2`, which constructs the URL using bare string interpolation:

```elixir
{k,v} when is_binary(v) -> "#{k}=#{v}"
{k,v} when is_float(v)  -> "#{k}=#{v}"
...
|> Enum.join("&")
|> URI.encode
```

`URI.encode/1` encodes the entire query string after it has already been assembled. This means that if a binary value contains `&`, `=`, or other query-string metacharacters **before** encoding, they will be percent-encoded by `URI.encode/1` and will not cause injection into the query structure. However:

1. `URI.encode/1` (without a custom character set) does **not** encode all characters that have structural significance in URLs — specifically, `?` and `#` are not encoded by the default `URI.encode/1` character set. A string value containing `#` could truncate the query string at the HTTP level.
2. No numeric range validation is applied to `lat`/`lng` (should be -90..90 and -180..180 respectively), `radius`, or `geonameId`. Out-of-range values are passed through to the upstream API without error.
3. The `type` and `featureClass`/`featureCode` fields are free-form strings with no allow-list validation. They are forwarded verbatim to the external geonames.org API.

The practical injection risk against the upstream GeoNames API is low because geonames.org is not under the application's control and server-side validation there is expected. The risk to the local application is minimal given `URI.encode` does prevent most query-string manipulation. However the absence of any validation represents a missing defence-in-depth layer.

---

### §4: Session and CSRF

These modules are not web controllers, do not interact with sessions, cookies, or CSRF tokens, and are not plugs. They define no HTTP handlers.

§4: No issues found.

---

### §5: File and Data Handling

**A018-3 — LOW — GPS coordinate parameters forwarded to external third-party API without data minimisation or logging controls**

File: `geonames-elixir/lib/geonames/endpoints/country_code.ex`, lines 5–10
```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  type: nil,
  radius: nil
}
```

The `CountryCode` endpoint accepts latitude and longitude values and forwards them to the external GeoNames API. In the context of api_server being a fleet management backend, the `lat`/`lng` values passed through this endpoint may represent real-time vehicle or asset locations. These coordinates are passed to `api.geonames.org` (a third-party public API) over HTTP (no TLS scheme is specified in the base URL — see A018-4). This constitutes potential PII/location-data disclosure to a third party without the base URL being enforced as HTTPS.

No logger calls or error responses with sensitive data were found in the three assigned files.

§5: See A018-3 above.

---

### §6: Dependencies

The three assigned endpoint files have no direct dependencies — they declare no `use`, `import`, or external calls. Their transitive dependency path is through `Geonames.Helpers` which calls `HTTPoison` for HTTP and `Poison` for JSON.

From `geonames-elixir/mix.exs` (supporting context):
```elixir
{:poison, "~> 3.1"},
{:httpoison, "~> 1.0"},
{:ex_doc, "~> 0.12", only: :dev}
```

**A018-4 — HIGH — Outdated vendored library with known-vulnerable dependencies; no TLS enforcement on outbound API calls**

1. **Poison ~> 3.1** — Poison 3.x is multiple major versions behind the current release. Poison 3.x has known denial-of-service concerns with certain deeply nested JSON inputs. The vendored library pins only an approximate version (`~> 3.1`); the exact pinned version would need checking in `mix.lock` to confirm whether a patched sub-version is in use.

2. **HTTPoison ~> 1.0** — HTTPoison 1.x is a significantly outdated version. The library wraps Hackney and inherits its TLS stack. Version 1.x may not benefit from TLS improvements present in later releases.

3. **No HTTPS enforcement** — The base URL in `Geonames.Helpers` is `"api.geonames.org/"` with no scheme. When `build_url_string/2` constructs the full URL, no `https://` prefix is added, meaning HTTP (unencrypted) may be used for outbound requests carrying GPS coordinate parameters. This would expose vehicle location data in transit to a public third-party service.

4. **Elixir version constraint `~> 1.2`** — The vendored library targets Elixir 1.2 (released 2016). This is informational but indicates the library has not been maintained or updated and may not follow current security practices.

5. **ex_doc pinned to `~> 0.12`** — Extremely old dev dependency; low risk as it is dev-only, but indicates the library is unmaintained.

---

### §7: Infrastructure Exposure

**A018-5 — INFO — Hardcoded external service hostname reveals third-party dependency**

File: `geonames-elixir/lib/geonames/helpers.ex`, line 8 (supporting context for the assigned modules)
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The hostname `api.geonames.org` is hardcoded as the compile-time default for all three assigned endpoint modules' outbound HTTP calls. This is not an internal infrastructure hostname, so the topology exposure risk is low. However, the absence of a scheme (`https://`) means there is no guarantee that TLS is enforced for outbound requests (see A018-4).

The three assigned files themselves contain no hardcoded hostnames, IPs, port numbers, or internal service URLs.

§7: See A018-5 above.

---

## Finding Summary

| ID | Severity | Section | File(s) | Summary |
|----|----------|---------|---------|---------|
| A018-1 | MEDIUM | §1 Secrets & Config | `helpers.ex` (context) | Compile-time default base URL; if prod config omits `:base_url`, GPS data silently routed to public geonames.org |
| A018-2 | MEDIUM | §3 Input Validation | all three assigned files + `helpers.ex` | No type or range validation on caller-supplied URL parameters; URL assembled via string interpolation with incomplete encoding |
| A018-3 | LOW | §5 File & Data Handling | `country_code.ex` | GPS coordinates forwarded to external third-party API; potential fleet location data disclosure |
| A018-4 | HIGH | §6 Dependencies | `mix.exs` (context) | Outdated vendored library; Poison 3.x, HTTPoison 1.x; no HTTPS scheme enforced on outbound calls carrying GPS data |
| A018-5 | INFO | §7 Infrastructure | `helpers.ex` (context) | Hardcoded third-party hostname as compile-time default; no scheme prefix means TLS not guaranteed |

---

*End of report A018.*
