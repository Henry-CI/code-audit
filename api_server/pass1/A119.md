# Security Audit Report — A119
**Agent:** A119
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Run:** 2026-02-27-01
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server_web/resolvers/puls.ex`
2. `lib/api_server_web/resolvers/things.ex`
3. `lib/api_server_web/router.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server_web/resolvers/puls.ex`

**Module:** `ApiServerWeb.Resolvers.Puls`

**Public functions:**

| Function | Arity | Line |
|----------|-------|------|
| `puls_record/3` | 3 | 3 |

**defstruct / defexception / schema:** None.

**Plugs / pipelines:** None (resolver module, not a controller/router).

**use / import / alias at module level:** None declared.

**Full text read:** Yes (lines 1–29).

---

### File 2: `lib/api_server_web/resolvers/things.ex`

**Module:** `ApiServerWeb.Resolvers.Things`

**Public functions:**

| Function | Arity | Line |
|----------|-------|------|
| `find_thing/3` | 3 | 3 |
| `get_all_things/3` | 3 | 13 |

**defstruct / defexception / schema:** None.

**Plugs / pipelines:** None (resolver module).

**use / import / alias at module level:** None declared.

**Full text read:** Yes (lines 1–22).

---

### File 3: `lib/api_server_web/router.ex`

**Module:** `ApiServerWeb.Router`

**use / import / alias at module level:**
- `use ApiServerWeb, :router`

**Pipelines defined:**

| Pipeline | Plugs |
|----------|-------|
| `:browser` | `accepts(["html"])`, `fetch_session`, `fetch_flash`, `protect_from_forgery`, `put_secure_browser_headers` |
| `:api` | `fetch_session`, `accepts(["json"])` (CORSPlug commented out) |
| `:api_xml` | `fetch_session`, `accepts(["xml"])` (CORSPlug commented out) |
| `:authenticated` | `ApiServer.Guardian.AuthPipeline` |

**All routes — scope `/api/v1` (first block):**

Lines 30–31: Two routes declared BEFORE the `pipe_through([:api, :authenticated])` call at line 33. These two routes are therefore unauthenticated:

| Method | Path | Controller | Action | Pipelines |
|--------|------|------------|--------|-----------|
| GET | `/api/v1/rhm/engine_usage` | `VXThingController` | `:combined_engine_usage` | **NONE** |
| GET | `/api/v1/rhm/monday_hour_meters` | `VXThingController` | `:monday_hour_meters` | **NONE** |

All subsequent routes in this scope (lines 35–153) are behind `[:api, :authenticated]`:

| Method | Path | Controller | Action |
|--------|------|------------|--------|
| GET | `/api/v1/rhm/pape_export` | `VXThingController` | `:pape_export` |
| GET | `/api/v1/rhm/sielift_export` | `VXThingController` | `:sielift_export` |
| GET | `/api/v1/rhm/reports/geofence_events` | `GeofenceController` | `:process_things_geofences` |
| GET | `/api/v1/rhm/work_in_progress` | `VXThingController` | `:sielift_export` |
| GET | `/api/v1/rhm/things_with_usage` | `VXThingController` | `:rhm_get_things_with_usage` |
| GET | `/api/v1/rhm/thing_records` | `VXThingController` | `:rhm_get_thing_records` |
| GET | `/api/v1/rhm/:customer/things/names` | `VXThingController` | `:rhm_get_things_names` |
| GET | `/api/v1/rhm/:customer/things` | `VXThingController` | `:rhm_get_things` |
| GET | `/api/v1/rhm/thing/:hardwareid/events` | `VXThingController` | `:rhm_get_thing_events` |
| GET | `/api/v1/rhm/thing/:hardwareid/usage` | `VXThingController` | `:rhm_get_thing_usage` |
| GET | `/api/v1/rhm/:customer/thing/:hardwareid` | `VXThingController` | `:rhm_get_thing` |
| GET | `/api/v1/rhm/thing/:hardwareid/active_rental` | `VXRentalController` | `:rhm_active_rental` |
| POST | `/api/v1/rhm/thing/` | `VXThingController` | `:update_thing` |
| PUT | `/api/v1/rhm/thing/` | `VXThingController` | `:create_thing` |
| GET | `/api/v1/rhm/thing/:hardwareid/omega_data` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_current_omega_status` |
| GET | `/api/v1/vx/:customer/thing/:hardwareid/movements/:day` | `VXThingController` | `:get_movements` |
| GET | `/api/v1/rhm/omega_thing/:hardwareid/container_lift_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_container_lift_report` |
| GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_summary_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_lift_summary_report` |
| GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_list_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_lift_list_report` |
| GET | `/api/v1/rhm/omega_fleet/:fleetid/lift_summary_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_lift_summary_report` |
| GET | `/api/v1/rhm/omega_thing/:hardwareid/engine_utilization_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_engine_utilization_report` |
| GET | `/api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` (x2 — duplicate) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_operation_summary_report` |
| GET | `/api/v1/rhm/fleets` | `VXFleetController` | `:get_fleets` |
| GET | `/api/v1/rhm/fleets_with_equipment` | `VXFleetController` | `:get_fleets_with_equipment` |
| PUT | `/api/v1/rhm/:customer/fleet/` | `VXFleetController` | `:create_fleet` |
| DELETE | `/api/v1/rhm/:customer/fleet/:id` | `VXFleetController` | `:delete_fleet` |
| POST | `/api/v1/rhm/:customer/fleet/` | `VXFleetController` | `:update_fleet` |
| GET | `/api/v1/rhm/:customer/fleet/:id/equipment` | `VXFleetController` | `:get_equipment_in_fleet` |
| POST | `/api/v1/rhm/:customer/fleet/:id/manage` | `VXFleetController` | `:manage_fleet` |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:rhm_service_records` |
| GET | `/api/v1/rhm/:customer/rentals` | `VXRentalController` | `:get_rentals` |
| POST | `/api/v1/rhm/:customer/rentals/` | `VXRentalController` | `:update_rental` |
| PUT | `/api/v1/rhm/:customer/rentals/` | `VXRentalController` | `:create_rental` |
| DELETE | `/api/v1/rhm/:customer/rentals/:id` | `VXRentalController` | `:delete_rental` |
| GET | `/api/v1/rhm/thing/:hardwareid/rental_anniversaries` | `VXRentalController` | `:get_rental_anniversaries` |
| GET | `/api/v1/rhm/rentals/midpac_style_report` | `VXRentalController` | `:get_midpac_style_rental_report` |
| POST | `/api/v1/rhm/user/change_password` | `VXUserController` | `:change_password` |
| GET | `/api/v1/rhm/user/:user_id/fleets` | `VXUserController` | `:get_user_fleets` |
| POST | `/api/v1/rhm/user/:user_id/fleets` | `VXUserController` | `:manage_user_fleets` |
| GET | `/api/v1/rhm/:customer/users` | `VXUserController` | `:get_users` |
| GET | `/api/v1/rhm/:customer/user/:email` | `VXUserController` | `:get_user_with_email` |
| POST | `/api/v1/rhm/:customer/user/` | `VXUserController` | `:update_user` |
| PUT | `/api/v1/rhm/:customer/user/` | `VXUserController` | `:create_user` |
| DELETE | `/api/v1/rhm/:customer/user/:id` | `VXUserController` | `:delete_user` |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:index` |
| GET | `/api/v1/rhm/customer/:id` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:show` |
| POST | `[REDACTED-AWS-SMTP-PASSWORD]` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:update` |
| PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:create` |
| DELETE | `/api/v1/rhm/customer/:id` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:delete` |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `VXThingController` | `:get_fleet_map` |
| GET | `/api/v1/rhm/fleetmap/:fleetid` | `VXThingController` | `:get_fleet_map` |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `GeofenceController` | `:list_all_geofences` |
| PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | `GeofenceController` | `:create_geofence` |
| POST | `[REDACTED-AWS-SMTP-PASSWORD]` | `GeofenceController` | `:update_geofence` |
| DELETE | `/api/v1/rhm/geofence/:id` | `GeofenceController` | `:delete_geofence` |

**All routes — scope `/api/v1` (second block, pipe_through `:api` only — NO authentication):**

| Method | Path | Controller | Action | Pipelines |
|--------|------|------------|--------|-----------|
| GET | `/api/v1/hc` | `UtilityController` | `:do_health_check` | `:api` only |
| POST | `/api/v1/rhm/:customer/login/` | `VXUserController` | `:login` | `:api` only |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` (index) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:index` | `:api` only |
| POST | `[REDACTED-AWS-SMTP-PASSWORD]` (create) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:create` | `:api` only |
| GET | `/api/v1/vx/thingsummaries/:id` (show) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:show` | `:api` only |
| PATCH/PUT | `/api/v1/vx/thingsummaries/:id` (update) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:update` | `:api` only |
| DELETE | `/api/v1/vx/thingsummaries/:id` (delete) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:delete` | `:api` only |
| GET | `/api/v1/files/getsize/:esn` | `FileController` | `:get_size` | `:api` only |
| GET | `/api/v1/files/getfile/:esn` | `FileController` | `:send_file_download` | `:api` only |
| GET | `/api/v1/vx/:customer/thing/with_checklists` | `VXThingController` | `:get_hardware_with_checklists` | `:api` only |
| GET | `/api/v1/vx/:customer/thing/:hardwareid/checklists` | `VXThingController` | `:get_checklists` | `:api` only |
| GET | `/api/v1/vx/:customer/pmServicesAjax/:hardwareid` | `VXThingController` | `:get_pm_data` | `:api` only |
| GET | `/api/v1/vx/:customer/pmServicesAjax` | `VXThingController` | `:get_all_pm_data` | `:api` only |
| GET | `/api/v1/vx/:customer/rentalStats` | `VXThingController` | `:get_all_rental_stats` | `:api` only |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `VXThingController` | `:get_timezones` | `:api` only |
| GET | `/api/v1/rhm/:customer/fix_info` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:fix_infos` | `:api` only |

**All routes — scope `/` (pipe_through `:api_xml` only — NO authentication):**

| Method | Path | Controller | Action | Pipelines |
|--------|------|------------|--------|-----------|
| GET | `/` | `UtilityController` | `:do_health_check` | `:api_xml` only |
| GET | `/geocode` | `UtilityController` | `:do_geocode_lookup` | `:api_xml` only |
| GET | `/error/:status_code` | `UtilityController` | `:do_error` | `:api_xml` only |
| POST | `/test-omega-data` | `UtilityController` | `:process_incoming_omegawatch_data` | `:api_xml` only |
| POST | `/prodisplay/event` | `UtilityController` | `:process_prodisplay_event` | `:api_xml` only |
| POST | `/` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_g62_data` | `:api_xml` only |
| POST | `/erp-import` | `UtilityController` | `:erp_import` | `:api_xml` only |
| POST | `/driverid-converter` | `UtilityController` | `:driverid_converter` | `:api_xml` only |
| GET | `/dis-sync` | `UtilityController` | `:sync_to_DISCorp` | `:api_xml` only |

**GraphQL routes:** Commented out (lines 195–202). No active GraphQL endpoints.

**Full text read:** Yes (lines 1–203).

---

## Checklist Review

### §1: Secrets and Configuration

**A119-1 — CRITICAL: `EnsureAuthenticated` plug is commented out in `AuthPipeline`**

File: `lib/api_server_web/auth_pipeline.ex`, line 7.

```elixir
plug Guardian.Plug.VerifyHeader, realm: "Bearer"
# plug Guardian.Plug.EnsureAuthenticated   <-- COMMENTED OUT
plug Guardian.Plug.LoadResource
```

The `:authenticated` pipeline only verifies and loads a token if one is present. It does **not** enforce that a valid token must be present. A request with no `Authorization` header will pass through `VerifyHeader` without error and reach `LoadResource`, which will silently load `nil` as the current resource. Controllers that assume `current_claims/1` or `current_resource/1` will not be nil after passing `:authenticated` may behave unpredictably. This effectively means that many routes advertised as authenticated are reachable without a token. This is the highest-severity finding in this file set.

---

**A119-2 — CRITICAL: Guardian `secret_key` hardcoded in tracked source file**

File: `config/config.exs`, line 136.

```elixir
config :api_server, ApiServer.Guardian,
  issuer: "rhmapi",
  ttl: {52, :weeks},
  secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The HMAC signing key used to sign and verify all JWTs is committed in cleartext to the repository. Any person with read access to the repository can forge arbitrary tokens for any user, customer, or role, completely bypassing authentication.

---

**A119-3 — CRITICAL: `prod.secret.exs` committed to version control and contains production `secret_key_base`**

The `.gitignore` file comments out the exclusion rule for `*.secret.exs`:

```
# /config/*.secret.exs
```

Confirmed via `git ls-files config/prod.secret.exs` — the file is tracked. It contains:

```elixir
config :api_server, ApiServerWeb.Endpoint,
  secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```

The Phoenix `secret_key_base` protects session cookies and other signed/encrypted data. Exposure allows session forgery and cookie tampering in production.

---

**A119-4 — CRITICAL: CalAmp API credential hardcoded in resolver**

File: `lib/api_server_web/resolvers/puls.ex`, line 4.

```elixir
token = "VHJhY2tpbmdTb2x1dGlvbnM6U2tQREk4ZXo="
```

This is a Base64-encoded Basic Auth credential (`TrackingSolutions:SkPDI8ez` when decoded) for the CalAmp PULS telematics platform. It is hardcoded in source and committed to the repository.

Additionally, a second CalAmp/PULS credential appears in `utility_controller.ex`, line 151:
```
Authorization: "Basic VHJhY2tpbmdTb2x1dGlvbnM6dHZWSFFVc0NBZXU0"
```
(decoded: `TrackingSolutions:tvVHQUsCAeu4`)

These credentials provide access to telematics vehicle tracking data for the CalAmp fleet, enabling enumeration of fleet hardware IDs, ESNs, ICCIDs, and group assignments.

---

**A119-5 — HIGH: DISCorp API key hardcoded in source**

File: `lib/api_server_web/controllers/utility_controller.ex`, line 1053 (referenced via `sync_to_DISCorp`).

```elixir
api_key = "PZPwWHyAMFhPbt3UB8PWXtEw"
```

This third-party API key for DISCorp (`disprism.com`) is hardcoded in source. This key allows equipment hour meter updates to be pushed to the DISCorp system. If revoked or rotated the value must be changed in source, triggering a redeploy; and any repository reader can use the key directly.

---

**A119-6 — HIGH: Guardian token TTL is 52 weeks**

File: `config/config.exs`, line 135.

```elixir
ttl: {52, :weeks}
```

Tokens are valid for one full year. There is no evidence of refresh token rotation or token revocation infrastructure in the codebase. A stolen token remains valid for up to 52 weeks, providing an extremely wide attack window.

---

### §2: Authentication and Authorization

**A119-7 — CRITICAL: `EnsureAuthenticated` is disabled — authenticated routes are reachable without a token**

(See A119-1 above for full detail.) This is also an authorization finding: the `:authenticated` pipeline does not reject unauthenticated requests; it merely attempts to load credentials if they happen to be present. Routes intended to be protected may be accessible with no token whatsoever.

---

**A119-8 — CRITICAL: Full CRUD on `VXThingSummary` is unauthenticated and unscoped**

Router scope `/api/v1`, second block, line 162:
```elixir
resources("/vx/thingsummaries", VXThingSummaryController, except: [:new, :edit])
```
This registers `index`, `show`, `create`, `update`, and `delete` actions — all five behind `:api` only (no `:authenticated`). Inspection of `[REDACTED-AWS-SMTP-PASSWORD]` confirms:

- `index/2` calls `Vx.list_vxthingsummaries()` — returns all thing summaries across all customers, with no scoping.
- `show/2` accepts `id` from the URL directly: `Vx.get_vx_thing_summary!(id)` — no ownership check.
- `create/2` and `update/2` accept arbitrary params — no owner check.
- `delete/2` deletes by `id` with no ownership check.

Any unauthenticated internet client can enumerate, read, create, modify, or delete all thing summaries across all customer organisations. This is cross-customer data exposure without authentication.

---

**A119-9 — HIGH: File download endpoints are unauthenticated and leak access-fob key material**

Router (second scope, `:api` only):
```elixir
get("/files/getsize/:esn", FileController, :get_size)
get("/files/getfile/:esn", FileController, :send_file_download)
```

`FileController.send_file_download/2` retrieves all access fobs for the fleets associated with a hardware ID, concatenates their `fob_code` values, computes a CRC, and returns a binary file for download. This file is keying material for physical access control (forklift key fobs). No authentication is required; the only input is an ESN/hardware ID number, which is an enumerable integer.

`get_size/2` leaks the number of access fobs per vehicle, also without authentication.

---

**A119-10 — HIGH: `/vx/:customer/pmServicesAjax` and related VX endpoints are unauthenticated**

Router (second scope, `:api` only, lines 169–173):
```elixir
get("/vx/:customer/thing/with_checklists",   VXThingController, :get_hardware_with_checklists)
get("/vx/:customer/thing/:hardwareid/checklists", VXThingController, :get_checklists)
get("/vx/:customer/pmServicesAjax/:hardwareid",   VXThingController, :get_pm_data)
get("/vx/:customer/pmServicesAjax",               VXThingController, :get_all_pm_data)
get("/vx/:customer/rentalStats",                  VXThingController, :get_all_rental_stats)
```

None of these routes are behind `:authenticated`. They expose PM service data, checklist records, and rental statistics for any customer whose name is known or guessable. The `customer` path segment is not validated against any authenticated session.

---

**A119-11 — HIGH: `/rhm/:customer/fix_info` is an unauthenticated administrative maintenance action**

Router (second scope, line 176):
```elixir
get("/rhm/:customer/fix_info", VXThingInfoController, :fix_infos)
```

`VXThingInfoController.fix_infos/2` enumerates all things for a customer and triggers `do_fix_info` for each — a write/repair operation — without any authentication. Any caller who knows or guesses a customer identifier can trigger bulk data repair operations against arbitrary customer databases.

---

**A119-12 — HIGH: Two fleet data reporting routes lack authentication (pre-`pipe_through` position)**

Router, scope `/api/v1` first block, lines 30–31 (before `pipe_through([:api, :authenticated])` at line 33):
```elixir
get("/rhm/engine_usage",      VXThingController, :combined_engine_usage)
get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)
```

In Phoenix, `pipe_through` within a scope applies only to routes defined **after** it. These two routes appear before the `pipe_through` call and therefore receive no pipeline at all — not even `:api`. Confirmed by reading `combined_engine_usage/2`: it accepts `customers` as a comma-separated query parameter, iterates over all customer databases, and returns aggregated multi-customer engine usage data. `monday_hour_meters/2` similarly returns cross-customer hour-meter data. Both are sensitive fleet operational data accessible with a plain HTTP GET to any caller.

---

**A119-13 — MEDIUM: No authorization check in `Resolvers.Things` — customer from user input, not from authenticated session**

File: `lib/api_server_web/resolvers/things.ex`.

```elixir
def find_thing(_parent, %{aadhardwareid: hardwareid, customer: customer}, _resolution) do
  ...ApiServer.Vx.get_vx_thing_with_hardware_id!(hardwareid, customer)
```

```elixir
def get_all_things(_parent, %{customer: customer}, _resolution) do
  ...ApiServer.Vx.list_vxthings(customer)
```

Both resolvers accept `customer` directly from the GraphQL argument (`_resolution` parameter is ignored entirely). The `resolution` object carries the authenticated user's context including their org, but it is not consulted. An authenticated user could supply any `customer` value in the query and receive data for that organisation. This is an IDOR / cross-tenant data exposure.

Note: The GraphQL endpoint is currently commented out in the router (lines 195–202), so exploitation is not currently possible via HTTP. However the resolvers exist and would be exploitable if the endpoint is re-enabled. The pattern should be corrected regardless.

---

**A119-14 — MEDIUM: No authorization check in `Resolvers.Puls` — hardwareid from user input only**

File: `lib/api_server_web/resolvers/puls.ex`.

```elixir
def puls_record(parent, %{hardwareid: hardwareid}, resolution) do
```

`resolution` is accepted but never inspected. There is no check that the caller's authenticated organisation owns or is permitted to query the supplied `hardwareid`. Any authenticated user (if the GraphQL endpoint is re-enabled) could enumerate hardware IDs across all customers. ESNs, ICCIDs, and CalAmp group assignments would be returned.

---

**A119-15 — MEDIUM: `erp_import` and `driverid_converter` are unauthenticated**

Routes in scope `/` (`:api_xml` only):
```elixir
post("/erp-import",          UtilityController, :erp_import)
post("/driverid-converter",  UtilityController, :driverid_converter)
```

`erp_import/2` receives rental records and service records from an external source and writes them to the database. Customer selection is determined by the `from` field in the POST body — which is caller-controlled. An unauthenticated caller can inject arbitrary rental and service data into any customer database whose `from` address is known or guessable. `driverid_converter` similarly processes driver identity data without authentication. Both endpoints appear to be intended for machine-to-machine calls from known sources (e.g., `"SQLserver@sielift.com"`), but there is no token, shared secret, IP allowlist, or signature validation in the router or the controller.

---

**A119-16 — MEDIUM: `/dis-sync` triggers an outbound third-party API call without authentication**

Route in scope `/` (`:api_xml` only):
```elixir
get("/dis-sync", UtilityController, :sync_to_DISCorp)
```

Any unauthenticated caller can trigger a synchronisation of equipment hour-meter data to DISCorp, consuming the hardcoded API key (A119-5). No authentication, rate limiting, or authorisation is applied.

---

### §3: Input Validation and Injection

**A119-17 — MEDIUM: Unbounded recursive retry in `puls_record/3` — potential DoS / process exhaustion**

File: `lib/api_server_web/resolvers/puls.ex`, lines 12–17.

```elixir
:error ->
    IO.puts "Will attempt Re-send"
    receive do
    after
        60_000 ->
            puls_record(parent, %{hardwareid: hardwareid}, resolution)
    end
```

On HTTP error, the resolver waits 60 seconds and retries by recursing into itself — with no retry limit, no circuit breaker, and no backoff ceiling. If the CalAmp endpoint is persistently unavailable, this process will recurse indefinitely (until it hits Erlang's process stack limit). If multiple such queries arrive concurrently, request processes will pile up in the 60-second wait state, exhausting the available BEAM process pool and causing application-wide denial of service.

---

**A119-18 — LOW: `hardwareid` from user input interpolated directly into an external HTTP URL**

File: `lib/api_server_web/resolvers/puls.ex`, line 5.

```elixir
url = "https://puls.calamp.com/service2/lmu/#{hardwareid}"
```

`hardwareid` originates directly from the GraphQL argument without sanitization. While HTTPoison will percent-encode path segments in most cases, there is no explicit validation that `hardwareid` is numeric. A crafted value could cause unexpected URL construction (e.g., path traversal or query string injection into the CalAmp URL). The value should be validated as a numeric string before use.

---

### §4: Session and CSRF

**A119-19 — MEDIUM: `protect_from_forgery` is in the `:browser` pipeline which is never used**

The `:browser` pipeline (lines 4–10) defines `protect_from_forgery`. However, no scope in the router uses `pipe_through(:browser)`. All API scopes use `:api` or `:api_xml` which do not include CSRF protection. This is acceptable for a pure JSON/XML API that uses Bearer token authentication. Confirmed acceptable — noting only for completeness.

---

**A119-20 — INFO: `check_origin` configuration not visible in router; endpoint config not reviewed in this pass**

`check_origin` applies to WebSocket/channel connections. No channels are defined in the reviewed files. No finding raised; recommend verifying in `endpoint.ex`.

---

### §5: File and Data Handling

**A119-21 — HIGH: `send_file_download` returns access-fob keying material to unauthenticated callers**

(See A119-9 above.) The binary file returned by `FileController.send_file_download/2` contains concatenated `fob_code` values and a CRC, which constitutes physical access control keying material. Serving this to unauthenticated callers over the public internet is a physical security risk in addition to a logical security risk.

---

**A119-22 — MEDIUM: Internal diagnostic output (`IO.puts`, `IO.inspect`) present in production resolvers and controllers**

File: `lib/api_server_web/resolvers/puls.ex`, line 11: `IO.puts "Will attempt Re-send"`
File: `lib/api_server_web/controllers/file_controller.ex`, lines 16–17: `IO.puts "#{inspect length(thing.fleet_thing_joins)} #{inspect thing.fleet_thing_joins}"`
File: `lib/api_server_web/controllers/file_controller.ex`, line 45: `IO.puts "CRC: #{inspect crc}"`
File: `lib/api_server_web/controllers/file_controller.ex`, line 46: `IO.puts "CRC_String: #{inspect crc16_xmodem}"`

`IO.puts` and `IO.inspect` write to stdout, not to the structured Logger. They bypass log level filtering and will appear in production logs unconditionally, potentially leaking fleet join data, hardware IDs, and CRC values. Logger with appropriate level (`:debug`) should be used and these calls should be removed from production paths.

---

**A119-23 — MEDIUM: Cross-customer data exposure in `VXThingSummaryController.index`**

`Vx.list_vxthingsummaries()` returns all summaries across all customer organisations. The caller supplies no customer context, and the result is not filtered. Combined with the lack of authentication on this endpoint (A119-8), any caller receives all customers' thing summaries in a single call.

---

**A119-24 — INFO: `create_thing` error response leaks internal changeset details**

File: `lib/api_server_web/controllers/vx_thing_controller.ex`, line 250 (approximate):

```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")
```

`inspect changeset` on an Ecto changeset struct will include all field values and constraint errors in the response. This may expose database column names, validation rules, and partial data values to the client.

---

### §6: Dependencies

§6: Not assessed in this pass (assigned files do not include `mix.exs` or `mix.lock`). Defer to dedicated dependency audit pass.

---

### §7: Infrastructure Exposure

**A119-25 — HIGH: CalAmp PULS service URL and credentials expose external telematics infrastructure**

File: `lib/api_server_web/resolvers/puls.ex`, line 5:
```elixir
url = "https://puls.calamp.com/service2/lmu/#{hardwareid}"
```

Combined with the hardcoded credential (A119-4), this reveals the specific CalAmp endpoint path used for LMU device queries, the account used, and the credential. This information is sufficient to directly query the CalAmp API for any known hardware ID without going through the api_server application.

---

**A119-26 — HIGH: DISCorp endpoint URL and API key hardcoded in source**

File: `lib/api_server_web/controllers/utility_controller.ex`:
```elixir
api_key = "PZPwWHyAMFhPbt3UB8PWXtEw"
url = "https://407110-01.disprism.com/updateEquipmentHourMeter"
```

The account-specific subdomain `407110-01.disprism.com` identifies the customer account within DISCorp's infrastructure. Combined with the API key, this constitutes full credentials for direct API access to that DISCorp account.

---

**A119-27 — INFO: Duplicate route definition**

Router lines 92–100 define `GET /rhm/omega_fleet/:fleetid/operation_summary_report` twice with identical controller and action. The second definition is unreachable and the duplication may indicate copy-paste error or an incomplete refactoring.

---

## Summary of Findings

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A119-1 | CRITICAL | `auth_pipeline.ex` | `EnsureAuthenticated` commented out — tokens not enforced |
| A119-2 | CRITICAL | `config/config.exs` | Guardian JWT signing key hardcoded in tracked source |
| A119-3 | CRITICAL | `config/prod.secret.exs` | Production `secret_key_base` committed to version control |
| A119-4 | CRITICAL | `resolvers/puls.ex` | CalAmp API Basic Auth credential hardcoded in source |
| A119-5 | HIGH | `utility_controller.ex` | DISCorp API key hardcoded in source |
| A119-6 | HIGH | `config/config.exs` | Guardian TTL 52 weeks with no revocation mechanism |
| A119-7 | CRITICAL | `auth_pipeline.ex` | Auth pipeline does not reject unauthenticated requests |
| A119-8 | CRITICAL | `router.ex` / `vx_thing_summary_controller.ex` | Full CRUD on VXThingSummary unauthenticated and cross-tenant |
| A119-9 | HIGH | `router.ex` / `file_controller.ex` | Access-fob key material download requires no authentication |
| A119-10 | HIGH | `router.ex` | Multiple VX fleet data endpoints unauthenticated |
| A119-11 | HIGH | `router.ex` | Administrative `fix_info` action unauthenticated |
| A119-12 | HIGH | `router.ex` | Engine usage and hour-meter routes have no pipeline at all |
| A119-13 | MEDIUM | `resolvers/things.ex` | `customer` taken from GraphQL args; `resolution` context ignored — IDOR |
| A119-14 | MEDIUM | `resolvers/puls.ex` | No authorisation check; `resolution` context ignored |
| A119-15 | MEDIUM | `router.ex` | `erp-import` and `driverid-converter` unauthenticated |
| A119-16 | MEDIUM | `router.ex` | `dis-sync` triggers privileged third-party call unauthenticated |
| A119-17 | MEDIUM | `resolvers/puls.ex` | Unbounded recursive retry — process exhaustion / DoS |
| A119-18 | LOW | `resolvers/puls.ex` | `hardwareid` interpolated into external URL without validation |
| A119-19 | MEDIUM | `router.ex` | CSRF plug in unused `:browser` pipeline (informational) |
| A119-20 | INFO | `router.ex` | `check_origin` not verified in this pass |
| A119-21 | HIGH | `file_controller.ex` | Physical access-fob keying material served unauthenticated |
| A119-22 | MEDIUM | multiple | `IO.puts`/`IO.inspect` in production code leaks data to stdout |
| A119-23 | MEDIUM | `vx_thing_summary_controller.ex` | `index` returns all customers' summaries with no scoping |
| A119-24 | INFO | `vx_thing_controller.ex` | Ecto changeset details exposed in error response |
| A119-25 | HIGH | `resolvers/puls.ex` | CalAmp telematics URL + credential reveals external infrastructure |
| A119-26 | HIGH | `utility_controller.ex` | DISCorp account URL + API key reveals external infrastructure |
| A119-27 | INFO | `router.ex` | Duplicate route definition for `operation_summary_report` |
