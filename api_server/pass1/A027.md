# Audit Report A027
**Agent:** A027
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix (vendored geonames-elixir)
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `geonames-elixir/lib/geonames/endpoints/find_nearby_streets.ex`
2. `geonames-elixir/lib/geonames/endpoints/find_nearby_streets_osm.ex`
3. `geonames-elixir/lib/geonames/endpoints/find_nearby_weather.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/find_nearby_streets.ex`

**Module name:** `Geonames.Endpoints.FindNearbyStreets`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 11 |
| `available_url_parameters` | 0 | 12 |
| `required_url_parameters` | 0 | 13 |
| `function_name` | 0 | 14 |
| `url_arguments` | 1 | 16 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None. (`@behaviour Geonames.Endpoint` at line 3.)

**Module attributes:**

```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  maxRows: 10
}
```

---

### File 2: `geonames-elixir/lib/geonames/endpoints/find_nearby_streets_osm.ex`

**Module name:** `Geonames.Endpoints.FindNearbyStreetsOSM`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None. (`@behaviour Geonames.Endpoint` at line 3.)

**Module attributes:**

```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  radius: nil,
  maxRows: 10
}
```

---

### File 3: `geonames-elixir/lib/geonames/endpoints/find_nearby_weather.ex`

**Module name:** `Geonames.Endpoints.FindNearbyWeather`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 11 |
| `available_url_parameters` | 0 | 12 |
| `required_url_parameters` | 0 | 13 |
| `function_name` | 0 | 14 |
| `url_arguments` | 1 | 16 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None. (`@behaviour Geonames.Endpoint` at line 3.)

**Module attributes:**

```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  radius: nil
}
```

---

## Supporting Context Read

To understand the full data flow the following additional files were read:

- `geonames-elixir/lib/geonames/endpoint.ex` — defines the `Geonames.Endpoint` behaviour callbacks.
- `geonames-elixir/lib/geonames/helpers.ex` — contains `build_url_string/2` and `user_configuration/0`; assembles the outgoing HTTP URL.
- `geonames-elixir/lib/geonames.ex` — uses compile-time metaprogramming (`for endpoint <- endpoints do`) to generate one public wrapper function per endpoint; calls `url_arguments/1` then `Helpers.build_url_string/2` then `HTTPoison.get/1`.
- `geonames-elixir/mix.exs` — dependency declarations for the vendored library.

---

## Checklist Review

### §1: Secrets and Configuration

The three assigned endpoint modules contain no configuration, credentials, API keys, or environment variable references.

For completeness: the broader `Geonames.Helpers` module (read as supporting context) references `Application.get_env(:geonames, :username)` and `System.get_env("GEONAMES_USERNAME")`. This is outside the scope of the assigned files but establishes that the GeoNames API username credential is expected from application config or environment — not hardcoded in these endpoint modules.

§1: No issues found in the assigned files.

---

### §2: Authentication and Authorization

The three modules implement purely structural/metadata functions. They define URL parameter maps and endpoint name strings. They perform no authentication, issue no tokens, handle no sessions, and enforce no authorisation logic.

No Guardian usage, no password handling, no IDOR surface.

§2: No issues found.

---

### §3: Input Validation and Injection

**`url_arguments/1` — unfiltered merge (MEDIUM)**

All three modules implement `url_arguments/1` identically:

```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`provided_arguments` is the caller-supplied map. `Map.merge/2` replaces every key in `@default_arguments` with whatever the caller provides but also — critically — **passes through every extra key the caller includes that is not in `@default_arguments`**. Because `Map.merge/2` retains all keys from both maps, a caller can inject arbitrary additional query-string parameters into the outgoing GeoNames API request.

The downstream path in `Geonames.Helpers.build_url_string/2` iterates over every key/value pair in the merged map without filtering to `available_url_parameters`, so every extra key supplied by the caller is appended to the URL query string that is sent to `api.geonames.org`.

Concretely for the three assigned endpoints:

- `FindNearbyStreets` — declared keys: `lat`, `lng`, `maxRows`. A caller passing `%{lat: x, lng: y, username: "attacker", style: "FULL", ...}` would inject those into the upstream API call.
- `[REDACTED-AWS-SMTP-PASSWORD]` — declared keys: `lat`, `lng`, `radius`, `maxRows`.
- `FindNearbyWeather` — declared keys: `lat`, `lng`, `radius`.

The practical impact depends on how tightly the rest of the application controls what goes into `provided_arguments`. If `provided_arguments` originates from validated, controller-level params this is lower risk. If it is derived directly from raw user-supplied HTTP query parameters (which must be investigated in the calling controllers — outside the scope of these three files), an attacker could:

1. Override the `username` parameter, routing API quota to an arbitrary GeoNames account.
2. Inject `style`, `lang`, or other parameters that alter the shape of the response returned to the caller.
3. Inject a crafted `callback` parameter (if GeoNames JSONP is enabled on the account) to attempt to alter response parsing.

This is flagged as a finding because no allowlist filter is applied in these modules; the behaviour contracts (`available_url_parameters/0`) are never enforced by `url_arguments/1` itself.

**`String.to_atom` / unsafe deserialization:** Not present in any assigned file.

**Raw SQL / Ecto fragments:** Not present; these modules have no database interaction.

---

### §4: Session and CSRF

Not applicable to these endpoint descriptor modules. No session, cookie, or WebSocket logic is present.

§4: No issues found.

---

### §5: File and Data Handling

**GPS coordinate pass-through to third-party API (INFO)**

`FindNearbyStreets`, `[REDACTED-AWS-SMTP-PASSWORD]`, and `FindNearbyWeather` all accept `lat`/`lng` as required URL parameters and forward them to `api.geonames.org` without masking or anonymisation. In the context of a fleet management backend, these coordinates may represent real-time vehicle positions.

This is an architectural observation rather than a code defect in these modules. The data flow must be reviewed at the layer that calls these functions to confirm: (a) the GeoNames API is an authorised processor of fleet GPS data under the applicable data-sharing agreements and privacy policy, and (b) coordinates are not logged at DEBUG/INFO level by `HTTPoison` or the application logger before or after transmission.

**PII in Logger:** No `Logger` calls appear in any of the three assigned files.

**Error responses / stack traces:** These modules raise no errors; error handling is in `Geonames` (the wrapper) and is out of scope here.

§5: No issues found (INFO observation noted below as A027-2).

---

### §6: Dependencies

The `mix.exs` for the vendored library specifies:

```elixir
{:poison, "~> 3.1"},
{:httpoison, "~> 1.0"},
{:ex_doc, "~> 0.12", only: :dev}
```

- `poison ~> 3.1`: Poison 3.x is an old major version. Poison 4.x and 5.x were released with bug fixes. No known CVEs in 3.x affect confidentiality directly but the version constraint is loose and outdated.
- `httpoison ~> 1.0`: HTTPoison 1.x is significantly behind the current release line (2.x). No critical CVEs at time of writing, but the constraint is loose.
- `ex_doc ~> 0.12`: dev-only; no runtime impact.
- No `git:` source URLs are present — all dependencies are fetched from hex.pm.
- `mix.lock` is present in the vendored directory; exact pinning is therefore in use for reproducible builds.

The concern is that these are vendored files bundled inside the `api_server` repo. Whether the parent `api_server` `mix.exs`/`mix.lock` or this inner `mix.exs` governs the actual resolved versions needs to be confirmed. If this inner `mix.exs` is active, the loose `~>` constraints on Poison and HTTPoison may resolve to outdated patch versions depending on what is in the corresponding `mix.lock`.

§6: One finding noted below (A027-3).

---

### §7: Infrastructure Exposure

**Hardcoded base URL to external third-party service (LOW)**

In `Geonames.Helpers` (supporting context):

```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default value `"api.geonames.org/"` is hardcoded. If the application config does not override `:base_url`, all GeoNames traffic targets the public internet endpoint. This is the intended design of the library and not a secret exposure, but it means:

- There is no TLS enforcement in the base URL default (no `https://` prefix — the scheme is absent, meaning downstream URL construction in `build_url_string/2` produces scheme-less URLs of the form `api.geonames.org/findNearbyStreetsJSON?...`).
- Without `https://`, `HTTPoison.get/1` behaviour depends on whether HTTPoison applies a default scheme. If it does not, the connection may fall back to plain HTTP, transmitting GPS coordinates in cleartext.

This is directly relevant to the assigned files because the endpoint strings returned by `endpoint/0` in all three modules are used as path components in that URL.

§7: One finding noted below (A027-4).

---

## Findings

### A027-1
**Severity:** MEDIUM
**File:** All three assigned files
- `geonames-elixir/lib/geonames/endpoints/find_nearby_streets.ex` line 16-18
- `geonames-elixir/lib/geonames/endpoints/find_nearby_streets_osm.ex` line 17-19
- `geonames-elixir/lib/geonames/endpoints/find_nearby_weather.ex` line 16-18

**Title:** `url_arguments/1` performs an unfiltered map merge — arbitrary caller-supplied keys are forwarded to the upstream GeoNames API

**Detail:**

```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`Map.merge/2` retains all keys from both maps. Any key present in `provided_arguments` but absent from `@default_arguments` is silently passed through and ultimately appended to the outbound URL query string by `Geonames.Helpers.build_url_string/2`. The `available_url_parameters/0` allowlist is declared but never enforced at this layer.

**Impact:**
A caller (or, if callers pass raw HTTP params, an end-user) can inject extra GeoNames query parameters. Likely impacts: `username` override (routing API usage to attacker-controlled account, exhausting quota or bypassing rate limiting tied to the application's own account), `style` override (changing response verbosity), and potential `callback` injection affecting JSON response parsing if JSONP is active.

**Recommendation:**
Filter `provided_arguments` to only permitted keys before merging, or post-filter the merged map:

```elixir
def url_arguments(provided_arguments) do
  allowed = MapSet.new(available_url_parameters())
  filtered = Map.filter(provided_arguments, fn {k, _} -> MapSet.member?(allowed, k) end)
  Map.merge(@default_arguments, filtered)
end
```

This change must be applied consistently across all endpoint modules that use the same pattern.

---

### A027-2
**Severity:** INFO
**File:** All three assigned files (data flow concern)

**Title:** GPS coordinates for `lat`/`lng` are forwarded to an external third-party API (`api.geonames.org`) without documented consent or data-flow review

**Detail:**
The `FindNearbyStreets`, `[REDACTED-AWS-SMTP-PASSWORD]`, and `FindNearbyWeather` endpoints require `lat` and `lng` as mandatory parameters, which are then transmitted to the public GeoNames API. In the context of a fleet management backend, these coordinates likely represent real-time or recent vehicle positions, which may constitute personal data or commercially sensitive asset tracking data.

**Impact:**
If GPS coordinates belong to tracked drivers or customer fleet assets, their transmission to a third-party service requires explicit authorisation under the applicable privacy policy and data processing agreements. No evidence of such review is visible in these files.

**Recommendation:**
Confirm with the data/privacy owner that `api.geonames.org` is an approved data processor for fleet GPS coordinates. Verify that no DEBUG/INFO logger calls in the calling layers log raw lat/lng values. Consider whether coordinates should be coarsened (reduced precision) before forwarding to the third-party service.

---

### A027-3
**Severity:** LOW
**File:** `geonames-elixir/mix.exs`

**Title:** Vendored library uses outdated, loosely-pinned dependency versions for `poison` and `httpoison`

**Detail:**
The vendored `mix.exs` pins `{:poison, "~> 3.1"}` and `{:httpoison, "~> 1.0"}`. Poison 3.x is multiple major versions behind current (5.x); HTTPoison 1.x is behind 2.x. The `~>` operator allows automatic resolution to any newer patch/minor within the stated major, but the declared floor versions are old.

**Impact:**
If this inner `mix.exs` governs resolution (i.e., if the parent `api_server` project does not override these constraints in its own lockfile), the application may be running on old dependency versions that lack security patches or bug fixes accumulated in later releases. Additionally, Poison 3.x may be susceptible to atom exhaustion when decoding JSON with unknown keys if `keys: :atoms` mode is used (not visible in these files but possible in calling code).

**Recommendation:**
Update `mix.exs` constraints to current stable releases (`{:poison, "~> 5.0"}`, `{:httpoison, "~> 2.0"}`), regenerate `mix.lock`, and run the test suite. Confirm the parent `api_server` lockfile pins exact resolved versions.

---

### A027-4
**Severity:** LOW
**File:** `geonames-elixir/lib/geonames/helpers.ex` (supporting context for assigned files)

**Title:** Default base URL has no scheme — outbound HTTP requests to GeoNames may use plain HTTP, transmitting GPS coordinates in cleartext

**Detail:**
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default value `"api.geonames.org/"` contains no URL scheme. The constructed URL (e.g. `api.geonames.org/findNearbyStreetsJSON?lat=...&lng=...`) is passed to `HTTPoison.get/1`. HTTPoison's `hackney` backend interprets scheme-less URLs as HTTP by default, meaning GPS coordinates transmitted via all three assigned endpoint modules may travel over an unencrypted connection if the application config does not explicitly override `:base_url` with `"https://api.geonames.org/"`.

**Impact:**
GPS coordinates (`lat`, `lng`) and the GeoNames API username are sent in plaintext over HTTP, exposing them to network eavesdropping on any path between the server and the GeoNames API.

**Recommendation:**
Set the default to `"https://api.geonames.org/"` and, if possible, configure HTTPoison/hackney to enforce TLS certificate verification for outbound connections.

---

## Summary Table

| ID | Severity | Title |
|---|---|---|
| A027-1 | MEDIUM | `url_arguments/1` unfiltered map merge allows arbitrary parameter injection to upstream GeoNames API |
| A027-2 | INFO | GPS coordinates forwarded to third-party API without documented data-flow/privacy review |
| A027-3 | LOW | Vendored library uses outdated, loosely-pinned `poison` and `httpoison` versions |
| A027-4 | LOW | Default base URL has no scheme — outbound requests may use plain HTTP |

No CRITICAL or HIGH severity issues were identified in the assigned files.
