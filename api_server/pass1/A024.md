# Audit Report: A024
**Agent:** A024
**Run:** 2026-02-27-01
**Pass:** 1
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `geonames-elixir/lib/geonames/endpoints/find_nearby_place_name.ex`
2. `geonames-elixir/lib/geonames/endpoints/find_nearby_pois_osm.ex`
3. `geonames-elixir/lib/geonames/endpoints/find_nearby_postal_codes.ex`

---

## Reading Evidence

---

### File 1: `geonames-elixir/lib/geonames/endpoints/find_nearby_place_name.ex`

**Module name:** `Geonames.Endpoints.FindNearbyPlaceName`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 15 |
| `available_url_parameters` | 0 | 16 |
| `required_url_parameters` | 0 | 17 |
| `function_name` | 0 | 18 |
| `url_arguments` | 1 | 20 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None. Only `@behaviour Geonames.Endpoint` declared at line 3.

**Module attributes:**

- `@moduledoc false` (line 2)
- `@default_arguments` map literal (lines 5–13): `%{lat: nil, lng: nil, radius: nil, maxRows: 10, style: "MEDIUM", localCountry: true, cities: nil}`

**Summary of behaviour:** Implements `Geonames.Endpoint` behaviour. Declares the GeoNames REST endpoint path `"findNearbyPlaceNameJSON"`, the set of accepted URL parameters, the required parameters (`:lat` and `:lng`), and merges caller-supplied arguments over defaults in `url_arguments/1`.

---

### File 2: `geonames-elixir/lib/geonames/endpoints/find_nearby_pois_osm.ex`

**Module name:** `Geonames.Endpoints.FindNearbyPOIsOSM`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None. Only `@behaviour Geonames.Endpoint` declared at line 3.

**Module attributes:**

- `@moduledoc false` (line 2)
- `@default_arguments` map literal (lines 5–10): `%{lat: nil, lng: nil, radius: nil, maxRows: nil}`

**Summary of behaviour:** Implements `Geonames.Endpoint` behaviour. Declares the GeoNames REST endpoint path `"findNearbyPOIsOSMJSON"`, the set of accepted URL parameters, the required parameters (`:lat` and `:lng`), and merges caller-supplied arguments over defaults in `url_arguments/1`.

---

### File 3: `geonames-elixir/lib/geonames/endpoints/find_nearby_postal_codes.ex`

**Module name:** `Geonames.Endpoints.FindNearbyPostalCodes`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 17 |
| `available_url_parameters` | 0 | 18 |
| `required_url_parameters` | 0 | 19 |
| `function_name` | 0 | 20 |
| `url_arguments` | 1 | 22 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None. Only `@behaviour Geonames.Endpoint` declared at line 3.

**Module attributes:**

- `@moduledoc false` (line 2)
- `@default_arguments` map literal (lines 5–15): `%{lat: nil, lng: nil, postalCode: nil, country: nil, radius: nil, maxRows: 5, style: "MEDIUM", localCountry: nil, cities: nil}`

**Summary of behaviour:** Implements `Geonames.Endpoint` behaviour. Declares the GeoNames REST endpoint path `"findNearbyPostalCodesJSON"`, the set of accepted URL parameters, declares **no** required parameters (`required_url_parameters/0` returns `[]`), and merges caller-supplied arguments over defaults in `url_arguments/1`.

---

## Checklist Review

### §1: Secrets and Configuration

No config files, environment variable access, credentials, API keys, secret key bases, hardcoded AWS endpoints, RDS hostnames, or pipeline YAML are present in any of these three files. All module attributes are benign string/atom/boolean/nil literals.

§1: No issues found.

---

### §2: Authentication and Authorization

These are pure endpoint-descriptor modules. They define no routes, no plugs, no pipeline registrations, no Guardian configuration, no password handling, and no authentication or authorisation logic. They do not fetch or return data directly — they only declare metadata that the `Geonames` client library uses to construct outbound HTTP query strings.

§2: No issues found.

---

### §3: Input Validation and Injection

All three modules expose a single data-transformation function `url_arguments/1`, which merges a caller-supplied map over a compile-time default map using `Map.merge/2`. The following potential concerns were evaluated:

**No atom creation from user input.** `Map.merge/2` merges values but does not create new atoms from string input; the keys in `@default_arguments` are compile-time atom literals and `Map.merge/2` will only retain keys that appear in the merged result. The caller-supplied map `provided_arguments` is merged *into* `@default_arguments`, meaning caller keys that do not exist in `@default_arguments` are *preserved* in the resulting map (standard `Map.merge/2` keeps all keys from both maps, with the second argument's values winning on collision).

**Key injection via caller-supplied map.** Because `Map.merge(@default_arguments, provided_arguments)` retains all keys from `provided_arguments`, a caller can inject arbitrary additional key/value pairs into the returned map. Whether those extra keys are harmful depends entirely on how the calling layer (the GeoNames HTTP client) serialises the result into a query string. If the HTTP client appends all map keys as query string parameters and passes the result to the GeoNames API, an attacker who controls `provided_arguments` could append arbitrary query parameters to the outbound GeoNames API request. This is a low-severity concern in this context because: (a) the GeoNames API is an external third-party service, not an internal sensitive backend; (b) the risk of exfiltration or privilege escalation against GeoNames via extra query parameters is minimal; (c) the actual attack surface depends on the calling layer, not these modules. The modules themselves do not validate or whitelist the keys in `provided_arguments`.

**No SQL, Ecto fragments, `String.to_atom/1`, `binary_to_term/1`, `Code.eval_string/1`, or `Kernel.apply/3` are present in any of the three files.**

**Finding recorded below (A024-1).**

---

### §4: Session and CSRF

No session handling, cookie configuration, CSRF tokens, WebSocket channels, or Phoenix endpoint configuration are present in these files.

§4: No issues found.

---

### §5: File and Data Handling

No file I/O, Logger calls, error views, PII handling, GPS coordinate logging, or fleet/driver/vehicle data processing are present in these files.

§5: No issues found.

---

### §6: Dependencies

These files contain no `mix.exs` or `mix.lock` content, no dependency declarations, and no `git:` source URLs. Dependency review for the geonames-elixir vendored library as a whole is out of scope for these three specific modules but is noted as requiring coverage elsewhere in the audit.

§6: No issues found (within scope of these three files).

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IP addresses, port numbers, CORS configuration, TLS settings, or inter-service call logic are present in these files. The only string literals are GeoNames API endpoint path suffixes (`"findNearbyPlaceNameJSON"`, `"findNearbyPOIsOSMJSON"`, `"findNearbyPostalCodesJSON"`), `"MEDIUM"` (a style parameter value), which are non-sensitive.

§7: No issues found.

---

## Findings

### A024-1
**Severity:** LOW
**File:** All three endpoint modules
- `geonames-elixir/lib/geonames/endpoints/find_nearby_place_name.ex` line 21
- `geonames-elixir/lib/geonames/endpoints/find_nearby_pois_osm.ex` line 18
- `geonames-elixir/lib/geonames/endpoints/find_nearby_postal_codes.ex` line 23

**Description:** `url_arguments/1` uses `Map.merge(@default_arguments, provided_arguments)` without whitelisting keys in `provided_arguments`. Because `Map.merge/2` retains all keys from both operands, a caller that passes a map containing keys not declared in `@default_arguments` will have those extra keys present in the returned map. If the upstream HTTP client serialises all map entries as outbound query string parameters, a caller with control over `provided_arguments` could inject arbitrary query parameters into requests sent to the GeoNames API.

**Code:**
```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

**Risk:** Low. The target is the third-party GeoNames geocoding API — there is no known privilege-escalation path via extra query parameters against that service, and no internal sensitive data is at risk from this specific call. However the pattern is inconsistent with the defensive posture expected of a validated-input codebase: callers should only be able to supply values for declared parameters.

**Recommendation (for Pass 2 review):** Consider replacing `Map.merge/2` with an explicit take-and-merge that restricts accepted keys to `available_url_parameters/0`, e.g.:

```elixir
def url_arguments(provided_arguments) do
  filtered = Map.take(provided_arguments, available_url_parameters())
  Map.merge(@default_arguments, filtered)
end
```

This is a pattern-consistency and defence-in-depth recommendation, not an immediately exploitable vulnerability.

---

### A024-2
**Severity:** INFO
**File:** `geonames-elixir/lib/geonames/endpoints/find_nearby_postal_codes.ex` line 19

**Description:** `required_url_parameters/0` returns an empty list `[]`, meaning the `[REDACTED-AWS-SMTP-PASSWORD]` endpoint declares no required parameters. This is divergent from the other two modules (which both require `:lat` and `:lng`). The GeoNames `[REDACTED-AWS-SMTP-PASSWORD]` endpoint can be driven by either coordinates (`lat`/`lng`) or a postal code (`postalCode`/`country`), so no single parameter is universally required, making this arguably correct. However, it means the `Geonames.Endpoint` behaviour's required-parameter enforcement (if any) provides no protection against a call that supplies neither coordinates nor a postal code. Whether the upstream client or calling code compensates for this is outside the scope of these three files.

**Risk:** Informational. Not a security vulnerability in isolation; flagged for awareness so downstream validation logic can be confirmed in Pass 2.

---

## Summary Table

| ID | Severity | File(s) | Title |
|---|---|---|---|
| A024-1 | LOW | All three endpoint modules | `url_arguments/1` does not whitelist caller-supplied map keys |
| A024-2 | INFO | `find_nearby_postal_codes.ex` | `required_url_parameters/0` returns empty list — no coordinate or postal-code requirement enforced at this layer |

---

*End of report A024.*
