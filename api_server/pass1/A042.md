# Audit Report A042
**Agent:** A042
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

**Assigned files:**
- `geonames-elixir/lib/geonames/endpoints/postal_code_search.ex`
- `geonames-elixir/lib/geonames/endpoints/search.ex`
- `geonames-elixir/lib/geonames/endpoints/siblings.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/postal_code_search.ex`

**Module name:** `Geonames.Endpoints.PostalCodeSearch`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 22 |
| `available_url_parameters` | 0 | 23 |
| `required_url_parameters` | 0 | 24 |
| `function_name` | 0 | 25 |
| `url_arguments` | 1 | 27 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None (only `@behaviour Geonames.Endpoint` at line 3).

**Module-level `plug` / `pipeline`:** None.

**Module attribute `@default_arguments`** (line 5-20): atom-keyed map with 14 postal-code search parameters; all default to `nil` or `false`/`10`.

---

### File 2: `geonames-elixir/lib/geonames/endpoints/search.ex`

**Module name:** `Geonames.Endpoints.Search`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 35 |
| `available_url_parameters` | 0 | 36 |
| `required_url_parameters` | 0 | 37 |
| `function_name` | 0 | 38 |
| `url_arguments` | 1 | 40 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None (only `@behaviour Geonames.Endpoint` at line 3).

**Module-level `plug` / `pipeline`:** None.

**Module attribute `@default_arguments`** (line 5-33): atom-keyed map with 27 free-text search parameters; all default to `nil`.

---

### File 3: `geonames-elixir/lib/geonames/endpoints/siblings.ex`

**Module name:** `Geonames.Endpoints.Siblings`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 9 |
| `available_url_parameters` | 0 | 10 |
| `required_url_parameters` | 0 | 11 |
| `function_name` | 0 | 12 |
| `url_arguments` | 1 | 14 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None (only `@behaviour Geonames.Endpoint` at line 3).

**Module-level `plug` / `pipeline`:** None.

**Module attribute `@default_arguments`** (line 5-7): atom-keyed map with single key `:geonameId` defaulting to `nil`.

---

## Supporting-file Evidence (read for context, not assigned)

The following files were read to understand how the three assigned endpoint modules are consumed:

- `geonames-elixir/lib/geonames/endpoint.ex` — defines the `Geonames.Endpoint` behaviour callbacks.
- `geonames-elixir/lib/geonames/helpers.ex` — `build_url_string/2` assembles the outbound HTTP request URL; `user_configuration/0` reads `username` / `language` from application env or system env.
- `geonames-elixir/lib/geonames.ex` — macro loop generates one public function per endpoint module; calls `url_arguments/1` then `Helpers.build_url_string/2` then `HTTPoison.get/1`; decodes response with `Poison.decode!/1`.
- `geonames-elixir/mix.exs` and `geonames-elixir/mix.lock` — vendored library manifest and lockfile.
- `lib/api_server_web/controllers/utility_controller.ex` (lines 991-1050) — call-site in the main application.

---

## Checklist Review

### §1: Secrets and Configuration

The three assigned files contain no credentials, API keys, or connection strings.

**Supporting-file observation relevant to §1:**

In `geonames-elixir/lib/geonames/helpers.ex` line 8:

```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default base URL is a hard-coded literal. This is a compile-time default, not a runtime environment variable. If the deploying project does not override `:geonames, :base_url` in its own config, all outbound API calls silently use the literal default. This is noted as INFO — it is a common pattern for a vendored wrapper library, and the value itself is not a secret.

In `geonames-elixir/lib/geonames/helpers.ex` line 52-56 (`user_configuration/0`):

```elixir
username: Application.get_env(:geonames, :username) || System.get_env("GEONAMES_USERNAME"),
language: Application.get_env(:geonames, :language, System.get_env("GEONAMES_LANGUAGE") || "en")
```

The GeoNames API username is read from application env or the environment variable `GEONAMES_USERNAME`. No hardcoded credential is present in the three assigned files or in `helpers.ex`. This is acceptable.

**A042-1 — INFO — Hardcoded base URL default in vendored library**
`geonames-elixir/lib/geonames/helpers.ex` line 8: the default `@base_url` value `"api.geonames.org/"` is compiled in. If `Application.get_env(:geonames, :base_url)` is not configured in the host project, all three endpoint modules' calls are silently routed to this compile-time default. The risk is low (the URL is a public API, not a secret), but it means a misconfigured deployment cannot be detected at runtime. Documented for completeness.

§1: No further issues found in the assigned files.

---

### §2: Authentication and Authorization

The three files define pure data/configuration modules. They have no routes, no plugs, no Guardian usage, no password handling, and no resource ownership checks. They do not implement or bypass any authentication layer. The endpoint modules are internal library building blocks; authentication is the caller's responsibility.

No issues arising from the assigned files themselves.

**Supporting-file observation:** `geonames.ex` calls `HTTPoison.get(url)` where the URL contains the GeoNames API `username` credential as a query parameter (assembled by `helpers.ex`). This is an outbound API call to a third-party service, not an inbound authenticated endpoint. The credential-as-query-parameter pattern is standard for the GeoNames API and not controllable by this library. Not a finding against the assigned files.

§2: No issues found.

---

### §3: Input Validation and Injection

This is the most significant area of concern for these modules.

**How user input flows through the assigned modules:**

All three modules implement `url_arguments/1` identically:

```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`provided_arguments` is whatever map the caller passes (e.g., `Geonames.search(%{q: "London"})`). The merge is performed without any key or value validation. The merged map is then passed to `Helpers.build_url_string/2`, which iterates over the map and builds a query string:

```elixir
|> Enum.map(fn
  {_,nil}                    -> nil
  {k,v} when is_binary(v)    -> "#{k}=#{v}"
  {k,v} when is_float(v)     -> "#{k}=#{v}"
  {k,v} when is_boolean(v)   -> "#{k}=#{v}"
  {k,v} when is_integer(v)   -> "#{k}=#{v}"
  {k,arr} when is_list(arr)  -> Enum.map(arr, &"#{k}=#{&1}")
end)
|> Enum.join("&")
|> URI.encode
```

**A042-2 — MEDIUM — No input validation or key allowlist in `url_arguments/1`**

Severity: MEDIUM

Files:
- `geonames-elixir/lib/geonames/endpoints/postal_code_search.ex` line 27-29
- `geonames-elixir/lib/geonames/endpoints/search.ex` line 40-42
- `geonames-elixir/lib/geonames/endpoints/siblings.ex` line 14-16

`Map.merge(@default_arguments, provided_arguments)` allows the caller to inject arbitrary keys into the query string sent to the GeoNames API. Although `available_url_parameters/0` lists the intended keys, it is never enforced; it is documentation only. A caller can pass `%{username: "attacker_account"}` and silently override the configured GeoNames username, or inject any other query parameter the GeoNames API accepts (e.g., `token`, `style`, `charset`).

Additionally, `Map.merge/2` with an atom-keyed default map and a caller-supplied map means the caller is expected to supply atom keys. If user-supplied string data is ever converted to atom keys before being passed to these functions (e.g., via `String.to_atom/1`), atom table exhaustion becomes possible. No such conversion is visible in the immediately reviewed call sites (the two usages in `utility_controller.ex` use hardcoded atom keys), but the absence of enforcement is a latent risk if future callers pass user-controlled maps.

**A042-3 — MEDIUM — URL parameter values are not sanitized before query-string interpolation**

Severity: MEDIUM

File: `geonames-elixir/lib/geonames/helpers.ex` line 36-40 (supporting context for the assigned modules).

Values in the merged map are interpolated directly into the query string via string interpolation (`"#{k}=#{v}"`) before being passed to `URI.encode/1`. `URI.encode/1` in Elixir encodes the entire string, not individual components — it percent-encodes characters that are not valid in a URI, but it does not percent-encode `&`, `=`, or `?` within component values. A binary value containing `&` would split into a second query parameter at the HTTP layer. For example, if `provided_arguments` contains `%{q: "foo&username=attacker"}`, after `URI.encode` the assembled URL will contain `q=foo&username=attacker`, effectively injecting an extra query parameter. This is a query-string injection (parameter pollution) vulnerability. `URI.encode_www_form/1` or `URI.encode_query/1` should be used per-value rather than on the entire assembled string.

**A042-4 — LOW — `String.to_existing_atom` vs atom creation (latent risk)**

Severity: LOW

All three `@default_arguments` maps use atom keys. `url_arguments/1` accepts `provided_arguments` without constraining its key type. If any upstream caller converts user-supplied strings to atoms (e.g., via Phoenix param destructuring with `String.to_atom/1` or dynamic map construction) and passes them here, atom table exhaustion is possible. No direct `String.to_atom/1` call is present in the assigned files, so this is a latent/structural risk rather than an immediate finding.

§3 findings: A042-2, A042-3, A042-4 as above.

---

### §4: Session and CSRF

The three files are data-layer endpoint configuration modules. They define no routes, no plugs, no channels, and no session handling. Not applicable.

§4: No issues found.

---

### §5: File and Data Handling

The three files perform no file I/O, no logging, and return no HTTP responses. They do not handle PII, GPS coordinates, driver records, or fleet data directly.

**Supporting-file observation:** `Helpers.build_url_string/2` includes latitude/longitude values (passed through from callers such as `utility_controller.ex`) as query parameters in the outbound URL sent to `api.geonames.org`. These values originate from GPS telemetry (vehicle location). The GeoNames API call is outbound to a third-party service; GPS coordinates are therefore being disclosed to `api.geonames.org`. This is a design-level observation. It is not a finding against the assigned files, but it is noted as an INFO finding for the audit record.

**A042-5 — INFO — GPS coordinates transmitted to third-party GeoNames API**

Severity: INFO

File: `lib/api_server_web/controllers/utility_controller.ex` lines 1012, 1038 (call sites using the library).

Vehicle latitude/longitude (from fleet GPS data) is transmitted to `api.geonames.org` as part of geocoding lookups. Depending on data-processing agreements and applicable privacy regulations, disclosing precise fleet vehicle locations to a third-party service may require review. This is not a vulnerability in the assigned endpoint modules themselves, but it is raised for completeness given the fleet-management context described in §5 of the checklist.

§5: No issues found within the three assigned files themselves. See A042-5 for cross-cutting observation.

---

### §6: Dependencies

The three assigned files declare no dependencies of their own. The vendored library's `mix.exs` and `mix.lock` are examined below.

**`geonames-elixir/mix.exs` dependencies:**
- `poison ~> 3.1` (JSON)
- `httpoison ~> 1.0` (HTTP client)
- `ex_doc ~> 0.12` (dev only)

**`geonames-elixir/mix.lock` pinned versions:**
- `poison 3.1.0`
- `httpoison 1.3.0`
- `hackney 1.13.0` (transitive, HTTP backend)
- `certifi 2.3.1` (transitive, TLS certificates)
- `ssl_verify_fun 1.1.1` (transitive)
- `idna 5.1.2` (transitive)

**A042-6 — HIGH — Severely outdated vendored dependencies**

Severity: HIGH

The vendored `geonames-elixir` library pins very old versions:

| Package | Locked version | Current stable (approx.) | Notes |
|---------|---------------|--------------------------|-------|
| `poison` | 3.1.0 (2017) | 6.x | Multiple releases; 3.x branch no longer maintained |
| `httpoison` | 1.3.0 (2018) | 2.x | Outdated; upstream is 2.2+ |
| `hackney` | 1.13.0 (2018) | 1.20+ | TLS/connection handling fixes in later versions |
| `certifi` | 2.3.1 (2018) | 2.14+ | CA bundle from 2018; may not include current root certificates |
| `ssl_verify_fun` | 1.1.1 (2016) | 1.1.7 | Hostname verification library, unmaintained version |

The `certifi 2.3.1` CA bundle dates to 2018 and will be missing root certificates added since then. Recent certificate renewals (e.g., the Sectigo Root R46 issue referenced in recent commit `e486dd8`) demonstrate that outdated CA bundles can cause TLS handshake failures. The `hackney` + `certifi` combination is used for all outbound calls to `api.geonames.org` from these endpoint modules.

No Mariaex 0.8.2 is present.

All dependencies are sourced from `hexpm`; no `git:` URLs are present. The `mix.lock` file does pin exact versions (reproducible builds are possible).

§6 finding: A042-6 as above.

---

### §7: Infrastructure Exposure

**A042-7 — INFO — Hardcoded third-party API hostname**

Severity: INFO

`geonames-elixir/lib/geonames/helpers.ex` line 8:

```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The third-party hostname `api.geonames.org` is compiled in as a fallback default. This is not an internal infrastructure hostname, so it does not reveal internal topology. It is noted for completeness.

No hardcoded internal IPs, RDS endpoints, or AWS infrastructure strings are present in the three assigned files or the supporting library files.

No CORS configuration is present (these are not Phoenix endpoint/router files).

No TLS termination is performed by these modules; they are HTTP client callers, not servers.

§7: No further issues found.

---

## Findings Summary

| ID | Severity | File(s) | Description |
|----|----------|---------|-------------|
| A042-1 | INFO | `geonames-elixir/lib/geonames/helpers.ex:8` | Hardcoded compile-time default base URL `api.geonames.org/`; misconfiguration not detectable at runtime |
| A042-2 | MEDIUM | `postal_code_search.ex:27`, `search.ex:40`, `siblings.ex:14` | `url_arguments/1` performs unconstrained `Map.merge` — no key allowlist enforced; `available_url_parameters/0` is documentation only; callers can inject arbitrary query parameters including overriding the `username` credential |
| A042-3 | MEDIUM | `geonames-elixir/lib/geonames/helpers.ex:36-40` | Per-value query-string interpolation uses `URI.encode/1` on the full assembled string rather than `URI.encode_www_form/1` per value; binary values containing `&` or `=` enable query-parameter injection/pollution |
| A042-4 | LOW | `postal_code_search.ex:27`, `search.ex:40`, `siblings.ex:14` | Atom-keyed merge with unconstrained `provided_arguments`; latent atom exhaustion risk if upstream code converts user strings to atoms before passing to these functions |
| A042-5 | INFO | `lib/api_server_web/controllers/utility_controller.ex:1012,1038` | GPS coordinates from fleet vehicles are transmitted to third-party `api.geonames.org`; privacy/data-processing agreement review advised |
| A042-6 | HIGH | `geonames-elixir/mix.lock` | Vendored library uses severely outdated dependencies (2016-2018); notably `certifi 2.3.1` CA bundle predates current root certificates, risking TLS failures for outbound calls through these endpoint modules |
| A042-7 | INFO | `geonames-elixir/lib/geonames/helpers.ex:8` | Hardcoded third-party hostname in compile-time default (low risk, documented for completeness) |

---

*End of report A042.*
