# Pass 1 Security Audit — A071
**Agent:** A071
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Assigned files:**
- `lib/api_server/vx/rental_periods.ex`
- `lib/api_server/vx/scheduler.ex`
- `lib/api_server/vx/vx.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server/vx/rental_periods.ex`

**Module name:** `ApiServer.Vx.RentalPeriod`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 17 |

**Schemas / structs / exceptions:**

- `schema "rental_periods"` (lines 6–15)
  - Fields: `id` (integer), `contract_id` (integer), `period_start` (date), `period_end` (date), `hours_used` (float), `overage` (float), `is_completed` (integer), `created` (utc_datetime)
  - `@primary_key {:ID, :id, autogenerate: true}` (line 5)

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Ecto.Schema` | 2 |
| `import` | `Ecto.Changeset` | 3 |

---

### File 2: `lib/api_server/vx/scheduler.ex`

**Module name:** `ApiServer.Scheduler`

**Public functions (def):** None explicitly defined (all behaviour delegated via `use Quantum.Scheduler`).

**Schemas / structs / exceptions:** None.

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Quantum.Scheduler, otp_app: :api_server` | 2–3 |

---

### File 3: `lib/api_server/vx/vx.ex`

**Module name:** `ApiServer.Vx`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `update_key_if_value` | 3 | 27 |
| `update_key_if_value` | 3 | 28 |
| `list_vxusers` | 1 | 33 |
| `get_vx_user!` | 2 | 40 |
| `get_vx_user_offset` | 2 | 47 |
| `get_vx_user_fleets!` | 2 | 54 |
| `create_vx_user` | 2 | 75 |
| `update_vx_user` | 3 | 93 |
| `update_vx_user_password` | 3 | 99 |
| `delete_vx_user` | 2 | 117 |
| `change_vx_user` | 1 | 130 |
| `list_vxaccessfobs` | 0 | 145 |
| `get_vx_access_fob!` | 1 | 163 |
| `get_vx_access_fob_by_code!` | 1 | 165 |
| `get_vx_access_fobs_for_fleets!` | 1 | 177 |
| `get_vx_fleet_for_access_fob` | 1 | 189 |
| `get_num_vx_admin_fobs` | 0 | 198 |
| `get_vx_admin_fobs` | 0 | 199 |
| `delete_vx_access_fob` | 1 | 215 |
| `list_vxfleets` | 1 | 222 |
| `list_vxfleets` | 2 | 227 |
| `get_list_of_valid_fleets_for_user` | 2 | 235 |
| `get_list_of_valid_equipment_for_user` | 2 | 243 |
| `list_vxfleets_with_equipment` | 2 | 264 |
| `get_vx_fleet_by_name` | 2 | 290 |
| `get_vx_fleet` | 2 | 296 |
| `create_vx_fleet` | 2 | 315 |
| `update_vx_fleet` | 3 | 333 |
| `delete_vx_fleet` | 2 | 351 |
| `change_vx_fleet` | 1 | 364 |
| `update_fleet_assocs` | 3 | 378 |
| `get_equipment_in_fleet` | 2 | 392 |
| `get_hardwareids_in_fleet` | 2 | 400 |
| `get_fleets_for_thing` | 2 | 408 |
| `get_branch_for_thing` | 2 | 416 |
| `list_vxfleetassociations` | 0 | 427 |
| `get_vx_fleet_association!` | 1 | 449 |
| `delete_vx_fleet_association` | 1 | 464 |
| `list_vxthings` | 1 | 470 |
| `list_vxthings_full` | 1 | 478 |
| `list_vxthings_lite` | 1 | 492 |
| `list_vxthing` | 2 | 498 |
| `list_vxthing_full` | 2 | 507 |
| `list_vxthing_lite` | 2 | 520 |
| `list_vxthings` | 2 | 528 |
| `list_augmented_things` | 2 | 539 |
| `list_augmented_things_with_rentals` | 1 | 555 |
| `list_augmented_things_with_rentals_in_fleet` | 3 | 568 |
| `list_augmented_things_in_fleet` | 3 | 589 |
| `list_vxthings_in_fleet` | 2 | 608 |
| `list_vxthings_with_checklists` | 1 | 623 |
| `get_lift_event_counts_for_thing_by_day` | 5 | 631 |
| `get_detailed_lift_event_counts_for_thing_by_day` | 6 | 651 |
| `get_list_lift_event_counts_for_thing_by_day` | 6 | 677 |
| `get_detailed_lift_event_counts_for_fleet_by_day` | 5 | 699 |
| `get_omega_engine_utilization` | 5 | 726 |
| `get_omega_operation_summary` | 5 | 749 |
| `list_vxthings_for_map` | 2 | 780 |
| `list_vxthings_for_map` | 2 | 795 |
| `augment_thing_with_fleets` | 2 | 811 |
| `augment_thing_with_services` | 2 | 816 |
| `get_hour_meter_start_rental` | 2 | 827 |
| `augment_thing_with_rental_periods` | 2 | 871 |
| `augment_thing_with_usage` | 2 | 940 |
| `get_avg_weekly_hours` | 2 | 968 |
| `get_avg_weekly_hours` | 3 | 981 |
| `get_summary_total_usage` | 1 | 985 |
| `get_usage_since_service` | 2 | 1006 |
| `fetch_actual_usage` | 2 | 1030 |
| `generate_usage_select` | 2 | 1042 |
| `fetch_actual_usage` | 5 | 1090 (category 4) |
| `fetch_actual_usage` | 5 | 1133 (category 2) |
| `fetch_actual_usage` | 5 | 1174 (category 3) |
| `fetch_actual_usage` | 5 | 1215 (generic) |
| `fetch_actual_usage_thing` | 4 | 1230 |
| `get_movements` | 5 | 1235 |
| `get_vx_thing!` | 1 | 1281 |
| `get_vx_thing!` | 2 | 1283 |
| `get_thing_name_with_hardware_id!` | 2 | 1290 |
| `get_fleet_name_with_id` | 2 | 1296 |
| `get_thing_category_with_hardware_id!` | 2 | 1303 |
| `get_thing_id_with_hardware_id!` | 2 | 1311 |
| `lookup_thing_with_name_serial` | 3 | 1319 |
| `lookup_thing_with_name` | 2 | 1328 |
| `get_vx_thing_with_hardware_id!` | 1 | 1337 |
| `get_vx_thing_with_hardware_id!` | 2 | 1347 |
| `get_augmented_thing_with_hardware_id!` | 2 | 1357 |
| `get_equipment_by_name` | 2 | 1363 |
| `get_equipment_by_serial` | 2 | 1371 |
| `get_equipment_assignments_by_id` | 2 | 1377 |
| `create_vx_thing` | 2 | 1395 |
| `update_vx_thing` | 3 | 1413 |
| `delete_vx_thing` | 1 | 1431 |
| `change_vx_thing` | 1 | 1444 |
| `list_vxthingsummaries` | 0 | 1459 |
| `get_vx_thing_summary!` | 1 | 1477 |
| `get_summary_for_hardwareid` | 2 | 1478 |
| `update_or_insert_summary` | 3 | 1484 |
| `create_vx_thing_summary` | 1 | 1501 |
| `update_vx_thing_summary` | 2 | 1519 |
| `delete_vx_thing_summary` | 1 | 1537 |
| `change_vx_thing_summary` | 1 | 1550 |
| `default_checklist_questions` | 0 | 1555 |
| `get_checklists` | 1 | 1586 |
| `list_vxthingevents` | 0 | 1622 |
| `get_vx_thing_event!` | 1 | 1640 |
| `get_most_recent_thingevent` | 2 | 1642 |
| `get_most_recent_thingevent_with_date` | 3 | 1651 |
| `get_most_recent_thingevent_with_omega` | 2 | 1660 |
| `get_thingevents_for_hardwareid` | 2 | 1673 |
| `get_thingevents_for_hardwareid` | 4 | 1680 |
| `create_vx_thing_event` | 2 | 1702 |
| `update_vx_thing_event` | 2 | 1720 |
| `delete_vx_thing_event` | 1 | 1738 |
| `change_vx_thing_event` | 1 | 1751 |
| `generate_avg_weekly_select` | 2 | 1755 |
| `convert_category_to_regular_units` | 2 | 1795 |
| `get_first_event` | 2 | 1824 |
| `get_actual_avg_weekly_hours` | 3 | 1842 (category 4) |
| `get_actual_avg_weekly_hours` | 4 | 1879 (category 4, input) |
| `get_actual_avg_weekly_hours` | 3 | 1916 (category 2) |
| `get_actual_avg_weekly_hours` | 4 | 1952 (category 2, 1) |
| `get_actual_avg_weekly_hours` | 3 | 1988 (category 3) |
| `get_actual_avg_weekly_hours` | 3 | 2026 (generic) |
| `list_service_records` | 1 | 2054 |
| `get_daily_usage` | 6 | 2100 |
| `get_impact_count_by_hardwareid` | 2 | 2170 |
| `get_events` | 5 | 2179 |
| `process_events` | 0 | 2192 |
| `process_events_subprocess` | 1 | 2547 |
| `get_vx_abl_record!` | 1 | 2611 |
| `create_vx_abl_record` | 1 | 2625 |
| `create_abl_record` | 2 | 2631 |
| `create_equipment_record` | 2 | 2637 |
| `get_equipment_id` | 2 | 2643 |
| `create_equipment_assignment_record` | 2 | 2650 |
| `update_vx_abl_record` | 2 | 2668 |
| `delete_vx_abl_record` | 1 | 2686 |
| `change_vx_abl_record` | 1 | 2699 |
| `get_rhm_user` | 3 | 2704 |
| `check_password` | 3 | 2712 |
| `get_rhm_user` | 2 | 2719 |
| `list_all_rentals` | 1 | 2730 |
| `list_open_rentals` | 1 | 2740 |
| `get_rental` | 2 | 2753 |
| `get_active_rental` | 2 | 2764 |
| `get_all_rentals_for_thing` | 2 | 2776 |
| `get_rental` | 4 | 2786 |
| `delete_rental` | 2 | 2798 |
| `update_rental` | 3 | 2802 |
| `create_rental_contract` | 2 | 2809 |
| `create_rental_period` | 2 | 2817 |
| `get_rental_periods_for_contract` | 2 | 2825 |
| `create_rental` | 2 | 2831 |
| `list_customers` | 1 | 2871 |
| `get_vx_customer!` | 2 | 2889 |
| `get_customer` | 3 | 2891 |
| `create_vx_customer` | 2 | 2916 |
| `update_vx_customer` | 3 | 2934 |
| `delete_vx_customer` | 2 | 2952 |
| `change_vx_customer` | 2 | 2965 |
| `list_vxaatuserfunctions` | 0 | 2980 |
| `get_vx_user_function!` | 1 | 2998 |
| `create_vx_user_function` | 1 | 3012 |
| `update_vx_user_function` | 2 | 3030 |
| `delete_vx_user_function` | 1 | 3048 |
| `change_vx_user_function` | 1 | 3061 |
| `list_vxaau_rest` | 0 | 3074 |
| `get_vx_restriction!` | 1 | 3092 |
| `create_vx_restriction` | 1 | 3106 |
| `add_fleet_to_user` | 3 | 3112 |
| `get_restriction` | 3 | 3124 |
| `remove_fleet_from_user` | 3 | 3132 |
| `update_vx_restriction` | 2 | 3150 |
| `delete_vx_restriction` | 1 | 3168 |
| `change_vx_restriction` | 1 | 3181 |
| `delete_erp_import` | 2 | 3189 |
| `create_erp_import` | 2 | 3193 |
| `update_erp_import` | 3 | 3199 |
| `check_for_existing_erp_record` | 2 | 3205 |
| `get_geofence_by_id` | 2 | 3223 |
| `get_geofences` | 1 | 3229 |
| `get_geofences_as_map` | 1 | 3234 |
| `create_geofence` | 2 | 3249 |
| `update_geofence` | 3 | 3255 |
| `delete_geofence` | 2 | 3261 |
| `create_thingevent_record` | 2 | 3265 |
| `update_thingevent_record` | 3 | 3271 |
| `delete_thingevent_record` | 2 | 3277 |
| `create_thingeventomega_record` | 2 | 3281 |
| `create_thingomegatires_record` | 2 | 3287 |
| `create_rayven_message_log_record` | 2 | 3293 |
| `update_rayven_stream_status_record` | 2 | 3299 |
| `count_rayven_events_to_stream` | 3 | 3305 |

**Schemas / structs / exceptions:** None defined in this module (context module only; uses schemas from aliased modules).

**use / import / alias at module level:**

| Directive | Value | Lines |
|-----------|-------|-------|
| `import` | `Ecto.Query, warn: false` | 6 |
| `alias` | `ApiServer.Repo` | 7 |
| `alias` | `ApiServer.Vx.VXUser` | 8 |
| `alias` | `ApiServer.Vx.VXThingEvent` | 9 |
| `alias` | `ApiServer.Vx.VXThingEventOmega` | 10 |
| `alias` | `ApiServer.Vx.VXThingEventOmegaTires` | 11 |
| `alias` | `ApiServer.Vx.VXFleetAssociation` | 12 |
| `alias` | `ApiServer.Vx.VXRestriction` | 13 |
| `alias` | `ApiServer.Vx.Geofence` | 14 |
| `alias` | `ApiServer.Vx.VXThing` | 15 |
| `alias` | `ApiServer.Vx.VXRental` | 16 |
| `alias` | `ApiServer.Vx.VXAblRecord` | 17 |
| `alias` | `ApiServer.Vx.VXRayvenMessageLog` | 18 |
| `alias` | `ApiServer.Vx.VXRayvenStreamStatus` | 19 |
| `alias` | `ApiServer.Vx.Equipment` | 20 |
| `alias` | `ApiServer.Vx.EquipmentAssignment` | 21 |
| `alias` | `ApiServer.Vx.RentalContract` | 22 |
| `alias` | `ApiServer.Vx.RentalPeriod` | 23 |
| `alias` (inline) | `ApiServer.Vx.VXAccessFob` | 134 |
| `alias` (inline) | `ApiServer.Vx.VXFleet` | 220 |
| `alias` (inline) | `ApiServer.Vx.VXThingEvent` | 1611 |
| `alias` (inline) | `ApiServer.Vx.VXAblRecord` | 2043 |
| `alias` (inline) | `ApiServer.Vx.VXRental` | 2728 |
| `alias` (inline) | `ApiServer.Vx.VXCustomer` | 2860 |
| `alias` (inline) | `ApiServer.Vx.VXUserFunction` | 2969 |
| `alias` (inline) | `ApiServer.Vx.ERPImport` | 3187 |

---

## Checklist Review

---

### §1: Secrets and Configuration

**A071-1 — CRITICAL — Hardcoded admin fob credential string in source**

`lib/api_server/vx/vx.ex`, lines 199–201:

```elixir
def get_vx_admin_fobs() do
  "000019333303000019333AEA000019330E4E0000193354AC00001933382D00001932FCA800001933001A"
end
```

A hardcoded string encoding seven physical access fob codes is embedded directly in source. This is an operational secret: anyone with access to the repository can read the exact fob IDs granted admin-level physical access to equipment. The fob codes cannot be rotated without a code change and redeployment. This directly contradicts the requirement that secrets must come from environment variables or a secrets manager, never from tracked files.

---

**A071-2 — HIGH — Hardcoded internal customer schema identifier in production code path**

`lib/api_server/vx/vx.ex`, lines 2196–2197 (`process_events/0`) and lines 2549–2550 (`process_events_subprocess/1`):

```elixir
customer = "vx_cea"
user_id = 37 # This is the admin user
```

The production customer schema name `"vx_cea"` and a specific admin user ID (`37`) are hardcoded inside two public functions. This reveals internal multi-tenant schema topology. If `process_events/0` is callable (e.g. via the scheduler), it will always operate against `vx_cea` regardless of context. This is both an information disclosure issue and a configuration correctness issue.

---

**A071-3 — HIGH — Hardcoded customer name in production branch logic**

`lib/api_server/vx/vx.ex`, line 3207:

```elixir
"vx_cea" ->
  # CEA only want to match on equipment name
```

The `check_for_existing_erp_record/2` function contains a hardcoded customer-specific schema name as a branch condition. This encodes internal deployment topology in source and creates a maintenance coupling between code and infrastructure naming.

---

**A071-4 — MEDIUM — Hardcoded email addresses for alert recipients**

`lib/api_server/vx/vx.ex`, lines 2306–2307, 2323, 2357–2358, 2375–2376, 2417, 2435–2436, 2477, 2495–2496, 2500, 2540–2541 (throughout `process_events/0`):

```elixir
email_to = ["shad.wall@clarkequipment.com","james.purdom@trackingsolutions.com.au","graham.oconnell@trackingsolutions.com.au"]
email_from = "no-reply@mobilehourmeter.com"
```

Multiple individual email addresses (including external parties) and a sender address are hardcoded in source. While most sending paths are commented out, two remain active (lines 2328–2329, 2377–2378, 2381–2382, 2437–2438, 2441–2442, 2497–2498, 2501–2502). Personal email addresses of named employees constitute PII embedded in source code.

---

**A071-5 — MEDIUM — Hardcoded date constants in `augment_thing_with_rental_periods/2`**

`lib/api_server/vx/vx.ex`, lines 874–879:

```elixir
from_date = "2019-01-01"
# Do something to change this to now.
to_date = "2020-07-05"
user_timezone = "US/Michigan"
```

Static date strings and a hardcoded timezone are embedded in a production function. The comment "Do something to change this to now" confirms these are unfinished placeholders. Any caller of this function receives data scoped to a fixed historical window regardless of actual request parameters. The hardcoded timezone `"US/Michigan"` also leaks a specific customer's operational geography.

---

**A071-6 — INFO — Hardcoded timezone in `augment_thing_with_usage/2`**

`lib/api_server/vx/vx.ex`, line 950:

```elixir
user_timezone = "+10:00"
```

A hardcoded UTC offset is used for all `this_week` and `this_month` usage calculations. This is likely wrong for most customers and leaks an assumed timezone (UTC+10, consistent with eastern Australia). Should be derived from user or customer configuration.

---

### §2: Authentication and Authorization

**A071-7 — CRITICAL — Plaintext password comparison in authentication functions**

`lib/api_server/vx/vx.ex`, lines 2704–2717:

```elixir
def get_rhm_user(email, password, customer) do
  VXUser
  |> Ecto.Query.where(aacemail: ^email)
  |> Ecto.Query.where(aacpassword: ^password)
  |> Ecto.Query.preload(:function)
  |> Repo.one(prefix: customer)
end

def check_password(user_id, password, customer) do
  VXUser
  |> Ecto.Query.where(aacid: ^user_id)
  |> Ecto.Query.where(aacpassword: ^password)
  |> Repo.one(prefix: customer)
end
```

Both `get_rhm_user/3` (3-arity) and `check_password/3` authenticate by issuing SQL queries that match on the raw `aacpassword` column. This means:
1. Passwords are stored in plaintext (or at most reversibly encoded) in the database — a violation of the checklist requirement that password hashing uses bcrypt or argon2.
2. Authentication is done via database equality rather than a constant-time hash comparison, making it vulnerable to timing attacks.
3. The column name `aacpassword` and query structure confirm the password is held in the user table in plaintext form.

This is the most severe authentication finding in the assigned files.

---

**A071-8 — HIGH — No changeset validation in `RentalPeriod.changeset/2`**

`lib/api_server/vx/rental_periods.ex`, lines 17–20:

```elixir
def changeset(rental_periods, attrs) do
  rental_periods
  |> cast(attrs, [:id, :contract_id, :period_start, :period_end, :hours_used, :overage, :is_completed, :created])
end
```

The changeset casts all fields but applies no `validate_required`, `validate_number`, or any other validation. Any caller can insert or update a `RentalPeriod` with an empty or malformed record. In particular, casting `:id` directly (overriding the autogenerated primary key `{:ID, :id, autogenerate: true}`) is unexpected and could allow callers to force-insert or collide on an arbitrary ID.

---

**A071-9 — HIGH — `list_vxfleetassociations/0` and several other functions query without tenant prefix**

`lib/api_server/vx/vx.ex`, lines 427–433:

```elixir
def list_vxfleetassociations do
  VXFleetAssociation
      |> Ecto.Query.where([r], r.aafgroupid != ^"29")
      |> Ecto.Query.preload(:fleet)
      |> Ecto.Query.preload(:thing)
      |> Repo.all
end
```

This function and several others (`list_vxaccessfobs/0`, `get_vx_access_fob!/1`, `get_vx_access_fob_by_code!/1`, `get_vx_access_fobs_for_fleets!/1`, `get_vx_fleet_for_access_fob/1`, `delete_vx_access_fob/1`, `get_vx_fleet_association!/1`, `delete_vx_fleet_association/1`, `list_vxthingevents/0`, `get_vx_thing_event!/1`, `get_vx_thing_summary!/1`, `create_vx_thing_summary/1`, `update_vx_thing_summary/2`, `delete_vx_thing_summary/1`, `change_vx_thing_summary/1`, `create_vx_abl_record/1`, `update_vx_abl_record/2`, `delete_vx_abl_record/1`, `list_vxaatuserfunctions/0`, `get_vx_user_function!/1`, `create_vx_user_function/1`, `update_vx_user_function/2`, `delete_vx_user_function/1`, `list_vxaau_rest/0`, `get_vx_restriction!/1`, `create_vx_restriction/1`, `update_vx_restriction/2`, `delete_vx_restriction/1`, `get_vx_thing_with_hardware_id!/1` (1-arity)) issue `Repo.*` calls **without a `prefix:` option**, bypassing the multi-tenant schema scoping pattern used throughout the rest of the codebase. This creates a cross-tenant data exposure risk: the query runs against whichever schema is the database user's default schema, or the OTP application default, rather than the authenticated customer's schema. If any of these no-prefix paths are reachable from a web request, data from one tenant may be returned to another.

---

**A071-10 — MEDIUM — `get_vx_admin_fobs/0` returns all admin fobs with no access control**

`lib/api_server/vx/vx.ex`, lines 198–201:

```elixir
def get_num_vx_admin_fobs(), do: 7
def get_vx_admin_fobs() do
  "000019333303000019333AEA000019330E4E0000193354AC00001933382D00001932FCA800001933001A"
end
```

These are public context functions with no authorization logic. Whether the callers enforce authorization is not visible in these files, but the function itself exposes the complete set of admin-privileged hardware credentials to any caller with module access.

---

### §3: Input Validation and Injection

**A071-11 — MEDIUM — SQL `fragment/1` interpolates caller-supplied timezone string without sanitization**

`lib/api_server/vx/vx.ex`, appearing throughout — representative examples at lines 638–639, 644–646, 658–659, 670–672, 685–686, 708–709, 719–721, 734–735, 738–745, 763–767, 1117–1118, 1258–1259, 2030, 2032, 2117–2118, 2132–2134, 2155–2156, 2160–2162, 2186–2187:

```elixir
fragment("DATE(CONVERT_TZ(?,'+00:00', ?))", field(te, :gmtdatetime), ^timezone)
fragment("CONVERT_TZ(?,'+00:00', ?) >= ?", field(te, :gmtdatetime), ^timezone, ^from)
```

The `timezone` parameter is interpolated as a bound parameter (`^timezone`) into MySQL `CONVERT_TZ` function calls via `fragment/1`. While Ecto's `^` binding parameterizes scalar values safely for most SQL injection contexts, the `CONVERT_TZ` named-zone argument (e.g. `"US/Michigan"`) is a string value processed by MySQL's timezone subsystem. The risk depends on whether the database's timezone tables are populated and whether MySQL sanitizes the zone argument. More critically, the functions accept `timezone` as a caller-supplied argument (e.g. `get_lift_event_counts_for_thing_by_day/5`, `get_movements/5`, `get_events/5`, `get_daily_usage/6`) with no validation or allowlist check on format. There is no evidence in these files that timezone is validated before reaching these queries. If a sufficiently long or specially crafted timezone string is accepted, MySQL may behave unexpectedly. This should be validated against an allowlist (e.g. Timex.Timezone zones or a `+HH:MM` pattern) before use.

---

**A071-12 — LOW — `rental_periods.ex` changeset casts `:id` (primary key) from external attrs**

`lib/api_server/vx/rental_periods.ex`, line 19:

```elixir
|> cast(attrs, [:id, :contract_id, ...])
```

Including `:id` in the cast list allows caller-supplied values to override the auto-generated primary key. In combination with the lack of any `validate_required` or permission checks within the changeset, this means an attacker able to reach `create_rental_period/2` could insert records with arbitrary IDs, potentially creating collisions or interfering with referential integrity.

---

### §4: Session and CSRF

§4: No session, CSRF, WebSocket, or channel configuration is present in the assigned files. These are context/schema modules. No issues found in scope.

---

### §5: File and Data Handling

**A071-13 — HIGH — GPS coordinates, vehicle data, driver IDs logged to stdout in production scheduler code**

`lib/api_server/vx/vx.ex`, throughout `process_events/0`, lines 2194, 2211, 2220, 2226, 2230, 2233, 2245, 2254, 2275, 2285–2295 etc.:

```elixir
IO.puts "[process_events] starting #{inspect time_start}"
IO.puts "[process_events] event geofence #{inspect time_start} #{inspect geofence_name}"
IO.puts "[geofence_name] going to send an exited_search of some description #{inspect time_start} #{inspect geofence_name}"
```

`process_events/0` uses `IO.puts` extensively to log runtime state. While the specific calls shown include timestamps and geofence names, the broader function processes vehicle event records containing `latitude`, `longitude`, `hardwareid`, and driver-association data. `IO.puts` bypasses the Logger infrastructure (which can be configured with log levels and backends in production) and writes directly to stdout/stderr. This means these outputs will appear in production logs unconditionally, cannot be filtered by log level, and are not subject to any PII-scrubbing middleware. Vehicle movement data (GPS location, hardware IDs, geofence membership) is PII-adjacent fleet data that should not appear in raw logs.

Additionally, the function contains hardcoded named email recipients (see A071-4) and is clearly intended as an internal batch process, yet it remains a fully public function callable from any context.

---

**A071-14 — MEDIUM — `process_events/0` returns GPS coordinates and vehicle names in email alerts sent to hardcoded external addresses**

`lib/api_server/vx/vx.ex`, lines 2296–2309, 2345–2360, 2405–2419, 2465–2479:

```elixir
data = %{
  vehicle_name: thing.aaddesc,
  vehicle_serial: thing.aadserialno,
  geofence_name: previous_name,
  time_left: Timex.format!(...),
  ...
}
email_to = ["shad.wall@clarkequipment.com", "james.purdom@trackingsolutions.com.au", "graham.oconnell@trackingsolutions.com.au"]
```

Active email paths (`ApiServer.Mailer.deliver_now()` is not commented out on lines 2329, 2378, 2382, 2438, 2442, 2498, 2502) send vehicle serial numbers, vehicle names, geofence names, and timestamps to hardcoded external addresses. This is cross-customer data disclosure if `process_events/0` processes data from multiple tenants (it currently hardcodes `vx_cea`, but if the function scope changes this risk escalates). The inclusion of external parties (`trackingsolutions.com.au`) in alert recipients is especially sensitive.

---

**A071-15 — INFO — `get_checklists/1` returns static stub data, ignores its argument**

`lib/api_server/vx/vx.ex`, lines 1586–1609:

```elixir
def get_checklists(hardwareid) do
  [
    %{gmtdatetime: DateTime.utc_now(), answers: [true, true, false, true], ...},
    ...
  ]
end
```

The `hardwareid` parameter is accepted but completely ignored; the function returns hardcoded stub checklist data. Any caller receives identical fabricated data regardless of which equipment is queried. This is not a direct security issue but could mask the absence of real checklist validation data in downstream security checks (e.g. equipment safety checks that rely on this result).

---

### §6: Dependencies

§6: No `mix.exs` or `mix.lock` are in the assigned files. Dependency review is out of scope for this agent.

---

### §7: Infrastructure Exposure

**A071-16 — MEDIUM — Internal schema namespace `"vx_cea"` hardcoded in multiple public functions**

(Cross-reference with A071-2 and A071-3.)

`lib/api_server/vx/vx.ex`, lines 2196, 2549, 3207.

The string `"vx_cea"` is a Postgres/MySQL schema prefix naming a specific customer deployment. Its presence in source exposes the internal naming convention used for multi-tenant schema isolation. An attacker who learns this pattern can infer other schema names by convention. All customer-scoped operations should receive the customer identifier from the authenticated session or configuration, never from hardcoded literals.

---

**A071-17 — LOW — Email sender domain `"no-reply@mobilehourmeter.com"` hardcoded**

`lib/api_server/vx/vx.ex`, lines 2307, 2358, 2419, 2478, 2540:

```elixir
email_from = "no-reply@mobilehourmeter.com"
```

The sender domain `mobilehourmeter.com` is different from the primary CIG/VX domain, potentially revealing infrastructure detail or a legacy domain. This should be moved to configuration.

---

## Summary of Findings

| ID | Severity | File | Line(s) | Description |
|----|----------|------|---------|-------------|
| A071-1 | CRITICAL | vx.ex | 199–201 | Hardcoded admin fob credential string in source |
| A071-2 | HIGH | vx.ex | 2196–2197, 2549–2550 | Hardcoded customer schema `vx_cea` and admin user ID 37 in process_events |
| A071-3 | HIGH | vx.ex | 3207 | Hardcoded customer name in check_for_existing_erp_record branch |
| A071-4 | MEDIUM | vx.ex | multiple in process_events | Hardcoded personal email addresses (PII) in source |
| A071-5 | MEDIUM | vx.ex | 874–879 | Hardcoded historical date range and timezone in augment_thing_with_rental_periods |
| A071-6 | INFO | vx.ex | 950 | Hardcoded timezone `+10:00` in augment_thing_with_usage |
| A071-7 | CRITICAL | vx.ex | 2704–2717 | Plaintext password comparison — passwords stored and compared without hashing |
| A071-8 | HIGH | rental_periods.ex | 17–20 | Changeset has no validation; casts primary key from external input |
| A071-9 | HIGH | vx.ex | 427–433 + others | Multiple functions query without tenant prefix — cross-tenant exposure risk |
| A071-10 | MEDIUM | vx.ex | 198–201 | get_vx_admin_fobs returns privileged hardware credentials with no access control |
| A071-11 | MEDIUM | vx.ex | many | Timezone string passed into SQL fragment without allowlist validation |
| A071-12 | LOW | rental_periods.ex | 19 | Changeset casts :id (primary key) from external attrs |
| A071-13 | HIGH | vx.ex | throughout process_events | Vehicle GPS/fleet data logged via IO.puts (bypasses Logger, always emits) |
| A071-14 | MEDIUM | vx.ex | 2296–2502 | Fleet/vehicle data emailed to hardcoded external addresses via live mailer paths |
| A071-15 | INFO | vx.ex | 1586–1609 | get_checklists/1 returns static stub data; argument ignored |
| A071-16 | MEDIUM | vx.ex | 2196, 2549, 3207 | Internal schema namespace pattern exposed via hardcoded `vx_cea` |
| A071-17 | LOW | vx.ex | 2307 et al. | Sender email domain `mobilehourmeter.com` hardcoded; reveals infrastructure detail |
