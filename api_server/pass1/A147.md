# Security Audit Report — A147
**Agent:** A147
**Audit Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `priv/repo/migrations/20180829062447_create_files.exs`
2. `priv/repo/migrations/20180829154449_create_vxusers.exs`
3. `priv/repo/migrations/20180829154621_create_vxaccessfobs.exs`
4. `priv/repo/migrations/20180829154748_create_vxfleets.exs`
5. `priv/repo/migrations/20180829154831_create_vxfleetassociationss.exs`
6. `priv/repo/migrations/20180829155630_create_vxthings.exs`
7. `priv/repo/migrations/20180905123954_create_vxthingsummaries.exs`
8. `priv/repo/migrations/20180911054724_create_vxthingevents.exs`
9. `priv/repo/migrations/20181101052321_create_vxablrecords.exs`
10. `priv/repo/migrations/20190301032407_create_vxabhrental.exs`
11. `priv/repo/migrations/20190305003212_create_aaa_customers.exs`
12. `priv/repo/migrations/20190326223729_create_vxaatuserfunctions.exs`
13. `priv/repo/migrations/20190328050930_create_vxaau_rest.exs`
14. `priv/repo/seeds.exs`

---

## Reading Evidence

---

### File 1: `priv/repo/migrations/20180829062447_create_files.exs`

- **Migration timestamp:** 20180829062447
- **Module:** `ApiServer.Repo.Migrations.CreateFiles`
- **Table created:** `files`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `esn` — `:string`, no NOT NULL constraint, no unique index
  - `custcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 2: `priv/repo/migrations/20180829154449_create_vxusers.exs`

- **Migration timestamp:** 20180829154449
- **Module:** `ApiServer.Repo.Migrations.CreateVxusers`
- **Table created:** `vxusers`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aaccustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 3: `priv/repo/migrations/20180829154621_create_vxaccessfobs.exs`

- **Migration timestamp:** 20180829154621
- **Module:** `ApiServer.Repo.Migrations.CreateVxaccessfobs`
- **Table created:** `vxaccessfobs`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `fob_code` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 4: `priv/repo/migrations/20180829154748_create_vxfleets.exs`

- **Migration timestamp:** 20180829154748
- **Module:** `ApiServer.Repo.Migrations.CreateVxfleets`
- **Table created:** `vxfleets`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aaecustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 5: `priv/repo/migrations/20180829154831_create_vxfleetassociationss.exs`

- **Migration timestamp:** 20180829154831
- **Module:** `ApiServer.Repo.Migrations.CreateVxfleetassociationss`
- **Table created:** `[REDACTED-AWS-SMTP-PASSWORD]`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aafcustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **Note:** Table name contains a double-s suffix (`[REDACTED-AWS-SMTP-PASSWORD]`) — likely a typo in the original migration.
- **use/import/alias:** `use Ecto.Migration`

---

### File 6: `priv/repo/migrations/20180829155630_create_vxthings.exs`

- **Migration timestamp:** 20180829155630
- **Module:** `ApiServer.Repo.Migrations.CreateVxthings`
- **Table created:** `vxthings`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aadcustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 7: `priv/repo/migrations/20180905123954_create_vxthingsummaries.exs`

- **Migration timestamp:** 20180905123954
- **Module:** `ApiServer.Repo.Migrations.CreateVxthingsummaries`
- **Table created:** `vxthingsummaries`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `ambcustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 8: `priv/repo/migrations/20180911054724_create_vxthingevents.exs`

- **Migration timestamp:** 20180911054724
- **Module:** `ApiServer.Repo.Migrations.CreateVxthingevents`
- **Table created:** `vxthingevents`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `hardwareid` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 9: `priv/repo/migrations/20181101052321_create_vxablrecords.exs`

- **Migration timestamp:** 20181101052321
- **Module:** `ApiServer.Repo.Migrations.CreateVxablrecords`
- **Table created:** `vxablrecords`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `ablcustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 10: `priv/repo/migrations/20190301032407_create_vxabhrental.exs`

- **Migration timestamp:** 20190301032407
- **Module:** `ApiServer.Repo.Migrations.CreateVxabhrental`
- **Table created:** `vxabhrental`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `abhid` — `:integer`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 11: `priv/repo/migrations/20190305003212_create_aaa_customers.exs`

- **Migration timestamp:** 20190305003212
- **Module:** `ApiServer.Repo.Migrations.CreateAaaCustomers`
- **Table created:** `aaa_customers`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aaaid` — `:integer`, no NOT NULL constraint, no unique index
  - `aaacustcode` — `:string`, no NOT NULL constraint, no unique index
  - `aaaname` — `:string`, no NOT NULL constraint
  - `aaaaddr1` — `:string`, no NOT NULL constraint
  - `aaaaddr2` — `:string`, no NOT NULL constraint
  - `aaaaddr3` — `:string`, no NOT NULL constraint
  - `aaapcode` — `:string`, no NOT NULL constraint (postal code)
  - `aaaprimcont` — `:string`, no NOT NULL constraint (primary contact name)
  - `aaaprimtel` — `:string`, no NOT NULL constraint (primary telephone)
  - `aaaprimemail` — `:string`, no NOT NULL constraint (primary email)
  - `aaatz` — `:string`, no NOT NULL constraint (timezone)
  - `aaaudfcustcode` — `:string`, no NOT NULL constraint
  - `aaacolour` — `:string`, no NOT NULL constraint
- **Timestamps:** None — `timestamps()` is NOT called in this migration.
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 12: `priv/repo/migrations/20190326223729_create_vxaatuserfunctions.exs`

- **Migration timestamp:** 20190326223729
- **Module:** `ApiServer.Repo.Migrations.CreateVxaatuserfunctions`
- **Table created:** `vxaatuserfunctions`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aatid` — `:integer`, no NOT NULL constraint, no unique index
  - `aatuser_id` — `:integer`, no NOT NULL constraint, no foreign key constraint
  - `aatfunctionid` — `:integer`, no NOT NULL constraint
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 13: `priv/repo/migrations/20190328050930_create_vxaau_rest.exs`

- **Migration timestamp:** 20190328050930
- **Module:** `ApiServer.Repo.Migrations.CreateVxaauRest`
- **Table created:** `vxaau_rest`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aauid` — `:integer`, no NOT NULL constraint, no unique index
  - `aauuser_id` — `:integer`, no NOT NULL constraint, no foreign key constraint
  - `aaucustcode` — `:string`, no NOT NULL constraint
  - `aaufun` — `:string`, no NOT NULL constraint (function/permission label)
  - `aaucharval` — `:string`, no NOT NULL constraint (character value parameter)
  - `aaunumval` — `:integer`, no NOT NULL constraint (numeric value parameter)
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 14: `priv/repo/seeds.exs`

- **Content:** Boilerplate Phoenix seeds file only. Contains only comments — no executable code, no data insertion, no credentials, no test users.

---

## Checklist Review

### §1: Secrets and Configuration

No config files, `.gitignore`, `bitbucket-pipelines.yml`, or AWS configuration files are in scope for this batch. The `seeds.exs` file contains no hardcoded credentials, API keys, database passwords, or test user data — it is entirely comment-only.

§1: No issues found in assigned files.

---

### §2: Authentication and Authorization

No Guardian configuration, no password hashing, no token columns, and no authentication logic appear in any of these migration files. The `vxusers` table (`20180829154449`) stores only a single `aaccustcode` string column — it contains no `password`, `password_hash`, `token`, `secret`, or `pin` columns. The `vxaatuserfunctions` and `vxaau_rest` tables implement what appears to be a permission/function-association scheme; neither table has any foreign key constraints or indexes referencing a users table, creating a referential integrity gap at the database level.

See findings A147-3 and A147-4 below.

---

### §3: Input Validation and Injection

No Ecto query fragments, raw SQL, `String.to_atom/1`, or deserialization logic appear in migration files. Migration files are DDL-only.

§3: No issues found in assigned files.

---

### §4: Session and CSRF

Not applicable to migration or seeds files.

§4: No issues found in assigned files.

---

### §5: File and Data Handling

The `aaa_customers` table stores PII: primary contact name (`aaaprimcont`), telephone number (`aaaprimtel`), and email address (`aaaprimemail`), as well as postal address fields (`aaaaddr1`, `aaaaddr2`, `aaaaddr3`, `aaapcode`). No row-level security, encryption-at-rest markers, or audit timestamps are present on this table. This does not in itself constitute a code vulnerability but flags a data-governance concern relevant to §5.

See finding A147-5 below.

---

### §6: Dependencies

Not applicable to migration or seeds files.

§6: No issues found in assigned files.

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IPs, CORS configuration, or TLS settings appear in migration or seeds files.

§7: No issues found in assigned files.

---

## Findings

---

### A147-1 — MEDIUM — Missing NOT NULL Constraints on Business-Critical Identifier Columns (Multiple Tables)

**Affected files:**
- `priv/repo/migrations/20180829062447_create_files.exs` — columns `esn`, `custcode`
- `priv/repo/migrations/20180829154449_create_vxusers.exs` — column `aaccustcode`
- `priv/repo/migrations/20180829154621_create_vxaccessfobs.exs` — column `fob_code`
- `priv/repo/migrations/20180829154748_create_vxfleets.exs` — column `aaecustcode`
- `priv/repo/migrations/20180829154831_create_vxfleetassociationss.exs` — column `aafcustcode`
- `priv/repo/migrations/20180829155630_create_vxthings.exs` — column `aadcustcode`
- `priv/repo/migrations/20180905123954_create_vxthingsummaries.exs` — column `ambcustcode`
- `priv/repo/migrations/20180911054724_create_vxthingevents.exs` — column `hardwareid`
- `priv/repo/migrations/20181101052321_create_vxablrecords.exs` — column `ablcustcode`
- `priv/repo/migrations/20190301032407_create_vxabhrental.exs` — column `abhid`
- `priv/repo/migrations/20190305003212_create_aaa_customers.exs` — all columns
- `priv/repo/migrations/20190326223729_create_vxaatuserfunctions.exs` — columns `aatid`, `aatuser_id`, `aatfunctionid`
- `priv/repo/migrations/20190328050930_create_vxaau_rest.exs` — columns `aauid`, `aauuser_id`, `aaucustcode`, `aaufun`, `aaucharval`, `aaunumval`

**Description:**
Every column across all 13 migration files is defined without a `null: false` constraint. In Ecto migrations, columns default to nullable unless `null: false` is explicitly set. For identifier and foreign-key columns such as `aaccustcode`, `fob_code`, `aatuser_id`, `aauuser_id`, and `aaucustcode`, a NULL value is logically meaningless and could allow orphaned or unscoped records to exist in the database. This is especially significant for the customer-code columns that appear to be the primary multi-tenancy scoping mechanism across all fleet tables — a NULL `custcode` row would be invisible to any per-customer query filter, potentially leaking into cross-customer result sets depending on application query construction.

**Recommendation:**
Add `null: false` to all business-critical columns via corrective migrations. At minimum, enforce NOT NULL on every column used for customer scoping (`*custcode`), user references (`*user_id`), and hardware identifiers (`esn`, `hardwareid`, `fob_code`).

---

### A147-2 — MEDIUM — Missing Unique Indexes on Customer-Code Identifier Columns and Access-Fob Code

**Affected files:**
- `priv/repo/migrations/20180829062447_create_files.exs` — `esn` (Electronic Serial Number — device identifier, expected unique)
- `priv/repo/migrations/20180829154621_create_vxaccessfobs.exs` — `fob_code` (access fob credential — expected unique)
- `priv/repo/migrations/20190305003212_create_aaa_customers.exs` — `aaacustcode`, `aaaid` (customer code and upstream system ID — both expected unique)

**Description:**
No indexes of any kind are present across all 13 migrations. The `fob_code` column in `vxaccessfobs` is a physical access credential (an RFID/NFC fob identifier). Without a unique index, the database permits multiple records with the same `fob_code`, which could allow a duplicate fob entry to be inserted and subsequently matched during access-control lookups, depending on application logic. The `esn` column represents a device Electronic Serial Number, which is a hardware identifier that should be unique per device. The `aaacustcode` and `aaaid` columns in `aaa_customers` represent customer identifiers synced from an upstream system; duplicates would corrupt multi-tenancy data isolation.

**Recommendation:**
Create unique indexes on `fob_code` (`vxaccessfobs`), `esn` (`files`), and both `aaacustcode` and `aaaid` (`aaa_customers`). For all other `*custcode` columns used as foreign references, create non-unique indexes to support query performance.

---

### A147-3 — MEDIUM — No Foreign Key Constraints on User-Reference Columns in Permission Tables

**Affected files:**
- `priv/repo/migrations/20190326223729_create_vxaatuserfunctions.exs` — column `aatuser_id`
- `priv/repo/migrations/20190328050930_create_vxaau_rest.exs` — column `aauuser_id`

**Description:**
The `vxaatuserfunctions` and `vxaau_rest` tables store per-user permission and function associations. Both contain `*user_id` integer columns that clearly reference a users entity, but no `references/2` foreign key constraint is declared. Without a foreign key constraint, permission records can remain in the table after the associated user is deleted or the user ID becomes invalid. Stale permission records could potentially be exploited if a new user is assigned a recycled ID that inherits the old user's permissions. Additionally, the absence of constraints means the application cannot rely on the database to enforce referential integrity, pushing all integrity responsibility onto application-layer code.

**Recommendation:**
Replace the bare `:integer` type for `aatuser_id` and `aauuser_id` with `references(:vxusers, on_delete: :delete_all)` (or equivalent) in corrective migrations to enforce referential integrity at the database level.

---

### A147-4 — LOW — `aaa_customers` Table Has No `timestamps()` — Audit Trail Gap

**Affected file:**
- `priv/repo/migrations/20190305003212_create_aaa_customers.exs`

**Description:**
The `aaa_customers` table is the only table in this migration batch that omits the `timestamps()` call. All other tables include `inserted_at` and `updated_at` columns. For a table that stores customer PII (contact name, telephone, email, address), the absence of `inserted_at`/`updated_at` means there is no database-level record of when a customer record was created or last modified. This impairs incident response, audit logging, and data-subject access request fulfillment under privacy regulations.

**Recommendation:**
Add a corrective migration to add `inserted_at` and `updated_at` columns to the `aaa_customers` table.

---

### A147-5 — LOW — PII Stored in `aaa_customers` With No Encryption Markers or Row-Level Access Controls at Schema Level

**Affected file:**
- `priv/repo/migrations/20190305003212_create_aaa_customers.exs`

**Description:**
The `aaa_customers` table stores the following PII fields in plain `:string` columns with no encryption, column-level access restriction, or masking defined at the schema level:
- `aaaprimcont` — primary contact name
- `aaaprimtel` — primary telephone number
- `aaaprimemail` — primary email address
- `aaaaddr1`, `aaaaddr2`, `aaaaddr3`, `aaapcode` — postal address

This is a data-governance observation: at the migration level, there is no mechanism preventing these values from being exposed in logs, debug outputs, or error messages. Combined with the absence of `timestamps()` (A147-4) and lack of NOT NULL or unique constraints on `aaaprimemail` (A147-1), there is no database-enforced uniqueness on the email address, which could allow duplicate customer records or complicate account-recovery flows.

**Recommendation:**
Confirm that application-layer controls (Ecto schemas, serializers, logger filters) prevent PII from leaking into logs or API error responses. Consider adding a unique index on `aaaprimemail`. Assess whether column-level encryption is appropriate for contact and address fields under applicable data-protection obligations.

---

### A147-6 — INFO — Table Name Typo: `[REDACTED-AWS-SMTP-PASSWORD]` (Double-s)

**Affected file:**
- `priv/repo/migrations/20180829154831_create_vxfleetassociationss.exs`

**Description:**
The table name `[REDACTED-AWS-SMTP-PASSWORD]` contains a trailing double-s, which is inconsistent with the naming convention of all other tables in this batch and is almost certainly a typographical error in the original migration. While this is not a security vulnerability, it is documented here as an INFO-level finding because: (a) the typo is now baked into the database schema and any correction requires a rename migration coordinated with application code; (b) it may cause confusion during future schema reviews or when auditing query scoping logic.

**Recommendation:**
Verify whether downstream code intentionally uses `[REDACTED-AWS-SMTP-PASSWORD]` or whether application code also contains the typo. If a rename is warranted, coordinate a migration with the application-layer schema module.

---

### A147-7 — INFO — seeds.exs Is Effectively Empty

**Affected file:**
- `priv/repo/seeds.exs`

**Description:**
The seeds file contains only the Phoenix-generated boilerplate comments and no executable code. This is not a security concern — it is preferable to an empty seeds file that inserts test credentials. Documented as INFO for completeness.

§: No action required.

---

## Summary Table

| ID      | Severity | File(s)                                                      | Issue                                                                 |
|---------|----------|--------------------------------------------------------------|-----------------------------------------------------------------------|
| A147-1  | MEDIUM   | All 13 migration files                                       | No NOT NULL constraints on any column                                 |
| A147-2  | MEDIUM   | create_files, create_vxaccessfobs, create_aaa_customers      | Missing unique indexes on fob_code, esn, aaacustcode, aaaid           |
| A147-3  | MEDIUM   | create_vxaatuserfunctions, create_vxaau_rest                 | No foreign key constraints on user_id reference columns               |
| A147-4  | LOW      | create_aaa_customers                                         | No timestamps() — PII table has no insert/update audit trail          |
| A147-5  | LOW      | create_aaa_customers                                         | PII stored in plain string columns with no encryption or uniqueness   |
| A147-6  | INFO     | create_vxfleetassociationss                                  | Table name typo (double-s suffix)                                     |
| A147-7  | INFO     | seeds.exs                                                    | Seeds file is empty (no action required)                              |

---

*End of report A147 — pass1 — 2026-02-27-01*
