# Security Audit Report — A101
**Agent:** A101
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Run:** 2026-02-27-01
**Checklist:** PASS1-CHECKLIST-api_server.md

---

## Files Audited

1. `lib/api_server_web/controllers/pivotel_controller.ex`
2. `lib/api_server_web/controllers/utility_controller.ex`
3. `lib/api_server_web/controllers/vx_abl_record_controller.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server_web/controllers/pivotel_controller.ex`

**Module:** `ApiServerWeb.PivotelController`

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)

**defstruct / defexception / schema:** None.

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `get_pivotel_data/2` | 2 | 4 (pattern 1: xml match) |
| `get_pivotel_data/2` | 2 | 15 (pattern 2: catch-all) |
| `create_update_object/1` | 1 | 20 (pattern 1: LOCATION Cause) |
| `create_update_object/1` | 1 | 63 (pattern 2: ACCUM Cause) |
| `create_update_object/1` | 1 | 103 (pattern 3: catch-all) |

**Private functions (`defp`):**
- `convert_timestamp/1` (line 109)

---

### File 2: `lib/api_server_web/controllers/utility_controller.ex`

**Module:** `ApiServerWeb.UtilityController`

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `use Bamboo.Phoenix, view: ApiServer.EmailView` (line 3)
- `import Ecto.Query, warn: false` (line 5)
- `alias ApiServer.Vx` (line 6)
- `alias ApiServer.Vx.VXCustomer` (line 7)
- `alias ApiServer.Vx.ERPImport` (line 8)
- `alias ApiServer.Vx.VXThingInfo` (line 9)
- `alias ApiServer.Repo` (line 10)
- `alias ApiServer.Vx.VXThingEvent` (line 11)
- `alias ApiServer.Vx.VXThingEventOmega` (line 12)
- `alias ApiServer.Vx.VXThingEventOmegaTires` (line 13)
- `alias ApiServer.Vx.VXRayvenMessageLog` (line 14)
- `alias ApiServer.Vx.VXRayvenStreamStatus` (line 15)
- `alias ApiServer.Vx.DeviceDatabaseLookup` (line 16)
- `alias ApiServer.Vx.VXThingSummary` (line 17)
- `alias ApiServer.Vx.Equipment` (line 18)
- `alias ApiServer.Vx.EquipmentAssignment` (line 19)
- `alias ApiServer.Vx.VXRental` (line 20)
- `alias ApiServer.Vx.RentalPeriod` (line 21)
- `alias ApiServer.Vx.RentalContract` (line 22)

**Module attributes:**
- `@lookup_olson` — Windows-to-Olson timezone lookup table (lines 25–126)

**defstruct / defexception / schema:** None.

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `update_puls_firmware/1` | 1 | 128 |
| `bulk_daily_usage_summary/1` | 1 | 228 |
| `do_health_check/2` | 2 | 320 |
| `calculate_roi_value/2` | 2 | 324 |
| `process_incoming_omegawatch_data/2` | 2 | 328 |
| `process_prodisplay_event/2` | 2 | 333 |
| `do_error/2` | 2 | 982 |
| `do_geocode_lookup/2` | 2 | 991 |
| `sync_to_DISCorp/2` | 2 | 1052 |
| `sync_vehicles_to_rayven/1` | 1 | 1076 |
| `test_rental_messages/1` | 1 | 1203 |
| `send_vehicle_to_rayven/2` | 2 | 1445 |
| `send_to_rayven/7` | 7 | 1677 |
| `pull_from_rayven/1` | 1 | 1986 |
| `check_out_of_sequence_events/1` | 1 | 2009 |
| `get_tracker_ids/0` | 0 | 2078 |
| `device_lookup_with_hardware_id/1` | 1 | 2093 |
| `check_vehicles_for_rental_overage/3` | 3 | 2100 |
| `process_monthly_movements/0` | 0 | 2280 |
| `process_pronto/0` | 0 | 2463 |
| `process_ebs/0` | 0 | 2821 |
| `process_ebs_check_service/1` | 1 | 2972 |
| `process_ebs_get_hour_meter/2` | 2 | 2990 |
| `send_local_arrow_data/0` | 0 | 3036 |
| `check_vehicles_for_no_usage_historical/1` | 1 | 3170 |
| `process_events_for_next_usage/4` | 4 | 3213 |
| `sync_events_to_rayven/0` | 0 | 3298 |
| `rayven_login/2` | 2 | 3346 |
| `get_rayven_devices_for_project/2` | 2 | 3390 |
| `pull_data_from_rayven/1` | 1 | 3412 |
| `create_equipment/3` | 3 | 3453 |
| `get_equipment_id/2` | 2 | 3524 |
| `create_equipment_assignment/3` | 3 | 3533 |
| `create_rental_records/1` | 1 | 3596 |
| `sync_rental_contracts_to_rayven/1` | 1 | 3600 |
| `sync_rental_periods_to_rayven/1` | 1 | 3615 |
| `copy_rental_contracts/1` | 1 | 3623 |
| `pull_equipment_data_from_rayven/1` | 1 | 4647 |
| `pull_services_from_rayven/1` | 1 | 4729 |
| `refresh_rayven_stream_status/1` | 1 | 4900 |
| `sync_historical_events_to_rayven/1` | 1 | 5020 |
| `sync_historical_events_to_rayven/5` | 5 | 5091 |
| `send_events_to_rayven/6` | 6 | 5358 |
| `prepare_rayven_events/3` | 3 | 5416 |
| `check_for_future_date/2` | 2 | 5567 |
| `erp_import/2` | 2 | 5666 |
| `driverid_converter/2` | 2 | 6025 |
| `get_additional_data/1` | 1 | 6172 |
| `next_service/1` | 1 | 6225 |

**Private functions (`defp`):**
- `parse_prodisplay_thingevent/4` (line 701)
- `parse_prodisplay_thingomega_event/5` (line 806)
- `parse_prodisplay_thingomegatires_event/5` (line 923)
- `check_and_save_erp_record/3` (line 5735)
- `process_rental_from_erp/2` (line 5758)
- `find_or_make_customer/3` (line 5850)
- `process_services_from_erp/2` (line 5882)
- `process_service_from_erp/2` (line 5896)
- `get_dm_driverid/1` (line 6092)
- `rayven_ssl_opts/0` (line 6267)
- `rayven_cacerts/0` (line 6278)

---

### File 3: `lib/api_server_web/controllers/vx_abl_record_controller.ex`

**Module:** `ApiServerWeb.VXAblRecordController`

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXAblRecord` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

**defstruct / defexception / schema:** None.

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `create/2` | 2 | 9 |
| `show/2` | 2 | 18 |
| `update/2` | 2 | 23 |
| `delete/2` | 2 | 31 |
| `rhm_service_records/2` | 2 | 38 |
| `generate_service_record/3` | 3 | 66 |

---

## Checklist Review

---

### §1: Secrets and Configuration

**A101-1 — CRITICAL — Hardcoded third-party API keys in source (utility_controller.ex)**

Multiple live API keys are hardcoded directly in source code committed to the repository:

- **CalAmp PULS API key (old account):** `IwZTptJkQeOxZCoKRKVtI3IrIVwotFW6KRDS8O8OI-RKjmykQ95DPGlEE4yxjqbg` — embedded in URL string, line 146.
- **CalAmp PULS API key (new account):** `1SdeU1293s78waU_2P3vwCInz2oEOe-Rj6_AYqL-FwBzFtsG3n_o5mNsqat5rO4L` — embedded in URL strings at lines 171 and 204.
- **DISCorp API key:** `[REDACTED-AWS-SMTP-PASSWORD]` — line 1053, hardcoded in `sync_to_DISCorp/2`.
- **Rayven UID tokens** (used as authentication credentials in all Rayven API calls):
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 1747, used in `send_to_rayven/7` for `my.rayven.io`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 2000, `pull_from_rayven/1` for `my.rayven.io`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 3423, `pull_data_from_rayven/1`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 4759, `pull_services_from_rayven/1`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 3861, `copy_rental_contracts/1`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 3154, `send_local_arrow_data/0` (Rayven IOTX8 real endpoint).
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 3157 (commented out, speed-only endpoint; still present in source).

These are bearer/UID credentials that grant write access to production Rayven tenants and CalAmp device management. Any person with access to this repository can push arbitrary data to customer tracking systems or enumerate/modify device firmware. They must be moved to runtime environment variables or a secrets manager immediately.

**A101-2 — HIGH — Hardcoded Basic Auth credential in `update_puls_firmware/1` (utility_controller.ex, line 151)**

The `Authorization` header for all CalAmp PULS requests includes:

```elixir
Authorization: "Basic VHJhY2tpbmdTb2x1dGlvbnM6dHZWSFFVc0NBZXU0"
```

This is a Base64-encoded HTTP Basic credential. Decoding `[REDACTED-AWS-SMTP-PASSWORD]` yields `TrackingSolutions:tvVHQUsCAeu4`. This username:password pair for the CalAmp PULS service is committed in plaintext (Base64 is not encryption).

**A101-3 — HIGH — Password in commented-out Rayven login code (utility_controller.ex, lines 3353–3356)**

The `rayven_login/2` function body contains a JavaScript code block in a comment that embeds a cleartext Rayven password:

```
'email': 'graham.oconnell@trackingsolutions.com.au',
'password': 'kz2xA8Y+n#btU*dk'
```

And separately at line 3369:

```
'Authorization': 'Basic be93fbd8a8a936198a368b2bfb4a4e76e6850896a9398652c399a137916e7219',
```

Even though these are in comments and not executed, they are committed to source control, constituting credential exposure. The email/password pattern suggests this is a live Rayven account credential.

**A101-4 — HIGH — Hardcoded Postman tracing headers and host hints in `update_puls_firmware/1` (utility_controller.ex, lines 153–161)**

The request headers include:

```elixir
"Postman-Token": "4ca5f9eb-e694-4501-8a36-cab9a08d00b4,32f442cd-eb53-4915-b387-0202196c741a"
```

These are specific Postman tokens that reveal the original development workflow. While these do not grant access by themselves, they indicate the function was copy-pasted from Postman and never cleaned up. More importantly, hardcoding `Host: "puls.calamp.com"` and `"User-Agent": "PostmanRuntime/7.15.2"` is unnecessary and leaks infrastructure details.

**A101-5 — MEDIUM — Hardcoded internal/test Rayven URL with UID in commented code (utility_controller.ex, lines 2426–2428, 3154–3157, 4707)**

Several Rayven IOTX8 URLs with UID tokens appear in commented-out sections but remain in source:

```
https://iotx8.rayven.io:8082/api/main?uid=3064ab70dea22793431c9a950d0435540f87&deviceid=385F
https://iotx8.rayven.io:8082/api/main?uid=30644d88731f847a4d4694cad17e2fa05aa5&deviceid=385F
```

Additionally, line 4707 contains a commented-out URL with a plaintext Rayven password:

```
https://my.rayven.io:8082/api/customTableData?ctid=4483&email=graham.oconnell@trackingsolutions.com.au&pw=kz2xA8Y+n#btU*dk
```

This is the same password found in the `rayven_login` comment. Password in URL is logged in HTTP access logs by any intermediary.

---

### §2: Authentication and Authorization

**A101-6 — CRITICAL — Multiple sensitive endpoints exposed without authentication (router.ex cross-reference)**

Reviewing the router, the following routes are served by the audited controllers and are **outside** the `:authenticated` pipeline:

In the `scope "/"` block (no authentication at all):
- `POST /erp-import` → `UtilityController.erp_import/2`
- `POST /driverid-converter` → `UtilityController.driverid_converter/2`
- `GET /dis-sync` → `UtilityController.sync_to_DISCorp/2`
- `POST /test-omega-data` → `UtilityController.process_incoming_omegawatch_data/2`
- `POST /prodisplay/event` → `UtilityController.process_prodisplay_event/2`
- `GET /geocode` → `UtilityController.do_geocode_lookup/2`
- `GET /error/:status_code` → `UtilityController.do_error/2`

The `/erp-import` endpoint accepts rental and service data and writes it to customer databases. An unauthenticated attacker can POST arbitrary ERP records, injecting false service dates, rental records, and customer data across any supported customer tenant by manipulating the `from` field. The `from` field in `erp_import/2` is used to determine the target customer schema — this is not authenticated, it is user-controlled (see A101-7 below).

`/prodisplay/event` writes vehicle telemetry event records to multiple customer databases without authentication. This allows an unauthenticated actor to inject falsified location, ignition, and operational data.

`/test-omega-data` echoes back the request body without validation — low severity on its own but the endpoint is unnecessary in production.

`/dis-sync` makes an outbound POST to the DISCorp API with hardcoded credentials (see A101-1) and is callable by anyone without authentication.

**A101-7 — CRITICAL — Customer (tenant) determined from user-supplied `from` field without authentication (`erp_import/2`, utility_controller.ex, lines 5666–5698)**

The `erp_import/2` function uses the `from` parameter in the POST body to select which customer database schema to write into:

```elixir
customer =
  case from do
    "SQLserver@sielift.com"  -> "vx_sielift"
    "rayven+cea@trackingsolutions.io" -> "vx_cea"
    _ -> "vx_dev"
```

There is no authentication, no HMAC signature verification, and no IP allowlisting on this endpoint. Any caller can supply any email address from the known list (all of which are visible in the source code) and write service records and rentals directly into production customer schemas.

**A101-8 — HIGH — `driverid_converter/2` accepts and processes any `from` field without authentication (utility_controller.ex, lines 6025–6090)**

Same pattern as A101-7. The `from` field controls the customer target. The endpoint is unauthenticated and the customer selection logic is identical to `erp_import/2`.

**A101-9 — HIGH — No IDOR protection in `[REDACTED-AWS-SMTP-PASSWORD]` CRUD endpoints (vx_abl_record_controller.ex)**

`show/2` (line 18), `update/2` (line 23), and `delete/2` (line 31) accept an `id` parameter and call `Vx.get_vx_abl_record!(id)` directly with no check that the record belongs to the authenticated user's organisation. While these endpoints are under the `:authenticated` pipeline (per router line 112 mapping `/rhm/services`), an authenticated user from one customer could access or delete ABL records belonging to another customer by supplying a different `id`. The `create/2` action similarly does not enforce customer scoping on the written record.

Note: `rhm_service_records/2` is correctly authenticated and scopes by `customer` from the JWT claims. `generate_service_record/3` is also JWT-scoped. The IDOR risk is confined to the raw CRUD actions.

**A101-10 — MEDIUM — `process_prodisplay_event/2` hardcodes the target customer as `"vx_ceaomega"` (utility_controller.ex, line 339)**

The Prodisplay inbound webhook has no authentication at all (no pipeline), yet it hardcodes `customer = "vx_ceaomega"` and writes event records. The fallback path for SSSL and Mondial EVGL customers is also hardcoded (`"vx_sssl"`, `"vx_mondialevgl"`). While this limits cross-customer data injection from a single call, the absence of any token or signature verification means any internet actor can flood those three customer schemas with fabricated vehicle events.

---

### §3: Input Validation and Injection

**A101-11 — HIGH — XML constructed via string interpolation with unsanitised user/database values (vx_abl_record_controller.ex, lines 148–160; utility_controller.ex, lines 5577–5586, 6003–6004)**

In `generate_service_record/3` (vx_abl_record_controller.ex), the `abl_xml` variable is assembled by direct interpolation of values that originate from the database or from user-controlled request parameters:

```elixir
abl_xml = "<?xml version='1.0'?><documentroot>" <>
  "<performed_by>#{branch_name}</performed_by>" <>
  "<hardwareid>#{thing.aadhardwareid}</hardwareid>" <>
  ...
```

`branch_name` ultimately comes from `Vx.get_branch_for_thing/2`, which queries the database. If any of these string values contain XML special characters (`<`, `>`, `&`, `"`, `'`), the resulting XML will be malformed. If branch names or hardware descriptions are user-editable, this is an XML injection path. The same pattern appears in `check_for_future_date/2` (utility_controller.ex, lines 5577–5586) and `process_service_from_erp/2` (line 6003–6004) where event IDs, customer strings, hardware IDs, and timestamps are interpolated directly into XML.

**A101-12 — MEDIUM — `do_error/2` calls `Plug.Conn.Status.reason_phrase/1` with user-supplied integer, no bounds check (utility_controller.ex, lines 982–989)**

```elixir
def do_error(conn, %{"status_code" => status_code}) do
  status_code_int = String.to_integer(status_code)
  status_phrase = Plug.Conn.Status.reason_phrase(status_code_int)
```

`String.to_integer/1` will raise `ArgumentError` on non-integer input (unhandled). `Plug.Conn.Status.reason_phrase/1` raises `ArgumentError` for unknown status codes. These unhandled exceptions will be caught by Phoenix's error handler, but the stack trace may be returned to the client depending on the ErrorView configuration. The endpoint is also unauthenticated (router line 184).

**A101-13 — MEDIUM — `do_geocode_lookup/2` takes latitude and longitude from unauthenticated user input and passes them to external geocoding calls without validation (utility_controller.ex, lines 991–1050)**

```elixir
def do_geocode_lookup(conn, %{"lat" => inc_lat, "long" => inc_long}) do
  {f_lat, _} = Float.parse(inc_lat)
  {f_long, _} = Float.parse(inc_long)
```

`Float.parse/1` returns `:error` if the input cannot be parsed; the result is pattern-matched as a two-element tuple, so `:error` causes a `MatchError` (unhandled). This causes an uncaught exception visible to the caller. The endpoint is unauthenticated (router line 183). No bounds checking on latitude/longitude values (±90, ±180). SSRF is not applicable as the call goes to a Geonames dependency, but unvalidated float coordinates that are out of range may produce unexpected upstream behaviour.

**A101-14 — LOW — `create_update_object/1` in `pivotel_controller.ex` calls `String.to_float/1` on incoming message fields without guard (lines 55–56, 97–99)**

```elixir
:latitude  => String.to_float(latitude),
:longitude => String.to_float(longitude),
```

`String.to_float/1` raises `ArgumentError` if the input is not a valid float string. If Pivotel sends a malformed or missing float field, the process handling this request will crash. The catch-all `create_update_object/1` clause (line 103) returns an empty map but is only reached for an entirely different message structure, not for a LOCATION message with a bad latitude value.

**A101-15 — LOW — `get_additional_data/1` and `next_service/1` read local CSV files at runtime without path sanitisation (utility_controller.ex, lines 6172–6262)**

```elixir
File.stream!("vehicle_status.csv")
File.stream!("next_services.csv")
```

These use relative paths, meaning they resolve against the OS working directory at runtime (typically the OTP release root). The filenames are hardcoded so path traversal is not a risk here, but if these files are absent the entire `send_vehicle_to_rayven/2` call (which calls both functions) will raise a `File.Error` that is unhandled and will propagate up through the Task.async_stream. More critically, the contents of these CSV files are treated as trusted data piped into the Rayven payload. If an attacker can modify these files on the server (e.g. via a separate vulnerability), they can inject arbitrary data into every Rayven vehicle sync.

---

### §4: Session and CSRF

**A101-16 — HIGH — Inbound webhook endpoints (prodisplay, erp-import, driverid-converter, test-omega) served in the `:api_xml` pipeline which does not enforce CSRF protection and has no token verification**

The `:api_xml` pipeline (router lines 18–22) only sets `plug :fetch_session` and `plug :accepts, ["xml"]`. There is no CSRF plug, no API key middleware, and no bearer token requirement. For endpoints receiving webhook-style POST requests from third-party systems, CSRF is typically not the primary risk, but combined with the complete lack of any authentication (A101-6), there is no defence-in-depth.

§4: No other session/CSRF issues found in these three files specifically; CSRF is enabled in `:browser` pipeline (router line 8) and JWT auth in `:authenticated` pipeline. These files do not handle WebSocket channels.

---

### §5: File and Data Handling

**A101-17 — HIGH — Vehicle GPS coordinates, driver IDs, ignition status, and full event telemetry logged to console via `IO.puts` and `IO.inspect` in production code**

Numerous functions in `utility_controller.ex` and `pivotel_controller.ex` emit PII and fleet operational data to stdout, which in production typically lands in application logs accessible to any operator or log aggregation system:

- `pivotel_controller.ex` line 47: `IO.puts "Need to store a location event"` — though not the data itself, the surrounding context at lines 8 and 48 logs hardware IDs.
- `utility_controller.ex` line 246: logs `hardwareid`, `customer`, `to_date`, `from_date`, `timezone`, `category` in a single `IO.puts`.
- Lines 751–759: logs metadata, location (including latitude/longitude), truck, and TPMS data for specific hardware IDs.
- Lines 1092, 1100, etc.: logs hardware IDs and customer codes during Rayven sync.
- Line 5583 (check_for_future_date): the `abl_xml` string interpolated into log XML contains `event.gmtdatetime`, `event.hardwareid`, and `event.dateinqueue`.
- Line 6154: logs Wiegand driver ID parity bits.

GPS coordinates and driver IDs constitute PII under Australian privacy law and GDPR for any European customers. Driver Wiegand/card IDs at line 6154 (`IO.puts "upper_parity: ..."`) are less sensitive but still operational security data.

**A101-18 — MEDIUM — Error detail (Ecto changeset errors) returned verbatim to client in `process_prodisplay_event/2` (utility_controller.ex, lines 425–426, 434–436, 441–445)**

```elixir
Plug.Conn.send_resp(400,
  Poison.encode!(%{message: Kernel.inspect(thingomega_event_result)}))
```

When an Ecto changeset fails, `error.errors` is an Erlang keyword list of changeset validation errors. `Kernel.inspect/1` converts this to its Elixir term representation and returns it in the HTTP 400 response. This discloses internal schema field names and validation rules to unauthenticated callers. The same pattern applies to `event_id` (line 444): if the event write fails, the raw error structure is returned.

**A101-19 — MEDIUM — `process_ebs_get_hour_meter/2` hardcodes the customer schema prefix as `"vx_cea_latest"` (utility_controller.ex, line 3002)**

```elixir
|> Repo.all(prefix: "vx_cea_latest")
```

This function is called with a `hardwareid` parameter from CSV data (imported via `process_ebs/0` and `process_monthly_movements/0`). Regardless of which customer the calling context intends, the query always runs against `vx_cea_latest`. This is a logic bug that causes cross-customer data leakage: data from another customer's CSV import will be evaluated against CEA Latest's event database.

**A101-20 — MEDIUM — Fleet and rental data containing customer PII sent to Rayven without redaction (utility_controller.ex, send_vehicle_to_rayven/2, lines 1500–1512)**

The Rayven payload includes the end-customer's full address, primary contact name, telephone, and email address:

```elixir
address_1: rental.customer.aaaaddr1,
address_2: rental.customer.aaaaddr2,
primary_contact: rental.customer.aaaprimcont,
primary_telephone: rental.customer.aaaprimtel,
primary_email: rental.customer.aaaprimemail,
```

This data is transmitted to `my.rayven.io:8082` which is a third-party service. The appropriateness of this transfer should be reviewed against privacy agreements. The code itself makes no attempt to minimise or pseudonymise the data before transmission.

**A101-21 — INFO — `check_for_future_date/2` silently deletes telemetry events (utility_controller.ex, lines 5567–5616)**

Events with `gmtdatetime` more than 3600 seconds in the future relative to `dateinqueue` are permanently deleted from the database. While this is intentional behaviour, it operates without any operator notification (the email alert code is commented out at lines 5613–5614). Deleted events cannot be recovered. This is noted as an operational data integrity concern rather than a direct security finding.

---

### §6: Dependencies

§6: No dependency files (`mix.exs`, `mix.lock`) were assigned to this agent. Dependency review is deferred to the agent assigned those files.

---

### §7: Infrastructure Exposure

**A101-22 — HIGH — Production infrastructure hostnames, UIDs, and device IDs hardcoded in source (utility_controller.ex)**

The following production infrastructure endpoints are hardcoded in plain source:

- `https://my.rayven.io:8082` — production Rayven MQTT/HTTP gateway (multiple locations)
- `https://iotx8.rayven.io:8082` — Rayven IOTX8 instance (lines 3154, 3864, 3961)
- `https://external_apis.rayven.io` — Rayven external API (line 3392)
- `https://407110-01.disprism.com/updateEquipmentHourMeter` — DISCorp production endpoint (line 1054)
- `https://puls.calamp.com/service/firmware` — CalAmp PULS production service (lines 145, 170, 201)
- `https://api-test.mobilehourmeter.com/erp-import` — Internal test/staging endpoint (line 4805); the use of the word "test" suggests this may be a non-production service receiving production data.

Together with the hardcoded API keys (A101-1), this constitutes a full roadmap of the production integration topology visible to any repository reader.

**A101-23 — MEDIUM — `do_geocode_lookup/2` is accessible without authentication and makes outbound calls to Geonames (utility_controller.ex, lines 991–1050; router.ex line 183)**

The endpoint at `GET /geocode?lat=...&long=...` is served in the unauthenticated `scope "/"` pipeline. It makes outbound HTTP calls to `Geonames.find_nearby_streets_osm` and `Geonames.find_nearby_place_name` for any user-supplied coordinate pair. This could be abused to use the server as a geocoding proxy, consuming Geonames API quota. Additionally, the endpoint leaks whether the server has Geonames API access configured.

**A101-24 — INFO — TLS certificate loading for Rayven done correctly with `verify: :verify_peer` and custom CA bundle (utility_controller.ex, lines 6267–6291)**

The `rayven_ssl_opts/0` function correctly sets `verify: :verify_peer`, loads the system CA bundle via `:certifi`, and supplements it with a Sectigo Root R46 certificate from `priv/certs/`. This is the fix described in the most recent commit (`e486dd8`). No TLS misconfiguration was found here.

---

## Summary of Findings

| ID | Severity | File | Description |
|---|---|---|---|
| A101-1 | CRITICAL | utility_controller.ex | Multiple live API keys hardcoded in source (CalAmp, DISCorp, Rayven UIDs) |
| A101-2 | HIGH | utility_controller.ex | Base64-encoded HTTP Basic credential for CalAmp PULS hardcoded (line 151) |
| A101-3 | HIGH | utility_controller.ex | Cleartext Rayven password in comment block (lines 3353–3376) |
| A101-4 | HIGH | utility_controller.ex | Postman tokens and redundant Host header in production code (lines 153–161) |
| A101-5 | MEDIUM | utility_controller.ex | Rayven URL with UIDs and password in commented-out code (lines 2426, 4707) |
| A101-6 | CRITICAL | utility_controller.ex / router.ex | Sensitive write endpoints (erp-import, prodisplay, dis-sync) exposed without authentication |
| A101-7 | CRITICAL | utility_controller.ex | Customer/tenant determined from unauthenticated user-supplied `from` field in erp_import/2 |
| A101-8 | HIGH | utility_controller.ex | Same unauthenticated tenant selection in driverid_converter/2 |
| A101-9 | HIGH | vx_abl_record_controller.ex | IDOR: CRUD actions (show, update, delete) do not scope ABL records to authenticated user's organisation |
| A101-10 | MEDIUM | utility_controller.ex | Prodisplay webhook unauthenticated and hardcodes target customer |
| A101-11 | HIGH | vx_abl_record_controller.ex, utility_controller.ex | XML injection via string interpolation of unsanitised database/user values into abl_xml |
| A101-12 | MEDIUM | utility_controller.ex | Unhandled exception in do_error/2 on invalid status_code input |
| A101-13 | MEDIUM | utility_controller.ex | Unvalidated float parse in do_geocode_lookup/2 causes unhandled MatchError |
| A101-14 | LOW | pivotel_controller.ex | String.to_float/1 raises on malformed Pivotel message fields |
| A101-15 | LOW | utility_controller.ex | Runtime CSV file reads (vehicle_status.csv, next_services.csv) with no path validation; absence raises unhandled error |
| A101-16 | HIGH | utility_controller.ex / router.ex | No CSRF or token verification on inbound webhook endpoints |
| A101-17 | HIGH | utility_controller.ex, pivotel_controller.ex | GPS coordinates, driver IDs, and customer PII logged to stdout in production |
| A101-18 | MEDIUM | utility_controller.ex | Ecto changeset errors returned verbatim in HTTP 400 responses from prodisplay endpoint |
| A101-19 | MEDIUM | utility_controller.ex | process_ebs_get_hour_meter/2 hardcodes customer schema prefix as "vx_cea_latest" — cross-customer data leakage |
| A101-20 | MEDIUM | utility_controller.ex | Full customer PII (address, phone, email) transmitted to third-party Rayven service without redaction |
| A101-21 | INFO | utility_controller.ex | Future-dated events silently deleted; alert email commented out |
| A101-22 | HIGH | utility_controller.ex | All production infrastructure hostnames and device IDs hardcoded in source |
| A101-23 | MEDIUM | utility_controller.ex / router.ex | Unauthenticated geocode endpoint usable as Geonames API proxy |
| A101-24 | INFO | utility_controller.ex | TLS Rayven connection uses verify_peer with correct CA bundle — no finding |
