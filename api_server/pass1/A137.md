# Audit Report A137
**Agent:** A137
**Run:** 2026-02-27-01
**Branch:** master
**Stack:** Elixir/Phoenix — api_server
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server_web/views/vx_restriction_view.ex`
2. `lib/api_server_web/views/vx_thing_event_view.ex`
3. `lib/api_server_web/views/vx_thing_omega_view.ex`

Supporting context files read (not assigned, referenced for analysis):
- `lib/api_server_web/controllers/vx_thing_event_controller.ex`
- `lib/api_server_web/controllers/vx_restriction_controller.ex`
- `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
- `lib/api_server_web/router.ex`
- `lib/api_server/vx/vx_restriction.ex`
- `lib/api_server/vx/vx.ex` (relevant excerpts)

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_restriction_view.ex`

**Module name:** `ApiServerWeb.VXRestrictionView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 — `"index.json"` clause | 5 |
| `render` | 2 — `"show.json"` clause | 9 |
| `render` | 2 — `"vx_restriction.json"` clause | 13 |

**defstruct / defexception / schema defined:** None.

**use / import / alias at module level:**

| Kind | Value | Line |
|------|-------|------|
| `use` | `ApiServerWeb, :view` | 2 |
| `alias` | `ApiServerWeb.VXRestrictionView` | 3 |

---

### File 2: `lib/api_server_web/views/vx_thing_event_view.ex`

**Module name:** `ApiServerWeb.VXThingEventView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 — `"index.json"` clause | 5 |
| `render` | 2 — `"show.json"` clause | 9 |
| `render` | 2 — `"vx_thing_event.json"` clause | 13 |

**Private functions (defp, noted for completeness):**

| Name | Arity | Line |
|------|-------|------|
| `omega_to_map` | 1 | 18 |
| `thingevent_to_map` | 1 | 83 |

**defstruct / defexception / schema defined:** None.

**use / import / alias at module level:**

| Kind | Value | Line |
|------|-------|------|
| `use` | `ApiServerWeb, :view` | 2 |
| `alias` | `ApiServerWeb.VXThingEventView` | 3 |

**Fields serialised — `thingevent_to_map/1` (lines 84–131):**
`id`, `gmtdatetime`, `hardwareid`, `eventtype`, `eventcode`, `latitude`, `longitude`, `driverid`, `engineonelapsed`, `totalengineseconds`, `hardwaretype`, `datetimesaved`, `dateinqueue`, `timeoffix`, `altitude`, `heading`, `speed`, `rssi`, `gpsfixquality`, `odometer`, `mifaredriverid`, `ignition`, `ignitionstatus`, `calcengineseconds`, `input1elapsed`, `input1status`, `input1totalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `input2elapsed`, `input2status`, `input2totalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `input3elapsed`, `input3status`, `input3totalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `input4elapsed`, `input4status`, `input4totalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `prntelapsed`, `prntstatus`, `prnttotalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`.

**Fields serialised — `omega_to_map/1` (lines 19–81):**
`accelerometerx`, `accelerometery`, `accelerometerz`, `[REDACTED-AWS-SMTP-PASSWORD]`, `omegadriverid`, `seatbelt`, `seated`, `parkbrakerequest`, `parkbreakreleased`, `vehicleload`, `tilt`, `height`, `overload`, `attretracted`, `yellowled`, `redled`, `greenled`, `liftenable`, `safetyoverride`, `parkbrakerror`, `batterynotcharged`, `lowengineoil`, `accnotcharged`, `[REDACTED-AWS-SMTP-PASSWORD]`, `airfilterblocked`, `attpressure`, `oilcoolerfan`, `lowerinterruption`, `undersafetyheight`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `md3temperature`, `fuellevel`, `md3status`, `xa2status`, `batteryvoltage`, `xa2temperature`, `boomangle`, `boomextension`, `lift`, `extension`, `[REDACTED-AWS-SMTP-PASSWORD]`, `fuelrate`, `totalfuelidle`, `totalidlehour`, `totalenginehour`, `enginerpm`, `capacity`, `coolanttemperature`, `oiltemperature`, `engineerrorcode`, `vehiclespeed`, `gearselection`, `transerrorcode`, `prestartchecklist`, `truckerrorcode`, `mc43status`, `mc43temperature`, `lc5status`, `lc5temperature`.

---

### File 3: `lib/api_server_web/views/vx_thing_omega_view.ex`

**Module name:** `ApiServerWeb.VXThingOmegaView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 — `"container_lift_report.json"` clause | 6 |
| `render` | 2 — `"lift_summary_report_fleet.json"` clause | 17 |
| `render` | 2 — `"lift_summary_report.json"` clause | 39 |
| `render` | 2 — `"lift_list_report.json"` clause | 63 |
| `render` | 2 — `"engine_utilization_report.json"` clause | 77 |
| `render` | 2 — `"operation_summary_report.json"` clause | 92 |

**Private functions (defp):**

| Name | Arity | Line |
|------|-------|------|
| `translate_lift_type_to_string` | 1 | 139 |

**defstruct / defexception / schema defined:** None.

**use / import / alias at module level:**

| Kind | Value | Line |
|------|-------|------|
| `use` | `ApiServerWeb, :view` | 2 |
| `alias` | `ApiServerWeb.VXThingOmegaView` | 3 |

---

## Checklist Review

### §1: Secrets and Configuration

No config files, environment variable access, credentials, API keys, or secret material is present in any of the three view files. Views contain no module attributes, application env lookups, or comments referencing secrets.

**§1: No issues found.**

---

### §2: Authentication and Authorization

#### VXRestrictionView — missing controller actions and absent route

The `VXRestrictionView` exposes three render clauses: `index.json`, `show.json`, and `vx_restriction.json`. The corresponding `[REDACTED-AWS-SMTP-PASSWORD]` (`lib/api_server_web/controllers/vx_restriction_controller.ex`) is effectively empty — it contains only `use ApiServerWeb, :controller`, aliases, and `action_fallback`. No action functions (`index`, `show`, `create`, etc.) are implemented.

No route in `router.ex` references `[REDACTED-AWS-SMTP-PASSWORD]` for any CRUD action on restriction records. The view exists but the controller surface is unused at the HTTP level.

This is noted as an informational item: dead view/controller scaffold for a sensitive access-control data model (`aau_rest` table, which governs fleet access restrictions per user). The risk is latent — if routes are added in future without proper authorization, the full restriction table for any customer could be dumped.

#### VXThingEventController — `index` and CRUD actions are unrouted but exist

The router only exposes:
```
GET /api/v1/rhm/thing/:hardwareid/omega_data  ->  VXThingEventController.get_current_omega_status/2
```
The `index/2`, `show/2`, `create/2`, `update/2`, and `delete/2` actions on `[REDACTED-AWS-SMTP-PASSWORD]` are present in the controller source but are **not wired to any route** in `router.ex`. They are therefore unreachable via HTTP at present.

However, `index/2` calls `Vx.list_vxthingevents()`, which resolves to `Repo.all(VXThingEvent)` — a table scan with **no tenant scoping** and **no pagination**. If this action were ever routed (accidentally or deliberately), it would return all telemetry records across all customers. This is flagged below (A137-2).

#### VXThingEventController — `get_current_omega_status/2` (the one routed action)

This action correctly extracts `customer` from the Guardian JWT claims (`ApiServer.Guardian.Plug.current_claims(conn)["customer"]`) before calling `Vx.get_most_recent_thingevent_with_omega(hardwareid, customer)`. The customer context is enforced at the data layer, not the view layer.

The route is placed inside the `pipe_through([:api, :authenticated])` pipeline scope (line 33 of `router.ex`), so it is behind JWT authentication.

#### VXThingOmegaController — all actions

All six controller actions correctly extract `customer` and `user_id` from JWT claims before querying. All routes for these actions fall within the `pipe_through([:api, :authenticated])` block.

**Finding A137-1 (see below) — `index` action: unrouted but dangerous; `write_partial_record` and `add_calculated_fields` are public but not route-accessible.**

---

### §3: Input Validation and Injection

The view files themselves do not perform any user-input processing, SQL construction, atom creation, or deserialization. They are purely serializers mapping struct fields to map literals.

No `String.to_atom/1`, `fragment/1`, `binary_to_term/1`, `Code.eval_string/1`, or `Kernel.apply/3` usage is present in any of the three files.

**§3: No issues found in the view files themselves.**

---

### §4: Session and CSRF

View files do not configure sessions or CSRF. Not applicable.

**§4: No issues found.**

---

### §5: File and Data Handling

This section is the primary concern for view files in a fleet-management system.

#### VXThingEventView — GPS coordinates and driver IDs in the telemetry response

The `thingevent_to_map/1` private function (lines 84–131) serialises the following sensitive fields unconditionally into every API response for `vx_thing_event.json`:

- **GPS coordinates:** `latitude` (line 90), `longitude` (line 91), `altitude` (line 99), `heading` (line 100), `speed` (line 101), `gpsfixquality` (line 103), `timeoffix` (line 98).
- **Driver identification:** `driverid` (line 92), `mifaredriverid` (line 105).

The `omega_to_map/1` private function additionally serialises:
- `omegadriverid` (line 24) — a second driver ID field from the omega payload.
- Detailed vehicle state data (seatbelt, safety-override, load, error codes, etc.).

All of these fields are emitted in a single flat merged map via `Map.merge(thingevent_to_map(...), omega_to_map(...))` at line 14. There is no field filtering, masking, or role-based exclusion at the view layer.

The route `/api/v1/rhm/thing/:hardwareid/omega_data` is authenticated and customer-scoped (see §2), so the data is not publicly accessible. However, the issue is that **any authenticated user of a customer tenant receives the full GPS track, both driver ID fields, and all safety-override status** for a vehicle. There is no per-user role check to restrict access to sensitive fields such as `driverid`, `mifaredriverid`, and `omegadriverid`. This constitutes over-exposure of PII (driver identity) and real-time location data.

**Finding A137-3 (HIGH) — see below.**

#### VXThingOmegaView — `lift_list_report.json` exposes `operator` field

The `render("lift_list_report.json", ...)` clause (lines 63–75) serialises an `operator` field derived directly from the data layer tuple:

```elixir
fn({datetime, lift_type, vehicle_load, operator, thing_name}) ->
  %{
    ...
    operator: operator,
    ...
  }
```

The field name `operator` in the context of a lift-event report is likely a driver/operator identifier. This is confirmed by the controller calling `Vx.get_list_lift_event_counts_for_thing_by_day/7`. No masking or role-based suppression is applied.

**Finding A137-4 (MEDIUM) — see below.**

#### Logger / IO.puts diagnostic output in VXThingEventController

While not in the view files, the controller used by VXThingEventView contains `IO.puts/1` and `IO.inspect/1` calls (lines 63, 65–68, 79–81) that write hardware IDs, changeset contents (potentially including latitude/longitude/driverid fields), and operational data to stdout. In a production container these will appear in application logs. This is flagged below as A137-5.

---

### §6: Dependencies

No `mix.exs` or `mix.lock` reference appears in the assigned view files.

**§6: No issues found in assigned files.**

---

### §7: Infrastructure Exposure

The view files contain no hostnames, IP addresses, port numbers, CORS configuration, or inter-service call logic.

**§7: No issues found.**

---

## Findings

---

### A137-1 — INFO — Unrouted but public CRUD surface on VXThingEventController

**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex` (referenced by `VXThingEventView`)
**Lines:** 9–44 (`index`, `create`, `show`, `update`, `delete`)

The `[REDACTED-AWS-SMTP-PASSWORD]` exposes five standard CRUD actions and two additional public functions (`write_partial_record/3`, `add_calculated_fields/2`). None of the five CRUD actions is wired to a route in `router.ex`. Only `get_current_omega_status/2` is routed (line 56 of router).

The `index/2` action calls `Vx.list_vxthingevents()` which resolves to an unscoped `Repo.all(VXThingEvent)` — no tenant prefix, no pagination:

```elixir
# lib/api_server/vx/vx.ex line 1622
def list_vxthingevents do
  Repo.all(VXThingEvent)
end
```

If a route is accidentally added, or if a router change maps `resources "/vx_thing_events"` to this controller in the unauthenticated `pipe_through(:api)` scope, a full cross-tenant dump of the telemetry table (including GPS, driver IDs) would be publicly accessible.

**Recommendation:** Either delete the unused CRUD action scaffolding from `[REDACTED-AWS-SMTP-PASSWORD]`, or add a guard comment and explicit documentation that these actions must never be routed. If `list_vxthingevents/0` in `vx.ex` is retained, it must be given a tenant-scoped variant that accepts a customer prefix before any route is added.

---

### A137-2 — HIGH — `Vx.list_vxthingevents/0` has no tenant scoping and no pagination

**Severity:** HIGH
**File:** `lib/api_server/vx/vx.ex` line 1622 (context file, referenced by assigned view)

```elixir
def list_vxthingevents do
  Repo.all(VXThingEvent)
end
```

This function is called exclusively by `VXThingEventController.index/2`. It performs a full-table scan with no `prefix:` (customer schema), no `where` clause, and no limit. For a large fleet deployment the result set could contain millions of records with GPS tracks, driver IDs, and sensor data spanning all customers.

Although the route is currently absent, the function is a latent cross-tenant data-leak vector. The correct pattern used elsewhere in the codebase is `Repo.all(..., prefix: customer)`.

**Recommendation:** Add tenant scoping and pagination to `list_vxthingevents/0`, or remove it entirely if it is not intended for use.

---

### A137-3 — HIGH — Full GPS coordinates and dual driver IDs exposed in every telemetry response

**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`
**Lines:** 83–131 (`thingevent_to_map/1`), lines 18–81 (`omega_to_map/1`), line 14 (merge)

Every call to `render("vx_thing_event.json", ...)` (used by both the `show.json` and the `get_current_omega_status` route) serialises the following sensitive fields with no filtering or role check:

- **Real-time GPS:** `latitude`, `longitude`, `altitude`, `heading`, `speed`, `gpsfixquality`, `timeoffix`
- **Driver PII:** `driverid` (line 92), `mifaredriverid` (line 105), `omegadriverid` (omega line 24)

Three separate driver-identification fields are present in the same response. The `mifaredriverid` field specifically represents a Mifare card identifier (physical proximity card) — a hardware token number that could be used to clone or track an individual worker's identity across systems.

The route `/api/v1/rhm/thing/:hardwareid/omega_data` is authenticated and customer-scoped, so this is not a public data leak. However:

1. Any user within a tenant can query live GPS position and driver identity for any vehicle by hardware ID — there is no per-user role or fleet-membership check at the controller or view layer.
2. The three driver-identity fields (one from the core event, two from the omega payload) are duplicated and over-exposed in a way that is unlikely to all be required by every consumer of this endpoint.

**Recommendation:**
- Audit which client use-cases genuinely require `driverid`, `mifaredriverid`, and `omegadriverid` simultaneously. Expose only the minimum required.
- Apply a fleet-membership or role check in the controller before returning location data, consistent with the fleet-scoped access model visible in `get_list_of_valid_fleets_for_user/2` elsewhere in `vx.ex`.
- Consider a separate, more restricted endpoint for clients that only need operational state (seatbelt, park-brake, load) without GPS and driver identity.

---

### A137-4 — MEDIUM — Operator (driver) identity exposed in lift list report without role filtering

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`
**Lines:** 63–75 (`render("lift_list_report.json", ...)`)

The `lift_list_report.json` response includes an `operator` field in each lift event record:

```elixir
%{
  thing_name: thing_name,
  gmtdatetime: event_time,
  lift_type: translate_lift_type_to_string(lift_type),
  operator: operator,
  vehicle_load: vehicle_load
}
```

The `operator` value is sourced from the tuple returned by `Vx.get_list_lift_event_counts_for_thing_by_day/7` and represents a driver/operator identifier associated with each lift event. This report endpoint (`GET /api/v1/rhm/omega_thing/:hardwareid/lift_list_report`) is authenticated and customer-scoped in the controller, but there is no role-based check to determine whether the requesting user has permission to view individual operator-level attribution.

This creates a scenario where any authenticated user (e.g., a read-only fleet viewer) can enumerate every operator who used a particular piece of equipment over a date range, which may constitute processing of employee personal data under privacy regulations (e.g., GDPR, Australian Privacy Act).

**Recommendation:** Apply a role check in `VXThingOmegaController.get_lift_list_report/2` before serialising operator identity. If no role check is feasible in the short term, document the data-privacy impact and obtain a privacy review sign-off.

---

### A137-5 — MEDIUM — `IO.puts` / `IO.inspect` in production controller path leaks PII to application logs

**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Lines:** 63, 65–68, 79–81

Three diagnostic output calls are present in production controller code called by `write_partial_record/3` and `add_calculated_fields/2`:

```elixir
# Line 63
IO.puts("Inserted")

# Lines 65–68
{:error, changeset} ->
  case changeset.errors do
    _ ->
      IO.inspect(changeset)
  end

# Lines 79–81
IO.puts(
  "totalengineseconds is nil for #{record_to_add.hardwareid} but aadhourmeter is set to ..."
)
```

`IO.inspect(changeset)` will dump the full changeset struct to stdout, which may include `latitude`, `longitude`, `driverid`, and other sensor fields from the rejected record. `IO.puts` with `hardwareid` in the format string will also write equipment identifiers to logs.

In production these writes reach stdout/stderr and will be captured by container log aggregation (CloudWatch, etc.), where they may be retained, indexed, and accessible to log-system users who should not have visibility of individual GPS or driver records.

**Recommendation:** Replace all `IO.puts` and `IO.inspect` calls with structured `Logger` calls at appropriate levels (`Logger.debug` for success paths, `Logger.error` for changeset failures). Ensure that PII fields (`latitude`, `longitude`, `driverid`) are excluded from logged changeset details — log only the error keys, not the full changeset data.

---

### A137-6 — MEDIUM — VXRestrictionView exposes internal user-ID and customer-code fields

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_restriction_view.ex`
**Lines:** 13–21

The `vx_restriction.json` render clause serialises all fields of the `aau_rest` access-control table including:

```elixir
%{id: vx_restriction.id,
  aauid: vx_restriction.aauid,
  aauuser_id: vx_restriction.aauuser_id,
  aaucustcode: vx_restriction.aaucustcode,
  aaufun: vx_restriction.aaufun,
  aaucharval: vx_restriction.aaucharval,
  aaunumval: vx_restriction.aaunumval}
```

This table is the fleet-access control table (`aau_rest`): it maps users (`aauuser_id`) to the fleets (`aaunumval` where `aaufun = "FLEET"`) they are permitted to access. Exposing the full restriction row — including the internal user numeric ID, customer code, and the function code (`aaufun`) — provides a caller with a complete map of the tenant's user-to-fleet access matrix.

Although no HTTP route currently points to `[REDACTED-AWS-SMTP-PASSWORD]` (the controller is empty), the view is fully implemented and ready to serve this data. If a route is added without careful authorization gating, any authenticated user could enumerate all users' fleet permissions within the tenant.

**Recommendation:**
- If this view is ever routed, restrict its use to admin-role users only — never to general authenticated users.
- Consider stripping `aauuser_id` (raw database ID) from the response and returning only the fleet associations relevant to the requesting user.
- Add a comment in the view and controller explicitly documenting that this endpoint must be admin-only.

---

### A137-7 — LOW — Duplicate route definition for `operation_summary_report`

**Severity:** LOW
**File:** `lib/api_server_web/router.ex`
**Lines:** 91–100

The route `GET /api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` is defined twice:

```elixir
# Line 91–94
get(
  "/rhm/omega_fleet/:fleetid/operation_summary_report",
  VXThingOmegaController,
  :get_operation_summary_report
)

# Line 96–100 (duplicate)
get(
  "/rhm/omega_fleet/:fleetid/operation_summary_report",
  VXThingOmegaController,
  :get_operation_summary_report
)
```

In Phoenix, the first matching route takes precedence and the second is silently ignored. This is dead code that creates maintenance confusion and may mask a copy-paste error where a different action or path was intended for the second entry.

**Recommendation:** Remove the duplicate route definition. Review whether a distinct variant (e.g., with different parameters or a different path segment) was intended.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A137-1 | INFO | `vx_thing_event_controller.ex` | Unrouted CRUD scaffold — dangerous if ever routed; `index` has no tenant scope |
| A137-2 | HIGH | `vx.ex` (via view) | `list_vxthingevents/0` performs full cross-tenant table scan with no scope or pagination |
| A137-3 | HIGH | `vx_thing_event_view.ex` | GPS coordinates and three driver ID fields exposed in every telemetry response without per-user role check |
| A137-4 | MEDIUM | `vx_thing_omega_view.ex` | Operator identity serialised in lift-list report without role filtering — privacy impact |
| A137-5 | MEDIUM | `vx_thing_event_controller.ex` | `IO.puts`/`IO.inspect` in production path may write GPS coordinates and driver IDs to logs |
| A137-6 | MEDIUM | `vx_restriction_view.ex` | Full user-to-fleet access control matrix exposed if view is ever routed; no admin-only guard |
| A137-7 | LOW | `router.ex` | Duplicate route definition for `operation_summary_report` |
