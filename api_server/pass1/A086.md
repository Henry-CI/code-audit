# Security Audit Pass 1 — Agent A086
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Auditor:** A086

---

## Files Reviewed

1. `lib/api_server/vx/vx_thing_event_omega_tires.ex`
2. `lib/api_server/vx/vx_thing_info.ex`
3. `lib/api_server/vx/vx_thing_summary.ex`

---

## File 1: `lib/api_server/vx/vx_thing_event_omega_tires.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingEventOmegaTires`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `changeset` | 2 | 58 |

**Schema defined:** `"thingomegatires"` (Ecto schema, no explicit primary key — inherits default `id`)

Schema fields:
- `:pressurewarning0` — `:integer`
- `:pressureleakage0` — `:integer`
- `:temperaturehigh0` — `:integer`
- `:receivetimeout0` — `:integer`
- `:carbatteryvoltageexceed0` — `:integer`
- `:sensorbatteryvoltagelow0` — `:integer`
- `:tirepressure0` — `:integer`
- `:temperature0` — `:integer`
- *(fields 1–5 repeat the same 8 fields with suffix 1 through 5)*
- `:pressurewarning1` through `:temperature5` — `:integer` (40 fields total, 8 per tire × 6 tires)
- `belongs_to :thingevent` — `ApiServer.Vx.VXThingEvent` with `foreign_key: :id, references: :id, primary_key: true, define_field: false`

**use / import / alias at module level:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

---

### Checklist Review

**§1: No issues found.**

**§2: No issues found.** (Schema/changeset module only; no authentication logic.)

**§3:**

> **A086-1** — LOW — Missing validation on all sensor fields in changeset.

`changeset/2` at line 60 casts all 48 sensor fields plus `:id` but calls `validate_required` only for `:id`. None of the sensor integer fields have `validate_number` bounds checks. Values such as `:tirepressure0`, `:temperature0`, etc. are accepted at any integer value, including negatives or impossibly large values. While this is a data-integrity concern rather than a direct injection risk (Ecto parameterises the insert), it means malformed telemetry data written via this changeset is not rejected. This could corrupt fleet analytics or trigger incorrect pressure/temperature alerts.

**§4: No issues found.**

**§5: No issues found.**

**§6: No issues found.**

**§7: No issues found.**

---

## File 2: `lib/api_server/vx/vx_thing_info.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingInfo`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `getWithHardwareId` | 2 | 24 |
| `service_performed` | 3 | 31 |
| `[REDACTED-AWS-SMTP-PASSWORD]` | 2 | 47 |
| `make_info_record` | 2 | 57 |
| `update_existing_record` | 3 | 74 |

**Schema defined:** `"thing_info"` with `@primary_key {:id, :id, autogenerate: true}`

Schema fields:
- `:averageweeklyusage` — `:float`
- `:pmnotificationid` — `:integer`
- `:pmnotificationdate` — `:date`
- `:usagesincenotification` — `:integer`
- `belongs_to :thing` — `VXThing` with `foreign_key: :hardwareid, references: :aadhardwareid`

**use / import / alias at module level:**
- `use Ecto.Schema`
- `import Ecto.Changeset`
- `require Ecto.Query`
- `require Ecto.Adapters.SQL`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXThing`
- `alias ApiServer.Vx.VXThingInfo`
- `alias ApiServer.Repo`

---

### Checklist Review

**§1:**

> **A086-2** — LOW — Hardcoded magic date and notification ID in `make_info_record/2`.

At lines 59 and 67, `make_info_record/2` initialises new `thing_info` records with a hardcoded `notification_date = ~D[2019-01-13]` and `pmnotificationid: 12`. These values are not configurable and are baked into production code. Any device that does not yet have a `thing_info` record will receive a fabricated historical PM notification dated 2019-01-13 with a fixed ID of 12. This is a data-integrity issue: it may cause incorrect PM service notifications to be presented to end-users or customers, and could mask legitimate PM state for fleet operators. It is not a security vulnerability per se but is flagged as LOW because it could affect business logic that drives customer-facing alerts.

**§2: No issues found.** (No authentication or authorisation logic in this module itself; `customer` is passed through as the Postgres schema prefix by callers.)

**§3:**

> **A086-3** — MEDIUM — `require Ecto.Adapters.SQL` present but no corresponding safe usage; unused `require` implies intent.

`Ecto.Adapters.SQL` is required at line 7 but is not directly called anywhere in this file. Its presence alongside `require Ecto.Query` suggests it was previously used (or is planned to be used) for raw SQL execution. While no active raw-SQL call is present here, the `require` should be removed to reduce the attack surface and avoid confusion during future maintenance. If raw SQL is introduced later, reviewers may not scrutinise it carefully because the `require` is already present. Classified MEDIUM because it is an indicator of unsafe pattern intent rather than an active vulnerability.

**§3 (continued):**

> **A086-4** — MEDIUM — No changeset-based validation on `Ecto.Changeset.change/2` calls in `make_info_record/2` and `update_existing_record/3`.

At lines 70, 92, and 43, all writes to the `thing_info` table use `Ecto.Changeset.change/2` (not `Ecto.Changeset.cast/3`). `Ecto.Changeset.change/2` performs no type-coercion, no validation, and no whitelist enforcement; it directly merges the provided map into the struct. If the `params` map in `make_info_record/2` or `update_existing_record/3` ever contains unexpected keys (e.g. due to upstream change), those keys will be silently included. The module also defines a `changeset/2` function (not shown — absent from this file; no public `changeset` def is present), but it is never called for these write paths. Writes should pass through a validated changeset.

**§4: No issues found.**

**§5:**

> **A086-5** — MEDIUM — `[REDACTED-AWS-SMTP-PASSWORD]` and `averageweeklyusage` are fleet operational data that flow through logging-visible code paths without PII audit trail, but no direct Logger leak is visible in this file. No issue within scope of this file.

Specifically: no `Logger` calls are present in `vx_thing_info.ex`. No PII leak found within this file.

**§5: No issues found** (within this file).

**§6: No issues found.**

**§7: No issues found.**

---

## File 3: `lib/api_server/vx/vx_thing_summary.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingSummary`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `changeset` | 2 | 49 |
| `make_or_update_summary` | 2/3 (default arg) | 56 |
| `validate_for_hardwareid` | 2 | 138 |
| `is_valid?` | 2 | 156 |

**Schema defined:** `"abm_summary"` with `@primary_key {:abmid, :id, autogenerate: true}`

Schema fields:
- `:abmgmtdatetime` — `:utc_datetime`
- `:abmdesc` — `:string`
- `:abmignitionstatus` — `:string`
- `:abmeventtype` — `:integer`
- `:abmeventcode` — `:integer`
- `:abmtotalengineseconds` — `:integer`
- `:abmcalctotalengineseconds` — `:integer`
- `:abmtotalenginesecondssinceservice` — `:integer`
- `:abmhourmeter1` — `:integer`
- `:abmcalchourmeter1` — `:integer`
- `:abmhourmeter1sinceservice` — `:integer`
- `:abmhourmeter2` — `:integer`
- `:abmcalchourmeter2` — `:integer`
- `:abmhourmeter2sinceservice` — `:integer`
- `:abmhourmeter3` — `:integer`
- `:abmcalchourmeter3` — `:integer`
- `:abmhourmeter3sinceservice` — `:integer`
- `:abmhourmeter4` — `:integer`
- `:abmcalchourmeter4` — `:integer`
- `:abmhourmeter4sinceservice` — `:integer`
- `:abmodometer` — `:integer`
- `:abmcalcodometer` — `:integer`
- `:abmodometersinceservice` — `:integer`
- `:abmlatitude` — `:float`
- `:abmlongitude` — `:float`
- `:abmheading` — `:float`
- `:abmspeed` — `:float`
- `:abmdriverid` — `:string`
- `:abmmifaredriverid` — `:string`
- `:abmcustcode` — `:string`
- `:abmusagesinceservice` — `:float`
- `:abmhourmeteromega` — `:float`
- `:abmcalchourmeteromega` — `:float`
- `:abmhourmeterothcan` — `:float`
- `:abmcalchourmeterothcan` — `:float`
- `:abmrhmprestartlastgmt` — `:utc_datetime`
- `:abmrhmprestartchecklist` — `:string`
- `belongs_to :thing` — `ApiServer.Vx.VXThing` with `foreign_key: :abmhardwareid, references: :aadhardwareid`

**use / import / alias at module level:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

---

### Checklist Review

**§1: No issues found.**

**§2:**

> **A086-6** — HIGH — `VXThingSummaryController.index/2` and `show/2` are in an unauthenticated scope and return cross-tenant fleet data including GPS coordinates, driver IDs, and odometer readings.

`[REDACTED-AWS-SMTP-PASSWORD]` is mounted at line 162 of `router.ex` inside the second `scope "/api/v1"` block at line 156, which uses only `pipe_through(:api)`. The `:authenticated` pipeline (`ApiServer.Guardian.AuthPipeline`) is NOT applied to this scope. As a result, the following actions are completely unauthenticated:

- `index` (line 9–11) — calls `Vx.list_vxthingsummaries()` which executes `Repo.all(VXThingSummary)` with no `prefix:` argument, returning ALL summary records for ALL customers.
- `show` (line 23–25) — calls `Vx.get_vx_thing_summary!(id)` with no customer scoping.
- `create` (line 14–21) — creates a summary record with no authentication.
- `update` (line 28–33) — updates any summary record by ID with no authentication.
- `delete` (line 36–40) — deletes any summary record by ID with no authentication.

The `abm_summary` table schema contains: GPS latitude/longitude (`:abmlatitude`, `:abmlongitude`), driver ID (`:abmdriverid`), Mifare driver ID (`:abmmifaredriverid`), customer code (`:abmcustcode`), heading, speed, odometer, and engine hours. This is highly sensitive fleet operational and PII data. Any unauthenticated caller can enumerate all customer vehicle positions and driver records, and can modify or delete summary records for any vehicle across all tenants. This is a critical multi-tenant data breach vector.

Note: `list_vxthingsummaries` also does not accept a `customer` prefix, meaning this is a full cross-tenant data dump with no authentication and no tenant scoping.

> **A086-7** — HIGH — `VXThingInfoController.fix_infos/2` and related `get_info/2` are in an unauthenticated scope with no customer ownership verification.

`GET /api/v1/rhm/:customer/fix_info` (router line 176) is in the second scope block using only `pipe_through(:api)` — no authentication. The `customer` parameter comes directly from the URL path. An unauthenticated caller can trigger recalculation of PM notification records for any customer schema by supplying an arbitrary `customer` value. While `fix_infos/2` does not directly return data (returns `{}`), it performs DB writes against the supplied `customer` schema, potentially resetting or corrupting PM service state for any tenant.

Additionally, `get_info/2` at line 17 is defined in the controller but is not routed (no GET route for `/:customer/info/:id` exists in the router), however the function is public and accessible if a route is added without review.

**§3:**

> **A086-8** — MEDIUM — Unsafe `Integer.parse/1` result used as primary key field without validating remainder.

In `make_or_update_summary/3` at lines 66–71, when `hardwareid` is not already an integer, the code pattern-matches `{hardwareid_parsed, result} = Integer.parse(hardwareid)`. `Integer.parse/1` returns `{integer, remainder_string}` — if the input is `"123abc"`, `hardwareid_parsed` will be `123` and `result` will be `"abc"`. The variable `result` is assigned but never checked. The parsed integer `123` will then be inserted as `abmhardwareid` even though the original input `"123abc"` is not a valid integer hardware ID. This silently truncates malformed input and writes corrupted data to the summary table. Additionally, `Integer.parse/1` raises no error on non-integer strings but returns `:error` as an atom when the string starts with a non-digit — this would cause a match error (crash) if `hardwareid` is a non-numeric string like `"abc"`, since `:error` cannot be matched to `{hardwareid_parsed, result}`. This is both a data-integrity issue and a potential crash vector.

> **A086-9** — LOW — `validate_for_hardwareid/2` discards the return value of `make_or_update_summary/3`.

At line 150, inside `validate_for_hardwareid/2`, the result of `make_or_update_summary(hardwareid, customer, summary)` is the return value of `ApiServer.Vx.update_or_insert_summary/3`, which returns `{:ok, record}` or `{:error, changeset}`. Neither branch is pattern-matched; errors are silently swallowed. If the DB write fails (e.g., constraint violation, connection failure), the caller receives no indication. The unused variable `timestamp = Timex.now()` at line 149 (also never used) suggests incomplete implementation.

> **A086-10** — LOW — Dead/unused variable `timestamp` in `validate_for_hardwareid/2`.

Line 149: `timestamp = Timex.now()` is assigned but never used. This is dead code; it adds an unnecessary external call (`Timex.now()`) and suggests the function was not fully implemented before being committed.

**§4: No issues found** (no session or channel logic in this module).

**§5:**

> **A086-11** — HIGH — Schema contains GPS coordinates, driver IDs, and vehicle location data (`abmlatitude`, `abmlongitude`, `abmdriverid`, `abmmifaredriverid`) exposed via unauthenticated REST endpoints (cross-reference A086-6).

The `abm_summary` schema is the direct backing model for the unauthenticated `[REDACTED-AWS-SMTP-PASSWORD]`. The combination of unprotected endpoints and a schema containing PII (driver IDs, Mifare driver card IDs) and GPS location data constitutes an information disclosure vulnerability. This finding is raised here to note the schema-level concern; the endpoint-level finding is A086-6.

> **A086-12** — MEDIUM — `make_or_update_summary/3` writes GPS coordinates and driver identity to `abm_summary` using `Ecto.Changeset.change/2` (not `cast/3`), bypassing the module's own `changeset/2`.

The module defines `changeset/2` at line 49 with a field whitelist, but `make_or_update_summary/3` at line 135 calls `ApiServer.Vx.update_or_insert_summary/3`, which internally calls `Ecto.Changeset.change(existing_summary, attrs)` directly. This means the field-level cast whitelist in `changeset/2` is completely bypassed for all routine summary updates. Any field in the `updated_summary` map (including latitude, longitude, driver IDs) is written without going through `validate_required([:abmcustcode])` or any other changeset validation.

**§6: No issues found** (no dependency declarations in these files).

**§7: No issues found** (no TLS, CORS, or inter-service communication in these files).

---

## Summary of Findings

| ID | Severity | File | Description |
|---|---|---|---|
| A086-1 | LOW | vx_thing_event_omega_tires.ex | No bounds validation on sensor integer fields in changeset |
| A086-2 | LOW | vx_thing_info.ex | Hardcoded magic date (2019-01-13) and PM notification ID (12) in `make_info_record/2` |
| A086-3 | MEDIUM | vx_thing_info.ex | `require Ecto.Adapters.SQL` present but unused — raw SQL intent indicator |
| A086-4 | MEDIUM | vx_thing_info.ex | All DB writes use `Ecto.Changeset.change/2` instead of validated `cast/3`, bypassing schema validation |
| A086-5 | — | vx_thing_info.ex | (No Logger PII leak found in this file — no issue.) |
| A086-6 | HIGH | vx_thing_summary.ex (via router) | `[REDACTED-AWS-SMTP-PASSWORD]` index/show/create/update/delete are unauthenticated and cross-tenant; expose GPS, driver IDs, fleet data for all customers |
| A086-7 | HIGH | vx_thing_info.ex (via router) | `fix_infos` endpoint is unauthenticated; arbitrary `customer` schema can be targeted by any caller |
| A086-8 | MEDIUM | vx_thing_summary.ex | `Integer.parse/1` result remainder not validated; silently truncates malformed hardware IDs and will crash on non-numeric strings |
| A086-9 | LOW | vx_thing_summary.ex | DB write result from `make_or_update_summary/3` silently discarded in `validate_for_hardwareid/2` |
| A086-10 | LOW | vx_thing_summary.ex | Dead code: `timestamp = Timex.now()` assigned and never used at line 149 |
| A086-11 | HIGH | vx_thing_summary.ex | Schema contains GPS coordinates and driver PII exposed via unauthenticated endpoints (reinforces A086-6) |
| A086-12 | MEDIUM | vx_thing_summary.ex | `make_or_update_summary/3` writes all fields via `Ecto.Changeset.change/2`, bypassing the module's own `changeset/2` validation whitelist |

### Critical Issues: 0
### High Issues: 3 (A086-6, A086-7, A086-11)
### Medium Issues: 4 (A086-3, A086-4, A086-8, A086-12)
### Low Issues: 4 (A086-1, A086-2, A086-9, A086-10)

---

*End of report — Agent A086 — 2026-02-27-01*
