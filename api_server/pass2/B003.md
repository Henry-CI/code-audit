# Audit Report B003
**Audit run:** 2026-02-27-01
**Agent:** B003 (Pass 2)
**Assigned source files:**
- `lib/api_server/operators/file.ex`
- `lib/api_server/operators/operators.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/operators/file.ex`

**Module:** `ApiServer.Operators.File`

**Behaviours/macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined (line 6–11):** `"files"` table
| Field      | Type      | Line |
|------------|-----------|------|
| `:custcode` | `:string` | 7    |
| `:esn`      | `:string` | 8    |
| `timestamps()` | (inserted_at, updated_at) | 10 |

**Functions defined:**

| Name         | Arity | Line | Visibility |
|--------------|-------|------|------------|
| `changeset/2` | 2    | 14   | public     |

**Changeset logic (`changeset/2`, lines 14–18):**
- Casts `:esn` and `:custcode` from attrs.
- Validates both fields are required via `validate_required([:esn, :custcode])`.

---

### File 2: `lib/api_server/operators/operators.ex`

**Module:** `ApiServer.Operators`

**Aliases used:**
- `ApiServer.Repo` (line 7)
- `ApiServer.Operators.File` (line 8)

**Functions defined:**

| Name           | Arity | Line | Visibility |
|----------------|-------|------|------------|
| `list_files/0`  | 0    | 19   | public     |
| `get_file!/1`   | 1    | 37   | public     |
| `create_file/1` | 1    | 51   | public (default arg `%{}`) |
| `update_file/2` | 2    | 69   | public     |
| `delete_file/1` | 1    | 87   | public     |
| `change_file/1` | 1    | 100  | public     |

**Function summaries:**
- `list_files/0` (line 19–21): Returns `Repo.all(File)` — full table scan.
- `get_file!/1` (line 37): Returns single record via `Repo.get!`; raises `Ecto.NoResultsError` if not found.
- `create_file/1` (line 51–55): Builds new `%File{}`, applies changeset, calls `Repo.insert()`. Returns `{:ok, %File{}}` or `{:error, %Ecto.Changeset{}}`.
- `update_file/2` (line 69–73): Applies changeset to existing `%File{}`, calls `Repo.update()`. Returns `{:ok, %File{}}` or `{:error, %Ecto.Changeset{}}`.
- `delete_file/1` (line 87–89): Calls `Repo.delete(file)`. Returns `{:ok, %File{}}` or `{:error, %Ecto.Changeset{}}`.
- `change_file/1` (line 100–102): Returns a bare `%Ecto.Changeset{}` for form tracking; calls `File.changeset(file, %{})`.

---

## TEST COVERAGE SEARCH RESULTS

**Direct test files:** None exist for either module.

**Indirect coverage search — test directory scanned for:**
- `ApiServer.Operators` — 0 matches
- `ApiServer.Operators.File` — 0 matches
- `list_files`, `get_file`, `create_file`, `update_file`, `delete_file`, `change_file` — 0 matches
- `operators` (case-insensitive) — 0 matches
- `changeset` — matches only in `test/support/data_case.ex` (generic helper; no reference to `ApiServer.Operators.File`)

**Conclusion:** Zero test coverage exists for either module anywhere in the test suite.

---

## FINDINGS

---

### B003-1
**Severity:** HIGH
**File:** `lib/api_server/operators/file.ex`
**Finding:** No test file exists for `ApiServer.Operators.File`, and no indirect coverage was found anywhere in the test suite.

The schema module is completely untested. There is no test exercising `changeset/2`, no validation of required-field enforcement, and no confirmation that the schema maps correctly to the `"files"` table.

---

### B003-2
**Severity:** HIGH
**File:** `lib/api_server/operators/operators.ex`
**Finding:** No test file exists for `ApiServer.Operators`, and no indirect coverage was found anywhere in the test suite.

All six public context functions (`list_files/0`, `get_file!/1`, `create_file/1`, `update_file/2`, `delete_file/1`, `change_file/1`) are completely untested. The module is a standard Phoenix context generated by `mix phx.gen.context` and Phoenix itself generates a corresponding test file for such contexts; that generated test file is absent.

---

### B003-3
**Severity:** MEDIUM
**File:** `lib/api_server/operators/operators.ex` — `create_file/1` (line 51)
**Finding:** The success path `{:ok, %File{}}` for `create_file/1` is untested, and the failure path `{:error, %Ecto.Changeset{}}` (triggered when required fields `:esn` or `:custcode` are missing or invalid) is also untested.

Both branches documented in the `@doc` example are exercised by zero tests.

---

### B003-4
**Severity:** MEDIUM
**File:** `lib/api_server/operators/operators.ex` — `update_file/2` (line 69)
**Finding:** Both the success path and the validation-failure path of `update_file/2` are untested. Passing an invalid or empty attrs map should produce `{:error, %Ecto.Changeset{}}` but this is never verified.

---

### B003-5
**Severity:** MEDIUM
**File:** `lib/api_server/operators/operators.ex` — `get_file!/1` (line 37)
**Finding:** The exception path — calling `get_file!/1` with a non-existent ID and expecting `Ecto.NoResultsError` to be raised — is untested. This is the primary documented failure mode for this function.

---

### B003-6
**Severity:** MEDIUM
**File:** `lib/api_server/operators/file.ex` — `changeset/2` (line 14)
**Finding:** The `validate_required([:esn, :custcode])` constraint is untested. There is no test confirming that omitting `:esn`, omitting `:custcode`, or omitting both produces the expected changeset errors.

---

### B003-7
**Severity:** LOW
**File:** `lib/api_server/operators/file.ex` — `changeset/2` (line 14)
**Finding:** Edge cases for field values are untested:
- Empty string (`""`) for `:esn` or `:custcode` — Ecto's `validate_required` treats empty strings as blank by default, which would trigger a validation error, but this is never verified.
- Extremely long strings for `:esn` or `:custcode` — no maximum-length validation is defined and no test confirms or challenges this absence.
- `nil` explicitly passed for either field — untested.

---

### B003-8
**Severity:** LOW
**File:** `lib/api_server/operators/operators.ex` — `create_file/1` (line 51)
**Finding:** `create_file/1` accepts a default argument of `%{}`. Calling `create_file()` with no argument (empty map) is an edge case that should produce a validation failure; this path is untested and the default-arg behaviour is never exercised by any test.

---

### B003-9
**Severity:** LOW
**File:** `lib/api_server/operators/operators.ex` — `delete_file/1` (line 87)
**Finding:** `delete_file/1` is untested in both its success path and any potential constraint-violation failure path (e.g., a foreign-key constraint preventing deletion). There are no tests confirming the record is actually removed from the database after deletion.

---

### B003-10
**Severity:** INFO
**File:** `lib/api_server/operators/operators.ex` — `change_file/1` (line 100)
**Finding:** `change_file/1` is a form-tracking helper that returns a changeset with empty attrs. While it is low-risk, it is completely untested. The return value shape (`%Ecto.Changeset{source: %File{}}`) noted in the docstring is never verified.

---

## SUMMARY TABLE

| ID      | Severity | Module / Function                              | Description                                              |
|---------|----------|------------------------------------------------|----------------------------------------------------------|
| B003-1  | HIGH     | `ApiServer.Operators.File` (whole module)      | No test file; zero coverage for schema/changeset module  |
| B003-2  | HIGH     | `ApiServer.Operators` (whole module)           | No test file; all 6 context functions untested           |
| B003-3  | MEDIUM   | `Operators.create_file/1`                      | Both success and validation-failure paths untested       |
| B003-4  | MEDIUM   | `Operators.update_file/2`                      | Both success and validation-failure paths untested       |
| B003-5  | MEDIUM   | `Operators.get_file!/1`                        | `Ecto.NoResultsError` raise path untested                |
| B003-6  | MEDIUM   | `Operators.File.changeset/2`                   | `validate_required` constraints never tested             |
| B003-7  | LOW      | `Operators.File.changeset/2`                   | Edge cases: empty string, nil, oversized values untested |
| B003-8  | LOW      | `Operators.create_file/1` (default arg)        | Default empty-map argument path untested                 |
| B003-9  | LOW      | `Operators.delete_file/1`                      | Success path and FK-constraint failure path untested     |
| B003-10 | INFO     | `Operators.change_file/1`                      | Form-tracking helper entirely untested                   |
