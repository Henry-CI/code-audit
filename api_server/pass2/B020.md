# Audit Report B020
**Audit run:** 2026-02-27-01
**Agent:** B020 (Pass 2)
**Scope:** Test coverage gaps for four VX controllers

---

## Source Files Audited

1. `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
2. `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
3. `lib/api_server_web/controllers/vx_user_controller.ex`
4. `lib/api_server_web/controllers/vx_user_function_controller.ex`

---

## Test Coverage Search Results

Searched the entire `test/` directory for:
- Module names: `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXUserController`, `[REDACTED-AWS-SMTP-PASSWORD]`
- Case-insensitive path patterns: `vx_thing_omega`, `vx_thing_summary`, `vx_user_controller`, `vx_user_function`
- All individual public function names across all four files

**Result: Zero matches found.** No test file — direct or indirect — exercises any function in any of the four assigned source files.

The only existing controller test files are:
- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`

Neither references any of the audited modules.

---

## Reading Evidence

### 1. `ApiServerWeb.VXThingOmegaController`

**Module:** `ApiServerWeb.VXThingOmegaController`
**Uses:** `ApiServerWeb` (:controller), `Timex`
**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXThing`
**Action fallback:** `ApiServerWeb.FallbackController`

**Public functions defined:**

| Line | Function | Signature |
|------|----------|-----------|
| 10 | `get_container_lift_report/2` | `(conn, %{"hardwareid", "from", "to"})` |
| 22 | `get_lift_summary_report/2` | `(conn, %{"hardwareid", "from", "to"})` — clause 1 |
| 33 | `get_lift_list_report/2` | `(conn, %{"hardwareid", "from", "to"})` |
| 44 | `get_lift_summary_report/2` | `(conn, %{"fleetid", "from", "to"})` — clause 2 |
| 53 | `get_operation_summary_report/2` | `(conn, %{"fleetid", "from", "to"})` |
| 63 | `get_engine_utilization_report/2` | `(conn, %{"hardwareid", "from", "to"})` |

**Types / structs / constants:** None defined.

**Notes:**
- `get_lift_summary_report/2` has two clauses dispatched by parameter key (`hardwareid` vs `fleetid`). Both are untested.
- All actions call `ApiServer.Guardian.Plug.current_claims/1` (requires authenticated connection) and delegate to `ApiServer.Vx` context functions before rendering. No guard, `with`, or error branch is written into these actions — errors would propagate to `FallbackController`.

---

### 2. `ApiServerWeb.VXThingSummaryController`

**Module:** `ApiServerWeb.VXThingSummaryController`
**Uses:** `ApiServerWeb` (:controller)
**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXThingSummary`
**Action fallback:** `ApiServerWeb.FallbackController`

**Public functions defined:**

| Line | Function | Signature |
|------|----------|-----------|
| 9  | `index/2`        | `(conn, _params)` |
| 14 | `create/2`       | `(conn, %{"vx_thing_summary" => ...})` |
| 23 | `show/2`         | `(conn, %{"id" => id})` |
| 28 | `update/2`       | `(conn, %{"id" => id, "vx_thing_summary" => ...})` |
| 36 | `delete/2`       | `(conn, %{"id" => id})` |
| 45 | `do_fix_summary/2` | `(hardwareid, customer)` — non-action public helper |

**Types / structs / constants:** None defined.

**Notes:**
- `create/2` uses `with {:ok, %VXThingSummary{}} <- ...` — the error branch is delegated to `FallbackController` (untested failure path for invalid params).
- `update/2` similarly relies on `with` for error propagation.
- `do_fix_summary/2` is a public function (not a Phoenix action) that calls `VXThingSummary.validate_for_hardwareid/2`. It has no tests and no callers visible within this file.

---

### 3. `ApiServerWeb.VXUserController`

**Module:** `ApiServerWeb.VXUserController`
**Uses:** `ApiServerWeb` (:controller)
**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXUser`
**Action fallback:** `ApiServerWeb.FallbackController`

**Public functions defined:**

| Line | Function | Signature |
|------|----------|-----------|
| 9   | `create/2`                 | `(conn, %{"vx_user" => ...})` |
| 18  | `lookup_customer_from_conn/1` | `(conn)` — non-action public helper |
| 41  | `login/2`                  | `(conn, %{"customer", "password", "email"})` |
| 59  | `change_password/2`        | `(conn, %{"current_password", "new_password"})` |
| 82  | `get_users/2`              | `(conn, %{"customer" => _})` |
| 89  | `get_user_with_email/2`    | `(conn, %{"email", "customer"})` |
| 99  | `update_key_if_value/3`    | `(map, key_to_save, nil)` — clause 1 (nil guard) |
| 100 | `update_key_if_value/3`    | `(map, key_to_save, value_to_add)` — clause 2 |
| 104 | `update_user/2`            | `(conn, %{"customer", "user"})` — clause 1 |
| 127 | `update_user/2`            | `(conn, %{"customer"})` — clause 2 (missing "user" key) |
| 131 | `create_user/2`            | `(conn, %{"customer", "user"})` |
| 153 | `delete_user/2`            | `(conn, %{"customer", "id"})` |
| 168 | `get_user_fleets/2`        | `(conn, %{"user_id"})` |
| 180 | `manage_user_fleets/2`     | `(conn, %{"user_id", "allowed_fleets"})` |

**Types / structs / constants:** None defined.

**Notes:**
- `lookup_customer_from_conn/1` contains a hardcoded origin-to-customer mapping covering 7 specific origins plus a catch-all defaulting to `"vx_dev"`. The catch-all is security-sensitive (unknown origins silently become `"vx_dev"`).
- `login/2` calls `Vx.get_rhm_user/3` without guarding against `nil` or non-map returns before passing to `Guardian.encode_and_sign/2`. A bad credential could raise rather than returning the `{:error, _}` branch.
- `get_user_with_email/2` uses `[user | _] = Vx.get_rhm_user(email, customer)` — a match error will raise (not a graceful 404/500) if the list is empty.
- `change_password/2` has an inline `case changeset.errors do _ -> ...` that catches all errors with a single wildcard — the specific error branch is unreachable dead code.
- `update_user/2` clause 2 (line 127) returns a plain 500 with no "user" key. This defensive fallback is never tested.
- `IO.inspect` left in `lookup_customer_from_conn/1` (line 19) — production debug output.

---

### 4. `ApiServerWeb.VXUserFunctionController`

**Module:** `ApiServerWeb.VXUserFunctionController`
**Uses:** `ApiServerWeb` (:controller)
**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXUserFunction`
**Action fallback:** `ApiServerWeb.FallbackController`

**Public functions defined:** None (all action function bodies are commented out).

**Types / structs / constants:** None defined.

**Notes:**
- The entire action set (`index`, `create`, `show`, `update`, `delete`) is commented out. The module compiles but exposes no endpoints. There is nothing to test at runtime, but the commented-out code represents dead scaffolding that may confuse future developers.

---

## Findings

### B020-1 — HIGH: No test file exists for `[REDACTED-AWS-SMTP-PASSWORD]`

**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
**Severity:** HIGH

No test file exists and no indirect test coverage was found. The module defines six public action functions (with one polymorphic function having two clauses). Zero lines of this controller are exercised by the test suite.

---

### B020-2 — HIGH: No test file exists for `[REDACTED-AWS-SMTP-PASSWORD]`

**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
**Severity:** HIGH

No test file exists and no indirect test coverage was found. The module defines five Phoenix actions plus one public non-action helper (`do_fix_summary/2`). Zero lines are covered.

---

### B020-3 — HIGH: No test file exists for `VXUserController`

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** HIGH

No test file exists and no indirect test coverage was found. This is the most complex of the four controllers, with 14 distinct public functions/clauses including authentication (`login/2`), password change, user CRUD, and fleet management. Zero lines are covered.

---

### B020-4 — HIGH: No test file exists for `[REDACTED-AWS-SMTP-PASSWORD]`

**File:** `lib/api_server_web/controllers/vx_user_function_controller.ex`
**Severity:** HIGH

No test file exists. The module has no active functions (all are commented out), but the module itself has no tests confirming it compiles cleanly or that the action_fallback is wired correctly. Severity is lower in practice but remains HIGH by policy (source file with no test file at all).

---

### B020-5 — MEDIUM: All six actions in `[REDACTED-AWS-SMTP-PASSWORD]` untested

**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
**Severity:** MEDIUM
**Lines:** 10, 22, 33, 44, 53, 63

Each of `get_container_lift_report/2`, `get_lift_summary_report/2` (both clauses), `get_lift_list_report/2`, `get_operation_summary_report/2`, and `get_engine_utilization_report/2` lacks any test. Both the happy path (valid date range and hardware/fleet ID) and the error path (invalid ID causing `Vx.get_thing_name_with_hardware_id!/2` to raise) are untested.

---

### B020-6 — MEDIUM: All five actions in `[REDACTED-AWS-SMTP-PASSWORD]` untested

**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
**Severity:** MEDIUM
**Lines:** 9, 14, 23, 28, 36

`index/2`, `create/2`, `show/2`, `update/2`, and `delete/2` are all untested. This is a full CRUD controller with no test coverage at all — happy paths, invalid-data paths, and not-found paths are all missing.

---

### B020-7 — MEDIUM: `do_fix_summary/2` public helper untested

**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
**Severity:** MEDIUM
**Line:** 45

`do_fix_summary/2` is a public function that delegates to `VXThingSummary.validate_for_hardwareid/2`. It is not a Phoenix action (takes `hardwareid` and `customer`, not `conn`), has no callers visible in this file, and has no tests. Its purpose and expected return values are unclear.

---

### B020-8 — MEDIUM: `login/2` action completely untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 41–57

Authentication is the highest-risk path in this controller. Neither the success path (valid credentials → JWT token issued, session set) nor the failure path (`{:error, _message}` from `Guardian.encode_and_sign/2` → 500 response) is exercised by any test.

---

### B020-9 — MEDIUM: `change_password/2` action untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 59–80

No test covers: successful password change, incorrect current password (`user == nil`), empty `new_password`, or Ecto changeset error on update.

---

### B020-10 — MEDIUM: `create_user/2`, `update_user/2`, `delete_user/2` untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 104–165

All three user-mutation actions are untested. Error branches — duplicate email on create (line 133–134), duplicate email on update (line 116), generic Ecto error on update (line 118), delete failure (line 159–160), and the defensive `update_user/2` clause with no "user" key (line 127–129) — are completely unexercised.

---

### B020-11 — MEDIUM: `get_users/2`, `get_user_with_email/2`, `get_user_fleets/2`, `manage_user_fleets/2` untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 82, 89, 168, 180

All four read/fleet-management actions lack tests. No happy path or error path is verified.

---

### B020-12 — MEDIUM: `lookup_customer_from_conn/1` untested — security-sensitive

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 18–39

This function maps the HTTP `Origin` header to a customer tenant string. The catch-all clause (`_`) silently maps any unrecognised origin to `"vx_dev"`. There are no tests for any of the seven named origin strings, the default, or malformed/absent Origin headers. A regression here could cause data from one tenant to be served under another tenant context.

---

### B020-13 — MEDIUM: `get_container_lift_report/2` — missing-parameter clause untested

**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
**Severity:** MEDIUM

All omega controller actions use only a single pattern-match clause with required keys (`hardwareid`/`fleetid`, `from`, `to`). If any required parameter is absent the request will fall through to `FallbackController`. This fallback behaviour is never verified.

---

### B020-14 — LOW: `get_user_with_email/2` — empty-list match raises uncaught exception

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Line:** 90

```elixir
[user | _] = Vx.get_rhm_user(email, customer)
```

If `Vx.get_rhm_user/2` returns an empty list `[]`, this match raises a `MatchError` rather than executing the `nil` branch below it. The nil guard on line 92 (`if user != nil`) would never be reached in that scenario. No test documents or guards against this edge case.

---

### B020-15 — LOW: `change_password/2` — dead error-branch code

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Lines:** 71–74

The inner `case changeset.errors do` at line 71 has only a wildcard clause (`_`), making any specific pattern match on changeset errors unreachable. The structure mirrors a copy-paste from `update_user/2` (which does have a specific `[aacuser: ...]` clause) but was not adapted. No test surfaces this dead code.

---

### B020-16 — LOW: `update_key_if_value/3` utility function untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Lines:** 99–102

This two-clause public utility function (nil-value no-op vs. map insert) is called internally but has no direct unit tests. Edge cases — passing an existing key (note: `Map.put_new/3` does NOT overwrite) and passing a non-nil value to a map that already contains the key — are unverified.

---

### B020-17 — LOW: `IO.inspect` debug call in production code path

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Line:** 19

```elixir
IO.inspect get_req_header(conn, "origin")
```

`lookup_customer_from_conn/1` is called on every `login/2` request. The `IO.inspect` will emit the `Origin` header value to stdout/logs on every login attempt. No test asserts this is absent or that it does not leak PII.

---

### B020-18 — LOW: Boundary/edge cases for date range parameters never tested

**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
**Severity:** LOW

All six omega controller actions accept `from_date` and `to_date` as raw string parameters with no validation before passing to `Vx` context functions. Edge cases — empty string, invalid date format, `from > to`, identical from/to — are entirely untested and the behaviour in each case is unknown.

---

### B020-19 — LOW: `manage_user_fleets/2` — side-effect operations untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Lines:** 180–197

This action performs `Enum.each` mutations (add and remove fleet assignments) with no error handling on individual operations. If any `Vx.add_fleet_to_user/3` or `Vx.remove_fleet_from_user/3` call fails, the error is silently swallowed and the function still returns `200 OK`. No test verifies partial-failure behaviour.

---

## Summary Table

| ID      | Severity | File                              | Description |
|---------|----------|-----------------------------------|-------------|
| B020-1  | HIGH     | vx_thing_omega_controller.ex      | No test file at all |
| B020-2  | HIGH     | vx_thing_summary_controller.ex    | No test file at all |
| B020-3  | HIGH     | vx_user_controller.ex             | No test file at all |
| B020-4  | HIGH     | vx_user_function_controller.ex    | No test file at all |
| B020-5  | MEDIUM   | vx_thing_omega_controller.ex      | All 6 actions (both clauses) untested |
| B020-6  | MEDIUM   | vx_thing_summary_controller.ex    | All 5 CRUD actions untested |
| B020-7  | MEDIUM   | vx_thing_summary_controller.ex    | `do_fix_summary/2` helper untested |
| B020-8  | MEDIUM   | vx_user_controller.ex             | `login/2` auth action untested |
| B020-9  | MEDIUM   | vx_user_controller.ex             | `change_password/2` untested |
| B020-10 | MEDIUM   | vx_user_controller.ex             | `create_user/2`, `update_user/2`, `delete_user/2` untested |
| B020-11 | MEDIUM   | vx_user_controller.ex             | `get_users/2`, `get_user_with_email/2`, `get_user_fleets/2`, `manage_user_fleets/2` untested |
| B020-12 | MEDIUM   | vx_user_controller.ex             | `lookup_customer_from_conn/1` security mapping untested |
| B020-13 | MEDIUM   | vx_thing_omega_controller.ex      | Missing-parameter fallback path untested |
| B020-14 | LOW      | vx_user_controller.ex             | `get_user_with_email/2` empty-list match raises uncaught exception |
| B020-15 | LOW      | vx_user_controller.ex             | Dead error-branch in `change_password/2` |
| B020-16 | LOW      | vx_user_controller.ex             | `update_key_if_value/3` utility untested |
| B020-17 | LOW      | vx_user_controller.ex             | `IO.inspect` debug leak on every login |
| B020-18 | LOW      | vx_thing_omega_controller.ex      | Date range boundary/edge cases untested |
| B020-19 | LOW      | vx_user_controller.ex             | `manage_user_fleets/2` silently swallows per-fleet errors |
