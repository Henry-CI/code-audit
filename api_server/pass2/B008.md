# B008 — Audit Report: `lib/api_server/vx/vx.ex`

**Audit run:** 2026-02-27-01
**Agent:** Pass 2 / B008
**Source file:** `C:/Projects/cig-audit/repos/api_server/lib/api_server/vx/vx.ex`
**Total lines:** 3,315

---

## READING EVIDENCE

### Module Name

`ApiServer.Vx`

### Aliases / Dependencies Declared

- `ApiServer.Repo`
- `ApiServer.Vx.VXUser`
- `ApiServer.Vx.VXThingEvent`
- `ApiServer.Vx.VXThingEventOmega`
- `ApiServer.Vx.VXThingEventOmegaTires`
- `ApiServer.Vx.VXFleetAssociation`
- `ApiServer.Vx.VXRestriction`
- `ApiServer.Vx.Geofence`
- `ApiServer.Vx.VXThing`
- `ApiServer.Vx.VXRental`
- `ApiServer.Vx.VXAblRecord`
- `ApiServer.Vx.VXRayvenMessageLog`
- `ApiServer.Vx.VXRayvenStreamStatus`
- `ApiServer.Vx.Equipment`
- `ApiServer.Vx.EquipmentAssignment`
- `ApiServer.Vx.RentalContract`
- `ApiServer.Vx.RentalPeriod`
- `ApiServer.Vx.VXAccessFob` (alias inside module body, line 134)
- `ApiServer.Vx.VXFleet` (alias inside module body, line 220)
- `ApiServer.Vx.VXThingSummary` (alias inside module body, line 1448)
- `ApiServer.Vx.VXAblRecord` (re-aliased at line 2043)
- `ApiServer.Vx.VXCustomer` (alias at line 2860)
- `ApiServer.Vx.VXUserFunction` (alias at line 2969)
- `ApiServer.Vx.ERPImport` (alias at line 3187)

### Every Public Function Defined (with line number)

| # | Function | Arity | Line |
|---|----------|-------|------|
| 1 | `update_key_if_value/3` (2 clauses) | 3 | 27–30 |
| 2 | `list_vxusers/1` | 1 | 33 |
| 3 | `get_vx_user!/2` | 2 | 40 |
| 4 | `get_vx_user_offset/2` | 2 | 47 |
| 5 | `get_vx_user_fleets!/2` | 2 | 54 |
| 6 | `create_vx_user/2` | 2 | 75 |
| 7 | `update_vx_user/3` | 3 | 93 |
| 8 | `update_vx_user_password/3` | 3 | 99 |
| 9 | `delete_vx_user/2` | 2 | 117 |
| 10 | `change_vx_user/1` | 1 | 130 |
| 11 | `list_vxaccessfobs/0` | 0 | 145 |
| 12 | `get_vx_access_fob!/1` | 1 | 163 |
| 13 | `get_vx_access_fob_by_code!/1` | 1 | 165 |
| 14 | `get_vx_access_fobs_for_fleets!/1` | 1 | 177 |
| 15 | `get_vx_fleet_for_access_fob/1` | 1 | 189 |
| 16 | `get_num_vx_admin_fobs/0` | 0 | 198 |
| 17 | `get_vx_admin_fobs/0` | 0 | 199 |
| 18 | `delete_vx_access_fob/1` | 1 | 215 |
| 19 | `list_vxfleets/1` | 1 | 222 |
| 20 | `list_vxfleets/2` | 2 | 227 |
| 21 | `get_list_of_valid_fleets_for_user/2` | 2 | 235 |
| 22 | `get_list_of_valid_equipment_for_user/2` | 2 | 243 |
| 23 | `list_vxfleets_with_equipment/2` | 2 | 264 |
| 24 | `get_vx_fleet_by_name/2` | 2 | 290 |
| 25 | `get_vx_fleet/2` | 2 | 296 |
| 26 | `create_vx_fleet/2` | 2 | 315 |
| 27 | `update_vx_fleet/3` | 3 | 333 |
| 28 | `delete_vx_fleet/2` | 2 | 351 |
| 29 | `change_vx_fleet/1` | 1 | 364 |
| 30 | `update_fleet_assocs/3` | 3 | 378 |
| 31 | `get_equipment_in_fleet/2` | 2 | 392 |
| 32 | `get_hardwareids_in_fleet/2` | 2 | 400 |
| 33 | `get_fleets_for_thing/2` | 2 | 408 |
| 34 | `get_branch_for_thing/2` | 2 | 416 |
| 35 | `list_vxfleetassociations/0` | 0 | 427 |
| 36 | `get_vx_fleet_association!/1` | 1 | 449 |
| 37 | `delete_vx_fleet_association/1` | 1 | 464 |
| 38 | `list_vxthings/1` | 1 | 470 |
| 39 | `list_vxthings_full/1` | 1 | 478 |
| 40 | `list_vxthings_lite/1` | 1 | 492 |
| 41 | `list_vxthing/2` | 2 | 498 |
| 42 | `list_vxthing_full/2` | 2 | 507 |
| 43 | `list_vxthing_lite/2` | 2 | 520 |
| 44 | `list_vxthings/2` | 2 | 528 |
| 45 | `list_augmented_things/2` | 2 | 539 |
| 46 | `list_augmented_things_with_rentals/1` | 1 | 555 |
| 47 | `list_augmented_things_with_rentals_in_fleet/3` | 3 | 568 |
| 48 | `list_augmented_things_in_fleet/3` | 3 | 589 |
| 49 | `list_vxthings_in_fleet/2` | 2 | 608 |
| 50 | `list_vxthings_with_checklists/1` | 1 | 623 |
| 51 | `get_lift_event_counts_for_thing_by_day/5` | 5 | 631 |
| 52 | `get_detailed_lift_event_counts_for_thing_by_day/6` | 6 | 651 |
| 53 | `get_list_lift_event_counts_for_thing_by_day/6` | 6 | 677 |
| 54 | `get_detailed_lift_event_counts_for_fleet_by_day/5` | 5 | 699 |
| 55 | `get_omega_engine_utilization/5` | 5 | 726 |
| 56 | `get_omega_operation_summary/5` | 5 | 749 |
| 57 | `list_vxthings_for_map/2` (2 clauses, different arg semantics) | 2 | 780, 795 |
| 58 | `augment_thing_with_fleets/2` | 2 | 811 |
| 59 | `augment_thing_with_services/2` | 2 | 816 |
| 60 | `get_hour_meter_start_rental/2` | 2 | 827 |
| 61 | `augment_thing_with_rental_periods/2` | 2 | 871 |
| 62 | `augment_thing_with_usage/2` | 2 | 940 |
| 63 | `get_avg_weekly_hours/2` | 2 | 968 |
| 64 | `get_avg_weekly_hours/3` | 3 | 981 |
| 65 | `get_summary_total_usage/1` | 1 | 985 |
| 66 | `get_usage_since_service/2` | 2 | 1006 |
| 67 | `fetch_actual_usage/2` | 2 | 1030 |
| 68 | `generate_usage_select/2` | 2 | 1042 |
| 69 | `fetch_actual_usage/5` (clause: category 4) | 5 | 1090 |
| 70 | `fetch_actual_usage/5` (clause: category 2) | 5 | 1133 |
| 71 | `fetch_actual_usage/5` (clause: category 3) | 5 | 1174 |
| 72 | `fetch_actual_usage/5` (catch-all clause) | 5 | 1215 |
| 73 | `fetch_actual_usage_thing/4` | 4 | 1230 |
| 74 | `get_movements/5` | 5 | 1235 |
| 75 | `get_vx_thing!/1` | 1 | 1281 |
| 76 | `get_vx_thing!/2` | 2 | 1283 |
| 77 | `get_thing_name_with_hardware_id!/2` | 2 | 1290 |
| 78 | `get_fleet_name_with_id/2` | 2 | 1296 |
| 79 | `get_thing_category_with_hardware_id!/2` | 2 | 1303 |
| 80 | `get_thing_id_with_hardware_id!/2` | 2 | 1311 |
| 81 | `lookup_thing_with_name_serial/3` | 3 | 1319 |
| 82 | `lookup_thing_with_name/2` | 2 | 1328 |
| 83 | `get_vx_thing_with_hardware_id!/1` | 1 | 1337 |
| 84 | `get_vx_thing_with_hardware_id!/2` | 2 | 1347 |
| 85 | `get_augmented_thing_with_hardware_id!/2` | 2 | 1357 |
| 86 | `get_equipment_by_name/2` | 2 | 1363 |
| 87 | `get_equipment_by_serial/2` | 2 | 1371 |
| 88 | `get_equipment_assignments_by_id/2` | 2 | 1377 |
| 89 | `create_vx_thing/2` | 2 | 1395 |
| 90 | `update_vx_thing/3` | 3 | 1413 |
| 91 | `delete_vx_thing/1` | 1 | 1431 |
| 92 | `change_vx_thing/1` | 1 | 1444 |
| 93 | `list_vxthingsummaries/0` | 0 | 1459 |
| 94 | `get_vx_thing_summary!/1` | 1 | 1477 |
| 95 | `get_summary_for_hardwareid/2` | 2 | 1478 |
| 96 | `update_or_insert_summary/3` | 3 | 1484 |
| 97 | `create_vx_thing_summary/1` | 1 | 1501 |
| 98 | `update_vx_thing_summary/2` | 2 | 1519 |
| 99 | `delete_vx_thing_summary/1` | 1 | 1537 |
| 100 | `change_vx_thing_summary/1` | 1 | 1550 |
| 101 | `default_checklist_questions/0` | 0 | 1555 |
| 102 | `get_checklists/1` | 1 | 1586 |
| 103 | `list_vxthingevents/0` | 0 | 1622 |
| 104 | `get_vx_thing_event!/1` | 1 | 1640 |
| 105 | `get_most_recent_thingevent/2` | 2 | 1642 |
| 106 | `get_most_recent_thingevent_with_date/3` | 3 | 1651 |
| 107 | `get_most_recent_thingevent_with_omega/2` | 2 | 1660 |
| 108 | `get_thingevents_for_hardwareid/2` | 2 | 1673 |
| 109 | `get_thingevents_for_hardwareid/4` | 4 | 1680 |
| 110 | `create_vx_thing_event/2` | 2 | 1702 |
| 111 | `update_vx_thing_event/2` | 2 | 1720 |
| 112 | `delete_vx_thing_event/1` | 1 | 1738 |
| 113 | `change_vx_thing_event/1` | 1 | 1751 |
| 114 | `generate_avg_weekly_select/2` | 2 | 1755 |
| 115 | `convert_category_to_regular_units/2` | 2 | 1795 |
| 116 | `get_first_event/2` | 2 | 1824 |
| 117 | `get_actual_avg_weekly_hours/3` (clause: category 4) | 3 | 1842 |
| 118 | `get_actual_avg_weekly_hours/4` (clause: category 4, input=_) | 4 | 1879 |
| 119 | `get_actual_avg_weekly_hours/3` (clause: category 2) | 3 | 1916 |
| 120 | `get_actual_avg_weekly_hours/4` (clause: category 2, input=1) | 4 | 1952 |
| 121 | `get_actual_avg_weekly_hours/3` (clause: category 3) | 3 | 1988 |
| 122 | `get_actual_avg_weekly_hours/3` (catch-all) | 3 | 2026 |
| 123 | `list_service_records/1` | 1 | 2054 |
| 124 | `get_daily_usage/6` | 6 | 2100 |
| 125 | `get_impact_count_by_hardwareid/2` | 2 | 2170 |
| 126 | `get_events/5` | 5 | 2179 |
| 127 | `process_events/0` | 0 | 2192 |
| 128 | `process_events_subprocess/1` | 1 | 2547 |
| 129 | `get_vx_abl_record!/1` | 1 | 2611 |
| 130 | `create_vx_abl_record/1` | 1 | 2625 |
| 131 | `create_abl_record/2` | 2 | 2631 |
| 132 | `create_equipment_record/2` | 2 | 2637 |
| 133 | `get_equipment_id/2` | 2 | 2643 |
| 134 | `create_equipment_assignment_record/2` | 2 | 2650 |
| 135 | `update_vx_abl_record/2` | 2 | 2668 |
| 136 | `delete_vx_abl_record/1` | 1 | 2686 |
| 137 | `change_vx_abl_record/1` | 1 | 2699 |
| 138 | `get_rhm_user/3` | 3 | 2704 |
| 139 | `check_password/3` | 3 | 2712 |
| 140 | `get_rhm_user/2` | 2 | 2719 |
| 141 | `list_all_rentals/1` | 1 | 2730 |
| 142 | `list_open_rentals/1` | 1 | 2740 |
| 143 | `get_rental/2` | 2 | 2753 |
| 144 | `get_active_rental/2` | 2 | 2764 |
| 145 | `get_all_rentals_for_thing/2` | 2 | 2776 |
| 146 | `get_rental/4` | 4 | 2786 |
| 147 | `delete_rental/2` | 2 | 2798 |
| 148 | `update_rental/3` | 3 | 2802 |
| 149 | `create_rental_contract/2` | 2 | 2809 |
| 150 | `create_rental_period/2` | 2 | 2817 |
| 151 | `get_rental_periods_for_contract/2` | 2 | 2825 |
| 152 | `create_rental/2` | 2 | 2831 |
| 153 | `list_customers/1` | 1 | 2871 |
| 154 | `get_vx_customer!/2` | 2 | 2889 |
| 155 | `get_customer/3` | 3 | 2891 |
| 156 | `create_vx_customer/2` | 2 | 2916 |
| 157 | `update_vx_customer/3` | 3 | 2934 |
| 158 | `delete_vx_customer/2` | 2 | 2952 |
| 159 | `change_vx_customer/2` | 2 | 2965 |
| 160 | `list_vxaatuserfunctions/0` | 0 | 2980 |
| 161 | `get_vx_user_function!/1` | 1 | 2998 |
| 162 | `create_vx_user_function/1` | 1 | 3012 |
| 163 | `update_vx_user_function/2` | 2 | 3030 |
| 164 | `delete_vx_user_function/1` | 1 | 3048 |
| 165 | `change_vx_user_function/1` | 1 | 3061 |
| 166 | `list_vxaau_rest/0` | 0 | 3074 |
| 167 | `get_vx_restriction!/1` | 1 | 3092 |
| 168 | `create_vx_restriction/1` | 1 | 3106 |
| 169 | `add_fleet_to_user/3` | 3 | 3112 |
| 170 | `get_restriction/3` | 3 | 3124 |
| 171 | `remove_fleet_from_user/3` | 3 | 3132 |
| 172 | `update_vx_restriction/2` | 2 | 3150 |
| 173 | `delete_vx_restriction/1` | 1 | 3168 |
| 174 | `change_vx_restriction/1` | 1 | 3181 |
| 175 | `delete_erp_import/2` | 2 | 3189 |
| 176 | `create_erp_import/2` | 2 | 3193 |
| 177 | `update_erp_import/3` | 3 | 3199 |
| 178 | `check_for_existing_erp_record/2` | 2 | 3205 |
| 179 | `get_geofence_by_id/2` | 2 | 3223 |
| 180 | `get_geofences/1` | 1 | 3229 |
| 181 | `get_geofences_as_map/1` | 1 | 3234 |
| 182 | `create_geofence/2` | 2 | 3249 |
| 183 | `update_geofence/3` | 3 | 3255 |
| 184 | `delete_geofence/2` | 2 | 3261 |
| 185 | `create_thingevent_record/2` | 2 | 3265 |
| 186 | `update_thingevent_record/3` | 3 | 3271 |
| 187 | `delete_thingevent_record/2` | 2 | 3277 |
| 188 | `create_thingeventomega_record/2` | 2 | 3281 |
| 189 | `create_thingomegatires_record/2` | 2 | 3287 |
| 190 | `create_rayven_message_log_record/2` | 2 | 3293 |
| 191 | `update_rayven_stream_status_record/2` | 2 | 3299 |
| 192 | `count_rayven_events_to_stream/3` | 3 | 3305 |

**Private functions declared (not exhaustive — excluded from coverage requirements):**
- `daily_usage_where/2` (line 2062) — private (`defp`)

### Constants / Hard-coded Values Noted

- `get_num_vx_admin_fobs/0` returns integer `7` (line 198)
- `get_vx_admin_fobs/0` returns a hardcoded hex string of 7 fob codes (line 200)
- `default_checklist_questions/0` returns a 25-element list of hardcoded strings (line 1555)
- `process_events/0` hardcodes customer `"vx_cea"`, user_id `37`, and specific email addresses (lines 2196–2307)
- `augment_thing_with_rental_periods/2` hardcodes `from_date = "2019-01-01"`, `to_date = "2020-07-05"`, and `user_timezone = "US/Michigan"` (lines 874–879)

---

## TEST COVERAGE ANALYSIS

### Test files in the repository

```
test/api_server_web/controllers/calamp_controller_test.exs
test/api_server_web/controllers/vx_restriction_controller_test.exs
test/api_server_web/views/layout_view_test.exs
test/api_server_web/views/page_view_test.exs
test/test_helper.exs
```

### Indirect coverage found

`test/api_server_web/controllers/vx_restriction_controller_test.exs` aliases `ApiServer.Vx` and calls exactly **one** context function:
- `create_vx_restriction/1` (line 12, used as a test fixture)

The tests for the restriction controller also exercise the HTTP endpoints which internally call `list_vxaau_rest/0`, `get_vx_restriction!/1`, `create_vx_restriction/1`, `update_vx_restriction/2`, and `delete_vx_restriction/1` indirectly through the controller layer.

No other test file references `ApiServer.Vx` or any function from `vx.ex`.

---

## FINDINGS

---

### B008-1 — No dedicated test file exists for `ApiServer.Vx`

**Severity:** HIGH

**Location:** `lib/api_server/vx/vx.ex`

The largest and most complex context module in the codebase (3,315 lines, ~192 public functions across ~30 functional groups) has no dedicated unit test file. No `test/api_server/vx/vx_test.exs` or equivalent exists. The only test file that references this module is the HTTP-layer `vx_restriction_controller_test.exs`, which exercises at most five of the 192 public functions, all through controller dispatch rather than direct context calls.

---

### B008-2 — VXUser CRUD and query functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 27–132

The following public functions have no test coverage whatsoever:

- `update_key_if_value/3` (lines 27–30)
- `list_vxusers/1` (line 33)
- `get_vx_user!/2` (line 40)
- `get_vx_user_offset/2` (line 47)
- `get_vx_user_fleets!/2` (line 54)
- `create_vx_user/2` (line 75)
- `update_vx_user/3` (line 93)
- `update_vx_user_password/3` (line 99)
- `delete_vx_user/2` (line 117)
- `change_vx_user/1` (line 130)
- `get_rhm_user/3` (line 2704)
- `get_rhm_user/2` (line 2719)
- `check_password/3` (line 2712)

`check_password/3` is particularly sensitive: it compares a plaintext password field directly in SQL (`aacpassword: ^password`), and has no test verifying correct vs. incorrect password behaviour.

---

### B008-3 — VXAccessFob functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 145–217

- `list_vxaccessfobs/0` (line 145)
- `get_vx_access_fob!/1` (line 163)
- `get_vx_access_fob_by_code!/1` (line 165)
- `get_vx_access_fobs_for_fleets!/1` (line 177)
- `get_vx_fleet_for_access_fob/1` (line 189)
- `get_num_vx_admin_fobs/0` (line 198)
- `get_vx_admin_fobs/0` (line 199)
- `delete_vx_access_fob/1` (line 215)

`get_vx_fleet_for_access_fob/1` contains an unchecked field access (`fob.user.aaclic1issuer`) that will crash with a `NilPointerError`-equivalent if `fob` is `nil` (access fob not found) or if `fob.user` is `nil`. Neither error path is tested.

---

### B008-4 — VXFleet and VXFleetAssociation functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 222–466

- `list_vxfleets/1`, `list_vxfleets/2` (lines 222, 227)
- `get_list_of_valid_fleets_for_user/2` (line 235)
- `get_list_of_valid_equipment_for_user/2` (line 243)
- `list_vxfleets_with_equipment/2` (line 264)
- `get_vx_fleet_by_name/2` (line 290)
- `get_vx_fleet/2` (line 296)
- `create_vx_fleet/2` (line 315)
- `update_vx_fleet/3` (line 333)
- `delete_vx_fleet/2` (line 351)
- `change_vx_fleet/1` (line 364)
- `update_fleet_assocs/3` (line 378)
- `get_equipment_in_fleet/2` (line 392)
- `get_hardwareids_in_fleet/2` (line 400)
- `get_fleets_for_thing/2` (line 408)
- `get_branch_for_thing/2` (line 416)
- `list_vxfleetassociations/0` (line 427)
- `get_vx_fleet_association!/1` (line 449)
- `delete_vx_fleet_association/1` (line 464)
- `add_fleet_to_user/3` (line 3112)
- `get_restriction/3` (line 3124)
- `remove_fleet_from_user/3` (line 3132)

`update_fleet_assocs/3` performs a `delete_all` followed by `insert_all` with no transaction wrapping visible in the function; partial failure (delete succeeds, insert fails) leaves the fleet without any associations. This error path is untested.

`get_branch_for_thing/2` calls `List.first` on a query result, which will return `nil` if no branch fleet exists. Callers are not guarded against `nil` and this is untested.

---

### B008-5 — VXThing listing and augmentation functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 470–966

- `list_vxthings/1`, `list_vxthings/2` (lines 470, 528)
- `list_vxthings_full/1` (line 478)
- `list_vxthings_lite/1` (line 492)
- `list_vxthing/2`, `list_vxthing_full/2`, `list_vxthing_lite/2` (lines 498, 507, 520)
- `list_augmented_things/2` (line 539)
- `list_augmented_things_with_rentals/1` (line 555)
- `list_augmented_things_with_rentals_in_fleet/3` (line 568)
- `list_augmented_things_in_fleet/3` (line 589)
- `list_vxthings_in_fleet/2` (line 608)
- `list_vxthings_with_checklists/1` (line 623)
- `list_vxthings_for_map/2` (lines 780, 795 — two clauses with different argument semantics but same arity; distinguishable only at runtime by content)
- `augment_thing_with_fleets/2` (line 811)
- `augment_thing_with_services/2` (line 816)
- `augment_thing_with_usage/2` (line 940)
- `augment_thing_with_rental_periods/2` (line 871)
- `get_hour_meter_start_rental/2` (line 827)
- `get_vx_thing!/1`, `get_vx_thing!/2` (lines 1281, 1283)
- `get_thing_name_with_hardware_id!/2` (line 1290)
- `get_fleet_name_with_id/2` (line 1296)
- `get_thing_category_with_hardware_id!/2` (line 1303)
- `get_thing_id_with_hardware_id!/2` (line 1311)
- `lookup_thing_with_name_serial/3` (line 1319)
- `lookup_thing_with_name/2` (line 1328)
- `get_vx_thing_with_hardware_id!/1`, `get_vx_thing_with_hardware_id!/2` (lines 1337, 1347)
- `get_augmented_thing_with_hardware_id!/2` (line 1357)
- `get_equipment_by_name/2` (line 1363)
- `get_equipment_by_serial/2` (line 1371)
- `get_equipment_assignments_by_id/2` (line 1377)
- `create_vx_thing/2`, `update_vx_thing/3`, `delete_vx_thing/1`, `change_vx_thing/1` (lines 1395, 1413, 1431, 1444)

`list_vxthings_for_map/2` has two clauses with the same arity whose distinction is purely semantic (one takes `user_id`, the other `fleet_id`). Elixir will always dispatch to the first clause; the second clause (line 795) is unreachable in normal usage without additional pattern matching. This is a latent bug with no test coverage.

`augment_thing_with_rental_periods/2` (line 871) contains hardcoded date constants (`"2019-01-01"` and `"2020-07-05"`) that make the function's output stale and incorrect for any real usage past July 2020. No test validates this.

---

### B008-6 — Usage calculation functions (`fetch_actual_usage`, `get_actual_avg_weekly_hours`, `get_summary_total_usage`, `convert_category_to_regular_units`) entirely untested

**Severity:** MEDIUM

**Location:** Lines 985–2041

These are algorithmically complex functions with multiple pattern-matched clauses for different device categories (2, 3, 4, 5, 6, 7, 8, 9, 12, 13, 14):

- `get_summary_total_usage/1` (line 985): 8-branch `case` on `thing.aadcat`; no fallback clause — passing an unexpected category raises `CaseClauseError`
- `fetch_actual_usage/2` (line 1030)
- `generate_usage_select/2` (line 1042): 9-branch `case`; no default clause — unrecognised category raises `CaseClauseError`
- `fetch_actual_usage/5` — 4 clauses (lines 1090, 1133, 1174, 1215)
- `fetch_actual_usage_thing/4` (line 1230)
- `get_avg_weekly_hours/2`, `get_avg_weekly_hours/3` (lines 968, 981)
- `get_actual_avg_weekly_hours/3` — 4 clauses (lines 1842, 1916, 1988, 2026)
- `get_actual_avg_weekly_hours/4` — 2 clauses (lines 1879, 1952)
- `convert_category_to_regular_units/2` (line 1795)
- `generate_avg_weekly_select/2` (line 1755): 8-branch `case`; no default clause — unrecognised category raises `CaseClauseError`
- `get_first_event/2` (line 1824)

The `fetch_actual_usage/5` clauses for categories 2, 3, and 4 use destructured single-element list pattern matches (`[min] = ...` and `[max] = ...`). If the database query returns more than one aggregate row, these will raise `MatchError`. This is untested.

---

### B008-7 — Lift event, Omega engine, and daily usage query functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 631–777, 2100–2177

- `get_lift_event_counts_for_thing_by_day/5` (line 631)
- `get_detailed_lift_event_counts_for_thing_by_day/6` (line 651)
- `get_list_lift_event_counts_for_thing_by_day/6` (line 677)
- `get_detailed_lift_event_counts_for_fleet_by_day/5` (line 699)
- `get_omega_engine_utilization/5` (line 726)
- `get_omega_operation_summary/5` (line 749)
- `get_daily_usage/6` (line 2100)
- `get_impact_count_by_hardwareid/2` (line 2170)
- `get_events/5` (line 2179)
- `get_movements/5` (line 1235)

All functions accept date-range arguments via ISO8601 strings. Invalid date strings (e.g., `"not-a-date"`) will raise `ArgumentError` from `Date.from_iso8601!` with no error handling. None of these paths are tested.

---

### B008-8 — VXThingEvent and VXThingSummary CRUD functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 1459–1553, 1622–1753

- `list_vxthingsummaries/0` (line 1459)
- `get_vx_thing_summary!/1` (line 1477)
- `get_summary_for_hardwareid/2` (line 1478)
- `update_or_insert_summary/3` (line 1484)
- `create_vx_thing_summary/1` (line 1501)
- `update_vx_thing_summary/2` (line 1519)
- `delete_vx_thing_summary/1` (line 1537)
- `change_vx_thing_summary/1` (line 1550)
- `list_vxthingevents/0` (line 1622)
- `get_vx_thing_event!/1` (line 1640)
- `get_most_recent_thingevent/2` (line 1642)
- `get_most_recent_thingevent_with_date/3` (line 1651)
- `get_most_recent_thingevent_with_omega/2` (line 1660)
- `get_thingevents_for_hardwareid/2` (line 1673)
- `get_thingevents_for_hardwareid/4` (line 1680)
- `create_vx_thing_event/2` (line 1702)
- `update_vx_thing_event/2` (line 1720)
- `delete_vx_thing_event/1` (line 1738)
- `change_vx_thing_event/1` (line 1751)
- `create_thingevent_record/2` (line 3265)
- `update_thingevent_record/3` (line 3271)
- `delete_thingevent_record/2` (line 3277)
- `create_thingeventomega_record/2` (line 3281)
- `create_thingomegatires_record/2` (line 3287)

---

### B008-9 — Rental, RentalContract, and RentalPeriod functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 2728–2858

- `list_all_rentals/1` (line 2730)
- `list_open_rentals/1` (line 2740)
- `get_rental/2` (line 2753)
- `get_active_rental/2` (line 2764)
- `get_all_rentals_for_thing/2` (line 2776)
- `get_rental/4` (line 2786)
- `delete_rental/2` (line 2798)
- `update_rental/3` (line 2802)
- `create_rental_contract/2` (line 2809)
- `create_rental_period/2` (line 2817)
- `get_rental_periods_for_contract/2` (line 2825)
- `create_rental/2` (line 2831)

`get_active_rental/2` uses `Ecto.Query.limit(1)` with `Repo.one`, which will raise if the query somehow returns more than one row. No test covers the case where a thing has multiple open rentals. `list_open_rentals/1` uses `or_where` in a way that returns rentals with a `nil` end date OR an end date in the future; the interaction between these two conditions is non-obvious and untested.

---

### B008-10 — VXCustomer, VXUserFunction CRUD functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 2860–3063

- `list_customers/1` (line 2871)
- `get_vx_customer!/2` (line 2889)
- `get_customer/3` (line 2891)
- `create_vx_customer/2` (line 2916)
- `update_vx_customer/3` (line 2934)
- `delete_vx_customer/2` (line 2952)
- `change_vx_customer/2` (line 2965)
- `list_vxaatuserfunctions/0` (line 2980)
- `get_vx_user_function!/1` (line 2998)
- `create_vx_user_function/1` (line 3012)
- `update_vx_user_function/2` (line 3030)
- `delete_vx_user_function/1` (line 3048)
- `change_vx_user_function/1` (line 3061)

---

### B008-11 — Geofence, ERPImport, Rayven, Equipment, and ABL record functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 2043–2060, 2611–2701, 3187–3312

- `list_service_records/1` (line 2054)
- `get_vx_abl_record!/1` (line 2611)
- `create_vx_abl_record/1` (line 2625)
- `create_abl_record/2` (line 2631)
- `update_vx_abl_record/2` (line 2668)
- `delete_vx_abl_record/1` (line 2686)
- `change_vx_abl_record/1` (line 2699)
- `create_equipment_record/2` (line 2637)
- `get_equipment_id/2` (line 2643)
- `create_equipment_assignment_record/2` (line 2650)
- `delete_erp_import/2` (line 3189)
- `create_erp_import/2` (line 3193)
- `update_erp_import/3` (line 3199)
- `check_for_existing_erp_record/2` (line 3205)
- `get_geofence_by_id/2` (line 3223)
- `get_geofences/1` (line 3229)
- `get_geofences_as_map/1` (line 3234)
- `create_geofence/2` (line 3249)
- `update_geofence/3` (line 3255)
- `delete_geofence/2` (line 3261)
- `create_rayven_message_log_record/2` (line 3293)
- `update_rayven_stream_status_record/2` (line 3299)
- `count_rayven_events_to_stream/3` (line 3305)

`get_geofences_as_map/1` (line 3234) performs destructuring `[coord_block | _] = geomap["coordinates"]` and `fn([long, lat]) -> {long, lat} end` that will raise `MatchError` / `FunctionClauseError` on malformed GeoJSON. No test covers invalid or empty coordinate blocks.

`check_for_existing_erp_record/2` (line 3205) has a customer-specific code branch for `"vx_cea"` that filters differently from all other customers. The distinct logic paths are untested.

---

### B008-12 — `process_events/0` and `process_events_subprocess/1` untested; contain hardcoded production credentials

**Severity:** MEDIUM

**Location:** Lines 2192–2594

- `process_events/0` (line 2192)
- `process_events_subprocess/1` (line 2547)

Both functions are completely untested. `process_events/0` contains:
- Hardcoded customer tenant `"vx_cea"` (line 2196)
- Hardcoded user ID `37` (line 2198)
- Hardcoded production email addresses including personal names and addresses (lines 2306, 2357, 2417, 2477)
- Deep conditional nesting (~10 levels) with multiple `IO.puts` debug statements still present

`process_events_subprocess/1` has an inline comment on line 2548 stating "I don't think this is used anymore", yet the function remains public and untested.

---

### B008-13 — Checklist functions return stub/mock data; untested and not production-ready

**Severity:** MEDIUM

**Location:** Lines 1555–1609

- `default_checklist_questions/0` (line 1555)
- `get_checklists/1` (line 1586)

`get_checklists/1` ignores its `hardwareid` argument entirely and returns four hardcoded static checklist records with `DateTime.utc_now()` timestamps and fixed answer arrays. It does not query the database. There is no test verifying this stub behaviour or that callers handle it correctly.

---

### B008-14 — VXRestriction context functions partially tested only at HTTP layer

**Severity:** MEDIUM

**Location:** Lines 3074–3183

`create_vx_restriction/1`, `get_vx_restriction!/1`, `list_vxaau_rest/0`, `update_vx_restriction/2`, and `delete_vx_restriction/1` are exercised only through the HTTP controller test, which uses the test database default schema (no `prefix:` / tenant). The following functions are entirely untested even at the HTTP layer:

- `add_fleet_to_user/3` (line 3112) — inserts a `VXRestriction` with a tenant prefix
- `get_restriction/3` (line 3124)
- `remove_fleet_from_user/3` (line 3132)
- `change_vx_restriction/1` (line 3181)

---

### B008-15 — No test for invalid/nil category in `get_summary_total_usage/1` and `generate_usage_select/2`

**Severity:** LOW

**Location:** Lines 985, 1042

`get_summary_total_usage/1` has a `case thing.aadcat do` with clauses for values `2`–`9` but no `_` fallback. An unknown category value (e.g., category `1`, `10`, `11`, or any future category) raises `CaseClauseError`. Similarly, `generate_usage_select/2` handles categories `12`, `13`, `14`, `5`–`9` but omits category `2`, `3`, and `4` (which are handled by other `fetch_actual_usage` clauses) and has no default. No edge-case test exists for any unexpected category.

---

### B008-16 — No test for nil/empty inputs in date-range functions

**Severity:** LOW

**Location:** Lines 631, 651, 677, 699, 726, 749, 2100, 2179

Functions such as `get_lift_event_counts_for_thing_by_day/5`, `get_daily_usage/6`, and `get_events/5` call `Date.from_iso8601!/1` (bang variant) which will raise `ArgumentError` if passed `nil`, an empty string, or a non-ISO8601 string. No validation or rescue is present, and no test exercises these error paths.

---

### B008-17 — `augment_thing_with_usage/2` hardcodes timezone `"+10:00"`

**Severity:** LOW

**Location:** Line 950

`augment_thing_with_usage/2` hardcodes `user_timezone = "+10:00"` when computing `this_week` and `this_month` usage windows, regardless of the actual user's timezone. This means `this_week` and `this_month` fields returned to all users are computed in AEST regardless of their actual location. No test validates this behaviour or catches the regression risk.

---

## SUMMARY TABLE

| ID | Severity | Description |
|----|----------|-------------|
| B008-1 | HIGH | No dedicated test file for `ApiServer.Vx` (~192 public functions, 3,315 lines) |
| B008-2 | MEDIUM | VXUser CRUD, query, and authentication functions (13 functions) entirely untested |
| B008-3 | MEDIUM | VXAccessFob functions (8 functions) entirely untested; nil-crash risk in `get_vx_fleet_for_access_fob/1` |
| B008-4 | MEDIUM | VXFleet and VXFleetAssociation functions (21 functions) entirely untested; non-transactional `update_fleet_assocs/3` |
| B008-5 | MEDIUM | VXThing listing, lookup, and augmentation functions (~30 functions) untested; unreachable second clause in `list_vxthings_for_map/2`; hardcoded stale dates in `augment_thing_with_rental_periods/2` |
| B008-6 | MEDIUM | Usage calculation functions (12+ clauses) entirely untested; multiple `CaseClauseError` risks on unknown categories; destructured aggregate match risk |
| B008-7 | MEDIUM | Lift event, Omega, daily usage, movements, and impact query functions (10 functions) entirely untested; no date string validation |
| B008-8 | MEDIUM | VXThingEvent and VXThingSummary CRUD functions (24 functions) entirely untested |
| B008-9 | MEDIUM | Rental, RentalContract, and RentalPeriod functions (12 functions) entirely untested |
| B008-10 | MEDIUM | VXCustomer and VXUserFunction CRUD functions (13 functions) entirely untested |
| B008-11 | MEDIUM | Geofence, ERPImport, Rayven, Equipment, and ABL record functions (24 functions) entirely untested; GeoJSON malformed-input crash risk; `check_for_existing_erp_record/2` customer-branch logic untested |
| B008-12 | MEDIUM | `process_events/0` and `process_events_subprocess/1` untested; hardcoded production emails and tenant; stale debug `IO.puts` |
| B008-13 | MEDIUM | `get_checklists/1` returns hardcoded stub data ignoring its argument; no test or note that it is a stub |
| B008-14 | MEDIUM | VXRestriction context tested only via HTTP layer; `add_fleet_to_user/3`, `get_restriction/3`, `remove_fleet_from_user/3`, `change_vx_restriction/1` untested |
| B008-15 | LOW | No fallback clause in `get_summary_total_usage/1` and `generate_usage_select/2`; unknown categories raise uncaught `CaseClauseError` |
| B008-16 | LOW | No nil/empty-string guard on `Date.from_iso8601!` calls in all date-range query functions |
| B008-17 | LOW | `augment_thing_with_usage/2` hardcodes timezone `"+10:00"` for all users |
