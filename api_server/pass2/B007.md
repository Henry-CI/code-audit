# Audit Report B007
**Audit run:** 2026-02-27-01
**Agent:** B007 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)

---

## Assigned Source Files

1. `lib/api_server/vx/rental_periods.ex`
2. `lib/api_server/vx/scheduler.ex`
3. `lib/api_server/vx/vx_user_function.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/vx/rental_periods.ex`

**Module:** `ApiServer.Vx.RentalPeriod`

**Behaviours / Use:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined** (`rental_periods` table, line 6):
| Field          | Type           | DB Source       |
|----------------|----------------|-----------------|
| `ID`           | `:id`          | primary key (autogenerate: true) |
| `id`           | `:integer`     | `id`            |
| `contract_id`  | `:integer`     | `contract_id`   |
| `period_start` | `:date`        | `period_start`  |
| `period_end`   | `:date`        | `period_end`    |
| `hours_used`   | `:float`       | `hours_used`    |
| `overage`      | `:float`       | `overage`       |
| `is_completed` | `:integer`     | `is_completed`  |
| `created`      | `:utc_datetime`| `created`       |

**Custom primary key:** `@primary_key {:ID, :id, autogenerate: true}` (line 5)
Note: `id` is also declared as a regular field (line 7) alongside the custom primary key `:ID`. This is a schema inconsistency (duplicate integer-type field shadowing).

**Functions defined:**
| Name        | Visibility | Line | Description |
|-------------|------------|------|-------------|
| `changeset/2` | public   | 17   | Casts all fields; no `validate_required` call |

---

### File 2: `lib/api_server/vx/scheduler.ex`

**Module:** `ApiServer.Scheduler`

**Behaviours / Use:**
- `use Quantum.Scheduler, otp_app: :api_server` (lines 2-3)

**Functions defined:**
- None explicitly defined. All public API (`add_job/2`, `delete_job/1`, `find_job/1`, `jobs/0`, `activate_job/1`, `deactivate_job/1`, `run_job/1`, etc.) is generated by the `Quantum.Scheduler` macro at compile time.

**Constants / config:** None in-file; schedule configuration lives in `config/*.exs`.

---

### File 3: `lib/api_server/vx/vx_user_function.ex`

**Module:** `ApiServer.Vx.VXUserFunction`

**Behaviours / Use:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined** (`aat_user_functions` table, line 6):
| Field            | Type       | Notes                          |
|------------------|------------|--------------------------------|
| `aatid`          | `:id`      | primary key (autogenerate: true) |
| `aatfunction_id` | `:integer` | (line 7)                       |
| `aatuser_id`     | `:integer` | (line 8)                       |

**Associations:**
- `belongs_to :user, ApiServer.Vx.VXUser` — foreign key `:aatuser_id`, references `:aacid`, `define_field: false` (line 10)

**Functions defined:**
| Name          | Visibility | Line | Description |
|---------------|------------|------|-------------|
| `changeset/2` | public (doc: `@doc false`) | 14 | Casts `:aatuser_id` and `:aatfunctionid`; validates both required |

**Note — field name mismatch (bug indicator):** The schema declares `aatfunction_id` (line 7) but `changeset/2` casts and validates `:aatfunctionid` (line 16-17, missing the underscore before `id`). The cast atom `:aatfunctionid` does not match any declared schema field `:aatfunction_id`, meaning the cast silently does nothing for that field and `validate_required` will always fail for `:aatfunctionid`.

---

## Test Coverage Search Results

Grep searched `test/` for:
- `RentalPeriod`, `rental_period`, `rental_periods`, `changeset` (no matches in module context)
- `ApiServer.Scheduler`, `Quantum.Scheduler`, `Scheduler`, `scheduler`
- `VXUserFunction`, `VxUserFunction`, `vx_user_function`, `aat_user_functions`

**All searches returned zero matches.** None of the four known test files reference these modules.

**Known test files reviewed:**
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — no references to any of the three audited modules
- `test/api_server_web/controllers/calamp_controller_test.exs` — not checked for these modules (unrelated domain)
- `test/api_server_web/views/layout_view_test.exs` — unrelated
- `test/api_server_web/views/page_view_test.exs` — unrelated

---

## Findings

---

### B007-1
**Severity:** HIGH
**File:** `lib/api_server/vx/rental_periods.ex`
**Finding:** No test file exists for `ApiServer.Vx.RentalPeriod` and no indirect test coverage was found in the test suite. The schema and `changeset/2` function are entirely untested.

---

### B007-2
**Severity:** HIGH
**File:** `lib/api_server/vx/scheduler.ex`
**Finding:** No test file exists for `ApiServer.Scheduler` and no indirect test coverage was found in the test suite. The Quantum-generated scheduler functions (job management, scheduling lifecycle) are entirely untested.

---

### B007-3
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_user_function.ex`
**Finding:** No test file exists for `ApiServer.Vx.VXUserFunction` and no indirect test coverage was found in the test suite. The schema and `changeset/2` function are entirely untested.

---

### B007-4
**Severity:** MEDIUM
**File:** `lib/api_server/vx/rental_periods.ex`
**Function:** `changeset/2` (line 17)
**Finding:** `changeset/2` contains no `validate_required/2` call. None of the eight fields are declared required. There is no test exercising this function with invalid/empty attrs to confirm whether omitting required validation is intentional. The absence of any validation means an empty struct `%RentalPeriod{}` with no attributes will produce a valid changeset.

---

### B007-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_user_function.ex`
**Function:** `changeset/2` (line 14)
**Finding:** `changeset/2` casts and validates `:aatfunctionid` (no underscore), but the schema field is named `:aatfunction_id` (with underscore, line 7). The atom `:aatfunctionid` is not a declared schema field. Ecto's `cast/3` silently ignores unknown fields, so `aatfunction_id` values are never applied to the changeset, and `validate_required([:aatuser_id, :aatfunctionid])` will always produce a required-field error for `:aatfunctionid` since it can never be set. No test exists to catch this silent failure path.

---

### B007-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/rental_periods.ex`
**Finding:** No test exercises the duplicate field declaration: `@primary_key {:ID, :id, autogenerate: true}` (line 5) alongside `field :id, :integer, source: :id` (line 7). This declares `:ID` as the primary key and also declares a regular field `:id` mapped to the same database column `id`. The interaction between these two declarations is untested and may cause unexpected query or insertion behaviour.

---

### B007-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/scheduler.ex`
**Finding:** Quantum scheduler job execution paths are entirely untested. There is no test confirming that jobs configured in `config/*.exs` are properly wired, that job callbacks are invoked, or that the scheduler process starts and stops cleanly within the OTP supervision tree.

---

### B007-8
**Severity:** LOW
**File:** `lib/api_server/vx/rental_periods.ex`
**Function:** `changeset/2` (line 17)
**Finding:** Edge cases for date fields (`period_start`, `period_end`) are untested: no test covers nil dates, invalid date formats, or the case where `period_end` is before `period_start`. The changeset performs no cross-field validation for date ordering.

---

### B007-9
**Severity:** LOW
**File:** `lib/api_server/vx/rental_periods.ex`
**Function:** `changeset/2` (line 17)
**Finding:** Edge cases for float fields (`hours_used`, `overage`) are untested: no test covers negative values, zero, or very large floats, none of which are guarded by validation.

---

### B007-10
**Severity:** LOW
**File:** `lib/api_server/vx/vx_user_function.ex`
**Function:** `changeset/2` (line 14)
**Finding:** The `belongs_to :user` association (line 10) uses `define_field: false`, relying on the manually declared `aatuser_id` field. No test verifies that the foreign key constraint to `ApiServer.Vx.VXUser` (via `:aacid`) is honoured, or that preloading the `:user` association works correctly.

---

### B007-11
**Severity:** INFO
**File:** `lib/api_server/vx/vx_user_function.ex`
**Finding:** `changeset/2` is marked `@doc false` (line 13), indicating it is intentionally treated as an internal/private function by the module author, yet it is defined as a public function (`def`, not `defp`). This inconsistency is untested and undocumented in any existing test.

---

## Summary Table

| ID      | Severity | File                        | Description |
|---------|----------|-----------------------------|-------------|
| B007-1  | HIGH     | rental_periods.ex           | No test file; zero coverage for module |
| B007-2  | HIGH     | scheduler.ex                | No test file; zero coverage for module |
| B007-3  | HIGH     | vx_user_function.ex         | No test file; zero coverage for module |
| B007-4  | MEDIUM   | rental_periods.ex           | `changeset/2` has no `validate_required`; untested intentionality |
| B007-5  | MEDIUM   | vx_user_function.ex         | Field name typo `:aatfunctionid` vs `:aatfunction_id` causes silent cast failure; untested |
| B007-6  | MEDIUM   | rental_periods.ex           | Duplicate primary key / field `id` declaration; untested interaction |
| B007-7  | MEDIUM   | scheduler.ex                | Quantum job execution and OTP supervision paths untested |
| B007-8  | LOW      | rental_periods.ex           | Date field edge cases (nil, ordering) untested |
| B007-9  | LOW      | rental_periods.ex           | Float field edge cases (negative, zero) untested |
| B007-10 | LOW      | vx_user_function.ex         | `belongs_to` association and FK constraint untested |
| B007-11 | INFO     | vx_user_function.ex         | `@doc false` on public `changeset/2` inconsistency |
