# Audit B004 — Pass 2 Coverage Analysis
**Audit run:** 2026-02-27-01
**Agent:** B004
**Date:** 2026-02-27

---

## Source Files Reviewed

1. `lib/api_server/tcp/tcp.ex`
2. `lib/api_server/tcp/tcp_commands.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/tcp/tcp.ex`

**Module:** `ApiServer.TCP`

**Aliases / Imports:**
- `import Ecto.Query, warn: false`
- `alias ApiServer.Repo`
- `alias ApiServer.Vx.VXUser`
- `alias ApiServer.Vx.VXThingEvent`
- `alias ApiServer.Vx.VXThingEventOmega`
- `alias ApiServer.Vx.VXThingEventOmegaTires`
- `alias ApiServer.Vx.VXFleetAssociation`
- `alias ApiServer.Vx.VXRestriction`
- `alias ApiServer.Vx.Geofence`
- `alias ApiServer.Vx.VXThing`
- `alias ApiServer.Vx.VXAblRecord`
- `alias ApiServer.Vx.VXRayvenMessageLog`
- `require Logger`

**Functions defined:**

| Name | Visibility | Line | Notes |
|------|-----------|------|-------|
| `accept/1` | public | 23 | Opens TCP listen socket, calls `loop_acceptor/1` |
| `loop_acceptor/1` | private | 32 | Accepts connections, spawns task via `Task.Supervisor`, tail-recurses |
| `serve/2` | private | 48 | Reads a line, dispatches via `ApiServer.TCP.Commands.parse/2` and `run/1`, writes response |
| `read_line/3` | private | 90 | Binary protocol framing; dispatches on sync bytes and message type byte |
| `write_line/2` (text) | private | 135 | Sends binary text over socket |
| `write_line/2` (unknown_command) | private | 139 | Sends "UNKNOWN COMMAND\r\n" error response |
| `write_line/2` (closed) | private | 143 | Calls `exit(:shutdown)` |
| `write_line/2` (generic error) | private | 147 | Sends "ERROR\r\n" and calls `exit(error)` |

**Constants / Literals:**
- Sync bytes pattern: `<<2>>, <<85>>` (0x02, 0x55)
- Message type bytes dispatched: `<<0>>` (Hello), `<<5>>` (commit), `<<38>>` (close), `<<4>>` (data/continuation)
- Timeout on `gen_tcp.recv`: 5000 ms (hard-coded, line 91)

---

### File 2: `lib/api_server/tcp/tcp_commands.ex`

**Module:** `ApiServer.TCP.Commands`

**Aliases / Imports:**
- `import Ecto.Query, warn: false`
- `alias ApiServer.FortyNineRepo`
- `alias ApiServer.FortyNine.CalampPositionEvents`
- `alias ApiServer.FortyNine.WebServicePositionQueue`
- `alias ApiServer.Vx.DeviceDatabaseLookup`
- `alias ApiServerWeb.UtilityController`

**Functions defined:**

| Name | Visibility | Line | Notes |
|------|-----------|------|-------|
| `parse_hello_message/1` | public | 9 | Parses binary hello frame; looks up device by serial; returns `{:ok, {:send, "hello", params}}` or `{:error, ...}` |
| `parse_data_message/3` | public | 35 | Parses binary data frame; recurses for multiple records; dispatches to `parse_debug_record` or `parse_data_record` based on log_reason |
| `parse_debug_record/3` | public | 120 | Parses a debug record; dispatches to `parse_debug_field`; always returns `[]` |
| `parse_data_record/3` | public | 158 | Core data parsing: extracts up to 7 named fields, dispatches to GPS/trip/total/driverid/analog32 field parsers; writes to DB via Ecto and FortyNineRepo; returns `[]` |
| `parse_debug_field/1` | public | 1325 | Parses severity/module + ASCII from binary; returns ASCII codepoint integer |
| `parse_gps_field/1` | public | 1331 | Parses 20-byte GPS field binary; returns map with keys `Alt`, `FType`, `GpsStat`, `GpsUTC`, `Head`, `Lat`, `Long`, `PDOP`, `PosAcc`, `Spd`, `SpdAcc` |
| `parse_digital_field/1` | public | 1385 | Parses 6-byte digital I/O field; extracts battery status bits and two input bits; returns map with `FType => 2` |
| `parse_analog_field/1` | public | 1454 | Parses raw analog bytes; returns map with `FType => 6`, raw bytes and hex string |
| `parse_analog32_field/1` | public | 1470 | Parses 32-bit analog field; decodes up to 3 analog inputs from chunked hex; always emits `IO.puts`; returns map with `FType => 7` |
| `parse_trip_field/1` | public | 1541 | Parses 8-byte trip field; returns map with `Dist`, `FType => 26`, `Dur` |
| `parse_total_field/1` | public | 1556 | Parses 8-byte total field; returns map with `Odo`, `FType => 27`, `RH` |
| `parse_driverid_field/1` | public | 1571 | Parses driver ID field; handles iButton (type 2), Weigand 26-bit RFID (type 7), and other RFID sizes; always emits `IO.puts`; returns map with `FType => 3` |
| `parse_commit_message/2` | public | 1673 | Trivially returns `{:ok, {:send, "commit", params}}` |
| `parse_iridium/2` | public | 1679 | Parses Iridium satellite binary frame; hard-codes `hardware_id = 462_743` and `customer = "vx_trility"`; writes to DB; returns `{:send, "commit", params}` (note: not wrapped in `{:ok, ...}`) |
| `parse/2` | public | 1903 | Top-level parser dispatcher; matches message type byte and routes to appropriate sub-parser; returns command tuple or `""` |
| `run/1` (function head) | public | 1959 | Declares the `run/1` function |
| `run({:send, "hello", params})` | public | 1961 | Returns hello response binary `<<2, 85, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0>>` |
| `run({:send, "commit", params})` | public | 1966 | Returns commit success binary `<<2, 85, 6, 1, 0, 1>>` |
| `run({:processed, "data", params})` | public | 1976 | Returns `<<0>>` (noop marker) |
| `run({:close, "socket", params})` | public | 1982 | Returns `<<1>>` (close marker) |

**Hard-coded device serial/hardware ID whitelists (constants embedded in code):**
- Trility Iridium unit: `462_743` (hard-coded in `parse_iridium/2`, line 1756)
- Trility device list (integer guard): lines 886–904 (13 entries)
- Trility device list (integer guard): lines 1144–1161 (15 entries)
- Trility device list (string guard): lines 1231–1247 (15 entries)
- Yabby3 device list: lines 780–817 (30+ entries)
- Test unit: `625_425` (special-cased debug logging throughout)
- Special-case hardware IDs for `thing_event` shape: `[279_677, 370_775, 408_573, 408_538, 371_119]` (line 1058)

---

## Test Coverage Search Results

Searched `test/` for:
- `ApiServer.TCP`
- `TCP.Commands`
- `tcp_commands`
- `parse_hello`, `parse_data`, `parse_commit`, `parse_iridium`
- `parse_gps`, `parse_trip`, `parse_total`, `parse_debug`, `parse_analog`, `parse_driverid`, `parse_digital`
- `Commands.run`, `Commands.parse`

**Result: Zero matches.** No test file in the repository exercises any function in either `ApiServer.TCP` or `ApiServer.TCP.Commands`.

---

## Findings

---

### B004-1
**Severity:** HIGH
**File:** `lib/api_server/tcp/tcp.ex`
**Finding:** No test file exists for `ApiServer.TCP`. The entire TCP server module — connection acceptance, binary protocol framing, message dispatch, and socket lifecycle — has zero automated test coverage.

---

### B004-2
**Severity:** HIGH
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Finding:** No test file exists for `ApiServer.TCP.Commands`. This module contains the bulk of the application's binary protocol parsing and all database write logic for tracking device events. None of the 19 public functions have any automated test coverage.

---

### B004-3
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_hello_message/1` (line 9)
**Finding:** The device-not-found branch (`[]` return from `device_lookup_with_hardware_id`) is untested. The error return path `{:error, {:error, "error", %{}}}` propagates back to `serve/2` in `tcp.ex` where it is not handled explicitly (falls into the `_` catch-all at line 85 which is `:noop`), silently discarding the error. No test exercises either the success or failure path.

---

### B004-4
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_data_record/3` (line 158)
**Finding:** The function performs no fewer than seven levels of nested field parsing with distinct dispatch branches (field IDs 0, 3, 7, 26, 27, and catch-all) and conditional database writes. None of these branches are tested. In particular:
- The path where `field_one_empty == 0` (all-zero GPS payload) returns early with `[]`.
- The path where `remaining_field_data == ""` at any nesting level returns `%{}` silently.
- The DB write failure path (`{:error, error}` from `create_thingevent_record`, line 1129) calls `IO.inspect` and attempts `error.errors`, which will raise `KeyError` if `error` is a plain string or does not have an `.errors` field.

---

### B004-5
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_iridium/2` (line 1679)
**Finding:** `parse_iridium/2` has a hard-coded `hardware_id = 462_743` (line 1756) and `customer = "vx_trility"` (line 1810), making it non-generic and impossible to test without targeting that specific device. The function is never called from within `parse/2` (it is not dispatched on any message type byte in the `parse/2` case statement), meaning it appears to be dead code in the current dispatch path. No test exercises this function.

---

### B004-6
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_driverid_field/1` (line 1571)
**Finding:** Three distinct driverid type branches exist:
- Type 2 (iButton): expects exactly 6 bytes after the type byte. If the actual payload is shorter, a `MatchError` will be raised.
- Type 7 (Weigand RFID): 26-bit and non-26-bit sub-paths, with complex bit manipulation.
- Any other type: the outer `if/else` chain returns `nil` (neither branch matches), so `driverid_data_encoded` is `nil`. The map built at line 1659 will have `"driverID" => nil`, and the subsequent `IO.puts` at line 1666 will format `nil` without error, but callers may not expect `nil` in the `driverID` field.

None of these paths are tested.

---

### B004-7
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp.ex`
**Function:** `read_line/3` (line 90)
**Finding:** The binary pattern match on line 95-99 is unconditional:
```elixir
<<sync_byte_one :: bytes-size(1),
  sync_byte_two :: bytes-size(1),
  message_type :: bytes-size(1),
  payload_length_raw :: bytes-size(2),
  remainder :: binary>> = data
```
If the TCP client sends fewer than 5 bytes in a single recv (e.g. a truncated or malformed packet), this pattern match will raise `MatchError`, crashing the supervised Task. No test verifies this behaviour or the crash-and-restart semantics.

---

### B004-8
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse/2` (line 1903)
**Finding:** The `<<4>>` (Data Record Upload) branch at line 1927 calls `parse(next_remainder, params)` recursively, but discards the result of `parse_data_message/3` entirely (the return value `data_message_response` is bound but unused, and the recursive call's result is also discarded — execution falls through to the result of the `parse(next_remainder, params)` call). The intended accumulation of data message responses is silently lost. No test exercises multi-record uploads to expose this bug.

---

### B004-9
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_analog32_field/1` (line 1470)
**Finding:** Line 1523 performs a destructuring bind:
```elixir
[final_input1, final_input2, final_input3] = [
  Enum.at(analog_values, 0),
  Enum.at(analog_values, 1),
  Enum.at(analog_values, 2)
]
```
`Enum.at/2` returns `nil` for out-of-bounds indices, so if the analog payload contains fewer than 3 entries this bind succeeds but writes `nil` into the result map. If the payload contains 0 entries, all three fields are `nil`. Callers (line 1008–1019) guard with `if analog32_data["Analog_Input1"]`, which handles `nil`, but the silent `nil` is never surfaced to tests. More critically, if `analog_inputs` is empty, the `Enum.chunk_every/1` pipeline can produce an empty list without error but the assumption of exactly 3 inputs is never verified.

---

### B004-10
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_data_record/3` (line 158) — DB write paths
**Finding:** Two separate database write paths exist:
1. `ApiServer.Vx.create_thingevent_record/2` (line 1125) into the primary database.
2. `FortyNineRepo.insert/2` for `[REDACTED-AWS-SMTP-PASSWORD]` and `[REDACTED-AWS-SMTP-PASSWORD]` (lines 1186–1228 and 1271–1313), guarded by a hard-coded serial number whitelist.

The second path has duplicated logic for integer serial numbers (lines 1143–1229) and string serial numbers (lines 1230–1317) that are structurally identical but differ only in the guard type. Neither path is tested, and the string-serial branch at line 1230 (`when trility in ["461858", ...]`) can never be reached given `serial_number` is always bound as an integer (parsed via `<<serial::little-signed-integer-size(32)>>`), making the string branch dead code.

---

### B004-11
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp.ex`
**Function:** `serve/2` (line 48)
**Finding:** The `result` binding in the `{:ok, _}` branch (lines 70–83) contains a `case msg` block with a `<<1>>` branch that calls `:gen_tcp.close(socket)` and then falls through to the recursive `serve(socket, params)` call at line 84. After closing the socket, the next `read_line` will receive `{:error, :closed}`, returning `{:ok, "closed", <<>>}` which leads to `{_, ""}` → `:noop` and the function returns without further recursion. This is the effective termination path, but there is no guard preventing the `serve` loop from continuing after `close`. No test verifies the connection teardown sequence.

---

### B004-12
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_gps_field/1` (line 1331)
**Finding:** The function expects exactly 20 bytes (`4+4+4+2+2+1+1+1+1+1 = 21`; actual pattern: `gps_datetime(4) + latitude(4) + longitude(4) + altitude(2) + speed(2) + speed_accuracy(1) + heading(1) + pdop(1) + position_accuracy(1) + gps_status(1) = 21` bytes). No test verifies that an undersized or oversized GPS field binary raises a clear error rather than a cryptic `MatchError`.

---

### B004-13
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_digital_field/1` (line 1385)
**Finding:** `Integer.digits(0, 2)` returns `[0]` in Elixir, not `[]`. The `length_inputs == 0` branch (line 1424) can therefore never be reached when `inputs == 0`, since `Integer.digits(0, 2)` produces a list of length 1. The guard `0 ->` for `length_inputs` is dead code. No test exercises this to detect the unreachable branch.

---

### B004-14
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_data_message/3` (line 35)
**Finding:** The `log_reason` case at line 52 maps integer literals (`1`, `2`, `3`, `11`, `17`, `16`, `23`) to `{event_code, event_type}` tuples. However `log_reason` at this point is a raw `bytes-size(1)` binary (`<<parsed_log_reason::little-signed-integer-size(8)>>` is extracted on line 48, but the `case log_reason` on line 52 matches against the raw binary `log_reason` binding, not `parsed_log_reason`). The integer literals `1`, `2`, etc. will never match a single-byte binary, so the entire case falls through to the `_` catch-all on every call. This is a semantic bug (the integer binding `parsed_log_reason` is computed but unused in the case, then both `event_code` and `event_type` are also unused in `parse_data_message` itself). No test exists to expose this.

---

### B004-15
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_analog32_field/1` (line 1470) — `IO.puts` side-effect
**Finding:** Line 1492 unconditionally calls `IO.puts("Analog values: #{inspect(analog_values)}")` on every invocation. Similarly, `parse_driverid_field/1` calls `IO.puts` unconditionally at line 1666. These production log statements produce noise in any test output and could expose sensitive data. No tests suppress or capture this output.

---

### B004-16
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `run/1` (lines 1959–1986)
**Finding:** There is no catch-all clause for `run/1`. If `parse/2` returns an unexpected tuple shape (or `""` on an empty line that is passed through the `command == ""` guard in `tcp.ex` line 64), `run/1` will raise `FunctionClauseError`. The `""` case is already guarded in `tcp.ex` (line 64–66), but there is no test verifying this guard prevents the `FunctionClauseError`.

---

### B004-17
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Finding:** The aliases `alias ApiServer.Vx.DeviceDatabaseLookup` (line 6) is imported but never referenced in the module body. This is unused dead code that no test would catch as it produces only a compiler warning, not a failure.

---

### B004-18
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp.ex`
**Finding:** The aliases for `VXUser`, `VXThingEvent`, `VXThingEventOmega`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXFleetAssociation`, `VXRestriction`, `Geofence`, `VXAblRecord`, and `VXRayvenMessageLog` (lines 9–18) are all imported but never used in the module body. The file itself has a comment acknowledging this: `# Clean these up after we know which ones we use`. No test would catch these stale imports.

---

## Summary Table

| ID | Severity | File | Subject |
|----|----------|------|---------|
| B004-1 | HIGH | tcp.ex | No test file — entire TCP server module unexercised |
| B004-2 | HIGH | tcp_commands.ex | No test file — all 19 public functions unexercised |
| B004-3 | MEDIUM | tcp_commands.ex | `parse_hello_message/1` — device-not-found error path untested; silent `:noop` on failure |
| B004-4 | MEDIUM | tcp_commands.ex | `parse_data_record/3` — all DB write branches untested; `error.errors` may raise `KeyError` |
| B004-5 | MEDIUM | tcp_commands.ex | `parse_iridium/2` — not reachable from `parse/2`; hard-coded device ID; dead code |
| B004-6 | MEDIUM | tcp_commands.ex | `parse_driverid_field/1` — type mismatch / `nil` driverid for unrecognised type; no tests |
| B004-7 | MEDIUM | tcp.ex | `read_line/3` — unconditional 5-byte pattern match crashes task on short frames |
| B004-8 | MEDIUM | tcp_commands.ex | `parse/2` message type `<<4>>` — `parse_data_message` return value silently discarded |
| B004-9 | MEDIUM | tcp_commands.ex | `parse_analog32_field/1` — silent `nil` fields when payload has fewer than 3 inputs |
| B004-10 | MEDIUM | tcp_commands.ex | `parse_data_record/3` — string-serial FortyNine branch is dead code (serial is always integer) |
| B004-11 | LOW | tcp.ex | `serve/2` — post-close loop continuation; teardown sequence untested |
| B004-12 | LOW | tcp_commands.ex | `parse_gps_field/1` — no edge case test for wrong-length GPS binary |
| B004-13 | LOW | tcp_commands.ex | `parse_digital_field/1` — `length_inputs == 0` branch is unreachable |
| B004-14 | LOW | tcp_commands.ex | `parse_data_message/3` — `case log_reason` matches binary not integer; always hits catch-all |
| B004-15 | LOW | tcp_commands.ex | `parse_analog32_field/1`, `parse_driverid_field/1` — unconditional `IO.puts` in hot path |
| B004-16 | LOW | tcp_commands.ex | `run/1` — no catch-all clause; unexpected tuple raises `FunctionClauseError` |
| B004-17 | INFO | tcp_commands.ex | `[REDACTED-AWS-SMTP-PASSWORD]` alias unused |
| B004-18 | INFO | tcp.ex | Nine aliases unused (Repo, VXUser, VXThingEvent, etc.) |
