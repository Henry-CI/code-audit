# Audit Report B025
**Audit run:** 2026-02-27-01
**Agent:** B025 (Pass 2)
**Assigned source files:**
- `lib/api_server_web/views/vx_access_fob_view.ex`
- `lib/api_server_web/views/vx_customer_view.ex`
- `lib/api_server_web/views/vx_fleet_association_view.ex`
- `lib/api_server_web/views/vx_fleet_view.ex`

---

## Test Coverage Search Summary

The entire `test/` tree was searched for each module name, each render template string, and each domain keyword. The full test suite consists of exactly five files:

| File | Contains coverage of assigned modules? |
|---|---|
| `test/api_server_web/controllers/calamp_controller_test.exs` | No (empty module body) |
| `test/api_server_web/controllers/vx_restriction_controller_test.exs` | No |
| `test/api_server_web/views/layout_view_test.exs` | No (empty module body) |
| `test/api_server_web/views/page_view_test.exs` | No (empty module body) |
| `test/test_helper.exs` | No |

No direct or indirect test coverage exists for any of the four assigned source files.

---

## Reading Evidence

### 1. `ApiServerWeb.VXAccessFobView`
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`

**Module-level macros/imports:**
- Line 2: `use ApiServerWeb, :view`
- Line 3: `alias ApiServerWeb.VXAccessFobView`

**Public functions defined:**

| Line | Signature |
|---|---|
| 5 | `render("index.json", %{vxaccessfobs: vxaccessfobs})` |
| 9 | `render("show.json", %{vx_access_fob: vx_access_fob})` |
| 13 | `render("vx_access_fob.json", %{vx_access_fob: vx_access_fob})` |

**Types / constants:** None.

**Behaviour notes:**
- `"index.json"` wraps the result list in a `%{data: ...}` envelope.
- `"show.json"` wraps the single record in a `%{data: ...}` envelope.
- `"vx_access_fob.json"` projects two fields: `id` and `fob_code`.
- No nil-guard or association-loaded guard on the leaf render clause.

---

### 2. `ApiServerWeb.VXCustomerView`
**File:** `lib/api_server_web/views/vx_customer_view.ex`

**Module-level macros/imports:**
- Line 2: `use ApiServerWeb, :view`
- Line 3: `alias ApiServerWeb.VXCustomerView`

**Public functions defined:**

| Line | Signature |
|---|---|
| 5 | `render("index.json", %{vx_customers: vx_customers})` |
| 9 | `render("show.json", %{vx_customer: vx_customer})` |
| 13 | `render("vx_customer.json", %{vx_customer: nil})` |
| 14 | `render("vx_customer.json", %{vx_customer: vx_customer})` |

**Types / constants:** None.

**Behaviour notes:**
- `"index.json"` does NOT wrap the result in a `%{data: ...}` envelope (inconsistent with other views in this set).
- `"show.json"` does NOT wrap the result in a `%{data: ...}` envelope (same inconsistency).
- `"vx_customer.json"` has two clauses: an explicit nil-guard returning `%{}` (line 13), and a full clause that checks `Ecto.assoc_loaded?/1` at runtime, returning `%{}` when the association is not loaded.
- Commented-out fields: `aaaudfcustcode` and `aaacolour` (lines 30–31).

---

### 3. `ApiServerWeb.VXFleetAssociationView`
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`

**Module-level macros/imports:**
- Line 2: `use ApiServerWeb, :view`
- Line 3: `alias ApiServerWeb.VXFleetAssociationView`

**Public functions defined:**

| Line | Signature |
|---|---|
| 5 | `render("index.json", %{vxfleetassociationss: vxfleetassociationss})` |
| 9 | `render("show.json", %{vx_fleet_association: vx_fleet_association})` |
| 13 | `render("vx_fleet_association.json", %{vx_fleet_association: vx_fleet_association})` |

**Types / constants:** None.

**Behaviour notes:**
- The `"index.json"` key is `[REDACTED-AWS-SMTP-PASSWORD]` (double `s`) — a likely typo that would cause a pattern-match failure if the controller uses a differently-spelled key.
- `"index.json"` and `"show.json"` both wrap output in `%{data: ...}`.
- Leaf render projects two fields: `id` and `aafcustcode`.
- No nil-guard on the leaf render clause.

---

### 4. `ApiServerWeb.VXFleetView`
**File:** `lib/api_server_web/views/vx_fleet_view.ex`

**Module-level macros/imports:**
- Line 2: `use ApiServerWeb, :view`
- Line 3: `alias ApiServerWeb.VXFleetView`

**Public functions defined:**

| Line | Signature |
|---|---|
| 5 | `render("index.json", %{vxfleets: vxfleets})` |
| 9 | `render("show.json", %{vx_fleet: vx_fleet})` |
| 13 | `render("vx_fleet.json", %{vx_fleet: vx_fleet})` |
| 22 | `render("rhm_fleets.json", %{vx_fleets: vx_fleets})` |
| 25 | `render("rhm_fleet.json", %{vx_fleet: vx_fleet})` |
| 34 | `render("rhm_fleets_with_equip.json", %{vx_fleets: vx_fleets})` |
| 37 | `render("rhm_fleet_with_equip.json", %{vx_fleet: vx_fleet})` |
| 47 | `render("rhm_fleet_equipment.json", %{results: results})` |
| 51 | `render("assoc.json", %{vx_fleet: {fleet_id, equipment_id, equipment_name}})` |

**Types / constants:** None.

**Behaviour notes:**
- `"index.json"` / `"show.json"` wrap in `%{data: ...}`; the RHM templates do not.
- `"rhm_fleet_with_equip.json"` accesses `vx_fleet.equipment`, which is presumably a preloaded association; no guard against it being unloaded.
- `"assoc.json"` destructures a 3-tuple from the `results` list — an unusual shape that is easy to break silently.
- Nine distinct render clauses versus the simpler two-or-three clauses in the other views.

---

## Findings

### B025-1
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXAccessFobView`, and no indirect coverage was found anywhere in the test suite. All three render clauses (`"index.json"`, `"show.json"`, `"vx_access_fob.json"`) are completely untested.

---

### B025-2
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_customer_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXCustomerView`, and no indirect coverage was found anywhere in the test suite. All four render clauses are completely untested.

---

### B025-3
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXFleetAssociationView`, and no indirect coverage was found anywhere in the test suite. All three render clauses are completely untested.

---

### B025-4
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXFleetView`, and no indirect coverage was found anywhere in the test suite. All nine render clauses are completely untested.

---

### B025-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_customer_view.ex`
**Function:** `render("vx_customer.json", ...)` — lines 13–34
**Finding:** The `Ecto.assoc_loaded?/1` branch (returns `%{}` when the association is not loaded) is untested. This is a non-trivial runtime code path; an unloaded association silently producing an empty map `%{}` could mask data bugs in callers that forget to preload.

---

### B025-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Function:** `render("rhm_fleet_with_equip.json", ...)` — line 37
**Finding:** `vx_fleet.equipment` is accessed without any guard for an unloaded or nil association. No test exercises this clause at all, so neither the happy path nor the failure path (unloaded association raising `Ecto.Association.NotLoaded`) is covered.

---

### B025-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Function:** `render("assoc.json", %{vx_fleet: {fleet_id, equipment_id, equipment_name}})` — line 51
**Finding:** This clause destructures a raw 3-tuple bound under the key `:vx_fleet`, which is an unconventional shape for a Phoenix view. No test exercises this, so a shape mismatch (e.g., a 2-tuple or a struct) would raise a `FunctionClauseError` at runtime with no test-time warning.

---

### B025-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`
**Function:** `render("index.json", ...)` — line 5
**Finding:** The `index.json` assign key is spelled `[REDACTED-AWS-SMTP-PASSWORD]` (double trailing `s`). This is almost certainly a typo. Because this clause is completely untested, the mismatch between the key name expected by the view and the key name assigned by the controller will not be caught until runtime, at which point it raises a `FunctionClauseError`.

---

### B025-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_customer_view.ex`
**Finding:** `render("index.json", ...)` and `render("show.json", ...)` do not wrap their output in a `%{data: ...}` envelope, while all other views in this set (`VXAccessFobView`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXFleetView`) do. This envelope inconsistency is untested, so any API client relying on a consistent shape will receive different JSON structures from different endpoints without any test-time indication of the divergence.

---

### B025-10
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`
**Function:** `render("vx_access_fob.json", ...)` — line 13
**Finding:** No nil-guard clause exists for `vx_access_fob`. If `render_one/3` is called with a nil struct (e.g., a not-found resource passed through incorrectly), the clause will raise a `KeyError` or `FunctionClauseError`. This edge case is untested.

---

### B025-11
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`
**Function:** `render("vx_fleet_association.json", ...)` — line 13
**Finding:** No nil-guard clause exists for `vx_fleet_association`. Same nil-propagation risk as B025-10. Untested.

---

### B025-12
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Function:** `render("vx_fleet.json", ...)` — line 13
**Finding:** No nil-guard clause exists for `vx_fleet` in the standard CRUD template. Untested.

---

### B025-13
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Finding:** The `render("rhm_fleets_with_equip.json", ...)` and `render("rhm_fleet_with_equip.json", ...)` pair (lines 34–44) are not tested with an empty list. `render_many/3` on an empty list returns `[]`, but no test confirms that the caller handles an empty equipment list gracefully without a separate RHM-specific empty-state code path.

---

### B025-14
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_customer_view.ex`
**Lines:** 30–31
**Finding:** Two fields (`aaaudfcustcode`, `aaacolour`) are commented out. There are no tests to signal if and when these should be reinstated. Their presence in comments suggests they were intentionally omitted rather than removed, but without tests this cannot be verified.

---

## Summary Table

| ID | Severity | File | Description |
|---|---|---|---|
| B025-1 | HIGH | vx_access_fob_view.ex | No test coverage whatsoever |
| B025-2 | HIGH | vx_customer_view.ex | No test coverage whatsoever |
| B025-3 | HIGH | vx_fleet_association_view.ex | No test coverage whatsoever |
| B025-4 | HIGH | vx_fleet_view.ex | No test coverage whatsoever |
| B025-5 | MEDIUM | vx_customer_view.ex | `assoc_loaded?` false branch untested |
| B025-6 | MEDIUM | vx_fleet_view.ex | `rhm_fleet_with_equip.json` equipment association not guarded or tested |
| B025-7 | MEDIUM | vx_fleet_view.ex | `assoc.json` 3-tuple destructure untested and fragile |
| B025-8 | MEDIUM | vx_fleet_association_view.ex | Typo `[REDACTED-AWS-SMTP-PASSWORD]` in index assign key, undetected by tests |
| B025-9 | MEDIUM | vx_customer_view.ex | Missing `%{data: ...}` envelope inconsistency undetected by tests |
| B025-10 | LOW | vx_access_fob_view.ex | No nil-guard on leaf render clause |
| B025-11 | LOW | vx_fleet_association_view.ex | No nil-guard on leaf render clause |
| B025-12 | LOW | vx_fleet_view.ex | No nil-guard on standard `vx_fleet.json` clause |
| B025-13 | LOW | vx_fleet_view.ex | Empty-list path for `rhm_fleets_with_equip.json` untested |
| B025-14 | INFO | vx_customer_view.ex | Commented-out fields with no test intent |
