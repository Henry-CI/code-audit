# Audit Report B019
**Audit Run:** 2026-02-27-01
**Agent:** B019 (Pass 2)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/controllers/vx_thing_controller.ex`
2. `lib/api_server_web/controllers/vx_thing_event_controller.ex`
3. `lib/api_server_web/controllers/vx_thing_info_controller.ex`

---

## Reading Evidence

### 1. `ApiServerWeb.VXThingController`
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`

**Public functions defined:**

| Function | Arity | Line | Notes |
|---|---|---|---|
| `get_checklists/2` | 2 | 10 | Pattern-matches `customer`, `hardwareid` |
| `get_movements/2` | 2 | 16 | Pattern-matches `customer`, `hardwareid`, `day`, `timezone` |
| `get_hardware_with_checklists/2` | 2 | 21 | Pattern-matches `customer` |
| `get_pm_data/2` | 2 | 30 | Pattern-matches `customer`, `hardwareid` |
| `get_all_pm_data/2` | 2 | 36 | Pattern-matches `customer` |
| `get_fleet_map/2` (clause 1) | 2 | 44 | Pattern-matches `customer`, `fleetname` |
| `get_fleet_map/2` (clause 2) | 2 | 51 | Pattern-matches `customer`, `fleetid` |
| `get_fleet_map/2` (clause 3) | 2 | 56 | Pattern-matches `fleetid` only |
| `get_fleet_map/2` (clause 4) | 2 | 64 | Catch-all `_` |
| `create/2` | 2 | 74 | Pattern-matches `vx_thing` params |
| `show/2` | 2 | 83 | Pattern-matches `id` (hardwareid) |
| `delete/2` | 2 | 88 | Pattern-matches `id` |
| `rhm_get_thing/2` | 2 | 95 | Pattern-matches `customer`, `hardwareid` |
| `rhm_get_thing_usage/2` | 2 | 100 | Pattern-matches `hardwareid`, `from`, `to`, `timezone` |
| `rhm_get_things_usage/2` | 2 | 111 | Pattern-matches `fleetid`, `from`, `to`, `timezone`; returns CSV |
| `rhm_get_thing_events/2` | 2 | 144 | Pattern-matches `hardwareid`, `from`, `to`, `timezone` |
| `rhm_get_things/2` (clause 1) | 2 | 153 | Pattern-matches `customer`, `fleet_id` |
| `rhm_get_things/2` (clause 2) | 2 | 161 | Pattern-matches `customer` |
| `rhm_get_things_with_usage/2` (clause 1) | 2 | 169 | Pattern-matches `fleet_id` |
| `rhm_get_things_with_usage/2` (clause 2) | 2 | 176 | Catch-all `_params` |
| `rhm_get_things_names/2` | 2 | 223 | Pattern-matches `customer` |
| `rhm_get_thing_records/2` | 2 | 231 | Pattern-matches `%{}` (any params) |
| `create_thing/2` | 2 | 240 | Pattern-matches `thing` params |
| `update_thing/2` | 2 | 254 | Pattern-matches `thing` params |
| `monday_hour_meters/2` | 2 | 377 | Pattern-matches `from`, `to`, `customers` |
| `get_next_monday_between_dates/4` | 4 | 438 | Recursive helper |
| `combined_engine_usage/2` | 2 | 453 | Pattern-matches `format: "csv"`, `from`, `to`, `customers` |
| `pape_export/2` (clause 1) | 2 | 603 | Pattern-matches `format: "csv"` |
| `pape_export/2` (clause 2) | 2 | 617 | Catch-all `_` |
| `sielift_export/2` (clause 1) | 2 | 724 | Pattern-matches `format: "json"`, `fleet_id` |
| `sielift_export/2` (clause 2) | 2 | 735 | Pattern-matches `format: "json"` (no fleet) |
| `sielift_export/2` (clause 3) | 2 | 746 | Catch-all (CSV output) |
| `update_thing_cached_fields/2` | 2 | 850 | Non-conn utility, called by VXThingEventController |
| `get_timezones/2` | 2 | 859 | Catch-all `_` |

**Private functions defined:**

| Function | Line |
|---|---|
| `things_with_usage/2` | 184 |
| `get_data_for_pape_export/1` | 285 |
| `ifnilzero/1` | 622–623 |
| `get_data_for_sielift_export/3` | 625 |

**Types/Structs/Constants:** None defined directly in this file. Aliases `ApiServer.Vx` and `ApiServer.Vx.VXThing`.

---

### 2. `ApiServerWeb.VXThingEventController`
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`

**Public functions defined:**

| Function | Arity | Line | Notes |
|---|---|---|---|
| `index/2` | 2 | 9 | Lists all thing events |
| `create/2` | 2 | 14 | Pattern-matches `vx_thing_event` params |
| `show/2` | 2 | 24 | Pattern-matches `id` |
| `update/2` | 2 | 29 | Pattern-matches `id`, `vx_thing_event` params |
| `delete/2` | 2 | 38 | Pattern-matches `id` |
| `write_partial_record/3` | 3 | 46 | Non-conn; merges with most recent event and saves |
| `add_calculated_fields/2` | 2 | 74 | Non-conn; computes calc hourmeter fields |
| `get_current_omega_status/2` | 2 | 111 | Pattern-matches `hardwareid` |

**Private functions defined:**

| Function | Line |
|---|---|
| `calculated_hourmeter/2` | 103 |

**Types/Structs/Constants:** None defined directly. Aliases `ApiServer.Vx` and `ApiServer.Vx.VXThingEvent`.

---

### 3. `ApiServerWeb.VXThingInfoController`
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`

**Public functions defined:**

| Function | Arity | Line | Notes |
|---|---|---|---|
| `fix_infos/2` | 2 | 9 | Pattern-matches `customer`; iterates all things and fixes info |
| `get_info/2` | 2 | 17 | Pattern-matches `id`, `customer`; always returns `{}` regardless of result |
| `do_fix_info/2` | 2 | 24 | Non-conn; delegates to `VXThingInfo.validateForHardwareId/2` |

**Types/Structs/Constants:** None defined directly. Aliases `ApiServer.Vx` and `ApiServer.Vx.VXThingInfo`.

---

## Test Coverage Search Results

**Test files searched:** All `.exs` files under `test/`

```
test/api_server_web/controllers/calamp_controller_test.exs
test/api_server_web/controllers/vx_restriction_controller_test.exs
test/api_server_web/views/layout_view_test.exs
test/api_server_web/views/page_view_test.exs
test/test_helper.exs
```

**Grep results for module names** (`VXThingController`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`): **0 matches**

**Grep results for all public function names** across all three modules: **0 matches**

**Conclusion:** There is zero test coverage — direct or indirect — for all three source files.

---

## Findings

---

### B019-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Finding:** No test file exists and no indirect test coverage exists for `ApiServerWeb.VXThingController`. This is the largest and most complex controller in the repository. It contains 29 public functions/clauses covering core fleet management, PM data, usage data, CSV exports, and vehicle CRUD operations. None are exercised by any test in the test suite.

---

### B019-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Finding:** No test file exists and no indirect test coverage exists for `ApiServerWeb.VXThingEventController`. This module contains 8 public functions including standard CRUD actions and the critical `write_partial_record/3` function, which is called by external controllers (e.g., `CalampController`) to persist incoming device telemetry events. The complete absence of tests means record-writing and hourmeter calculation logic is entirely unverified.

---

### B019-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`
**Finding:** No test file exists and no indirect test coverage exists for `ApiServerWeb.VXThingInfoController`. All three public functions (`fix_infos/2`, `get_info/2`, `do_fix_info/2`) are untested.

---

### B019-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `update_thing/2` (line 254)
**Finding:** The `update_thing/2` action contains a conditional branch where `thing == nil` results in a 500 response with the message `"no fleet to edit"` (line 281). The success path also contains a conditional service-record generation branch (lines 271–273). Neither the nil-thing path, nor the service-record conditional, nor the `{:error, changeset}` path from `Vx.update_vx_thing/3` (line 278) is tested.

---

### B019-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `create_thing/2` (line 240)
**Finding:** The `{:error, changeset}` branch (line 249–251) returns a 500 response. This error path is entirely untested.

---

### B019-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `create/2` (line 74)
**Finding:** The `with` expression delegates to `Vx.create_vx_thing/1`. The failure path — where `Vx.create_vx_thing/1` returns an error tuple — falls through to `action_fallback`. This fallback path is untested.

---

### B019-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `delete/2` (line 88)
**Finding:** The `with` expression delegates to `Vx.delete_vx_thing/1`. The failure path (non-ok tuple) falls through to `action_fallback`. This fallback path is untested. Additionally, the happy path (204 No Content) is untested.

---

### B019-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Function:** `write_partial_record/3` (line 46)
**Finding:** The `{:error, changeset}` branch (lines 64–68) on `Vx.create_vx_thing_event/2` is untested. This function is called from other controllers in the live event-ingestion path and a silent error at this point could cause data loss. The branch currently calls `IO.inspect(changeset)` and returns without surfacing the error to the caller.

---

### B019-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Function:** `add_calculated_fields/2` (line 74)
**Finding:** The nil-guard branch (lines 77–83) where `totalengineseconds` is nil but `aadhourmeter` is not nil has no test coverage. This branch silently resets `totalengineseconds` to `0`, which is a data-mutation side effect that warrants explicit verification.

---

### B019-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Function:** `create/2` (line 14) and `update/2` (line 29)
**Finding:** Both the `create` and `update` actions use `with` pattern matching delegating to `Vx` context functions. The fallback error paths (non-ok tuples) are untested.

---

### B019-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`
**Function:** `get_info/2` (line 17)
**Finding:** The response from `VXThingInfo.validateForHardwareId/2` is called but its return value is discarded — the function always responds with `send_resp(conn, :ok, "{}")`. This means a validation failure or error from the underlying call would still return HTTP 200. This logic gap is untested and the discarded return value is never asserted.

---

### B019-12
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `rhm_get_things_usage/2` (line 111)
**Finding:** This function produces a CSV file attachment response by iterating over every hardware ID in a fleet. There is no test verifying the CSV content type header (`text/csv`), the `content-disposition` attachment header, the CSV structure, or the behaviour when the fleet is empty or the fleet ID does not exist.

---

### B019-13
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `get_fleet_map/2` (4 clauses, lines 44–72)
**Finding:** All four pattern-match clauses of `get_fleet_map/2` are untested. In particular, clause 1 (matching `fleetname`) and clause 2 (matching `fleetid` with explicit `customer`) shadow each other in ambiguous ways and the routing-vs-clause dispatch is never exercised in tests.

---

### B019-14
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Function:** `calculated_hourmeter/2` (line 103)
**Finding:** The private helper `calculated_hourmeter/2` has three logical cases: `offset_in_hours == nil`, `offset_in_hours == 0`, and a positive offset. The boundary case of `offset_in_hours` being a negative value (representing a backwards adjustment) is never exercised. No tests exist for any branch.

---

### B019-15
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `get_movements/2` (line 16)
**Finding:** `Date.from_iso8601!/1` is called on both `day` and used directly (same value passed twice for start and end date). No test verifies behaviour with an invalid date string, which will raise an exception rather than returning a structured error response.

---

### B019-16
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `monday_hour_meters/2` (line 377) and `get_next_monday_between_dates/4` (line 438)
**Finding:** The recursive `get_next_monday_between_dates/4` function is untested. Edge cases include: `from_date == to_date` (single-day range), a range spanning no Mondays, and date-parsing failure from `Date.from_iso8601!`. The `NaiveDateTime.new/2` tuple destructuring at lines 381–382 is also unchecked for error tuples.

---

### B019-17
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `get_data_for_sielift_export/3` (line 625)
**Finding:** The `aadcat` category value is used in a `case` expression (lines 643–654) that matches only values 2–6. No `_` catch-all clause exists, so an unexpected category value would raise a `CaseClauseError` at runtime. This is untested.

---

### B019-18
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `combined_engine_usage/2` (line 453)
**Finding:** The inner `case` on `category` (lines 495–506) also matches only values 2–6 with no catch-all. An unexpected category would raise a `CaseClauseError`. No test exercises this path, including the empty-customers-list or empty-things-list edge cases.

---

### B019-19
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `update_thing/2` (line 254)
**Finding:** The `Map.has_key?(changeset, :aadlastservice)` check at line 271 operates on a plain map returned by `VXThing.convert_json_to_changeset/1` (not an Ecto changeset). If the changeset conversion fails silently or returns an unexpected structure, this could produce a runtime error. No test verifies this structural assumption.

---

### B019-20
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Finding:** There is a large block of commented-out code beginning at line 300 (`combined_engine_usage` alternate implementation) and at line 780 (`sielift_export_local`). This dead code adds maintenance noise and was noted as it could indicate abandoned or partially migrated functionality. No test coverage concern applies to commented code directly, but the live counterparts (`combined_engine_usage/2` at line 453 and `sielift_export/2`) are themselves untested.

---

### B019-21
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `things_with_usage/2` (line 184)
**Finding:** The private helper contains a duplicate `now = Timex.now()` assignment (lines 185 and 189). The first value is immediately shadowed and never used. This is a latent code-quality defect; while not a test coverage gap per se, any future test would need to account for which `now` binding is actually operative.

---

## Summary Table

| ID | Severity | File | Function / Scope |
|---|---|---|---|
| B019-1 | HIGH | vx_thing_controller.ex | Entire module — no tests |
| B019-2 | HIGH | vx_thing_event_controller.ex | Entire module — no tests |
| B019-3 | HIGH | vx_thing_info_controller.ex | Entire module — no tests |
| B019-4 | MEDIUM | vx_thing_controller.ex | `update_thing/2` — nil-thing, error, service-record paths |
| B019-5 | MEDIUM | vx_thing_controller.ex | `create_thing/2` — error path |
| B019-6 | MEDIUM | vx_thing_controller.ex | `create/2` — fallback error path |
| B019-7 | MEDIUM | vx_thing_controller.ex | `delete/2` — happy path and fallback |
| B019-8 | MEDIUM | vx_thing_event_controller.ex | `write_partial_record/3` — error branch |
| B019-9 | MEDIUM | vx_thing_event_controller.ex | `add_calculated_fields/2` — nil totalengineseconds branch |
| B019-10 | MEDIUM | vx_thing_event_controller.ex | `create/2`, `update/2` — fallback error paths |
| B019-11 | MEDIUM | vx_thing_info_controller.ex | `get_info/2` — discarded return value, always 200 |
| B019-12 | MEDIUM | vx_thing_controller.ex | `rhm_get_things_usage/2` — CSV output |
| B019-13 | MEDIUM | vx_thing_controller.ex | `get_fleet_map/2` — all 4 clauses |
| B019-14 | LOW | vx_thing_event_controller.ex | `calculated_hourmeter/2` — boundary/negative offset |
| B019-15 | LOW | vx_thing_controller.ex | `get_movements/2` — invalid date string |
| B019-16 | LOW | vx_thing_controller.ex | `monday_hour_meters/2`, `get_next_monday_between_dates/4` |
| B019-17 | LOW | vx_thing_controller.ex | `get_data_for_sielift_export/3` — missing case catch-all |
| B019-18 | LOW | vx_thing_controller.ex | `combined_engine_usage/2` — missing case catch-all |
| B019-19 | LOW | vx_thing_controller.ex | `update_thing/2` — changeset structure assumption |
| B019-20 | INFO | vx_thing_controller.ex | Large blocks of commented-out dead code |
| B019-21 | INFO | vx_thing_controller.ex | `things_with_usage/2` — duplicate `now` binding |
