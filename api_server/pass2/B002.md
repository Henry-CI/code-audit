# Audit Report B002
**Audit Run:** 2026-02-27-01
**Agent:** B002
**Pass:** 2 (Test Coverage)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server/fortynine/calamppositionevents.ex`
2. `lib/api_server/fortynine/webservicepositionqueue.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/fortynine/calamppositionevents.ex`

**Module name:** `ApiServer.FortyNine.CalampPositionEvents`

**Behaviours / use directives:**
- `use Ecto.Schema` (line 2)
- `use Bitwise` (line 3)
- `use Timex` (line 4)
- `import Ecto.Changeset` (line 5)

**Functions defined:**

| Function | Line | Visibility |
|----------|------|------------|
| `changeset/2` | 91 | Public (annotated `@doc false`) |

**Schema name:** `"calamppositionevents"` (line 7)

**Schema fields (all defined inside `schema` block, lines 7–88):**

| Field | Type |
|-------|------|
| `:datetimesaved` | `:utc_datetime` |
| `:gmtdatetime` | `:utc_datetime` |
| `:timeoffix` | `:utc_datetime` |
| `:hardwareid` | `:integer` |
| `:latitude` | `:float` |
| `:longitude` | `:float` |
| `:heading` | `:float` |
| `:speed` | `:float` |
| `:gpslock` | `:integer` |
| `:old` | `:integer` |
| `:ping` | `:integer` |
| `:motion` | `:integer` |
| `:speeding` | `:integer` |
| `:ignition` | `:integer` |
| `:ignitionstatus` | `:string` |
| `:rssi` | `:integer` |
| `:gpsfixquality` | `:integer` |
| `:eventtype` | `:integer` |
| `:eventcode` | `:integer` |
| `:sensor1` | `:integer` |
| `:sensor2` | `:integer` |
| `:odometer` | `:integer` |
| `:distancesincelastevent` | `:integer` |
| `:wsusername` | `:string` |
| `:wspassword` | `:string` |
| `:altitude` | `:integer` |
| `:error` | `:integer` |
| `:ioflagstatus` | `:integer` |
| `:alarmid` | `:integer` |
| `:errormsg` | `:string` |
| `:connectionname` | `:string` |
| `:weight` | `:float` |
| `:maxheight` | `:float` |
| `:fuelusage` | `:float` |
| `:engineonelapsed` | `:integer` |
| `:totalengineonelapsed` | `:integer` |
| `:input1elapsed` | `:integer` |
| `:input1status` | `:string` |
| `:input1flag` | `:integer` |
| `:totalinput1elapsed` | `:integer` |
| `:accelerometerx` | `:float` |
| `:accelerometery` | `:float` |
| `:accelerometerz` | `:float` |
| `:location` | `:string` |
| `:city` | `:string` |
| `:state` | `:string` |
| `:postcode` | `:string` |
| `:driverid` | `:string` |
| `:mifaredriverid` | `:string` |
| `:messageid` | `:integer` |
| `:originalmsg` | `:binary` |
| `:prestartchecklist` | `:string` |
| `:motiontotalelapsed` | `:integer` |
| `:containerliftcount` | `:integer` |
| `:appmsgtext` | `:string` |
| `:pulsecount` | `:integer` |
| `:totalfuel` | `:integer` |
| `:vehicleload` | `:integer` |
| `:rawvehicleload` | `:integer` |
| `:appmsgtext2` | `:string` |
| `:batteryvoltage` | `:float` |
| `:rpm` | `:float` |
| `:engcoolanttemp` | `:float` |
| `:engcoolantpressure` | `:float` |
| `:engcoolantlevelpercent` | `:float` |
| `:engoiltemp` | `:float` |
| `:engoilpressure` | `:float` |
| `:engcrankcasepressure` | `:float` |
| `:engoillevelpercent` | `:float` |
| `:engfuellevel1percent` | `:float` |
| `:engfuellevel2percent` | `:float` |
| `:engfuelrate` | `:float` |
| `:engtotalfuelused` | `:float` |
| `:engtotalfuelidle` | `:float` |
| `:engtotalhoursidle` | `:float` |
| `:engtotalhours` | `:float` |
| `:totalvehiclehours` | `:float` |
| `:totalptohours` | `:float` |
| `:engaveragefueleco` | `:float` |
| `:internalbatteryvoltage` | `:float` |

**`changeset/2` details (lines 91–95):**
- Casts all 80 schema fields
- `validate_required([:hardwareid])` — only `:hardwareid` is required

---

### File 2: `lib/api_server/fortynine/webservicepositionqueue.ex`

**Module name:** `ApiServer.FortyNine.WebServicePositionQueue`

**Behaviours / use directives:**
- `use Ecto.Schema` (line 2)
- `use Bitwise` (line 3)
- `use Timex` (line 4)
- `import Ecto.Changeset` (line 5)

**Functions defined:**

| Function | Line | Visibility |
|----------|------|------------|
| `changeset/2` | 37 | Public (annotated `@doc false`) |

**Schema name:** `"webservicepositionqueue"` (line 7)

**Schema fields (all defined inside `schema` block, lines 7–34):**

| Field | Type |
|-------|------|
| `:RECORDID` | `:integer` |
| `:datetimequeued` | `:utc_datetime` |
| `:utctimestamp` | `:utc_datetime` |
| `:HARDWAREID` | `:string` |
| `:MOBILENAME` | `:string` |
| `:driverID` | `:string` |
| `:LATITUDE` | `:float` |
| `:LONGITUDE` | `:float` |
| `:HEADING` | `:float` |
| `:SPEED` | `:float` |
| `:GPSLOCK` | `:integer` |
| `:OLD` | `:integer` |
| `:PING` | `:integer` |
| `:MOTION` | `:integer` |
| `:SPEEDING` | `:integer` |
| `:IGNITION` | `:integer` |
| `:IGNITIONSTATUS` | `:string` |
| `:RSSI` | `:integer` |
| `:SATS` | `:integer` |
| `:SENSOR1` | `:integer` |
| `:SENSOR2` | `:integer` |
| `:WSUSERNAME` | `:string` |
| `:WSPASSWORD` | `:string` |
| `:ERROR` | `:integer` |
| `:ERRORMSG` | `:string` |
| `:CONNECTIONNAME` | `:string` |

**`changeset/2` details (lines 37–41):**
- Casts all 26 schema fields
- `validate_required([:HARDWAREID])` — only `:HARDWAREID` is required

---

## Test Coverage Search Results

### Direct test files
No direct test files exist for either module. The known test files are:
- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`

### Grep results: indirect coverage search

Searches performed across `test/` for:
- `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`
- `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`
- `FortyNine.CalampPositionEvents`, `FortyNine.WebServicePositionQueue`
- `changeset` (scoped to test directory)

**Result: Zero matches found for either module or their `changeset/2` functions in any test file.**

### `calamp_controller_test.exs` contents
The file exists but is completely empty — the `use ApiServerWeb.ConnCase` line is commented out and no tests are defined:

```elixir
defmodule ApiServerWeb.CalampControllerTest do
    # use ApiServerWeb.ConnCase
end
```

### Production usage context
Both modules are used exclusively in:
- `lib/api_server/tcp/tcp_commands.ex` (lines 1186–1187, 1226–1227, 1271–1272, 1311–1312, 1856–1857, 1896–1897)

In each call site, the pattern is:
```elixir
%CalampPositionEvents{}
|> CalampPositionEvents.changeset(fortynine_calamppositionevent)

%WebServicePositionQueue{}
|> WebServicePositionQueue.changeset(fortynine_queued_event)
```

No tests cover `tcp_commands.ex` either (it is not in the known test file list).

---

## Findings

---

### B002-1
**Severity:** HIGH
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Issue:** No test file exists for `ApiServer.FortyNine.CalampPositionEvents`

There is no direct test file and no indirect test coverage found anywhere in the `test/` directory. The module defines an Ecto schema backed by a production database table (`[REDACTED-AWS-SMTP-PASSWORD]`) and a `changeset/2` function that is called from `tcp_commands.ex` at three distinct call sites (lines 1186, 1271, 1856). Any regression in changeset behaviour — such as a cast omission, a type mismatch, or a field being accidentally removed — would be completely invisible to the test suite.

---

### B002-2
**Severity:** HIGH
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Issue:** No test file exists for `ApiServer.FortyNine.WebServicePositionQueue`

There is no direct test file and no indirect test coverage found anywhere in the `test/` directory. The module defines an Ecto schema backed by `[REDACTED-AWS-SMTP-PASSWORD]` and a `changeset/2` function called from `tcp_commands.ex` at three distinct call sites (lines 1226, 1311, 1896). Identical risk profile to B002-1.

---

### B002-3
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Function:** `changeset/2` (line 91)
**Issue:** `changeset/2` has no test exercising its valid path

No test verifies that a valid attrs map with a `:hardwareid` value produces an `{:ok, changeset}` result with `changeset.valid? == true`. The function is the sole public API of the module and is exercised only from the TCP processing path, which itself has no tests.

---

### B002-4
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Function:** `changeset/2` (line 37)
**Issue:** `changeset/2` has no test exercising its valid path

Same situation as B002-3. No test verifies that a valid attrs map with a `:HARDWAREID` value produces a valid changeset.

---

### B002-5
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Function:** `changeset/2` (line 91)
**Issue:** `validate_required([:hardwareid])` failure path is untested

No test verifies that omitting `:hardwareid` from attrs causes `changeset.valid? == false` and produces the expected validation error on the `:hardwareid` field. A change to the `validate_required` call (e.g., accidentally widening or narrowing the required list) would not be caught.

---

### B002-6
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Function:** `changeset/2` (line 37)
**Issue:** `validate_required([:HARDWAREID])` failure path is untested

Same situation as B002-5. No test verifies the changeset is invalid when `:HARDWAREID` is absent from attrs.

---

### B002-7
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Function:** `changeset/2` (line 91)
**Issue:** Unknown/extra keys in attrs are not tested for safe rejection

`cast/3` silently drops fields not present in the permitted list. There is no test confirming that arbitrary or misspelled keys passed in attrs are silently ignored rather than causing an error, nor that the cast list itself is complete and accurate relative to the schema definition.

---

### B002-8
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Function:** `changeset/2` (line 37)
**Issue:** Unknown/extra keys in attrs are not tested for safe rejection

Same situation as B002-7.

---

### B002-9
**Severity:** LOW
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Function:** `changeset/2` (line 91)
**Issue:** Edge cases for nil, empty, and boundary values are untested

No tests cover:
- Passing `nil` explicitly for optional float fields (e.g., `:latitude`, `:longitude`, `:speed`) to confirm they are accepted
- Passing an empty string for string fields (e.g., `:ignitionstatus`, `:errormsg`) to confirm behaviour
- Passing zero or negative integers for fields where only positive values are meaningful (e.g., `:hardwareid`, `:odometer`, `:speed`)
- Passing `nil` for `:hardwareid` explicitly (should produce a required validation error)
- Passing a binary value for `:originalmsg` to confirm `:binary` cast handling

---

### B002-10
**Severity:** LOW
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Function:** `changeset/2` (line 37)
**Issue:** Edge cases for nil, empty, and boundary values are untested

No tests cover:
- Passing `nil` for optional float fields (e.g., `:LATITUDE`, `:LONGITUDE`, `:SPEED`)
- Passing an empty string for `:HARDWAREID` — the `validate_required` check passes for empty strings in Ecto unless `validate_required` is combined with a length/format validation; this edge case is unverified
- Passing `nil` for `:HARDWAREID` explicitly
- Passing zero or negative values for numeric fields

---

### B002-11
**Severity:** LOW
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Issue:** Unused `use Bitwise` and `use Timex` directives

Lines 3 and 4 import `Bitwise` and `Timex` into the module, but the module body (schema + changeset) makes no use of any functions from either library. This dead import has no test asserting the module compiles without warnings. While not a coverage gap per se, it indicates the module may be copy-pasted boilerplate and no test would catch a future accidental use of bitwise operators or Timex functions that could cause subtle type errors on field values.

---

### B002-12
**Severity:** LOW
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Issue:** Unused `use Bitwise` and `use Timex` directives

Same situation as B002-11. Lines 3 and 4 of `webservicepositionqueue.ex` include `use Bitwise` and `use Timex` with no actual usage in the module.

---

### B002-13
**Severity:** INFO
**File:** `test/api_server_web/controllers/calamp_controller_test.exs`
**Issue:** CalAMP controller test file is an empty stub

The file at `test/api_server_web/controllers/calamp_controller_test.exs` exists but contains only a commented-out `use ApiServerWeb.ConnCase` line and no test cases. This is the closest test file to the CalAMP domain and indicates that controller-level integration tests were planned but never implemented. This leaves the full request-to-database pipeline (controller → tcp_commands → changeset → Repo.insert) completely untested.

---

## Summary Table

| ID | Severity | File | Issue |
|----|----------|------|-------|
| B002-1 | HIGH | calamppositionevents.ex | No test file exists |
| B002-2 | HIGH | webservicepositionqueue.ex | No test file exists |
| B002-3 | MEDIUM | calamppositionevents.ex | `changeset/2` valid path untested |
| B002-4 | MEDIUM | webservicepositionqueue.ex | `changeset/2` valid path untested |
| B002-5 | MEDIUM | calamppositionevents.ex | `validate_required` failure path untested |
| B002-6 | MEDIUM | webservicepositionqueue.ex | `validate_required` failure path untested |
| B002-7 | MEDIUM | calamppositionevents.ex | Cast with unknown/extra keys untested |
| B002-8 | MEDIUM | webservicepositionqueue.ex | Cast with unknown/extra keys untested |
| B002-9 | LOW | calamppositionevents.ex | Nil/empty/boundary edge cases untested |
| B002-10 | LOW | webservicepositionqueue.ex | Nil/empty/boundary edge cases untested |
| B002-11 | LOW | calamppositionevents.ex | Unused `use Bitwise` / `use Timex` — no compile-warning test |
| B002-12 | LOW | webservicepositionqueue.ex | Unused `use Bitwise` / `use Timex` — no compile-warning test |
| B002-13 | INFO | calamp_controller_test.exs | Controller test file is an empty stub |

**Total findings: 13** (2 HIGH, 6 MEDIUM, 4 LOW, 1 INFO)
