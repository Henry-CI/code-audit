# Audit Report B026
**Audit run:** 2026-02-27-01
**Agent:** B026 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/views/vx_rental_view.ex`
2. `lib/api_server_web/views/vx_restriction_view.ex`
3. `lib/api_server_web/views/vx_thing_event_view.ex`
4. `lib/api_server_web/views/vx_thing_omega_view.ex`

---

## Reading Evidence

### 1. `lib/api_server_web/views/vx_rental_view.ex`

**Module:** `ApiServerWeb.VXRentalView`

**Aliases:**
- `ApiServer.Vx`
- `ApiServerWeb.VXRentalView`
- `ApiServerWeb.VXThingView`
- `ApiServerWeb.VXCustomerView`

**Functions defined:**

| Line | Visibility | Name / Clause | Notes |
|------|-----------|---------------|-------|
| 8    | public    | `render/2` — `"rhm_rentals.json"` | Renders a list of rentals for a customer; delegates to `"rhm_rental.json"` |
| 13   | public    | `render/2` — `"rhm_rental.json"` | Renders a single rental; calls `Vx.fetch_actual_usage/5`, `Vx.get_usage_since_service/2`, `Vx.get_avg_weekly_hours/2`; branches on `vx_rental.thing != nil` (lines 16–26) and `Map.has_key?(vx_rental, :overage)` (lines 29–34) |
| 64   | public    | `render/2` — `"midpac_report.json"` | Pass-through; returns `data` unchanged |
| 68   | public    | `render/2` — `"rental_anniversaries.json"` | Pass-through; returns `data` unchanged |
| 73   | public    | `convert_json_to_changeset/1` | Converts inbound rental JSON map to a changeset map; contains a `case` on `rental_json["period"]` matching `"28 Day Period"` → `"28DAY"` with a catch-all |

**Types / constants:** None explicitly defined.

**Notable code-quality observation:** Line 55 contains a typo in the JSON key name: `hours_to_serivce` (should be `hours_to_service`). This is a data contract bug, not a test coverage gap per se, but noted as evidence.

---

### 2. `lib/api_server_web/views/vx_restriction_view.ex`

**Module:** `ApiServerWeb.VXRestrictionView`

**Aliases:**
- `ApiServerWeb.VXRestrictionView`

**Functions defined:**

| Line | Visibility | Name / Clause | Notes |
|------|-----------|---------------|-------|
| 5    | public    | `render/2` — `"index.json"` | Wraps list in `%{data: ...}` using `render_many/3` |
| 9    | public    | `render/2` — `"show.json"` | Wraps single record in `%{data: ...}` using `render_one/3` |
| 13   | public    | `render/2` — `"vx_restriction.json"` | Maps all seven schema fields to JSON keys |

**Types / constants:** None.

---

### 3. `lib/api_server_web/views/vx_thing_event_view.ex`

**Module:** `ApiServerWeb.VXThingEventView`

**Aliases:**
- `ApiServerWeb.VXThingEventView`

**Functions defined:**

| Line | Visibility | Name / Clause | Notes |
|------|-----------|---------------|-------|
| 5    | public    | `render/2` — `"index.json"` | Wraps list in `%{data: ...}` using `render_many/3` |
| 9    | public    | `render/2` — `"show.json"` | Returns `render_one/3` result directly (no `%{data:}` wrapper — note asymmetry with index) |
| 13   | public    | `render/2` — `"vx_thing_event.json"` | Merges `thingevent_to_map/1` and `omega_to_map/1`; requires `vx_thing_event.thingeventomega` to be loaded (will crash if association is nil/not-loaded) |
| 18   | private   | `omega_to_map/1` | Maps 61 omega fields to a plain map |
| 83   | private   | `thingevent_to_map/1` | Maps 30 core thingevent fields to a plain map |

**Types / constants:** None.

**Notable code-quality observation:** `render("show.json", ...)` on line 9–11 returns the merged map directly without a `%{data: ...}` wrapper, while `render("index.json", ...)` wraps in `%{data: ...}`. This is an asymmetry that may be intentional or a bug; no tests confirm expected shape.

---

### 4. `lib/api_server_web/views/vx_thing_omega_view.ex`

**Module:** `ApiServerWeb.VXThingOmegaView`

**Aliases:**
- `ApiServerWeb.VXThingOmegaView`

**Functions defined:**

| Line | Visibility | Name / Clause | Notes |
|------|-----------|---------------|-------|
| 6    | public    | `render/2` — `"container_lift_report.json"` | Formats a list of `{date_tuple, day_name, lift_count}` tuples |
| 17   | public    | `render/2` — `"lift_summary_report_fleet.json"` | Formats a list of 8-element tuples (date, day_name, 6 counts) |
| 39   | public    | `render/2` — `"lift_summary_report.json"` | Formats a list of 9-element tuples (adds `thing_name`) |
| 63   | public    | `render/2` — `"lift_list_report.json"` | Formats lift list; calls `Timex.to_datetime/1` and `translate_lift_type_to_string/1` |
| 77   | public    | `render/2` — `"engine_utilization_report.json"` | Formats engine use data; computes `high_idle` via `max(0, engine_hours - idle_hours)` |
| 92   | public    | `render/2` — `"operation_summary_report.json"` | Computes three averages with division-by-zero guards; uses `Decimal` arithmetic |
| 139  | private   | `translate_lift_type_to_string/1` | `case` on integer lift_type: 0→"20", 1→"30", 2→"40", 4→"chain", 8→"bottom", _→"unknown" |

**Types / constants:** None.

---

## Test Coverage Investigation

### Test files searched

All `.exs` files under `test/` were enumerated. The full set is:

- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`
- `test/test_helper.exs`

### Grep results

- Searches for `VXRentalView`, `VxRentalView`, `vx_rental_view`: **0 matches** in any test file.
- Searches for `VXRestrictionView`, `VxRestrictionView`, `vx_restriction_view`: **0 matches** in any test file. (The controller test exercises the view indirectly via HTTP round-trips.)
- Searches for `VXThingEventView`, `VxThingEventView`, `vx_thing_event_view`: **0 matches** in any test file.
- Searches for `VXThingOmegaView`, `VxThingOmegaView`, `vx_thing_omega_view`: **0 matches** in any test file.
- Searches for render template name strings (`rhm_rental`, `midpac_report`, `rental_anniversaries`, `container_lift_report`, `lift_summary_report`, `lift_list_report`, `engine_utilization`, `operation_summary`): **0 matches**.
- Searches for `convert_json_to_changeset`, `thingevent`, `thing_event`: **0 matches**.

### Indirect coverage via `vx_restriction_controller_test.exs`

The controller test does exercise `VXRestrictionView` indirectly because the controller calls `render/2` and the test asserts on JSON responses. Specifically covered:

- `render("index.json", ...)` — covered by the "lists all vxaau_rest" test (line 22–24 of test).
- `render("show.json", ...)` — covered by the create-then-show and update-then-show tests (lines 29–40, 52–64).
- `render("vx_restriction.json", ...)` — covered by the show assertions that verify all seven fields.

However, this is controller-level integration coverage with no isolated unit tests for the view itself.

---

## Findings

---

### B026-1 — No test file exists for `VXRentalView`
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_rental_view.ex`
**Detail:** There is no direct test file and no indirect test coverage found anywhere in the test suite for `ApiServerWeb.VXRentalView`. All four public render clauses and `convert_json_to_changeset/1` are completely untested.

---

### B026-2 — No test file exists for `VXThingEventView`
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`
**Detail:** There is no direct test file and no indirect test coverage found anywhere in the test suite for `ApiServerWeb.VXThingEventView`. All three public render clauses and both private helper functions are completely untested.

---

### B026-3 — No test file exists for `VXThingOmegaView`
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`
**Detail:** There is no direct test file and no indirect test coverage found anywhere in the test suite for `ApiServerWeb.VXThingOmegaView`. All six public render clauses and the private `translate_lift_type_to_string/1` function are completely untested.

---

### B026-4 — No unit test file exists for `VXRestrictionView`
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_restriction_view.ex`
**Detail:** There is no direct unit test file for `ApiServerWeb.VXRestrictionView`. Indirect coverage exists only through `vx_restriction_controller_test.exs`, which exercises the view as a side-effect of HTTP requests. Isolated view-level assertions (e.g., testing the shape of the rendered map in isolation) are absent. The existing controller test does provide meaningful but incomplete coverage.

---

### B026-5 — `render("rhm_rental.json")` — `thing == nil` branch untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 16–26
**Detail:** The `cond` block at line 15 has two branches: one where `vx_rental.thing != nil` (performs Vx context calls) and a fallback `true` branch that returns `{0,0,0,0,0}`. No test exercises the `thing == nil` path to confirm defaults are rendered correctly.

---

### B026-6 — `render("rhm_rental.json")` — `overage` present branch untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 28–34
**Detail:** The `cond` block at line 28 branches on `Map.has_key?(vx_rental, :overage)`. No test exercises the path where `overage`, `period_start`, and `period_usage` are present on the rental struct, so the `DateTime.to_date/1` conversion on `period_start` is never verified.

---

### B026-7 — `convert_json_to_changeset/1` — "28 Day Period" branch untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 73–89
**Detail:** The `case` on `rental_json["period"]` at line 74 has a specific match for `"28 Day Period"` that converts it to `"28DAY"`. The catch-all branch is also untested. Neither branch has any test coverage; incorrect period conversion would silently produce wrong data.

---

### B026-8 — `convert_json_to_changeset/1` — nil/missing fields behaviour untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 73–89
**Detail:** The function calls `Vx.update_key_if_value/3` for every field. No test verifies that missing (nil) JSON keys are correctly omitted from the resulting changeset map, nor that partial inputs produce partial maps.

---

### B026-9 — `render("vx_thing_event.json")` crashes if `thingeventomega` association is nil or not loaded
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`, line 14
**Detail:** `omega_to_map(vx_thing_event.thingeventomega)` will raise a `KeyError` or `FunctionClauseError` if `thingeventomega` is `nil` or an `Ecto.Association.NotLoaded` struct. There is no guard, no test confirming behavior when the association is missing, and no documentation of the precondition.

---

### B026-10 — `render("operation_summary_report.json")` — division-by-zero guards only partially cover Decimal edge cases
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, lines 103–122
**Detail:** The function guards `operating_hours == 0` and `Decimal.to_integer(lift_count) == 0` before performing `Decimal.div/2`. However, no tests exist to confirm that:
1. The guards actually prevent `Decimal.div/2` from being called with a zero denominator.
2. The comparison `operating_hours == 0` works correctly when `operating_hours` is a `Decimal` value (Decimal zero does not `==` integer `0` in all contexts in Elixir).
3. The computed averages are rounded correctly.

---

### B026-11 — `translate_lift_type_to_string/1` — unmapped integer values silently return "unknown"
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, lines 139–154
**Detail:** Lift type integers 3, 5, 6, 7, and any value > 8 fall through to the `_` catch-all and return `"unknown"`. No test verifies that invalid/unexpected lift type codes are handled gracefully or that the mapped values (0→"20", 1→"30", 2→"40", 4→"chain", 8→"bottom") are correct. Note also that lift type integer `3` (which may represent a valid hardware state) silently becomes `"unknown"` with no log or error.

---

### B026-12 — `render("show.json")` in `VXThingEventView` lacks `%{data:}` wrapper — asymmetry with `index.json` untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`, lines 9–11
**Detail:** `render("show.json", ...)` returns the flat merged map directly, while `render("index.json", ...)` wraps results in `%{data: ...}`. This asymmetry differs from the Phoenix generator convention and from the pattern used in `VXRestrictionView`. No test exists to confirm which shape is expected by API clients; if this is unintentional it is an API contract bug.

---

### B026-13 — `render("rhm_rentals.json")` not tested with empty list
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 8–12
**Detail:** No test checks that rendering an empty `vx_rentals` list returns an empty JSON array rather than raising or returning nil.

---

### B026-14 — `render("lift_list_report.json")` — `Timex.to_datetime/1` not tested with boundary inputs
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, lines 63–75
**Detail:** The `Timex.to_datetime/1` call on line 65 converts a raw datetime tuple. No tests exist for edge inputs such as an invalid datetime tuple, a naive datetime, or a timezone-aware datetime that Timex may handle differently.

---

### B026-15 — `render("engine_utilization_report.json")` — `high_idle` computed as `max(0, engine_hours - idle_hours)` with no test for negative intermediate value
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, line 86
**Detail:** When `idle_hours > engine_hours` (e.g., due to data anomalies), `high_idle` is clamped to 0 by `max/2`. No test verifies this clamping behavior or that the subtraction works correctly when the fields are `Decimal` vs. numeric types.

---

### B026-16 — `VXRestrictionView` — no test for `render("index.json")` with non-empty list
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_restriction_view.ex`, lines 5–7
**Detail:** The controller test for `index` only asserts `"data" == []` (empty list). No test verifies the rendered shape of a non-empty list, meaning the `render_many/3` path through `"vx_restriction.json"` is never exercised from the index route with actual data.

---

### B026-17 — Typo in JSON key `hours_to_serivce` in `VXRentalView`
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_rental_view.ex`, line 55
**Detail:** The rendered JSON field is named `hours_to_serivce` (misspelling of "service"). Because no tests assert on this key name, the bug has gone undetected. Any API client relying on a correctly-spelled key would silently receive no value.

---

## Summary Table

| ID     | Severity | File                          | Description |
|--------|----------|-------------------------------|-------------|
| B026-1 | HIGH     | vx_rental_view.ex             | No test coverage at all for VXRentalView |
| B026-2 | HIGH     | vx_thing_event_view.ex        | No test coverage at all for VXThingEventView |
| B026-3 | HIGH     | vx_thing_omega_view.ex        | No test coverage at all for VXThingOmegaView |
| B026-4 | HIGH     | vx_restriction_view.ex        | No unit test file; only indirect controller coverage |
| B026-5 | MEDIUM   | vx_rental_view.ex             | `thing == nil` branch of rhm_rental.json untested |
| B026-6 | MEDIUM   | vx_rental_view.ex             | `overage` present branch untested |
| B026-7 | MEDIUM   | vx_rental_view.ex             | `convert_json_to_changeset/1` period branches untested |
| B026-8 | MEDIUM   | vx_rental_view.ex             | `convert_json_to_changeset/1` nil/missing fields untested |
| B026-9 | MEDIUM   | vx_thing_event_view.ex        | Crash if `thingeventomega` association not loaded |
| B026-10| MEDIUM   | vx_thing_omega_view.ex        | Division-by-zero guards and Decimal comparison untested |
| B026-11| MEDIUM   | vx_thing_omega_view.ex        | `translate_lift_type_to_string/1` values and unknown fallback untested |
| B026-12| MEDIUM   | vx_thing_event_view.ex        | `show.json` missing `%{data:}` wrapper — asymmetry untested |
| B026-13| LOW      | vx_rental_view.ex             | `rhm_rentals.json` not tested with empty list |
| B026-14| LOW      | vx_thing_omega_view.ex        | `lift_list_report.json` Timex conversion edge cases untested |
| B026-15| LOW      | vx_thing_omega_view.ex        | `high_idle` clamping to 0 not tested |
| B026-16| LOW      | vx_restriction_view.ex        | `index.json` only tested with empty list |
| B026-17| LOW      | vx_rental_view.ex             | Typo `hours_to_serivce` undetected due to absence of tests |
