# Audit Report B014
**Audit run:** 2026-02-27-01
**Agent:** Pass 2 / B014
**Scope:** ApiServerWeb.UserSocket, ApiServerWeb.Endpoint, ApiServerWeb.Gettext, Plug.Parsers.XML (xml_plug.ex)

---

## 1. Reading Evidence

### 1.1 `lib/api_server_web/channels/user_socket.ex`

**Module:** `ApiServerWeb.UserSocket`

| Kind | Name | Line |
|------|------|------|
| `use` macro | `Phoenix.Socket` | 2 |
| transport declaration | `:websocket` via `Phoenix.Transports.WebSocket` | 8 |
| public function | `connect/2` — accepts any params, returns `{:ok, socket}` | 22–24 |
| public function | `id/1` — always returns `nil` (anonymous socket) | 36 |

**Constants / config:**
- The `channel "room:*"` line is commented out; no channels are mounted.
- The `:longpoll` transport is commented out.

**Notes:**
- `connect/2` performs no authentication: every connection is unconditionally accepted.
- `id/1` always returns `nil`, making all sockets anonymous (no per-user broadcast possible).

---

### 1.2 `lib/api_server_web/endpoint.ex`

**Module:** `ApiServerWeb.Endpoint`

| Kind | Name | Line |
|------|------|------|
| `use` macro | `Phoenix.Endpoint, otp_app: :api_server` | 2 |
| socket mount | `/socket` → `ApiServerWeb.UserSocket` | 4 |
| plug | `Plug.Static` — serves `priv/static`, `gzip: false` | 10–12 |
| conditional plugs | `Phoenix.LiveReloader.Socket`, `Phoenix.LiveReloader`, `Phoenix.CodeReloader` (dev only) | 16–20 |
| plug | `Plug.Logger` | 22 |
| plug | `Plug.Parsers` with `:urlencoded`, `:multipart`, `:json`, `:xml`, `Absinthe.Plug.Parser`; `json_decoder: Poison`, `xml_decoder: :xmerl_scan` | 24–28 |
| plug | `Plug.MethodOverride` | 30 |
| plug | `Plug.Head` | 31 |
| plug | `Plug.Session` — cookie store, key `_api_server_key`, `signing_salt: "5CSDVUtC"` | 36–39 |
| plug | `CORSPlug` | 42 |
| plug | `ApiServerWeb.Router` | 43 |
| public callback | `init/2` — conditionally reads `PORT` env var | 51–58 |

**Constants:**
- `signing_salt: "5CSDVUtC"` — hardcoded literal in source.
- Session key: `"_api_server_key"`.
- `gzip: false` on static serving.

---

### 1.3 `lib/api_server_web/gettext.ex`

**Module:** `ApiServerWeb.Gettext`

| Kind | Name | Line |
|------|------|------|
| `use` macro | `Gettext, otp_app: :api_server` | 23 |

No functions or callbacks are defined directly in this file. All public macros (`gettext/1`, `ngettext/3`, `dgettext/2`, etc.) are injected by the `Gettext` library at compile time.

---

### 1.4 `lib/api_server_web/xml_plug.ex`

**Module:** `Plug.Parsers.XML`

| Kind | Name | Line |
|------|------|------|
| `@behaviour` | `Plug.Parsers` | 3 |
| public function | `parse/5` — XML content-type clause: reads body, decodes via `XmlToMap.naive_map/1`, returns `{:ok, %{xml: map}, conn}` | 6–11 |
| public function | `parse/5` — catch-all clause: returns `{:next, conn}` | 13–15 |
| private function | `decode/2` — wraps `XmlToMap.naive_map/1`; raises `Plug.Parsers.ParseError` on exception; hardcoded `raise "Malformed XML"` branch is unreachable | 17–26 |

**Constants / behaviours:**
- Decoder is retrieved from opts via `Keyword.get(opts, :xml_decoder)` — raises `ArgumentError` if missing.
- The `_` catch-all branch inside the `case` (line 21) is dead code: `XmlToMap.naive_map/1` either returns a value or raises; the `_ -> raise "Malformed XML"` arm can never be reached because the `case` has no failing pattern.
- Only the `:ok` tuple from `read_body/2` is handled; the `{:more, partial_body, conn}` and `{:error, reason}` tuples returned by `Plug.Conn.read_body/2` are not pattern-matched, meaning large or erroring request bodies will cause a `FunctionClauseError` at runtime.

---

## 2. Test Coverage Search Results

### 2.1 `test/support/channel_case.ex`
- Defines `ApiServerWeb.ChannelCase` which sets `@endpoint ApiServerWeb.Endpoint` and uses `Phoenix.ChannelTest`.
- **No test file uses `ApiServerWeb.ChannelCase`** — confirmed by the absence of any `*_channel_test.exs` file in the test tree.
- The case template is therefore defined but never instantiated; it provides zero actual coverage.

### 2.2 Grep results across all test files

| Search term | Files matched | Notes |
|-------------|---------------|-------|
| `UserSocket` | 0 | No tests reference the socket module |
| `connect` | 0 | `connect/2` callback never exercised |
| `id(_socket)` / `user_socket` | 0 | `id/1` never exercised |
| `ApiServerWeb.Endpoint` | 2 (conn_case.ex, channel_case.ex) | Only used as `@endpoint` config in support files, never tested directly |
| `Endpoint.init` / `load_from_system_env` / `PORT` | 0 | `init/2` never tested |
| `Gettext` | 0 | No test references the Gettext module |
| `Plug.Parsers.XML` / `xml_plug` / `XmlToMap` / `xml_decoder` | 0 | XML plug never tested |
| `xml` / `XML` / `parse` (in test dir) | 0 | No XML parsing tests at all |

### 2.3 Existing test files assessed for indirect coverage

| Test file | Relevant to assigned files? |
|-----------|----------------------------|
| `calamp_controller_test.exs` | Body is empty (`use` line commented out); no tests execute. |
| `vx_restriction_controller_test.exs` | Exercises JSON endpoints via `ConnCase`; does not send XML payloads. |
| `layout_view_test.exs` | Empty — no tests. |
| `page_view_test.exs` | Empty — no tests. |

**Conclusion: zero test coverage exists for all four assigned source files.**

---

## 3. Findings

---

### B014-1 — No test file for `ApiServerWeb.UserSocket`
**Severity:** HIGH
**File:** `lib/api_server_web/channels/user_socket.ex`

No dedicated test file exists for `ApiServerWeb.UserSocket`. Although `test/support/channel_case.ex` defines the `ChannelCase` helper and sets the correct `@endpoint`, no test module in the repository ever `use`s `ApiServerWeb.ChannelCase`, meaning the helper is dead infrastructure. Neither `connect/2` nor `id/1` is exercised by any test.

---

### B014-2 — `connect/2` has no authentication and is never tested
**Severity:** HIGH
**File:** `lib/api_server_web/channels/user_socket.ex`, line 22–24

`connect/2` unconditionally returns `{:ok, socket}` regardless of the params received. There is no token verification, no credential check, and no rejection path. No test verifies this behaviour, nor is there any test confirming that invalid/missing credentials are (or are not) rejected. This is both a security gap (unauthenticated WebSocket access) and a coverage gap.

---

### B014-3 — `id/1` always returns `nil` and is never tested
**Severity:** MEDIUM
**File:** `lib/api_server_web/channels/user_socket.ex`, line 36

`id/1` always returns `nil`, making all sockets permanently anonymous. No test verifies this return value, nor is there a test confirming that per-user broadcast (e.g. `Endpoint.broadcast/3` keyed on socket id) is not expected. If per-user disconnect broadcasts are ever needed, the hardcoded `nil` will silently prevent them.

---

### B014-4 — No test file for `ApiServerWeb.Endpoint`
**Severity:** HIGH
**File:** `lib/api_server_web/endpoint.ex`

No dedicated test file exists for `ApiServerWeb.Endpoint`. The endpoint is referenced as `@endpoint` in support files but its own configuration — plug pipeline order, session configuration, CORS, parser setup — is never verified in isolation.

---

### B014-5 — `init/2` `load_from_system_env` branch is never tested
**Severity:** MEDIUM
**File:** `lib/api_server_web/endpoint.ex`, lines 51–58

The `init/2` callback has two branches:
1. `load_from_system_env: true` — reads the `PORT` environment variable and raises if absent.
2. The else branch — returns config unchanged.

Neither branch is covered by a test. In particular, the error path (`PORT` not set) which raises a runtime exception is untested and could silently break deployments.

---

### B014-6 — Hardcoded `signing_salt` in endpoint configuration
**Severity:** MEDIUM
**File:** `lib/api_server_web/endpoint.ex`, line 39

The session `signing_salt` value `"5CSDVUtC"` is a literal string committed to source code. No test verifies that this value is configurable via environment or application config. While this is primarily a security concern, it also represents a missing test for configuration hygiene (verifying that the value is loaded from config rather than hardcoded).

---

### B014-7 — No test file for `ApiServerWeb.Gettext`
**Severity:** HIGH
**File:** `lib/api_server_web/gettext.ex`

No test file exists for `ApiServerWeb.Gettext`. The module is a thin wrapper over the `Gettext` library, but no test verifies that translation files are present, that the `otp_app` binding is correct, or that `gettext/1`, `ngettext/3`, or `dgettext/2` resolve strings as expected.

---

### B014-8 — No test file for `Plug.Parsers.XML`
**Severity:** HIGH
**File:** `lib/api_server_web/xml_plug.ex`

No test file exists for the custom XML parser plug. The module implements `Plug.Parsers` behaviour and is referenced in the endpoint's `Plug.Parsers` configuration (endpoint.ex line 25). No integration or unit test sends an XML-content-typed request through the pipeline.

---

### B014-9 — `parse/5` XML clause: `{:more, ...}` and `{:error, ...}` tuples from `read_body/2` not handled
**Severity:** MEDIUM
**File:** `lib/api_server_web/xml_plug.ex`, lines 6–11 and 17–26

`Plug.Conn.read_body/2` can return three shapes:
- `{:ok, body, conn}` — handled by `decode/2`.
- `{:more, partial_body, conn}` — not matched; causes `FunctionClauseError` at runtime for requests whose body exceeds the read buffer.
- `{:error, reason}` — not matched; causes `FunctionClauseError` for network read errors.

Neither the missing pattern-match branches nor the resulting runtime errors are covered by any test.

---

### B014-10 — Dead code branch in `decode/2`: `_ -> raise "Malformed XML"` is unreachable
**Severity:** LOW
**File:** `lib/api_server_web/xml_plug.ex`, lines 19–22

The `case XmlToMap.naive_map(body) do` expression has a wildcard arm (`_ -> raise "Malformed XML"`) that can never be reached: `XmlToMap.naive_map/1` either returns a value (matched by `map ->`) or raises an exception (caught by the surrounding `rescue`). The dead arm creates a false impression of error handling. No test probes malformed XML to expose this gap.

---

### B014-11 — `decode/2` does not handle `{:more, ...}` / `{:error, ...}` from `read_body` (error path untested)
**Severity:** MEDIUM
**File:** `lib/api_server_web/xml_plug.ex`, lines 17–26

Related to B014-9: the `decode/2` private function is only defined for the `{:ok, body, conn}` pattern. The missing clauses for `:more` and `:error` results are untested error paths that would produce unhelpful `FunctionClauseError` exceptions rather than proper `Plug.Parsers.ParseError` responses.

---

### B014-12 — XML parser: missing `:xml_decoder` option raises `ArgumentError` — untested
**Severity:** LOW
**File:** `lib/api_server_web/xml_plug.ex`, line 7

The `parse/5` XML clause raises an `ArgumentError` when no `:xml_decoder` opt is provided. This error path is never exercised by any test. While the endpoint currently supplies the decoder, a misconfiguration would produce an unhelpful crash rather than a meaningful error message.

---

### B014-13 — `calamp_controller_test.exs` is an empty stub
**Severity:** INFO
**File:** `test/api_server_web/controllers/calamp_controller_test.exs`

The `use ApiServerWeb.ConnCase` line is commented out and the module body is empty. This stub provides no coverage and gives a false impression of a tested module. Any XML payloads that would exercise `Plug.Parsers.XML` via the Calamp controller are absent.

---

### B014-14 — `ChannelCase` support module is defined but never used
**Severity:** INFO
**File:** `test/support/channel_case.ex`

`ApiServerWeb.ChannelCase` is fully implemented (Ecto sandbox setup, `Phoenix.ChannelTest` import) but no test file in the repository uses it. The infrastructure for socket/channel testing exists but no tests have been written against it.

---

## 4. Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B014-1 | HIGH | user_socket.ex | No test file exists for `ApiServerWeb.UserSocket` |
| B014-2 | HIGH | user_socket.ex | `connect/2` has no auth and is completely untested |
| B014-3 | MEDIUM | user_socket.ex | `id/1` always returns `nil`; never tested |
| B014-4 | HIGH | endpoint.ex | No test file exists for `ApiServerWeb.Endpoint` |
| B014-5 | MEDIUM | endpoint.ex | `init/2` both branches (including raise on missing PORT) untested |
| B014-6 | MEDIUM | endpoint.ex | Hardcoded `signing_salt` literal; no config-hygiene test |
| B014-7 | HIGH | gettext.ex | No test file exists for `ApiServerWeb.Gettext` |
| B014-8 | HIGH | xml_plug.ex | No test file exists for `Plug.Parsers.XML` |
| B014-9 | MEDIUM | xml_plug.ex | `{:more, ...}` and `{:error, ...}` from `read_body/2` not handled or tested |
| B014-10 | LOW | xml_plug.ex | Dead `_ -> raise "Malformed XML"` branch in `decode/2` |
| B014-11 | MEDIUM | xml_plug.ex | `decode/2` missing clauses for `:more`/`:error`; error path untested |
| B014-12 | LOW | xml_plug.ex | Missing `:xml_decoder` option raises `ArgumentError`; untested |
| B014-13 | INFO | calamp_controller_test.exs | Test file is an empty stub; no coverage provided |
| B014-14 | INFO | channel_case.ex | `ChannelCase` support module defined but never used by any test |
