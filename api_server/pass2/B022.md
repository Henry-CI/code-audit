# Audit Report B022
**Audit run:** 2026-02-27-01
**Agent:** B022
**Pass:** 2 (Test Coverage)
**Files audited:**
- `lib/api_server_web/router.ex`
- `lib/api_server_web/schema.ex`
- `lib/api_server_web/schema/thing_types.ex`

---

## READING EVIDENCE

### File: `lib/api_server_web/router.ex`

**Module:** `ApiServerWeb.Router`

**Pipelines defined:**
- `:browser` — HTML, session, CSRF, secure headers
- `:api` — JSON, session
- `:api_xml` — XML, session
- `:authenticated` — `ApiServer.Guardian.AuthPipeline`

**Routes — scope `/api/v1` (unauthenticated block, lines 28–32):**

| # | Method | Path | Controller | Action |
|---|--------|------|------------|--------|
| R01 | GET | `/api/v1/rhm/engine_usage` | VXThingController | `:combined_engine_usage` |
| R02 | GET | `/api/v1/rhm/monday_hour_meters` | VXThingController | `:monday_hour_meters` |

**Routes — scope `/api/v1` (`:api` + `:authenticated` pipelines, lines 33–154):**

| # | Method | Path | Controller | Action |
|---|--------|------|------------|--------|
| R03 | GET | `/api/v1/rhm/pape_export` | VXThingController | `:pape_export` |
| R04 | GET | `/api/v1/rhm/sielift_export` | VXThingController | `:sielift_export` |
| R05 | GET | `/api/v1/rhm/reports/geofence_events` | GeofenceController | `:process_things_geofences` |
| R06 | GET | `/api/v1/rhm/work_in_progress` | VXThingController | `:sielift_export` (alias — was `:work_in_progress`) |
| R07 | GET | `/api/v1/rhm/things_with_usage` | VXThingController | `:rhm_get_things_with_usage` |
| R08 | GET | `/api/v1/rhm/thing_records` | VXThingController | `:rhm_get_thing_records` |
| R09 | GET | `/api/v1/rhm/:customer/things/names` | VXThingController | `:rhm_get_things_names` |
| R10 | GET | `/api/v1/rhm/:customer/things` | VXThingController | `:rhm_get_things` |
| R11 | GET | `/api/v1/rhm/thing/:hardwareid/events` | VXThingController | `:rhm_get_thing_events` |
| R12 | GET | `/api/v1/rhm/thing/:hardwareid/usage` | VXThingController | `:rhm_get_thing_usage` |
| R13 | GET | `/api/v1/rhm/:customer/thing/:hardwareid` | VXThingController | `:rhm_get_thing` |
| R14 | GET | `/api/v1/rhm/thing/:hardwareid/active_rental` | VXRentalController | `:rhm_active_rental` |
| R15 | POST | `/api/v1/rhm/thing/` | VXThingController | `:update_thing` |
| R16 | PUT | `/api/v1/rhm/thing/` | VXThingController | `:create_thing` |
| R17 | GET | `/api/v1/rhm/thing/:hardwareid/omega_data` | VXThingEventController | `:get_current_omega_status` |
| R18 | GET | `/api/v1/vx/:customer/thing/:hardwareid/movements/:day` | VXThingController | `:get_movements` |
| R19 | GET | `/api/v1/rhm/omega_thing/:hardwareid/container_lift_report` | VXThingOmegaController | `:get_container_lift_report` |
| R20 | GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_summary_report` | VXThingOmegaController | `:get_lift_summary_report` |
| R21 | GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_list_report` | VXThingOmegaController | `:get_lift_list_report` |
| R22 | GET | `/api/v1/rhm/omega_fleet/:fleetid/lift_summary_report` | VXThingOmegaController | `:get_lift_summary_report` |
| R23 | GET | `/api/v1/rhm/omega_thing/:hardwareid/engine_utilization_report` | VXThingOmegaController | `:get_engine_utilization_report` |
| R24 | GET | `/api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` | VXThingOmegaController | `:get_operation_summary_report` |
| R25 | GET | `/api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` | VXThingOmegaController | `:get_operation_summary_report` (DUPLICATE of R24) |
| R26 | GET | `/api/v1/rhm/fleets` | VXFleetController | `:get_fleets` |
| R27 | GET | `/api/v1/rhm/fleets_with_equipment` | VXFleetController | `:get_fleets_with_equipment` |
| R28 | PUT | `/api/v1/rhm/:customer/fleet/` | VXFleetController | `:create_fleet` |
| R29 | DELETE | `/api/v1/rhm/:customer/fleet/:id` | VXFleetController | `:delete_fleet` |
| R30 | POST | `/api/v1/rhm/:customer/fleet/` | VXFleetController | `:update_fleet` |
| R31 | GET | `/api/v1/rhm/:customer/fleet/:id/equipment` | VXFleetController | `:get_equipment_in_fleet` |
| R32 | POST | `/api/v1/rhm/:customer/fleet/:id/manage` | VXFleetController | `:manage_fleet` |
| R33 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXAblRecordController | `:rhm_service_records` |
| R34 | GET | `/api/v1/rhm/:customer/rentals` | VXRentalController | `:get_rentals` |
| R35 | POST | `/api/v1/rhm/:customer/rentals/` | VXRentalController | `:update_rental` |
| R36 | PUT | `/api/v1/rhm/:customer/rentals/` | VXRentalController | `:create_rental` |
| R37 | DELETE | `/api/v1/rhm/:customer/rentals/:id` | VXRentalController | `:delete_rental` |
| R38 | GET | `/api/v1/rhm/thing/:hardwareid/rental_anniversaries` | VXRentalController | `:get_rental_anniversaries` |
| R39 | GET | `/api/v1/rhm/rentals/midpac_style_report` | VXRentalController | `:get_midpac_style_rental_report` |
| R40 | POST | `/api/v1/rhm/user/change_password` | VXUserController | `:change_password` |
| R41 | GET | `/api/v1/rhm/user/:user_id/fleets` | VXUserController | `:get_user_fleets` |
| R42 | POST | `/api/v1/rhm/user/:user_id/fleets` | VXUserController | `:manage_user_fleets` |
| R43 | GET | `/api/v1/rhm/:customer/users` | VXUserController | `:get_users` |
| R44 | GET | `/api/v1/rhm/:customer/user/:email` | VXUserController | `:get_user_with_email` |
| R45 | POST | `/api/v1/rhm/:customer/user/` | VXUserController | `:update_user` |
| R46 | PUT | `/api/v1/rhm/:customer/user/` | VXUserController | `:create_user` |
| R47 | DELETE | `/api/v1/rhm/:customer/user/:id` | VXUserController | `:delete_user` |
| R48 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXCustomerController | `:index` |
| R49 | GET | `/api/v1/rhm/customer/:id` | VXCustomerController | `:show` |
| R50 | POST | `[REDACTED-AWS-SMTP-PASSWORD]` | VXCustomerController | `:update` |
| R51 | PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | VXCustomerController | `:create` |
| R52 | DELETE | `/api/v1/rhm/customer/:id` | VXCustomerController | `:delete` |
| R53 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXThingController | `:get_fleet_map` |
| R54 | GET | `/api/v1/rhm/fleetmap/:fleetid` | VXThingController | `:get_fleet_map` |
| R55 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | GeofenceController | `:list_all_geofences` |
| R56 | PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | GeofenceController | `:create_geofence` |
| R57 | POST | `[REDACTED-AWS-SMTP-PASSWORD]` | GeofenceController | `:update_geofence` |
| R58 | DELETE | `/api/v1/rhm/geofence/:id` | GeofenceController | `:delete_geofence` |

**Routes — scope `/api/v1` (`:api` pipeline only, lines 156–177):**

| # | Method | Path | Controller | Action |
|---|--------|------|------------|--------|
| R59 | GET | `/api/v1/hc` | UtilityController | `:do_health_check` |
| R60 | POST | `/api/v1/rhm/:customer/login/` | VXUserController | `:login` |
| R61–R66 | (REST) | `[REDACTED-AWS-SMTP-PASSWORD]` | VXThingSummaryController | `resources` (index, show, create, update, delete) |
| R67 | GET | `/api/v1/files/getsize/:esn` | FileController | `:get_size` |
| R68 | GET | `/api/v1/files/getfile/:esn` | FileController | `:send_file_download` |
| R69 | GET | `/api/v1/vx/:customer/thing/with_checklists` | VXThingController | `:get_hardware_with_checklists` |
| R70 | GET | `/api/v1/vx/:customer/thing/:hardwareid/checklists` | VXThingController | `:get_checklists` |
| R71 | GET | `/api/v1/vx/:customer/pmServicesAjax/:hardwareid` | VXThingController | `:get_pm_data` |
| R72 | GET | `/api/v1/vx/:customer/pmServicesAjax` | VXThingController | `:get_all_pm_data` |
| R73 | GET | `/api/v1/vx/:customer/rentalStats` | VXThingController | `:get_all_rental_stats` |
| R74 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXThingController | `:get_timezones` |
| R75 | GET | `/api/v1/rhm/:customer/fix_info` | VXThingInfoController | `:fix_infos` |

**Routes — scope `/` (`:api_xml` pipeline, lines 179–193):**

| # | Method | Path | Controller | Action |
|---|--------|------|------------|--------|
| R76 | GET | `/` | UtilityController | `:do_health_check` |
| R77 | GET | `/geocode` | UtilityController | `:do_geocode_lookup` |
| R78 | GET | `/error/:status_code` | UtilityController | `:do_error` |
| R79 | POST | `/test-omega-data` | UtilityController | `:process_incoming_omegawatch_data` |
| R80 | POST | `/prodisplay/event` | UtilityController | `:process_prodisplay_event` |
| R81 | POST | `/` | DigitalMatterController | `:get_g62_data` |
| R82 | POST | `/erp-import` | UtilityController | `:erp_import` |
| R83 | POST | `/driverid-converter` | UtilityController | `:driverid_converter` |
| R84 | GET | `/dis-sync` | UtilityController | `:sync_to_DISCorp` |

**Note:** GraphQL forwarding (`/graphql`, `/graphiql`) is commented out at lines 195–202.

---

### File: `lib/api_server_web/schema.ex`

**Module:** `ApiServerWeb.Schema`

**Queries defined:**

| # | Field | Return Type | Args | Resolver | Line |
|---|-------|-------------|------|----------|------|
| Q01 | `:get_thing` | `:thing` | `aadhardwareid` (non_null string), `customer` (non_null string) | `Resolvers.Things.find_thing/3` | 11 |
| Q02 | `:get_puls_record` | `:puls_record` | `hardwareid` (non_null string) | `Resolvers.Puls.puls_record/3` | 18 |
| Q03 | `:get_all_things` | `list_of(:thing)` | `customer` (non_null string) | `Resolvers.Things.get_all_things/3` | 24 |

**Mutations defined:** None.
**Subscriptions defined:** None.

---

### File: `lib/api_server_web/schema/thing_types.ex`

**Module:** `ApiServerWeb.Schema.ThingTypes`

**Types defined:**

| # | Object | Fields | Line |
|---|--------|--------|------|
| T01 | `:thing` | `aadcustcode`, `aaddesc`, `aadintext`, `aadaddr`, `aadcustomerid`, `aadcat`, `aadhardwareid`, `aadhw_type`, `aadmake`, `aadmodel`, `aadserialno`, `aadmobile`, `aadimei`, `aadhourmeter`, `aadhourmeter1`, `aadhourmeter2`, `aadhourmeter3`, `aadhourmeter4`, `aadodometer`, `aadhourmeteromega`, `aadhourmeterothcan`, `aaddateintoservice`, `aadlastservice`, `aadvalid`, `aadserviceoffset`, `aadsvchrs`, `aadrange_lat`, `aadrange_long`, `aadrange_dist`, `aadrange_unit`, `service_calculation_input` | 5–37 |
| T02 | `:puls_record` | `esn`, `iccid`, `group` | 41–45 |

---

## TEST COVERAGE SEARCH RESULTS

The entire `test/` tree contains exactly five test files:
- `test/api_server_web/controllers/calamp_controller_test.exs` — empty stub (module body contains only a commented-out `use` line, no test cases)
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — tests `VXRestriction` CRUD; uses routes not present in `router.ex` (generated path helpers for a resource that is not declared in the router)
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`
- `test/test_helper.exs`

Grep searches for `ApiServerWeb.Router`, `ApiServerWeb.Schema`, `ApiServerWeb.Schema.ThingTypes`, every controller module name, every GraphQL query name, and every route path prefix returned **zero matches** in any test file.

---

## FINDINGS

---

### B022-1 — No tests exist for `router.ex`
**Severity:** HIGH
**File:** `lib/api_server_web/router.ex`

There is no test file for `ApiServerWeb.Router` and no test file anywhere in the test suite exercises any of the 84 routes defined in the router. The `calamp_controller_test.exs` file is an empty stub. Zero routes have integration-level test coverage.

---

### B022-2 — No tests exist for `schema.ex`
**Severity:** HIGH
**File:** `lib/api_server_web/schema.ex`

`ApiServerWeb.Schema` has no test file and no indirect test coverage. None of the three GraphQL queries (`get_thing`, `get_puls_record`, `get_all_things`) are exercised by any test. Additionally, the GraphQL endpoint is commented out in `router.ex` (lines 195–202), making the schema dead code from the HTTP layer's perspective. No test validates that the schema compiles correctly or that resolvers return expected data shapes.

---

### B022-3 — No tests exist for `thing_types.ex`
**Severity:** HIGH
**File:** `lib/api_server_web/schema/thing_types.ex`

`ApiServerWeb.Schema.ThingTypes` has no test file and no indirect test coverage. Neither the `:thing` object nor the `:puls_record` object is referenced in any test. Because the GraphQL endpoint is also commented out (see B022-2), these type definitions are entirely untested dead code.

---

### B022-4 — All 84 routes individually untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`

Every individual route (R01–R84) lacks a test exercising its success path. This includes all CRUD operations for customers, users, fleets, rentals, geofences, and things; all export/report endpoints; the health-check endpoint; the DigitalMatter ingest endpoint; the ERP-import, driver-id-converter, and DISCorp sync endpoints; and all VX-prefixed endpoints.

---

### B022-5 — Authentication pipeline (`:authenticated`) never tested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 24–26, 33

The `ApiServer.Guardian.AuthPipeline` plug is applied to all routes in the first authenticated block (R03–R58). No test verifies that unauthenticated requests to those routes are rejected (e.g., return 401/403), nor that a valid JWT grants access. The authentication boundary is completely uncovered.

---

### B022-6 — Unauthenticated routes R01 and R02 bypass authentication silently and are untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 29–31

Routes R01 (`/rhm/engine_usage`) and R02 (`/rhm/monday_hour_meters`) are declared before `pipe_through([:api, :authenticated])` is called, meaning they are intentionally public. No test confirms they are reachable without a token, nor that their response content is correct.

---

### B022-7 — Duplicate route declaration
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 91–100

The route `GET /api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` → `VXThingOmegaController.:get_operation_summary_report` is declared twice (R24 and R25, lines 91–94 and 97–100). Phoenix will only match the first declaration; the second is dead. No test detects this or verifies the intended behaviour.

---

### B022-8 — `work_in_progress` route silently aliased to `sielift_export`
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 41–42

The commented-out original route (`VXThingController.:work_in_progress`) has been replaced with a route that calls `:sielift_export` instead. The comment retains the original intent. No test validates that this aliasing is correct or intentional, and there is no test for the endpoint at all.

---

### B022-9 — GraphQL endpoint commented out but schema and types remain active code
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 195–202; `lib/api_server_web/schema.ex`; `lib/api_server_web/schema/thing_types.ex`

The `/graphql` and `/graphiql` forwards are commented out, meaning the schema defined in `schema.ex` and `thing_types.ex` is never reachable at runtime. No test or static check guards against this divergence. If the GraphQL endpoint is intentionally disabled, the schema files should be removed or clearly marked; if the endpoint is intended to be re-enabled, the missing test coverage becomes a blocker.

---

### B022-10 — GraphQL queries missing argument validation and error-path tests
**Severity:** MEDIUM
**File:** `lib/api_server_web/schema.ex`, lines 11–27

All three queries (`get_thing`, `get_puls_record`, `get_all_things`) declare `non_null` arguments. No test verifies:
- behaviour when a required argument is omitted (Absinthe validation error)
- behaviour when the resolver returns `{:error, reason}`
- behaviour when the requested customer or hardwareid does not exist (not-found path)

---

### B022-11 — `:puls_record` type missing fields present in typical PULS data
**Severity:** LOW
**File:** `lib/api_server_web/schema/thing_types.ex`, lines 41–45

The `:puls_record` object exposes only three fields (`esn`, `iccid`, `group`). No test validates that these are the complete and correct fields returned by `Resolvers.Puls.puls_record/3`, nor that additional PULS fields are intentionally omitted.

---

### B022-12 — `[REDACTED-AWS-SMTP-PASSWORD]` resources route not tested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, line 162

`resources("/vx/thingsummaries", VXThingSummaryController, except: [:new, :edit])` generates five REST actions (index, show, create, update, delete). None of these actions has a test, despite being structurally similar to the `VXRestriction` resource for which a test scaffold exists (but is also unused by the router).

---

### B022-13 — File download endpoint untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 165–166

`GET /api/v1/files/getsize/:esn` and `GET /api/v1/files/getfile/:esn` are untested. The file-download endpoint in particular has high risk for path-traversal or missing-file error conditions that should be covered.

---

### B022-14 — Destructive routes (DELETE) entirely untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 106, 118, 136, 143, 153

All five `DELETE` routes (fleet, rental, user, customer, geofence) have no test coverage. No test verifies correct deletion, 404 on unknown IDs, authorization enforcement, or cascade behaviour.

---

### B022-15 — `calamp_controller_test.exs` is an empty stub
**Severity:** LOW
**File:** `test/api_server_web/controllers/calamp_controller_test.exs`

The test file exists but contains only a commented-out `use ApiServerWeb.ConnCase` and no test cases. `CalampController` (if it exists) has zero coverage. The stub gives a false impression of test presence.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B022-1 | HIGH | router.ex | No tests for the router module at all |
| B022-2 | HIGH | schema.ex | No tests for the GraphQL schema |
| B022-3 | HIGH | schema/thing_types.ex | No tests for GraphQL type definitions |
| B022-4 | MEDIUM | router.ex | All 84 routes individually untested |
| B022-5 | MEDIUM | router.ex | Authentication pipeline never tested |
| B022-6 | MEDIUM | router.ex | Intentionally public routes R01/R02 untested |
| B022-7 | MEDIUM | router.ex | Duplicate route declaration (operation_summary_report) |
| B022-8 | MEDIUM | router.ex | `work_in_progress` silently aliased to `sielift_export`, untested |
| B022-9 | MEDIUM | router.ex / schema.ex | GraphQL endpoint commented out, schema is dead but untested |
| B022-10 | MEDIUM | schema.ex | GraphQL query error paths and missing-arg paths untested |
| B022-11 | LOW | schema/thing_types.ex | `:puls_record` field completeness unverified |
| B022-12 | MEDIUM | router.ex | VXThingSummaryController resources route untested |
| B022-13 | MEDIUM | router.ex | File download endpoints untested |
| B022-14 | MEDIUM | router.ex | All DELETE routes untested |
| B022-15 | LOW | calamp_controller_test.exs | Test file is an empty stub |
