# Audit Report B005
**Audit run:** 2026-02-27-01
**Agent:** B005 (Pass 2)
**Scope:** Test coverage analysis for four source files in `lib/api_server/vx/`

---

## Source Files Audited

1. `lib/api_server/vx/device_database_lookup.ex`
2. `lib/api_server/vx/email.ex`
3. `lib/api_server/vx/equipment.ex`
4. `lib/api_server/vx/equipment_assignment.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/vx/device_database_lookup.ex`

**Module:** `ApiServer.Vx.DeviceDatabaseLookup`

**Behaviours/macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:** `"DeviceDatabaseLookup"` (line 6)
- Primary key: `{:ID, :id, autogenerate: true}` (line 5)

**Schema fields:**
| Field atom       | Type      | DB column      |
|-----------------|-----------|----------------|
| `:hardwareid`   | `:string` | `hardwareID`   |
| `:customer`     | `:string` | `databaseName` |
| `:custcode`     | `:string` | `CustCode`     |
| `:iccid`        | `:string` | `ICCID`        |

**Functions defined:**
| Name          | Arity | Line | Visibility |
|---------------|-------|------|------------|
| `changeset/2` | 2     | 13   | public     |

**`changeset/2` behaviour:**
- Casts all four fields: `:hardwareid`, `:customer`, `:custcode`, `:iccid`
- No `validate_required` or `unique_constraint` calls

---

### File 2: `lib/api_server/vx/email.ex`

**Module:** `ApiServer.Email`

**Behaviours/macros used:**
- `use Bamboo.Phoenix, view: ApiServer.EmailView` (line 2)

**Functions defined:**
| Name                          | Arity | Line | Visibility |
|-------------------------------|-------|------|------------|
| `send_notification_email/3`   | 3     | 4    | public     |
| `send_test_email/3`           | 3     | 14   | public     |
| `send_enter_email/4`          | 4     | 103  | public     |
| `send_missing_serial_email/4` | 4     | 167  | public     |
| `send_digital_matter_email/4` | 4     | 215  | public     |
| `send_slow_email/4`           | 4     | 262  | public     |
| `send_exit_email/4`           | 4     | 303  | public     |

**Key observations:**
- `send_notification_email/3` ignores the `to` parameter entirely — the recipient is hardcoded to `"graham.oconnell@trackingsolutions.com.au"` (line 7); the `to` argument is silently discarded.
- `send_test_email/3` also ignores the `to` parameter; recipient is hardcoded (line 16). The `message` parameter is unused (commented-out `text_body` call, line 18); the body is a static hardcoded HTML blob.
- `send_enter_email/4`, `send_exit_email/4`, `send_missing_serial_email/4`, `send_slow_email/4`, and `send_digital_matter_email/4` all use bare map field access on the `data` argument (e.g. `data.person_name`, `data.geofence_name`, etc.) with no nil-guard or pattern match, meaning any missing key causes a runtime `KeyError`.
- `send_digital_matter_email/4` uses `Kernel.inspect(data, limit: :infinity)` (line 227) to dump arbitrary data into HTML — intended as a debug helper.
- From address in `send_notification_email/3` is hardcoded to `"no-reply@mobilehourmeter.com"` regardless of caller intent.

---

### File 3: `lib/api_server/vx/equipment.ex`

**Module:** `ApiServer.Vx.Equipment`

**Behaviours/macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)
- `alias ApiServer.Vx` (line 5) — unused in this file

**Schema defined:** `"equipment"` (line 8)
- Primary key: `{:ID, :id, autogenerate: true}` (line 7)

**Schema fields:**
| Field atom       | Type            | DB column       |
|-----------------|-----------------|-----------------|
| `:id`            | `:integer`      | `id`            |
| `:name`          | `:string`       | `name`          |
| `:make`          | `:string`       | `make`          |
| `:model`         | `:string`       | `model`         |
| `:serial_number` | `:string`       | `serial_number` |
| `:class`         | `:string`       | `class`         |
| `:type`          | `:string`       | `type`          |
| `:created`       | `:utc_datetime` | `created`       |

**Functions defined:**
| Name          | Arity | Line | Visibility |
|---------------|-------|------|------------|
| `changeset/2` | 2     | 20   | public     |

**`changeset/2` behaviour:**
- Casts all eight fields
- `validate_required([:serial_number])` (line 23)
- `unique_constraint(:serial_number, name: :serial_number)` (line 24)

**Note:** `:id` is declared both as the primary key alias (`@primary_key {:ID, :id, ...}`) and as a regular schema field (line 9), which may cause a field collision at compile/runtime.

---

### File 4: `lib/api_server/vx/equipment_assignment.ex`

**Module:** `ApiServer.Vx.EquipmentAssignment`

**Behaviours/macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)
- `alias ApiServer.Vx` (line 5) — unused in this file

**Schema defined:** `"equipment_assignment"` (line 8)
- Primary key: `{:ID, :id, autogenerate: true}` (line 7)

**Schema fields:**
| Field atom                | Type            | DB column                  |
|--------------------------|-----------------|----------------------------|
| `:id`                    | `:integer`      | `id`                       |
| `:equipment_id`          | `:integer`      | `equipment_id`             |
| `:device_group`          | `:string`       | `device_group`             |
| `:device_group_timezone` | `:string`       | `device_group_timezone`    |
| `:assignment_start`      | `:utc_datetime` | `assignment_start`         |
| `:assignment_end`        | `:utc_datetime` | `assignment_end`           |
| `:created`               | `:utc_datetime` | `created`                  |

**Commented-out code:**
- `belongs_to :equipment, ApiServer.Vx.Equipment, ...` (line 17) — association commented out

**Functions defined:**
| Name          | Arity | Line | Visibility |
|---------------|-------|------|------------|
| `changeset/2` | 2     | 20   | public     |

**`changeset/2` behaviour:**
- Casts all seven fields
- `validate_required([:equipment_id, :device_group])` (line 23)
- `unique_constraint(:equipment_id)` (line 24)

---

## Test Coverage Search Results

Searches performed against `test/` for:
- Module names: `[REDACTED-AWS-SMTP-PASSWORD]`, `ApiServer.Email`, `ApiServer.Vx.Equipment`, `EquipmentAssignment`
- Function names: `send_notification_email`, `send_test_email`, `send_enter_email`, `send_exit_email`, `send_missing_serial_email`, `send_digital_matter_email`, `send_slow_email`
- Case-insensitive partial names: `device_database_lookup`, `equipment_assignment`, `equipment`

**Result: Zero matches in all searches.** None of the four source files are referenced anywhere in the test suite.

The existing test files (`calamp_controller_test.exs` is an empty stub; `vx_restriction_controller_test.exs` covers only `ApiServer.Vx.VXRestriction`; `layout_view_test.exs` and `page_view_test.exs` cover view modules) provide no coverage for any of the audited modules.

---

## Findings

---

### B005-1
**Severity:** HIGH
**File:** `lib/api_server/vx/device_database_lookup.ex`
**Finding:** No test file exists for `ApiServer.Vx.DeviceDatabaseLookup`. The module has no direct or indirect test coverage whatsoever.
**Detail:** The `changeset/2` function casts four fields but applies no `validate_required` or `unique_constraint` validations. No test verifies the changeset accepts valid attrs, produces an `%Ecto.Changeset{}`, or that cast works correctly against the non-standard column name mappings (`hardwareID`, `databaseName`, `CustCode`, `ICCID`).

---

### B005-2
**Severity:** HIGH
**File:** `lib/api_server/vx/email.ex`
**Finding:** No test file exists for `ApiServer.Email`. None of its seven public functions are exercised by any test in the repository.
**Detail:** This module is responsible for all outbound email construction. The complete absence of tests means no verification that email structs are built correctly, that recipients/subjects/bodies are set as expected, or that missing `data` map keys are handled safely.

---

### B005-3
**Severity:** HIGH
**File:** `lib/api_server/vx/equipment.ex`
**Finding:** No test file exists for `ApiServer.Vx.Equipment`. The module has no direct or indirect test coverage.
**Detail:** `changeset/2` applies `validate_required([:serial_number])` and `unique_constraint(:serial_number, ...)`. Neither the happy path (valid attrs), the required-field validation path (missing `:serial_number`), nor the unique-constraint path is tested.

---

### B005-4
**Severity:** HIGH
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Finding:** No test file exists for `ApiServer.Vx.EquipmentAssignment`. The module has no direct or indirect test coverage.
**Detail:** `changeset/2` applies `validate_required([:equipment_id, :device_group])` and `unique_constraint(:equipment_id)`. No test covers valid attrs, missing required fields, or the unique constraint behaviour.

---

### B005-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/email.ex`
**Function:** `send_notification_email/3` (line 4)
**Finding:** The `to` parameter is silently ignored. The recipient is hardcoded to `"graham.oconnell@trackingsolutions.com.au"` regardless of what the caller passes. No test exists to catch this regression, and the broken contract (caller-supplied `to` is never used) is invisible without test coverage.

---

### B005-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/email.ex`
**Function:** `send_test_email/3` (line 14)
**Finding:** Both the `to` parameter and the `message` parameter are silently discarded. The `to` recipient is hardcoded; the `message` argument is commented out and the body is a static HTML blob. No test verifies the function signature contract or that callers' arguments are (or are not) used.

---

### B005-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/email.ex`
**Functions:** `send_enter_email/4` (line 103), `send_exit_email/4` (line 303), `send_missing_serial_email/4` (line 167), `send_slow_email/4` (line 262)
**Finding:** All four functions access `data` map fields using bare dot-access (e.g. `data.person_name`, `data.geofence_name`, `data.vehicle_name`, `data.vehicle_serial`, `data.time_left`, `data.time_returned`, `data.time_out`, `data.usage_out`, `data.event_reference`, `data.customer`, `data.hardware_id`, `data.diff`). If any expected key is absent from `data`, the call raises a `KeyError` at runtime. No test covers this error path, and no guards or pattern matches validate the `data` map shape before use.

---

### B005-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/equipment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** The `validate_required([:serial_number])` path is untested. No test confirms that a changeset built without `:serial_number` returns `{:error, changeset}` with the expected error on `:serial_number`.

---

### B005-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** The `validate_required([:equipment_id, :device_group])` path is untested. No test confirms that omitting `:equipment_id` or `:device_group` produces a changeset with the appropriate validation errors.

---

### B005-10
**Severity:** MEDIUM
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** The `unique_constraint(:equipment_id)` is untested. The constraint relies on a database-level unique index, but no integration test inserts a duplicate `equipment_id` and verifies the changeset returns the expected constraint error.

---

### B005-11
**Severity:** MEDIUM
**File:** `lib/api_server/vx/equipment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** The `unique_constraint(:serial_number, name: :serial_number)` is untested. No test verifies that inserting a duplicate `serial_number` is translated into a changeset error rather than propagating a raw database exception.

---

### B005-12
**Severity:** LOW
**File:** `lib/api_server/vx/device_database_lookup.ex`
**Function:** `changeset/2` (line 13)
**Finding:** No edge-case tests for nil or empty string values for any of the four fields. The changeset applies no `validate_required`, so nil values are accepted silently. There is no test confirming this is intentional behaviour.

---

### B005-13
**Severity:** LOW
**File:** `lib/api_server/vx/equipment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** No test covers passing an empty string `""` for `:serial_number`. Ecto's `validate_required` passes for empty strings by default (only nil is rejected); there is no `validate_length` or `validate_format` guard. The empty-string case is untested and likely unintended.

---

### B005-14
**Severity:** LOW
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** No test covers the boundary case of `:assignment_end` being earlier than or equal to `:assignment_start`. The changeset does not validate temporal ordering, and this logic gap is undetected without tests.

---

### B005-15
**Severity:** LOW
**File:** `lib/api_server/vx/email.ex`
**Function:** `send_enter_email/4` (line 103), `send_exit_email/4` (line 303)
**Finding:** No test covers the case where string fields in `data` are `nil`. Because the function builds the HTML body via string concatenation (`<> data.field <>`), a nil value will raise a `Protocol.UndefinedError` for `String.Chars` at runtime. The nil path is entirely untested.

---

### B005-16
**Severity:** INFO
**File:** `lib/api_server/vx/equipment.ex`
**Finding:** `alias ApiServer.Vx` is declared at line 5 but never used within the module. This is dead code. No test exercises any cross-module interaction.

---

### B005-17
**Severity:** INFO
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Finding:** `alias ApiServer.Vx` is declared at line 5 but never used within the module. The `belongs_to` association to `ApiServer.Vx.Equipment` is commented out (line 17). Both represent dead or deferred code with no test coverage to document intended behaviour.

---

### B005-18
**Severity:** INFO
**File:** `lib/api_server/vx/email.ex`
**Function:** `send_digital_matter_email/4` (line 215)
**Finding:** This function appears to be a debug/diagnostic utility (it renders the entire raw `data` term via `Kernel.inspect` in the email body). No test exists to confirm it is not called in production paths, and no test verifies its output structure or that `Kernel.inspect(data, limit: :infinity)` on large/deeply nested data does not cause excessive memory use.

---

## Summary Table

| ID      | Severity | File                         | Subject                                                        |
|---------|----------|------------------------------|----------------------------------------------------------------|
| B005-1  | HIGH     | device_database_lookup.ex    | No test file — zero coverage for module                        |
| B005-2  | HIGH     | email.ex                     | No test file — zero coverage for module (7 public functions)   |
| B005-3  | HIGH     | equipment.ex                 | No test file — zero coverage for module                        |
| B005-4  | HIGH     | equipment_assignment.ex      | No test file — zero coverage for module                        |
| B005-5  | MEDIUM   | email.ex                     | `send_notification_email/3` silently discards `to` parameter   |
| B005-6  | MEDIUM   | email.ex                     | `send_test_email/3` discards both `to` and `message` params    |
| B005-7  | MEDIUM   | email.ex                     | Bare map dot-access on `data` raises `KeyError` if key missing |
| B005-8  | MEDIUM   | equipment.ex                 | `validate_required(:serial_number)` error path untested        |
| B005-9  | MEDIUM   | equipment_assignment.ex      | `validate_required` error paths untested                       |
| B005-10 | MEDIUM   | equipment_assignment.ex      | `unique_constraint(:equipment_id)` untested                    |
| B005-11 | MEDIUM   | equipment.ex                 | `unique_constraint(:serial_number)` untested                   |
| B005-12 | LOW      | device_database_lookup.ex    | Nil/empty edge cases not tested, no required validation        |
| B005-13 | LOW      | equipment.ex                 | Empty string for `:serial_number` passes `validate_required`   |
| B005-14 | LOW      | equipment_assignment.ex      | No temporal ordering validation for assignment dates           |
| B005-15 | LOW      | email.ex                     | Nil string values in `data` cause `Protocol.UndefinedError`    |
| B005-16 | INFO     | equipment.ex                 | Unused `alias ApiServer.Vx`                                    |
| B005-17 | INFO     | equipment_assignment.ex      | Unused alias; commented-out `belongs_to` association           |
| B005-18 | INFO     | email.ex                     | `send_digital_matter_email/4` appears to be a debug utility    |
