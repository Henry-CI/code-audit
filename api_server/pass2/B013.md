# Audit Report B013
**Audit Run:** 2026-02-27-01
**Agent:** Pass 2 / B013
**Scope:** Coverage gaps for three web-layer source files

---

## Source Files Audited

1. `lib/api_server_web.ex`
2. `lib/api_server_web/auth_error_handler.ex`
3. `lib/api_server_web/auth_pipeline.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server_web.ex`

**Module:** `ApiServerWeb`

**Functions/Macros defined:**

| Line | Name | Kind |
|------|------|------|
| 20 | `controller/0` | public def |
| 29 | `view/0` | public def |
| 46 | `router/0` | public def |
| 54 | `channel/0` | public def |
| 64 | `__using__/1` | public defmacro |

**Types / Constants / Structs:** None defined directly; each function returns a `quote` block that injects standard Phoenix/Plug imports into the calling module.

**Notes:**
- `controller/0` injects: `use Phoenix.Controller`, `import Plug.Conn`, `import ApiServerWeb.Router.Helpers`, `import ApiServerWeb.Gettext`.
- `view/0` injects: `use Phoenix.View`, `import Phoenix.Controller` (get_flash/view_module), `use Phoenix.HTML`, `import ApiServerWeb.Router.Helpers`, `import ApiServerWeb.ErrorHelpers`, `import ApiServerWeb.Gettext`.
- `router/0` injects: `use Phoenix.Router`, `import Plug.Conn`, `import Phoenix.Controller`.
- `channel/0` injects: `use Phoenix.Channel`, `import ApiServerWeb.Gettext`.
- `__using__/1` dispatches to `apply(__MODULE__, which, [])` — calls one of the four functions above based on the atom argument.
- `channel/0` has no callers anywhere in the codebase (no `use ApiServerWeb, :channel` found).

---

### File 2: `lib/api_server_web/auth_error_handler.ex`

**Module:** `ApiServerWeb.AuthErrorHandler`

**Functions defined:**

| Line | Name | Kind |
|------|------|------|
| 4 | `auth_error/3` | public def |

**Signature:** `auth_error(conn, {type, _reason}, _opts)`

**Behaviour:** Encodes `%{error: to_string(type)}` via `Poison.encode!`, then calls `send_resp(conn, 401, body)`.

**Types / Constants / Structs:** None.

**Notes:**
- `_reason` is discarded; the error reason is never surfaced to the caller.
- Uses `Poison` (not Jason) — inconsistent with the rest of the Phoenix 1.4+ ecosystem which defaults to Jason.

---

### File 3: `lib/api_server_web/auth_pipeline.ex`

**Module:** `ApiServer.Guardian.AuthPipeline`

**Plugs defined (via `use Guardian.Plug.Pipeline`):**

| Line | Name | Notes |
|------|------|-------|
| 6 | `Guardian.Plug.VerifyHeader` | `realm: "Bearer"` — validates Bearer token in Authorization header |
| 7 | `Guardian.Plug.EnsureAuthenticated` | **commented out** — authentication is NOT enforced |
| 8 | `Guardian.Plug.LoadResource` | loads the resource associated with the verified token |

**Configuration:**
- `otp_app: :MyApi` — atom literal `:MyApi` (capitalised) used instead of `:api_server`.
- `module: ApiServer.Guardian`
- `error_handler: ApiServerWeb.AuthErrorHandler`

**Types / Constants / Structs:** None.

**Notes:**
- The pipeline is registered in `router.ex` line 25 as the `:authenticated` pipeline and applied to the majority of `/api/v1` routes via `pipe_through([:api, :authenticated])`.
- Because `EnsureAuthenticated` is commented out, all routes in the `:authenticated` pipeline accept unauthenticated requests without rejection.

---

## Test Coverage Search Results

### Direct test files

| Source file | Direct test file | Exists? |
|-------------|-----------------|---------|
| `lib/api_server_web.ex` | `test/api_server_web_test.exs` | No |
| `lib/api_server_web/auth_error_handler.ex` | `test/api_server_web/auth_error_handler_test.exs` | No |
| `lib/api_server_web/auth_pipeline.ex` | `test/api_server_web/auth_pipeline_test.exs` | No |

### Indirect coverage search

Grep for `AuthErrorHandler`, `auth_error` in `test/` — **no matches**.
Grep for `AuthPipeline`, `Guardian.Plug`, `auth_pipeline` in `test/` — **no matches**.
Grep for `authorization`, `Bearer`, `token`, `401`, `authenticated` in `test/` — **no matches**.

The four known test files were read in full:

- `test/api_server_web/controllers/calamp_controller_test.exs` — empty stub; `use ApiServerWeb.ConnCase` is commented out. No tests.
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — exercises CRUD on `VXRestriction`. All requests are made without an Authorization header; no auth behaviour is tested.
- `test/api_server_web/views/layout_view_test.exs` — empty body; only `use ApiServerWeb.ConnCase`.
- `test/api_server_web/views/page_view_test.exs` — empty body; only `use ApiServerWeb.ConnCase`.

**Conclusion:** There is zero direct or indirect test coverage for all three assigned source files.

---

## Findings

---

### B013-1
**Severity:** HIGH
**File:** `lib/api_server_web/auth_error_handler.ex`
**Finding:** No test file exists and no indirect test coverage found for `ApiServerWeb.AuthErrorHandler`. The sole public function `auth_error/3` — which returns the 401 error response for all JWT authentication failures — is completely untested. Any regression in this handler (wrong status code, malformed JSON body, Poison serialisation failure) would be invisible before deployment.

---

### B013-2
**Severity:** HIGH
**File:** `lib/api_server_web/auth_pipeline.ex`
**Finding:** No test file exists and no indirect test coverage found for `ApiServer.Guardian.AuthPipeline`. The pipeline is plugged into the `:authenticated` pipeline used by the majority of API routes, yet no test sends a request with a valid token, an invalid token, or no token to any of those routes. The interaction between `VerifyHeader`, `LoadResource`, and `AuthErrorHandler` is entirely untested.

---

### B013-3
**Severity:** HIGH
**File:** `lib/api_server_web.ex`
**Finding:** No test file exists for `ApiServerWeb`. While the `controller/0`, `view/0`, and `router/0` macros are exercised transitively at compile time by other modules, that compilation behaviour is not covered by any explicit unit or integration test. The `channel/0` function has no callers at all (no `use ApiServerWeb, :channel` found in the codebase) and is therefore dead code with zero test coverage.

---

### B013-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/auth_pipeline.ex`
**Finding:** `Guardian.Plug.EnsureAuthenticated` is commented out (line 7). This means that even if a request reaches the `:authenticated` pipeline with no token or an expired token, `VerifyHeader` will silently fail to set a subject and `LoadResource` will likely load `nil`, but the request will still proceed to the controller. There is no test asserting that an unauthenticated request to a protected route receives a 401 response. The combination of commented-out enforcement and zero test coverage means the security boundary is unverifiable.

---

### B013-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/auth_pipeline.ex`
**Finding:** `otp_app` is set to `:MyApi` (line 2) instead of `:api_server`, which is the atom used by every other module in the application (`Guardian`, `Endpoint`, `Repo`, `Mailer`, `Scheduler`, `Gettext`). Guardian reads its secret key and other configuration from the OTP application environment under this atom. If the `:MyApi` application environment key is not explicitly configured in `config/config.exs` (or equivalent), Guardian will silently fall back to defaults or raise at runtime. No test exists that would catch a misconfiguration of this atom.

---

### B013-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/auth_error_handler.ex`
**Finding:** The `_reason` parameter of `auth_error/3` is ignored (line 4). Guardian passes structured reason atoms such as `:token_expired`, `:invalid_token`, `:unauthenticated`, etc. Discarding this information means the API client receives a generic `{"error": "unauthenticated"}` (or similar) for all failure modes, making it impossible to distinguish a missing token from an expired one. There is no test covering any of the distinct failure-type inputs.

---

### B013-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/auth_error_handler.ex`
**Finding:** `auth_error/3` uses `Poison.encode!/1` (line 5). The rest of the application uses Jason as the JSON encoder (the default for Phoenix 1.4+). There is no test verifying the serialised response body format, meaning a dependency change or encoder mismatch could produce malformed or unexpected output silently.

---

### B013-8
**Severity:** LOW
**File:** `lib/api_server_web/auth_error_handler.ex`
**Finding:** No edge-case tests exist for `auth_error/3` with unusual `type` values. The function calls `to_string(type)` on the first element of the second argument tuple. If `type` is not a simple atom (e.g., it is a nested tuple, a struct, or a large binary), `to_string/1` behaviour may be unexpected. No boundary tests exist for these inputs.

---

### B013-9
**Severity:** LOW
**File:** `lib/api_server_web.ex`
**Finding:** The `__using__/1` macro (line 64) calls `apply(__MODULE__, which, [])` where `which` must be an atom matching one of the four defined functions. If called with an unrecognised atom (e.g., `use ApiServerWeb, :socket`), `apply/3` will raise `[REDACTED-AWS-SMTP-PASSWORD]` at compile time with no user-friendly error message. There is no guard clause, fallback clause, or test for an invalid `which` argument.

---

### B013-10
**Severity:** INFO
**File:** `lib/api_server_web.ex`
**Finding:** `channel/0` (line 54) is defined but has no callers in the codebase. No channel modules use `use ApiServerWeb, :channel`. This function appears to be dead code left over from the Phoenix project generator scaffold. No tests exist for it, and its removal would have no functional impact.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B013-1 | HIGH | `auth_error_handler.ex` | No test coverage whatsoever for `auth_error/3` |
| B013-2 | HIGH | `auth_pipeline.ex` | No test coverage for the Guardian auth pipeline |
| B013-3 | HIGH | `api_server_web.ex` | No test file; `channel/0` is dead code with no coverage |
| B013-4 | MEDIUM | `auth_pipeline.ex` | `EnsureAuthenticated` commented out; no test asserts 401 on unauthenticated requests |
| B013-5 | MEDIUM | `auth_pipeline.ex` | `otp_app: :MyApi` mismatches application atom `:api_server`; no test catches misconfiguration |
| B013-6 | MEDIUM | `auth_error_handler.ex` | `_reason` discarded; distinct failure types produce identical responses; no tests |
| B013-7 | MEDIUM | `auth_error_handler.ex` | Uses `Poison` instead of `Jason`; inconsistency untested |
| B013-8 | LOW | `auth_error_handler.ex` | No edge-case tests for unusual `type` values in `auth_error/3` |
| B013-9 | LOW | `api_server_web.ex` | `__using__/1` raises uninformatively on unknown atom; no tests for invalid input |
| B013-10 | INFO | `api_server_web.ex` | `channel/0` is dead code; never called anywhere in codebase |
