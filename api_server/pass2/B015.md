# Audit Report B015
**Audit Run:** 2026-02-27-01
**Agent:** Pass 2 / B015
**Scope:** Controller test coverage analysis
**Files Audited:**
- `lib/api_server_web/controllers/calamp_controller.ex`
- `lib/api_server_web/controllers/digital_matter_controller.ex`
- `lib/api_server_web/controllers/fallback_controller.ex`
- `lib/api_server_web/controllers/file_controller.ex`

---

## READING EVIDENCE

### 1. `ApiServerWeb.CalampController`
**File:** `lib/api_server_web/controllers/calamp_controller.ex`

**Functions defined:**

| Line | Visibility | Name | Signature |
|------|-----------|------|-----------|
| 4 | public | `recieve_calamp_data/2` | `(conn, %{xml: calamp_data})` |
| 31 | private | `validate/3` | `(new_event, current_event, thing)` |

**Types / structs / constants:** None defined in this module.

**Notes:**
- `recieve_calamp_data` contains a typo in the name ("recieve" instead of "receive").
- The action hardcodes `customer = "vx_dev"`.
- Steps 2 (save record), 3 (update SummaryRecord), and 4 (update ThingInfo) are commented out — only step 1 (generate ThingEvent) and the final `send_resp` are executed.
- `validate/3` performs three `DateTime.diff` and one arithmetic comparison but returns no value and has no side effects — its result is discarded by the caller.
- `IO.inspect` and multiple `IO.puts` calls are left in production code paths.

---

### 2. `ApiServerWeb.DigitalMatterController`
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`

**Functions defined:**

| Line | Visibility | Name | Signature |
|------|-----------|------|-----------|
| 4 | public | `get_g62_data/2` | `(conn, params)` |

**Types / structs / constants:** None defined in this module.

**Notes:**
- Routed at `POST /` (root scope, `api_xml` pipeline) — see `router.ex` line 188.
- Iterates over `params["Records"]` with `Enum.each/2`, processing each record individually.
- `reason` is pattern-matched for values 1, 2, 3, 11, 16, 17; all other values fall through to `{255, reason}`.
- `date_formatted` falls back to raw `record["DateUTC"]` string or `"invalid"` on parse error.
- `driver_id["DriverID"]` access at line 172–176 will raise `FunctionClauseError` / `[REDACTED-AWS-SMTP-PASSWORD]` if `driver_id` is `nil` (i.e., no FType 3 field found in the record).
- `trip_hours["Dur"]` at line 139 will raise if `trip_hours` is `nil` (no FType 26 field).
- `run_hours["RH"]` at line 197 will raise if `run_hours` is `nil` despite the `nil` guard only protecting `run_hours["Odo"]` at lines 142–148.
- Customer is hardcoded to `"CEA"` (line 200) and `"vx_dev"` (line 200).
- Email sending is commented out (lines 17–18 and lines 229–238).
- The function does not return a unified response: the `Enum.each` side-effects attempt to send responses per-record but `conn` is not threaded through; after the `Enum.each` the function returns `:ok` (the return of `Enum.each`) which leaves the connection hanging if the `get_vx_thing_with_hardware_id!` path is hit on every iteration without a final explicit response outside the loop.

---

### 3. `ApiServerWeb.FallbackController`
**File:** `lib/api_server_web/controllers/fallback_controller.ex`

**Functions defined:**

| Line | Visibility | Name | Signature |
|------|-----------|------|-----------|
| 9 | public | `call/2` | `(conn, {:error, %Ecto.Changeset{} = changeset})` — renders 422 |
| 15 | public | `call/2` | `(conn, {:error, :not_found})` — renders 404 |

**Types / structs / constants:** None defined in this module.

**Notes:**
- Module is a Phoenix action-fallback controller; `call/2` is invoked by Phoenix when a controller action returns an `{:error, ...}` tuple and the controller declares `action_fallback ApiServerWeb.FallbackController`.
- Only `ApiServerWeb.FileController` in the audited set uses `action_fallback` pointing to this module.
- No clause handles `{:error, :unauthorized}`, `{:error, :forbidden}`, or any other error atom.

---

### 4. `ApiServerWeb.FileController`
**File:** `lib/api_server_web/controllers/file_controller.ex`

**Functions defined:**

| Line | Visibility | Name | Signature |
|------|-----------|------|-----------|
| 12 | public | `get_size/2` | `(conn, %{"esn" => hardwareid})` |
| 28 | public | `send_file_download/2` | `(conn, %{"esn" => hardwareid})` |
| 42 | private | `generate_binary_file_contents/1` | `(operator_string)` |
| 52 | private | `check_crc/1` | `(crc_string)` |

**Types / structs / constants:** None defined in this module.

**Notes:**
- Routed at `GET /api/v1/files/getsize/:esn` and `GET /api/v1/files/getfile/:esn` — both under the unauthenticated `api` pipeline (router.ex lines 165–166).
- `check_crc/1` handles only CRC hex strings of length 1–4; a length outside that range raises `CaseClauseError`.
- `IO.puts` calls are left in production paths (lines 16, 45, 46).
- `action_fallback ApiServerWeb.FallbackController` is declared; however, neither public action returns `{:error, ...}` tuples — they call `Vx.get_vx_thing_with_hardware_id!` (bang function, raises on not found) and `send_download`/`render`, so the fallback is effectively unreachable for these actions.

---

## TEST COVERAGE ANALYSIS

### Direct test file: `test/api_server_web/controllers/calamp_controller_test.exs`

The file contains:
```elixir
defmodule ApiServerWeb.CalampControllerTest do
    # use ApiServerWeb.ConnCase

end
```

The `use ApiServerWeb.ConnCase` line is commented out. There are **zero test cases** defined. The file is a stub with no executable content.

### Indirect coverage (grep of entire `test/` tree)

| Search term | Matches |
|-------------|---------|
| `[REDACTED-AWS-SMTP-PASSWORD]` | 0 |
| `digital_matter` | 0 |
| `get_g62_data` | 0 |
| `FallbackController` | 0 |
| `fallback_controller` | 0 |
| `action_fallback` | 0 |
| `FileController` | 0 |
| `file_controller` | 0 |
| `get_size` | 0 |
| `send_file_download` | 0 |
| `generate_binary` | 0 |
| `check_crc` | 0 |

**All four source files have zero test coverage** — direct or indirect.

---

## FINDINGS

---

### B015-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Finding:** The test file `test/api_server_web/controllers/calamp_controller_test.exs` exists but is entirely empty (the `use ApiServerWeb.ConnCase` macro is commented out and no test cases are defined). The sole public action `recieve_calamp_data/2` has zero test coverage.

**Evidence:**
```elixir
defmodule ApiServerWeb.CalampControllerTest do
    # use ApiServerWeb.ConnCase
end
```
No `test` blocks anywhere in the file. No indirect coverage found in the rest of the test suite.

---

### B015-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.DigitalMatterController` and no indirect coverage was found anywhere in the test suite. The single public action `get_g62_data/2` — which is the root POST handler for the entire application and processes incoming device telemetry — is completely untested.

---

### B015-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/fallback_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.FallbackController` and no indirect coverage was found. Both `call/2` clauses (422 Changeset error, 404 not-found) are untested.

---

### B015-4
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.FileController` and no indirect coverage was found. Both public actions `get_size/2` and `send_file_download/2` are completely untested.

---

### B015-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Function:** `recieve_calamp_data/2` (line 4)
**Finding:** The success path (`send_resp(conn, :ok, "{}")`) is untested. There is no test verifying that a well-formed XML payload results in a 200 response.

---

### B015-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Function:** `recieve_calamp_data/2` (line 4)
**Finding:** The private `validate/3` function (line 31) is called but its return value is discarded. No test exists to verify correct behaviour when `current_event` is `nil` (i.e., `ApiServer.Vx.get_most_recent_thingevent/2` returns `nil`). `DateTime.diff(new_event.gmtdatetime, nil.gmtdatetime)` would raise at runtime.

---

### B015-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** The not-found path (`ApiServer.Vx.get_vx_thing_with_hardware_id!` returning `nil`, line 202) is untested. There is no test verifying that the function responds with HTTP 400 and the expected JSON body when the hardware ID is unknown.

---

### B015-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** The Ecto error path (line 217: `{:error, error}`) when `ApiServer.Vx.create_thingevent_record/2` fails is untested. There is no test verifying the HTTP 400 response and the error message body returned in that case.

---

### B015-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** The date-parse error path (line 113: `{:error, error}`) when `Timex.parse/2` fails is untested. No test verifies the fallback to the raw `record["DateUTC"]` string or the `"invalid"` sentinel value.

---

### B015-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/fallback_controller.ex`
**Function:** `call/2` — Changeset clause (line 9)
**Finding:** The 422 Unprocessable Entity response path for Ecto Changeset errors is untested. No test verifies that the changeset error JSON is rendered correctly.

---

### B015-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/fallback_controller.ex`
**Function:** `call/2` — not-found clause (line 15)
**Finding:** The 404 Not Found response path is untested. No test verifies the correct HTTP status and error view rendering.

---

### B015-12
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Function:** `get_size/2` (line 12)
**Finding:** The success path for `get_size/2` is untested. No test verifies the JSON response containing `size`, `hardwareid`, and `num_fobs` fields.

---

### B015-13
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Function:** `send_file_download/2` (line 28)
**Finding:** The success path for `send_file_download/2` is untested. No test verifies the binary file download response, including the dynamically generated filename (`SM-<unix_ts>-<hardwareid>.bin`) and the CRC-appended binary content.

---

### B015-14
**Severity:** LOW
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Function:** `recieve_calamp_data/2` (line 4)
**Finding:** No edge-case tests exist for malformed or missing XML payload fields (e.g., missing `document_root`, `nil` `hardwareid`, missing datetime fields). Pattern-match on `%{xml: calamp_data}` will cause a `FunctionClauseError` if the key is absent.

---

### B015-15
**Severity:** LOW
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** No test covers the case where `params["Records"]` is `nil` or an empty list. An empty list causes no records to be processed and no response to be sent, leaving the connection open. A `nil` value causes `Enum.each/2` to raise `Protocol.UndefinedError`.

---

### B015-16
**Severity:** LOW
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** No test covers records where `driver_id` (FType 3) is `nil`. At line 172, `driver_id["DriverID"]` will raise `[REDACTED-AWS-SMTP-PASSWORD]` (map access on `nil`) when no FType 3 field is present in a record. Similarly, `trip_hours["Dur"]` at line 139 raises when FType 26 is absent, and `run_hours["RH"]` at line 197 raises when FType 27 is absent despite the surrounding nil guard only covering `run_hours["Odo"]`.

---

### B015-17
**Severity:** LOW
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** No test covers unmapped `reason` values (the `_` catch-all producing `{255, reason}`). The behaviour of downstream processing for a `{255, reason}` event code is untested.

---

### B015-18
**Severity:** LOW
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Function:** `check_crc/1` (line 52)
**Finding:** `check_crc/1` handles only hex CRC strings of length 1, 2, 3, or 4. A CRC value that produces a hex string longer than 4 characters (theoretically impossible for CRC-16 but worth guarding) or of length 0 will raise `CaseClauseError`. No test covers any of these boundary cases.

---

### B015-19
**Severity:** LOW
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Function:** `get_size/2` and `send_file_download/2` (lines 12, 28)
**Finding:** Both actions use the bang variant `Vx.get_vx_thing_with_hardware_id!/1` (no customer argument — different arity from the version in other controllers). If the hardware ID does not exist this raises an exception rather than returning an error tuple, bypassing the declared `action_fallback`. No test covers the not-found scenario.

---

### B015-20
**Severity:** INFO
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Finding:** The function name `recieve_calamp_data` is a misspelling of "receive". While not a test coverage gap, it is a code quality issue that would affect any route helper or test that references the action by name.

---

### B015-21
**Severity:** INFO
**File:** `lib/api_server_web/controllers/calamp_controller.ex`, `lib/api_server_web/controllers/digital_matter_controller.ex`, `lib/api_server_web/controllers/file_controller.ex`
**Finding:** Multiple `IO.inspect` and `IO.puts` calls are present in production code paths across three of the four audited controllers. These are not test-related issues but indicate debug instrumentation that was never removed, and they cannot be verified as intentional by any test.

---

### B015-22
**Severity:** INFO
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Finding:** The CalAmp controller route is not visible in `router.ex` — no route maps to `CalampController`. The controller exists and has a public action but is apparently not reachable via any HTTP route. This means even an integration test framework would not be able to exercise it through the router without directly invoking the controller function.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B015-1 | HIGH | calamp_controller.ex | Test file exists but is empty (ConnCase commented out, no test cases) |
| B015-2 | HIGH | digital_matter_controller.ex | No test file, no indirect coverage; root POST handler fully untested |
| B015-3 | HIGH | fallback_controller.ex | No test file, no indirect coverage; both call/2 clauses untested |
| B015-4 | HIGH | file_controller.ex | No test file, no indirect coverage; both public actions untested |
| B015-5 | MEDIUM | calamp_controller.ex | `recieve_calamp_data/2` success path (200 response) untested |
| B015-6 | MEDIUM | calamp_controller.ex | `validate/3` called with potentially nil `current_event`; nil crash path untested |
| B015-7 | MEDIUM | digital_matter_controller.ex | `get_g62_data/2` not-found 400 path untested |
| B015-8 | MEDIUM | digital_matter_controller.ex | `get_g62_data/2` Ecto create error path untested |
| B015-9 | MEDIUM | digital_matter_controller.ex | `get_g62_data/2` Timex parse error/fallback path untested |
| B015-10 | MEDIUM | fallback_controller.ex | `call/2` Changeset 422 response untested |
| B015-11 | MEDIUM | fallback_controller.ex | `call/2` :not_found 404 response untested |
| B015-12 | MEDIUM | file_controller.ex | `get_size/2` success path untested |
| B015-13 | MEDIUM | file_controller.ex | `send_file_download/2` success path untested |
| B015-14 | LOW | calamp_controller.ex | No edge-case tests for malformed/missing XML fields |
| B015-15 | LOW | digital_matter_controller.ex | No test for nil or empty `Records` list |
| B015-16 | LOW | digital_matter_controller.ex | No test for records missing FType 3/26/27 fields (nil access crash) |
| B015-17 | LOW | digital_matter_controller.ex | No test for unmapped `reason` values in catch-all clause |
| B015-18 | LOW | file_controller.ex | `check_crc/1` boundary cases for length 0 or > 4 untested |
| B015-19 | LOW | file_controller.ex | Bang function not-found crash path bypasses fallback; untested |
| B015-20 | INFO | calamp_controller.ex | Misspelled function name `recieve_calamp_data` |
| B015-21 | INFO | calamp, digital_matter, file controllers | `IO.inspect`/`IO.puts` left in production code paths |
| B015-22 | INFO | calamp_controller.ex | No router entry found for CalampController; action unreachable via HTTP |
