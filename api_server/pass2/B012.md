# Audit Report B012
**Audit run:** 2026-02-27-01
**Agent:** Pass 2 / B012
**Scope:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`, `lib/api_server/vx/vx_thing_info.ex`, `lib/api_server/vx/vx_thing_summary.ex`, `lib/api_server/vx/vx_user.ex`

---

## READING EVIDENCE

### 1. `ApiServer.Vx.VXThingEventOmegaTires`
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`

**Behaviours / use macros:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema (`"thingomegatires"`, lines 5–56):**
- Primary key: implicitly `id` (default Ecto integer PK; also used as the belongs_to FK)
- Fields (all `:integer`): `pressurewarning0`–`pressurewarning5`, `pressureleakage0`–`pressureleakage5`, `temperaturehigh0`–`temperaturehigh5`, `receivetimeout0`–`receivetimeout5`, `[REDACTED-AWS-SMTP-PASSWORD]`–`[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`–`[REDACTED-AWS-SMTP-PASSWORD]`, `tirepressure0`–`tirepressure5`, `temperature0`–`temperature5` (48 fields total, 8 per tire × 6 tires)
- Association: `belongs_to :thingevent, ApiServer.Vx.VXThingEvent` (FK `:id` → references `:id`, `define_field: false`, `primary_key: true`)

**Public functions:**
| Line | Name | Arity |
|------|------|-------|
| 58 | `changeset/2` | `(vx_thing_event_omega_tires, attrs)` |

**changeset/2 details:**
- Casts all 49 fields (`:id` + 48 tire data fields)
- `validate_required([:id])`

---

### 2. `ApiServer.Vx.VXThingInfo`
**File:** `lib/api_server/vx/vx_thing_info.ex`

**Behaviours / use macros:**
- `use Ecto.Schema` (line 4)
- `import Ecto.Changeset` (line 5)
- `require Ecto.Query`, `require Ecto.Adapters.SQL` (lines 6–7)

**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXThing`, `ApiServer.Vx.VXThingInfo`, `ApiServer.Repo`

**Schema (`"thing_info"`, lines 15–22):**
- Primary key: `{:id, :id, autogenerate: true}` (line 14)
- Fields: `averageweeklyusage` (`:float`), `pmnotificationid` (`:integer`), `pmnotificationdate` (`:date`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`)
- Association: `belongs_to :thing, VXThing` (FK `:hardwareid` → references `:aadhardwareid`)

**Note:** No `changeset/2` is defined in this module (unlike the other three schemas). Data manipulation uses `Ecto.Changeset.change/2` directly inside functions.

**Public functions:**
| Line | Name | Arity |
|------|------|-------|
| 24 | `getWithHardwareId/2` | `(hardwareid, customer)` |
| 31 | `service_performed/3` | `(hardwareid, new_service_date, customer)` |
| 47 | `[REDACTED-AWS-SMTP-PASSWORD]` | `(hardwareid, customer)` |
| 57 | `make_info_record/2` | `(hardwareid, customer)` |
| 74 | `update_existing_record/3` | `(existing, hardwareid, customer)` |

**Notable logic:**
- `getWithHardwareId/2`: single Ecto query with `Repo.one/2` using a customer-scoped prefix.
- `service_performed/3`: fetches record, resets PM notification fields only when `info != nil && info.pmnotificationdate <= new_service_date`. Returns `nil` implicitly when the guard fails.
- `[REDACTED-AWS-SMTP-PASSWORD]`: dispatches to `make_info_record/2` (new record) or `update_existing_record/3` (existing record).
- `make_info_record/2`: hardcodes `pmnotificationid: 12` and `notification_date: ~D[2019-01-13]`; calculates `hours_since_notified` from that epoch.
- `update_existing_record/3`: conditional on `pmnotificationdate != nil && pmnotificationdate > ~D[1970-01-01]`; branches to include or exclude `[REDACTED-AWS-SMTP-PASSWORD]` calculation.

---

### 3. `ApiServer.Vx.VXThingSummary`
**File:** `lib/api_server/vx/vx_thing_summary.ex`

**Behaviours / use macros:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema (`"abm_summary"`, lines 6–46):**
- Primary key: `{:abmid, :id, autogenerate: true}` (line 5)
- Fields (41 total): `abmgmtdatetime` (`:utc_datetime`), `abmdesc` (`:string`), `abmignitionstatus` (`:string`), `abmeventtype` (`:integer`), `abmeventcode` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `abmhourmeter1`–`abmhourmeter4` (`:integer`), `abmcalchourmeter1`–`abmcalchourmeter4` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]`–`[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `abmodometer` (`:integer`), `abmcalcodometer` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `abmlatitude` (`:float`), `abmlongitude` (`:float`), `abmheading` (`:float`), `abmspeed` (`:float`), `abmdriverid` (`:string`), `abmmifaredriverid` (`:string`), `abmcustcode` (`:string`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:float`), `abmhourmeteromega` (`:float`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:float`), `abmhourmeterothcan` (`:float`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:float`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:utc_datetime`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:string`)
- Association: `belongs_to :thing, ApiServer.Vx.VXThing` (FK `:abmhardwareid` → references `:aadhardwareid`)

**Public functions:**
| Line | Name | Arity |
|------|------|-------|
| 49 | `changeset/2` | `(vx_thing_summary, attrs)` |
| 56 | `make_or_update_summary/3` | `(hardwareid, customer, existingSummary \\ %VXThingSummary{})` |
| 138 | `validate_for_hardwareid/2` | `(hardwareid, customer)` |
| 156 | `is_valid?/2` | `(summary_record, thing_event)` |

**Notable logic:**
- `make_or_update_summary/3`: resolves most-recent event preferring omega variant; parses `hardwareid` as integer; conditionally merges omega hourmeter fields based on two separate guards (`thing_event.thingeventomega` present, then `thing.aadhourmeteromega && thing_event.thingeventomega`). Unused binding `result` on line 135 (variable `result` assigned but not returned under a name; last expression is the `result = ...` assignment which is the implicit return).
- `validate_for_hardwareid/2`: creates summary when nil; otherwise validates staleness and updates. Assigns `timestamp = Timex.now()` on line 149 but never uses it (dead code).
- `is_valid?/2`: compares five fields across summary and event structs; returns `false` if either argument is `nil`.

---

### 4. `ApiServer.Vx.VXUser`
**File:** `lib/api_server/vx/vx_user.ex`

**Behaviours / use macros:**
- `use Ecto.Schema` (line 5)
- `import Ecto.Changeset` (line 7)
- `require Ecto.Query`, `require Ecto.Adapters.SQL` (top-level, lines 1–2, outside `defmodule`)
- `alias ApiServer.Vx` (line 9)

**Schema (`"aac_user"`, lines 13–55):**
- Primary key: `{:aacid, :id, autogenerate: true}` (line 12)
- Fields (32 total): `aaccustcode` (`:string`), `aacuser` (`:string`), `aacfname` (`:string`), `aacsurname` (`:string`), `aaccredte` (`:utc_datetime`), `aacexpdte` (`:date`), `aaclastupdated` (`:utc_datetime`), `aacpassword` (`:string`), `aacpasswordhash` (`:string`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:string`), `aactz` (`:string`), `aacfirstopt` (`:string`), `aacemail` (`:string`), `aacdash` (`:integer`), `aacpwdlastupd` (`:utc_datetime`), `aacuserdriver` (`:string`), `aaclic1`/`aaclic2` license fields (10 fields), `aacusertype` (`:string`), `aacproxyenabled` (`:string`), `aactimezone` (`:string`), `aacdeffleet` (`:integer`), `aacdateformat` (`:string`), `aachourformat` (`:integer`), `aaclang` (`:string`), `aacuom` (`:string`), `aacmaprefresh` (`:integer`)
- Associations: `has_one :accessfob`, `has_one :function` (`VXUserFunction`, `on_replace: :update`), `has_many :assigned_fleets` (`VXRestriction`), `has_many :abl_records` (`VXAblRecord`)

**Public functions:**
| Line | Name | Arity |
|------|------|-------|
| 57 | `convert_json_to_changeset/1` | `(user_json)` |
| 73 | `password_changeset/2` | `(user, attrs)` |
| 78 | `changeset/2` | `(user, attrs)` |

**Notable logic:**
- `convert_json_to_changeset/1`: builds a plain map (not an `Ecto.Changeset`) by piping through `Vx.update_key_if_value/3` calls. Maps `"units"` to `:aacuom` twice (lines 62 and 67 — duplicate key). Maps `:user_level` (an atom key) into the map despite this not being a valid schema field. Commented-out `aactz`/`offset` mapping (line 68).
- `password_changeset/2`: casts only `:aacpassword`; no `validate_required` or hashing.
- `changeset/2`: casts core fields; uses `put_assoc(:function, ...)` with `attrs.user_level` (atom-key access — will crash if `attrs` is a plain map with string keys); validates `:aacemail` presence and format (`~r/@/`); enforces unique constraint on `:aacuser`.

---

## TEST COVERAGE SEARCH RESULTS

All four module names and all public function names were searched against `C:/Projects/cig-audit/repos/api_server/test/` using `Grep`. **Zero matches** were found for any of the following patterns:

- `[REDACTED-AWS-SMTP-PASSWORD]`, `thingomegatires`
- `VXThingInfo`, `thing_info`, `getWithHardwareId`, `service_performed`, `[REDACTED-AWS-SMTP-PASSWORD]`, `make_info_record`, `update_existing_record`
- `VXThingSummary`, `abm_summary`, `make_or_update_summary`, `validate_for_hardwareid`, `is_valid?`
- `VXUser`, `aac_user`, `convert_json_to_changeset`, `password_changeset`

The four known test files (`calamp_controller_test.exs`, `vx_restriction_controller_test.exs`, `layout_view_test.exs`, `page_view_test.exs`) contain no references to these modules. No indirect test coverage exists anywhere in the test suite.

---

## FINDINGS

### B012-1
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`
**Finding:** No test file exists and no test in the suite exercises `ApiServer.Vx.VXThingEventOmegaTires`. The module defines a 48-field Ecto schema and a `changeset/2`. Zero coverage.

---

### B012-2
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_info.ex`
**Finding:** No test file exists and no test in the suite exercises `ApiServer.Vx.VXThingInfo`. The module defines five public functions (`getWithHardwareId/2`, `service_performed/3`, `[REDACTED-AWS-SMTP-PASSWORD]`, `make_info_record/2`, `update_existing_record/3`). Zero coverage.

---

### B012-3
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_summary.ex`
**Finding:** No test file exists and no test in the suite exercises `ApiServer.Vx.VXThingSummary`. The module defines four public functions (`changeset/2`, `make_or_update_summary/3`, `validate_for_hardwareid/2`, `is_valid?/2`). Zero coverage.

---

### B012-4
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_user.ex`
**Finding:** No test file exists and no test in the suite exercises `ApiServer.Vx.VXUser`. The module defines three public functions (`convert_json_to_changeset/1`, `password_changeset/2`, `changeset/2`). Zero coverage.

---

### B012-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_info.ex`, `service_performed/3` (line 31)
**Finding:** The early-exit path when `info == nil` (i.e., no `thing_info` record exists for the given `hardwareid`) is untested. The function silently returns `nil` in this case. Callers may not handle a `nil` return, and no test verifies the nil-info guard fires correctly.

---

### B012-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_info.ex`, `service_performed/3` (line 36)
**Finding:** The condition `info.pmnotificationdate <= new_service_date` is untested for the case where the condition is `false` (i.e., `new_service_date` is before `pmnotificationdate`). The update is silently skipped and `nil` is returned; no test verifies this negative path.

---

### B012-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_info.ex`, `update_existing_record/3` (line 74)
**Finding:** The `cond` branch at line 85 (`true ->`) — reached when `pmnotificationdate` is `nil` or equals `~D[1970-01-01]` — is untested. This branch sets `usagesincenotification: 0` and skips the `fetch_actual_usage` call. The sentinel date `~D[1970-01-01]` boundary is also never tested (e.g., a record with exactly that date, or one day before/after).

---

### B012-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `make_or_update_summary/3` (line 56)
**Finding:** The fallback path at line 59–61 — where `get_most_recent_thingevent_with_omega/2` returns `nil` and the function falls back to `get_most_recent_thingevent/2` — is untested. No test verifies that the fallback produces a correct summary or that the final result is valid when no omega event exists.

---

### B012-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `make_or_update_summary/3` (line 66)
**Finding:** The `hardwareid` integer-parsing branch at lines 69–71 (`Integer.parse(hardwareid)`) is untested. When `hardwareid` is a non-integer string, `Integer.parse/1` returns `{integer, remainder}` and the remainder is silently discarded. If parsing fails entirely, `Integer.parse/1` returns `:error`, causing a destructuring crash `{hardwareid_parsed, result} = :error`. No test covers string input, partial-parse input, or unparseable input.

---

### B012-10
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `is_valid?/2` (line 156)
**Finding:** `is_valid?/2` is untested. It is a pure function with two branches (`nil`-guard returning `false`, and the five-field equality check returning a boolean). Both the `true` and `false` outcomes of the equality branch are untested. This function controls whether a summary record is refreshed or reused across the system.

---

### B012-11
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_user.ex`, `changeset/2` (line 78)
**Finding:** `changeset/2` is untested. It includes `put_assoc(:function, %{aatfunction_id: attrs.user_level}, required: true)` which accesses `attrs.user_level` using atom-key struct/map access. If `attrs` is a plain map with string keys (as is typical from JSON input), this raises a `KeyError` at runtime. No test covers this path, the email format validation, the unique constraint on `:aacuser`, or required field validation.

---

### B012-12
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_user.ex`, `convert_json_to_changeset/1` (line 57)
**Finding:** `convert_json_to_changeset/1` is untested. The function contains a duplicate mapping of `"units"` to `:aacuom` (lines 62 and 67), meaning the first assignment is always silently overwritten. It also maps a `:user_level` atom key that is not a valid schema field, which will be ignored by downstream changesets. No test verifies correct output, the duplicate-key behaviour, or handling of nil/missing JSON keys.

---

### B012-13
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_user.ex`, `password_changeset/2` (line 73)
**Finding:** `password_changeset/2` is untested. It casts `:aacpassword` in plain text with no hashing, no strength validation, and no `validate_required`. No test verifies that the changeset correctly accepts or rejects password updates.

---

### B012-14
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`, `changeset/2` (line 58)
**Finding:** Edge cases for `changeset/2` are untested: (a) all 48 tire fields absent (only `:id` provided — the only required field); (b) non-integer values supplied for integer fields; (c) `id` missing (should produce a required-field validation error). The schema supports 6 tires; no test verifies partial tire data (e.g., only tires 0–2 populated).

---

### B012-15
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_info.ex`, `make_info_record/2` (line 57)
**Finding:** The hardcoded `notification_date = ~D[2019-01-13]` and `pmnotificationid: 12` constants are never tested. These magic values look like a one-time migration artifact. No test verifies that newly created `thing_info` records carry the correct initial values, or that `NaiveDateTime.new/2` succeeds for this date (it always should, but the `{_, notification_datetime}` destructuring silently discards errors).

---

### B012-16
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `validate_for_hardwareid/2` (line 138)
**Finding:** The unused variable `timestamp = Timex.now()` at line 149 is dead code — it is assigned but never referenced. While not a correctness bug, it is untested dead logic that may have been intended to stamp the update time on the record and was inadvertently omitted.

---

### B012-17
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `make_or_update_summary/3` (lines 103–117 and 119–133)
**Finding:** Two consecutive `if` guards both test `thing_event.thingeventomega` and then `thing.aadhourmeteromega && thing_event.thingeventomega`. When both conditions are true, the second block overwrites the first, making the first block's result unreachable in practice. No test exercises the case where the first block executes but the second does not (i.e., `thing_event.thingeventomega` is set but `thing.aadhourmeteromega` is nil/false).

---

### B012-18
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `make_or_update_summary/3` (line 104)
**Finding:** The `nil`-guard for `thing_event.thingeventomega.totalenginehour` (returning `0.0`) is duplicated identically at lines 104–108 and 120–124. No test verifies that `0.0` is correctly stored when `totalenginehour` is `nil`, nor that `Float.round/2` at line 108/124 correctly handles boundary float values.

---

### B012-19
**Severity:** LOW
**File:** `lib/api_server/vx/vx_user.ex`, `changeset/2` (line 83)
**Finding:** The email format regex `~r/@/` (line 83) only checks for the presence of the `@` character. It does not validate a domain part, local part, or TLD. Edge cases such as `"@"`, `"a@"`, `"@b"`, and multiple `@` symbols are unchecked and untested.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B012-1 | HIGH | vx_thing_event_omega_tires.ex | No tests — entire module uncovered |
| B012-2 | HIGH | vx_thing_info.ex | No tests — entire module uncovered |
| B012-3 | HIGH | vx_thing_summary.ex | No tests — entire module uncovered |
| B012-4 | HIGH | vx_user.ex | No tests — entire module uncovered |
| B012-5 | MEDIUM | vx_thing_info.ex | `service_performed/3`: nil-info path untested |
| B012-6 | MEDIUM | vx_thing_info.ex | `service_performed/3`: date-before-notification path untested |
| B012-7 | MEDIUM | vx_thing_info.ex | `update_existing_record/3`: nil/epoch date branch and sentinel boundary untested |
| B012-8 | MEDIUM | vx_thing_summary.ex | `make_or_update_summary/3`: no-omega-event fallback path untested |
| B012-9 | MEDIUM | vx_thing_summary.ex | `make_or_update_summary/3`: string hardwareid parsing (crash on `:error`) untested |
| B012-10 | MEDIUM | vx_thing_summary.ex | `is_valid?/2`: pure function entirely untested |
| B012-11 | MEDIUM | vx_user.ex | `changeset/2`: atom-key access crash risk on string-key map untested |
| B012-12 | MEDIUM | vx_user.ex | `convert_json_to_changeset/1`: duplicate key and invalid field mapping untested |
| B012-13 | MEDIUM | vx_user.ex | `password_changeset/2`: no hashing/validation, entirely untested |
| B012-14 | LOW | vx_thing_event_omega_tires.ex | `changeset/2`: partial/empty/invalid field edge cases untested |
| B012-15 | LOW | vx_thing_info.ex | `make_info_record/2`: hardcoded magic constants untested |
| B012-16 | LOW | vx_thing_summary.ex | `validate_for_hardwareid/2`: unused dead variable `timestamp` |
| B012-17 | LOW | vx_thing_summary.ex | `make_or_update_summary/3`: first omega block unreachable when second fires |
| B012-18 | LOW | vx_thing_summary.ex | `make_or_update_summary/3`: duplicated nil-guard for `totalenginehour` untested |
| B012-19 | LOW | vx_user.ex | `changeset/2`: overly permissive email regex edge cases untested |
