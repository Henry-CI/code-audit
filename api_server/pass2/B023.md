# Audit Report B023
**Audit run:** 2026-02-27-01
**Agent:** B023 (Pass 2)
**Scope:** View layer — changeset, error helpers, error view, file view

---

## Source Files Examined

1. `lib/api_server_web/views/changeset_view.ex`
2. `lib/api_server_web/views/error_helpers.ex`
3. `lib/api_server_web/views/error_view.ex`
4. `lib/api_server_web/views/file_view.ex`

---

## Reading Evidence

### 1. `ApiServerWeb.ChangesetView`
**File:** `lib/api_server_web/views/changeset_view.ex`

| Line | Definition |
|------|-----------|
| 1    | `defmodule ApiServerWeb.ChangesetView` |
| 2    | `use ApiServerWeb, :view` |
| 10   | `def translate_errors(changeset)` — public; traverses changeset errors via `Ecto.Changeset.traverse_errors/2` and `translate_error/1` |
| 14   | `def render("error.json", %{changeset: changeset})` — public render clause; returns `%{errors: translate_errors(changeset)}` |

No types or module-level constants defined.

Called from: `lib/api_server_web/controllers/fallback_controller.ex` line 12 — `render(conn, ApiServerWeb.ChangesetView, "error.json", changeset: changeset)`.

---

### 2. `ApiServerWeb.ErrorHelpers`
**File:** `lib/api_server_web/views/error_helpers.ex`

| Line | Definition |
|------|-----------|
| 1    | `defmodule ApiServerWeb.ErrorHelpers` |
| 6    | `use Phoenix.HTML` |
| 11   | `def error_tag(form, field)` — public; generates HTML `<span>` tags for inline form errors using `content_tag/3` |
| 20   | `def translate_error({msg, opts})` — public; translates a single `{msg, opts}` error tuple via Gettext, with plural-form branching on `opts[:count]` |

No types or module-level constants defined.

Imported globally by `lib/api_server_web.ex` line 41 (`import ApiServerWeb.ErrorHelpers`) into every view module, so `translate_error/1` is available in all views and is called indirectly by `ChangesetView.translate_errors/1`.

---

### 3. `ApiServerWeb.ErrorView`
**File:** `lib/api_server_web/views/error_view.ex`

| Line | Definition |
|------|-----------|
| 1    | `defmodule ApiServerWeb.ErrorView` |
| 2    | `use ApiServerWeb, :view` |
| 13   | `def template_not_found(template, _assigns)` — public (Phoenix callback); returns `%{error: Phoenix.Controller.status_message_from_template(template)}` for any unmatched template |

No explicit `render/2` clauses, no types or constants defined.

Called from: `lib/api_server_web/controllers/fallback_controller.ex` line 18 — `render(ApiServerWeb.ErrorView, :"404")`.

---

### 4. `ApiServerWeb.FileView`
**File:** `lib/api_server_web/views/file_view.ex`

| Line | Definition |
|------|-----------|
| 1    | `defmodule ApiServerWeb.FileView` |
| 2    | `use ApiServerWeb, :view` |
| 3    | `alias ApiServerWeb.FileView` |
| 5    | `def render("index.json", %{files: files})` — public; returns `%{data: render_many(...)}` |
| 9    | `def render("show.json", %{file: file})` — public; returns `%{data: render_one(...)}` |
| 13   | `def render("filesize.json", %{file: file})` — public; returns `%{hardwareid:, size:, num_fobs:}` |
| 20   | `def render("file.json", %{file: file})` — public; returns `%{hardwareid:, size:, num_fobs:, fobs:}` |

No types or module-level constants defined.

Called from: `lib/api_server_web/controllers/file_controller.ex` line 24 — `render(conn, "filesize.json", ...)`.

---

## Test Coverage Search Results

### Direct test files
None exist for any of the four modules (confirmed — no files in `test/api_server_web/views/` for these modules).

### Indirect coverage search
All test files in the repository:
- `test/api_server_web/controllers/calamp_controller_test.exs` — empty stub (only module declaration, no tests)
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — exercises CRUD on `VXRestriction`; posts invalid attrs and asserts `json_response(conn, 422)["errors"] != %{}`
- `test/api_server_web/views/layout_view_test.exs` — empty stub
- `test/api_server_web/views/page_view_test.exs` — empty stub
- `test/test_helper.exs`

Grep results for all module names (`ChangesetView`, `ErrorHelpers`, `ErrorView`, `FileView`, `translate_errors`, `translate_error`, `error_tag`, `template_not_found`) across all test files: **no matches**.

The `vx_restriction_controller_test.exs` "renders errors when data is invalid" test does indirectly exercise the pipeline that calls `FallbackController` -> `ChangesetView.render("error.json")` -> `translate_errors/1` -> `ErrorHelpers.translate_error/1`, but only at the HTTP response boundary (it asserts `["errors"] != %{}`). It does not assert the specific structure, error messages, or translation behaviour of these view modules directly.

---

## Findings

---

### B023-1
**Severity:** HIGH
**File:** `lib/api_server_web/views/changeset_view.ex`
**Finding:** No dedicated test file exists for `ApiServerWeb.ChangesetView`. The module has two public functions (`translate_errors/1` and `render("error.json", ...)`). No test directly constructs a changeset and asserts the rendered JSON structure. The single indirect exercise in `vx_restriction_controller_test.exs` only asserts `["errors"] != %{}` — it does not verify the shape of the errors map, field names, or translated messages.

---

### B023-2
**Severity:** HIGH
**File:** `lib/api_server_web/views/error_helpers.ex`
**Finding:** No dedicated test file exists for `ApiServerWeb.ErrorHelpers`. Neither `translate_error/1` nor `error_tag/2` is directly tested. The module is imported globally into all views but no test exercises these functions in isolation or verifies their output.

---

### B023-3
**Severity:** HIGH
**File:** `lib/api_server_web/views/error_view.ex`
**Finding:** No dedicated test file exists for `ApiServerWeb.ErrorView`. The `template_not_found/2` callback is the module's only function and has no test coverage. No test verifies that arbitrary template names (e.g., `"500.json"`, `"404.html"`) are correctly mapped to their status messages via `Phoenix.Controller.status_message_from_template/1`.

---

### B023-4
**Severity:** HIGH
**File:** `lib/api_server_web/views/file_view.ex`
**Finding:** No dedicated test file and no indirect test coverage exist for `ApiServerWeb.FileView`. All four render clauses (`"index.json"`, `"show.json"`, `"filesize.json"`, `"file.json"`) are completely untested. There is no test file for `FileController` either, so the view is never exercised at any level of the test suite.

---

### B023-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/changeset_view.ex`
**Function:** `translate_errors/1` (line 10)
**Finding:** The function is never called with a changeset that contains multiple errors on the same field, or errors on nested/embedded changesets. The single indirect test only posts entirely nil attributes against one schema. Edge cases such as: (a) a changeset with multiple validation errors on one field, (b) a changeset with association/embed errors, and (c) an empty changeset (no errors) are all untested.

---

### B023-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/error_helpers.ex`
**Function:** `translate_error/1` (line 20)
**Finding:** The function contains an explicit branch at line 38: `if count = opts[:count]` — the plural-form path (`Gettext.dngettext/6`) versus the singular path (`Gettext.dgettext/5`). Neither branch is tested directly. An error with a `:count` option (e.g., a `length` or `format` validation with a count constraint) would follow a different code path that is wholly unexercised.

---

### B023-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/error_helpers.ex`
**Function:** `error_tag/2` (line 11)
**Finding:** `error_tag/2` generates HTML `<span>` elements for form field errors. It is never tested. No test verifies: (a) that it returns an empty list when the field has no errors, (b) that it returns one `<span>` per error when multiple errors exist on the same field, or (c) that the generated HTML has the correct `class="help-block"` attribute.

---

### B023-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/error_view.ex`
**Function:** `template_not_found/2` (line 13)
**Finding:** The `template_not_found/2` callback is triggered for every HTTP error status that has no explicit render clause. No test verifies that it correctly returns `%{error: "Not Found"}` for `"404.json"`, `%{error: "Internal Server Error"}` for `"500.json"`, or any other status code. The fallback controller calls this path for 404 responses but no test asserts on the response body structure.

---

### B023-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/file_view.ex`
**Function:** `render("filesize.json", ...)` (line 13) and `render("file.json", ...)` (line 20)
**Finding:** Both clauses are called from production code (`FileController.get_size/2` and indirectly via `render_many`/`render_one`) but have zero test coverage. The `"filesize.json"` clause omits the `fobs` field that `"file.json"` includes — no test verifies this intentional difference or that both serialise all expected fields correctly.

---

### B023-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/file_view.ex`
**Function:** `render("index.json", ...)` (line 5), `render("show.json", ...)` (line 9)
**Finding:** The `"index.json"` and `"show.json"` clauses use `render_many/3` and `render_one/3` respectively, delegating to `"file.json"`. No test verifies that the `%{data: [...]}` wrapper is present, that an empty list is correctly serialised for an empty index, or that `render_one` returns `%{data: null}` (not a list) for a show response.

---

### B023-11
**Severity:** LOW
**File:** `lib/api_server_web/views/changeset_view.ex`
**Function:** `render("error.json", ...)` (line 14)
**Finding:** The rendered JSON key is `"errors"` (plural). No test verifies that the key is exactly `"errors"` and not `"error"` (singular). A typo or regression in the key name would not be caught by the existing assertion (`json_response(conn, 422)["errors"] != %{}` would merely return `nil != %{}` which is true and would not fail the test).

---

### B023-12
**Severity:** LOW
**File:** `lib/api_server_web/views/file_view.ex`
**Function:** `render("file.json", ...)` (line 20)
**Finding:** The `fobs` field is included in `"file.json"` output but omitted from `"filesize.json"`. There is no test to document or enforce this contract. If a caller uses `"filesize.json"` expecting `fobs` to be present, the omission would not be caught.

---

### B023-13
**Severity:** INFO
**File:** `lib/api_server_web/views/error_view.ex`
**Finding:** Lines 5–8 contain a commented-out `render("500.html", _assigns)` clause that would return a plain string instead of a map. Its absence means `template_not_found/2` handles 500 responses, returning a JSON map. The commented code is dead and creates no coverage gap, but its presence may cause confusion about the intended 500 response format.

---

### B023-14
**Severity:** INFO
**File:** `lib/api_server_web/views/file_view.ex`
**Finding:** `FileController` (`lib/api_server_web/controllers/file_controller.ex`) contains `IO.puts` debug calls on lines 16 and 46 that will write to stdout in production. These are not a test-coverage gap in `FileView` itself, but they indicate the file handling code path has never been cleaned up, which is consistent with the complete absence of tests for `FileView`.

---

## Summary Table

| ID      | Severity | File                   | Description |
|---------|----------|------------------------|-------------|
| B023-1  | HIGH     | changeset_view.ex      | No test file; no direct assertions on rendered changeset errors |
| B023-2  | HIGH     | error_helpers.ex       | No test file; both public functions completely untested |
| B023-3  | HIGH     | error_view.ex          | No test file; `template_not_found/2` untested |
| B023-4  | HIGH     | file_view.ex           | No test file; all four render clauses untested |
| B023-5  | MEDIUM   | changeset_view.ex      | `translate_errors/1` not tested with multiple errors, nested changesets, or empty changeset |
| B023-6  | MEDIUM   | error_helpers.ex       | `translate_error/1` plural-form branch (`opts[:count]` path) untested |
| B023-7  | MEDIUM   | error_helpers.ex       | `error_tag/2` never exercised by any test |
| B023-8  | MEDIUM   | error_view.ex          | `template_not_found/2` response body structure never asserted |
| B023-9  | MEDIUM   | file_view.ex           | `"filesize.json"` and `"file.json"` render clauses untested |
| B023-10 | MEDIUM   | file_view.ex           | `"index.json"` and `"show.json"` render clauses, including `render_many`/`render_one` wrapping, untested |
| B023-11 | LOW      | changeset_view.ex      | `"errors"` key name not verified; regression would silently pass existing test |
| B023-12 | LOW      | file_view.ex           | `fobs` field presence contract between `"file.json"` and `"filesize.json"` not enforced by tests |
| B023-13 | INFO     | error_view.ex          | Commented-out `render("500.html", ...)` clause creates dead-code confusion |
| B023-14 | INFO     | file_view.ex (context) | `IO.puts` debug statements in `FileController` indicate the associated view path has never been cleaned up |
