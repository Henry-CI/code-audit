# Audit Report B006
**Audit run:** 2026-02-27-01
**Auditor:** Pass 2 agent B006
**Scope:** `lib/api_server/vx/erp_import.ex`, `lib/api_server/vx/geofence.ex`, `lib/api_server/vx/mailer.ex`, `lib/api_server/vx/rental_contracts.ex`

---

## READING EVIDENCE

### 1. `lib/api_server/vx/erp_import.ex`

**Module:** `ApiServer.Vx.ERPImport`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined (`erp_imports` table):**
| Field | Type |
|---|---|
| `id` | `:id` (primary key, autogenerate) |
| `raw_record` | `:string` |
| `serialno` | `:string` |
| `name` | `:string` |
| `matched` | `:boolean` |
| `type` | `:string` |

**Functions defined:**
| Name | Line | Visibility |
|---|---|---|
| `changeset/2` | 15 | public |

**Constraints / validations in `changeset/2`:**
- `cast/3` on all five fields
- `validate_required/2` on `:raw_record` only

---

### 2. `lib/api_server/vx/geofence.ex`

**Module:** `ApiServer.Vx.Geofence`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)
- `import Ecto.Query, warn: false` (line 4)

**Aliases:**
- `ApiServer.Repo` (line 6)
- `ApiServer.Vx` (line 7)
- `ApiServer.Vx.VXThingEvent` (line 8)

**Schema defined (`geofences` table):**
| Field | Type |
|---|---|
| `id` | `:id` (primary key, autogenerate) |
| `name` | `:string` |
| `geojson` | `:string` |

**Functions defined:**
| Name | Line | Visibility |
|---|---|---|
| `changeset/2` | 17 | public |
| `geojson_map_to_string/1` | 24 | public |
| `geojson_db_string_to_map/1` | 38 | public |
| `does_event_cause_geofence_events_no_thing/5` | 52 | private |
| `check_event_for_left_events_no_thing/5` (nil guard clause) | 69 | private |
| `check_event_for_left_events_no_thing/5` (general clause) | 70 | private |
| `check_event_for_entered_events_no_thing/6` | 86 | private |
| `make_geofence_event_no_thing/5` | 103 | private |
| `engine_hours_at_event_no_thing/2` | 119 | private |

**Constraints / validations in `changeset/2`:**
- `cast/3` on `:name` and `:geojson`
- `validate_required/2` on `:name`

**Notable logic in private functions:**
- `engine_hours_at_event_no_thing/2`: pattern-matches `event.hardwaretype` on `1` (calcengineseconds/3600) or `2` (Omega, Repo query). No `_` catch-all — an unknown hardwaretype raises a `FunctionClauseError` at runtime.
- `check_event_for_left_events_no_thing/5` nil guard: returns a bare list `[]` instead of the expected two-tuple `{[], []}`, which is inconsistent with the general clause return type and the destructuring at line 63 (`{fences_still_inside, left_events}`).

---

### 3. `lib/api_server/vx/mailer.ex`

**Module:** `ApiServer.Mailer`

**Behaviours / macros used:**
- `use Bamboo.Mailer, otp_app: :api_server` (line 2)

**Functions defined:** None explicitly; all functions (`deliver_now/1`, `deliver_later/1`, etc.) are injected by the `Bamboo.Mailer` macro.

---

### 4. `lib/api_server/vx/rental_contracts.ex`

**Module:** `ApiServer.Vx.RentalContract`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined (`rental_contracts` table):**
| Field | Type | DB source column |
|---|---|---|
| `ID` | `:id` (primary key, autogenerate) | `id` |
| `id` | `:integer` | `id` |
| `equipment_id` | `:integer` | `equipment_id` |
| `customer_id` | `:integer` | `customer_id` |
| `contract_reference` | `:string` | `contract_reference` |
| `contract_start` | `:date` | `contract_start` |
| `contract_end` | `:date` | `contract_end` |
| `billing_frequency` | `:string` | `billing_frequency` |
| `hours_per_billing_period` | `:integer` | `hours_per_billing_period` |
| `cost_units` | `:string` | `cost_units` |
| `cost_per_unit` | `:float` | `cost_per_unit` |
| `reporting_frequency` | `:string` | `reporting_frequency` |
| `created` | `:utc_datetime` | `created` |
| `sent_to_rayven` | `:integer` | `sent_to_rayven` |

**Functions defined:**
| Name | Line | Visibility |
|---|---|---|
| `changeset/2` | 22 | public |

**Constraints / validations in `changeset/2`:**
- `cast/3` on all 13 non-primary-key fields
- No `validate_required/2` calls — all fields are optional

---

## FINDINGS

---

### B006-1
**Severity:** HIGH
**File:** `lib/api_server/vx/erp_import.ex`
**Finding:** No test file exists and no indirect test coverage was found for `ApiServer.Vx.ERPImport`. Searching the entire `test/` directory for `ERPImport` and `erp_import` returned zero results.

**Impact:** The `changeset/2` function — including its cast logic and the `validate_required(:raw_record)` constraint — is completely untested.

---

### B006-2
**Severity:** HIGH
**File:** `lib/api_server/vx/geofence.ex`
**Finding:** No test file exists and no indirect test coverage was found for `ApiServer.Vx.Geofence`. Searching the entire `test/` directory for `Geofence` and `geofence` returned zero results.

**Impact:** All public and private functions, including the geofence enter/exit event logic, are completely untested.

---

### B006-3
**Severity:** HIGH
**File:** `lib/api_server/vx/mailer.ex`
**Finding:** No test file exists and no indirect test coverage was found for `ApiServer.Mailer`. Searching `test/` for `Mailer` and `mailer` returned zero results.

**Impact:** Email delivery is exercised in multiple places in production code (`vx.ex`, `utility_controller.ex`, `digital_matter_controller.ex`); none of these call paths are tested. Bamboo provides a test adapter specifically for this purpose but it has not been configured or used.

---

### B006-4
**Severity:** HIGH
**File:** `lib/api_server/vx/rental_contracts.ex`
**Finding:** No test file exists and no indirect test coverage was found for `ApiServer.Vx.RentalContract`. Searching the entire `test/` directory for `RentalContract` and `rental_contract` returned zero results.

**Impact:** The `changeset/2` function is completely untested.

---

### B006-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `changeset/2` (line 17)
**Finding:** The `changeset/2` function has no test coverage. Specifically, no test verifies that:
- `:name` is required (should produce a validation error when absent).
- `:geojson` is optional (should be accepted when nil/absent).
- Invalid attribute keys are filtered by `cast/3`.

---

### B006-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `geojson_map_to_string/1` (line 24)
**Finding:** No test covers this public function. Callers in `geofence_controller.ex` (lines 21, 42) pass user-supplied maps directly to it. Untested paths include:
- A valid map that encodes successfully.
- A value that causes `Poison.encode/1` to return an error tuple (returns `""` silently — this silent failure is also a code-quality concern).
- A `nil` argument (returns `""` — valid but untested).

---

### B006-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `geojson_db_string_to_map/1` (line 38)
**Finding:** No test covers this public function. It is called from `geofence_view.ex` (line 18) and `vx.ex` (line 3238). Untested paths include:
- A valid JSON string that decodes successfully.
- A malformed JSON string causing `Poison.decode/1` to return an error tuple (returns `""` silently).
- A `nil` argument (returns `""`).

---

### B006-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/erp_import.ex`
**Function:** `changeset/2` (line 15)
**Finding:** No test verifies that `validate_required(:raw_record)` correctly rejects a changeset where `raw_record` is nil or absent, nor that the other four fields are accepted as optional.

---

### B006-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/rental_contracts.ex`
**Function:** `changeset/2` (line 22)
**Finding:** No test covers the `changeset/2` function. Notably, the function has no `validate_required/2` call at all — every field, including logically mandatory fields such as `equipment_id`, `customer_id`, and `contract_start`, is optional. This means a completely blank `RentalContract` can be inserted without an error from the changeset layer. This is untested and may represent a missing constraint.

---

### B006-10
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `engine_hours_at_event_no_thing/2` (line 119)
**Finding:** The private function pattern-matches only on `hardwaretype` values `1` and `2`. There is no catch-all (`_`) clause. Any event with a `hardwaretype` other than `1` or `2` will raise an unhandled `FunctionClauseError` at runtime. This code path has no test coverage.

---

### B006-11
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `check_event_for_left_events_no_thing/5` (line 69, nil guard clause)
**Finding:** The nil guard clause on line 69 returns a bare `[]` (a list), not the two-tuple `{[], []}` that is expected by the destructuring assignment on line 63:
```elixir
{fences_still_inside, left_events} = check_event_for_left_events_no_thing(...)
```
This will cause a `MatchError` (`** (MatchError) no match of right hand side value: []`) at runtime whenever `in_geofences` is `nil`. Because there are no tests, this bug has not been caught.

---

### B006-12
**Severity:** LOW
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `geojson_map_to_string/1` (line 24) and `geojson_db_string_to_map/1` (line 38)
**Finding:** Both functions silently return an empty string `""` on encode/decode failure rather than propagating `{:error, reason}` or raising. No test asserts this silent-failure contract, so callers have no documented or verified guarantee about the return value on error.

---

### B006-13
**Severity:** LOW
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `geojson_map_to_string/1` (line 24)
**Finding:** The `event_time` assignment inside `does_event_cause_geofence_events_no_thing/5` (line 56–60) has a dead binding: `datetime = Map.get(adt, :after)` assigns to a local variable `datetime` that is never used; the expression result is discarded. This is likely a bug — the intent was probably `event_time = Map.get(adt, :after)` — but is undetected due to absence of tests.

---

### B006-14
**Severity:** LOW
**File:** `lib/api_server/vx/rental_contracts.ex`
**Schema:** `rental_contracts` (line 5–20)
**Finding:** The schema declares both a custom primary key `{:ID, :id, autogenerate: true}` (uppercase atom `:ID`) and a regular field `field :id, :integer, source: :id` (line 7) mapping to the same underlying database column (`id`). This creates a shadowing situation where `:id` as a virtual field and `:ID` as the primary key both reference the same column. No test verifies that reads and writes behave correctly, and the `changeset/2` casts `:id` as a regular attribute (line 24) which may conflict with Ecto's primary-key handling.

---

### B006-15
**Severity:** LOW
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `changeset/2` (line 17)
**Finding:** No edge-case tests exist for boundary inputs:
- Empty string `""` for `:name` (passes `validate_required` but is semantically invalid).
- Extremely large GeoJSON strings for `:geojson`.
- `:geojson` supplied as a non-string type (e.g., a map) — Ecto's `:string` type would cast it, but the result is untested.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|---|---|---|---|
| B006-1 | HIGH | `erp_import.ex` | No test coverage whatsoever for `ApiServer.Vx.ERPImport` |
| B006-2 | HIGH | `geofence.ex` | No test coverage whatsoever for `ApiServer.Vx.Geofence` |
| B006-3 | HIGH | `mailer.ex` | No test coverage for `ApiServer.Mailer`; Bamboo test adapter not used |
| B006-4 | HIGH | `rental_contracts.ex` | No test coverage whatsoever for `ApiServer.Vx.RentalContract` |
| B006-5 | MEDIUM | `geofence.ex` | `changeset/2` — `validate_required(:name)` never tested |
| B006-6 | MEDIUM | `geofence.ex` | `geojson_map_to_string/1` — no tests; silent error return untested |
| B006-7 | MEDIUM | `geofence.ex` | `geojson_db_string_to_map/1` — no tests; silent error return untested |
| B006-8 | MEDIUM | `erp_import.ex` | `changeset/2` — `validate_required(:raw_record)` never tested |
| B006-9 | MEDIUM | `rental_contracts.ex` | `changeset/2` — no `validate_required` at all; blank record possible |
| B006-10 | MEDIUM | `geofence.ex` | `engine_hours_at_event_no_thing/2` — no catch-all clause; unknown hardwaretype crashes |
| B006-11 | MEDIUM | `geofence.ex` | `check_event_for_left_events_no_thing/5` nil clause returns `[]` not `{[], []}` — runtime `MatchError` |
| B006-12 | LOW | `geofence.ex` | Silent `""` return on JSON encode/decode failure — no test documents contract |
| B006-13 | LOW | `geofence.ex` | Dead binding `datetime =` in `does_event_cause_geofence_events_no_thing/5` (line 57) — likely bug |
| B006-14 | LOW | `rental_contracts.ex` | Dual `:ID`/`:id` primary-key + field mapping to same column; cast of `:id` may conflict with Ecto PK |
| B006-15 | LOW | `geofence.ex` | No edge-case tests for `changeset/2` (empty string name, oversized geojson, non-string geojson) |
