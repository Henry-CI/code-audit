# Audit Report B024
**Audit run:** 2026-02-27-01
**Agent:** B024 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/views/geofence_view.ex`
2. `lib/api_server_web/views/layout_view.ex`
3. `lib/api_server_web/views/page_view.ex`
4. `lib/api_server_web/views/vx_abl_record_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/geofence_view.ex`

**Module name:** `ApiServerWeb.GeofenceView`

**Uses/aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.GeofenceView` (line 4)
- `alias ApiServerWeb.VXThingView` (line 5)
- `alias ApiServer.Vx` (line 6)
- `alias ApiServer.Vx.Geofence` (line 7)

**Functions defined:**

| Line | Name | Arity | Clause / Pattern |
|------|------|-------|-----------------|
| 9 | `render/2` | 2 | `"index.json"` with `%{geofences: geofences}` |
| 13 | `render/2` | 2 | `"geofence.json"` with `%{geofence: geofence}` |
| 22 | `render/2` | 2 | `"geofence_events.json"` with `%{geofence_events: geofence_events, thing: thing}` |

**Types / constants defined:** None.

**Delegations / notable calls:**
- `Geofence.geojson_db_string_to_map/1` called in `render("geofence.json", ...)` (line 18)
- `render_one/3` called with `VXThingView, "rhm_thing.json"` in `render("geofence_events.json", ...)` (line 26)

---

### File 2: `lib/api_server_web/views/layout_view.ex`

**Module name:** `ApiServerWeb.LayoutView`

**Uses/aliases:**
- `use ApiServerWeb, :view` (line 2)

**Functions defined:** None explicitly. All functions are injected by `use ApiServerWeb, :view` at compile time.

**Types / constants defined:** None.

---

### File 3: `lib/api_server_web/views/page_view.ex`

**Module name:** `ApiServerWeb.PageView`

**Uses/aliases:**
- `use ApiServerWeb, :view` (line 2)

**Functions defined:** None explicitly. All functions are injected by `use ApiServerWeb, :view` at compile time.

**Types / constants defined:** None.

---

### File 4: `lib/api_server_web/views/vx_abl_record_view.ex`

**Module name:** `ApiServerWeb.VXAblRecordView`

**Uses/aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXAblRecordView` (line 4)
- `alias ApiServer.Vx` (line 5)

**Functions defined:**

| Line | Name | Arity | Clause / Pattern |
|------|------|-------|-----------------|
| 8 | `render/2` | 2 | `"index.json"` with `%{vxablrecords: vxablrecords}` |
| 12 | `render/2` | 2 | `"show.json"` with `%{vx_abl_record: vx_abl_record}` |
| 16 | `render/2` | 2 | `"vx_abl_record.json"` with `%{vx_abl_record: vx_abl_record}` |
| 22 | `render/2` | 2 | `"services.json"` with `%{records: records, customer: customer}` |
| 28 | `clean_xml_value/1` | 1 | general; returns `nil` when value is `%{}`, else returns value |
| 37 | `clean_xml_number_value/1` | 1 | general; returns `0` when value is `%{}`, else returns value |
| 46 | `render/2` | 2 | `"service.json"` with `%{vx_abl_record: {record, customer}}` |

**Types / constants defined:** None.

**Notable logic in `render("service.json", ...)`:**
- Branches on `is_integer(record.hardwareid)` to resolve vehicle name and fleets via `Vx.get_vx_thing_with_hardware_id!/2` (line 49).
- Secondary nil-check on `thing` result (line 50).
- Branches on `record.user != nil` to compose user name from struct fields vs. fallback `record.abluser` (line 60-65).

---

## Test File Analysis

### `test/api_server_web/views/layout_view_test.exs`

Full content:
```elixir
defmodule ApiServerWeb.LayoutViewTest do
  use ApiServerWeb.ConnCase, async: true
end
```

This file declares the test module but contains **zero test cases**. No `test/2` or `describe/2` blocks are present.

### `test/api_server_web/views/page_view_test.exs`

Full content:
```elixir
defmodule ApiServerWeb.PageViewTest do
  use ApiServerWeb.ConnCase, async: true
end
```

This file declares the test module but contains **zero test cases**. No `test/2` or `describe/2` blocks are present.

---

## Indirect Coverage Search Results

### `ApiServerWeb.GeofenceView`

- Grep for `GeofenceView`, `geofence_view`, `geofence_events`, `geofence.json`, `index.json` across all test files (`test/**/*.exs`): **no matches found**.

### `ApiServerWeb.VXAblRecordView`

- Grep for `VXAblRecordView`, `vx_abl_record_view`, `vx_abl_record`, `clean_xml_value`, `clean_xml_number_value`, `services.json`, `service.json`, `show.json` across all test files (`test/**/*.exs`): **no matches found**.

### Complete test file inventory

The repository contains exactly five test files:
1. `test/api_server_web/controllers/calamp_controller_test.exs`
2. `test/api_server_web/controllers/vx_restriction_controller_test.exs`
3. `test/api_server_web/views/layout_view_test.exs`
4. `test/api_server_web/views/page_view_test.exs`
5. `test/test_helper.exs`

No test file exercises `GeofenceView` or `VXAblRecordView` in any form.

---

## Findings

---

### B024-1

**Severity:** HIGH
**File:** `lib/api_server_web/views/geofence_view.ex`
**Finding:** No test file exists for `ApiServerWeb.GeofenceView` and no indirect coverage was found in any test file in the repository. The module is entirely untested.

**Evidence:** Grep for `GeofenceView`, all render template strings (`"index.json"`, `"geofence.json"`, `"geofence_events.json"`), and all related identifiers across `test/**/*.exs` returned zero matches. No dedicated test file exists under `test/api_server_web/views/`.

**Affected functions:**
- `render/2` — `"index.json"` (line 9)
- `render/2` — `"geofence.json"` (line 13)
- `render/2` — `"geofence_events.json"` (line 22)

---

### B024-2

**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXAblRecordView` and no indirect coverage was found in any test file in the repository. The module is entirely untested.

**Evidence:** Grep for `VXAblRecordView`, all render template strings, `clean_xml_value`, `clean_xml_number_value`, and related identifiers across `test/**/*.exs` returned zero matches. No dedicated test file exists under `test/api_server_web/views/`.

**Affected functions:**
- `render/2` — `"index.json"` (line 8)
- `render/2` — `"show.json"` (line 12)
- `render/2` — `"vx_abl_record.json"` (line 16)
- `render/2` — `"services.json"` (line 22)
- `render/2` — `"service.json"` (line 46)
- `clean_xml_value/1` (line 28)
- `clean_xml_number_value/1` (line 37)

---

### B024-3

**Severity:** HIGH
**File:** `lib/api_server_web/views/layout_view.ex`
**Finding:** The dedicated test file `test/api_server_web/views/layout_view_test.exs` exists but is completely empty — it declares the test module with `use ApiServerWeb.ConnCase, async: true` and contains zero test cases. The file provides no coverage whatsoever.

**Evidence:**
```elixir
defmodule ApiServerWeb.LayoutViewTest do
  use ApiServerWeb.ConnCase, async: true
end
```
No `test/2`, `describe/2`, or assertion of any kind is present.

**Note:** `ApiServerWeb.LayoutView` has no explicitly defined functions (the module body is `use ApiServerWeb, :view` only), so the injected macro-generated helpers from the view layer are also untested.

---

### B024-4

**Severity:** HIGH
**File:** `lib/api_server_web/views/page_view.ex`
**Finding:** The dedicated test file `test/api_server_web/views/page_view_test.exs` exists but is completely empty — it declares the test module with `use ApiServerWeb.ConnCase, async: true` and contains zero test cases. The file provides no coverage whatsoever.

**Evidence:**
```elixir
defmodule ApiServerWeb.PageViewTest do
  use ApiServerWeb.ConnCase, async: true
end
```
No `test/2`, `describe/2`, or assertion of any kind is present.

**Note:** `ApiServerWeb.PageView` has no explicitly defined functions (the module body is `use ApiServerWeb, :view` only), so the injected macro-generated helpers from the view layer are also untested.

---

### B024-5

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** `clean_xml_value/1` (line 28) has no tests for either branch: the `value == %{}` branch (returns `nil`) and the default branch (returns the value unchanged). This function is referenced as a utility but never exercised.

**Evidence:** No test file references `clean_xml_value` anywhere in the test suite. The function has two distinct cond branches.

---

### B024-6

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** `clean_xml_number_value/1` (line 37) has no tests for either branch: the `value == %{}` branch (returns `0`) and the default branch (returns the value unchanged). This function mirrors `clean_xml_value/1` with different sentinel output and is similarly untested.

**Evidence:** No test file references `clean_xml_number_value` anywhere in the test suite.

---

### B024-7

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** The `render("service.json", ...)` clause (line 46) contains multi-branch conditional logic with four distinct execution paths that are all untested:

1. `is_integer(record.hardwareid)` is true AND `Vx.get_vx_thing_with_hardware_id!` returns a non-nil thing — vehicle name and fleets are derived from the thing record.
2. `is_integer(record.hardwareid)` is true AND `Vx.get_vx_thing_with_hardware_id!` returns `nil` — vehicle name falls back to `record.hardwareid`, fleets become `[]`.
3. `is_integer(record.hardwareid)` is false — vehicle name is `record.hardwareid`, fleets are `[]`.
4. `record.user` is non-nil — user name is composed from `aacfname <> " " <> aacsurname`.
5. `record.user` is nil — user name falls back to `record.abluser`.

None of these paths are tested.

---

### B024-8

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/geofence_view.ex`
**Finding:** `render("geofence_events.json", ...)` (line 22) delegates to `VXThingView.render("rhm_thing.json", ...)` via `render_one/3`. The interaction between `GeofenceView` and `VXThingView` is untested, meaning any contract mismatch between the two views would not be detected.

**Evidence:** No test exercises `"geofence_events.json"` rendering or the cross-view delegation.

---

### B024-9

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/geofence_view.ex`
**Finding:** `render("geofence.json", ...)` (line 13) calls `Geofence.geojson_db_string_to_map/1` (line 18). There are no tests verifying the rendered output when this function returns a valid map, when the geofence has no geometry, or when the geojson field contains malformed data.

**Evidence:** No test exercises `"geofence.json"` rendering. The return value of `geojson_db_string_to_map/1` is passed directly into the response map without validation or error handling.

---

### B024-10

**Severity:** LOW
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** `render("services.json", ...)` (line 22) is untested for the edge case of an empty `records` list. An empty list would produce an empty JSON array; a non-empty list with mixed `hardwareid` types would exercise all branches of `render("service.json", ...)`. Neither case is covered.

---

### B024-11

**Severity:** LOW
**File:** `lib/api_server_web/views/geofence_view.ex`
**Finding:** `render("index.json", ...)` (line 9) is untested for the edge case of an empty `geofences` list. `render_many/3` on an empty list returns `[]`; this is the minimal valid response and is not verified.

---

### B024-12

**Severity:** LOW
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** `render("index.json", ...)` (line 8) wraps its output in a `%{data: ...}` envelope, while `render("services.json", ...)` (line 22) returns a bare list with no envelope. This inconsistency in response shape is untested and could cause client-side contract bugs that would go undetected.

---

### B024-13

**Severity:** INFO
**File:** `lib/api_server_web/views/layout_view.ex`
**Finding:** The module contains no explicitly defined functions; it is a standard Phoenix-generated scaffold. The empty test file is consistent with Phoenix generator output and represents a known generator artifact. However, if the application renders HTML layouts, integration-level rendering smoke tests would be appropriate.

---

### B024-14

**Severity:** INFO
**File:** `lib/api_server_web/views/page_view.ex`
**Finding:** The module contains no explicitly defined functions; it is a standard Phoenix-generated scaffold. The empty test file is consistent with Phoenix generator output. If the application serves any HTML pages, at least a basic render test would confirm the view resolves correctly.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B024-1 | HIGH | geofence_view.ex | No test file and no indirect coverage; module entirely untested |
| B024-2 | HIGH | vx_abl_record_view.ex | No test file and no indirect coverage; module entirely untested |
| B024-3 | HIGH | layout_view.ex | Dedicated test file is empty (zero test cases) |
| B024-4 | HIGH | page_view.ex | Dedicated test file is empty (zero test cases) |
| B024-5 | MEDIUM | vx_abl_record_view.ex | `clean_xml_value/1` both branches untested |
| B024-6 | MEDIUM | vx_abl_record_view.ex | `clean_xml_number_value/1` both branches untested |
| B024-7 | MEDIUM | vx_abl_record_view.ex | `render("service.json", ...)` multi-branch logic entirely untested |
| B024-8 | MEDIUM | geofence_view.ex | Cross-view delegation to `VXThingView` in `render("geofence_events.json", ...)` untested |
| B024-9 | MEDIUM | geofence_view.ex | `render("geofence.json", ...)` with `geojson_db_string_to_map/1` call untested |
| B024-10 | LOW | vx_abl_record_view.ex | `render("services.json", ...)` empty list edge case untested |
| B024-11 | LOW | geofence_view.ex | `render("index.json", ...)` empty list edge case untested |
| B024-12 | LOW | vx_abl_record_view.ex | Inconsistent response envelope shape across render clauses untested |
| B024-13 | INFO | layout_view.ex | Scaffold-only module; empty test is a generator artifact |
| B024-14 | INFO | page_view.ex | Scaffold-only module; empty test is a generator artifact |
