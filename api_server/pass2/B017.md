# Audit Report B017
**Audit run:** 2026-02-27-01
**Agent:** B017 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/controllers/vx_abl_record_controller.ex`
2. `lib/api_server_web/controllers/vx_access_fob_controller.ex`
3. `lib/api_server_web/controllers/vx_customer_controller.ex`

---

## Test Coverage Search

The full test directory was searched for all module names, controller names, and every public function name defined in the three source files. No matches were found in any test file.

Test files present in the repository:
- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`
- `test/test_helper.exs`

None of these files reference any module, function, or alias from the three assigned controllers.

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/vx_abl_record_controller.ex`

**Module:** `ApiServerWeb.VXAblRecordController`

**Aliases / dependencies:**
- `ApiServer.Vx`
- `ApiServer.Vx.VXAblRecord`
- `ApiServerWeb.FallbackController` (action_fallback)
- `ApiServer.Guardian.Plug` (JWT claims)
- `Timex` (date shifting / between?)
- `NaiveDateTime`, `Date`, `DateTime`
- `ApiServer.Vx` context functions: `create_vx_abl_record/1`, `get_vx_abl_record!/1`, `update_vx_abl_record/2`, `delete_vx_abl_record/1`, `list_service_records/1`, `get_hardwareids_in_fleet/2`, `get_vx_user_offset/2`, `get_branch_for_thing/2`, `fetch_actual_usage/5`, `create_abl_record/2`

**Public functions defined:**

| Line | Name | Signature |
|------|------|-----------|
| 9    | `create/2` | `(conn, %{"vx_abl_record" => vx_abl_record_params})` |
| 18   | `show/2` | `(conn, %{"id" => id})` |
| 23   | `update/2` | `(conn, %{"id" => id, "vx_abl_record" => vx_abl_record_params})` |
| 31   | `delete/2` | `(conn, %{"id" => id})` |
| 38   | `rhm_service_records/2` | `(conn, params)` |
| 66   | `generate_service_record/3` | `(conn, thing, new_service_date)` |

**Types / structs / constants defined:** None directly in this file.

**Notable logic in `rhm_service_records/2`:**
- Reads JWT customer claim.
- Optionally filters by `fleet_id` parameter.
- Optionally filters by `from`/`to` date range (parsed with `Date.from_iso8601!`, shifted via `Timex.shift`).
- Multi-step pipeline: expand XML to struct, filter nil `hardwareid`, filter nil/malformed `new_service_date` (must be exactly 10 chars), filter by fleet membership, filter by date range.

**Notable logic in `generate_service_record/3`:**
- Reads JWT customer and user_id claims.
- Looks up user timezone.
- Builds XML string for service record.
- Conditionally computes `current_hour_meter` and `input_one_hour_meter` from `thing.summary` (nil-guarded).
- Computes `usage` via `fetch_actual_usage/5` only when `existing_service_date` is non-nil.
- Returns the status atom from `create_abl_record/2`.

---

### File 2: `lib/api_server_web/controllers/vx_access_fob_controller.ex`

**Module:** `ApiServerWeb.VXAccessFobController`

**Aliases / dependencies:**
- `ApiServer.Vx`
- `ApiServer.Vx.VXAccessFob`
- `ApiServerWeb.FallbackController` (action_fallback)
- `ApiServer.Vx` context functions: `list_vxaccessfobs/0`, `get_vx_access_fob!/1`, `delete_vx_access_fob/1`

**Public functions defined:**

| Line | Name | Signature |
|------|------|-----------|
| 9    | `index/2` | `(conn, _params)` |
| 14   | `show/2` | `(conn, %{"id" => id})` |
| 19   | `delete/2` | `(conn, %{"id" => id})` |

**Types / structs / constants defined:** None.

**Notable observations:**
- `index/2` lists all access fobs with no customer/tenant scoping; there is no JWT claim extraction.
- No `create` or `update` action is present; this is intentional (fobs are presumably created elsewhere).

---

### File 3: `lib/api_server_web/controllers/vx_customer_controller.ex`

**Module:** `ApiServerWeb.VXCustomerController`

**Aliases / dependencies:**
- `ApiServer.Vx`
- `ApiServer.Vx.VXCustomer`
- `ApiServerWeb.FallbackController` (action_fallback)
- `ApiServer.Guardian.Plug` (JWT claims)
- `ApiServer.Vx` context functions: `list_customers/1`, `create_vx_customer/2`, `get_vx_customer!/2`, `update_vx_customer/3`, `delete_vx_customer/2`
- `VXCustomer.convert_json_to_changeset/1`

**Public functions defined:**

| Line | Name | Signature |
|------|------|-----------|
| 9    | `index/2` | `(conn, _params)` |
| 16   | `create/2` | `(conn, %{"customer" => vx_customer})` |
| 32   | `show/2` | `(conn, %{"id" => id})` |
| 39   | `update/2` | `(conn, %{"customer" => vx_customer_params})` |
| 51   | `delete/2` | `(conn, %{"id" => id})` |

**Types / structs / constants defined:** None.

**Notable logic in `create/2`:**
- Uses an explicit `else` branch that catches `{:error, error}` and returns a raw JSON string with `500 Internal Server Error`, bypassing the standard FallbackController and Phoenix view layer (line 26-29).
- `IO.inspect error` is called in the error path (debug output left in production code).

**Notable logic in `update/2`:**
- Extracts the customer id from the body parameter `vx_customer_params["id"]` rather than from the URL path parameter; there is no separate `%{"id" => id}` pattern in the function head.

---

## Findings

---

### B017-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Title:** No test file and zero indirect test coverage for `[REDACTED-AWS-SMTP-PASSWORD]`

**Description:**
There is no direct test file for this controller and no test in the entire test suite references any of its module name, actions, or helper functions. All six public functions (`create/2`, `show/2`, `update/2`, `delete/2`, `rhm_service_records/2`, `generate_service_record/3`) are completely untested.

**Evidence:** Grep for `VXAblRecord`, `vx_abl_record`, `rhm_service_records`, `generate_service_record` across `test/**/*.exs` returned no matches.

---

### B017-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`
**Title:** No test file and zero indirect test coverage for `[REDACTED-AWS-SMTP-PASSWORD]`

**Description:**
There is no direct test file for this controller and no test in the entire test suite references any of its module name, actions, or context calls. All three public functions (`index/2`, `show/2`, `delete/2`) are completely untested.

**Evidence:** Grep for `VXAccessFob`, `vx_access_fob`, `AccessFob` across `test/**/*.exs` returned no matches.

---

### B017-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Title:** No test file and zero indirect test coverage for `[REDACTED-AWS-SMTP-PASSWORD]`

**Description:**
There is no direct test file for this controller and no test in the entire test suite references any of its module name, actions, or context calls. All five public functions (`index/2`, `create/2`, `show/2`, `update/2`, `delete/2`) are completely untested.

**Evidence:** Grep for `VXCustomer`, `vx_customer` across `test/**/*.exs` returned no matches.

---

### B017-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `create/2` (line 9)
**Title:** Error path for `Vx.create_vx_abl_record/1` failure is untested

**Description:**
The `with` expression on line 10 delegates its error case to `FallbackController`. There is no test verifying that a changeset validation failure (e.g., missing required fields, duplicate key) produces the correct HTTP error response. The FallbackController rendering for this specific controller and error shape has never been exercised.

---

### B017-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `show/2` (line 18)
**Title:** Not-found error path for `Vx.get_vx_abl_record!/1` is untested

**Description:**
`get_vx_abl_record!` raises `Ecto.NoResultsError` when the record does not exist. The FallbackController is expected to convert this to a 404, but no test exercises the case of fetching a non-existent abl record ID.

---

### B017-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `update/2` (line 23)
**Title:** Error paths for `update` (not found, changeset error) are untested

**Description:**
Two distinct failure modes exist: (1) `get_vx_abl_record!` raises on a non-existent ID and (2) `update_vx_abl_record` returns `{:error, changeset}`. Neither path has any test coverage.

---

### B017-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `delete/2` (line 31)
**Title:** Error path for `delete` (not found, delete failure) is untested

**Description:**
`get_vx_abl_record!` can raise and `delete_vx_abl_record` can return an error tuple. Neither failure scenario is tested.

---

### B017-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `rhm_service_records/2` (line 38)
**Title:** All branches of `rhm_service_records/2` are untested

**Description:**
This function contains multiple conditional branches covering: presence/absence of `fleet_id`, presence/absence of `from`/`to` date parameters, and multi-stage record filtering. None of the following paths has test coverage:
- Request with no optional parameters (returns all records).
- Request filtered by `fleet_id`.
- Request filtered by date range.
- Request combining both `fleet_id` and date range.

---

### B017-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `generate_service_record/3` (line 66)
**Title:** `generate_service_record/3` is entirely untested

**Description:**
This function contains significant business logic: timezone-aware usage calculation, XML construction, and multiple nil-guard branches. None of its code paths (success, nil summary, nil existing service date, nil branch) has test coverage.

---

### B017-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`
**Function:** `show/2` (line 14), `delete/2` (line 19)
**Title:** Not-found error paths for `get_vx_access_fob!` are untested

**Description:**
Both `show/2` and `delete/2` call `Vx.get_vx_access_fob!(id)` which raises on a missing record. The resulting FallbackController 404 response path has never been tested.

---

### B017-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`
**Function:** `delete/2` (line 19)
**Title:** Delete failure error path is untested

**Description:**
`Vx.delete_vx_access_fob/1` can return `{:error, changeset}` (e.g., if the record has database constraints). The fallback handling of that error tuple is not tested.

---

### B017-12
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `create/2` (line 16)
**Title:** Error path in `create/2` bypasses FallbackController and is untested

**Description:**
The `else` branch (lines 26-29) catches `{:error, error}` and manually sends a raw JSON string with status 500. This path:
(a) is not exercised by any test,
(b) bypasses the standard Phoenix view/FallbackController pipeline, and
(c) calls `IO.inspect error` which emits debug output to stdout in production.
The raw string interpolation `"#{inspect error.errors}"` may produce malformed JSON if the error message contains double-quote characters.

---

### B017-13
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `show/2` (line 32), `update/2` (line 39), `delete/2` (line 51)
**Title:** Not-found error paths for `get_vx_customer!` are untested

**Description:**
All three actions call `Vx.get_vx_customer!(id, customer)` which raises `Ecto.NoResultsError` for unknown IDs. No test exercises the 404 response path for any of these actions.

---

### B017-14
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `update/2` (line 39)
**Title:** Update changeset failure path is untested

**Description:**
`Vx.update_vx_customer/3` returns `{:error, changeset}` on validation failure. This error is delegated to FallbackController (via the `with` expression). No test exercises this path.

---

### B017-15
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `delete/2` (line 51)
**Title:** Delete failure path is untested

**Description:**
`Vx.delete_vx_customer/2` can return an error tuple (e.g., foreign key constraint). No test exercises this failure path.

---

### B017-16
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `rhm_service_records/2` (line 38)
**Title:** Edge cases in date parsing within `rhm_service_records/2` are untested

**Description:**
`Date.from_iso8601!` is called with user-supplied `params["from"]` and `params["to"]` (line 51) and with `record.new_service_date` (line 61). Malformed or out-of-range date strings will raise `ArgumentError` or `MatchError` at runtime. No test covers:
- Invalid ISO 8601 date strings for `from`/`to`.
- `new_service_date` fields that pass the length-10 filter but are not valid ISO 8601 dates.
- Boundary dates (e.g., leap day, end of year).

---

### B017-17
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `generate_service_record/3` (line 66)
**Title:** `thing.aadsvchrs` nil case in arithmetic is untested

**Description:**
Line 144 computes `hours_to_service = thing.aadsvchrs - usage`. If `thing.aadsvchrs` is `nil`, this will raise `ArithmeticError`. No test exercises this nil case. Similarly, `usage` is always an integer/float when `existing_service_date` is non-nil, but `fetch_actual_usage/5` could return unexpected types.

---

### B017-18
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`
**Function:** `index/2` (line 9)
**Title:** `index/2` has no customer/tenant scoping and this is untested

**Description:**
Unlike the other controllers that extract a customer claim from the JWT, `index/2` calls `Vx.list_vxaccessfobs()` with no arguments, returning all access fobs regardless of tenant. There is no test confirming whether this is intentional (global admin endpoint) or an access-control omission. The multi-tenant behaviour (or lack of it) has never been verified by a test.

---

### B017-19
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `create/2` (line 16)
**Title:** Potential JSON injection in manually constructed error response body

**Description:**
Line 28 constructs the response body via string interpolation:
```elixir
"{\"error\": \"error creating customer\", \"reason\": \"#{inspect error.errors}\" }"
```
If `error.errors` contains a double-quote or backslash, the resulting string will be malformed JSON. No test verifies the shape or safety of this error response.

---

### B017-20
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `update/2` (line 39)
**Title:** ID sourced from request body rather than URL path parameter

**Description:**
`update/2` does not pattern-match an `id` from the URL path; instead it reads `vx_customer_params["id"]` from the JSON body (line 42). If the body omits the `id` key, this will be `nil`, and `get_vx_customer!(nil, customer)` behaviour is untested. There is also no test verifying that a mismatch between a URL path ID and a body ID is handled correctly, as the URL path ID is not used at all.

---

## Summary Table

| ID     | Severity | File                              | Area |
|--------|----------|-----------------------------------|------|
| B017-1 | HIGH     | vx_abl_record_controller.ex       | No test coverage at all |
| B017-2 | HIGH     | vx_access_fob_controller.ex       | No test coverage at all |
| B017-3 | HIGH     | vx_customer_controller.ex         | No test coverage at all |
| B017-4 | MEDIUM   | vx_abl_record_controller.ex       | `create` error path untested |
| B017-5 | MEDIUM   | vx_abl_record_controller.ex       | `show` not-found untested |
| B017-6 | MEDIUM   | vx_abl_record_controller.ex       | `update` error paths untested |
| B017-7 | MEDIUM   | vx_abl_record_controller.ex       | `delete` error paths untested |
| B017-8 | MEDIUM   | vx_abl_record_controller.ex       | `rhm_service_records` all branches untested |
| B017-9 | MEDIUM   | vx_abl_record_controller.ex       | `generate_service_record` entirely untested |
| B017-10| MEDIUM   | vx_access_fob_controller.ex       | `show`/`delete` not-found untested |
| B017-11| MEDIUM   | vx_access_fob_controller.ex       | `delete` failure path untested |
| B017-12| MEDIUM   | vx_customer_controller.ex         | `create` error bypasses FallbackController, untested |
| B017-13| MEDIUM   | vx_customer_controller.ex         | `show`/`update`/`delete` not-found untested |
| B017-14| MEDIUM   | vx_customer_controller.ex         | `update` changeset failure untested |
| B017-15| MEDIUM   | vx_customer_controller.ex         | `delete` failure path untested |
| B017-16| LOW      | vx_abl_record_controller.ex       | Date parsing edge cases untested |
| B017-17| LOW      | vx_abl_record_controller.ex       | `generate_service_record` nil arithmetic |
| B017-18| LOW      | vx_access_fob_controller.ex       | `index` tenant scoping unverified by tests |
| B017-19| LOW      | vx_customer_controller.ex         | JSON injection in error response body |
| B017-20| LOW      | vx_customer_controller.ex         | `update` ID sourced from body, nil case untested |

**Total findings: 20**
**HIGH: 3 | MEDIUM: 12 | LOW: 5**
