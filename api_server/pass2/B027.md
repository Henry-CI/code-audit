# Audit Report B027
**Audit Run:** 2026-02-27-01
**Agent:** B027 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/views/vx_thing_summary_view.ex`
2. `lib/api_server_web/views/vx_thing_view.ex`
3. `lib/api_server_web/views/vx_user_function_view.ex`
4. `lib/api_server_web/views/vx_user_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_thing_summary_view.ex`

**Module:** `ApiServerWeb.VXThingSummaryView`

**Uses / Aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXThingSummaryView` (line 3)

**Functions defined:**

| Line | Function Signature |
|------|--------------------|
| 5    | `render("index.json", %{vxthingsummaries: vxthingsummaries})` |
| 9    | `render("show.json", %{vx_thing_summary: vx_thing_summary})` |
| 13   | `render("vx_thing_summary.json", %{vx_thing_summary: vx_thing_summary})` |
| 57   | `render("rhm_thing_summary.json", %{vx_thing_summary: summary})` |

**Types / Constants:** None defined explicitly.

**Notes:**
- `render/2` with `"vx_thing_summary.json"` serializes 32 fields from the summary struct (lines 14–53).
- `render/2` with `"rhm_thing_summary.json"` produces a restructured nested map (lines 57–122), including nested sub-maps for `current_operator`, `gps`, `hour_meters` (with sub-inputs 0–4, odometer, omega, canbus).

---

### File 2: `lib/api_server_web/views/vx_thing_view.ex`

**Module:** `ApiServerWeb.VXThingView`

**Uses / Aliases:**
- `use ApiServerWeb, :view` (line 2)
- `use Timex` (line 3)
- `alias ApiServerWeb.VXThingView` (line 4)
- `alias ApiServerWeb.VXThingSummaryView` (line 5)

**Functions defined:**

| Line | Function Signature |
|------|--------------------|
| 8    | `render("index.json", %{vxthings: vxthings})` |
| 12   | `render("show.json", %{vx_thing: vx_thing})` |
| 16   | `render("fleet_map.json", %{vxthings: vxthings})` (collection) |
| 20   | `render("fleet_map.json", %{vx_thing: thing})` (single; pattern-matched tuple `{vx_thing, usage}`) |
| 105  | `render("hardware_with_checklists.json", %{vx_things: vx_things})` |
| 109  | `render("pm_data.json", %{vx_things: vx_things})` (collection) |
| 113  | `render("pm_data.json", %{vx_thing: vx_thing})` (single) |
| 147  | `render("movements.json", %{movements: movements})` |
| 150  | `render("movement.json", %{vx_thing: movement})` |
| 164  | `render("checklists.json", %{checklists: checklists})` |
| 168  | `render("vx_checklist.json", %{vx_thing: checklist})` |
| 176  | `render("vx_thing.json", %{vx_thing: vx_thing})` |
| 220  | `render("rhm_thing_usage.json", %{usage: usage})` |
| 224  | `render("rhm_thing_usage_manual.json", %{usage: usage, hardwareid: hardwareid, customer: customer})` |
| 228  | `render("usage_report.json", %{vx_thing: [...]})` (12-element destructured list) |
| 265  | `render("usage_report_many.json", %{vx_thing: [...], hardwareid: hardwareid, customer: customer})` (12-element list + extras) |
| 292  | `render("rhm_things_usage.json", %{usage_by_hardwareid: usages})` |
| 315  | `render("rhm_thing_events.json", %{events: events})` |
| 318  | `render("event_report.json", %{vx_thing: event})` |
| 351  | `render("rhm_thing.json", %{vx_things: vx_things})` (collection) |
| 354  | `render("rhm_thing.json", %{vx_thing: {vx_thing, usage_data}})` (single tuple) |
| 359  | `render("basic_thing.json", %{vx_thing: nil})` (nil guard clause) |
| 360  | `render("basic_thing.json", %{vx_thing: vx_thing})` |
| 396  | `render("sielift_wip_export.json", %{vx_thing: wip_reports})` |
| 434  | `render("pape_exports.json", %{vx_thing: vx_things})` |
| 437  | `render("pape_export.json", %{vx_thing: [aadserialno, aadhardwareid, abmgmtdatetime, engine_hours]})` |
| 449  | `render("rhm_things_names.json", %{vx_things: vx_things})` |
| 453  | `render("things_only.json", %{thing_records: thing_records})` |
| 487  | `info_to_map(thing_info)` (public helper) |
| 499  | `thing_to_map(vx_thing, usage_data)` (public helper) |

**Types / Constants:** None defined explicitly.

**Notes:**
- `render("fleet_map.json", %{vx_thing: thing})` (line 20): contains branching logic via `cond`; when `vx_thing.summary != nil` it performs arithmetic (`round/1`, division) that can raise `ArithmeticError` or `FunctionClauseError` if `usage.average_weekly_usage` is zero or nil (partially guarded).
- `render("pm_data.json", %{vx_thing: vx_thing})` (line 113): guards `nil` explicitly but performs `Float.round/1` and division without further nil-guard on numeric fields once the outer `cond` passes.
- `render("usage_report.json", ...)` and `render("usage_report_many.json", ...)` (lines 228, 265): `case category do` matches only integers 2–5 (input0–input4) with no `_` catch-all; an unexpected category value will raise `CaseClauseError`.
- `render("event_report.json", ...)` (line 318): `cond` on `event.eventtype` is well-structured but the inner `case event.eventcode` has a `_` wildcard.
- `thing_to_map/2` (line 499): contains a dead-code guard `if vx_thing == nil` (line 541) that is unreachable because pattern-matching earlier already dereferences `vx_thing` fields; the guard silently returns `%{}` and will never fire in practice, masking any actual `nil` passed directly.
- Large block of commented-out code retained in production source (lines 507–532).

---

### File 3: `lib/api_server_web/views/vx_user_function_view.ex`

**Module:** `ApiServerWeb.VXUserFunctionView`

**Uses / Aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXUserFunctionView` (line 3)

**Functions defined:**

| Line | Function Signature |
|------|--------------------|
| 5    | `render("index.json", %{vxaatuserfunctions: vxaatuserfunctions})` |
| 9    | `render("show.json", %{vx_user_function: vx_user_function})` |
| 13   | `render("vx_user_function.json", %{vx_user_function: vx_user_function})` |

**Types / Constants:** None defined explicitly.

---

### File 4: `lib/api_server_web/views/vx_user_view.ex`

**Module:** `ApiServerWeb.VXUserView`

**Uses / Aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXUserView` (line 3)

**Functions defined:**

| Line | Function Signature |
|------|--------------------|
| 5    | `render("index.json", %{vxusers: vxusers})` |
| 9    | `render("show.json", %{vx_user: vx_user})` |
| 13   | `render("rhm_users.json", %{vx_users: users})` |
| 17   | `render("rhm_user.json", %{vx_user: user})` |
| 58   | `render("fleet_list.json", %{fleet_list: fleet_list})` |

**Types / Constants:** None defined explicitly.

**Notes:**
- `render("rhm_user.json", ...)` (line 17): contains three `cond` branches testing `Map.has_key?/2` for `:jwt`, `:message`, and `:function`; when `:function` is present but `user.function.aatfunction_id` is nil, a `nil` user_level is emitted silently with no validation.
- `render("show.json", ...)` (line 9) uses `render_one/3` (not `%{data: ...}` wrapper), which is inconsistent with `render("index.json", ...)` that wraps in `%{data: ...}`. This pattern asymmetry is not tested.

---

## Test Coverage Search Results

### Search methodology
Searched the entire test directory (`test/`) for:
- Module names: `VXThingSummaryView`, `VXThingView`, `VXUserFunctionView`, `VXUserView` (and snake_case variants)
- Template key strings: `vx_thing_summary`, `rhm_thing_summary`, `fleet_map`, `pm_data`, `usage_report`, `event_report`, `rhm_thing`, `basic_thing`, `sielift_wip`, `pape_export`, `rhm_things_names`, `things_only`, `rhm_user`, `fleet_list`

### Result
**Zero matches found** in any of the five test files present in the repository:
- `test/api_server_web/controllers/calamp_controller_test.exs` — stub module only (no test body)
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — tests `[REDACTED-AWS-SMTP-PASSWORD]` only
- `test/api_server_web/views/layout_view_test.exs` — tests `LayoutView` only
- `test/api_server_web/views/page_view_test.exs` — tests `PageView` only
- `test/test_helper.exs` — ExUnit configuration only

None of the four assigned view modules are exercised by any test, directly or indirectly.

---

## Findings

### B027-1
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`
**Title:** No test coverage whatsoever for `ApiServerWeb.VXThingSummaryView`

No test file exists for this module, and no indirect test coverage was found anywhere in the test suite. All four `render/2` clauses — `"index.json"`, `"show.json"`, `"vx_thing_summary.json"`, and `"rhm_thing_summary.json"` — are completely untested. The `"vx_thing_summary.json"` render maps 32 struct fields; field name errors or omissions would go undetected. The `"rhm_thing_summary.json"` render produces a deeply nested restructuring of the same data into a different shape; no test verifies that both renderings are consistent or correct.

---

### B027-2
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Title:** No test coverage whatsoever for `ApiServerWeb.VXThingView`

No test file exists for this module, and no indirect test coverage was found anywhere in the test suite. This is the largest view in the repository with 29 `render/2` clauses plus two public helper functions (`info_to_map/1`, `thing_to_map/2`). None are exercised by any test.

---

### B027-3
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_user_function_view.ex`
**Title:** No test coverage whatsoever for `ApiServerWeb.VXUserFunctionView`

No test file exists for this module, and no indirect test coverage was found anywhere in the test suite. All three `render/2` clauses are untested.

---

### B027-4
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_user_view.ex`
**Title:** No test coverage whatsoever for `ApiServerWeb.VXUserView`

No test file exists for this module, and no indirect test coverage was found anywhere in the test suite. All five `render/2` clauses, including the JWT-bearing `"rhm_user.json"` render used in authentication flows, are completely untested.

---

### B027-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `render("usage_report.json", ...)` (line 228), `render("usage_report_many.json", ...)` (line 265)
**Title:** Unhandled `category` values cause `CaseClauseError` at runtime

Both `usage_report` render functions destructure a 12-element list and pass `category` into a `case` expression that matches only integer values `2`, `3`, `4`, `5`, and `6`. There is no `_` wildcard/catch-all clause. Any `category` value outside that set (e.g., `nil`, `1`, `7`, or any non-integer) will raise an uncaught `CaseClauseError` at runtime, producing a 500 response to the caller. No test exercises the valid path, let alone the error path.

---

### B027-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `render("fleet_map.json", %{vx_thing: thing})` (line 20)
**Title:** Arithmetic paths when `vx_thing.summary` is nil are untested; silent fallback returns empty string

When `vx_thing.summary` is `nil`, the `cond` at line 22 falls through to `true -> ""` (line 101), returning an empty string `""` rather than a map. This causes `render_many/3` (called at line 17) to produce a list mixing maps and empty strings, which may cause JSON encoding errors or unexpected API responses downstream. No test exercises either the `summary != nil` path or the `nil` path.

---

### B027-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `render("basic_thing.json", %{vx_thing: vx_thing})` (line 360)
**Title:** Unloaded Ecto association path is untested

Line 361 explicitly checks `!Ecto.assoc_loaded?(vx_thing)` and returns `%{}` if the association is not loaded. This defensive path is entirely untested. Callers receiving an empty map when they expected a full thing object would have a silent data loss bug with no coverage to detect it.

---

### B027-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `thing_to_map/2` (line 499)
**Title:** Dead `nil` guard creates silent incorrect behavior; untested

The guard `if vx_thing == nil do %{} else ...` at line 541 is unreachable in practice because the function body already dereferences `vx_thing` fields (e.g., `vx_thing.aadsvchrs`, `vx_thing.fleets`, etc.) before reaching line 541. If `vx_thing` were actually `nil`, the function would crash at first field access, not silently return `%{}`. The guard provides false confidence. No test covers `thing_to_map/2` in any form (nil or non-nil).

---

### B027-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_user_view.ex`
**Function:** `render("rhm_user.json", %{vx_user: user})` (line 17)
**Title:** JWT presence/absence conditional paths are untested

The `"rhm_user.json"` render has three conditional branches testing `Map.has_key?/2`:
1. `:jwt` present vs. absent — determines whether a JWT token is included in the response.
2. `:message` present vs. absent — determines whether a login nag screen message is included.
3. `:function` present/non-nil vs. absent — determines the `user_level` (defaulting to `2`).

The path where `:jwt` is present (login response) is especially security-sensitive: an error in this branch would suppress the token from being returned to the client. None of the three branches are tested in any combination.

---

### B027-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_user_view.ex`
**Function:** `render("show.json", ...)` (line 9) vs. `render("index.json", ...)` (line 5)
**Title:** Asymmetric response envelope between `show` and `index` is untested

`render("index.json", ...)` wraps its result in `%{data: render_many(...)}`, but `render("show.json", ...)` calls `render_one/3` directly without a `%{data: ...}` wrapper. This is inconsistent with the standard Phoenix JSON API convention and with how `VXUserFunctionView` handles the same pair of clauses (lines 5–11 in `vx_user_function_view.ex`, which wraps `show.json` with `%{data: ...}`). No test exercises either clause to catch this discrepancy.

---

### B027-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `render("pm_data.json", %{vx_thing: vx_thing})` (line 113)
**Title:** `nil` vx_thing path returns `%{}` silently; numeric computation paths untested

When `vx_thing` is `nil` (line 114), the function returns an empty map `%{}` with no indication to the caller that the record was missing. When `vx_thing` is non-nil but `summary` or `summary.abmusagesinceservice` is `nil`, `tts` defaults to `0` and `lastmeterreading` defaults to `0`. The mixed-type `Float.round/1` calls (which require float input) could raise `FunctionClauseError` if the underlying DB fields return integers rather than floats. None of these paths are tested.

---

### B027-12
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`
**Function:** `render("vx_thing_summary.json", ...)` vs. `render("rhm_thing_summary.json", ...)`
**Title:** Two renderings of the same struct data are never cross-validated

`"vx_thing_summary.json"` (line 13) and `"rhm_thing_summary.json"` (line 57) render the same underlying struct but produce different shapes. There are no tests verifying that both renderings include all required fields and that no field is accidentally dropped or renamed in one but not the other. Given the 32 flat fields in the first render and the restructured nested form in the second, divergence is a realistic risk during future maintenance.

---

### B027-13
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Title:** Large block of commented-out production code in `thing_to_map/2` (lines 507–532)

Lines 507–532 contain a commented-out `predicted_service_date` computation with multiple `IO.puts` debug calls. The inline comment acknowledges the computation was intentionally deferred due to a known edge-case bug (predicted dates thousands of years in the past when usage is very low). There are no tests and no documentation of what the correct behaviour should be, increasing the risk that the feature will be reintroduced incorrectly in the future.

---

### B027-14
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_user_view.ex`
**Function:** `render("rhm_user.json", ...)` (line 32–37)
**Title:** `user_level` defaults to hardcoded integer `2` when `:function` key is absent; no edge-case coverage

When the `:function` key is absent from the user map, `user_level` silently defaults to `2` (line 36). The meaning of level `2` is not documented. Additionally, when `:function` is present but `user.function.aatfunction_id` is `nil`, `nil` propagates into the `:user_level` field of the response without any explicit guard. No tests cover the `nil` function_id sub-case or verify the default value semantics.

---

## Summary Table

| ID      | Severity | File                             | Description |
|---------|----------|----------------------------------|-------------|
| B027-1  | HIGH     | vx_thing_summary_view.ex         | No tests at all for the module |
| B027-2  | HIGH     | vx_thing_view.ex                 | No tests at all for the module (29 render clauses + 2 helpers) |
| B027-3  | HIGH     | vx_user_function_view.ex         | No tests at all for the module |
| B027-4  | HIGH     | vx_user_view.ex                  | No tests at all for the module |
| B027-5  | MEDIUM   | vx_thing_view.ex                 | `CaseClauseError` on invalid `category` in `usage_report` renderers |
| B027-6  | MEDIUM   | vx_thing_view.ex                 | `fleet_map` returns `""` (not a map) when summary is nil |
| B027-7  | MEDIUM   | vx_thing_view.ex                 | Unloaded Ecto assoc path in `basic_thing` silently returns `%{}` |
| B027-8  | MEDIUM   | vx_thing_view.ex                 | Dead nil guard in `thing_to_map/2` masks real crash path |
| B027-9  | MEDIUM   | vx_user_view.ex                  | JWT / message / function conditional branches in `rhm_user` untested |
| B027-10 | MEDIUM   | vx_user_view.ex                  | `show.json` missing `%{data:}` wrapper, inconsistent with `index.json` |
| B027-11 | MEDIUM   | vx_thing_view.ex                 | `pm_data` nil/numeric edge cases untested; possible `FunctionClauseError` |
| B027-12 | LOW      | vx_thing_summary_view.ex         | Two renderings of same struct never cross-validated |
| B027-13 | LOW      | vx_thing_view.ex                 | Dead/commented-out code with known bug left in production source |
| B027-14 | LOW      | vx_user_view.ex                  | `user_level` default and nil `aatfunction_id` path undocumented/untested |
