# Audit Report B021
**Audit Run:** 2026-02-27-01
**Agent:** B021 (Pass 2)
**Files Reviewed:**
- `lib/api_server_web/resolvers/puls.ex`
- `lib/api_server_web/resolvers/things.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server_web/resolvers/puls.ex`

**Module:** `ApiServerWeb.Resolvers.Puls`

**Public Functions Defined:**

| Function | Arity | Line |
|----------|-------|------|
| `puls_record/3` | 3 | 3 |

**Types / Structs / Constants:**
- Hardcoded Base64 API token on line 4: `token = "VHJhY2tpbmdTb2x1dGlvbnM6U2tQREk4ZXo="`
- Hardcoded external API base URL on line 5: `"https://puls.calamp.com/service2/lmu/#{hardwareid}"`
- No module-level constants, structs, or typespecs defined.

**Behaviour summary:**
`puls_record/3` accepts a `hardwareid` argument, constructs an HTTP GET request to the CalAMP PULS API using a hardcoded Basic Auth token, decodes the JSON response with `Poison.decode!/1`, and returns `{:ok, record}` containing `esn`, `iccid`, and `group` fields. On `:error` from `HTTPoison.get/3`, it blocks in a `receive/after` block for 60 seconds then recursively calls itself.

---

### File 2: `lib/api_server_web/resolvers/things.ex`

**Module:** `ApiServerWeb.Resolvers.Things`

**Public Functions Defined:**

| Function | Arity | Line |
|----------|-------|------|
| `find_thing/3` | 3 | 3 |
| `get_all_things/3` | 3 | 13 |

**Types / Structs / Constants:**
- No module-level constants, structs, or typespecs defined.

**Behaviour summary:**
- `find_thing/3` accepts `aadhardwareid` and `customer`, delegates to `ApiServer.Vx.get_vx_thing_with_hardware_id!/2`, returns `{:ok, thing}` or `{:error, "Thing with HardwareId ... not found"}` when the result is `nil`.
- `get_all_things/3` accepts `customer`, delegates to `ApiServer.Vx.list_vxthings/1`, returns `{:ok, things}` (with `aadhardwareid` coerced to string via `Integer.to_string/1`) or `{:error, "Error fetching things for ..."}` when the result is `nil`.

---

## TEST COVERAGE INVESTIGATION

**Direct test files:** None exist for either module.

**Indirect coverage search — test directory scanned for:**
- Module names: `Resolvers.Puls`, `ApiServerWeb.Resolvers.Puls`, `Resolvers.Things`, `ApiServerWeb.Resolvers.Things`
- Function names: `puls_record`, `find_thing`, `get_all_things`
- Related symbols: `HTTPoison`, `Poison.decode`, `puls`, `get_vx_thing`, `list_vxthings`

**Result:** Zero matches found across all 5 test files in the test directory.

The only test files present in the repository are:
- `test/api_server_web/controllers/calamp_controller_test.exs` — empty (module body contains no test cases)
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — tests CRUD for `VXRestriction`; no GraphQL resolver coverage
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`
- `test/test_helper.exs`

Neither resolver module is exercised by any existing test.

---

## FINDINGS

---

### B021-1
**Severity:** HIGH
**File:** `lib/api_server_web/resolvers/puls.ex`
**Finding:** No test file exists for `ApiServerWeb.Resolvers.Puls` and zero indirect test coverage was found anywhere in the test suite.
**Detail:** The module `ApiServerWeb.Resolvers.Puls` has no corresponding test file and is not referenced by any existing test. The sole public function `puls_record/3` — which is wired as the resolver for the `:get_puls_record` GraphQL query in `ApiServerWeb.Schema` — is completely untested.

---

### B021-2
**Severity:** HIGH
**File:** `lib/api_server_web/resolvers/things.ex`
**Finding:** No test file exists for `ApiServerWeb.Resolvers.Things` and zero indirect test coverage was found anywhere in the test suite.
**Detail:** The module `ApiServerWeb.Resolvers.Things` has no corresponding test file and is not referenced by any existing test. Both public functions `find_thing/3` and `get_all_things/3` — which are wired as resolvers for `:get_thing` and `:get_all_things` GraphQL queries in `ApiServerWeb.Schema` — are completely untested.

---

### B021-3
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (line 3)
**Finding:** The `:ok` success path of the PULS API call (lines 18–24) is untested.
**Detail:** No test exercises the happy path where `HTTPoison.get/3` returns `{:ok, response}`, `Poison.decode!/1` succeeds, and the function returns `{:ok, %{esn: ..., iccid: ..., group: ...}}`.

---

### B021-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (lines 10–17)
**Finding:** The `:error` retry path is untested.
**Detail:** When `HTTPoison.get/3` returns `{:error, _}`, the function enters a `receive/after` block that blocks the calling process for 60 seconds before recursively retrying. No test exercises this path. This behaviour is also dangerous in production (see B021-7), making test coverage especially important.

---

### B021-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/things.ex`
**Function:** `find_thing/3` (line 3)
**Finding:** Both the success path and the `nil`-not-found error path are untested.
**Detail:** No test exercises `find_thing/3` returning `{:ok, thing}` for a found record, nor returning `{:error, "Thing with HardwareId ... not found"}` when the context returns `nil`.

---

### B021-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/things.ex`
**Function:** `get_all_things/3` (line 13)
**Finding:** Both the success path and the `nil`-error path are untested.
**Detail:** No test exercises `get_all_things/3` returning `{:ok, things}` with the `aadhardwareid` integer-to-string coercion applied, nor the `{:error, "Error fetching things for ..."}` error path when `list_vxthings/1` returns `nil`.

---

### B021-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (lines 10–17)
**Finding:** Unbounded recursive retry on HTTP error creates a process-blocking loop with no termination condition.
**Detail:** On any `HTTPoison` error, the resolver blocks its calling process for 60 seconds via `receive/after` and then calls itself recursively with no retry limit, no backoff cap, and no circuit-breaker. If the remote PULS service is persistently unavailable, this will permanently block the GraphQL request-handling process and accumulate stack frames indefinitely. No test verifies or documents the intended retry behaviour or its limits.

---

### B021-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (line 19)
**Finding:** `Poison.decode!/1` (bang form) is used without rescue; a malformed or unexpected API response will raise an unhandled exception.
**Detail:** If the PULS API returns a non-JSON body, an empty body, or a JSON object missing the keys `"esn"`, `"iccid"`, or `"group"`, `Poison.decode!/1` or `Map.fetch!/2` will raise a runtime exception that propagates unhandled to the caller. No test exercises these failure paths.

---

### B021-9
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (line 4)
**Finding:** API credentials are hardcoded as a plaintext Base64 string in source code.
**Detail:** The Basic Auth token `"VHJhY2tpbmdTb2x1dGlvbnM6U2tQREk4ZXo="` is committed in source. No test covers the case where the credential is rotated, missing from the environment, or invalid, because it cannot be injected or mocked in the current design.

---

### B021-10
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/things.ex`
**Function:** `get_all_things/3` (line 18)
**Finding:** The `Integer.to_string/1` coercion of `aadhardwareid` is untested for edge cases.
**Detail:** No test verifies the coercion behaviour when `aadhardwareid` is `0`, a negative integer, or already a string (which would cause `Integer.to_string/1` to raise `ArgumentError`). The schema defines `aadhardwareid` as `:string` on the GraphQL type but the underlying database field is an integer, making this conversion critical to the API contract.

---

### B021-11
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/things.ex`
**Function:** `find_thing/3` (line 3)
**Finding:** The `nil`-guard pattern for the not-found case may not behave as expected given the function is named with a bang (`get_vx_thing_with_hardware_id!`).
**Detail:** The delegated context function `ApiServer.Vx.get_vx_thing_with_hardware_id!/2` uses the Elixir convention of a trailing `!` to indicate it raises on error rather than returning `nil`. The `nil ->` branch in the `case` statement would therefore be unreachable if the function raises on not-found, meaning the intended error handling path `{:error, "Thing with HardwareId ... not found"}` would never be returned. No test verifies which behaviour actually occurs.

---

### B021-12
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (line 5)
**Finding:** No test covers the case where `hardwareid` is an empty string or contains characters that would produce an invalid URL.
**Detail:** The `hardwareid` argument is interpolated directly into the URL path with no validation or encoding. An empty string, whitespace, or URL-unsafe characters would produce a malformed request to the PULS API with no error guard before the HTTP call.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B021-1 | HIGH | `resolvers/puls.ex` | No test file; entire module untested |
| B021-2 | HIGH | `resolvers/things.ex` | No test file; entire module untested |
| B021-3 | MEDIUM | `resolvers/puls.ex` | `puls_record/3` success path untested |
| B021-4 | MEDIUM | `resolvers/puls.ex` | `puls_record/3` `:error` retry path untested |
| B021-5 | MEDIUM | `resolvers/things.ex` | `find_thing/3` success and not-found paths untested |
| B021-6 | MEDIUM | `resolvers/things.ex` | `get_all_things/3` success and nil-error paths untested |
| B021-7 | MEDIUM | `resolvers/puls.ex` | Unbounded recursive retry loop — untested and dangerous |
| B021-8 | MEDIUM | `resolvers/puls.ex` | `Poison.decode!` / `Map.fetch!` raise on bad API response; untested |
| B021-9 | LOW | `resolvers/puls.ex` | Hardcoded API credential prevents mocking/rotation testing |
| B021-10 | LOW | `resolvers/things.ex` | `Integer.to_string/1` edge cases untested |
| B021-11 | LOW | `resolvers/things.ex` | Bang-function `nil` guard likely unreachable; untested |
| B021-12 | LOW | `resolvers/puls.ex` | Empty/invalid `hardwareid` not validated before URL construction |
