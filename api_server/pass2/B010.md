# Audit Report B010
**Audit run:** 2026-02-27-01
**Agent:** Pass 2 / B010
**Scope:** `lib/api_server/vx/vx_fleet_association.ex`, `lib/api_server/vx/vx_rayven_message_log.ex`, `lib/api_server/vx/vx_rayven_stream_status.ex`, `lib/api_server/vx/vx_rental.ex`

---

## READING EVIDENCE

### 1. `ApiServer.Vx.VXFleetAssociation`
**File:** `lib/api_server/vx/vx_fleet_association.ex`

**Macros/Callbacks defined:**
- `use Ecto.Schema` (line 5) — injects Ecto schema macros

**Schema defined:** `aaf_groups_things` (line 8)
- Primary key: `aafid` (`:id`, autogenerate: true) — line 7
- Field: `aafcustcode` (`:string`) — line 9
- Association: `belongs_to :fleet` → `ApiServer.Vx.VXFleet`, foreign_key `:aafgroupid`, references `:aaeid` — line 10
- Association: `belongs_to :thing` → `ApiServer.Vx.VXThing`, foreign_key `:aafthingid`, references `:aadid` — line 11

**Public functions defined:** none (schema only; no `changeset/2` or query functions)

**Top-level requires (outside module):**
- `require Ecto.Query` (line 1)
- `require Ecto.Adapters.SQL` (line 2)

---

### 2. `ApiServer.Vx.VXRayvenMessageLog`
**File:** `lib/api_server/vx/vx_rayven_message_log.ex`

**Macros/Callbacks defined:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:** `rayven_message_log` (line 6)
- Primary key: `message_id` (`:id`, autogenerate: true) — line 5
- Field: `message_direction` (`:string`) — line 7
- Field: `message_type` (`:string`) — line 8
- Field: `hardware_id` (`:integer`) — line 9
- Field: `event_id` (`:integer`) — line 10
- Field: `response` (`:string`) — line 11
- Field: `message` (`:string`) — line 12
- Field: `created` (`:utc_datetime`) — line 13

**Public functions defined:**
- `changeset/2` (line 16) — casts `[:message_direction, :message_type, :hardware_id, :event_id, :response, :message]`

**Notable omissions:** `created` field is NOT included in the cast list; no `validate_required` calls.

---

### 3. `ApiServer.Vx.VXRayvenStreamStatus`
**File:** `lib/api_server/vx/vx_rayven_stream_status.ex`

**Macros/Callbacks defined:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:** `rayven_stream_status` (line 6)
- Primary key: `id` (`:id`, autogenerate: true) — line 5
- Field: `thing_id` (`:integer`) — line 7
- Field: `hardware_id` (`:integer`) — line 8
- Field: `last_event` (`:integer`) — line 9
- Field: `last_event_time` (`:utc_datetime`) — line 10
- Field: `streamed_at` (`:utc_datetime`) — line 11
- Field: `delay` (`:integer`) — line 12
- Field: `num_remaining` (`:integer`) — line 13
- Field: `batch` (`:integer`) — line 14

**Public functions defined:**
- `changeset/2` (line 17) — casts all eight fields; no `validate_required` calls

---

### 4. `ApiServer.Vx.VXRental`
**File:** `lib/api_server/vx/vx_rental.ex`

**Macros/Callbacks defined:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:** `abh_rentals` (line 6)
- Primary key: `abhid` (`:id`, autogenerate: true) — line 5
- Field: `abhcustcode` (`:string`) — line 7
- Field: `abhclient` (`:string`) — line 8
- Field: `abhstartdate` (`:date`) — line 9
- Field: `abhenddate` (`:date`) — line 10
- Field: `abhtransdate` (`:utc_datetime`) — line 11
- Field: `abhnotes` (`:string`) — line 12
- Field: `abhrental_freq` (`:string`) — line 13
- Field: `abhallowed_hours` (`:integer`) — line 14
- Field: `abhreport_freq` (`:string`) — line 15
- Field: `abhcustomerid` (`:integer`) — line 16
- Field: `period_calculation` (`:string`) — line 17
- Association: `has_one :customer` → `ApiServer.Vx.VXCustomer`, foreign_key `:aaaid`, references `:abhcustomerid` — line 19
- Association: `belongs_to :thing` → `ApiServer.Vx.VXThing`, foreign_key `:abhthingid`, references `:aadid` — line 20

**Public functions defined:**
- `get_all_anniversaries_between_dates/4` (line 24) — computes list of period anniversary dates between two date strings; dispatches on `period_calculation` ("CALENDAR" vs other) and `abhrental_freq`
- `get_current_rental_period_start/2` (line 112) — returns period start datetime for the current moment in the given timezone
- `calculate_period_end_date/3` (line 119) — shifts a period start datetime forward by one rental frequency unit; handles "28DAY", "MONTHLY", "OTHER", "WEEKLY", "DAILY", "OUT OF CONTRACT", and a default fallback
- `has_anniversary_on_day?/3` (line 146) — returns boolean; true if the given day coincides with a period start
- `generate_previous_period_anniversay/3` (line 246) — public; returns the previous period start date; handles all `abhrental_freq` values with complex end-of-contract edge cases
- `changeset/2` (line 158) — casts rental fields; no `validate_required`

**Private functions defined:**
- `get_all_subsequent_anniversaries/5` (line 77) — recursive tail-accumulation of anniversary list, stops at `to_datetime` or rental end date
- `generate_next_period_anniversay/3` (line 176) — computes next period boundary from a given datetime, respecting `period_calculation` and `abhenddate`
- `calculate_period_start_date/3` (line 468) — returns period start for an arbitrary check datetime; dispatches on all `abhrental_freq` values and `period_calculation`

---

## TEST COVERAGE SEARCH RESULTS

Grep for module names (`VXFleetAssociation`, `VXRayvenMessageLog`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXRental`) across `test/` — **zero matches**.

Grep for public function names (`get_all_anniversaries_between_dates`, `get_current_rental_period_start`, `calculate_period_end_date`, `has_anniversary_on_day`, `generate_previous_period_anniversay`, `changeset`) across `test/` — **zero matches** for any of these functions in connection with the audited modules.

The only test files present in the repository are:
- `test/api_server_web/controllers/calamp_controller_test.exs` — empty module body
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — tests `VXRestriction` only
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`

None of these files reference or indirectly exercise any of the four audited modules.

---

## FINDINGS

### B010-1 — HIGH: `VXFleetAssociation` has no test file and no indirect test coverage

**File:** `lib/api_server/vx/vx_fleet_association.ex`
**Severity:** HIGH

No direct test file exists for `ApiServer.Vx.VXFleetAssociation`. No test in the repository exercises this module at all (confirmed by full grep of test directory for the module name and file name). The schema defines foreign-key associations to both `VXFleet` and `VXThing` that are never exercised by automated tests.

---

### B010-2 — HIGH: `VXRayvenMessageLog` has no test file and no indirect test coverage

**File:** `lib/api_server/vx/vx_rayven_message_log.ex`
**Severity:** HIGH

No direct test file exists for `ApiServer.Vx.VXRayvenMessageLog`. No test in the repository exercises this module. The `changeset/2` function, the schema fields, and the primary-key configuration are entirely untested.

---

### B010-3 — HIGH: `[REDACTED-AWS-SMTP-PASSWORD]` has no test file and no indirect test coverage

**File:** `lib/api_server/vx/vx_rayven_stream_status.ex`
**Severity:** HIGH

No direct test file exists for `ApiServer.Vx.VXRayvenStreamStatus`. No test in the repository exercises this module. The `changeset/2` function and all schema fields are entirely untested.

---

### B010-4 — HIGH: `VXRental` has no test file and no indirect test coverage

**File:** `lib/api_server/vx/vx_rental.ex`
**Severity:** HIGH

No direct test file exists for `ApiServer.Vx.VXRental`. No test in the repository exercises this module despite it being the most functionally complex module in the assigned set. All five public functions and two private functions (totalling hundreds of lines of business logic for rental period calculation) are entirely untested.

---

### B010-5 — MEDIUM: `get_all_anniversaries_between_dates/4` — no test coverage for any code path

**File:** `lib/api_server/vx/vx_rental.ex`, line 24
**Severity:** MEDIUM

This function is used in `vx.ex` (line 882) and `utility_controller.ex` (lines 2172, 3727) and `vx_rental_controller.ex` (line 119). It contains two separate top-level `cond` branches (one for `"CALENDAR"`, one for all other `period_calculation` values), each with three sub-branches (contract starts before period, contract starts after period, contract starts during period). None of these branches are tested.

---

### B010-6 — MEDIUM: `generate_previous_period_anniversay/3` — no test coverage for any code path

**File:** `lib/api_server/vx/vx_rental.ex`, line 246
**Severity:** MEDIUM

This public function is called from `vx.ex` (line 885), `utility_controller.ex` (lines 2181, 3736), and `vx_rental_controller.ex` (lines 67, 122). It contains complex branch logic for every `abhrental_freq` value ("28DAY", "MONTHLY", "OTHER", "WEEKLY", "DAILY", "OUT OF CONTRACT", and a catch-all). The `"MONTHLY"` and `"WEEKLY"` arms each contain nested `period_calculation`-based branches and end-of-contract boundary logic. None of this is tested.

---

### B010-7 — MEDIUM: `calculate_period_end_date/3` — no test coverage for any code path

**File:** `lib/api_server/vx/vx_rental.ex`, line 119
**Severity:** MEDIUM

This public function is called from `utility_controller.ex` (lines 4182, 4345) and `vx_rental_controller.ex` (line 218). It dispatches on six distinct `abhrental_freq` values plus a default. None of these arms are tested.

---

### B010-8 — MEDIUM: `has_anniversary_on_day?/3` — no test coverage for any code path

**File:** `lib/api_server/vx/vx_rental.ex`, line 146
**Severity:** MEDIUM

This public function is called from `vx_rental_controller.ex` (line 65). It delegates to `calculate_period_start_date/3` and computes a day-level diff. Neither the `true` nor `false` return path is tested.

---

### B010-9 — MEDIUM: `get_current_rental_period_start/2` — no test coverage

**File:** `lib/api_server/vx/vx_rental.ex`, line 112
**Severity:** MEDIUM

This public function is called from `vx_rental_controller.ex` (lines 18, 38, 218) and `utility_controller.ex` (lines 4175, 4338). It relies on `Timex.now/1` (wall-clock time) internally, making it time-dependent and requiring mocking or careful fixture setup; no such test exists.

---

### B010-10 — MEDIUM: `VXRental.changeset/2` — no validation tests; `validate_required` absent

**File:** `lib/api_server/vx/vx_rental.ex`, line 158
**Severity:** MEDIUM

`changeset/2` casts eleven fields but performs no `validate_required/2` or any other validation. This means invalid or incomplete structs silently pass changeset validation. There are no tests confirming which fields are required or what constitutes an invalid rental struct. Same issue exists for `VXRayvenMessageLog.changeset/2` (line 16) and `VXRayvenStreamStatus.changeset/2` (line 17).

---

### B010-11 — MEDIUM: `VXRayvenMessageLog.changeset/2` omits `created` field from cast — untested

**File:** `lib/api_server/vx/vx_rayven_message_log.ex`, line 16-19
**Severity:** MEDIUM

The `created` field is declared in the schema (line 13) but is not included in the `cast/3` call. This means `created` can never be set through the changeset. Whether this is intentional (e.g., set at the database level) or an oversight is not documented, and there is no test that would catch a regression if the field were added or removed from the cast list.

---

### B010-12 — MEDIUM: `generate_next_period_anniversay/3` (private) — complex rental end-date capping logic untested

**File:** `lib/api_server/vx/vx_rental.ex`, line 176
**Severity:** MEDIUM

This private function is called by both `get_all_anniversaries_between_dates/4` and `get_all_subsequent_anniversaries/5`. It contains a conditional that clamps the next anniversary to `rental_end_datetime` when the computed next period would exceed the end date (lines 235-243). This capping behaviour is business-critical but never tested.

---

### B010-13 — LOW: `get_all_anniversaries_between_dates/4` — nil/boundary edge cases untested

**File:** `lib/api_server/vx/vx_rental.ex`, line 24
**Severity:** LOW

The following edge cases are unexercised by any test:
- `rental.abhenddate == nil` (open-ended contract) through the full anniversary generation loop
- `to_date` equal to `from_date` (single-day range)
- `rental.abhstartdate` exactly equal to `from_date` or `to_date`
- Invalid ISO 8601 date strings passed as `to_date`/`from_date` (the function calls `Date.from_iso8601!/1` which raises on bad input)

---

### B010-14 — LOW: `calculate_period_start_date/3` — "MONTHLY"/"CONTRACT" branch and unrecognised `period_calculation` value untested

**File:** `lib/api_server/vx/vx_rental.ex`, line 468
**Severity:** LOW

The `"MONTHLY"` arm at line 490 handles both `"CALENDAR"` and `"CONTRACT"` `period_calculation` values, but neither is tested. The `"WEEKLY"` arm uses `Timex.weekday/1` comparison arithmetic (line 590) without tests for week-boundary wrap-around. The default (`_`) arm at line 606 silently falls through to weekly logic; no test documents this behaviour.

---

### B010-15 — LOW: `VXFleetAssociation` has top-level `require` statements outside the module

**File:** `lib/api_server/vx/vx_fleet_association.ex`, lines 1-2
**Severity:** LOW

`require Ecto.Query` and `require Ecto.Adapters.SQL` appear at the top of the file, outside the module definition. These requires affect the entire compilation unit but appear to be unused inside the module (there are no query functions defined). This is a code-quality concern: the requires suggest query functions were planned or removed, and there are no tests to document the intended behaviour of this module beyond schema definition.

---

### B010-16 — LOW: `generate_previous_period_anniversay/3` — note on typo in public API name

**File:** `lib/api_server/vx/vx_rental.ex`, line 246
**Severity:** LOW (INFO)

The public function is spelled `generate_previous_period_anniversay` (missing the last `r` in "anniversary"). The same misspelling appears on the private `generate_next_period_anniversay/3` (line 176). Because these names are referenced across multiple callers in `vx.ex`, `utility_controller.ex`, and `vx_rental_controller.ex`, a rename would require coordinated updates. The absence of any test means this inconsistency has gone undetected and any future renaming would have no safety net.

---

## SUMMARY TABLE

| ID      | Severity | File                          | Description |
|---------|----------|-------------------------------|-------------|
| B010-1  | HIGH     | vx_fleet_association.ex       | No test file; zero test coverage |
| B010-2  | HIGH     | vx_rayven_message_log.ex      | No test file; zero test coverage |
| B010-3  | HIGH     | vx_rayven_stream_status.ex    | No test file; zero test coverage |
| B010-4  | HIGH     | vx_rental.ex                  | No test file; zero test coverage for all business logic |
| B010-5  | MEDIUM   | vx_rental.ex:24               | `get_all_anniversaries_between_dates/4` untested |
| B010-6  | MEDIUM   | vx_rental.ex:246              | `generate_previous_period_anniversay/3` untested |
| B010-7  | MEDIUM   | vx_rental.ex:119              | `calculate_period_end_date/3` untested |
| B010-8  | MEDIUM   | vx_rental.ex:146              | `has_anniversary_on_day?/3` untested |
| B010-9  | MEDIUM   | vx_rental.ex:112              | `get_current_rental_period_start/2` untested; time-dependent |
| B010-10 | MEDIUM   | vx_rental.ex:158 (and others) | `changeset/2` has no `validate_required`; untested |
| B010-11 | MEDIUM   | vx_rayven_message_log.ex:16   | `created` field omitted from `changeset/2` cast; untested |
| B010-12 | MEDIUM   | vx_rental.ex:176              | `generate_next_period_anniversay/3` end-date capping untested |
| B010-13 | LOW      | vx_rental.ex:24               | `get_all_anniversaries_between_dates/4` nil/boundary cases |
| B010-14 | LOW      | vx_rental.ex:468              | `calculate_period_start_date/3` MONTHLY CONTRACT branch and default untested |
| B010-15 | LOW      | vx_fleet_association.ex:1-2   | Top-level `require` outside module; unused; no tests documenting intent |
| B010-16 | LOW      | vx_rental.ex:176,246          | Consistent typo in public/private function names; no test safety net |
