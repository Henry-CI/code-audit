# Audit Report B011
**Audit run:** 2026-02-27-01
**Agent:** B011 (Pass 2)
**Assigned source files:**
- `lib/api_server/vx/vx_restriction.ex`
- `lib/api_server/vx/vx_thing.ex`
- `lib/api_server/vx/vx_thing_event.ex`
- `lib/api_server/vx/vx_thing_event_omega.ex`

---

## Reading Evidence

### File 1: `lib/api_server/vx/vx_restriction.ex`

**Module:** `ApiServer.Vx.VXRestriction`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema:** `"aau_rest"` (line 6)
- Primary key: `aauid` (`:id`, autogenerate: true)
- Fields:
  - `aaucharval` — `:string` (line 7)
  - `aaucustcode` — `:string` (line 8)
  - `aaufun` — `:string` (line 9)
  - `aaunumval` — `:integer` (line 10)
- Associations:
  - `belongs_to :user, ApiServer.Vx.VXUser` — foreign key `aauuser_id`, references `aacid` (line 12)

**Public functions defined:**
| Function | Line | Notes |
|---|---|---|
| `changeset/2` | 16 | Casts `[:aauuser_id, :aaucustcode, :aaufun, :aaucharval, :aaunumval]`; `validate_required([:aauuser_id])` |

---

### File 2: `lib/api_server/vx/vx_thing.ex`

**Module:** `ApiServer.Vx.VXThing`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 6)
- `import Ecto.Changeset` (line 7)
- `alias ApiServer.Vx` (line 8)
- `require Ecto.Query` (line 1)
- `require Ecto.Adapters.SQL` (line 2)

**Schema:** `"aad_thing"` (line 11)
- Primary key: `aadid` (`:id`, autogenerate: true)
- Fields (lines 12–48): `aadcustcode`, `aaddesc`, `aadintext`, `aadaddr`, `aadcustomerid`, `aadcat`, `aadhardwareid`, `aadhw_type`, `aadmake`, `aadmodel`, `aadserialno`, `aadmobile`, `aadimei`, `aadhourmeter`, `aadhourmeter1`–`aadhourmeter4`, `aadhourmeterprnt`, `aadodometer`, `aadhourmeteromega`, `aadhourmeterothcan`, `aaddateintoservice`, `aadlastservice`, `aadvalid`, `aadserviceoffset`, `aadsvchrs`, `aadrange_lat`, `aadrange_long`, `aadrange_dist`, `aadrange_unit`, `service_calculation_input`, `reference_1`, `reference_2`, `reference_3`, `notes`, `equipment_date_into_service`
- Associations:
  - `has_many :fleet_thing_joins` — `ApiServer.Vx.VXFleetAssociation` (line 50)
  - `has_many :rentals` — `ApiServer.Vx.VXRental` (line 51)
  - `has_many :events` — `ApiServer.Vx.VXThingEvent` (line 52)
  - `has_one :summary` — `ApiServer.Vx.VXThingSummary` (line 55)
  - `has_one :info` — `ApiServer.Vx.VXThingInfo` (line 56)
  - `has_one :customer` — `ApiServer.Vx.VXCustomer` (line 57)

**Public functions defined:**
| Function | Line | Notes |
|---|---|---|
| `convert_json_to_changeset/1` | 60 | Builds a bare map `%{}` from a JSON-shaped map using `Vx.update_key_if_value/3` pipeline; returns the map (not an Ecto changeset struct) |
| `changeset/2` | 75 | Casts a fixed subset of fields; no `validate_required` call |

---

### File 3: `lib/api_server/vx/vx_thing_event.ex`

**Module:** `ApiServer.Vx.VXThingEvent`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema:** `"thingevents"` (line 5)
- Primary key: implicit `id` (default Ecto integer)
- Fields (lines 6–51): `gmtdatetime`, `hardwareid`, `eventtype`, `eventcode`, `latitude`, `longitude`, `driverid`, `engineonelapsed`, `totalengineseconds`, `custcode`, `hardwaretype`, `datetimesaved`, `dateinqueue`, `timeoffix`, `altitude`, `heading`, `speed`, `rssi`, `gpsfixquality`, `odometer`, `mifaredriverid`, `ignition`, `ignitionstatus`, `calcengineseconds`, `input1elapsed`–`input4elapsed` (with status/totalseconds/calctotalseconds variants), `prntelapsed`, `prntstatus`, `prnttotalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `geofence`
- Commented-out field: `llpoint` (Geo.Point) (line 52)
- Associations:
  - `has_one :thingeventomega, ApiServer.Vx.VXThingEventOmega` — foreign key `:id`, references `:id` (line 54)
  - `belongs_to :thing, ApiServer.Vx.VXThing` — foreign key `:hardwareid`, references `:aadhardwareid`, `define_field: false` (lines 56–60)

**Public functions defined:**
| Function | Line | Notes |
|---|---|---|
| `map_xml/1` | 71 | Maps a raw string-keyed map (from XML parse) to a typed Elixir map suitable for insertion; uses `String.to_integer/1`, `String.to_float/1`, `DateTime.from_naive!/2`, `NaiveDateTime.from_iso8601!/1`; hardcodes `rhmprestartchecklist: ""` and `geofence: ""`; omits several schema fields (`driverid` uses string interpolation; `mifaredriverid`, `calcengineseconds`, `[REDACTED-AWS-SMTP-PASSWORD]` commented out) |
| `changeset/2` | 111 | Casts all schema fields; `validate_required([:hardwareid])` (line 161) |

---

### File 4: `lib/api_server/vx/vx_thing_event_omega.ex`

**Module:** `ApiServer.Vx.VXThingEventOmega`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema:** `"thingomega"` (line 5)
- Primary key: implicit `id`
- Fields (lines 6–68): `accelerometerx`, `accelerometery`, `accelerometerz`, `[REDACTED-AWS-SMTP-PASSWORD]`, `omegadriverid`, `seatbelt`, `seated`, `parkbrakerequest`, `parkbreakreleased`, `vehicleload`, `tilt`, `height`, `overload`, `attretracted`, `yellowled`, `redled`, `greenled`, `liftenable`, `safetyoverride`, `doorclosed`, `parkbrakerror`, `batterynotcharged`, `lowengineoil`, `accnotcharged`, `[REDACTED-AWS-SMTP-PASSWORD]`, `airfilterblocked`, `attpressure`, `oilcoolerfan`, `lowerinterruption`, `undersafetyheight`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `md3temperature`, `fuellevel`, `md3status`, `xa2status`, `batteryvoltage`, `xa2temperature`, `boomangle`, `boomextension`, `lift`, `extension`, `[REDACTED-AWS-SMTP-PASSWORD]`, `fuelrate`, `totalfuelidle`, `totalidlehour`, `totalenginehour`, `enginerpm`, `capacity`, `coolanttemperature`, `oiltemperature`, `engineerrorcode`, `vehiclespeed`, `gearselection`, `transerrorcode`, `prestartchecklist`, `truckerrorcode`, `mc43status`, `mc43temperature`, `lc5status`, `lc5temperature`, `truckangle`
- Associations:
  - `belongs_to :thingevent, ApiServer.Vx.VXThingEvent` — `foreign_key: :id`, `references: :id`, `primary_key: true`, `define_field: false` (line 69)

**Public functions defined:**
| Function | Line | Notes |
|---|---|---|
| `changeset/2` | 72 | Casts all 64+ fields; `validate_required([:id])` (line 75) |

---

## Test Coverage Summary

| Source file | Dedicated test file | Indirect coverage found |
|---|---|---|
| `vx_restriction.ex` | `vx_restriction_controller_test.exs` (YES) | `changeset/2` exercised indirectly via controller create/update |
| `vx_thing.ex` | None | None — zero test references found |
| `vx_thing_event.ex` | None | None — zero test references found |
| `vx_thing_event_omega.ex` | None | None — zero test references found |

---

## Findings

### B011-1
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing.ex`
**Finding:** No test file exists for `ApiServer.Vx.VXThing`. No test in the entire test suite references the module name, either function, or any of the table/schema names (`aad_thing`, `VXThing`, `convert_json_to_changeset`, `aadcustcode`, etc.).

The module has two public functions (`convert_json_to_changeset/1` and `changeset/2`) and a rich schema with 35+ fields. Neither function is exercised by any test.

---

### B011-2
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Finding:** No test file exists for `ApiServer.Vx.VXThingEvent`. No test in the entire test suite references the module, either public function (`map_xml/1`, `changeset/2`), or the underlying table name (`thingevents`).

---

### B011-3
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_event_omega.ex`
**Finding:** No test file exists for `ApiServer.Vx.VXThingEventOmega`. No test in the entire test suite references the module, its only public function (`changeset/2`), or the underlying table name (`thingomega`).

---

### B011-4
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Function:** `map_xml/1` (line 71)
**Finding:** `map_xml/1` is entirely untested. This function uses several bang functions that will raise on malformed input:
- `NaiveDateTime.from_iso8601!/1` — raises `ArgumentError` if the string is not a valid ISO 8601 datetime
- `DateTime.from_naive!/2` — raises if the naive datetime or timezone is invalid
- `String.to_integer/1` — raises `ArgumentError` if the string cannot be parsed as an integer
- `String.to_float/1` — raises `ArgumentError` if the string cannot be parsed as a float

There are no tests verifying that `map_xml/1` returns the correct structure with a well-formed input, and no tests verifying behaviour (or failure) when any required key is missing or malformed.

---

### B011-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing.ex`
**Function:** `convert_json_to_changeset/1` (line 60)
**Finding:** `convert_json_to_changeset/1` is entirely untested. The function returns a plain `%{}` map (not an Ecto changeset) constructed via a pipeline of `Vx.update_key_if_value/3` calls. There are no tests verifying:
- That the correct keys are populated from corresponding JSON keys.
- Behaviour when JSON keys are missing or `nil` (the logic depends on `Vx.update_key_if_value/3` semantics for nil values).
- That the returned map is correctly shaped for downstream use.

---

### B011-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing.ex`
**Function:** `changeset/2` (line 75)
**Finding:** `changeset/2` for `VXThing` is entirely untested. Unlike `VXRestriction.changeset/2`, there is no controller test or any other test that exercises this function. Notably, the changeset has no `validate_required/2` call, meaning a struct with all nil fields would pass validation — this design decision is not covered by any test.

---

### B011-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Function:** `changeset/2` (line 111)
**Finding:** `changeset/2` for `VXThingEvent` is entirely untested. The function casts a very large set of fields (49 fields) and validates only `:hardwareid`. There are no tests verifying the required-field validation or that the cast fields are accepted/rejected correctly.

---

### B011-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_event_omega.ex`
**Function:** `changeset/2` (line 72)
**Finding:** `changeset/2` for `VXThingEventOmega` is entirely untested. The function casts 64+ fields and validates only `:id`. The use of `:id` as both primary key and foreign key (`belongs_to :thingevent`, `primary_key: true`) is an unusual pattern with no test confirming correct persistence or validation behaviour.

---

### B011-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_restriction.ex`
**Function:** `changeset/2` (line 16)
**Finding:** The `changeset/2` function is exercised only indirectly through the controller test (`vx_restriction_controller_test.exs`) via `Vx.create_vx_restriction/1` and `Vx.update_vx_restriction/2`. There is no direct unit test of `VXRestriction.changeset/2` itself. Specifically:
- The `@invalid_attrs` test sets all fields to `nil`, which tests `validate_required([:aauuser_id])` via the controller path, but no test covers a case where `aauuser_id` is present but other optional fields take boundary values (empty string, 0, very large integer).
- The `@create_attrs` fixture includes `aauid: 42` in the test map, but `aauid` is the auto-generated primary key and is not in the `cast/3` field list — this inconsistency is untested at the schema level.

---

### B011-10
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Function:** `map_xml/1` (line 71)
**Finding:** Several schema fields present in `changeset/2` are explicitly omitted from `map_xml/1` with inline comments (lines 103–106):
- `driverid` is populated via string interpolation `"#{data["driverid"]}"` rather than direct assignment, meaning a `nil` value in the source would silently become the string `""`.
- `mifaredriverid`, `calcengineseconds`, and `[REDACTED-AWS-SMTP-PASSWORD]` are commented out entirely with the note "need the thing record for this one".

These omissions and silent coercions are not validated by any test.

---

### B011-11
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event_omega.ex`
**Schema:** `"thingomega"` (line 5)
**Finding:** The `[REDACTED-AWS-SMTP-PASSWORD]` field (line 9) is declared in the schema but is absent from the `cast/3` call in `changeset/2` (line 74). This means the field can never be set via the changeset. This discrepancy is undocumented and untested.

---

### B011-12
**Severity:** LOW
**File:** `lib/api_server/vx/vx_restriction.ex`
**Finding:** There is no test covering the `belongs_to :user` association (line 12). No test verifies behaviour when the referenced `VXUser` record does not exist (referential integrity), or that the foreign key constraint fires correctly. The controller test fixture uses `aauuser_id: 42` directly without creating a corresponding user record, which may indicate the database is not enforcing the foreign key or the association logic is untested end-to-end.

---

### B011-13
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing.ex`
**Finding:** `require Ecto.Query` (line 1) and `require Ecto.Adapters.SQL` (line 2) appear at the top level outside the module, meaning they affect the compilation unit but no functions in the module use raw SQL queries or dynamic Ecto.Query macros. This dead `require` usage is not flagged by any test and may indicate removed or planned functionality with no coverage.

---

### B011-14
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Finding:** The `llpoint` field (line 52) is commented out: `# field :llpoint, Geo.Point`. This suggests a `Geo` PostGIS integration was planned or previously implemented. There is no test and no documentation explaining why this field is disabled. The `geofence` field (line 51) is a `:string` that silently receives an empty string `""` from `map_xml/1`, suggesting the geo logic may be partially stubbed.

---

### B011-15
**Severity:** INFO
**File:** `lib/api_server/vx/vx_restriction_controller_test.exs`
**Finding:** The controller test references `vx_restriction_path(conn, :show, id)` after create (line 32) and checks the response body includes `"aauid" => 42`. However, `aauid` is the auto-generated primary key (`@primary_key {:aauid, :id, autogenerate: true}`), and the `@create_attrs` fixture specifies `aauid: 42`. Since `aauid` is the primary key and is autogenerated, attempting to set it via `cast` (which does not include `aauid` in the cast list) should have no effect, and the actual generated ID would differ from `42`. The test assertion `"aauid" => 42` is likely incorrect and would fail if run, or the view is rendering a value from `@create_attrs` rather than the persisted record. This is an existing test correctness issue.
