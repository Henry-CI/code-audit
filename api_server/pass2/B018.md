# Audit Report B018 — Test Coverage Analysis
**Audit run:** 2026-02-27-01
**Agent:** B018
**Pass:** 2
**Scope:** Controller test coverage for four VX controllers

---

## Source Files Audited

| # | File |
|---|------|
| 1 | `lib/api_server_web/controllers/vx_fleet_association_controller.ex` |
| 2 | `lib/api_server_web/controllers/vx_fleet_controller.ex` |
| 3 | `lib/api_server_web/controllers/vx_rental_controller.ex` |
| 4 | `lib/api_server_web/controllers/vx_restriction_controller.ex` |

---

## Reading Evidence

### 1. ApiServerWeb.VXFleetAssociationController
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`

**Module aliases:**
- `ApiServer.Vx` (alias `Vx`)
- `ApiServer.Vx.VXFleetAssociation` (alias `VXFleetAssociation`)

**Fallback:** `action_fallback ApiServerWeb.FallbackController`

**Public functions defined:**

| Function | Arity | Line |
|----------|-------|------|
| `index/2` | 2 | 9 |
| `show/2` | 2 | 14 |
| `delete/2` | 2 | 19 |

**Types / structs / constants defined:** None.

**Notes:**
- `index/2` calls `Vx.list_vxfleetassociations()` and renders `"index.json"`.
- `show/2` calls `Vx.get_vx_fleet_association!(id)` — the bang form will raise on not-found, delegating error handling to `FallbackController`.
- `delete/2` calls `Vx.get_vx_fleet_association!(id)` (bang) then `Vx.delete_vx_fleet_association/1` inside a `with`; returns 204 on success; the `with` failure case falls to `FallbackController`.

---

### 2. ApiServerWeb.VXFleetController
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`

**Module aliases:**
- `ApiServer.Vx` (alias `Vx`)
- `ApiServer.Vx.VXFleet` (alias `VXFleet`)

**Fallback:** `action_fallback ApiServerWeb.FallbackController`

**Public functions defined:**

| Function | Arity | Line | Notes |
|----------|-------|------|-------|
| `create/2` | 2 | 9 | Pattern matches `%{"vx_fleet" => vx_fleet_params}` |
| `get_fleets/2` | 2 | 19 | Clause 1: pattern matches `%{"admin" => "1"}` — admin list |
| `get_fleets/2` | 2 | 27 | Clause 2: catch-all — user-scoped list |
| `get_fleets_with_equipment/2` | 2 | 35 | Returns fleets with nested equipment list |
| `create_fleet/2` | 2 | 68 | Pattern matches `%{"customer" => cust, "fleet" => fleet_params}` |
| `delete_fleet/2` | 2 | 91 | Pattern matches `%{"customer" => customer, "id" => id}` |
| `get_equipment_in_fleet/2` | 2 | 105 | Pattern matches `%{"customer" => customer, "id" => fleet_id}` |
| `manage_fleet/2` | 2 | 110 | Pattern matches `%{"customer" => customer, "id" => fleet_id, "equip_in_fleet" => ids_in_fleet}` |
| `update_fleet/2` | 2 | 119 | Pattern matches `%{"customer" => customer, "fleet" => fleet_params}` |

**Types / structs / constants defined:** None.

**Key internal logic:**
- `create_fleet/2` (line 76): explicit duplicate-name guard — returns 500 if `length(fleets_with_same_name) > 0`.
- `delete_fleet/2` (line 93): explicit nil guard — returns 500 if fleet not found.
- `update_fleet/2` (line 122): explicit nil guard — returns 500 if fleet not found.
- `get_fleets_with_equipment/2` (lines 46–60): non-trivial `Enum.reduce` building nested fleet/equipment structure; handles `nil` vehicle_name at line 48.

---

### 3. ApiServerWeb.VXRentalController
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`

**Module aliases:**
- `ApiServer.Vx` (alias `Vx`)
- `ApiServer.Vx.VXRental` (alias `VXRental`)

**Fallback:** `action_fallback ApiServerWeb.FallbackController`

**Public functions defined:**

| Function | Arity | Line | Notes |
|----------|-------|------|-------|
| `get_rentals/2` | 2 | 9 | Clause 1: pattern matches `%{"customer" => _, "closed" => "1"}` — all rentals including closed |
| `get_rentals/2` | 2 | 30 | Clause 2: catch-all — open rentals only |
| `get_midpac_style_rental_report/2` | 2 | 51 | Pattern matches `%{"on" => on_date}` |
| `get_rental_anniversaries/2` | 2 | 110 | Pattern matches `%{"hardwareid" => hardwareid, "from" => from_date, "to" => to_date}` |
| `create_rental/2` | 2 | 158 | Pattern matches `%{"customer" => customer, "rental" => rental_params}` |
| `update_rental/2` | 2 | 174 | Pattern matches `%{"customer" => customer, "rental" => rental_params}` |
| `delete_rental/2` | 2 | 191 | Pattern matches `%{"customer" => customer, "id" => id}` |
| `rhm_active_rental/2` | 2 | 206 | Pattern matches `%{"hardwareid" => hardwareid}` |

**Types / structs / constants defined:** None.

**Key internal logic:**
- `get_rentals/2` (both clauses): inline period_usage/overage calculation via `Enum.map` — complex business logic inline.
- `get_midpac_style_rental_report/2` (line 65): calls `VXRental.has_anniversary_on_day?/3`; conditionally returns `nil` rows and filters them out; accesses `rental.customer` which may be `nil` (guarded at line 75).
- `create_rental/2` (line 169): malformed JSON string in error response — extra `}"` at end of string: `"...\"changeset\": \"#{inspect changeset}\"}\" }"`.
- `update_rental/2` (line 177): nil guard for missing rental; returns 500.
- `delete_rental/2` (line 193): nil guard for missing rental; returns 500.
- `rhm_active_rental/2` (line 214): case on `nil` — returns 500 when no active rental found; the computed `period_start`, `period_usage`, `overage` values (lines 218–225) are computed but **never actually stored back** into `active_rental` before `render/3` is called (the `Map.put_new` results are discarded).

---

### 4. ApiServerWeb.VXRestrictionController
**File:** `lib/api_server_web/controllers/vx_restriction_controller.ex`

**Module aliases:**
- `ApiServer.Vx` (alias `Vx`)
- `ApiServer.Vx.VXRestriction` (alias `VXRestriction`)

**Fallback:** `action_fallback ApiServerWeb.FallbackController`

**Public functions defined:** None.

**Types / structs / constants defined:** None.

**Notes:** The module body is empty — it contains only `use ApiServerWeb, :controller`, two aliases, `action_fallback`, and nothing else. The module defines zero action functions.

---

## Test File Evidence

### Direct test file: `test/api_server_web/controllers/vx_restriction_controller_test.exs`

The test module `ApiServerWeb.VXRestrictionControllerTest` uses `ApiServerWeb.ConnCase` and defines tests for the following actions:

| Describe block | Test name | HTTP method + path helper | Expected status |
|----------------|-----------|---------------------------|-----------------|
| `"index"` | `"lists all vxaau_rest"` | `GET vx_restriction_path(conn, :index)` | 200 |
| `"create vx_restriction"` | `"renders vx_restriction when data is valid"` | `POST vx_restriction_path(conn, :create)` | 201 |
| `"create vx_restriction"` | `"renders errors when data is invalid"` | `POST vx_restriction_path(conn, :create)` | 422 |
| `"update vx_restriction"` | `"renders vx_restriction when data is valid"` | `PUT vx_restriction_path(conn, :update, ...)` | 200 |
| `"update vx_restriction"` | `"renders errors when data is invalid"` | `PUT vx_restriction_path(conn, :update, ...)` | 422 |
| `"delete vx_restriction"` | `"deletes chosen vx_restriction"` | `DELETE vx_restriction_path(conn, :delete, ...)` | 204 |

**Attributes defined:**
- `@create_attrs` — all fields populated with valid values (line 7)
- `@update_attrs` — all fields populated with updated valid values (line 8)
- `@invalid_attrs` — all fields set to `nil` (line 9)

**Helper:** `fixture(:vx_restriction)` at line 11 creates a restriction via `Vx.create_vx_restriction/1`.

**Support module:** `test/support/conn_case.ex` — `ApiServerWeb.ConnCase` uses `Phoenix.ConnTest`, imports `ApiServerWeb.Router.Helpers`, sets `@endpoint ApiServerWeb.Endpoint`. The `setup` block checks out a SQL sandbox connection and wraps each test in a transaction (non-async mode).

### Indirect coverage search results

Grep of entire `test/` directory for `VXFleetAssociation`, `VXFleetController`, `VXRentalController`, and all their public function names: **zero matches found in any test file.**

Only two controller test files exist in the repository:
- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`

---

## VXRestrictionController — Action vs Test Mapping

| Action expected by test | Present in controller source? |
|-------------------------|-------------------------------|
| `index/2` | NO — not defined |
| `create/2` | NO — not defined |
| `show/2` | NO — not defined |
| `update/2` | NO — not defined |
| `delete/2` | NO — not defined |

The controller module (`vx_restriction_controller.ex`) contains **no action functions whatsoever**. The test file exercises five distinct actions (index, create, show, update, delete) that route to this controller, but none of them exist in the module. The tests will fail or exercise dead/misrouted code at runtime.

---

## Findings

---

### B018-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.VXFleetAssociationController`. No direct test file was found and no indirect test coverage was located anywhere in the `test/` directory. All three public actions (`index/2`, `show/2`, `delete/2`) are completely untested.

---

### B018-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.VXFleetController`. No direct test file was found and no indirect test coverage was located anywhere in the `test/` directory. All nine public action clauses (`create/2`, `get_fleets/2` clause 1, `get_fleets/2` clause 2, `get_fleets_with_equipment/2`, `create_fleet/2`, `delete_fleet/2`, `get_equipment_in_fleet/2`, `manage_fleet/2`, `update_fleet/2`) are completely untested.

---

### B018-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.VXRentalController`. No direct test file was found and no indirect test coverage was located anywhere in the `test/` directory. All eight public action clauses are completely untested.

---

### B018-4
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_restriction_controller.ex`
**Finding:** The controller module body is empty — it defines no action functions. The direct test file `test/api_server_web/controllers/vx_restriction_controller_test.exs` exists and exercises five actions (`index`, `create`, `show`, `update`, `delete`), but none of these actions are implemented in the controller. This means the controller has been stubbed out and all tests against it test non-existent functionality. The tests themselves are therefore vacuous or will fail at routing time.

---

### B018-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 19 vs line 27
**Finding:** `get_fleets/2` has two clauses — one for admin users (`%{"admin" => "1"}`) and one for non-admin users (catch-all). There is no test for either clause. The admin clause calls `Vx.list_vxfleets(customer)` while the non-admin clause calls `Vx.list_vxfleets(user_id, customer)` — different arities. The diverging code paths are fully untested.

---

### B018-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 76–88
**Finding:** `create_fleet/2` contains a duplicate-name guard that returns HTTP 500 when a fleet with the same name already exists. This error path is untested.

---

### B018-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 93–102
**Finding:** `delete_fleet/2` contains a nil-guard path returning HTTP 500 when no fleet with the given ID exists. This error path is untested.

---

### B018-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 122–133
**Finding:** `update_fleet/2` contains a nil-guard path returning HTTP 500 when no fleet with the given ID exists. This error path is untested.

---

### B018-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 9–28 vs lines 30–49
**Finding:** `get_rentals/2` has two clauses — one for closed rentals (`%{"closed" => "1"}`) and one for open rentals (catch-all). Neither clause is tested. The two clauses call different context functions (`Vx.list_all_rentals/1` vs `Vx.list_open_rentals/1`) and represent distinct business behaviors.

---

### B018-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 191–203
**Finding:** `delete_rental/2` has a nil-guard path returning HTTP 500 when no rental with the given ID exists. This error path is untested.

---

### B018-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 174–189
**Finding:** `update_rental/2` has a nil-guard path returning HTTP 500 when no rental with the given ID exists. This error path is untested.

---

### B018-12
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 214
**Finding:** `rhm_active_rental/2` has a `nil` case returning HTTP 500 when no active rental exists for the given hardware ID. This error path is untested.

---

### B018-13
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 40–63
**Finding:** `get_fleets_with_equipment/2` contains non-trivial inline `Enum.reduce` logic that builds a nested fleet/equipment data structure. It has two branches: creating a new fleet entry (when not yet in accumulator) and merging equipment into an existing entry. The nil-vehicle-name guard at line 48 is a third branch. None of these logic paths are tested.

---

### B018-14
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 62–108
**Finding:** `get_midpac_style_rental_report/2` contains complex conditional logic: it checks for anniversary on the given day, conditionally computes `previous_anniversary` (which may be nil), and filters out nil results. The branch where `previous_anniversary == nil` returns nil and is filtered out is untested. The branch where `rental.customer` is nil (line 75) is also untested.

---

### B018-15
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 118–154
**Finding:** `get_rental_anniversaries/2` iterates all rentals for a thing and all anniversaries within a date range, computing usage for each period. The inner `previous_anniversary == nil` guard at line 123 (filtering out nil entries) is untested, as is the `rental.customer == nil` guard at line 127.

---

### B018-16
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 14
**Finding:** `show/2` uses `Vx.get_vx_fleet_association!(id)` (bang variant). No test covers the not-found case (which would raise and be caught by `FallbackController`). Additionally, no test covers a non-integer or malformed `id` parameter.

---

### B018-17
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 110
**Finding:** `manage_fleet/2` pattern-matches on `"equip_in_fleet"` as a list and maps over it with `String.to_integer/1`. No test covers the case where `ids_in_fleet` is empty, contains non-integer strings, or contains duplicate IDs.

---

### B018-18
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 9
**Finding:** `get_rentals/2` (closed clause) pattern-matches on the string `"1"` for the `"closed"` parameter. No test covers the boundary between open-only and closed results, nor the case where the rental list is empty.

---

### B018-19
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 59
**Finding:** `get_midpac_style_rental_report/2` calls `Date.from_iso8601!/1` on the `on_date` parameter at line 59. No test covers an invalid date string (e.g. `"not-a-date"` or `"2026-13-01"`), which would raise `ArgumentError` and produce an unhandled 500 rather than a structured error response.

---

### B018-20
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_restriction_controller_test.exs`
**Finding:** The test file uses `fixture/1` (line 11) rather than ExMachina or Ecto factory patterns. The `fixture` function is a deprecated pattern in newer Phoenix/ExUnit conventions; it also shares state with `@create_attrs` rather than generating unique values, which could cause false-positive passes if uniqueness constraints are missing. This is an observation about test quality rather than a coverage gap.

---

### B018-21
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 218–225
**Finding:** In `rhm_active_rental/2`, the results of `Map.put_new(:period_start, ...)`, `Map.put_new(:period_usage, ...)`, and `Map.put_new(:overage, ...)` (lines 222–225) are not bound to any variable before the `render/3` call on line 229. The `active_rental` struct passed to the view is therefore missing the computed `period_start`, `period_usage`, and `overage` keys. This is a likely runtime logic bug; however since there are no tests, it is currently undetected. Reported as INFO here; the behavioral bug itself should be escalated by a separate pass.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B018-1 | HIGH | vx_fleet_association_controller.ex | No test file — all 3 actions untested |
| B018-2 | HIGH | vx_fleet_controller.ex | No test file — all 9 action clauses untested |
| B018-3 | HIGH | vx_rental_controller.ex | No test file — all 8 action clauses untested |
| B018-4 | HIGH | vx_restriction_controller.ex | Controller body is empty; test file exists but tests non-existent actions |
| B018-5 | MEDIUM | vx_fleet_controller.ex | `get_fleets/2` admin vs non-admin clauses both untested |
| B018-6 | MEDIUM | vx_fleet_controller.ex | `create_fleet/2` duplicate-name error path untested |
| B018-7 | MEDIUM | vx_fleet_controller.ex | `delete_fleet/2` not-found error path untested |
| B018-8 | MEDIUM | vx_fleet_controller.ex | `update_fleet/2` not-found error path untested |
| B018-9 | MEDIUM | vx_rental_controller.ex | `get_rentals/2` closed vs open clauses both untested |
| B018-10 | MEDIUM | vx_rental_controller.ex | `delete_rental/2` not-found error path untested |
| B018-11 | MEDIUM | vx_rental_controller.ex | `update_rental/2` not-found error path untested |
| B018-12 | MEDIUM | vx_rental_controller.ex | `rhm_active_rental/2` no-active-rental error path untested |
| B018-13 | MEDIUM | vx_fleet_controller.ex | `get_fleets_with_equipment/2` reduce logic branches untested |
| B018-14 | MEDIUM | vx_rental_controller.ex | `get_midpac_style_rental_report/2` nil-anniversary and nil-customer branches untested |
| B018-15 | MEDIUM | vx_rental_controller.ex | `get_rental_anniversaries/2` nil-anniversary and nil-customer branches untested |
| B018-16 | LOW | vx_fleet_association_controller.ex | `show/2` not-found and malformed-id cases untested |
| B018-17 | LOW | vx_fleet_controller.ex | `manage_fleet/2` empty/invalid `equip_in_fleet` list untested |
| B018-18 | LOW | vx_rental_controller.ex | `get_rentals/2` empty-list and closed-boundary edge cases untested |
| B018-19 | LOW | vx_rental_controller.ex | `get_midpac_style_rental_report/2` invalid date string raises unhandled error |
| B018-20 | INFO | vx_restriction_controller_test.exs | Deprecated `fixture/1` pattern used in test setup |
| B018-21 | INFO | vx_rental_controller.ex | `rhm_active_rental/2` discards computed `Map.put_new` results before render |
