# Audit Report B009
**Audit Run:** 2026-02-27-01
**Pass:** 2
**Agent:** B009
**Date:** 2026-02-27

## Assigned Source Files

1. `lib/api_server/vx/vx_abl_record.ex`
2. `lib/api_server/vx/vx_access_fob.ex`
3. `lib/api_server/vx/vx_customer.ex`
4. `lib/api_server/vx/vx_fleet.ex`

---

## Reading Evidence

### File 1: `lib/api_server/vx/vx_abl_record.ex`

**Module:** `ApiServer.Vx.VXAblRecord`

**Schema / Struct:**
- Table: `abl_data_changes`
- Primary key: `ablid` (`:id`, autogenerate: true)
- Fields:
  - `:abldatetime` (`:utc_datetime`)
  - `:ablcustcode` (`:string`)
  - `:abluser` (`:string`)
  - `:abllogtype` (`:string`)
  - `:ablusragnt` (`:string`)
  - `:ablip_address` (`:string`)
  - `:abltable` (`:string`)
  - `:ablaction` (`:string`)
  - `:ablimagetype` (`:string`)
  - `:ablimage` (`:string`)
  - `:ablprocessed` (`:string`)
- Association: `belongs_to :user, ApiServer.Vx.VXUser` (foreign_key: `:abluser`, references: `:aacuser`, define_field: false)

**Functions defined:**

| Line | Visibility | Name / Arity |
|------|-----------|--------------|
| 25   | public    | `changeset/2` |
| 31   | public    | `generate_service/10` |
| 54   | public    | `clean_xml_value/1` |
| 63   | public    | `clean_xml_number_value/1` |
| 72   | public    | `expand_xml_to_struct/1` |

**Notable logic in `expand_xml_to_struct/1`:**
- Calls `XmlToMap.naive_map/1` on `abl_record.ablimage`
- Parses `hardwareid` via `Integer.parse/1` with three case branches: `:error`, `{value, _}`, and `_` (catch-all)
- The `{value, _}` branch has a dead-code `if` at lines 80-84: both branches return `value` identically, making the length check a no-op

**Notable logic in `generate_service/10`:**
- Builds an XML string and calls `Vx.create_abl_record/2`
- `estimated_service_date` and `estimated_service_hours` are hardcoded to `""` (lines 32-33)
- Returns the `:ok` or `:error` atom from `create_abl_record`

---

### File 2: `lib/api_server/vx/vx_access_fob.ex`

**Module:** `ApiServer.Vx.VXAccessFob`

**Schema / Struct:**
- Table: `access_fobs`
- Primary key: default (`:id`)
- Fields:
  - `:fob_code` (`:string`)
- Association: `belongs_to :user, ApiServer.Vx.VXUser` (foreign_key: `:assigned_to_user`, references: `:aacid`)

**Functions defined:** None (schema-only module, no functions beyond Ecto-generated callbacks)

---

### File 3: `lib/api_server/vx/vx_customer.ex`

**Module:** `ApiServer.Vx.VXCustomer`

**Schema / Struct:**
- Table: `aaa_customers`
- Primary key: `aaaid` (`:id`, autogenerate: true)
- Fields:
  - `:aaaaddr1`, `:aaaaddr2`, `:aaaaddr3` (`:string`)
  - `:aaacolour` (`:string`)
  - `:aaaname` (`:string`)
  - `:aaapcode` (`:string`)
  - `:aaaprimcont` (`:string`)
  - `:aaaprimemail` (`:string`)
  - `:aaaprimtel` (`:string`)
  - `:aaatz` (`:string`)
  - `:aaaudfcustcode` (`:string`)
  - `:aaacustcode` (`:string`)
- Association: `belongs_to :rental, ApiServer.Vx.VXRental` (foreign_key: `:aaaid`, references: `:abhcustomerid`, primary_key: true, define_field: false)

**Functions defined:**

| Line | Visibility | Name / Arity |
|------|-----------|--------------|
| 25   | public    | `convert_json_to_changeset/1` |
| 43   | public    | `changeset/2` |

**Notable logic in `convert_json_to_changeset/1`:**
- Derives `:aaacustcode` from `customer_json["name"]` via a chain: `String.reverse/1` -> `String.replace/2` -> `String.slice/2` -> `String.upcase/1` (line 36)
- This will raise a `FunctionClauseError` if `customer_json["name"]` is `nil` (all String functions reject nil)

**Notable logic in `changeset/2`:**
- Validates `validate_required([:aaaname])`
- Applies `unique_constraint(:aaacustcode, name: :UQ1)`

---

### File 4: `lib/api_server/vx/vx_fleet.ex`

**Module:** `ApiServer.Vx.VXFleet`

**Schema / Struct:**
- Table: `aae_group`
- Primary key: `aaeid` (`:id`, autogenerate: true)
- Fields:
  - `:aaecustcode` (`:string`)
  - `:aaedesc` (`:string`)
  - `:aaecolour` (`:string`)
  - `:aaetype` (`:integer`)
  - `:aaeshowfilter` (`:boolean`)
- Association: `has_many :fleet_thing_joins, ApiServer.Vx.VXFleetAssociation` (foreign_key: `:aafgroupid`, on_delete: `:delete_all`)

**Functions defined:**

| Line | Visibility | Name / Arity |
|------|-----------|--------------|
| 19   | public    | `convert_json_to_changeset/1` |
| 27   | public    | `changeset/2` |

**Notable logic in `changeset/2`:**
- Validates `validate_required([:aaedesc])`
- No unique constraints

---

## Test Coverage Search Results

Searches performed against `test/` directory for:
- Module names: `VXAblRecord`, `VXAccessFob`, `VXCustomer`, `VXFleet`, `VxAblRecord`, `VxAccessFob`, `VxCustomer`, `VxFleet`
- Snake-case variants: `vx_abl_record`, `vx_access_fob`, `vx_customer`, `vx_fleet`
- Function names: `generate_service`, `clean_xml_value`, `clean_xml_number_value`, `expand_xml_to_struct`, `convert_json_to_changeset`
- Table names: `abl_data_changes`, `access_fobs`, `aaa_customers`, `aae_group`

**Result: Zero matches found in any test file for any of the above terms.**

The four known test files (`calamp_controller_test.exs`, `vx_restriction_controller_test.exs`, `layout_view_test.exs`, `page_view_test.exs`) contain no references to these modules or their functions.

---

## Findings

---

### B009-1
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Finding:** No test file exists for module `ApiServer.Vx.VXAblRecord` and no indirect test coverage was found anywhere in the test suite.

This module contains five public functions including complex XML-building logic (`generate_service/10`), XML-parsing logic (`expand_xml_to_struct/1`), and two utility helpers (`clean_xml_value/1`, `clean_xml_number_value/1`). The module is actively called from `vx_abl_record_controller.ex` and `vx.ex`. None of these code paths are exercised by any test.

---

### B009-2
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_access_fob.ex`
**Finding:** No test file exists for module `ApiServer.Vx.VXAccessFob` and no indirect test coverage was found anywhere in the test suite.

While the module itself is schema-only (no custom functions), the schema mapping and association (`belongs_to :user` via `assigned_to_user` / `aacid`) are never exercised in tests. Any regression in field mappings or association configuration would go undetected.

---

### B009-3
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_customer.ex`
**Finding:** No test file exists for module `ApiServer.Vx.VXCustomer` and no indirect test coverage was found anywhere in the test suite.

Both public functions (`convert_json_to_changeset/1` and `changeset/2`) are called from `vx_customer_controller.ex` and `vx.ex` respectively but are entirely untested.

---

### B009-4
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_fleet.ex`
**Finding:** No test file exists for module `ApiServer.Vx.VXFleet` and no indirect test coverage was found anywhere in the test suite.

Both public functions (`convert_json_to_changeset/1` and `changeset/2`) are called from `vx_fleet_controller.ex` and `vx.ex` respectively but are entirely untested.

---

### B009-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `generate_service/10` (line 31)
**Finding:** The `generate_service/10` function has no test exercising it.

This function accepts ten parameters, builds an XML string, and delegates persistence to `Vx.create_abl_record/2`. The function returns the status atom (`:ok` or `:error`) from that call. No test covers:
- The happy path where `create_abl_record` returns `{:ok, _}`
- The failure path where `create_abl_record` returns `{:error, _}`
- The XML structure produced (field ordering, special characters in interpolated values)

---

### B009-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `expand_xml_to_struct/1` (line 72)
**Finding:** The `expand_xml_to_struct/1` function has no test exercising it.

This function parses free-form XML stored in `ablimage`. No test covers:
- Malformed or empty XML input (would raise from `XmlToMap.naive_map/1`)
- A `hardwareid` that parses successfully vs. one that returns `:error`
- Fields missing from the XML document (missing keys return `nil` via `clean_xml_value`)
- The `_` catch-all branch of the `Integer.parse` case (line 85), which is unreachable given `Integer.parse/1` only returns `:error` or `{integer, remainder}`, making the branch dead code

---

### B009-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `changeset/2` (line 25)
**Finding:** The `changeset/2` function has no test exercising it.

There are no tests for valid attribute casting or for verifying which fields are accepted by the cast. The `ablcustcode` field is declared in the schema but is absent from the `cast/3` field list in the changeset, meaning it can never be set through a changeset — this silent omission is untested.

---

### B009-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_customer.ex`
**Function:** `convert_json_to_changeset/1` (line 25)
**Finding:** The `convert_json_to_changeset/1` function has no test exercising it.

No test covers:
- A fully populated JSON map (happy path)
- A JSON map with missing optional keys (nil values passed to `Vx.update_key_if_value/3`)
- The `"name"` key being absent or nil — line 36 applies `String.reverse/1` directly to the value, which will raise `FunctionClauseError` if `customer_json["name"]` is `nil`

---

### B009-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_customer.ex`
**Function:** `changeset/2` (line 43)
**Finding:** The `changeset/2` function has no test exercising it.

No test covers:
- Missing required field `:aaaname` (should produce a validation error)
- Duplicate `:aaacustcode` triggering the `unique_constraint` named `:UQ1`
- Valid full attribute cast

---

### B009-10
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_fleet.ex`
**Function:** `convert_json_to_changeset/1` (line 19)
**Finding:** The `convert_json_to_changeset/1` function has no test exercising it.

No test covers:
- A fully populated JSON map
- A JSON map with nil values for any key (delegated to `Vx.update_key_if_value/3`)
- Type coercion of `:aaetype` (integer) or `:aaeshowfilter` (boolean) from JSON string representations

---

### B009-11
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_fleet.ex`
**Function:** `changeset/2` (line 27)
**Finding:** The `changeset/2` function has no test exercising it.

No test covers:
- Missing required field `:aaedesc` (should produce a validation error)
- Valid attribute casting including integer and boolean fields
- The `aaecustcode` field is declared in the schema but absent from the `cast/3` field list, silently making it uncastable via changeset — untested

---

### B009-12
**Severity:** LOW
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `clean_xml_value/1` (line 54)
**Finding:** The `clean_xml_value/1` helper has no test exercising it.

No edge cases are tested:
- Input of `%{}` (the empty map sentinel) — should return `nil`
- Input of a normal string value — should pass through unchanged
- Input of `nil`, `0`, `false`, or other falsy values — these will pass through the `true ->` branch, but the intent may be to also sanitize these

---

### B009-13
**Severity:** LOW
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `clean_xml_number_value/1` (line 63)
**Finding:** The `clean_xml_number_value/1` helper has no test exercising it.

No edge cases are tested:
- Input of `%{}` — should return `0`
- Input of a valid integer — should pass through unchanged
- Input of `nil` — passes through unchanged (returns `nil`), which may be incorrect for a "number value" cleaner

---

### B009-14
**Severity:** LOW
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `expand_xml_to_struct/1` (line 72)
**Finding:** Dead code branch at lines 80-84 is untested and unreachable.

Inside the `Integer.parse` case, the `{value, _}` branch contains:
```elixir
if length(Integer.digits(value)) >= 10 do
  value
else
  value
end
```
Both arms return `value` identically, making the condition a no-op. This dead code suggests an incomplete implementation (the original intent was likely to handle large IDs differently). No test documents the intended behaviour.

---

### B009-15
**Severity:** LOW
**File:** `lib/api_server/vx/vx_customer.ex`
**Function:** `convert_json_to_changeset/1` (line 36)
**Finding:** The `aaacustcode` derivation from `customer_json["name"]` is not tested for boundary cases.

The derivation reverses the name, removes spaces, takes the first 9 characters, and uppercases the result. No test covers:
- A name shorter than 9 characters after removing spaces
- A name consisting entirely of spaces (produces an empty string after `String.replace`, then `String.slice` and `String.upcase` of `""`)
- Unicode/multi-byte characters in the name where `String.slice` operates on graphemes

---

### B009-16
**Severity:** LOW
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `generate_service/10` (line 31)
**Finding:** `estimated_service_date` and `estimated_service_hours` are hardcoded to empty strings.

Lines 32-33 set these to `""` unconditionally and embed them in the XML payload. This appears to be unfinished functionality. The parameters are not represented in the function signature, suggesting either placeholder logic or a regression from a refactor. No test documents whether this is intentional.

---

## Summary Table

| ID     | Severity | File                    | Subject                                      |
|--------|----------|-------------------------|----------------------------------------------|
| B009-1 | HIGH     | vx_abl_record.ex        | No test file or indirect coverage            |
| B009-2 | HIGH     | vx_access_fob.ex        | No test file or indirect coverage            |
| B009-3 | HIGH     | vx_customer.ex          | No test file or indirect coverage            |
| B009-4 | HIGH     | vx_fleet.ex             | No test file or indirect coverage            |
| B009-5 | MEDIUM   | vx_abl_record.ex        | `generate_service/10` untested               |
| B009-6 | MEDIUM   | vx_abl_record.ex        | `expand_xml_to_struct/1` untested            |
| B009-7 | MEDIUM   | vx_abl_record.ex        | `changeset/2` untested                       |
| B009-8 | MEDIUM   | vx_customer.ex          | `convert_json_to_changeset/1` untested       |
| B009-9 | MEDIUM   | vx_customer.ex          | `changeset/2` untested                       |
| B009-10| MEDIUM   | vx_fleet.ex             | `convert_json_to_changeset/1` untested       |
| B009-11| MEDIUM   | vx_fleet.ex             | `changeset/2` untested                       |
| B009-12| LOW      | vx_abl_record.ex        | `clean_xml_value/1` edge cases untested      |
| B009-13| LOW      | vx_abl_record.ex        | `clean_xml_number_value/1` edge cases untested|
| B009-14| LOW      | vx_abl_record.ex        | Dead code branch in `expand_xml_to_struct/1` |
| B009-15| LOW      | vx_customer.ex          | `aaacustcode` derivation boundary cases      |
| B009-16| LOW      | vx_abl_record.ex        | Hardcoded empty strings in `generate_service`|

**Total findings: 16**
**HIGH: 4 | MEDIUM: 7 | LOW: 5**
