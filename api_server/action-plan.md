> **Format Note:** Findings are in the audit agents's native format (`**B001-1 — [HIGH] ...`), not the structured `Description: / Fix:` schema. `^Fix:` lines: 0. `^Description:` lines: 357. Accepted as-is (option 1).

# Action Plan — api_server
**Branch:** master
**Audit Date:** 2026-02-27
**Run:** 01

---

## Summary

| Severity | Count |
|---|---|
| CRITICAL | 143 |
| HIGH | 563 |
| MEDIUM | 1088 |
| LOW | 955 |
| INFO | 748 |

---

## Pass 1 — Security

<!-- A001.md -->
# Pass 1 Security Audit — A001
**Agent:** A001
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Date:** 2026-02-27

---

## Reading Evidence

---

### File: `.dockerignore`

- No module name (non-Elixir file)
- No public functions, structs, plugs, pipelines, use/import/alias
- **Entries present:**
  - `.git/`
  - `_build/`
  - `assets/node_modules/`
  - `deps/`

---

### File: `.gitignore`

- No module name (non-Elixir file)
- No public functions, structs, plugs, pipelines, use/import/alias
- **Entries present:**
  - `/_build`
  - `/db`
  - `/deps`
  - `/*.ez`
  - `erl_crash.dump`
  - `npm-debug.log`
  - `/assets/node_modules`
  - `/priv/static/`
  - `.elixir_ls/`
  - `.DS_Store`
  - `.vscode/`
- **Notable absence:** The line `# /config/*.secret.exs` is commented out — `config/*.secret.exs` is NOT excluded from version control.
- **Notable absence:** No exclusion for `*.csv`, `*.sql`, or any data files at the repo root.

---

### File: `Dockerfile`

- No module name (non-Elixir file)
- No public functions, structs, plugs, pipelines, use/import/alias
- **Key configuration:**
  - Base image: `bitwalker/alpine-elixir:1.13.4`
  - Packages installed: `git make wget curl inotify-tools nodejs npm ca-certificates`
  - npm pinned to `8.1.3` globally
  - Custom CA certificate: `priv/certs/sectigo_root_r46.crt` added and `update-ca-certificates --fresh` run
  - `EXPOSE 4000` (HTTP), `EXPOSE 4001` (TCP)
  - `ENV PORT=4000`, `ENV TCP_PORT=4001`, `ENV MIX_ENV=prod`
  - Build sequence: `COPY . .` → `mix deps.get` → `npm install` → `mix compile` → `mix release`
  - CMD: `/app/_build/prod/rel/api_server/bin/api_server start`
  - Directory `/opt/app` created with `chmod -R 777`

---

### File: `assets/brunch-config.js`

- No module name (JavaScript config file)
- No public functions, structs, plugs, pipelines, use/import/alias
- **Key configuration:**
  - Compiles JS to `js/app.js`, CSS to `css/app.css`
  - Babel configured to ignore `/vendor/`
  - Public output path: `../priv/static`
  - npm enabled: `true`

---

### File: `assets/package.json`

- No module name (JSON file)
- No public functions, structs, plugs, pipelines, use/import/alias
- **Dependencies:**
  - `phoenix`: `file:../deps/phoenix` (local)
  - `phoenix_html`: `file:../deps/phoenix_html` (local)
- **DevDependencies:**
  - `babel-brunch`: `6.1.1`
  - `brunch`: `^2.10.17`
  - `clean-css-brunch`: `2.10.0`
  - `uglify-js-brunch`: `2.10.0`
- **License:** MIT

---

### File: `assets/package-lock.json`

- No module name (JSON lock file)
- No public functions, structs, plugs, pipelines, use/import/alias
- **lockfileVersion:** 2
- **Notable resolved versions:**
  - `acorn`: `5.7.3`
  - `ansi-regex`: `2.1.1`
  - `ansi-styles`: `2.2.1`
  - All packages resolved from `https://registry.npmjs.org/`
  - Phoenix/phoenix_html sourced from local file paths (`file:../deps/phoenix`, `file:../deps/phoenix_html`)

---

### File: `config/config.exs`

- No module name (Mix config file)
- No public functions, structs, plugs, pipelines
- **use:** `Mix.Config`
- **Config keys set:**
  - `:api_server` → `ecto_repos: [ApiServer.Repo]`
  - `:api_server, ApiServerWeb.Endpoint` → `url`, `secret_key_base` (hardcoded), `render_errors`, `pubsub`
  - `:api_server, ApiServer.Scheduler` → `debug_logging`, `jobs` (cron schedule — active jobs for vx_keller, vx_dpworld, vx_linde, vx_sielift; many commented-out customer tenants)
  - `:api_server, ApiServer.Mailer` → `adapter: Bamboo.SMTPAdapter`, `server: "email-smtp.us-west-2.amazonaws.com"`, `port: 587`, `username: "[REDACTED-AWS-KEY-ID]"`, `password: "[REDACTED-AWS-SMTP-PASSWORD]"`, `tls: :always`, `ssl: false`, `retries: 1`
  - `:logger, :console` → `format`, `metadata`
  - `:api_server, ApiServer.Guardian` → `issuer: "rhmapi"`, `ttl: {52, :weeks}`, `secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"` (hardcoded)
  - `:geonames` → `username: "vinxstudio"`, `language: "en"`
  - `import_config "#{Mix.env()}.exs"`

---

### File: `config/dev.exs`

- No module name (Mix config file)
- No public functions, structs, plugs, pipelines
- **use:** `Mix.Config`
- **Config keys set:**
  - `:api_server, ApiServerWeb.Endpoint` → `http: [port: 4000]`, `debug_errors: true`, `code_reloader: true`, `check_origin: false`, `watchers`, `live_reload`
  - `:logger` → `level: :info`
  - `:phoenix` → `stacktrace_depth: 20`, `json_library: Poison`
  - `:api_server, ApiServer.FortyNineRepo` → `adapter: Ecto.Adapters.MySQL`, `database: "trackingsolutions"`, `username: "svr49_hi_x_user"`, `password: "Q973bFtc9z/cVW#mA"` (hardcoded), `hostname: "svr49.tracking-intelligence.com"` (external host), `pool_timeout: 15000`, `timeout: :infinity`, `loggers: []`
  - `:api_server, ApiServer.Repo` → `adapter: Ecto.Adapters.MySQL`, `username: "vxaurorasyduser"`, `password: "TRxbixk9fuZc"` (hardcoded), `hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com"` (AWS RDS endpoint, hardcoded), `port: 3306`
  - `:api_server, ApiServer.Mailer` → same AWS SES credentials as config.exs (duplicated)

---

### File: `config/prod.exs`

- No module name (Mix config file)
- No public functions, structs, plugs, pipelines
- **use:** `Mix.Config`
- **Config keys set:**
  - `:api_server, ApiServerWeb.Endpoint` → `http: [port: 4000]`, `url: [host: "localhost", port: 4000]`, `server: true`, `version`
  - `:logger` → `level: :info`
  - `:api_server, ApiServer.FortyNineRepo` → `database: "trackingsolutions"`, `username: "svr49_hi_x_user"`, `password: "Q973bFtc9z/cVW#mA"` (hardcoded), `hostname: "svr49.tracking-intelligence.com"`, `timeout: :infinity`
  - `:api_server, ApiServer.Repo` → `username: "vxaurorasyduser"`, `password: "TRxbixk9fuZc"` (hardcoded), `hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com"` (AWS RDS, hardcoded), `timeout: 600_000` (10 min — noted as "bad" in comment), `port: 3306`
  - `:api_server, ApiServer.Mailer` → same AWS SES credentials (duplicated again)
  - `import_config "prod.secret.exs"`
- **Notable:** Production URL is `localhost:4000`, not a real hostname.
- **Notable:** `timeout: 600_000` (10 minutes) on the production DB pool, acknowledged in a comment as a known bad value.

---

### File: `config/prod.secret.exs`

- No module name (Mix config file)
- No public functions, structs, plugs, pipelines
- **use:** `Mix.Config`
- **Config keys set:**
  - `:api_server, ApiServerWeb.Endpoint` → `secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"` (hardcoded literal string)
- **Notable:** This file is present in the repository and tracked by git (not excluded by .gitignore — see .gitignore analysis above). The commented-out DB config block also shows the RDS password `TRxbixk9fuZc`.

---

### File: `config/test.exs`

- No module name (Mix config file)
- No public functions, structs, plugs, pipelines
- **use:** `Mix.Config`
- **Config keys set:**
  - `:api_server, ApiServerWeb.Endpoint` → `http: [port: 4001]`, `server: false`
  - `:logger, :console` → `format`
  - `:phoenix` → `stacktrace_depth: 20`
  - `:api_server, ApiServer.Repo` → `adapter: Ecto.Adapters.MySQL`, `database: "vx_dev"`, `username: "root"`, `password: "secret"`, `hostname: "127.0.0.1"`, `port: 3307`
  - `:api_server, ApiServer.Mailer` → same AWS SES credentials (`[REDACTED-AWS-KEY-ID]` / `[REDACTED-AWS-SMTP-PASSWORD]`) — production SMTP credentials in test config

---

### File: `mix.exs`

- **Module:** `ApiServer.Mixfile`
- **use:** `Mix.Project`
- **Public functions:**
  - `project/0` (line 4)
  - `application/0` (line 20)
- **Private functions:** `elixirc_paths/1`, `deps/0`, `aliases/0`
- **No defstruct/defexception/schema**
- **Dependencies declared (mix.exs):**
  - `{:phoenix, "~> 1.5.9"}`
  - `{:phoenix_pubsub, "~> 2.0"}`
  - `{:phoenix_ecto, "~> 3.2"}`
  - `{:mariaex, "~>0.8.2"}` — DEPRECATED (no security support per checklist)
  - `{:phoenix_html, "~> 2.10"}`
  - `{:phoenix_live_reload, "~> 1.0", only: :dev}`
  - `{:gettext, "~> 0.11"}`
  - `{:cowboy, "~> 1.0"}` — Cowboy 1.x (old major version)
  - `{:cors_plug, "~> 1.5"}`
  - `{:distillery, "~> 1.5"}`
  - `{:ex_crc, "~> 1.0.0"}`
  - `{:absinthe, "~> 1.4.0"}`
  - `{:absinthe_plug, "~> 1.4.0"}`
  - `{:absinthe_ecto, "~> 0.1.3"}`
  - `{:httpoison, "~> 1.6"}`
  - `{:poison, "~> 3.1"}`
  - `{:elixir_xml_to_map, "~> 0.1"}`
  - `{:timex, "~> 3.1"}`
  - `{:guardian, "~> 1.0"}`
  - `{:csv, "~> 2.1.1"}`
  - `{:geonames, path: "geonames-elixir"}` — local path dependency
  - `{:geohax, ">= 0.0.0"}` — unbounded version constraint
  - `{:con_cache, "~> 0.13"}`
  - `{:topo, "~> 0.1.0"}`
  - `{:bamboo, "~> 1.2"}`
  - `{:bamboo_smtp, "~> 2.1.0"}`
  - `{:quantum, "~> 2.3"}`
  - `{:plug_cowboy, "~> 1.0"}`
- **Elixir version constraint:** `"~> 1.4"` (very permissive — allows 1.x up to but not 2.0)

---

### File: `mix.lock`

- No module name (lock file)
- No public functions, structs, plugs, pipelines, use/import/alias
- **Resolved versions (security-relevant):**
  - `absinthe`: `1.4.16`
  - `absinthe_plug`: `1.4.7`
  - `bamboo`: `1.5.0`
  - `bamboo_smtp`: `2.1.0`
  - `certifi`: `2.5.2`
  - `cowboy`: `1.1.2`
  - `distillery`: `1.5.5`
  - `ecto`: `2.2.12`
  - `guardian`: `1.2.1`
  - `hackney`: `1.16.0`
  - `httpoison`: `1.6.2`
  - `jose`: `1.10.1`
  - `mariaex`: `0.8.4` (specified `~>0.8.2` in mix.exs; resolved to `0.8.4`)
  - `phoenix`: `1.5.13`
  - `plug`: `1.13.6`
  - `plug_cowboy`: `1.0.0`
  - `poison`: `3.1.0`
  - `quantum`: `2.4.0`
  - All packages sourced from `hexpm` (no `git:` URLs)
  - `geonames` is a `path:` dependency (not in mix.lock — local)

---

### File: `rel/config.exs`

- No module name (Distillery release config)
- No public functions, structs, plugs, pipelines, use/import/alias
- **use:** `Mix.Releases.Config`
- **Config keys set:**
  - `default_release: :default`
  - `default_environment: Mix.env()`
  - `environment :dev` → `dev_mode: true`, `include_erts: false`, `cookie: :"JKjj4~EgQ[*I;|ap1Gr2i.Lg4U(8])B/qqR8AWKoZLe@K!YN^!jjGH7yL8g8zDI0"` (hardcoded)
  - `environment :prod` → `include_erts: true`, `include_src: false`, `cookie: :"uGovGv~THz5>(L)>:_:.KDV>]Kr7mtIeFL)ESD\`a$bF\`I^hrWwwjea|K$HbFRIpR"` (hardcoded)
  - `release :api_server` → `version: current_version(:api_server)`, `applications: [:runtime_tools]`
- **Notable:** Both dev and prod Erlang distribution cookies are hardcoded plaintext literals committed to version control.

---

## Findings

---

### §1 Secrets and Configuration

**A001-1 — CRITICAL: AWS SES SMTP credentials hardcoded in four tracked config files**

The AWS SES SMTP username and password are hardcoded in plaintext in every config environment file that is tracked in git:

- `config/config.exs` lines 117–120:
  `username: "[REDACTED-AWS-KEY-ID]"`
  `password: "[REDACTED-AWS-SMTP-PASSWORD]"`
- `config/dev.exs` lines 98–101 (identical values)
- `config/prod.exs` lines 45–48 (identical values)
- `config/test.exs` lines 57–59 (identical values)

A comment in config.exs line 115 also preserves the prior IAM key `[REDACTED-AWS-KEY-ID]` (and prior password `[REDACTED-AWS-SMTP-PASSWORD]`) in commented-out form — both are committed to version control and visible in git history. The `AKIA`-prefix format confirms these are IAM access key IDs. These credentials must be revoked immediately, rotated, and replaced with environment variable references (`System.get_env/1`).

---

**A001-2 — CRITICAL: Guardian JWT secret key hardcoded in tracked config file**

`config/config.exs` line 136:
```
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The Guardian signing key is used to sign all JWT tokens for the application. Any party with read access to this repository can forge arbitrary JWT tokens, bypassing all authentication. This value must be rotated immediately, all existing tokens invalidated, and the key loaded via `System.get_env/1` at runtime.

---

**A001-3 — CRITICAL: Phoenix `secret_key_base` hardcoded in two tracked config files**

- `config/config.exs` line 15:
  `secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh"`
- `config/prod.secret.exs` line 12:
  `secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"`

The `secret_key_base` is used to sign cookies, session tokens, and CSRF tokens. Exposure allows session forgery and CSRF bypass. Both values must be rotated and loaded from environment variables.

---

**A001-4 — CRITICAL: Production and dev database passwords hardcoded in tracked config files**

Multiple database credentials are hardcoded in tracked files:

- `config/dev.exs` line 64 (`ApiServer.FortyNineRepo`):
  `password: "Q973bFtc9z/cVW#mA"`, `hostname: "svr49.tracking-intelligence.com"`
- `config/dev.exs` lines 87–88 (`ApiServer.Repo`):
  `password: "TRxbixk9fuZc"`, `hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com"`
- `config/prod.exs` lines 17, 35–36 (same passwords for both repos in production)
- `config/prod.secret.exs` lines 18–19 (commented-out block still exposes `TRxbixk9fuZc`)

The fact that the same password (`TRxbixk9fuZc`) is used across dev and prod RDS instances is a separate concern (credential reuse).

---

**A001-5 — CRITICAL: `config/prod.secret.exs` is tracked in git (not excluded by .gitignore)**

The `.gitignore` file contains the line:
```
# /config/*.secret.exs
```
The exclusion rule is commented out. `prod.secret.exs` is therefore tracked by git and confirmed present in the repository (`git ls-files` returns it). The file contains the production `secret_key_base`. This defeats the entire purpose of having a `*.secret.exs` file pattern.

---

**A001-6 — CRITICAL: Erlang distribution cookies hardcoded in tracked `rel/config.exs`**

`rel/config.exs` lines 33 and 39 contain hardcoded Erlang node cookies for dev and prod environments:
```
cookie: :"JKjj4~EgQ[*I;|ap1Gr2i.Lg4U(8])B/qqR8AWKoZLe@K!YN^!jjGH7yL8g8zDI0"
cookie: :"uGovGv~THz5>(L)>:_:.KDV>]Kr7mtIeFL)ESD`a$bF`I^hrWwwjea|K$HbFRIpR"
```
The Erlang distribution cookie is the only authentication mechanism for Erlang/OTP node-to-node communication. Any host that knows the cookie and can reach the EPMD port can connect to the node, execute arbitrary Erlang code, and take full control of the runtime. These must be rotated and injected at deploy time via environment variable or a secrets manager, never committed to source control.

---

**A001-7 — HIGH: `geonames` username hardcoded in tracked config**

`config/config.exs` line 139:
```
username: "vinxstudio"
```
This is a third-party API credential (geonames.org) committed in plaintext. While the impact of this specific credential is lower than the database and JWT secrets, it represents the same pattern of hardcoded credentials and may allow abuse of the account's quota or API limits.

---

**A001-8 — HIGH: AWS RDS endpoint hostname hardcoded in tracked config files**

`config/dev.exs` line 88 and `config/prod.exs` line 36:
```
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com"
```
`config/dev.exs` line 65 and `config/prod.exs` line 16:
```
hostname: "svr49.tracking-intelligence.com"
```
Hardcoded RDS cluster endpoints and external hostnames reveal infrastructure topology and region (`ap-southeast-2`). These should be injected via environment variables. Additionally, `svr49.tracking-intelligence.com` appears to be an external third-party tracking service, confirming a dependency on an external database server.

---

**A001-9 — HIGH: No `bitbucket-pipelines.yml` present — CI/CD pipeline absent**

The file `bitbucket-pipelines.yml` does not exist in the repository. The checklist requires its presence and review. The absence means there is no automated CI/CD pipeline visible in source control, so it is unknown whether deployments are being performed with hardcoded credentials in an out-of-band pipeline, or whether no automated deployment exists. The lack of pipeline configuration also means no automated security scanning or testing gate is enforced on commits.

---

**A001-10 — MEDIUM: Guardian TTL is 52 weeks — excessively long token lifetime**

`config/config.exs` line 135:
```
ttl: {52, :weeks}
```
JWT tokens issued by Guardian are valid for one full year. If a token is compromised, the attacker has up to 52 weeks of authenticated access before the token naturally expires. Industry best practice for API tokens is 15 minutes to 24 hours for access tokens, with refresh tokens handling long-lived sessions. There is no evidence in this configuration of a refresh token policy.

---

**A001-11 — MEDIUM: Production `url` host is `localhost` in `prod.exs`**

`config/prod.exs` line 5:
```
url: [host: "localhost", port: 4000]
```
The production endpoint URL is configured as `localhost`. This affects URL generation (e.g., email links, redirects). This suggests either the server sits behind a reverse proxy that was never configured here, or the production URL is simply not set correctly. Generated URLs in emails or webhooks will contain `localhost` as the host.

---

**A001-12 — MEDIUM: `timeout: :infinity` on `FortyNineRepo` in dev and prod**

`config/dev.exs` line 72 and `config/prod.exs` line 24:
```
timeout: :infinity
```
An infinite database query timeout on a production repository means a hung query will hold a connection pool slot indefinitely, enabling a denial-of-service condition through connection pool exhaustion.

---

**A001-13 — INFO: Prior AWS IAM key preserved in comments across multiple files**

The old IAM access key `[REDACTED-AWS-KEY-ID]` and its password `[REDACTED-AWS-SMTP-PASSWORD]` appear in commented-out blocks in `config/config.exs` (lines 115–116), `config/dev.exs` (lines 96–99), `config/prod.exs` (lines 43–44), and `config/test.exs` (lines 56–58). Even if revoked, these remain in git history and represent credential hygiene debt. The comments should be removed and git history cleaned.

---

### §2 Authentication and Authorization

**A001-14 — HIGH: Guardian signing algorithm not explicitly configured — default risk**

`config/config.exs` configures Guardian with only `issuer`, `ttl`, and `secret_key`. No `allowed_algos` or `secret_fetcher` module is specified. Guardian 1.x defaults to `HS512` when a binary secret key is provided. While HS512 is not inherently insecure, the absence of explicit algorithm configuration means the acceptable algorithm set is not auditable from configuration alone. Combined with the hardcoded `secret_key` (A001-2), any compromise of the key allows forging tokens with the default algorithm. Explicit `allowed_algos: ["HS512"]` (or RS256 with a key pair) should be configured.

---

**A001-15 — MEDIUM: `check_origin: false` in `dev.exs` — WebSocket origin not validated in dev**

`config/dev.exs` line 13:
```
check_origin: false
```
While this is a development-only setting, if the Docker image is built with `MIX_ENV=dev` or if dev config is accidentally applied to a staging/production-like environment, WebSocket connections will be accepted from any origin. The Dockerfile sets `MIX_ENV=prod`, which mitigates this for production builds, but the configuration remains a risk for any non-production deployment using this image pattern.

§2: No further issues found in the assigned files. (Router/endpoint files are not in the assigned file set for this pass; authentication pipeline review is deferred to a later pass covering those files.)

---

### §3 Input Validation and Injection

§3: No issues found in the assigned files. (Controller, context, and schema files are not in the assigned file set for this pass.)

---

### §4 Session and CSRF

**A001-16 — HIGH: `secret_key_base` hardcoded in two tracked files — session/CSRF forgery risk**

Covered under A001-3. The `secret_key_base` is the cryptographic root for Plug session signing and CSRF token generation. Its exposure in git means sessions can be forged and CSRF tokens can be computed by anyone with repository read access.

§4: No additional session or CSRF configuration was observable in the assigned files beyond the `secret_key_base` issues already reported. Cookie flags, session storage backend, and channel `connect/3` validation are in endpoint/router files deferred to a later pass.

---

### §5 File and Data Handling

**A001-17 — CRITICAL: 21 data files (20 CSV + 1 SQL) committed and tracked in git**

`git ls-files` confirms the following data files are tracked in the repository and committed since the initial commit (`e675b0b Initial clean commit into CIG bitbucket`):

**CSV files (20):**
- `2021-11-29.csv` (1,201 lines) — customer work order data with customer numbers, equipment serials, invoice amounts, addresses
- `2021-11-30.csv`
- `2021-12-06.csv`
- `2022-03-04 Pronto.csv`
- `2022-05-23 Work Orders.csv`
- `Daily Usage Summary - 2020-06-21.csv`
- `EBS Data .csv` (2,402 lines) — equipment service records with hardware IDs and customer numbers
- `EBS Data 2021-11-30.csv`
- `EBS Data 2022-01-18.csv`
- `EBS Data 2022-05-24.csv`
- `EBS Data 2022-05-24a.csv`
- `EBS Data 2022-03-04.csv` (as `Pronto Data Processed 2022-03-04.csv`)
- `all.csv`
- `anniversary_data_1.csv`
- `next_services.csv`
- `small.csv`
- `speed.csv`
- `usage_data.csv` (60,960 lines) — per-device usage data with customer identifiers and hardware IDs
- `usage_data_ayo.csv`
- `usage_report.csv`
- `vehicle_status.csv` (1,139 lines) — vehicle fleet data with serial numbers, product codes, GPS geofence locations, service types, customer locations

**SQL file (1):**
- `dump.sql` — present and tracked; file is empty (0 bytes) on disk but is in git history

Inspected CSV samples confirm real operational data: customer numbers (`kcustnum`), equipment serial numbers (`kserialnum`), invoice numbers (`arinvno`), work order text, hardware device IDs, GPS geofence locations, customer postal codes. This constitutes PII-adjacent operational and fleet data.

The `.gitignore` has no entries for `*.csv`, `*.sql`, or data files. These files were never excluded and are now part of the repository's permanent git history.

**Immediate action required:** Remove these files from the working tree, add exclusion patterns to `.gitignore`, and use `git filter-repo` or BFG Repo Cleaner to purge them from git history. All persons with repository access must be notified that this data was exposed. Consider whether data breach notification obligations apply.

---

**A001-18 — MEDIUM: `dump.sql` tracked in git (empty on disk but in history)**

The file `dump.sql` is tracked by git (confirmed via `git ls-files`). While it is currently 0 bytes on disk, it was introduced in the initial commit. If it ever contained a database dump — or if git history contains a non-empty version — that data is permanently accessible to anyone who can clone the repository. A full history audit with `git log -p -- dump.sql` should be performed to determine whether any non-empty version was committed.

---

### §6 Dependencies

**A001-19 — HIGH: `mariaex ~>0.8.2` — deprecated package with no security support**

`mix.exs` line 39: `{:mariaex, "~>0.8.2"}`
`mix.lock` resolves to `mariaex 0.8.4`.

The checklist explicitly flags Mariaex 0.8.2 as deprecated with no security support. This package has not received updates and any security vulnerabilities discovered will not be patched. The recommended migration path is to `myxql`, which is the actively maintained MySQL/MariaDB driver for Ecto 3+. Note that migration requires upgrading Ecto from 2.x to 3.x simultaneously.

---

**A001-20 — HIGH: Ecto 2.2.12 — end-of-life version**

`mix.lock` resolves `ecto` to `2.2.12`. Ecto 2.x is end-of-life; all security maintenance has moved to Ecto 3.x. Using an unmaintained ORM version on a production fleet management system accepting external data is a significant risk.

---

**A001-21 — HIGH: Cowboy 1.1.2 / plug_cowboy 1.0.0 — end-of-life HTTP server**

`mix.exs` declares `{:cowboy, "~> 1.0"}` and `{:plug_cowboy, "~> 1.0"}`.
`mix.lock` resolves `cowboy` to `1.1.2` and `plug_cowboy` to `1.0.0`.

Cowboy 1.x is end-of-life. Cowboy 2.x introduced significant security and correctness improvements including HTTP/2 support and better request smuggling protections. Running Cowboy 1.x in production exposes the application to unpatched vulnerabilities in the HTTP server.

---

**A001-22 — MEDIUM: `{:geohax, ">= 0.0.0"}` — unbounded version constraint**

`mix.exs` line 57: `{:geohax, ">= 0.0.0"}`

An unbounded version constraint (`>= 0.0.0`) means any future version of geohax, including major versions with breaking changes or potential supply-chain compromises, could be resolved. `mix.lock` pins it to `0.3.0`, which provides reproducibility for existing builds, but the constraint in `mix.exs` is dangerous: if `mix.lock` is ever regenerated (e.g., `mix deps.update --all`), the resolved version could jump arbitrarily. This should be tightened to a specific approximate version such as `"~> 0.3"`.

---

**A001-23 — MEDIUM: `{:geonames, path: "geonames-elixir"}` — local path dependency**

`mix.exs` line 56: `{:geonames, path: "geonames-elixir"}`

This dependency is loaded from a local directory rather than hex.pm. It does not appear in `mix.lock` (local path deps are not locked). This means: (a) the exact version used is not reproducibly pinned; (b) the code is not subject to hex.pm's checksum verification; (c) the dependency is not visible for vulnerability scanning. The local `geonames-elixir` directory must be audited separately. If the package is suitable for publication, it should be published to hex.pm and declared as a versioned dependency.

---

**A001-24 — MEDIUM: Phoenix 1.5.13 — significantly outdated framework**

`mix.lock` resolves `phoenix` to `1.5.13`. Phoenix 1.7+ introduced significant security improvements including better CSRF handling and LiveView security fixes. Running Phoenix 1.5 in production means missing multiple patch releases of security improvements. The `mix.exs` constraint `"~> 1.5.9"` prevents upgrading to 1.6+.

---

**A001-25 — MEDIUM: Guardian 1.2.1 — outdated authentication library**

`mix.lock` resolves `guardian` to `1.2.1`. Guardian 2.x introduced API improvements and security fixes. Combined with the extremely long TTL (A001-10) and hardcoded secret (A001-2), this represents a compounded authentication risk.

---

**A001-26 — MEDIUM: `brunch ^2.10.17` — outdated and unmaintained JS build tool**

`assets/package.json` declares `"brunch": "^2.10.17"`. Brunch has been largely abandoned as a build tool in favour of webpack and esbuild. While this is an assets pipeline concern, unmaintained build tools can introduce vulnerabilities in the build environment. The `^` prefix allows minor-version bumps automatically. This should be migrated to a maintained build tool such as esbuild (which Phoenix 1.7+ uses by default).

---

**A001-27 — INFO: `acorn 5.7.3` in package-lock.json — known vulnerability history**

`assets/package-lock.json` resolves `acorn` to `5.7.3` (a dev dependency of brunch). Acorn versions prior to 5.7.4, 6.4.1, and 7.1.1 had a ReDoS vulnerability (CVE-2020-7598). Version 5.7.3 is below the patched 5.7.4 threshold. While this is a build-time dev dependency (not included in the runtime Docker image), it could be exploited in a CI/CD environment that runs `npm install` and processes malicious JavaScript source files.

---

**A001-28 — INFO: `distillery 1.5.5` — outdated release tooling**

`mix.lock` resolves `distillery` to `1.5.5`. Distillery 2.x and the now-standard Mix Releases (built into Elixir 1.9+) are preferred. Distillery 1.x has known issues with hot-upgrades and release configuration. For security, release tooling should be current to ensure correct handling of environment variables and secrets in the release boot process.

---

### §7 Infrastructure Exposure

**A001-29 — HIGH: AWS region, RDS cluster endpoint, and external service hostname hardcoded in tracked config**

See A001-8. In summary:
- Region `ap-southeast-2` is exposed through the RDS hostname.
- The full Aurora cluster endpoint `vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com` is hardcoded in both dev and prod configs.
- The external hostname `svr49.tracking-intelligence.com` is hardcoded with its database credentials.

This information, combined with the leaked credentials (A001-4), provides a complete connection profile for the production database to any reader of this repository.

---

**A001-30 — HIGH: Docker `chmod -R 777 /opt/app` — overly permissive directory permissions**

`Dockerfile` line 7:
```
chmod -R 777 /opt/app
```
Setting world-writable (`777`) permissions on the application directory allows any process running in the container — including any compromised dependency or injected code — to write to the application directory. This is a significant container hardening failure. The directory should be owned by a non-root user with permissions `755` or stricter, and the application should run as a non-root user.

---

**A001-31 — HIGH: Docker container runs as root**

The Dockerfile does not create a non-root user or include a `USER` directive. The application process (`api_server start`) runs as root inside the container. If any vulnerability allows command injection or container escape, the attacker has root-level access. A dedicated low-privilege user should be created and used to run the application.

---

**A001-32 — MEDIUM: Docker image based on `bitwalker/alpine-elixir:1.13.4` — community image, potentially outdated**

The base image `bitwalker/alpine-elixir:1.13.4` is a community-maintained image (not an official Elixir or Alpine image). Community images may not receive timely security updates. Elixir 1.13.4 was released in early 2022; current Elixir is 1.16+. The underlying Alpine packages installed during `RUN apk update` will pull latest Alpine packages at build time, but the Elixir runtime and OTP version are pinned to what the base image provides. The official `hexpm/elixir` Docker images are recommended instead.

---

**A001-33 — MEDIUM: No TLS termination configured in the application**

`config/prod.exs` configures only HTTP (`http: [port: 4000]`). The `https:` key is commented out with a note referencing `SOME_APP_SSL_KEY_PATH` and `SOME_APP_SSL_CERT_PATH` environment variables. There is no `force_ssl` configuration. If TLS is not terminated by an upstream load balancer or reverse proxy, traffic to and from the application travels unencrypted. Given that this is a fleet management API handling vehicle locations and driver data, unencrypted transport is unacceptable. Confirmation that TLS is terminated externally (e.g., at an AWS ALB) is required; this is not verifiable from the assigned files alone.

---

**A001-34 — MEDIUM: `EXPOSE 4001` / `ENV TCP_PORT=4001` — unknown TCP service exposed**

The Dockerfile exposes port 4001 and sets `TCP_PORT=4001`. The purpose of this port is not documented in the assigned files. If this is an Erlang distribution port, it should never be exposed publicly. The port's purpose and access controls must be verified in the application source files.

---

**A001-35 — INFO: `cors_plug ~> 1.5` — CORS configuration not visible in assigned files**

`mix.exs` includes `{:cors_plug, "~> 1.5"}`. CORS configuration (allowed origins, methods, headers) is typically set in the endpoint or router, which are not in the assigned file set. A001-35 notes that CORS configuration must be reviewed in subsequent passes to verify that wildcard origins are not permitted for authenticated endpoints.

---

## Summary Table

| ID       | Severity | Section | Title |
|----------|----------|---------|-------|
| A001-1   | CRITICAL | §1      | AWS SES SMTP credentials hardcoded in 4 tracked config files |
| A001-2   | CRITICAL | §1      | Guardian JWT secret key hardcoded in tracked config |
| A001-3   | CRITICAL | §1      | Phoenix `secret_key_base` hardcoded in 2 tracked config files |
| A001-4   | CRITICAL | §1      | Production DB passwords hardcoded in tracked config files |
| A001-5   | CRITICAL | §1      | `prod.secret.exs` tracked in git (.gitignore entry commented out) |
| A001-6   | CRITICAL | §1      | Erlang distribution cookies hardcoded in tracked `rel/config.exs` |
| A001-7   | HIGH     | §1      | Geonames third-party API username hardcoded |
| A001-8   | HIGH     | §1      | AWS RDS endpoint and external service hostname hardcoded |
| A001-9   | HIGH     | §1      | No `bitbucket-pipelines.yml` — CI/CD pipeline absent from source control |
| A001-10  | MEDIUM   | §1      | Guardian TTL 52 weeks — excessively long token lifetime |
| A001-11  | MEDIUM   | §1      | Production URL host configured as `localhost` |
| A001-12  | MEDIUM   | §1      | `timeout: :infinity` on FortyNineRepo in dev and prod |
| A001-13  | INFO     | §1      | Prior AWS IAM key preserved in comments across config files |
| A001-14  | HIGH     | §2      | Guardian signing algorithm not explicitly configured |
| A001-15  | MEDIUM   | §2      | `check_origin: false` in dev config |
| A001-16  | HIGH     | §4      | `secret_key_base` hardcoded — session/CSRF forgery risk (see A001-3) |
| A001-17  | CRITICAL | §5      | 20 CSV + 1 SQL data files committed and tracked in git |
| A001-18  | MEDIUM   | §5      | `dump.sql` tracked in git (empty on disk, history unknown) |
| A001-19  | HIGH     | §6      | `mariaex ~>0.8.2` — deprecated, no security support |
| A001-20  | HIGH     | §6      | Ecto 2.2.12 — end-of-life version |
| A001-21  | HIGH     | §6      | Cowboy 1.1.2 / plug_cowboy 1.0.0 — end-of-life HTTP server |
| A001-22  | MEDIUM   | §6      | `{:geohax, ">= 0.0.0"}` — unbounded version constraint |
| A001-23  | MEDIUM   | §6      | `{:geonames, path: "geonames-elixir"}` — local path dependency, not locked |
| A001-24  | MEDIUM   | §6      | Phoenix 1.5.13 — significantly outdated framework |
| A001-25  | MEDIUM   | §6      | Guardian 1.2.1 — outdated authentication library |
| A001-26  | MEDIUM   | §6      | `brunch ^2.10.17` — outdated and unmaintained build tool |
| A001-27  | INFO     | §6      | `acorn 5.7.3` — below patched threshold for CVE-2020-7598 (dev dep) |
| A001-28  | INFO     | §6      | `distillery 1.5.5` — outdated release tooling |
| A001-29  | HIGH     | §7      | AWS region, RDS endpoint, external hostname hardcoded |
| A001-30  | HIGH     | §7      | Docker `chmod -R 777 /opt/app` — overly permissive |
| A001-31  | HIGH     | §7      | Docker container runs as root (no USER directive) |
| A001-32  | MEDIUM   | §7      | Community base image `bitwalker/alpine-elixir:1.13.4` — potentially outdated |
| A001-33  | MEDIUM   | §7      | No TLS termination configured in application |
| A001-34  | MEDIUM   | §7      | Port 4001 / TCP_PORT exposed with no documented purpose |
| A001-35  | INFO     | §7      | CORS configuration not visible — deferred to later pass |

---

## Critical Actions Required (Immediate)

1. **Revoke and rotate** all credentials exposed in this repository: AWS IAM key `[REDACTED-AWS-KEY-ID]`, SES SMTP password, both database passwords (`TRxbixk9fuZc`, `Q973bFtc9z/cVW#mA`), Guardian JWT secret key, both Phoenix `secret_key_base` values, and both Erlang distribution cookies.
2. **Purge git history** of all secrets using `git filter-repo` or BFG Repo Cleaner; force-push to all remotes; notify all collaborators to re-clone.
3. **Remove all CSV and SQL data files** from the working tree and git history. Assess data breach notification obligations under applicable privacy law (GDPR, Australian Privacy Act) given the customer fleet data exposed.
4. **Add `.gitignore` entries** for `*.csv`, `*.sql`, `/config/*.secret.exs`, and any other data or secret file patterns.
5. **Move all secrets to environment variables** or a secrets manager (AWS Secrets Manager, Parameter Store); reference them with `System.get_env/1` in runtime configuration.

<!-- A012.md -->
# Audit Report A012
**Agent:** A012
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Scope:** geonames-elixir (vendored third-party library)

---

## Assigned Files

- `geonames-elixir/config/config.exs`
- `geonames-elixir/lib/geonames.ex`
- `geonames-elixir/lib/geonames/endpoint.ex`
- `geonames-elixir/lib/geonames/helpers.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/config/config.exs`

**Module name:** N/A (Mix configuration file using `use Mix.Config`)

**Public functions:** None (configuration DSL, not a module with functions)

**defstruct / defexception / schema:** None

**use / import / alias at module level:**
- `use Mix.Config` (line 3)

**Configuration values set:**
- `config :geonames, username: "testuser"` (line 6)
- `config :geonames, language: "es"` (line 7)

---

### File 2: `geonames-elixir/lib/geonames.ex`

**Module name:** `Geonames`

**Public functions** (all generated via metaprogramming `for endpoint <- endpoints do ... def unquote(endpoint.function_name)(args \\ %{})` — one per endpoint, arity 0..1, line 96):

The following public functions are generated at compile time (line 96), one per endpoint module listed lines 42–79:
- `astergdem/0..1`
- `children/0..1`
- `cities/0..1`
- `contains/0..1`
- `country_code/0..1`
- `country_info/0..1`
- `country_subdivision/0..1`
- `earthquakes/0..1`
- `find_nearby/0..1`
- `find_nearby_place_name/0..1`
- `find_nearby_postal_codes/0..1`
- `find_nearby_streets/0..1`
- `find_nearby_streets_osm/0..1`
- `find_nearby_weather/0..1`
- `find_nearby_wikipedia/0..1`
- `find_nearest_address/0..1`
- `find_nearest_intersection/0..1`
- `find_nearest_intersection_osm/0..1`
- `find_nearby_pois_osm/0..1`
- `get/0..1`
- `gtopo30/0..1`
- `hierarchy/0..1`
- `neighbourhood/0..1`
- `neighbours/0..1`
- `ocean/0..1`
- `postal_code_country_info/0..1`
- `postal_code_lookup/0..1`
- `postal_code_search/0..1`
- `search/0..1`
- `siblings/0..1`
- `srtm1/0..1`
- `srtm3/0..1`
- `timezone/0..1`
- `weather/0..1`
- `weather_icao/0..1`
- `wikipedia_bounding_box/0..1`
- `wikipedia_search/0..1`

Additionally:
- `perform_geonames_request/1` (line 130) — public, arity 1

**defstruct / defexception / schema:** None

**use / import / alias at module level:**
- `alias Geonames.Endpoints, as: EP` (line 38)
- `alias Geonames.Helpers` (line 39)

---

### File 3: `geonames-elixir/lib/geonames/endpoint.ex`

**Module name:** `Geonames.Endpoint`

**Public functions:** None (behaviour definition only, no `def`)

**Callbacks defined:**
- `@callback endpoint :: String.t` (line 10)
- `@callback available_url_parameters :: list(Atom.t)` (line 11)
- `@callback required_url_parameters :: list(Atom.t)` (line 12)
- `@callback function_name :: Atom.t` (line 13)
- `@callback url_arguments(map) :: map` (line 14)

**defstruct / defexception / schema:** None

**use / import / alias at module level:** None

---

### File 4: `geonames-elixir/lib/geonames/helpers.ex`

**Module name:** `Geonames.Helpers`

**Public functions:**
- `required_parameters_provided?/2` (line 14, arity 2)
- `build_url_string/2` (line 30, arity 2)

**Private functions:**
- `user_configuration/0` (line 51, `defp`)

**defstruct / defexception / schema:** None

**use / import / alias at module level:** None

**Module attributes:**
- `@base_url` (line 8) — set at compile time via `Application.get_env(:geonames, :base_url, "api.geonames.org/")`

---

## Security Findings

### §1: Secrets and Configuration

**A012-1** — MEDIUM — Hardcoded credential (GeoNames username) in vendored library config

**File:** `geonames-elixir/config/config.exs`, line 6
**Evidence:**
```elixir
config :geonames,
  username: "testuser",
  language: "es"
```
The GeoNames API username `"testuser"` is hardcoded as the default value in the library's `config.exs`. This credential would be present in source control. Although this is the vendored library's own config file (which Elixir does not load from sub-dependencies), the fact that the value is present in source creates a risk: if the parent application does not explicitly override `:geonames, :username`, this value may remain as the operative credential. The `Geonames.Helpers.user_configuration/0` function (helpers.ex, line 53) will fall back to `Application.get_env(:geonames, :username)` if the env var `GEONAMES_USERNAME` is not set. A tracked, non-overridden username is a credentials-in-source-control issue.

**Recommendation:** The parent application's production config must set `:geonames, :username` from an environment variable. Verify this is the case in the parent project's `runtime.exs` or `prod.exs`. The vendored file should not contain a live username.

---

**A012-2** — LOW — Hardcoded language default `"es"` in vendored library config

**File:** `geonames-elixir/config/config.exs`, line 7
**Evidence:**
```elixir
language: "es"
```
The language default is set to Spanish (`"es"`) in the vendored config rather than English (`"en"`). While not a secret, this is an unexpected default that differs from the library's own fallback in `helpers.ex` (line 54, which falls back to `"en"` if `GEONAMES_LANGUAGE` env var is unset). The vendored config value would silently override the code-level default. This is a configuration integrity issue introduced by vendoring.

---

**A012-3** — MEDIUM — `@base_url` resolved at compile time, preventing runtime override

**File:** `geonames-elixir/lib/geonames/helpers.ex`, line 8
**Evidence:**
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```
The base URL is captured into a module attribute at compile time. `Application.get_env/3` in a module attribute (`@`) is evaluated during compilation, not at runtime. This means the base URL cannot be changed without recompilation, and if the compile-time application environment does not include the `:geonames` app config being fully loaded, the default `"api.geonames.org/"` will be baked in regardless of any runtime configuration. Additionally, note the URL has no scheme — the assembled URL (line 47: `@base_url <> endpoint <> "?" <> encoded_params`) would produce a string like `api.geonames.org/searchJSON?...` with no `http://` or `https://` prefix. HTTPoison/hackney would reject or mishandle this URL unless the parent application overrides `base_url` to include a full scheme. This may cause silent failures in production.

---

### §2: Authentication and Authorization

**A012-4** — INFO — GeoNames API authentication uses only a username parameter, with no secret/password

**File:** `geonames-elixir/lib/geonames/helpers.ex`, lines 52–55
**Evidence:**
```elixir
defp user_configuration do
  %{
    username: Application.get_env(:geonames, :username) || System.get_env("GEONAMES_USERNAME"),
    language: Application.get_env(:geonames, :language, System.get_env("GEONAMES_LANGUAGE") || "en")
  }
end
```
The GeoNames API authenticates requests solely by embedding the username as a plain URL query parameter (not a token or signed request). This is by design for the geonames.org free/commercial API, but it means the credential is visible in any HTTP logs, proxy logs, or error messages. There is no HMAC signing or token-based authentication. This is a characteristic of the upstream API, not a library bug, but the parent application should be aware that the GeoNames username will appear in outbound HTTP request logs.

---

### §3: Input Validation and Injection

**A012-5** — MEDIUM — URL parameters are string-interpolated without URL-encoding individual values before joining

**File:** `geonames-elixir/lib/geonames/helpers.ex`, lines 34–46
**Evidence:**
```elixir
|> Enum.map(fn
  {_,nil}                    -> nil
  {k,v} when is_binary(v)    -> "#{k}=#{v}"
  {k,v} when is_float(v)     -> "#{k}=#{v}"
  {k,v} when is_boolean(v)   -> "#{k}=#{v}"
  {k,v} when is_integer(v)   -> "#{k}=#{v}"
  {k,arr} when is_list(arr)  -> Enum.map(arr, &"#{k}=#{&1}")
end)
|> List.flatten
|> Enum.filter(fn(k) -> !is_nil(k) end)
|> Enum.join("&")
|> URI.encode
```
Individual parameter values are interpolated directly into the query string with `"#{k}=#{v}"` before the final `URI.encode/1` is called on the entire assembled string. `URI.encode/1` (without specifying a custom encoder) encodes the full string but preserves characters that are legal in a URI — including `=` and `&`. This means a user-supplied string value containing `&` or `=` (e.g., a search query like `"London&username=attacker"`) would not be properly percent-encoded per key, allowing parameter injection into the GeoNames API request. The correct approach is to use `URI.encode_query/1` on the parameter map, which encodes each key-value pair individually. This is a query-parameter injection vulnerability affecting all endpoints that accept free-text string parameters (e.g., `search`, `wikipedia_search`, `postal_code_search`).

---

**A012-6** — LOW — No validation of parameter value types or content beyond type guards

**File:** `geonames-elixir/lib/geonames/helpers.ex`, lines 34–41; `geonames-elixir/lib/geonames.ex`, lines 96–110
The library performs only binary/float/boolean/integer/list type guards on parameter values before interpolation. There is no validation of value content (e.g., numeric range checks for latitude/longitude, format validation for dates). Malformed values will be forwarded directly to the GeoNames API, which may return unexpected responses. This is a low-severity issue in the context of a geo lookup library, but the parent application should validate inputs before calling these functions.

---

### §4: Session and CSRF

§4: No issues found. This is a stateless HTTP client library with no session management, cookies, or CSRF relevance.

---

### §5: File and Data Handling

**A012-7** — LOW — API responses are decoded with `Poison.decode!/1` (bang form — raises on error) and raw decoded maps are returned directly to callers

**File:** `geonames-elixir/lib/geonames.ex`, lines 131–141
**Evidence:**
```elixir
def perform_geonames_request(url) do
  case HTTPoison.get(url) do
    { :ok, %HTTPoison.Response{ status_code: 200, body: body }} ->
      { :ok, Poison.decode!(body) }

    { :ok, %HTTPoison.Response{ status_code: status_code, body: body }} ->
      { :error, "An unexpected #{status_code} response was received"}

    { :error, %HTTPoison.Error{ reason: reason }} ->
      { :error, "Request failed with the following error: #{to_string(reason)}" }
  end
end
```
`Poison.decode!/1` raises a `Poison.ParseError` exception if the response body is not valid JSON. This exception is not caught, so a malformed or unexpected response from the GeoNames API (or a network intermediary returning an HTML error page) will cause an unhandled exception to propagate to the caller. The generated endpoint functions (geonames.ex, lines 101–106) re-raise `RuntimeError` on `{:error, ...}` tuples but do not catch exceptions from `perform_geonames_request/1`. Callers must be prepared to handle both `RuntimeError` and `Poison.ParseError`. If this error propagates to a Phoenix controller, it may expose a stack trace in development, and in production it may result in a 500 error without graceful handling. The parent application should ensure `perform_geonames_request/1` calls are wrapped in `try/rescue` or the error path is converted to a safe `{:error, reason}` tuple.

**A012-8** — INFO — GeoNames API responses are passed through to callers without sanitization

The decoded JSON map from the GeoNames API is returned directly to callers without validation of field presence, type, or content. If the GeoNames API returns unexpected or malicious content (e.g., if DNS is hijacked or the API is compromised), the raw map is forwarded. The parent application should treat all GeoNames API response data as untrusted external input.

---

### §6: Dependencies

**A012-9** — HIGH — Vendored third-party library not managed via hex.pm

**Location:** `geonames-elixir/` directory (entire subtree present in the api_server repository)
The `geonames-elixir` library is vendored directly into the repository rather than being declared as a hex.pm dependency or a `git:` path dependency in the parent project's `mix.exs`. Vendoring has the following security implications:

1. **No automatic vulnerability notifications:** hex.pm provides security advisories for published packages. A vendored copy receives no such notifications; the team must manually monitor for vulnerabilities in the library and its transitive dependencies.
2. **Dependency version drift:** The vendored library has its own `mix.lock` (within `geonames-elixir/`). This lock file is independent of the parent project's `mix.lock`. The transitive dependencies (HTTPoison 1.3.0, Hackney 1.13.0, Poison 3.1.0, certifi 2.3.1) are pinned to versions from approximately 2018–2019 and have not been updated. These are significantly outdated.
3. **Modifications are invisible:** Any changes made to the vendored source are not tracked against the upstream library version, making security patch application and auditing difficult.
4. **Supply chain risk:** The library (`geonames-elixir` v1.0.3, originally from `https://github.com/pareeohnos/geonames-elixir`) is now under full control of whoever committed it to this repository. No hash-based integrity verification exists for the vendored source.

**Recommendation:** Replace the vendored copy with a declared hex.pm dependency (`{:geonames, "~> 1.0"}`) or a locked git dependency with a pinned commit SHA. The parent project's `mix.lock` should control all transitive dependency versions.

---

**A012-10** — HIGH — Significantly outdated transitive dependencies with potential unpatched CVEs

**File:** `geonames-elixir/mix.lock`
The vendored library's own `mix.lock` pins the following notably old versions:

| Package | Vendored Version | Notes |
|---|---|---|
| `httpoison` | 1.3.0 (2018) | Current is 2.x; multiple fixes since 1.3.0 |
| `hackney` | 1.13.0 (2018) | Current is 1.20.x; multiple TLS and HTTP fixes since 1.13.0 |
| `poison` | 3.1.0 (2017) | Current is 5.x; no active security support for 3.x |
| `certifi` | 2.3.1 (2018) | CA bundle from 2018 — may contain expired or revoked roots |
| `ssl_verify_fun` | 1.1.1 (2016) | Current is 1.1.7; SSL verification fixes applied since 1.1.1 |

The `certifi 2.3.1` CA bundle is particularly concerning: it is from 2018 and may not include current trusted roots or may include roots that have since been distrusted. The parent api_server project recently fixed a TLS issue (commit `e486dd8`: "Fix Rayven TLS 'Unknown CA' error after Sectigo Root R46 cert renewal"), suggesting TLS certificate chain validation is a live operational concern. The vendored library's outdated `certifi` bundle would cause similar failures for GeoNames API calls if the GeoNames API's certificate chain depends on roots added after 2018.

**Note:** Whether the vendored library's `mix.lock` is actually used at runtime depends on how the parent project integrates the vendored code. If the parent project's `mix.exs` includes the vendored library as a `path:` dependency, the parent's `mix.lock` controls all deps and the vendored `mix.lock` is ignored. If the vendored code is compiled independently (i.e., the directory is on the `$ELIXIR_LIB_PATH` or similar), the vendored lock file would be operative. This should be verified.

---

**A012-11** — LOW — Vendored library requires `elixir: "~> 1.2"` — compatible with very old Elixir versions

**File:** `geonames-elixir/mix.exs`, line 7
The library specifies `elixir: "~> 1.2"`, meaning it was written for and tested against Elixir 1.2 (released 2016). No minimum bound is set for current supported Elixir versions. This is informational but indicates the library has not been maintained for a long time.

---

### §7: Infrastructure Exposure

**A012-12** — MEDIUM — Base URL defaults to plain HTTP (no scheme), and TLS is not enforced

**File:** `geonames-elixir/lib/geonames/helpers.ex`, line 8 and line 47
**Evidence:**
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
# ...
@base_url <> endpoint <> "?" <> encoded_params
```
The default `@base_url` value is `"api.geonames.org/"` — a bare hostname with no URL scheme. The assembled URL string would be `"api.geonames.org/searchJSON?..."`. HTTPoison/hackney may treat this as a relative URL or fail to parse it, depending on version. Even if the parent application overrides `base_url` to `"http://api.geonames.org/"`, that would mean all GeoNames API requests — including those carrying the API username credential — are transmitted over plain HTTP with no TLS. The GeoNames API is available over HTTPS (`https://secure.geonames.org/`). The library does not enforce or document HTTPS usage. The GeoNames username (a credential) would be transmitted in cleartext over HTTP if the parent application uses the default or an HTTP base URL.

**Recommendation:** The parent application's configuration must set `:geonames, :base_url` to `"https://secure.geonames.org/"` to ensure HTTPS is used for all GeoNames API calls.

---

**A012-13** — INFO — `perform_geonames_request/1` is public — exposes internal HTTP client capability

**File:** `geonames-elixir/lib/geonames.ex`, line 130
`perform_geonames_request/1` accepts an arbitrary URL string and performs an HTTP GET, returning parsed JSON. This function is `def` (public), not `defp` (private). Any code with access to the `Geonames` module can call this function with an arbitrary URL, potentially making HTTP requests to internal services or infrastructure endpoints. While this is a library design issue (not a direct vulnerability in api_server), the parent application should not expose this function through any API surface.

---

## Summary Table

| ID | Severity | Section | Title |
|---|---|---|---|
| A012-1 | MEDIUM | §1 | Hardcoded GeoNames username `"testuser"` in vendored config |
| A012-2 | LOW | §1 | Unexpected language default `"es"` overrides library default |
| A012-3 | MEDIUM | §1 | `@base_url` compiled at build time — runtime override ineffective; no URL scheme |
| A012-4 | INFO | §2 | GeoNames authentication via plain URL parameter — credential in HTTP logs |
| A012-5 | MEDIUM | §3 | URL parameter injection via insufficient per-value encoding (`URI.encode` on full string) |
| A012-6 | LOW | §3 | No content validation of parameter values before dispatch to GeoNames API |
| A012-7 | LOW | §5 | `Poison.decode!/1` raises uncaught exception on non-JSON responses |
| A012-8 | INFO | §5 | GeoNames API responses passed through without sanitization |
| A012-9 | HIGH | §6 | Library vendored rather than managed via hex.pm — no vulnerability tracking |
| A012-10 | HIGH | §6 | Outdated transitive dependencies (hackney 1.13, certifi 2.3.1, ssl_verify_fun 1.1.1) |
| A012-11 | LOW | §6 | Library targets Elixir ~> 1.2 — unmaintained |
| A012-12 | MEDIUM | §7 | No TLS enforcement — default base URL lacks scheme, credentials sent in cleartext |
| A012-13 | INFO | §7 | `perform_geonames_request/1` is public — arbitrary URL HTTP client accessible to callers |

<!-- A015.md -->
# Security Audit Report — A015
**Agent:** A015
**Run:** 2026-02-27-01
**Repo:** api_server
**Branch:** master
**Stack:** Elixir/Phoenix
**Scope:** Vendored geonames-elixir endpoint modules

---

## Assigned Files

1. `geonames-elixir/lib/geonames/endpoints/atergdem.ex`
2. `geonames-elixir/lib/geonames/endpoints/children.ex`
3. `geonames-elixir/lib/geonames/endpoints/cities.ex`

Supporting files read for full context (not in scope but necessary for accurate audit):
- `geonames-elixir/lib/geonames/endpoint.ex` (behaviour definition)
- `geonames-elixir/lib/geonames.ex` (macro-generated public API, HTTP dispatch)
- `geonames-elixir/lib/geonames/helpers.ex` (URL construction, credential injection)
- `geonames-elixir/mix.exs` (dependency manifest for vendored library)
- `config/config.exs` lines 138-140 (geonames runtime configuration)

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/atergdem.ex`

**Module name:** `Geonames.Endpoints.Astergdem`

Note: the filename is `atergdem.ex` but the module is named `Astergdem` — this is a pre-existing discrepancy in the vendored library (filename typo, not a security issue).

**Public functions (def, not defp):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 10 |
| `available_url_parameters/0` | 0 | 11 |
| `required_url_parameters/0` | 0 | 12 |
| `function_name/0` | 0 | 13 |
| `url_arguments/1` | 1 | 15 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attribute:**
```elixir
@default_arguments %{ lat: nil, lng: nil }
```

---

### File 2: `geonames-elixir/lib/geonames/endpoints/children.ex`

**Module name:** `Geonames.Endpoints.Children`

**Public functions (def, not defp):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 11 |
| `available_url_parameters/0` | 0 | 12 |
| `required_url_parameters/0` | 0 | 13 |
| `function_name/0` | 0 | 14 |
| `url_arguments/1` | 1 | 16 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attribute:**
```elixir
@default_arguments %{
  geonameId: nil,
  maxRows: 200,
  hierarchy: "tourism"
}
```

---

### File 3: `geonames-elixir/lib/geonames/endpoints/cities.ex`

**Module name:** `Geonames.Endpoints.Cities`

**Public functions (def, not defp):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 13 |
| `available_url_parameters/0` | 0 | 14 |
| `required_url_parameters/0` | 0 | 15 |
| `function_name/0` | 0 | 16 |
| `url_arguments/1` | 1 | 18 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attribute:**
```elixir
@default_arguments %{
  north: nil,
  south: nil,
  east: nil,
  west: nil,
  maxRows: 10
}
```

---

## Checklist Review

### §1: Secrets and Configuration

**Finding A015-1** — CRITICAL: Hardcoded GeoNames API username in tracked config file.

File: `config/config.exs`, lines 138–140:
```elixir
config :geonames,
  username: "vinxstudio",
  language: "en"
```

The GeoNames API username `"vinxstudio"` is committed in plaintext in a tracked source file. This is the credential used by `Geonames.Helpers.user_configuration/0` to authenticate every outbound API call to `api.geonames.org`. A hardcoded API credential in a tracked config file is a secret leakage: anyone with read access to the repository (including CI pipelines, audit tools, or future employees) can extract and abuse this credential. The correct pattern is to load it from an environment variable: `System.get_env("GEONAMES_USERNAME")`. Note that `Geonames.Helpers` already has fallback logic for `System.get_env("GEONAMES_USERNAME")` but this fallback is never reached because the application config is set first. The hardcoded value takes precedence over the environment-variable fallback.

**Finding A015-2** — CRITICAL: Hardcoded Guardian `secret_key` in the same tracked config file.

File: `config/config.exs`, line 136:
```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

While this is not part of the assigned endpoint files, it was discovered in the same config block immediately above the geonames config and is within scope of §1. This is the JWT signing secret for all authentication tokens issued by Guardian. A hardcoded secret_key in a tracked file means any JWT token can be forged by any party who has ever seen the repository. This must be loaded from a secrets manager or environment variable at runtime.

**Finding A015-3** — LOW: GeoNames `base_url` is hardcoded as a compile-time module attribute with no TLS scheme.

File: `geonames-elixir/lib/geonames/helpers.ex`, line 8:
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default base URL `"api.geonames.org/"` does not include a URI scheme. In `build_url_string/2` the URL is assembled as `@base_url <> endpoint <> "?" <> encoded_params`, yielding a string such as `api.geonames.org/citiesJSON?...`. HTTPoison will prepend `http://` as the scheme default when no scheme is present. All outbound calls to the GeoNames API therefore occur over plaintext HTTP rather than HTTPS. This is relevant for the username credential transmitted in every request query string (see A015-1). The username would be sent in cleartext to an external service. The base_url default should be `"https://api.geonames.org/"`.

---

### §2: Authentication and Authorization

The three assigned endpoint modules (`Astergdem`, `Children`, `Cities`) are pure data-descriptor modules. They define no HTTP handlers, no plug pipelines, no authentication checks, and no authorization logic. They are consumed by the macro loop in `Geonames` (geonames.ex) which generates wrapper functions for outbound calls to the external GeoNames API.

These modules are not Phoenix controllers; they do not receive inbound HTTP requests from application users. Authentication of inbound requests is handled by upstream Phoenix plugs that are outside the scope of these files.

No authentication or authorization issues arise directly from the three assigned files themselves.

**Finding A015-4** — MEDIUM: No caller-side authorization gate on `Children.url_arguments/1` for the `geonameId` parameter.

The `Children` endpoint accepts a caller-supplied `geonameId` and passes it through `Map.merge/2` with no validation. When this library is invoked from an application controller, there is no enforcement within this library layer that the `geonameId` belongs to or is accessible by the authenticated user. This is an IDOR risk if the calling application controller passes a user-supplied `geonameId` without first verifying the user is authorized to query that geographic entity. Authorization must be enforced at the controller layer; this finding is flagged here because the library provides no guard and callers must be reviewed. This finding should be corroborated by a review of the application controllers that call `Geonames.children/1`.

§2: No additional issues found in the assigned files beyond A015-4.

---

### §3: Input Validation and Injection

**Finding A015-5** — MEDIUM: No input validation or sanitization of caller-supplied parameters before URL construction.

All three endpoint modules implement `url_arguments/1` identically as a plain `Map.merge/2` of caller-supplied arguments over defaults:
```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

There is no type checking, range checking, or allowlisting of values. For example:
- `Cities` accepts `north`, `south`, `east`, `west` as latitude/longitude bounding box coordinates. These should be floats in the range -90..90 (lat) and -180..180 (lng). No such validation exists.
- `Children` accepts `maxRows` (default 200) and `hierarchy`. The `hierarchy` value is a free-form binary that is interpolated directly into the URL query string in `Geonames.Helpers.build_url_string/2` via `"#{k}=#{v}"` without encoding the value separately before joining with `&`.
- `Astergdem` accepts `lat` and `lng` with no bounds checking.

`URI.encode/1` is called on the full assembled query string in `build_url_string/2`:
```elixir
|> URI.encode
```

However, `URI.encode/1` encodes the entire string and only encodes characters outside the unreserved set. It does not encode `&`, `=`, or `?`. A crafted value such as `"tourism&username=attacker"` passed as `hierarchy` would not be fully neutralized: the `&` character would survive `URI.encode/1` because `&` is a valid URI character. This could permit parameter injection into the outbound GeoNames API request, potentially overriding the `username` parameter or injecting additional query parameters. The risk is contingent on whether the calling application passes user-supplied data to `Geonames.children/1` without sanitizing the `hierarchy` field.

**Finding A015-6** — LOW: `url_arguments/1` accepts arbitrary map keys beyond those in `available_url_parameters`.

`Map.merge(@default_arguments, provided_arguments)` will retain any keys in `provided_arguments` that are not in `@default_arguments`. The `available_url_parameters` list is informational only and is not enforced. Extra keys pass through to `build_url_string/2` and are included in the outbound URL. If user-controlled data is passed as the arguments map without strict allowlisting at the call site, arbitrary query parameters can be injected into the GeoNames API request.

§3: No raw SQL, no atom creation from user input, no `binary_to_term`, no `Code.eval_string`, no `Kernel.apply` with user-controlled inputs found in the three assigned files.

---

### §4: Session and CSRF

The assigned files are outbound HTTP client descriptor modules, not Phoenix controllers or channels. They handle no inbound sessions, cookies, CSRF tokens, or WebSocket connections.

§4: No issues found.

---

### §5: File and Data Handling

**Finding A015-7** — INFO: Outbound API response deserialized with `Poison.decode!/1` — no schema validation on received data.

In `geonames.ex` line 133:
```elixir
{ :ok, Poison.decode!(body) }
```

The raw JSON body from the external GeoNames API is decoded and returned without any schema validation or field filtering. If the GeoNames API response were tampered with (e.g., DNS hijack of `api.geonames.org`, or an MITM on the plaintext HTTP connection noted in A015-3), maliciously crafted JSON could propagate into the application's data layer. The bang form `Poison.decode!` also raises an exception on malformed JSON rather than returning an error tuple, which could produce unhandled runtime errors surfaced to API consumers.

**Finding A015-8** — LOW: `build_url_string/2` constructs the full outbound URL by string concatenation; the GeoNames `username` credential is transmitted as a plaintext query parameter over HTTP.

As established in A015-3, the scheme defaults to HTTP. The username credential appears as `username=vinxstudio` in every outbound request query string. Query parameters are logged by many HTTP proxies and intermediaries. Combined with A015-1 (credential hardcoded in tracked file) and A015-3 (cleartext HTTP), this represents a full credential exposure chain for the GeoNames API account.

§5: No file upload handling, no PII in Logger calls, no cross-customer data boundary issues found in the three assigned files (these modules make no database queries and return external geographic data, not fleet/driver/vehicle data).

---

### §6: Dependencies

The vendored `geonames-elixir` library declares the following runtime dependencies in `geonames-elixir/mix.exs`:

```elixir
{:poison, "~> 3.1"},
{:httpoison, "~> 1.0"},
```

**Finding A015-9** — MEDIUM: `poison ~> 3.1` is an outdated major version with known security history.

Poison 3.x is significantly outdated (current stable is 6.x as of 2026). Poison 3.x has had parsing edge-case issues. The `~>` constraint permits `>= 3.1.0, < 4.0.0` only — the library is locked to a 3.x series that received its last security-relevant patch years ago. The project should evaluate migrating to `Jason` (now the Phoenix default JSON library) or at minimum updating to a current Poison major version.

**Finding A015-10** — LOW: `httpoison ~> 1.0` is an outdated constraint.

HTTPoison 1.x is outdated (current is 2.x). The `~>` constraint pins to `>= 1.0.0, < 2.0.0`. HTTPoison is a wrapper over Hackney; version 1.x may depend on an older Hackney that has had TLS-related updates in later versions. This should be updated to current.

**Finding A015-11** — INFO: Vendored library has its own `mix.exs` with independent dependency constraints that may diverge from the host application's `mix.lock`.

The geonames-elixir library is vendored (source-included) rather than declared as a path or hex dependency. Its `mix.exs` declares its own `poison` and `httpoison` constraints. If the host application's `mix.lock` resolves different versions of these packages than what the vendored `mix.exs` targets, there may be silent version conflicts. The host application's `mix.lock` should be reviewed to confirm the resolved versions of `poison` and `httpoison` are compatible and current.

§6: No `git:` source URLs. No Mariaex found in this library. No missing `mix.lock` in the vendored library directory (the vendored library's own `mix.lock` should be confirmed as absent or consistent with the host).

---

### §7: Infrastructure Exposure

**Finding A015-12** — LOW: Outbound requests to `api.geonames.org` use plaintext HTTP (see A015-3) and transmit credentials in the query string.

The hardcoded base URL `"api.geonames.org/"` without an `https://` scheme means all outbound geographic API calls leave the application over unencrypted HTTP. The `username` parameter (a third-party API credential) is visible in the query string to any network intermediary on the path between the application server and GeoNames. In an AWS VPC environment, this traffic leaves the VPC boundary in cleartext. The `base_url` default should be corrected to `"https://api.geonames.org/"` and this should be enforced via configuration rather than relying on defaults.

**Finding A015-13** — INFO: The `base_url` is configurable via application config but the default exposes an infrastructure assumption.

`Application.get_env(:geonames, :base_url, "api.geonames.org/")` defaults to the public GeoNames API. If the application were configured to point at an internal proxy or alternative service, there is no validation that the configured URL uses HTTPS, which could silently downgrade security.

§7: No CORS configuration, no CSP, no inbound port exposure in these files. No hardcoded AWS endpoints, RDS hostnames, or EC2 identifiers found in the three assigned files or the supporting geonames-elixir library files.

---

## Summary of Findings

| ID | Severity | Section | Description |
|---|---|---|---|
| A015-1 | CRITICAL | §1 | GeoNames API username `"vinxstudio"` hardcoded in tracked `config/config.exs` |
| A015-2 | CRITICAL | §1 | Guardian `secret_key` hardcoded in tracked `config/config.exs` (discovered in same config block) |
| A015-3 | LOW | §1/§7 | Default `base_url` has no URI scheme; outbound calls default to HTTP not HTTPS |
| A015-4 | MEDIUM | §2 | No authorization gate in `Children` on `geonameId`; IDOR risk at call sites |
| A015-5 | MEDIUM | §3 | No input validation on URL parameters; `hierarchy` and other string fields susceptible to query-parameter injection via unencoded `&`/`=` characters |
| A015-6 | LOW | §3 | `url_arguments/1` passes arbitrary extra map keys through to outbound URL; no allowlist enforcement |
| A015-7 | INFO | §5 | Outbound API response deserialized via `Poison.decode!` with no schema validation; bang form raises on malformed JSON |
| A015-8 | LOW | §5 | API credential transmitted as plaintext query string parameter over HTTP |
| A015-9 | MEDIUM | §6 | `poison ~> 3.1` is an outdated major version; should migrate to Jason or current Poison |
| A015-10 | LOW | §6 | `httpoison ~> 1.0` is an outdated version constraint |
| A015-11 | INFO | §6 | Vendored library has independent `mix.exs`; dependency version resolution against host `mix.lock` unverified |
| A015-12 | LOW | §7 | All outbound GeoNames calls use plaintext HTTP; credential exposed in query string to network intermediaries |
| A015-13 | INFO | §7 | Configurable `base_url` has no enforcement of HTTPS scheme |

---

*Report generated by agent A015, pass 1, run 2026-02-27-01.*

<!-- A018.md -->
# Audit Report A018
**Agent:** A018
**Run:** 2026-02-27-01
**Pass:** 1
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Auditor model:** claude-sonnet-4-6
**Date:** 2026-02-27

**Assigned files:**
- `geonames-elixir/lib/geonames/endpoints/contains.ex`
- `geonames-elixir/lib/geonames/endpoints/country_code.ex`
- `geonames-elixir/lib/geonames/endpoints/country_info.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/contains.ex`

**Module name:** `Geonames.Endpoints.Contains`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 11 |
| `available_url_parameters` | 0 | 12 |
| `required_url_parameters` | 0 | 13 |
| `function_name` | 0 | 14 |
| `url_arguments` | 1 | 16 |

**Structs / defexception / schema:** None.

**use / import / alias at module level:** None (no `use`, `import`, or `alias`).

**Behaviour:** `@behaviour Geonames.Endpoint`

**Module attributes:**
- `@default_arguments %{geonameId: nil, featureClass: nil, featureCode: nil}` (line 5–9)

---

### File 2: `geonames-elixir/lib/geonames/endpoints/country_code.ex`

**Module name:** `Geonames.Endpoints.CountryCode`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**Structs / defexception / schema:** None.

**use / import / alias at module level:** None.

**Behaviour:** `@behaviour Geonames.Endpoint`

**Module attributes:**
- `@default_arguments %{lat: nil, lng: nil, type: nil, radius: nil}` (lines 5–10)

---

### File 3: `geonames-elixir/lib/geonames/endpoints/country_info.ex`

**Module name:** `Geonames.Endpoints.CountryInfo`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 9 |
| `available_url_parameters` | 0 | 10 |
| `required_url_parameters` | 0 | 11 |
| `function_name` | 0 | 12 |
| `url_arguments` | 1 | 14 |

**Structs / defexception / schema:** None.

**use / import / alias at module level:** None.

**Behaviour:** `@behaviour Geonames.Endpoint`

**Module attributes:**
- `@default_arguments %{country: nil}` (lines 5–7)

---

## Supporting Context Read

Because these modules implement the `Geonames.Endpoint` behaviour and the `url_arguments/1` function's output feeds into URL construction, the following supporting files were also read to provide complete security context:

- `geonames-elixir/lib/geonames/endpoint.ex` — defines the behaviour callbacks
- `geonames-elixir/lib/geonames/helpers.ex` — contains `build_url_string/2` which consumes the output of `url_arguments/1`
- `geonames-elixir/mix.exs` — dependency declarations for the vendored library

---

## Findings by Checklist Section

### §1: Secrets and Configuration

**A018-1 — MEDIUM — Hardcoded external API base URL in compile-time module attribute**

File: `geonames-elixir/lib/geonames/helpers.ex`, line 8
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```
This is in a supporting file read for context, but it directly governs the base URL used when the three assigned endpoint modules construct their outbound HTTP requests. The default `"api.geonames.org/"` is evaluated at **compile time** via `Application.get_env/3` as a module attribute. In a release build where the application environment is not explicitly configured, this default silently takes effect. If the production configuration omits `:base_url`, the application will send all geolocation queries (which may include GPS coordinates derived from fleet/vehicle data) to the public geonames.org API rather than to an internal or validated endpoint. This is a misconfiguration risk with data-disclosure implications.

Note: No secrets were hardcoded in the three assigned endpoint files themselves. The endpoint files contain no credentials, API keys, or sensitive configuration.

---

### §2: Authentication and Authorization

These three modules are pure data-structure endpoint descriptors. They implement a behaviour interface (`Geonames.Endpoint`) and perform no authentication, session handling, or authorisation logic of their own. They do not make HTTP calls — they only define parameters to be assembled into a URL by `Geonames.Helpers.build_url_string/2`.

Specific observations:

- `Geonames.Endpoints.CountryCode` declares `:lat` and `:lng` as required parameters (line 14). The `url_arguments/1` function accepts an arbitrary caller-supplied map and merges it into the default arguments map with no type checking or range validation on the coordinate values. Whether those coordinates originate from authenticated user input or unauthenticated sources is entirely the concern of the caller — these modules impose no guard.
- The GeoNames API itself requires a `username` credential (injected by `Geonames.Helpers` from application config or `GEONAMES_USERNAME` env var). These endpoint modules do not touch that credential path; authentication to the upstream API is handled in the helper layer.

§2: No authentication or authorisation issues within the scope of these three files.

---

### §3: Input Validation and Injection

**A018-2 — MEDIUM — No input validation on caller-supplied URL parameters; URL construction uses unencoded string interpolation**

Files: all three assigned endpoints, and `geonames-elixir/lib/geonames/helpers.ex` (supporting context)

The `url_arguments/1` function in each module performs only a `Map.merge/2` of caller-supplied arguments into a default map. No type checking, range validation, or allow-list enforcement is performed on the values. The merged map is then passed to `Geonames.Helpers.build_url_string/2`, which constructs the URL using bare string interpolation:

```elixir
{k,v} when is_binary(v) -> "#{k}=#{v}"
{k,v} when is_float(v)  -> "#{k}=#{v}"
...
|> Enum.join("&")
|> URI.encode
```

`URI.encode/1` encodes the entire query string after it has already been assembled. This means that if a binary value contains `&`, `=`, or other query-string metacharacters **before** encoding, they will be percent-encoded by `URI.encode/1` and will not cause injection into the query structure. However:

1. `URI.encode/1` (without a custom character set) does **not** encode all characters that have structural significance in URLs — specifically, `?` and `#` are not encoded by the default `URI.encode/1` character set. A string value containing `#` could truncate the query string at the HTTP level.
2. No numeric range validation is applied to `lat`/`lng` (should be -90..90 and -180..180 respectively), `radius`, or `geonameId`. Out-of-range values are passed through to the upstream API without error.
3. The `type` and `featureClass`/`featureCode` fields are free-form strings with no allow-list validation. They are forwarded verbatim to the external geonames.org API.

The practical injection risk against the upstream GeoNames API is low because geonames.org is not under the application's control and server-side validation there is expected. The risk to the local application is minimal given `URI.encode` does prevent most query-string manipulation. However the absence of any validation represents a missing defence-in-depth layer.

---

### §4: Session and CSRF

These modules are not web controllers, do not interact with sessions, cookies, or CSRF tokens, and are not plugs. They define no HTTP handlers.

§4: No issues found.

---

### §5: File and Data Handling

**A018-3 — LOW — GPS coordinate parameters forwarded to external third-party API without data minimisation or logging controls**

File: `geonames-elixir/lib/geonames/endpoints/country_code.ex`, lines 5–10
```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  type: nil,
  radius: nil
}
```

The `CountryCode` endpoint accepts latitude and longitude values and forwards them to the external GeoNames API. In the context of api_server being a fleet management backend, the `lat`/`lng` values passed through this endpoint may represent real-time vehicle or asset locations. These coordinates are passed to `api.geonames.org` (a third-party public API) over HTTP (no TLS scheme is specified in the base URL — see A018-4). This constitutes potential PII/location-data disclosure to a third party without the base URL being enforced as HTTPS.

No logger calls or error responses with sensitive data were found in the three assigned files.

§5: See A018-3 above.

---

### §6: Dependencies

The three assigned endpoint files have no direct dependencies — they declare no `use`, `import`, or external calls. Their transitive dependency path is through `Geonames.Helpers` which calls `HTTPoison` for HTTP and `Poison` for JSON.

From `geonames-elixir/mix.exs` (supporting context):
```elixir
{:poison, "~> 3.1"},
{:httpoison, "~> 1.0"},
{:ex_doc, "~> 0.12", only: :dev}
```

**A018-4 — HIGH — Outdated vendored library with known-vulnerable dependencies; no TLS enforcement on outbound API calls**

1. **Poison ~> 3.1** — Poison 3.x is multiple major versions behind the current release. Poison 3.x has known denial-of-service concerns with certain deeply nested JSON inputs. The vendored library pins only an approximate version (`~> 3.1`); the exact pinned version would need checking in `mix.lock` to confirm whether a patched sub-version is in use.

2. **HTTPoison ~> 1.0** — HTTPoison 1.x is a significantly outdated version. The library wraps Hackney and inherits its TLS stack. Version 1.x may not benefit from TLS improvements present in later releases.

3. **No HTTPS enforcement** — The base URL in `Geonames.Helpers` is `"api.geonames.org/"` with no scheme. When `build_url_string/2` constructs the full URL, no `https://` prefix is added, meaning HTTP (unencrypted) may be used for outbound requests carrying GPS coordinate parameters. This would expose vehicle location data in transit to a public third-party service.

4. **Elixir version constraint `~> 1.2`** — The vendored library targets Elixir 1.2 (released 2016). This is informational but indicates the library has not been maintained or updated and may not follow current security practices.

5. **ex_doc pinned to `~> 0.12`** — Extremely old dev dependency; low risk as it is dev-only, but indicates the library is unmaintained.

---

### §7: Infrastructure Exposure

**A018-5 — INFO — Hardcoded external service hostname reveals third-party dependency**

File: `geonames-elixir/lib/geonames/helpers.ex`, line 8 (supporting context for the assigned modules)
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The hostname `api.geonames.org` is hardcoded as the compile-time default for all three assigned endpoint modules' outbound HTTP calls. This is not an internal infrastructure hostname, so the topology exposure risk is low. However, the absence of a scheme (`https://`) means there is no guarantee that TLS is enforced for outbound requests (see A018-4).

The three assigned files themselves contain no hardcoded hostnames, IPs, port numbers, or internal service URLs.

§7: See A018-5 above.

---

## Finding Summary

| ID | Severity | Section | File(s) | Summary |
|----|----------|---------|---------|---------|
| A018-1 | MEDIUM | §1 Secrets & Config | `helpers.ex` (context) | Compile-time default base URL; if prod config omits `:base_url`, GPS data silently routed to public geonames.org |
| A018-2 | MEDIUM | §3 Input Validation | all three assigned files + `helpers.ex` | No type or range validation on caller-supplied URL parameters; URL assembled via string interpolation with incomplete encoding |
| A018-3 | LOW | §5 File & Data Handling | `country_code.ex` | GPS coordinates forwarded to external third-party API; potential fleet location data disclosure |
| A018-4 | HIGH | §6 Dependencies | `mix.exs` (context) | Outdated vendored library; Poison 3.x, HTTPoison 1.x; no HTTPS scheme enforced on outbound calls carrying GPS data |
| A018-5 | INFO | §7 Infrastructure | `helpers.ex` (context) | Hardcoded third-party hostname as compile-time default; no scheme prefix means TLS not guaranteed |

---

*End of report A018.*

<!-- A021.md -->
# Audit Report A021
**Agent:** A021
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Auditor model:** claude-sonnet-4-6

---

## Assigned Files

- `geonames-elixir/lib/geonames/endpoints/country_subdivision.ex`
- `geonames-elixir/lib/geonames/endpoints/earthquakes.ex`
- `geonames-elixir/lib/geonames/endpoints/find_nearby.ex`

Supporting context files read (not assigned but required to trace trust boundaries):
- `geonames-elixir/lib/geonames/endpoint.ex` (behaviour definition)
- `geonames-elixir/lib/geonames.ex` (public dispatch module)
- `geonames-elixir/lib/geonames/helpers.ex` (URL builder, credential resolution)
- `geonames-elixir/config/config.exs` (vendored library config)
- `geonames-elixir/mix.exs` and `mix.lock` (dependency graph)
- `config/config.exs` (parent project geonames config block, lines 138-140)
- `lib/api_server_web/controllers/utility_controller.ex` (caller, grepped for Geonames usage)

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/country_subdivision.ex`

**Module name:** `Geonames.Endpoints.CountrySubdivision`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `@behaviour Geonames.Endpoint` (line 3)

**Module-level attributes:**
- `@default_arguments` (line 5–10): `%{lat: nil, lng: nil, radius: nil, level: nil}`

---

### File 2: `geonames-elixir/lib/geonames/endpoints/earthquakes.ex`

**Module name:** `Geonames.Endpoints.Earthquakes`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 15 |
| `available_url_parameters` | 0 | 16 |
| `required_url_parameters` | 0 | 17 |
| `function_name` | 0 | 18 |
| `url_arguments` | 1 | 20 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `@behaviour Geonames.Endpoint` (line 3)

**Module-level attributes:**
- `@default_arguments` (lines 5–13): `%{north: nil, south: nil, east: nil, west: nil, date: nil, minMagnitude: nil, maxRows: 10}`

---

### File 3: `geonames-elixir/lib/geonames/endpoints/find_nearby.ex`

**Module name:** `Geonames.Endpoints.FindNearby`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 16 |
| `available_url_parameters` | 0 | 17 |
| `required_url_parameters` | 0 | 18 |
| `function_name` | 0 | 19 |
| `url_arguments` | 1 | 21 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `@behaviour Geonames.Endpoint` (line 3)

**Module-level attributes:**
- `@default_arguments` (lines 5–14): `%{lat: nil, lng: nil, featureClass: nil, featureCode: nil, radius: nil, maxRows: 10, style: "MEDIUM", localCountry: true}`

---

## Checklist Findings

### §1: Secrets and Configuration

**Finding A021-1 — MEDIUM: GeoNames API username hardcoded in vendored library config**

**File:** `geonames-elixir/config/config.exs`, lines 5–7
**Evidence:**
```elixir
config :geonames,
  username: "testuser",
  language: "es"
```

The vendored library's own `config/config.exs` contains a hardcoded GeoNames API username (`"testuser"`). Although this is a vendored `config/config.exs` that Mix does not load when used as a sub-dependency of the parent project (it is overridden by the parent project's config at `config/config.exs` lines 138–140), the value is committed to version control. The vendor config file carries a different hardcoded username than the parent project uses in production.

The parent project's `config/config.exs` (lines 138–140) sets:
```elixir
config :geonames,
  username: "vinxstudio",
  language: "en"
```

This `"vinxstudio"` username is also a hardcoded literal committed to a tracked config file rather than being sourced from an environment variable or secrets manager. The `Geonames.Helpers` module (line 53) does provide a fallback to `System.get_env("GEONAMES_USERNAME")` if the application env is nil, but the parent config assigns a literal value that pre-empts that fallback. A GeoNames API username is a credential granting access to a paid/rate-limited account; it should be stored in an environment variable or secrets manager and never committed to source.

**Recommendation:** Remove the literal username value from `config/config.exs`. Set `:username` to `nil` and rely exclusively on `System.get_env("GEONAMES_USERNAME")`, or inject via `runtime.exs` / deployment secrets.

---

**Finding A021-2 — INFO: Vendored library config uses `use Mix.Config` (deprecated API)**

**File:** `geonames-elixir/config/config.exs`, line 3
**Evidence:**
```elixir
use Mix.Config
```

`Mix.Config` was deprecated in Elixir 1.11 in favour of `Config`. This is a low-risk issue in a vendored library whose config is not loaded by the parent application, but it indicates the vendor library has not been updated.

---

### §2: Authentication and Authorization

The three assigned endpoint modules are pure data-definition modules implementing the `Geonames.Endpoint` behaviour. They define no routes, no plugs, no authentication logic, and no authorisation checks. They are called from `utility_controller.ex` in the parent application — authentication and authorisation at the controller level is out of scope for this report (not an assigned file), but is noted for completeness.

Within the assigned files themselves: §2: No issues found.

---

### §3: Input Validation and Injection

**Finding A021-3 — MEDIUM: `url_arguments/1` performs unrestricted map merge — caller-supplied keys outside the allowed parameter set are passed through to the URL**

**Files:**
- `geonames-elixir/lib/geonames/endpoints/country_subdivision.ex`, line 17–19
- `geonames-elixir/lib/geonames/endpoints/earthquakes.ex`, lines 20–22
- `geonames-elixir/lib/geonames/endpoints/find_nearby.ex`, lines 21–23

**Evidence (identical pattern in all three):**
```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`Map.merge/2` merges the caller-supplied map over the defaults without filtering. Any key present in `provided_arguments` that is not in `@default_arguments` will appear in the merged map. The merged map is then passed to `Geonames.Helpers.build_url_string/2` (in `helpers.ex`, lines 30–47), which iterates all key-value pairs and appends non-nil entries as `key=value` query string segments.

This means that if a caller passes extra keys (e.g. `%{lat: 1.0, lng: 2.0, username: "attacker"}`) those extra keys are appended to the outbound GeoNames API request URL. An attacker who controls the argument map (e.g. if arguments are derived from user-controlled HTTP parameters without strict filtering in the parent controller) could inject arbitrary GeoNames API parameters, including overriding the `username` parameter used for API authentication.

The practical severity depends on the trust boundary between HTTP input and the argument map at the call sites. The two observed call sites in `utility_controller.ex` pass hard-coded lat/lng values sourced from database records rather than raw user strings, which mitigates the risk at those specific sites. However, the library API itself provides no defence in depth — the absence of a whitelist in `url_arguments/1` means any future call site that passes user-controlled parameters is immediately vulnerable.

Additionally, `Geonames.Helpers.build_url_string/2` uses `URI.encode/1` (line 45 of helpers.ex), which percent-encodes the entire query string as a single string rather than encoding individual parameter values. This is semantically incorrect: `URI.encode` does not encode `&` or `=` characters (they are unreserved in the full URI context), so a value containing `&foo=bar` embedded in a parameter value would not be escaped and would be interpreted as an additional query parameter by the GeoNames server. This is a URL injection / parameter pollution vector.

**Recommendation:** In each endpoint's `url_arguments/1`, filter `provided_arguments` to only keys in `available_url_parameters` before merging. In `helpers.ex`, replace the manual string-building and `URI.encode/1` with `URI.encode_query/1` which correctly percent-encodes individual key and value components.

---

**Finding A021-4 — LOW: No type validation of latitude/longitude values before URL construction**

**Files:**
- `geonames-elixir/lib/geonames/endpoints/country_subdivision.ex` (required: `lat`, `lng`)
- `geonames-elixir/lib/geonames/endpoints/earthquakes.ex` (required: `north`, `south`, `east`, `west`)
- `geonames-elixir/lib/geonames/endpoints/find_nearby.ex` (required: `lat`, `lng`)

The `required_parameters_provided?` check in `Geonames.Helpers` (helpers.ex line 14) only verifies that the required keys are non-nil; it performs no type validation (e.g. that lat/lng values are floats in valid WGS-84 ranges, or that bounding-box coordinates are numerically coherent). A string value of arbitrary content passes the check and is appended to the URL. The URL builder in `helpers.ex` only handles `is_binary`, `is_float`, `is_boolean`, `is_integer`, and `is_list` guards; a value of an unexpected type (e.g. a PID, a struct) would cause the anonymous function to raise a `FunctionClauseError` rather than returning an error tuple, which may surface as an unhandled exception.

---

### §4: Session and CSRF

The three assigned files are endpoint definition modules with no session, cookie, or CSRF-related code. They do not implement any HTTP handlers.

§4: No issues found.

---

### §5: File and Data Handling

**Finding A021-5 — INFO: GeoNames API response is decoded with `Poison.decode!/1` (raises on malformed JSON)**

**File:** `geonames-elixir/lib/geonames.ex`, line 133
**Evidence:**
```elixir
{ :ok, Poison.decode!(body) }
```

`Poison.decode!/1` raises a `Poison.ParseError` if the GeoNames API returns a non-JSON body (e.g. an HTML error page, a plain-text rate-limit message, or a network interception response). The calling code in `Geonames` wraps the HTTPoison call but does not wrap this decode step in a rescue block. The `raise RuntimeError` path only covers HTTP-level errors; a malformed body from the upstream API will propagate an unhandled exception into the controller.

The three assigned endpoint modules do not directly handle this path; the issue is in the dispatch layer that uses them. Noted here because it affects the security-relevant behaviour (error handling / information disclosure) of all three assigned endpoint types.

---

**Finding A021-6 — INFO: No logging of outbound GeoNames requests or error responses**

The library makes no `Logger` calls. Absence of logging means failed or anomalous GeoNames API calls (e.g. repeated `401 Unauthorized` that might indicate credential theft, or unexpected `429 Too Many Requests`) are not recorded for audit purposes. This is an operational security observation.

---

### §6: Dependencies

**Finding A021-7 — HIGH: Severely outdated dependency versions with no security support**

**File:** `geonames-elixir/mix.lock`

The vendored library's lock file pins the following versions:

| Package | Locked version | Status |
|---|---|---|
| `httpoison` | 1.3.0 (2018) | Unsupported; current is 2.x |
| `hackney` | 1.13.0 (2018) | Outdated; current is 1.20.x |
| `poison` | 3.1.0 (2017) | Outdated; current is 5.x |
| `certifi` | 2.3.1 (2018) | Outdated; current is 2.12.x |
| `ssl_verify_fun` | 1.1.1 (2017) | Outdated |

`hackney` 1.13.0 is notably old and predates multiple TLS and connection handling fixes. `certifi` 2.3.1 contains a CA bundle from 2018; the parent project has already had to patch TLS issues (see commit `e486dd8`: "Fix Rayven TLS 'Unknown CA' error after Sectigo Root R46 cert renewal"), indicating that stale CA bundles are a real operational problem in this codebase. Relying on `certifi` 2.3.1 within the vendored Geonames library means outbound requests to `api.geonames.org` may fail certificate validation if the Geonames.org TLS chain is updated to use a newer root CA.

`httpoison` 1.3.0 and `hackney` 1.13.0 are not known to have specific published CVEs, but their age means they have not received security patches from the past six years. The `mix.exs` specifies `{:httpoison, "~> 1.0"}` and `{:poison, "~> 3.1"}` which use approximate version constraints; the `mix.lock` snapshot may diverge from what would be installed on a clean `mix deps.get` on a new host if these packages have been yanked or updated.

**Note:** Because this is a vendored directory (not fetched from hex.pm by the parent project's `mix.lock`), the parent project's own `mix audit` will not surface these issues automatically.

---

**Finding A021-8 — INFO: Vendored library's `mix.exs` pinned to `elixir: "~> 1.2"`**

**File:** `geonames-elixir/mix.exs`, line 6

The library requires only Elixir ~> 1.2, which was released in 2015. This is not a vulnerability in itself, but combined with all the other staleness indicators it confirms this vendored copy of geonames-elixir has not been maintained. The library should be either replaced with a current hex.pm dependency or the vendored copy should be updated.

---

### §7: Infrastructure Exposure

**Finding A021-9 — LOW: Base URL for GeoNames API is plain HTTP (no scheme specified) and hardcoded in library source**

**File:** `geonames-elixir/lib/geonames/helpers.ex`, line 8
**Evidence:**
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default base URL `"api.geonames.org/"` has no URL scheme. In `build_url_string/2` (helpers.ex line 47) it is concatenated directly:
```elixir
@base_url <> endpoint <> "?" <> encoded_params
```

The resulting string is passed directly to `HTTPoison.get/1`. When no scheme is present, HTTPoison/hackney will attempt to parse the URL and will either raise, treat it as a relative URL, or default to HTTP depending on the hackney version. The `config/config.exs` in the parent project does not override `:base_url`, so the default is used.

If hackney resolves this as `http://api.geonames.org/...`, then the GeoNames API username (a credential) is transmitted in plaintext over HTTP, exposing it to network interception. The GeoNames.org API does support HTTPS (`https://secure.geonames.org/`); the library should enforce HTTPS.

**Recommendation:** Set `@base_url` default to `"https://secure.geonames.org/"` and document that `:base_url` overrides in config must also use HTTPS.

---

## Summary Table

| ID | Severity | Section | Title |
|---|---|---|---|
| A021-1 | MEDIUM | §1 | GeoNames API username hardcoded in tracked config files |
| A021-2 | INFO | §1 | Vendored library uses deprecated `use Mix.Config` |
| A021-3 | MEDIUM | §3 | Unrestricted map merge in `url_arguments/1` enables parameter injection / username override |
| A021-4 | LOW | §3 | No type or range validation of coordinate parameters |
| A021-5 | INFO | §5 | `Poison.decode!/1` raises on malformed upstream response; unhandled exception path |
| A021-6 | INFO | §5 | No logging of outbound GeoNames requests or errors |
| A021-7 | HIGH | §6 | Vendored dependency lock pins severely outdated packages including stale CA bundle |
| A021-8 | INFO | §6 | Vendored library `mix.exs` requires Elixir ~> 1.2 (2015); unmaintained library |
| A021-9 | LOW | §7 | Default GeoNames base URL lacks HTTPS scheme; credentials potentially sent over HTTP |

<!-- A024.md -->
# Audit Report: A024
**Agent:** A024
**Run:** 2026-02-27-01
**Pass:** 1
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `geonames-elixir/lib/geonames/endpoints/find_nearby_place_name.ex`
2. `geonames-elixir/lib/geonames/endpoints/find_nearby_pois_osm.ex`
3. `geonames-elixir/lib/geonames/endpoints/find_nearby_postal_codes.ex`

---

## Reading Evidence

---

### File 1: `geonames-elixir/lib/geonames/endpoints/find_nearby_place_name.ex`

**Module name:** `Geonames.Endpoints.FindNearbyPlaceName`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 15 |
| `available_url_parameters` | 0 | 16 |
| `required_url_parameters` | 0 | 17 |
| `function_name` | 0 | 18 |
| `url_arguments` | 1 | 20 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None. Only `@behaviour Geonames.Endpoint` declared at line 3.

**Module attributes:**

- `@moduledoc false` (line 2)
- `@default_arguments` map literal (lines 5–13): `%{lat: nil, lng: nil, radius: nil, maxRows: 10, style: "MEDIUM", localCountry: true, cities: nil}`

**Summary of behaviour:** Implements `Geonames.Endpoint` behaviour. Declares the GeoNames REST endpoint path `"findNearbyPlaceNameJSON"`, the set of accepted URL parameters, the required parameters (`:lat` and `:lng`), and merges caller-supplied arguments over defaults in `url_arguments/1`.

---

### File 2: `geonames-elixir/lib/geonames/endpoints/find_nearby_pois_osm.ex`

**Module name:** `Geonames.Endpoints.FindNearbyPOIsOSM`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None. Only `@behaviour Geonames.Endpoint` declared at line 3.

**Module attributes:**

- `@moduledoc false` (line 2)
- `@default_arguments` map literal (lines 5–10): `%{lat: nil, lng: nil, radius: nil, maxRows: nil}`

**Summary of behaviour:** Implements `Geonames.Endpoint` behaviour. Declares the GeoNames REST endpoint path `"findNearbyPOIsOSMJSON"`, the set of accepted URL parameters, the required parameters (`:lat` and `:lng`), and merges caller-supplied arguments over defaults in `url_arguments/1`.

---

### File 3: `geonames-elixir/lib/geonames/endpoints/find_nearby_postal_codes.ex`

**Module name:** `Geonames.Endpoints.FindNearbyPostalCodes`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 17 |
| `available_url_parameters` | 0 | 18 |
| `required_url_parameters` | 0 | 19 |
| `function_name` | 0 | 20 |
| `url_arguments` | 1 | 22 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None. Only `@behaviour Geonames.Endpoint` declared at line 3.

**Module attributes:**

- `@moduledoc false` (line 2)
- `@default_arguments` map literal (lines 5–15): `%{lat: nil, lng: nil, postalCode: nil, country: nil, radius: nil, maxRows: 5, style: "MEDIUM", localCountry: nil, cities: nil}`

**Summary of behaviour:** Implements `Geonames.Endpoint` behaviour. Declares the GeoNames REST endpoint path `"findNearbyPostalCodesJSON"`, the set of accepted URL parameters, declares **no** required parameters (`required_url_parameters/0` returns `[]`), and merges caller-supplied arguments over defaults in `url_arguments/1`.

---

## Checklist Review

### §1: Secrets and Configuration

No config files, environment variable access, credentials, API keys, secret key bases, hardcoded AWS endpoints, RDS hostnames, or pipeline YAML are present in any of these three files. All module attributes are benign string/atom/boolean/nil literals.

§1: No issues found.

---

### §2: Authentication and Authorization

These are pure endpoint-descriptor modules. They define no routes, no plugs, no pipeline registrations, no Guardian configuration, no password handling, and no authentication or authorisation logic. They do not fetch or return data directly — they only declare metadata that the `Geonames` client library uses to construct outbound HTTP query strings.

§2: No issues found.

---

### §3: Input Validation and Injection

All three modules expose a single data-transformation function `url_arguments/1`, which merges a caller-supplied map over a compile-time default map using `Map.merge/2`. The following potential concerns were evaluated:

**No atom creation from user input.** `Map.merge/2` merges values but does not create new atoms from string input; the keys in `@default_arguments` are compile-time atom literals and `Map.merge/2` will only retain keys that appear in the merged result. The caller-supplied map `provided_arguments` is merged *into* `@default_arguments`, meaning caller keys that do not exist in `@default_arguments` are *preserved* in the resulting map (standard `Map.merge/2` keeps all keys from both maps, with the second argument's values winning on collision).

**Key injection via caller-supplied map.** Because `Map.merge(@default_arguments, provided_arguments)` retains all keys from `provided_arguments`, a caller can inject arbitrary additional key/value pairs into the returned map. Whether those extra keys are harmful depends entirely on how the calling layer (the GeoNames HTTP client) serialises the result into a query string. If the HTTP client appends all map keys as query string parameters and passes the result to the GeoNames API, an attacker who controls `provided_arguments` could append arbitrary query parameters to the outbound GeoNames API request. This is a low-severity concern in this context because: (a) the GeoNames API is an external third-party service, not an internal sensitive backend; (b) the risk of exfiltration or privilege escalation against GeoNames via extra query parameters is minimal; (c) the actual attack surface depends on the calling layer, not these modules. The modules themselves do not validate or whitelist the keys in `provided_arguments`.

**No SQL, Ecto fragments, `String.to_atom/1`, `binary_to_term/1`, `Code.eval_string/1`, or `Kernel.apply/3` are present in any of the three files.**

**Finding recorded below (A024-1).**

---

### §4: Session and CSRF

No session handling, cookie configuration, CSRF tokens, WebSocket channels, or Phoenix endpoint configuration are present in these files.

§4: No issues found.

---

### §5: File and Data Handling

No file I/O, Logger calls, error views, PII handling, GPS coordinate logging, or fleet/driver/vehicle data processing are present in these files.

§5: No issues found.

---

### §6: Dependencies

These files contain no `mix.exs` or `mix.lock` content, no dependency declarations, and no `git:` source URLs. Dependency review for the geonames-elixir vendored library as a whole is out of scope for these three specific modules but is noted as requiring coverage elsewhere in the audit.

§6: No issues found (within scope of these three files).

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IP addresses, port numbers, CORS configuration, TLS settings, or inter-service call logic are present in these files. The only string literals are GeoNames API endpoint path suffixes (`"findNearbyPlaceNameJSON"`, `"findNearbyPOIsOSMJSON"`, `"findNearbyPostalCodesJSON"`), `"MEDIUM"` (a style parameter value), which are non-sensitive.

§7: No issues found.

---

## Findings

### A024-1
**Severity:** LOW
**File:** All three endpoint modules
- `geonames-elixir/lib/geonames/endpoints/find_nearby_place_name.ex` line 21
- `geonames-elixir/lib/geonames/endpoints/find_nearby_pois_osm.ex` line 18
- `geonames-elixir/lib/geonames/endpoints/find_nearby_postal_codes.ex` line 23

**Description:** `url_arguments/1` uses `Map.merge(@default_arguments, provided_arguments)` without whitelisting keys in `provided_arguments`. Because `Map.merge/2` retains all keys from both operands, a caller that passes a map containing keys not declared in `@default_arguments` will have those extra keys present in the returned map. If the upstream HTTP client serialises all map entries as outbound query string parameters, a caller with control over `provided_arguments` could inject arbitrary query parameters into requests sent to the GeoNames API.

**Code:**
```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

**Risk:** Low. The target is the third-party GeoNames geocoding API — there is no known privilege-escalation path via extra query parameters against that service, and no internal sensitive data is at risk from this specific call. However the pattern is inconsistent with the defensive posture expected of a validated-input codebase: callers should only be able to supply values for declared parameters.

**Recommendation (for Pass 2 review):** Consider replacing `Map.merge/2` with an explicit take-and-merge that restricts accepted keys to `available_url_parameters/0`, e.g.:

```elixir
def url_arguments(provided_arguments) do
  filtered = Map.take(provided_arguments, available_url_parameters())
  Map.merge(@default_arguments, filtered)
end
```

This is a pattern-consistency and defence-in-depth recommendation, not an immediately exploitable vulnerability.

---

### A024-2
**Severity:** INFO
**File:** `geonames-elixir/lib/geonames/endpoints/find_nearby_postal_codes.ex` line 19

**Description:** `required_url_parameters/0` returns an empty list `[]`, meaning the `[REDACTED-AWS-SMTP-PASSWORD]` endpoint declares no required parameters. This is divergent from the other two modules (which both require `:lat` and `:lng`). The GeoNames `[REDACTED-AWS-SMTP-PASSWORD]` endpoint can be driven by either coordinates (`lat`/`lng`) or a postal code (`postalCode`/`country`), so no single parameter is universally required, making this arguably correct. However, it means the `Geonames.Endpoint` behaviour's required-parameter enforcement (if any) provides no protection against a call that supplies neither coordinates nor a postal code. Whether the upstream client or calling code compensates for this is outside the scope of these three files.

**Risk:** Informational. Not a security vulnerability in isolation; flagged for awareness so downstream validation logic can be confirmed in Pass 2.

---

## Summary Table

| ID | Severity | File(s) | Title |
|---|---|---|---|
| A024-1 | LOW | All three endpoint modules | `url_arguments/1` does not whitelist caller-supplied map keys |
| A024-2 | INFO | `find_nearby_postal_codes.ex` | `required_url_parameters/0` returns empty list — no coordinate or postal-code requirement enforced at this layer |

---

*End of report A024.*

<!-- A027.md -->
# Audit Report A027
**Agent:** A027
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix (vendored geonames-elixir)
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `geonames-elixir/lib/geonames/endpoints/find_nearby_streets.ex`
2. `geonames-elixir/lib/geonames/endpoints/find_nearby_streets_osm.ex`
3. `geonames-elixir/lib/geonames/endpoints/find_nearby_weather.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/find_nearby_streets.ex`

**Module name:** `Geonames.Endpoints.FindNearbyStreets`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 11 |
| `available_url_parameters` | 0 | 12 |
| `required_url_parameters` | 0 | 13 |
| `function_name` | 0 | 14 |
| `url_arguments` | 1 | 16 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None. (`@behaviour Geonames.Endpoint` at line 3.)

**Module attributes:**

```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  maxRows: 10
}
```

---

### File 2: `geonames-elixir/lib/geonames/endpoints/find_nearby_streets_osm.ex`

**Module name:** `Geonames.Endpoints.FindNearbyStreetsOSM`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None. (`@behaviour Geonames.Endpoint` at line 3.)

**Module attributes:**

```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  radius: nil,
  maxRows: 10
}
```

---

### File 3: `geonames-elixir/lib/geonames/endpoints/find_nearby_weather.ex`

**Module name:** `Geonames.Endpoints.FindNearbyWeather`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 11 |
| `available_url_parameters` | 0 | 12 |
| `required_url_parameters` | 0 | 13 |
| `function_name` | 0 | 14 |
| `url_arguments` | 1 | 16 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None. (`@behaviour Geonames.Endpoint` at line 3.)

**Module attributes:**

```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  radius: nil
}
```

---

## Supporting Context Read

To understand the full data flow the following additional files were read:

- `geonames-elixir/lib/geonames/endpoint.ex` — defines the `Geonames.Endpoint` behaviour callbacks.
- `geonames-elixir/lib/geonames/helpers.ex` — contains `build_url_string/2` and `user_configuration/0`; assembles the outgoing HTTP URL.
- `geonames-elixir/lib/geonames.ex` — uses compile-time metaprogramming (`for endpoint <- endpoints do`) to generate one public wrapper function per endpoint; calls `url_arguments/1` then `Helpers.build_url_string/2` then `HTTPoison.get/1`.
- `geonames-elixir/mix.exs` — dependency declarations for the vendored library.

---

## Checklist Review

### §1: Secrets and Configuration

The three assigned endpoint modules contain no configuration, credentials, API keys, or environment variable references.

For completeness: the broader `Geonames.Helpers` module (read as supporting context) references `Application.get_env(:geonames, :username)` and `System.get_env("GEONAMES_USERNAME")`. This is outside the scope of the assigned files but establishes that the GeoNames API username credential is expected from application config or environment — not hardcoded in these endpoint modules.

§1: No issues found in the assigned files.

---

### §2: Authentication and Authorization

The three modules implement purely structural/metadata functions. They define URL parameter maps and endpoint name strings. They perform no authentication, issue no tokens, handle no sessions, and enforce no authorisation logic.

No Guardian usage, no password handling, no IDOR surface.

§2: No issues found.

---

### §3: Input Validation and Injection

**`url_arguments/1` — unfiltered merge (MEDIUM)**

All three modules implement `url_arguments/1` identically:

```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`provided_arguments` is the caller-supplied map. `Map.merge/2` replaces every key in `@default_arguments` with whatever the caller provides but also — critically — **passes through every extra key the caller includes that is not in `@default_arguments`**. Because `Map.merge/2` retains all keys from both maps, a caller can inject arbitrary additional query-string parameters into the outgoing GeoNames API request.

The downstream path in `Geonames.Helpers.build_url_string/2` iterates over every key/value pair in the merged map without filtering to `available_url_parameters`, so every extra key supplied by the caller is appended to the URL query string that is sent to `api.geonames.org`.

Concretely for the three assigned endpoints:

- `FindNearbyStreets` — declared keys: `lat`, `lng`, `maxRows`. A caller passing `%{lat: x, lng: y, username: "attacker", style: "FULL", ...}` would inject those into the upstream API call.
- `[REDACTED-AWS-SMTP-PASSWORD]` — declared keys: `lat`, `lng`, `radius`, `maxRows`.
- `FindNearbyWeather` — declared keys: `lat`, `lng`, `radius`.

The practical impact depends on how tightly the rest of the application controls what goes into `provided_arguments`. If `provided_arguments` originates from validated, controller-level params this is lower risk. If it is derived directly from raw user-supplied HTTP query parameters (which must be investigated in the calling controllers — outside the scope of these three files), an attacker could:

1. Override the `username` parameter, routing API quota to an arbitrary GeoNames account.
2. Inject `style`, `lang`, or other parameters that alter the shape of the response returned to the caller.
3. Inject a crafted `callback` parameter (if GeoNames JSONP is enabled on the account) to attempt to alter response parsing.

This is flagged as a finding because no allowlist filter is applied in these modules; the behaviour contracts (`available_url_parameters/0`) are never enforced by `url_arguments/1` itself.

**`String.to_atom` / unsafe deserialization:** Not present in any assigned file.

**Raw SQL / Ecto fragments:** Not present; these modules have no database interaction.

---

### §4: Session and CSRF

Not applicable to these endpoint descriptor modules. No session, cookie, or WebSocket logic is present.

§4: No issues found.

---

### §5: File and Data Handling

**GPS coordinate pass-through to third-party API (INFO)**

`FindNearbyStreets`, `[REDACTED-AWS-SMTP-PASSWORD]`, and `FindNearbyWeather` all accept `lat`/`lng` as required URL parameters and forward them to `api.geonames.org` without masking or anonymisation. In the context of a fleet management backend, these coordinates may represent real-time vehicle positions.

This is an architectural observation rather than a code defect in these modules. The data flow must be reviewed at the layer that calls these functions to confirm: (a) the GeoNames API is an authorised processor of fleet GPS data under the applicable data-sharing agreements and privacy policy, and (b) coordinates are not logged at DEBUG/INFO level by `HTTPoison` or the application logger before or after transmission.

**PII in Logger:** No `Logger` calls appear in any of the three assigned files.

**Error responses / stack traces:** These modules raise no errors; error handling is in `Geonames` (the wrapper) and is out of scope here.

§5: No issues found (INFO observation noted below as A027-2).

---

### §6: Dependencies

The `mix.exs` for the vendored library specifies:

```elixir
{:poison, "~> 3.1"},
{:httpoison, "~> 1.0"},
{:ex_doc, "~> 0.12", only: :dev}
```

- `poison ~> 3.1`: Poison 3.x is an old major version. Poison 4.x and 5.x were released with bug fixes. No known CVEs in 3.x affect confidentiality directly but the version constraint is loose and outdated.
- `httpoison ~> 1.0`: HTTPoison 1.x is significantly behind the current release line (2.x). No critical CVEs at time of writing, but the constraint is loose.
- `ex_doc ~> 0.12`: dev-only; no runtime impact.
- No `git:` source URLs are present — all dependencies are fetched from hex.pm.
- `mix.lock` is present in the vendored directory; exact pinning is therefore in use for reproducible builds.

The concern is that these are vendored files bundled inside the `api_server` repo. Whether the parent `api_server` `mix.exs`/`mix.lock` or this inner `mix.exs` governs the actual resolved versions needs to be confirmed. If this inner `mix.exs` is active, the loose `~>` constraints on Poison and HTTPoison may resolve to outdated patch versions depending on what is in the corresponding `mix.lock`.

§6: One finding noted below (A027-3).

---

### §7: Infrastructure Exposure

**Hardcoded base URL to external third-party service (LOW)**

In `Geonames.Helpers` (supporting context):

```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default value `"api.geonames.org/"` is hardcoded. If the application config does not override `:base_url`, all GeoNames traffic targets the public internet endpoint. This is the intended design of the library and not a secret exposure, but it means:

- There is no TLS enforcement in the base URL default (no `https://` prefix — the scheme is absent, meaning downstream URL construction in `build_url_string/2` produces scheme-less URLs of the form `api.geonames.org/findNearbyStreetsJSON?...`).
- Without `https://`, `HTTPoison.get/1` behaviour depends on whether HTTPoison applies a default scheme. If it does not, the connection may fall back to plain HTTP, transmitting GPS coordinates in cleartext.

This is directly relevant to the assigned files because the endpoint strings returned by `endpoint/0` in all three modules are used as path components in that URL.

§7: One finding noted below (A027-4).

---

## Findings

### A027-1
**Severity:** MEDIUM
**File:** All three assigned files
- `geonames-elixir/lib/geonames/endpoints/find_nearby_streets.ex` line 16-18
- `geonames-elixir/lib/geonames/endpoints/find_nearby_streets_osm.ex` line 17-19
- `geonames-elixir/lib/geonames/endpoints/find_nearby_weather.ex` line 16-18

**Title:** `url_arguments/1` performs an unfiltered map merge — arbitrary caller-supplied keys are forwarded to the upstream GeoNames API

**Detail:**

```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`Map.merge/2` retains all keys from both maps. Any key present in `provided_arguments` but absent from `@default_arguments` is silently passed through and ultimately appended to the outbound URL query string by `Geonames.Helpers.build_url_string/2`. The `available_url_parameters/0` allowlist is declared but never enforced at this layer.

**Impact:**
A caller (or, if callers pass raw HTTP params, an end-user) can inject extra GeoNames query parameters. Likely impacts: `username` override (routing API usage to attacker-controlled account, exhausting quota or bypassing rate limiting tied to the application's own account), `style` override (changing response verbosity), and potential `callback` injection affecting JSON response parsing if JSONP is active.

**Recommendation:**
Filter `provided_arguments` to only permitted keys before merging, or post-filter the merged map:

```elixir
def url_arguments(provided_arguments) do
  allowed = MapSet.new(available_url_parameters())
  filtered = Map.filter(provided_arguments, fn {k, _} -> MapSet.member?(allowed, k) end)
  Map.merge(@default_arguments, filtered)
end
```

This change must be applied consistently across all endpoint modules that use the same pattern.

---

### A027-2
**Severity:** INFO
**File:** All three assigned files (data flow concern)

**Title:** GPS coordinates for `lat`/`lng` are forwarded to an external third-party API (`api.geonames.org`) without documented consent or data-flow review

**Detail:**
The `FindNearbyStreets`, `[REDACTED-AWS-SMTP-PASSWORD]`, and `FindNearbyWeather` endpoints require `lat` and `lng` as mandatory parameters, which are then transmitted to the public GeoNames API. In the context of a fleet management backend, these coordinates likely represent real-time or recent vehicle positions, which may constitute personal data or commercially sensitive asset tracking data.

**Impact:**
If GPS coordinates belong to tracked drivers or customer fleet assets, their transmission to a third-party service requires explicit authorisation under the applicable privacy policy and data processing agreements. No evidence of such review is visible in these files.

**Recommendation:**
Confirm with the data/privacy owner that `api.geonames.org` is an approved data processor for fleet GPS coordinates. Verify that no DEBUG/INFO logger calls in the calling layers log raw lat/lng values. Consider whether coordinates should be coarsened (reduced precision) before forwarding to the third-party service.

---

### A027-3
**Severity:** LOW
**File:** `geonames-elixir/mix.exs`

**Title:** Vendored library uses outdated, loosely-pinned dependency versions for `poison` and `httpoison`

**Detail:**
The vendored `mix.exs` pins `{:poison, "~> 3.1"}` and `{:httpoison, "~> 1.0"}`. Poison 3.x is multiple major versions behind current (5.x); HTTPoison 1.x is behind 2.x. The `~>` operator allows automatic resolution to any newer patch/minor within the stated major, but the declared floor versions are old.

**Impact:**
If this inner `mix.exs` governs resolution (i.e., if the parent `api_server` project does not override these constraints in its own lockfile), the application may be running on old dependency versions that lack security patches or bug fixes accumulated in later releases. Additionally, Poison 3.x may be susceptible to atom exhaustion when decoding JSON with unknown keys if `keys: :atoms` mode is used (not visible in these files but possible in calling code).

**Recommendation:**
Update `mix.exs` constraints to current stable releases (`{:poison, "~> 5.0"}`, `{:httpoison, "~> 2.0"}`), regenerate `mix.lock`, and run the test suite. Confirm the parent `api_server` lockfile pins exact resolved versions.

---

### A027-4
**Severity:** LOW
**File:** `geonames-elixir/lib/geonames/helpers.ex` (supporting context for assigned files)

**Title:** Default base URL has no scheme — outbound HTTP requests to GeoNames may use plain HTTP, transmitting GPS coordinates in cleartext

**Detail:**
```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default value `"api.geonames.org/"` contains no URL scheme. The constructed URL (e.g. `api.geonames.org/findNearbyStreetsJSON?lat=...&lng=...`) is passed to `HTTPoison.get/1`. HTTPoison's `hackney` backend interprets scheme-less URLs as HTTP by default, meaning GPS coordinates transmitted via all three assigned endpoint modules may travel over an unencrypted connection if the application config does not explicitly override `:base_url` with `"https://api.geonames.org/"`.

**Impact:**
GPS coordinates (`lat`, `lng`) and the GeoNames API username are sent in plaintext over HTTP, exposing them to network eavesdropping on any path between the server and the GeoNames API.

**Recommendation:**
Set the default to `"https://api.geonames.org/"` and, if possible, configure HTTPoison/hackney to enforce TLS certificate verification for outbound connections.

---

## Summary Table

| ID | Severity | Title |
|---|---|---|
| A027-1 | MEDIUM | `url_arguments/1` unfiltered map merge allows arbitrary parameter injection to upstream GeoNames API |
| A027-2 | INFO | GPS coordinates forwarded to third-party API without documented data-flow/privacy review |
| A027-3 | LOW | Vendored library uses outdated, loosely-pinned `poison` and `httpoison` versions |
| A027-4 | LOW | Default base URL has no scheme — outbound requests may use plain HTTP |

No CRITICAL or HIGH severity issues were identified in the assigned files.

<!-- A030.md -->
# Audit Report A030
**Agent:** A030
**Run:** 2026-02-27-01
**Repo:** api_server
**Branch:** master
**Stack:** Elixir/Phoenix (vendored geonames-elixir endpoint modules)
**Date:** 2026-02-27

---

## Assigned Files

1. `geonames-elixir/lib/geonames/endpoints/find_nearby_wikipedia.ex`
2. `geonames-elixir/lib/geonames/endpoints/find_nearest_address.ex`
3. `geonames-elixir/lib/geonames/endpoints/find_nearest_intersection.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/find_nearby_wikipedia.ex`

**Module name:** `Geonames.Endpoints.FindNearbyWikipedia`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 14 |
| `available_url_parameters` | 0 | 15 |
| `required_url_parameters` | 0 | 16 |
| `function_name` | 0 | 17 |
| `url_arguments` | 1 | 19 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None. Only `@behaviour Geonames.Endpoint` at line 3.

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments` map literal with keys `lat`, `lng`, `radius`, `postalcode`, `country`, `maxRows` — all defaulting to `nil` (lines 5–12)

---

### File 2: `geonames-elixir/lib/geonames/endpoints/find_nearest_address.ex`

**Module name:** `Geonames.Endpoints.FindNearestAddress`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None. Only `@behaviour Geonames.Endpoint` at line 3.

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments` map literal with keys `lat`, `lng` — both defaulting to `nil` (lines 5–8)

---

### File 3: `geonames-elixir/lib/geonames/endpoints/find_nearest_intersection.ex`

**Module name:** `Geonames.Endpoints.FindNearestIntersection`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None. Only `@behaviour Geonames.Endpoint` at line 3.

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments` map literal with keys `lat`, `lng` — both defaulting to `nil` (lines 5–8)

---

## Checklist Review

### §1: Secrets and Configuration

No config files, environment variable access, credentials, API keys, secret key bases, database URLs, AWS resource identifiers, hardcoded hostnames, or release configuration are present in any of the three files. All three modules are pure behaviour-implementation data-mapping modules with no I/O or configuration concerns.

§1: No issues found.

---

### §2: Authentication and Authorization

These modules implement the `Geonames.Endpoint` behaviour and define only parameter-mapping logic. They contain no plug pipelines, no Guardian usage, no route definitions, no password handling, and no access-control logic. Authentication and authorization are entirely outside the scope of these files.

§2: No issues found.

---

### §3: Input Validation and Injection

All three files implement `url_arguments/1`, which merges a caller-supplied map over a static `@default_arguments` map using `Map.merge/2`. This is the primary code path that accepts external data.

**Observations:**

1. **No type validation or sanitisation of `provided_arguments`** — `url_arguments/1` accepts any map and merges it directly into the default arguments map. There is no guard, no schema, no Ecto changeset, and no type constraint. Values for `lat`, `lng`, `radius`, `postalcode`, `country`, `maxRows` are accepted as-is from the caller.

   The severity of this observation depends entirely on how callers use these modules. If the calling layer (e.g., `Geonames` client) passes user-supplied values directly without prior validation, arbitrary values will be forwarded to the external GeoNames HTTP API. Because the downstream call is to an external read-only third-party API (not an internal database), the injection surface is limited to malformed HTTP query strings — not SQL injection or Ecto injection.

2. **No atom creation from user input** — keys in `@default_arguments` are compile-time atoms. `Map.merge/2` does not create new atoms from keys present only in `provided_arguments`; excess keys are simply included in the merged map. No `String.to_atom/1` or `String.to_existing_atom/1` is used.

3. **No `Ecto.Adapters.SQL.query/3`, `fragment/1`, `:erlang.binary_to_term/1`, `Code.eval_string/1`, or `Kernel.apply/3`** — none of these patterns are present.

**Finding:**

A030-1 — LOW — `url_arguments/1` performs no input validation before forwarding caller-supplied parameters to the GeoNames API query string.

All three modules are affected:
- `Geonames.Endpoints.FindNearbyWikipedia.url_arguments/1` (line 19)
- `Geonames.Endpoints.FindNearestAddress.url_arguments/1` (line 15)
- `Geonames.Endpoints.FindNearestIntersection.url_arguments/1` (line 15)

If any calling code passes user-supplied values for `lat` or `lng` without prior type enforcement, non-numeric strings will be forwarded to the external API. While this does not constitute an injection vulnerability against an internal data store, it may result in unexpected error responses from GeoNames being propagated to clients or logged with user-supplied content. The risk is bounded by the fact that the GeoNames API is external, read-only, and unauthenticated from the user's perspective (the API key is expected to be added at a lower layer, not here). Remediation should occur at the calling layer rather than in these endpoint modules.

§3: One finding — see A030-1.

---

### §4: Session and CSRF

These modules contain no Phoenix endpoint configuration, no plug pipelines, no channel or WebSocket handling, and no session or cookie configuration.

§4: No issues found.

---

### §5: File and Data Handling

These modules perform no file I/O, no Logger calls, no error rendering, and return no PII, GPS coordinates, or fleet data to clients directly. They only produce parameter maps consumed by the GeoNames HTTP client layer.

Note: `lat` and `lng` parameters handled by `FindNearestAddress` and `[REDACTED-AWS-SMTP-PASSWORD]` are GPS coordinate values. These modules do not log, store, or return such values — they only pass them through to a parameter map. No disclosure risk exists within these files themselves. Risk from coordinates in transit or in API responses is outside the scope of these endpoint definition modules.

§5: No issues found.

---

### §6: Dependencies

These files do not declare or reference any Mix dependencies, hex packages, or `git:` source URLs. Dependency analysis is not applicable at the individual module level.

§6: No issues found.

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IP addresses, port numbers, TLS/SSL configuration, CORS settings, Content Security Policy headers, or inter-service call logic are present in any of the three files. The string values returned by `endpoint/0` (`"findNearbyWikipediaJSON"`, `"findNearestAddressJSON"`, `"findNearestIntersectionJSON"`) are GeoNames API endpoint path segments — these are public API identifiers, not internal infrastructure identifiers.

§7: No issues found.

---

## Findings Summary

| ID | Severity | File(s) | Description |
|----|----------|---------|-------------|
| A030-1 | LOW | `find_nearby_wikipedia.ex` (line 19), `find_nearest_address.ex` (line 15), `find_nearest_intersection.ex` (line 15) | `url_arguments/1` performs no input validation on the caller-supplied map before merging into the outbound GeoNames API query parameters. Risk is limited to malformed external API requests; no internal injection surface exists. |

---

## Notes

All three files are structurally identical shallow data-mapping modules implementing the `Geonames.Endpoint` behaviour. They are minimal and carry negligible security surface on their own. The single finding (A030-1) is a design-level observation about the absence of a validation layer, and its actual exploitability is fully determined by how the calling code (outside the scope of this assignment) handles user input before invoking these endpoint modules.

<!-- A033.md -->
# Audit Report A033
**Agent:** A033
**Run:** 2026-02-27-01
**Repository:** api_server
**Stack:** Elixir/Phoenix (vendored geonames-elixir library)
**Branch:** master
**Auditor model:** claude-sonnet-4-6

---

## Assigned Files

1. `geonames-elixir/lib/geonames/endpoints/find_nearest_intersection_osm.ex`
2. `geonames-elixir/lib/geonames/endpoints/get.ex`
3. `geonames-elixir/lib/geonames/endpoints/gtopo30.ex`

Supporting files read for full context (not assigned, but required to evaluate data flow):
- `geonames-elixir/lib/geonames/endpoint.ex` (behaviour definition)
- `geonames-elixir/lib/geonames/helpers.ex` (URL builder and username resolution)
- `geonames-elixir/lib/geonames.ex` (macro-generated public API and HTTP dispatch)
- `geonames-elixir/mix.exs` (dependency declarations)
- `geonames-elixir/mix.lock` (pinned dependency hashes)

---

## Reading Evidence

### File 1 — `geonames-elixir/lib/geonames/endpoints/find_nearest_intersection_osm.ex`

**Module name:** `Geonames.Endpoints.FindNearestIntersectionOSM`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attributes:**
```elixir
@default_arguments %{
  lat: nil,
  lng: nil,
  radius: nil,
  maxRows: nil
}
```

**Behaviour:** `@behaviour Geonames.Endpoint`

---

### File 2 — `geonames-elixir/lib/geonames/endpoints/get.ex`

**Module name:** `Geonames.Endpoints.Get`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attributes:**
```elixir
@default_arguments %{
  geonameId: nil,
  style: nil
}
```

**Behaviour:** `@behaviour Geonames.Endpoint`

---

### File 3 — `geonames-elixir/lib/geonames/endpoints/gtopo30.ex`

**Module name:** `Geonames.Endpoints.GTOPO30`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None.

**Module-level use / import / alias:** None (only `@behaviour Geonames.Endpoint`).

**Module attributes:**
```elixir
@default_arguments %{
  lat: nil,
  lng: nil
}
```

**Behaviour:** `@behaviour Geonames.Endpoint`

---

## Checklist Review

The three assigned modules are pure endpoint-descriptor modules. They contain no HTTP logic, no config resolution, no authentication, and no direct I/O. All security-relevant behaviour flows through `Geonames.Helpers` and `Geonames` (the macro-generated dispatcher), which were read as supporting context to reach accurate conclusions on the data-flow findings below.

---

### §1: Secrets and Configuration

No hardcoded credentials, API keys, database passwords, or secret key bases are present in any of the three assigned files.

The `@default_arguments` maps contain only parameter-shape definitions (atoms mapped to `nil`); no credential values appear.

The GeoNames `username` credential is resolved in `Geonames.Helpers.user_configuration/0` (supporting file) via `Application.get_env(:geonames, :username)` with a `System.get_env("GEONAMES_USERNAME")` fallback. This is outside the assigned files but is relevant context: no hardcoded username value was observed.

**§1: No issues found in assigned files.**

---

### §2: Authentication and Authorization

These modules are endpoint-descriptor wrappers for an outbound third-party API (geonames.org). They are not Phoenix controllers, do not implement authentication logic, and do not handle inbound requests from end users. There are no plug pipelines, Guardian tokens, or session management present.

**§2: No issues found in assigned files.**

---

### §3: Input Validation and Injection

**Finding A033-1 is raised below (MEDIUM).**

The `url_arguments/1` function in all three modules performs a `Map.merge(@default_arguments, provided_arguments)` without any validation or sanitisation of the caller-supplied map:

```elixir
# find_nearest_intersection_osm.ex line 17-19
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

The merged result is passed directly to `Geonames.Helpers.build_url_string/2`, which encodes values into a URL query string using string interpolation (`"#{k}=#{v}"`), before passing the entire string to `URI.encode/1`:

```elixir
# helpers.ex line 34-44 (supporting context)
|> Enum.map(fn
  {_,nil}                    -> nil
  {k,v} when is_binary(v)    -> "#{k}=#{v}"
  {k,v} when is_float(v)     -> "#{k}=#{v}"
  {k,v} when is_boolean(v)   -> "#{k}=#{v}"
  {k,v} when is_integer(v)   -> "#{k}=#{v}"
  {k,arr} when is_list(arr)  -> Enum.map(arr, &"#{k}=#{&1}")
end)
|> ...
|> Enum.join("&")
|> URI.encode
```

No type coercion, range checking, or allowlist validation is applied to individual parameter values in any of the three endpoint modules before they reach the URL builder. There is no validation that:

- `lat`/`lng` are numeric and within valid geographic ranges (-90..90, -180..180).
- `maxRows` is a positive integer within a sane bound.
- `geonameId` is a non-negative integer.
- `radius` is a positive numeric value.
- Caller-supplied keys beyond the known `@default_arguments` keys are rejected (extra keys propagate through `Map.merge` because the caller's map is the right-hand operand and will overwrite defaults, but in practice only keys already in `@default_arguments` can appear since `Map.merge` preserves unknown keys from both sides — however unknown keys in `provided_arguments` will also be included in the merged result and thus serialised into the URL).

The `URI.encode/1` call provides percent-encoding at the byte level but does not strip control characters or validate that values are semantically correct for each parameter.

**Practical impact:** Because these modules wrap an outbound call to `api.geonames.org` (a third-party service not operated by CIG), the primary risk is SSRF-adjacent parameter injection — a caller could supply crafted `lat`/`lng` string values containing `&username=attacker` or similar query-string injection fragments. `URI.encode` will encode the `&` to `%26`, which mitigates naive query-string injection for most values, but it does not validate that string-typed values are actually numeric where numeric is expected.

**No `String.to_atom/1`** from user input, **no `Code.eval_string/1`**, and **no `binary_to_term/1`** are present in the assigned files.

---

### §4: Session and CSRF

Not applicable. These modules contain no Phoenix endpoint, router, channel, or session logic.

**§4: No issues found in assigned files.**

---

### §5: File and Data Handling

No file I/O, no Logger calls, no PII handling, and no error view rendering are present in the assigned files.

`Geonames.perform_geonames_request/1` (supporting context, `geonames.ex` line 130-141) returns raw parsed JSON from geonames.org directly to the caller without filtering. Geographic coordinate data (lat/lng) passed into these endpoint modules originates from the application and potentially from vehicle/asset records. The endpoint modules themselves do not log this data.

**§5: No issues found in assigned files.**

---

### §6: Dependencies

The assigned files themselves declare no dependencies. The supporting `mix.exs` and `mix.lock` were read to assess the vendored library's dependency tree.

**Finding A033-2 is raised below (MEDIUM).**

`mix.exs` pins dependencies with approximate version operators (`~>`), which is normal Elixir practice. `mix.lock` pins exact versions for reproducible builds, which is correct. However, the locked versions are substantially outdated:

| Package | Locked version | Notes |
|---------|---------------|-------|
| `httpoison` | 1.3.0 (2018) | Current release is 2.x; 1.3.0 is multiple major versions behind |
| `hackney` | 1.13.0 (2018) | Transitive dep of httpoison; multiple versions behind |
| `poison` | 3.1.0 (2017) | Current is 6.x; 3.1.0 is significantly outdated |
| `certifi` | 2.3.1 (2018) | CA bundle is stale; current is 2.12.x |
| `ssl_verify_fun` | 1.1.1 | Current is 1.1.7 |

**Finding A033-3 is raised below (LOW).**

The `elixir: "~> 1.2"` constraint in `mix.exs` accepts Elixir 1.2 or higher. Elixir 1.2 was released in January 2016 and has been end-of-life for many years. This is a floor constraint, not an enforcement of a modern version, but it signals the library has not been maintained to track current Elixir releases.

No `git:` source specifications are present in `mix.exs`; all dependencies are fetched from hex.pm. No Mariaex dependency is present.

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IPs, or port numbers are present in the assigned endpoint files.

The base URL for the geonames.org API is defined in `Geonames.Helpers` as a compile-time module attribute:

```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

This is a public third-party API hostname and is not a CIG internal infrastructure endpoint; no exposure issue arises from this specific value.

No TLS configuration, CORS configuration, Content Security Policy, or inter-service authentication logic is present in the assigned files or in the supporting library code.

**§7: No issues found in assigned files.**

---

## Findings Summary

### A033-1 — No input validation on URL parameters before outbound API call
**Severity:** MEDIUM
**Files:**
- `geonames-elixir/lib/geonames/endpoints/find_nearest_intersection_osm.ex` — `url_arguments/1` (line 17)
- `geonames-elixir/lib/geonames/endpoints/get.ex` — `url_arguments/1` (line 15)
- `geonames-elixir/lib/geonames/endpoints/gtopo30.ex` — `url_arguments/1` (line 15)

**Description:**
All three endpoint modules implement `url_arguments/1` as a plain `Map.merge(@default_arguments, provided_arguments)` with no type checking, range validation, or allowlisting of keys. The merged map is passed directly to `Geonames.Helpers.build_url_string/2` which interpolates values into a query string and applies only `URI.encode/1`. Callers can supply arbitrary keys (they will be included in the outbound URL) and non-numeric string values for parameters that the geonames.org API expects to be numeric (e.g. `lat`, `lng`, `maxRows`, `geonameId`).

**Risk:**
If any of these functions are called with data that has originated from user-controlled input (e.g. a driver or device supplying their own coordinates through the fleet API), crafted string values could produce malformed requests or, in edge cases, inject additional query parameters if `URI.encode` fails to encode a separator character in a specific runtime condition.

**Recommendation:**
Add parameter-level validation in each `url_arguments/1` implementation to assert that numeric parameters (`lat`, `lng`, `radius`, `maxRows`, `geonameId`) are of the expected Elixir type before merging. Reject unknown keys from `provided_arguments` rather than passing them through. Consider using a thin changeset or guard-clause pattern.

---

### A033-2 — Severely outdated transitive dependencies (httpoison, hackney, poison, certifi)
**Severity:** MEDIUM
**File:** `geonames-elixir/mix.lock`

**Description:**
The vendored library's locked dependency set is approximately 6-7 years old as of the audit date. Specifically:
- `httpoison 1.3.0` and `hackney 1.13.0` are the HTTP client stack; multiple security-relevant releases have been issued since 2018 in both packages.
- `certifi 2.3.1` contains a CA bundle from 2018. An outdated CA bundle increases the risk that outbound TLS connections to geonames.org (or any service) may fail to validate certificates issued under newer CAs, or conversely may trust certificates from CAs that have since been distrusted.
- `poison 3.1.0` is the JSON decoder; it is used with `Poison.decode!/1` on the raw HTTP response body. Versions since 3.1.0 have addressed edge-case denial-of-service behaviours on malformed input.

**Risk:**
Stale CA bundle (`certifi`) is the most directly exploitable item: if geonames.org rotates to a certificate signed by a CA not in the 2018 bundle, outbound TLS verification could fail in a way that causes the application to either error or — depending on hackney TLS configuration — silently proceed without full verification. The outdated HTTP client stack may also carry unpatched vulnerabilities.

**Recommendation:**
Update `mix.lock` by running `mix deps.update --all` within the `geonames-elixir` vendored directory and review the updated transitive dependency set. At minimum, `certifi`, `hackney`, and `httpoison` should be brought to current releases. If the library is vendored and not independently maintained, the parent `api_server` application's own `mix.lock` should verify it is not also locked to these old transitive versions.

---

### A033-3 — Minimum Elixir version floor is end-of-life (1.2)
**Severity:** LOW
**File:** `geonames-elixir/mix.exs` line 6

**Description:**
```elixir
elixir: "~> 1.2"
```
The `~> 1.2` constraint permits the library to compile against Elixir 1.2, which reached end-of-life in 2016. This is a floor constraint only; it does not enforce that a modern Elixir version is used. However, it signals the library has not been updated to declare a minimum supported version aligned with currently maintained Elixir releases, and may mask compatibility assumptions that break on newer versions.

**Risk:**
Low direct security risk. The risk is primarily one of maintenance hygiene: if the constraint is not updated, future Elixir upgrades in the parent application could silently run this library under an untested version.

**Recommendation:**
Update the constraint to reflect the minimum Elixir version actually in use by the parent `api_server` application (at least `~> 1.12` or higher).

---

## Checklist Section Results

| Section | Result |
|---------|--------|
| §1 Secrets and Configuration | No issues found. |
| §2 Authentication and Authorization | No issues found. |
| §3 Input Validation and Injection | A033-1 raised (MEDIUM) |
| §4 Session and CSRF | No issues found. |
| §5 File and Data Handling | No issues found. |
| §6 Dependencies | A033-2 raised (MEDIUM), A033-3 raised (LOW) |
| §7 Infrastructure Exposure | No issues found. |

---

*End of report A033.*

<!-- A036.md -->
# Audit Report A036
**Agent:** A036
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Pass:** 1
**Date:** 2026-02-27

**Assigned files:**
- `geonames-elixir/lib/geonames/endpoints/hierarchy.ex`
- `geonames-elixir/lib/geonames/endpoints/neighbourhood.ex`
- `geonames-elixir/lib/geonames/endpoints/neighbours.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/hierarchy.ex`

**Module name:** `Geonames.Endpoints.Hierarchy`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 9 |
| `available_url_parameters` | 0 | 10 |
| `required_url_parameters` | 0 | 11 |
| `function_name` | 0 | 12 |
| `url_arguments` | 1 | 14 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None. (`@behaviour Geonames.Endpoint` declared at line 3.)

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{geonameId: nil}` (lines 5–7)

---

### File 2: `geonames-elixir/lib/geonames/endpoints/neighbourhood.ex`

**Module name:** `Geonames.Endpoints.Neighbourhood`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None. (`@behaviour Geonames.Endpoint` declared at line 3.)

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{lat: nil, lng: nil}` (lines 5–8)

---

### File 3: `geonames-elixir/lib/geonames/endpoints/neighbours.ex`

**Module name:** `Geonames.Endpoints.Neighbours`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None. (`@behaviour Geonames.Endpoint` declared at line 3.)

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{geonameId: nil, country: nil}` (lines 5–8)

---

## Checklist Review

All three files are thin behaviour-implementation modules for the vendored `geonames-elixir` library. Each module's sole runtime logic is `url_arguments/1`, which merges a caller-supplied map over a fixed default map using `Map.merge/2`. There are no HTTP calls, no database queries, no authentication logic, and no I/O in any of these files. The findings below reflect that narrow scope.

---

### §1: Secrets and Configuration

No config files, credentials, API keys, environment variable reads, or module attributes containing secret material are present in any of the three files.

§1: No issues found.

---

### §2: Authentication and Authorization

These modules contain no authentication or authorization logic. They are pure parameter-shaping helpers for an outbound HTTP library (geonames.org API). There are no plug pipelines, no Guardian calls, and no access-control decisions.

§2: No issues found.

---

### §3: Input Validation and Injection

**`url_arguments/1` in all three modules** accepts a caller-supplied map (`provided_arguments`) and merges it with the module's `@default_arguments` using `Map.merge/2`. No validation, no type coercion, and no allowlist enforcement is performed on the keys or values in `provided_arguments`.

Key observations per module:

- **Hierarchy** (`url_arguments/1`, line 14–16): merges arbitrary caller map over `%{geonameId: nil}`. The `:geonameId` value is passed directly to the GeoNames API URL by the library's HTTP layer. No range check, no integer coercion, no nil guard.
- **Neighbourhood** (`url_arguments/1`, line 15–17): merges arbitrary caller map over `%{lat: nil, lng: nil}`. Latitude and longitude values are passed as-is. No numeric range validation (lat must be −90..90, lng must be −180..180) is enforced here.
- **Neighbours** (`url_arguments/1`, line 15–17): merges arbitrary caller map over `%{geonameId: nil, country: nil}`. Additionally, `required_url_parameters/0` returns `[]` (line 12), meaning neither `geonameId` nor `country` is treated as required by this module's own contract, yet both are declared as `available_url_parameters`. The omission of any required parameter may cause silent failures or error responses from the upstream API.

No `String.to_atom/1` usage, no raw SQL, no `Code.eval_string`, and no `binary_to_term` are present.

**A036-1** — MEDIUM — `url_arguments/1` performs no input validation before forwarding caller-supplied values to the GeoNames API URL builder.

All three modules (`Hierarchy`, `Neighbourhood`, `Neighbours`) implement `url_arguments/1` by blindly merging the caller-supplied map with no key allowlisting, no type validation, and no value-range enforcement. Any unexpected key supplied by a caller will be forwarded as a URL query parameter to the upstream GeoNames API. For `Neighbourhood`, latitude and longitude are not range-checked (valid ranges: lat −90..90, lng −180..180); out-of-range or non-numeric values will produce a runtime error or a rejected upstream request whose error path must be handled by callers. Recommended: add an allowlist guard and type/range validation inside `url_arguments/1` or in the calling layer before parameters reach these modules.

Affected lines:
- `hierarchy.ex` line 14
- `neighbourhood.ex` line 15
- `neighbours.ex` line 15

**A036-2** — LOW — `Neighbours.required_url_parameters/0` returns an empty list despite both `:geonameId` and `:country` being listed as available parameters, creating an implicit contract mismatch.

`required_url_parameters/0` at line 12 of `neighbours.ex` returns `[]`. The GeoNames `neighboursJSON` endpoint requires either a `geonameId` or a `country` code to return any meaningful result; passing neither will produce an upstream API error. If the `Geonames.Endpoint` behaviour framework uses `required_url_parameters/0` to enforce presence before dispatching an HTTP call, this omission means no such enforcement occurs for this endpoint. Callers receive a runtime upstream error rather than a clear compile-time or changeset-level validation failure. Recommended: add at least one required parameter or document the at-least-one-of constraint explicitly and enforce it in the dispatch layer.

Affected line:
- `neighbours.ex` line 12

§3: 2 issues found (A036-1, A036-2).

---

### §4: Session and CSRF

These modules contain no session handling, no cookie configuration, no CSRF tokens, and no WebSocket/channel logic.

§4: No issues found.

---

### §5: File and Data Handling

No file I/O, no Logger calls, no PII handling, and no fleet/vehicle/driver data are present in any of the three files. These modules do not return HTTP responses to clients.

§5: No issues found.

---

### §6: Dependencies

These files are part of the vendored `geonames-elixir` library subtree. No `mix.exs` or `mix.lock` entries are contained within these individual source files. Dependency version auditing for this vendored library must be performed against the top-level `mix.lock` and `mix.exs` files, which are outside this agent's assigned scope.

§6: No issues found (in-scope files only).

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IP addresses, port numbers, CORS configuration, TLS settings, or inter-service call logic appear in any of the three files. The string literals `"hierarchyJSON"`, `"neighbourhoodJSON"`, and `"neighboursJSON"` are GeoNames API endpoint path fragments, not internal infrastructure identifiers.

§7: No issues found.

---

## Findings Summary

| ID | Severity | File | Line(s) | Summary |
|----|----------|------|---------|---------|
| A036-1 | MEDIUM | `hierarchy.ex`, `neighbourhood.ex`, `neighbours.ex` | 14, 15, 15 | `url_arguments/1` forwards caller-supplied map to upstream API with no key allowlisting, type coercion, or value-range validation |
| A036-2 | LOW | `neighbours.ex` | 12 | `required_url_parameters/0` returns `[]` despite both available parameters being effectively required for a meaningful API response; no enforcement prevents a no-parameter call |

---

## Notes

- All three modules are structurally identical thin wrappers implementing the `Geonames.Endpoint` behaviour. The only runtime logic in each is the `Map.merge/2` call in `url_arguments/1`.
- No secrets, no authentication, no direct I/O, no SQL, and no unsafe Elixir primitives (`String.to_atom/1`, `binary_to_term/1`, `Code.eval_string/1`) are present.
- The security posture of these modules depends heavily on what validation occurs in the calling layer (the `Geonames` dispatcher that ultimately passes URL parameters to an HTTP client). If callers validate before invoking these modules, A036-1 is mitigated at the call site. That calling-layer code is outside this agent's assigned files and should be reviewed separately.

<!-- A039.md -->
# Audit Report: A039
**Agent:** A039
**Run:** 2026-02-27-01
**Pass:** 1
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

**Assigned files (vendored geonames-elixir endpoint modules):**
- `geonames-elixir/lib/geonames/endpoints/oceans.ex`
- `geonames-elixir/lib/geonames/endpoints/postal_code_country_info.ex`
- `geonames-elixir/lib/geonames/endpoints/postal_code_lookup.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/oceans.ex`

**Module name:** `Geonames.Endpoints.Ocean`

**Public functions (def):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 11 |
| `available_url_parameters/0` | 0 | 12 |
| `required_url_parameters/0` | 0 | 13 |
| `function_name/0` | 0 | 14 |
| `url_arguments/1` | 1 | 16 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{lat: nil, lng: nil, radius: nil}` (line 5–9)

---

### File 2: `geonames-elixir/lib/geonames/endpoints/postal_code_country_info.ex`

**Module name:** `Geonames.Endpoints.PostalCodeCountryInfo`

**Public functions (def):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 8 |
| `available_url_parameters/0` | 0 | 9 |
| `required_url_parameters/0` | 0 | 10 |
| `function_name/0` | 0 | 11 |
| `url_arguments/1` | 1 | 13 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{}` (line 5–6)

---

### File 3: `geonames-elixir/lib/geonames/endpoints/postal_code_lookup.ex`

**Module name:** `Geonames.Endpoints.PostalCodeLookup`

**Public functions (def):**

| Function | Arity | Line |
|---|---|---|
| `endpoint/0` | 0 | 11 |
| `available_url_parameters/0` | 0 | 12 |
| `required_url_parameters/0` | 0 | 13 |
| `function_name/0` | 0 | 14 |
| `url_arguments/1` | 1 | 16 |

**defstruct / defexception / schema:** None.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{postalcode: nil, country: nil, maxRows: 20}` (line 5–9)

---

## Checklist Review

### §1: Secrets and Configuration

No config files, credentials, API keys, environment variable references, hardcoded AWS endpoints, or secret material of any kind are present in these three files.

§1: No issues found.

---

### §2: Authentication and Authorization

These modules are pure data-configuration modules implementing the `Geonames.Endpoint` behaviour. They contain no route definitions, plug pipelines, Guardian configuration, password handling, or authorization logic. They define parameter shapes for outbound GeoNames API calls — authentication and authorization decisions are made at a higher layer not present in these files.

§2: No issues found.

---

### §3: Input Validation and Injection

The `url_arguments/1` function in all three modules merges a caller-supplied map into a module-level default map using `Map.merge/2`. No SQL queries, Ecto fragments, raw SQL, atom creation from user input (`String.to_atom/1`), unsafe deserialization (`:erlang.binary_to_term/1`), `Code.eval_string/1`, or `Kernel.apply/3` are present.

However, two observations are raised:

**A039-1** (LOW) — `url_arguments/1` performs no validation of the keys or values in `provided_arguments` before merging them into the parameter map that is ultimately forwarded to the GeoNames external HTTP API. If a caller passes unexpected keys (e.g., `username`, `token`, or other GeoNames API parameters), those keys will be silently included in the outbound URL query string. There is no whitelist enforcement at this layer. While the immediate risk is low because these modules do not themselves make HTTP calls, the contract is permissive and relies entirely on the calling layer to restrict inputs. If the calling layer ever exposes `provided_arguments` to user-controlled data (e.g., pass-through of request query params), unexpected GeoNames parameters could be injected into the outbound call.

**A039-2** (INFO) — `Geonames.Endpoints.PostalCodeLookup` line 12: `available_url_parameters/0` contains a typo — `:postcalcode` (transposed 'l' and 'c') instead of `:postalcode`. The corresponding `required_url_parameters/0` on line 13 correctly spells `:postalcode`. This inconsistency means the `available_url_parameters` list does not include the correctly spelled atom that is actually required, which could lead to a validation bypass if any caller uses `available_url_parameters` as an allowlist to gate what may be passed into `url_arguments/1`. This is a logic defect with a potential security implication if the endpoint framework enforces parameter filtering based on `available_url_parameters`.

---

### §4: Session and CSRF

No session handling, CSRF tokens, WebSocket/channel code, or cookie configuration is present in these files.

§4: No issues found.

---

### §5: File and Data Handling

No file uploads, file I/O, Logger calls, or data returned to clients are present in these files. These modules solely define static configuration maps and short pure functions.

§5: No issues found.

---

### §6: Dependencies

These files contain no `mix.exs` references, no `Mix.Project`, no external library calls, and no `git:` dependency specifications. Dependency review is not applicable to these individual source modules; it is addressed at the project level by the `mix.exs`/`mix.lock` review.

§6: No issues found.

---

### §7: Infrastructure Exposure

No hostnames, IP addresses, port numbers, CORS configuration, TLS settings, or inter-service call logic are present. The GeoNames endpoint name strings (e.g., `"oceanJSON"`, `"postalCodeCountryInfoJSON"`, `"postalCodeLookupJSON"`) are public GeoNames API endpoint identifiers and do not reveal internal infrastructure topology.

§7: No issues found.

---

## Findings Summary

| ID | Severity | File | Description |
|---|---|---|---|
| A039-1 | LOW | `postal_code_lookup.ex`, `oceans.ex`, `postal_code_country_info.ex` | `url_arguments/1` performs no key/value validation on `provided_arguments`; any key passed by the caller is forwarded to the outbound GeoNames API URL without whitelist enforcement at this layer. |
| A039-2 | INFO | `postal_code_lookup.ex` line 12 | Typo in `available_url_parameters/0`: `:postcalcode` should be `:postalcode`. Mismatch with `required_url_parameters/0` could allow a validation bypass if the framework uses `available_url_parameters` as an allowlist. |

---

## Detailed Findings

### A039-1 — LOW
**File(s):** All three modules (`oceans.ex` line 16–18, `postal_code_country_info.ex` line 13–15, `postal_code_lookup.ex` line 16–18)
**Description:** The `url_arguments/1` function in all three endpoint modules accepts an arbitrary map (`provided_arguments`) and merges it into the default arguments map with no filtering or validation:

```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`Map.merge/2` with the provided map as the second argument means caller-supplied keys override defaults and any additional keys are included verbatim. There is no check that keys belong to the set declared in `available_url_parameters/0`, no type validation, and no value sanitisation. The resulting map is what gets serialised into the outbound GeoNames HTTP query string.

If any upstream caller constructs `provided_arguments` from user-controlled input (e.g., pass-through of HTTP query parameters), an attacker could inject arbitrary GeoNames API parameters — most notably the `username` parameter used for GeoNames authentication, which if overridden could exhaust a different account's quota, or add parameters such as `style` or `lang` that alter the response shape in unexpected ways.

**Recommendation:** Either enforce key filtering in `url_arguments/1` using `Map.take(provided_arguments, available_url_parameters())` before merging, or ensure that calling code never passes user-controlled input to this function without its own whitelist enforcement.

---

### A039-2 — INFO
**File:** `geonames-elixir/lib/geonames/endpoints/postal_code_lookup.ex` line 12
**Description:** Typo in `available_url_parameters/0`:

```elixir
# Line 12 — as written (typo):
def available_url_parameters, do: [:postcalcode, :country, :maxRows]

# Line 13 — correct spelling used in required_url_parameters:
def required_url_parameters, do: [:postalcode, :country]
```

The atom `:postcalcode` does not match the `:postalcode` key used in `@default_arguments` and `required_url_parameters`. If any caller uses `available_url_parameters/0` as a validation allowlist before calling `url_arguments/1`, the correct `:postalcode` key would be rejected (not in the available list) while the misspelled `:postcalcode` would be accepted — effectively inverting the validation for the primary required parameter.

**Recommendation:** Correct the typo on line 12 from `:postcalcode` to `:postalcode`.

<!-- A042.md -->
# Audit Report A042
**Agent:** A042
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

**Assigned files:**
- `geonames-elixir/lib/geonames/endpoints/postal_code_search.ex`
- `geonames-elixir/lib/geonames/endpoints/search.ex`
- `geonames-elixir/lib/geonames/endpoints/siblings.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/postal_code_search.ex`

**Module name:** `Geonames.Endpoints.PostalCodeSearch`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 22 |
| `available_url_parameters` | 0 | 23 |
| `required_url_parameters` | 0 | 24 |
| `function_name` | 0 | 25 |
| `url_arguments` | 1 | 27 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None (only `@behaviour Geonames.Endpoint` at line 3).

**Module-level `plug` / `pipeline`:** None.

**Module attribute `@default_arguments`** (line 5-20): atom-keyed map with 14 postal-code search parameters; all default to `nil` or `false`/`10`.

---

### File 2: `geonames-elixir/lib/geonames/endpoints/search.ex`

**Module name:** `Geonames.Endpoints.Search`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 35 |
| `available_url_parameters` | 0 | 36 |
| `required_url_parameters` | 0 | 37 |
| `function_name` | 0 | 38 |
| `url_arguments` | 1 | 40 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None (only `@behaviour Geonames.Endpoint` at line 3).

**Module-level `plug` / `pipeline`:** None.

**Module attribute `@default_arguments`** (line 5-33): atom-keyed map with 27 free-text search parameters; all default to `nil`.

---

### File 3: `geonames-elixir/lib/geonames/endpoints/siblings.ex`

**Module name:** `Geonames.Endpoints.Siblings`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 9 |
| `available_url_parameters` | 0 | 10 |
| `required_url_parameters` | 0 | 11 |
| `function_name` | 0 | 12 |
| `url_arguments` | 1 | 14 |

**Structs / exceptions / schemas defined:** None.

**Module-level `use` / `import` / `alias`:** None (only `@behaviour Geonames.Endpoint` at line 3).

**Module-level `plug` / `pipeline`:** None.

**Module attribute `@default_arguments`** (line 5-7): atom-keyed map with single key `:geonameId` defaulting to `nil`.

---

## Supporting-file Evidence (read for context, not assigned)

The following files were read to understand how the three assigned endpoint modules are consumed:

- `geonames-elixir/lib/geonames/endpoint.ex` — defines the `Geonames.Endpoint` behaviour callbacks.
- `geonames-elixir/lib/geonames/helpers.ex` — `build_url_string/2` assembles the outbound HTTP request URL; `user_configuration/0` reads `username` / `language` from application env or system env.
- `geonames-elixir/lib/geonames.ex` — macro loop generates one public function per endpoint module; calls `url_arguments/1` then `Helpers.build_url_string/2` then `HTTPoison.get/1`; decodes response with `Poison.decode!/1`.
- `geonames-elixir/mix.exs` and `geonames-elixir/mix.lock` — vendored library manifest and lockfile.
- `lib/api_server_web/controllers/utility_controller.ex` (lines 991-1050) — call-site in the main application.

---

## Checklist Review

### §1: Secrets and Configuration

The three assigned files contain no credentials, API keys, or connection strings.

**Supporting-file observation relevant to §1:**

In `geonames-elixir/lib/geonames/helpers.ex` line 8:

```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The default base URL is a hard-coded literal. This is a compile-time default, not a runtime environment variable. If the deploying project does not override `:geonames, :base_url` in its own config, all outbound API calls silently use the literal default. This is noted as INFO — it is a common pattern for a vendored wrapper library, and the value itself is not a secret.

In `geonames-elixir/lib/geonames/helpers.ex` line 52-56 (`user_configuration/0`):

```elixir
username: Application.get_env(:geonames, :username) || System.get_env("GEONAMES_USERNAME"),
language: Application.get_env(:geonames, :language, System.get_env("GEONAMES_LANGUAGE") || "en")
```

The GeoNames API username is read from application env or the environment variable `GEONAMES_USERNAME`. No hardcoded credential is present in the three assigned files or in `helpers.ex`. This is acceptable.

**A042-1 — INFO — Hardcoded base URL default in vendored library**
`geonames-elixir/lib/geonames/helpers.ex` line 8: the default `@base_url` value `"api.geonames.org/"` is compiled in. If `Application.get_env(:geonames, :base_url)` is not configured in the host project, all three endpoint modules' calls are silently routed to this compile-time default. The risk is low (the URL is a public API, not a secret), but it means a misconfigured deployment cannot be detected at runtime. Documented for completeness.

§1: No further issues found in the assigned files.

---

### §2: Authentication and Authorization

The three files define pure data/configuration modules. They have no routes, no plugs, no Guardian usage, no password handling, and no resource ownership checks. They do not implement or bypass any authentication layer. The endpoint modules are internal library building blocks; authentication is the caller's responsibility.

No issues arising from the assigned files themselves.

**Supporting-file observation:** `geonames.ex` calls `HTTPoison.get(url)` where the URL contains the GeoNames API `username` credential as a query parameter (assembled by `helpers.ex`). This is an outbound API call to a third-party service, not an inbound authenticated endpoint. The credential-as-query-parameter pattern is standard for the GeoNames API and not controllable by this library. Not a finding against the assigned files.

§2: No issues found.

---

### §3: Input Validation and Injection

This is the most significant area of concern for these modules.

**How user input flows through the assigned modules:**

All three modules implement `url_arguments/1` identically:

```elixir
def url_arguments(provided_arguments) do
  Map.merge(@default_arguments, provided_arguments)
end
```

`provided_arguments` is whatever map the caller passes (e.g., `Geonames.search(%{q: "London"})`). The merge is performed without any key or value validation. The merged map is then passed to `Helpers.build_url_string/2`, which iterates over the map and builds a query string:

```elixir
|> Enum.map(fn
  {_,nil}                    -> nil
  {k,v} when is_binary(v)    -> "#{k}=#{v}"
  {k,v} when is_float(v)     -> "#{k}=#{v}"
  {k,v} when is_boolean(v)   -> "#{k}=#{v}"
  {k,v} when is_integer(v)   -> "#{k}=#{v}"
  {k,arr} when is_list(arr)  -> Enum.map(arr, &"#{k}=#{&1}")
end)
|> Enum.join("&")
|> URI.encode
```

**A042-2 — MEDIUM — No input validation or key allowlist in `url_arguments/1`**

Severity: MEDIUM

Files:
- `geonames-elixir/lib/geonames/endpoints/postal_code_search.ex` line 27-29
- `geonames-elixir/lib/geonames/endpoints/search.ex` line 40-42
- `geonames-elixir/lib/geonames/endpoints/siblings.ex` line 14-16

`Map.merge(@default_arguments, provided_arguments)` allows the caller to inject arbitrary keys into the query string sent to the GeoNames API. Although `available_url_parameters/0` lists the intended keys, it is never enforced; it is documentation only. A caller can pass `%{username: "attacker_account"}` and silently override the configured GeoNames username, or inject any other query parameter the GeoNames API accepts (e.g., `token`, `style`, `charset`).

Additionally, `Map.merge/2` with an atom-keyed default map and a caller-supplied map means the caller is expected to supply atom keys. If user-supplied string data is ever converted to atom keys before being passed to these functions (e.g., via `String.to_atom/1`), atom table exhaustion becomes possible. No such conversion is visible in the immediately reviewed call sites (the two usages in `utility_controller.ex` use hardcoded atom keys), but the absence of enforcement is a latent risk if future callers pass user-controlled maps.

**A042-3 — MEDIUM — URL parameter values are not sanitized before query-string interpolation**

Severity: MEDIUM

File: `geonames-elixir/lib/geonames/helpers.ex` line 36-40 (supporting context for the assigned modules).

Values in the merged map are interpolated directly into the query string via string interpolation (`"#{k}=#{v}"`) before being passed to `URI.encode/1`. `URI.encode/1` in Elixir encodes the entire string, not individual components — it percent-encodes characters that are not valid in a URI, but it does not percent-encode `&`, `=`, or `?` within component values. A binary value containing `&` would split into a second query parameter at the HTTP layer. For example, if `provided_arguments` contains `%{q: "foo&username=attacker"}`, after `URI.encode` the assembled URL will contain `q=foo&username=attacker`, effectively injecting an extra query parameter. This is a query-string injection (parameter pollution) vulnerability. `URI.encode_www_form/1` or `URI.encode_query/1` should be used per-value rather than on the entire assembled string.

**A042-4 — LOW — `String.to_existing_atom` vs atom creation (latent risk)**

Severity: LOW

All three `@default_arguments` maps use atom keys. `url_arguments/1` accepts `provided_arguments` without constraining its key type. If any upstream caller converts user-supplied strings to atoms (e.g., via Phoenix param destructuring with `String.to_atom/1` or dynamic map construction) and passes them here, atom table exhaustion is possible. No direct `String.to_atom/1` call is present in the assigned files, so this is a latent/structural risk rather than an immediate finding.

§3 findings: A042-2, A042-3, A042-4 as above.

---

### §4: Session and CSRF

The three files are data-layer endpoint configuration modules. They define no routes, no plugs, no channels, and no session handling. Not applicable.

§4: No issues found.

---

### §5: File and Data Handling

The three files perform no file I/O, no logging, and return no HTTP responses. They do not handle PII, GPS coordinates, driver records, or fleet data directly.

**Supporting-file observation:** `Helpers.build_url_string/2` includes latitude/longitude values (passed through from callers such as `utility_controller.ex`) as query parameters in the outbound URL sent to `api.geonames.org`. These values originate from GPS telemetry (vehicle location). The GeoNames API call is outbound to a third-party service; GPS coordinates are therefore being disclosed to `api.geonames.org`. This is a design-level observation. It is not a finding against the assigned files, but it is noted as an INFO finding for the audit record.

**A042-5 — INFO — GPS coordinates transmitted to third-party GeoNames API**

Severity: INFO

File: `lib/api_server_web/controllers/utility_controller.ex` lines 1012, 1038 (call sites using the library).

Vehicle latitude/longitude (from fleet GPS data) is transmitted to `api.geonames.org` as part of geocoding lookups. Depending on data-processing agreements and applicable privacy regulations, disclosing precise fleet vehicle locations to a third-party service may require review. This is not a vulnerability in the assigned endpoint modules themselves, but it is raised for completeness given the fleet-management context described in §5 of the checklist.

§5: No issues found within the three assigned files themselves. See A042-5 for cross-cutting observation.

---

### §6: Dependencies

The three assigned files declare no dependencies of their own. The vendored library's `mix.exs` and `mix.lock` are examined below.

**`geonames-elixir/mix.exs` dependencies:**
- `poison ~> 3.1` (JSON)
- `httpoison ~> 1.0` (HTTP client)
- `ex_doc ~> 0.12` (dev only)

**`geonames-elixir/mix.lock` pinned versions:**
- `poison 3.1.0`
- `httpoison 1.3.0`
- `hackney 1.13.0` (transitive, HTTP backend)
- `certifi 2.3.1` (transitive, TLS certificates)
- `ssl_verify_fun 1.1.1` (transitive)
- `idna 5.1.2` (transitive)

**A042-6 — HIGH — Severely outdated vendored dependencies**

Severity: HIGH

The vendored `geonames-elixir` library pins very old versions:

| Package | Locked version | Current stable (approx.) | Notes |
|---------|---------------|--------------------------|-------|
| `poison` | 3.1.0 (2017) | 6.x | Multiple releases; 3.x branch no longer maintained |
| `httpoison` | 1.3.0 (2018) | 2.x | Outdated; upstream is 2.2+ |
| `hackney` | 1.13.0 (2018) | 1.20+ | TLS/connection handling fixes in later versions |
| `certifi` | 2.3.1 (2018) | 2.14+ | CA bundle from 2018; may not include current root certificates |
| `ssl_verify_fun` | 1.1.1 (2016) | 1.1.7 | Hostname verification library, unmaintained version |

The `certifi 2.3.1` CA bundle dates to 2018 and will be missing root certificates added since then. Recent certificate renewals (e.g., the Sectigo Root R46 issue referenced in recent commit `e486dd8`) demonstrate that outdated CA bundles can cause TLS handshake failures. The `hackney` + `certifi` combination is used for all outbound calls to `api.geonames.org` from these endpoint modules.

No Mariaex 0.8.2 is present.

All dependencies are sourced from `hexpm`; no `git:` URLs are present. The `mix.lock` file does pin exact versions (reproducible builds are possible).

§6 finding: A042-6 as above.

---

### §7: Infrastructure Exposure

**A042-7 — INFO — Hardcoded third-party API hostname**

Severity: INFO

`geonames-elixir/lib/geonames/helpers.ex` line 8:

```elixir
@base_url Application.get_env(:geonames, :base_url, "api.geonames.org/")
```

The third-party hostname `api.geonames.org` is compiled in as a fallback default. This is not an internal infrastructure hostname, so it does not reveal internal topology. It is noted for completeness.

No hardcoded internal IPs, RDS endpoints, or AWS infrastructure strings are present in the three assigned files or the supporting library files.

No CORS configuration is present (these are not Phoenix endpoint/router files).

No TLS termination is performed by these modules; they are HTTP client callers, not servers.

§7: No further issues found.

---

## Findings Summary

| ID | Severity | File(s) | Description |
|----|----------|---------|-------------|
| A042-1 | INFO | `geonames-elixir/lib/geonames/helpers.ex:8` | Hardcoded compile-time default base URL `api.geonames.org/`; misconfiguration not detectable at runtime |
| A042-2 | MEDIUM | `postal_code_search.ex:27`, `search.ex:40`, `siblings.ex:14` | `url_arguments/1` performs unconstrained `Map.merge` — no key allowlist enforced; `available_url_parameters/0` is documentation only; callers can inject arbitrary query parameters including overriding the `username` credential |
| A042-3 | MEDIUM | `geonames-elixir/lib/geonames/helpers.ex:36-40` | Per-value query-string interpolation uses `URI.encode/1` on the full assembled string rather than `URI.encode_www_form/1` per value; binary values containing `&` or `=` enable query-parameter injection/pollution |
| A042-4 | LOW | `postal_code_search.ex:27`, `search.ex:40`, `siblings.ex:14` | Atom-keyed merge with unconstrained `provided_arguments`; latent atom exhaustion risk if upstream code converts user strings to atoms before passing to these functions |
| A042-5 | INFO | `lib/api_server_web/controllers/utility_controller.ex:1012,1038` | GPS coordinates from fleet vehicles are transmitted to third-party `api.geonames.org`; privacy/data-processing agreement review advised |
| A042-6 | HIGH | `geonames-elixir/mix.lock` | Vendored library uses severely outdated dependencies (2016-2018); notably `certifi 2.3.1` CA bundle predates current root certificates, risking TLS failures for outbound calls through these endpoint modules |
| A042-7 | INFO | `geonames-elixir/lib/geonames/helpers.ex:8` | Hardcoded third-party hostname in compile-time default (low risk, documented for completeness) |

---

*End of report A042.*

<!-- A045.md -->
# Audit Report — A045
**Agent:** A045
**Pass:** 1
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

- `geonames-elixir/lib/geonames/endpoints/srtm1.ex`
- `geonames-elixir/lib/geonames/endpoints/srtm3.ex`
- `geonames-elixir/lib/geonames/endpoints/timezone.ex`

---

## Reading Evidence

### File 1: `geonames-elixir/lib/geonames/endpoints/srtm1.ex`

**Module name:** `Geonames.Endpoints.SRTM1`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None defined.

**Module-level use / import / alias:** None. Module uses `@behaviour Geonames.Endpoint` (line 3).

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{lat: nil, lng: nil}` (lines 5–8)

---

### File 2: `geonames-elixir/lib/geonames/endpoints/srtm3.ex`

**Module name:** `Geonames.Endpoints.SRTM3`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 10 |
| `available_url_parameters` | 0 | 11 |
| `required_url_parameters` | 0 | 12 |
| `function_name` | 0 | 13 |
| `url_arguments` | 1 | 15 |

**defstruct / defexception / schema:** None defined.

**Module-level use / import / alias:** None. Module uses `@behaviour Geonames.Endpoint` (line 3).

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{lat: nil, lng: nil}` (lines 5–8)

---

### File 3: `geonames-elixir/lib/geonames/endpoints/timezone.ex`

**Module name:** `Geonames.Endpoints.Timezone`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**defstruct / defexception / schema:** None defined.

**Module-level use / import / alias:** None. Module uses `@behaviour Geonames.Endpoint` (line 3).

**Module attributes:**
- `@moduledoc false` (line 2)
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{lat: nil, lng: nil, radius: nil, date: nil}` (lines 5–10)

---

## Checklist Review

### §1: Secrets and Configuration

All three modules contain no configuration loading, no module attributes referencing credentials, API keys, secret key bases, environment variables, or external service URLs. The `@default_arguments` maps hold only `nil` values for geographic/temporal parameters (`lat`, `lng`, `radius`, `date`).

§1: No issues found.

---

### §2: Authentication and Authorization

These modules are pure endpoint descriptor modules implementing the `Geonames.Endpoint` behaviour. They define no plugs, no routes, no authentication checks, and no authorization logic. They do not receive or process requests directly. Authentication and authorization responsibility lies with callers of these modules, which are outside the scope of these files.

§2: No issues found.

---

### §3: Input Validation and Injection

The `url_arguments/1` function in all three modules performs a `Map.merge(@default_arguments, provided_arguments)`. This merges caller-supplied arguments onto the default map. Key observations:

- There is no atom creation from user input (`String.to_atom/1`) in these files.
- There are no raw SQL fragments, no `Ecto.Adapters.SQL.query/3`, no `fragment/1` calls.
- There is no `Code.eval_string/1`, no `:erlang.binary_to_term/1`, and no `Kernel.apply/3`.
- No deserialization is performed.
- The `url_arguments/1` function does not validate the types or contents of `provided_arguments` before merging. However, this function is a configuration-time descriptor, not a request handler — it assembles URL query parameters passed downstream to the GeoNames HTTP API. Input validation is the responsibility of the calling layer. This is noted as an informational observation; the risk is low given the narrow scope of these modules.

§3: No issues found.

---

### §4: Session and CSRF

These modules define no plugs, no endpoint configuration, no WebSocket/channel logic, and no session handling. CSRF and session configuration are not applicable.

§4: No issues found.

---

### §5: File and Data Handling

These modules perform no file I/O, no logging, and return no HTTP responses directly. No GPS coordinates, PII, driver data, or fleet data are logged or disclosed. The modules only assemble parameter maps for downstream use.

§5: No issues found.

---

### §6: Dependencies

These files do not declare dependencies. Dependency review for the geonames-elixir vendored library as a whole (mix.exs, mix.lock) is outside the scope of these three endpoint files and would be covered by a separate assigned file review.

§6: No issues found (within scope of assigned files).

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IP addresses, port numbers, or internal service URLs appear in any of the three files. The endpoint name strings (`"srtm1JSON"`, `"srtm3JSON"`, `"timezoneJSON"`) are GeoNames public API endpoint path segments — these are not CIG infrastructure identifiers. No CORS configuration, TLS settings, or inter-service communication is present in these files.

§7: No issues found.

---

## Findings

No security findings were identified in the three assigned files. All three modules are minimal, stateless, behaviour-implementing descriptor modules with no secrets, no input handling, no authentication logic, no file I/O, no logging, and no infrastructure references.

**Total findings: 0**

---

*End of report A045.*

<!-- A048.md -->
# Audit Report A048
**Agent:** A048
**Pass:** 1
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Auditor model:** claude-sonnet-4-6

**Assigned files:**
- `geonames-elixir/lib/geonames/endpoints/weather.ex`
- `geonames-elixir/lib/geonames/endpoints/weather_icao.ex`
- `geonames-elixir/lib/geonames/endpoints/wikipedia_bounding_box.ex`
- `geonames-elixir/lib/geonames/endpoints/wikipedia_search.ex`

---

## Reading Evidence

---

### File 1: `geonames-elixir/lib/geonames/endpoints/weather.ex`

**Module name:** `Geonames.Endpoints.Weather`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 12 |
| `available_url_parameters` | 0 | 13 |
| `required_url_parameters` | 0 | 14 |
| `function_name` | 0 | 15 |
| `url_arguments` | 1 | 17 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{north: nil, south: nil, east: nil, west: nil}` (lines 5-10)

---

### File 2: `geonames-elixir/lib/geonames/endpoints/weather_icao.ex`

**Module name:** `Geonames.Endpoints.WeatherICAO`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 9 |
| `available_url_parameters` | 0 | 10 |
| `required_url_parameters` | 0 | 11 |
| `function_name` | 0 | 12 |
| `url_arguments` | 1 | 14 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{ICAO: nil}` (lines 5-7)

---

### File 3: `geonames-elixir/lib/geonames/endpoints/wikipedia_bounding_box.ex`

**Module name:** `Geonames.Endpoints.WikipediaBoundingBox`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 13 |
| `available_url_parameters` | 0 | 14 |
| `required_url_parameters` | 0 | 15 |
| `function_name` | 0 | 16 |
| `url_arguments` | 1 | 18 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{north: nil, south: nil, east: nil, west: nil, maxRows: 10}` (lines 5-11)

---

### File 4: `geonames-elixir/lib/geonames/endpoints/wikipedia_search.ex`

**Module name:** `Geonames.Endpoints.WikipediaSearch`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `endpoint` | 0 | 11 |
| `available_url_parameters` | 0 | 12 |
| `required_url_parameters` | 0 | 13 |
| `function_name` | 0 | 14 |
| `url_arguments` | 1 | 16 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:** None.

**Other module-level attributes:**
- `@behaviour Geonames.Endpoint` (line 3)
- `@default_arguments %{q: nil, title: nil, maxRows: 10}` (lines 5-9)

---

## Checklist Review

### §1: Secrets and Configuration

No config files, credentials, API keys, secrets, or environment variable references appear in any of the four files. All four modules contain only compile-time module attributes defining parameter names and default values (all `nil` or small integer constants). No hardcoded hostnames, AWS resource names, or Bitbucket pipeline references are present.

**§1: No issues found.**

---

### §2: Authentication and Authorization

These are pure endpoint-descriptor modules implementing the `Geonames.Endpoint` behaviour. They contain no authentication logic, no plug pipelines, no Guardian configuration, no password handling, and no resource-ownership checks. Authentication and authorization are expected to be enforced by the calling layer (the HTTP client wrapper and application controllers), not within these descriptor modules. No issues attributable to these files.

**§2: No issues found.**

---

### §3: Input Validation and Injection

The `url_arguments/1` function in each module performs a `Map.merge(@default_arguments, provided_arguments)`, merging caller-supplied arguments over the module's default map. There is no validation of the types or values of `provided_arguments` within these modules.

The following observations apply:

**A048-1 — MEDIUM — Missing input validation in `url_arguments/1` (all four modules)**

Each module's `url_arguments/1` accepts an arbitrary map `provided_arguments` and merges it directly into `@default_arguments` without any type, range, or key whitelist validation. The merged result is presumably passed downstream to construct a URL query string for the GeoNames HTTP API. If the calling code does not enforce validation before calling `url_arguments/1`, a caller could inject unexpected keys into the URL (parameter pollution) or supply values of unexpected types (e.g., maps or lists instead of scalars), potentially causing malformed requests or unexpected behaviour in the GeoNames API client layer.

Affected files and lines:
- `weather.ex` line 17-19: `url_arguments/1`
- `weather_icao.ex` line 14-16: `url_arguments/1`
- `wikipedia_bounding_box.ex` line 18-20: `url_arguments/1`
- `wikipedia_search.ex` line 16-18: `url_arguments/1`

Note: Each module does declare `required_url_parameters/0` and `available_url_parameters/0`, which would allow a caller to enforce a whitelist and presence check. However, these descriptor functions are advisory only — there is no enforcement within `url_arguments/1` itself. If the caller does not use them, the validation gap is open.

No raw SQL, atom creation from user input, `binary_to_term`, `Code.eval_string`, or `Kernel.apply` with user-controlled arguments was found in any file.

---

### §4: Session and CSRF

These modules contain no session handling, cookie configuration, WebSocket/channel logic, or CSRF protection. These concerns are not within scope for this layer.

**§4: No issues found.**

---

### §5: File and Data Handling

No file upload handling, `File.write/2`, `Logger` calls, or error response rendering is present in any of the four files. No PII, GPS coordinates, driver data, or fleet data is handled within these modules.

**§5: No issues found.**

---

### §6: Dependencies

These files contain no `mix.exs` entries, dependency declarations, or `git:` source references. Dependency review for the `geonames-elixir` vendored library is outside the scope of these four endpoint modules specifically; it would need to be assessed at the library's `mix.exs` and `mix.lock` level.

**§6: No issues found** (within the scope of these four files; library-level dependency review is deferred to the relevant assigned agent).

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IP addresses, port numbers, or internal service URLs are present in any of the four files. The string literals present are GeoNames API endpoint path fragments (`"weatherJSON"`, `"weatherIcaoJSON"`, `"wikipediaBoundingBoxJSON"`, `"wikipediaSearchJSON"`), which are standard public GeoNames API endpoint names and do not reveal internal CIG infrastructure topology.

No CORS configuration, TLS configuration, or inter-service communication logic is present.

**§7: No issues found.**

---

## Summary of Findings

| ID | Severity | File(s) | Description |
|---|---|---|---|
| A048-1 | MEDIUM | `weather.ex:17`, `weather_icao.ex:14`, `wikipedia_bounding_box.ex:18`, `wikipedia_search.ex:16` | `url_arguments/1` merges caller-provided arguments without whitelist or type validation; advisory `available_url_parameters/0` is not enforced internally, leaving validation to the caller. |

---

*End of report A048.*

<!-- A053.md -->
# Audit Report A053
**Agent:** A053
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Files assigned:**
- `lib/api_server.ex`
- `lib/api_server/application.ex`
- `lib/api_server/fortynine/calamppositionevents.ex`

---

## Reading Evidence

### File 1: `lib/api_server.ex`

**Module name:** `ApiServer`

**Public functions (def):** None.

**defstruct / defexception / schema:** None.

**use / import / alias:** None.

**Notes:** This is a bare module containing only a `@moduledoc` string. It serves as the top-level namespace placeholder generated by Phoenix. No logic is present.

---

### File 2: `lib/api_server/application.ex`

**Module name:** `ApiServer.Application`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `start` | 2 | 6 |
| `config_change` | 3 | 36 |

**defstruct / defexception / schema:** None.

**use / import / alias:**
- `use Application` (line 2)
- `import Supervisor.Spec` (line 7, inside `start/2`)

**Child specifications registered in supervisor tree:**
- `ApiServer.FortyNineRepo` (Ecto repo, supervisor)
- `ApiServer.Repo` (Ecto repo, supervisor)
- `ApiServerWeb.Endpoint` (Phoenix endpoint, supervisor)
- `ApiServer.Scheduler` (cron scheduler)
- `Task.Supervisor` named `ApiServer.TCP.TaskSupervisor`
- `Task` running `ApiServer.TCP.accept(tcp_port)` with `restart: :permanent`
- `ConCache` named `:geocode_store` with `ttl_check_interval: false`

**Environment variable usage:**
- `TCP_PORT` read at line 9 via `System.get_env/1`, defaulting to `"4001"`.

---

### File 3: `lib/api_server/fortynine/calamppositionevents.ex`

**Module name:** `ApiServer.FortyNine.CalampPositionEvents`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 91 |

**defstruct / defexception / schema:**
- `schema "calamppositionevents"` defined at line 7.
  Fields (88 total, selected notable ones):
  - `:datetimesaved`, `:gmtdatetime`, `:timeoffix` — datetime
  - `:hardwareid` — integer (device identifier)
  - `:latitude`, `:longitude` — float (GPS coordinates / PII)
  - `:driverid`, `:mifaredriverid` — string (PII / driver identity data)
  - `:wsusername`, `:wspassword` — string (credentials stored in schema)
  - `:originalmsg` — binary (raw device message payload)
  - `:prestartchecklist`, `:appmsgtext`, `:appmsgtext2` — freeform strings
  - Engine/telemetry floats: `:rpm`, `:engcoolanttemp`, `:engoilpressure`, etc.

**use / import / alias:**
- `use Ecto.Schema` (line 2)
- `use Bitwise` (line 3)
- `use Timex` (line 4)
- `import Ecto.Changeset` (line 5)

---

## Security Review

### §1: Secrets and Configuration

**A053-1 — CRITICAL — Credential fields (`wsusername`, `wspassword`) persisted to database via Ecto schema**

File: `lib/api_server/fortynine/calamppositionevents.ex`, lines 31–32 (schema) and line 93 (changeset cast list).

The schema `[REDACTED-AWS-SMTP-PASSWORD]` declares `:wsusername` and `:wspassword` as first-class fields on the schema, and `changeset/2` includes both in the `cast/3` call with no exclusion or transformation. This means:

1. Credentials arrive from the CALAmp device/parser and are written to the database as plaintext.
2. Any code that reads a `[REDACTED-AWS-SMTP-PASSWORD]` struct will carry the password in memory alongside telemetry data.
3. Any logging, inspection, or serialisation of these structs (e.g., error reports, `IO.inspect`, JSON serialisation of query results) will leak the plaintext password.

The checklist requires that credentials not appear in tracked code as module attributes or application defaults, and the broader fleet-data guidance requires that sensitive data not leak across boundaries. Storing device credentials inside a telemetry event row violates both principles. There is no hashing, masking, or redaction anywhere in this file.

**A053-2 — LOW — `TCP_PORT` default hardcoded in application source**

File: `lib/api_server/application.ex`, line 9.

```elixir
tcp_port = String.to_integer(System.get_env("TCP_PORT") || "4001")
```

The fallback port `4001` is hardcoded in source. In isolation this is low severity (it is a non-privileged port and the real value should come from the environment variable), but it means a deployment that omits `TCP_PORT` silently binds on 4001 rather than failing fast, which could mask a misconfiguration.

---

### §2: Authentication and Authorization

**A053-3 — HIGH — Raw device credentials in telemetry schema with no validation or access controls**

File: `lib/api_server/fortynine/calamppositionevents.ex`, lines 31–32, 93.

`wsusername` and `wspassword` are included in the `cast` list inside `changeset/2` with no `validate_format`, `validate_length`, or any other constraint. Because the changeset accepts these fields from any attrs map passed to it, a caller can supply arbitrary credential values and they will be accepted without validation. The only `validate_required` check is on `:hardwareid`, leaving credential fields completely unconstrained.

Additionally, because these credentials are embedded in a telemetry event row, there are no access-control boundaries: any code path that can query `[REDACTED-AWS-SMTP-PASSWORD]` for GPS/telemetry data will also retrieve associated credentials, widening the blast radius of any SQL injection or IDOR vulnerability elsewhere in the application.

---

### §3: Input Validation and Injection

**A053-4 — MEDIUM — Changeset casts all 88 fields with only a single `validate_required` check**

File: `lib/api_server/fortynine/calamppositionevents.ex`, lines 91–95.

`changeset/2` casts every field in the schema (including freeform strings such as `:appmsgtext`, `:appmsgtext2`, `:prestartchecklist`, `:errormsg`, `:location`, `:city`, `:state`, `:postcode`) with no length validation, format validation, or content sanitisation. While Ecto's type casting provides some type coercion, there are no upper-bound length constraints on string fields. Overly long values could cause downstream issues (database column overflow, memory pressure when building large changesets, or injection if any of these strings are later interpolated into queries or log messages without escaping).

No `String.to_atom/1` or unsafe deserialisation was observed in these three files.

---

### §4: Session and CSRF

§4: No issues found.

These three files contain no session, cookie, CSRF token, or WebSocket/channel configuration. Session and CSRF concerns belong to the endpoint and router modules, which are not assigned to this agent.

---

### §5: File and Data Handling

**A053-5 — HIGH — GPS coordinates and driver identity fields (PII) stored in a schema with no field-level access logging or redaction indication**

File: `lib/api_server/fortynine/calamppositionevents.ex`, lines 12–13 (`:latitude`, `:longitude`), line 55 (`:driverid`), line 56 (`:mifaredriverid`).

The schema stores vehicle GPS coordinates, driver IDs, and Mifare RFID card IDs alongside all other telemetry. The checklist requires verifying that fleet/driver/location data is scoped to the authenticated user's organisation and not returned across customer boundaries. This schema itself cannot enforce that boundary — the enforcement must occur in query code — but the presence of PII fields here means that any unscoped query returning `[REDACTED-AWS-SMTP-PASSWORD]` rows will expose PII across tenants. This finding is raised for visibility; the reviewer of query/controller modules must confirm tenant scoping is applied when this schema is queried.

**A053-6 — MEDIUM — Raw binary device message (`:originalmsg`) stored and cast without size or content constraints**

File: `lib/api_server/fortynine/calamppositionevents.ex`, line 58 (schema), line 93 (cast list).

The `:originalmsg` field is typed as `:binary` and is included in the cast list with no size limit. A malformed or abnormally large device message could be stored as-is. If this binary is later decoded or processed by application code (e.g., replayed through the parser), unvalidated binary content could trigger parser vulnerabilities. No size validation was observed.

---

### §6: Dependencies

§6: No issues found.

No `mix.exs` or `mix.lock` files are within the assigned file set. Dependency review is deferred to the agent assigned those files. The three files reviewed import only standard Elixir/OTP modules (`Application`, `Supervisor`), Hex-distributed libraries (`Ecto`, `Timex`, `Bitwise`), and project-internal modules. No `git:` URL dependencies are visible in these files.

---

### §7: Infrastructure Exposure

**A053-7 — LOW — TCP listener port binding is permanent and unconditionally started**

File: `lib/api_server/application.ex`, lines 21–22.

```elixir
{Task.Supervisor, name: ApiServer.TCP.TaskSupervisor},
Supervisor.child_spec({Task, fn -> ApiServer.TCP.accept(tcp_port) end}, restart: :permanent),
```

The TCP acceptor task is started with `restart: :permanent` and is part of the application's top-level supervisor. There is no environment-gated condition that would prevent the TCP listener from starting in a non-production environment (e.g., CI or test). This means the TCP port is always opened unless the caller explicitly sets `TCP_PORT` and controls network access. Combined with finding A053-2 (hardcoded default port), any deployment that does not set `TCP_PORT` will silently open port 4001. The TCP server is a direct network ingress point; its security depends entirely on `ApiServer.TCP.accept/1` (not reviewed in this pass).

**A053-8 — INFO — `ConCache` started with `ttl_check_interval: false`**

File: `lib/api_server/application.ex`, line 25.

```elixir
{ConCache, [name: :geocode_store, ttl_check_interval: false]}
```

TTL checking is disabled for the geocode store. If cached geocode results are ever associated with a specific user or tenancy context, stale entries will never expire automatically, potentially serving one customer's location data for a query that should return another's. This is flagged for awareness; the actual risk depends on how `:geocode_store` is populated and consumed (not visible in assigned files).

---

## Summary of Findings

| ID | Severity | File | Summary |
|----|----------|------|---------|
| A053-1 | CRITICAL | `calamppositionevents.ex` | Plaintext credentials (`wsusername`, `wspassword`) persisted in telemetry schema and cast without masking or hashing |
| A053-2 | LOW | `application.ex` | Hardcoded TCP port fallback (`4001`) masks misconfiguration |
| A053-3 | HIGH | `calamppositionevents.ex` | Device credentials in schema with no validation; all credential data co-located with queryable telemetry |
| A053-4 | MEDIUM | `calamppositionevents.ex` | 88-field mass-cast changeset with no length/format validation on string fields |
| A053-5 | HIGH | `calamppositionevents.ex` | PII (GPS coordinates, driver IDs) in schema; tenant scoping cannot be verified from schema alone — must be confirmed in query/controller layer |
| A053-6 | MEDIUM | `calamppositionevents.ex` | Raw binary device message (`:originalmsg`) stored with no size constraint |
| A053-7 | LOW | `application.ex` | TCP listener always started with `restart: :permanent`; no env-gate for non-production environments |
| A053-8 | INFO | `application.ex` | `ConCache` geocode store has TTL checking disabled — stale cached entries never expire |

<!-- A056.md -->
# Pass 1 Security Audit — A056
**Agent:** A056
**Stack:** Elixir/Phoenix — api_server
**Branch:** master
**Run:** 2026-02-27-01

---

## Assigned Files

1. `lib/api_server/fortynine/webservicepositionqueue.ex`
2. `lib/api_server/guardian.ex`
3. `lib/api_server/operators/file.ex`

Supporting config files read for context:
- `config/config.exs` (Guardian config, secret_key_base)
- `config/prod.exs` (database credentials, SMTP credentials)
- `config/prod.secret.exs` (secret_key_base override)
- `.gitignore` (secret exclusion verification)
- `mix.exs` (guardian dependency version)
- `mix.lock` (guardian pinned version)

---

## Reading Evidence

### File 1: `lib/api_server/fortynine/webservicepositionqueue.ex`

**Module name:** `ApiServer.FortyNine.WebServicePositionQueue`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 37 |

**Schema defined:** `"webservicepositionqueue"` (line 7)

Fields: `:RECORDID`, `:datetimequeued`, `:utctimestamp`, `:HARDWAREID`, `:MOBILENAME`, `:driverID`, `:LATITUDE`, `:LONGITUDE`, `:HEADING`, `:SPEED`, `:GPSLOCK`, `:OLD`, `:PING`, `:MOTION`, `:SPEEDING`, `:IGNITION`, `:IGNITIONSTATUS`, `:RSSI`, `:SATS`, `:SENSOR1`, `:SENSOR2`, `:WSUSERNAME`, `:WSPASSWORD`, `:ERROR`, `:ERRORMSG`, `:CONNECTIONNAME`

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Ecto.Schema` | 2 |
| `use` | `Bitwise` | 3 |
| `use` | `Timex` | 4 |
| `import` | `Ecto.Changeset` | 5 |

---

### File 2: `lib/api_server/guardian.ex`

**Module name:** `ApiServer.Guardian`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `subject_for_token` | 2 | 6 |
| `subject_for_token` | 2 | 14 (fallback clause) |
| `resource_from_claims` | 1 | 18 |
| `resource_from_claims` | 1 | 24 (fallback clause) |

**defstruct / defexception / schema:** None

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Guardian, otp_app: :api_server` | 2 |
| `alias` | `ApiServer.Vx` | 4 |

**Guardian runtime configuration (from `config/config.exs` lines 132–136):**

```elixir
config :api_server, ApiServer.Guardian,
  issuer: "rhmapi",
  ttl: {52, :weeks},
  secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

No `allowed_algos` key is explicitly set. Guardian 1.x defaults to `["HS512"]` when no algorithm is specified.

---

### File 3: `lib/api_server/operators/file.ex`

**Module name:** `ApiServer.Operators.File`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 14 |

**Schema defined:** `"files"` (line 6)

Fields: `:custcode`, `:esn`, plus Ecto timestamps.

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Ecto.Schema` | 2 |
| `import` | `Ecto.Changeset` | 3 |

---

## Checklist Review

### §1: Secrets and Configuration

**config/config.exs — Hardcoded secret_key_base (line 15):**

```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh"
```

**config/config.exs — Hardcoded Guardian signing key (line 136):**

```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

**config/prod.secret.exs — Hardcoded production secret_key_base (line 12):**

```elixir
secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```

**config/prod.exs — Hardcoded production database credentials (lines 13–25):**

```elixir
config :api_server, ApiServer.FortyNineRepo,
  username: "svr49_hi_x_user",
  password: "Q973bFtc9z/cVW#mA",
  hostname: "svr49.tracking-intelligence.com",
```

**config/prod.exs — Hardcoded AWS RDS endpoint and credentials (lines 27–37):**

```elixir
config :api_server, ApiServer.Repo,
  username: "vxaurorasyduser",
  password: "TRxbixk9fuZc",
  hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
  port: 3306
```

**config/prod.exs — Hardcoded AWS SES SMTP credentials (lines 39–53):**

```elixir
config :api_server, ApiServer.Mailer,
  username: "[REDACTED-AWS-KEY-ID]",
  password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

Note: a commented-out second AWS IAM access key ID is also present: `[REDACTED-AWS-KEY-ID]`. Even in a comment, a rotated key ID in version control reveals historical credential usage and may be a target for automated secret scanners querying AWS for key status.

**config/prod.secret.exs — Commented-out database credentials (lines 15–22):**

```elixir
#   username: "vxaurorasyduser",
#   password: "TRxbixk9fuZc",
#   hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
```

Same RDS credentials appear here in comment form, confirming they are persisted in VCS history.

**.gitignore — `prod.secret.exs` exclusion is commented out (line 27):**

```
# /config/*.secret.exs
```

The comment explicitly acknowledges the pattern but leaves it disabled. `prod.secret.exs` is therefore tracked by git, meaning all secrets it contains are committed to version control.

**webservicepositionqueue.ex — Schema fields `:WSUSERNAME` and `:WSPASSWORD` (lines 29–30):**

These fields are cast without restriction in the changeset. The schema mirrors columns that appear to hold plaintext web-service credentials. This is a data-model concern, not a code defect by itself, but it is flagged as a data-handling risk.

---

### §2: Authentication and Authorization

**Guardian algorithm not explicitly configured:**

No `allowed_algos` key is present in the Guardian config block. Guardian 1.x defaults to `["HS512"]`, which is an acceptable symmetric algorithm. However, the absence of an explicit declaration means the algorithm is implicitly inherited from library defaults, and a future library upgrade could silently change the accepted set. The `"none"` algorithm is not configured.

**Guardian TTL is 52 weeks (1 year):**

```elixir
ttl: {52, :weeks},
```

A one-year JWT lifetime means a compromised token remains valid for up to 52 weeks with no ability to revoke it (Guardian 1.x has no built-in token revocation unless a `GuardianDb` or custom revocation store is wired in). No refresh policy is visible in the configuration.

**`resource_from_claims/1` trusts the `customer` claim without validation (guardian.ex line 19–21):**

```elixir
def resource_from_claims(claims) do
  id = claims["sub"]
  customer = claims["customer"]
  user = Vx.get_vx_user!(id, customer)
  {:ok, user}
end
```

The `customer` value is extracted directly from the JWT claims and passed to `Vx.get_vx_user!/2` without any allowlist check or cross-reference against the authenticated user's own customer record. If the JWT signing key is compromised, or if a token is issued with an attacker-controlled `customer` claim, the lookup can return users belonging to a different customer organisation. This is a cross-tenant IDOR vector.

---

### §3: Input Validation and Injection

**webservicepositionqueue.ex — No injection issues found.** The changeset uses `cast/3` with an explicit field list and `validate_required/2`. No raw SQL fragments or unsafe atom creation observed.

**operators/file.ex — No injection issues found.** The changeset uses `cast/3` and `validate_required/2`. No raw SQL or unsafe operations observed.

**guardian.ex — No direct injection issues in module code.** The `Vx.get_vx_user!/2` call is where the risk materialises (see §2 note above); the guardian module itself does not do raw SQL.

§3: No additional issues found beyond the cross-tenant concern noted in §2.

---

### §4: Session and CSRF

Not directly applicable to the three assigned files (schema modules and guardian callback module). No session, cookie, or CSRF configuration is present in these files.

§4: No issues found in assigned files.

---

### §5: File and Data Handling

**webservicepositionqueue.ex — GPS and driver PII in schema:**

The schema includes `:LATITUDE`, `:LONGITUDE`, `:HARDWAREID`, `:MOBILENAME`, `:driverID`, `:SPEED`, `:HEADING`, and `:IGNITION`. These are fleet vehicle tracking fields. The module itself does not log or expose this data, but consumers of this schema must be confirmed to scope data access per customer organisation. This is an advisory note for downstream review.

**webservicepositionqueue.ex — `:WSPASSWORD` field in position-queue schema:**

The `[REDACTED-AWS-SMTP-PASSWORD]` table stores plaintext web-service credentials (`:WSUSERNAME`, `:WSPASSWORD`) alongside GPS position records. Storing credentials in a queue table alongside telemetry data widens the blast radius of any database breach; those credentials are not isolated to a secrets store.

§5: No stack-trace disclosure or path traversal issues found in assigned files. The schema-level concerns above are flagged as findings.

---

### §6: Dependencies

Guardian is pinned in `mix.exs` as `{:guardian, "~> 1.0"}` and resolves to `1.2.1` in `mix.lock`. Guardian 1.2.1 is the final release of the 1.x series; the project has since moved to 2.x with breaking changes. No published CVEs against guardian 1.2.1 are on record, but the library is effectively unmaintained at this version.

§6: No critical dependency vulnerabilities identified in guardian 1.2.1. The version is outdated; flagged as LOW.

---

### §7: Infrastructure Exposure

**config/prod.exs — Hardcoded AWS RDS hostname (line 36):**

```
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com"
```

The RDS cluster identifier and AWS region (`ap-southeast-2`) are embedded in a tracked config file. This exposes infrastructure topology.

**config/prod.exs — Hardcoded external database hostname (line 17):**

```
hostname: "svr49.tracking-intelligence.com"
```

An external third-party service hostname is committed in plaintext.

**config/prod.exs — AWS SES endpoint reveals region (line 41):**

```
server: "email-smtp.us-west-2.amazonaws.com"
```

AWS region `us-west-2` for the SES endpoint is hardcoded.

§7: CORS and TLS configuration are not present in the three assigned files; those are assessed elsewhere.

---

## Findings

---

### A056-1 — CRITICAL: Guardian JWT signing key hardcoded in tracked config file

**File:** `config/config.exs` line 136
**Section:** §1 Secrets and Configuration / §2 Authentication and Authorization

```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The HMAC-SHA signing key used to sign and verify all JWTs is committed in plaintext to the repository. Any party with read access to the repository can forge arbitrary JWTs, bypass authentication entirely, and impersonate any user including administrators. This key must be treated as fully compromised, rotated immediately, and replaced with a reference to a runtime environment variable or secrets manager value (e.g., `System.fetch_env!("GUARDIAN_SECRET_KEY")`).

---

### A056-2 — CRITICAL: Production database credentials hardcoded in tracked config file

**File:** `config/prod.exs` lines 13–25 and lines 27–37
**Section:** §1 Secrets and Configuration

Two separate database credentials are committed in plaintext:

1. FortyNine repo — `username: "svr49_hi_x_user"`, `password: "Q973bFtc9z/cVW#mA"`, host `svr49.tracking-intelligence.com`
2. Main repo (AWS RDS) — `username: "vxaurorasyduser"`, `password: "TRxbixk9fuZc"`, host `vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com`

Both `prod.exs` and `prod.secret.exs` are committed to version control (the `.gitignore` exclusion for `*.secret.exs` is commented out — see A056-5). All credentials must be rotated immediately and replaced with environment variable references.

---

### A056-3 — CRITICAL: AWS SES SMTP credentials (IAM access key + secret) hardcoded in tracked config file

**File:** `config/prod.exs` lines 44–48
**Section:** §1 Secrets and Configuration

```elixir
username: "[REDACTED-AWS-KEY-ID]",
password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

An AWS IAM access key ID and secret access key for SES SMTP are committed in plaintext. These credentials can be used to send email as the account and may carry broader IAM permissions. They must be treated as compromised, revoked immediately in IAM, and replaced with environment variable references. A second (now-commented) key ID `[REDACTED-AWS-KEY-ID]` is also present, indicating at least one prior rotation that did not remove the old value from VCS history.

---

### A056-4 — CRITICAL: `prod.secret.exs` committed to version control — secret_key_base exposed

**File:** `config/prod.secret.exs` line 12; `.gitignore` line 27
**Section:** §1 Secrets and Configuration

```
# /config/*.secret.exs     ← exclusion is commented out in .gitignore
```

```elixir
secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```

The Phoenix `secret_key_base` used for session cookie signing and encryption is committed to VCS. An attacker with repository access can forge session cookies. The `.gitignore` comment explicitly notes the file should be excluded but the exclusion line is disabled. The file must be removed from tracking (`git rm --cached`), the exclusion re-enabled, and the `secret_key_base` rotated.

---

### A056-5 — HIGH: `.gitignore` excludion for `*.secret.exs` is commented out

**File:** `.gitignore` line 27
**Section:** §1 Secrets and Configuration

```
# /config/*.secret.exs
```

The inline comment in `.gitignore` acknowledges the pattern's purpose but the line is disabled. This is the root-cause configuration error that allowed `prod.secret.exs` (and any future `*.secret.exs` file) to be committed. The line must be uncommented.

---

### A056-6 — HIGH: Guardian JWT TTL is 52 weeks with no visible revocation mechanism

**File:** `config/config.exs` lines 133–136
**Section:** §2 Authentication and Authorization

```elixir
ttl: {52, :weeks},
```

A one-year token lifetime means a stolen JWT remains valid for up to 52 weeks. Guardian 1.x does not include built-in server-side revocation; without a token store (e.g., GuardianDb), there is no way to invalidate tokens on logout, password change, or account suspension. The TTL should be reduced to a short-lived access token (e.g., 15 minutes to 1 hour) combined with a refresh token strategy, or a revocation store must be implemented.

---

### A056-7 — HIGH: Cross-tenant IDOR — `customer` claim used without validation in `resource_from_claims/1`

**File:** `lib/api_server/guardian.ex` lines 18–23
**Section:** §2 Authentication and Authorization

```elixir
def resource_from_claims(claims) do
  id = claims["sub"]
  customer = claims["customer"]
  user = Vx.get_vx_user!(id, customer)
  {:ok, user}
end
```

The `customer` value is taken directly from the JWT claims and used as a lookup parameter without validation against any authoritative record. If the signing key is known (see A056-1, which confirms it is committed to VCS), an attacker can craft a JWT with an arbitrary `customer` claim and load any user from any customer organisation. Even absent key compromise, if the claim can be manipulated through any other path, this becomes a cross-tenant data access vulnerability. The `customer` claim must be independently validated — for example, by verifying it matches the customer associated with the `sub` user in the database, rather than being accepted from the token at face value.

---

### A056-8 — HIGH: Guardian signing algorithm not explicitly configured — defaults silently

**File:** `config/config.exs` lines 133–136
**Section:** §2 Authentication and Authorization

No `allowed_algos` key is set in the Guardian configuration. Guardian 1.x defaults to `["HS512"]`. While `"none"` is not the default and is not configured, the lack of an explicit declaration means the accepted algorithm set is determined solely by library defaults. A future upgrade or misconfiguration could silently admit weaker or unintended algorithms. Best practice is to explicitly declare:

```elixir
allowed_algos: ["HS512"],
```

---

### A056-9 — HIGH: Hardcoded `secret_key_base` in `config/config.exs`

**File:** `config/config.exs` line 15
**Section:** §1 Secrets and Configuration

```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh"
```

A `secret_key_base` is hardcoded in the base config file. Even if this is intended as a development default, the value is committed to VCS. If production configuration fails to override it (e.g., during a misconfigured deployment), session cookies and signed URLs will be signed with a publicly known key. This value must be replaced with a fallback that fails loudly if no environment variable is set.

---

### A056-10 — MEDIUM: Plaintext web-service credentials stored in position-queue schema

**File:** `lib/api_server/fortynine/webservicepositionqueue.ex` lines 29–30
**Section:** §5 File and Data Handling

```elixir
field :WSUSERNAME, :string
field :WSPASSWORD, :string
```

The `[REDACTED-AWS-SMTP-PASSWORD]` schema persists web-service credentials (`:WSUSERNAME`, `:WSPASSWORD`) in the same table as GPS telemetry records. Storing credentials in an operational queue table alongside vehicle location data means any database query or ORM access to position records also exposes credentials. Credentials should be stored separately in a dedicated secrets store, with the queue referencing a credential identifier rather than the raw values.

---

### A056-11 — MEDIUM: AWS RDS hostname and region exposed in tracked config file

**File:** `config/prod.exs` line 36
**Section:** §7 Infrastructure Exposure

```
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com"
```

The full RDS cluster DNS name exposes the AWS account's RDS cluster identifier, the region (`ap-southeast-2`), and the environment context ("sandbox"). This should be moved to an environment variable.

---

### A056-12 — MEDIUM: Commented-out IAM access key ID persisted in VCS history

**File:** `config/prod.exs` lines 43, 55–57
**Section:** §1 Secrets and Configuration

```elixir
# username: "[REDACTED-AWS-KEY-ID]", # Existing username
```

A rotated (but not necessarily disabled) AWS IAM access key ID remains in a code comment. Automated secret scanners that index public or leaked repositories will flag this as an active credential. The key ID should be verified as fully revoked in AWS IAM and the comment should be removed. VCS history containing the key should be assessed for scrubbing.

---

### A056-13 — LOW: Guardian 1.x is end-of-life; no security support

**File:** `mix.exs` line 54; `mix.lock` line 31
**Section:** §6 Dependencies

```elixir
{:guardian, "~> 1.0"}   # resolves to 1.2.1
```

Guardian 1.2.1 is the last release of the 1.x series. The library has moved to 2.x, which includes breaking API changes and ongoing maintenance. Guardian 1.x receives no security patches. The project should plan an upgrade to Guardian 2.x.

---

### A056-14 — LOW: No `allowed_algos` in Guardian config — "none" algorithm not explicitly rejected

**File:** `config/config.exs` lines 133–136
**Section:** §2 Authentication and Authorization

Checklist item explicitly requires confirming the signing algorithm is not `"none"`. Guardian 1.x does not default to `"none"` and JOSE (the underlying library) will reject unsigned tokens in normal usage. However, the absence of an explicit `allowed_algos` list means there is no defence-in-depth configuration preventing algorithm confusion. Explicitly setting `allowed_algos: ["HS512"]` satisfies the checklist requirement and adds a configuration-level control.

---

### A056-15 — INFO: GPS, driver, and vehicle telemetry fields in webservicepositionqueue schema

**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Section:** §5 File and Data Handling

The schema contains sensitive fleet-management PII including `:LATITUDE`, `:LONGITUDE`, `:MOBILENAME`, `:driverID`, `:SPEED`, and `:HEADING`. Any code paths that query, log, or return rows from this schema should be reviewed in subsequent passes to confirm data is scoped per customer organisation and not disclosed in logs or error responses.

---

## Summary Table

| ID | Severity | File | Issue |
|----|----------|------|-------|
| A056-1 | CRITICAL | config/config.exs:136 | Guardian JWT signing key hardcoded in VCS |
| A056-2 | CRITICAL | config/prod.exs:13–37 | Production database credentials hardcoded in VCS |
| A056-3 | CRITICAL | config/prod.exs:44–48 | AWS SES IAM access key + secret hardcoded in VCS |
| A056-4 | CRITICAL | config/prod.secret.exs:12 / .gitignore:27 | `prod.secret.exs` committed — secret_key_base exposed |
| A056-5 | HIGH | .gitignore:27 | `*.secret.exs` git-exclusion rule is commented out |
| A056-6 | HIGH | config/config.exs:135 | JWT TTL 52 weeks with no revocation mechanism |
| A056-7 | HIGH | lib/api_server/guardian.ex:18–23 | `customer` claim trusted from JWT without validation — cross-tenant IDOR |
| A056-8 | HIGH | config/config.exs:133–136 | Guardian signing algorithm not explicitly declared |
| A056-9 | HIGH | config/config.exs:15 | `secret_key_base` hardcoded in base config |
| A056-10 | MEDIUM | lib/api_server/fortynine/webservicepositionqueue.ex:29–30 | Plaintext web-service credentials in telemetry queue schema |
| A056-11 | MEDIUM | config/prod.exs:36 | AWS RDS hostname and region hardcoded in tracked config |
| A056-12 | MEDIUM | config/prod.exs:43 | Rotated IAM key ID persisted in comment in VCS |
| A056-13 | LOW | mix.exs:54 | Guardian 1.x is end-of-life |
| A056-14 | LOW | config/config.exs:133–136 | `allowed_algos` not explicitly configured |
| A056-15 | INFO | lib/api_server/fortynine/webservicepositionqueue.ex | GPS/driver PII in schema — downstream data-scoping review needed |

<!-- A059.md -->
# Pass 1 Security Audit — A059
**Agent:** A059
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Run:** 2026-02-27-01
**Auditor:** Claude Sonnet 4.6

---

## Assigned Files

1. `lib/api_server/operators/operators.ex`
2. `lib/api_server/repo.ex`
3. `lib/api_server/tcp/tcp.ex`

Supporting context files read (not assigned but referenced or required for full analysis):
- `lib/api_server/operators/file.ex`
- `lib/api_server/tcp/tcp_commands.ex`
- `config/config.exs`
- `config/dev.exs`
- `config/prod.exs`
- `config/prod.secret.exs`
- `.gitignore`

---

## Reading Evidence

---

### File 1: `lib/api_server/operators/operators.ex`

**Module name:** `ApiServer.Operators`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `list_files` | 0 | 19 |
| `get_file!` | 1 | 37 |
| `create_file` | 1 | 51 |
| `update_file` | 2 | 69 |
| `delete_file` | 1 | 87 |
| `change_file` | 1 | 100 |

**defstruct / defexception / schema defined:** None (this is a context module; the schema is in `ApiServer.Operators.File`)

**use / import / alias at module level:**
- `import Ecto.Query, warn: false` (line 5)
- `alias ApiServer.Repo` (line 7)
- `alias ApiServer.Operators.File` (line 8)

---

### File 2: `lib/api_server/repo.ex`

**Module names:** `ApiServer.Repo` and `ApiServer.FortyNineRepo` (both defined in this file)

**Public functions (def):**

| Module | Name | Arity | Line |
|---|---|---|---|
| `ApiServer.Repo` | `init` | 2 | 8 |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**
- `ApiServer.Repo`: `use Ecto.Repo, otp_app: :api_server` (line 2)
- `ApiServer.FortyNineRepo`: `use Ecto.Repo, otp_app: :api_server` (line 14)

---

### File 3: `lib/api_server/tcp/tcp.ex`

**Module name:** `ApiServer.TCP`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `accept` | 1 | 23 |

**Private functions (defp) — listed for completeness:**
- `loop_acceptor/1` (line 32)
- `serve/2` (line 48)
- `read_line/3` (line 90)
- `write_line/2` (line 135, 139, 143, 147 — multiple clauses)

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**
- `import Ecto.Query, warn: false` (line 7)
- `alias ApiServer.Repo` (line 8)
- `alias ApiServer.Vx.VXUser` (line 9)
- `alias ApiServer.Vx.VXThingEvent` (line 10)
- `alias ApiServer.Vx.VXThingEventOmega` (line 11)
- `alias ApiServer.Vx.VXThingEventOmegaTires` (line 12)
- `alias ApiServer.Vx.VXFleetAssociation` (line 13)
- `alias ApiServer.Vx.VXRestriction` (line 14)
- `alias ApiServer.Vx.Geofence` (line 15)
- `alias ApiServer.Vx.VXThing` (line 16)
- `alias ApiServer.Vx.VXAblRecord` (line 17)
- `alias ApiServer.Vx.VXRayvenMessageLog` (line 18)
- `require Logger` (line 21)

---

## Checklist Review

---

### §1: Secrets and Configuration

**Finding A059-1 — CRITICAL: AWS SES SMTP credentials hardcoded in tracked config files**

`config/config.exs` lines 117–120 and identically in `config/dev.exs` lines 98–101 and `config/prod.exs` lines 45–48:

```elixir
username: "[REDACTED-AWS-KEY-ID]",
password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

These are plaintext AWS IAM access key ID and SMTP password for the SES service. They appear identically in three separate tracked config files (`config.exs`, `dev.exs`, `prod.exs`). All three files are committed to version control. The AWS access key `[REDACTED-AWS-KEY-ID]` follows the AWS IAM key format and must be treated as a live, compromised credential. Additionally, commented-out credentials for a previous key (`[REDACTED-AWS-KEY-ID]` / `[REDACTED-AWS-SMTP-PASSWORD]`) also appear in all three files, suggesting a prior rotation that did not remove the old values from source.

---

**Finding A059-2 — CRITICAL: Phoenix secret_key_base hardcoded in tracked config files**

`config/config.exs` line 15:
```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh",
```

`config/prod.secret.exs` line 12:
```elixir
secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN",
```

The `secret_key_base` is used by Phoenix to sign session cookies and other cryptographic tokens. Two different values are tracked in source — one in `config.exs` (the base/dev default) and a different one in `prod.secret.exs`. Despite the file being named `prod.secret.exs`, the `.gitignore` contains the line `# /config/*.secret.exs` (commented out), meaning the exclusion rule is disabled. `prod.secret.exs` is being committed to version control. Any attacker with repository read access can forge session cookies for the production instance.

---

**Finding A059-3 — CRITICAL: Guardian JWT secret_key hardcoded in tracked config**

`config/config.exs` lines 133–136:
```elixir
config :api_server, ApiServer.Guardian,
  issuer: "rhmapi",
  ttl: {52, :weeks},
  secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The Guardian HMAC signing secret is hardcoded in a tracked file. Any party with repository access can forge valid JWT authentication tokens for any user. The `ttl` of 52 weeks (1 year) compounds the risk — tokens issued with this key are valid for a full year, and since the key is public, offline token forgery is trivial.

---

**Finding A059-4 — CRITICAL: Database credentials hardcoded in tracked config files**

Multiple databases have credentials embedded in tracked files:

`config/prod.exs` lines 14–18 (`ApiServer.FortyNineRepo`, external MySQL host):
```elixir
username: "svr49_hi_x_user",
password: "Q973bFtc9z/cVW#mA",
hostname: "svr49.tracking-intelligence.com",
```

`config/prod.exs` lines 33–36 (`ApiServer.Repo`, AWS RDS Aurora):
```elixir
username: "vxaurorasyduser",
password: "TRxbixk9fuZc",
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
port: 3306
```

`config/dev.exs` repeats the same credentials for both repos (lines 60–88).

These credentials are in tracked files. The Aurora RDS endpoint `vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com` reveals the AWS cluster identifier and region (`ap-southeast-2`), directly exposing infrastructure topology. The external `svr49.tracking-intelligence.com` hostname exposes a third-party partner's server identity. Note: `ApiServer.Repo.init/2` (in `repo.ex` line 9) does correctly load the primary repo URL from `DATABASE_URL` at runtime — however this is overridden by the static config in `prod.exs` and `dev.exs` which set all connection fields explicitly, meaning the `init/2` runtime override may not take effect when the adapter, database, username, password, and hostname keys are already set by the environment-specific config.

---

**Finding A059-5 — HIGH: Third-party service password hardcoded in tcp_commands.ex**

`lib/api_server/tcp/tcp_commands.ex` lines 1221 and 1306 (and again at lines 1891–1892):
```elixir
WSUSERNAME: "trility",
WSPASSWORD: "@trility!",
```

These are hardcoded credentials written into every `[REDACTED-AWS-SMTP-PASSWORD]` record inserted into the FortyNine database. This is a plaintext credential embedded in application source code for a downstream web service integration. The password appears three times in the file across different code paths.

---

**Finding A059-6 — MEDIUM: .gitignore does not exclude prod.secret.exs**

`.gitignore` line 27:
```
# /config/*.secret.exs
```

The line that would exclude secret config files is commented out. The Phoenix project generator adds this exclusion by default; it has been manually disabled here. As a result, `prod.secret.exs` is tracked and committed (confirmed above in Finding A059-2). The comment on line 21–26 of the `.gitignore` acknowledges this is a secret file and documents the risk, making this a deliberate decision rather than an oversight — but the outcome is the same: production secrets are in version control.

---

**Finding A059-7 — MEDIUM: Geonames username hardcoded in config.exs**

`config/config.exs` lines 138–140:
```elixir
config :geonames,
  username: "vinxstudio",
  language: "en"
```

A Geonames API service username is hardcoded in a tracked config file. While Geonames accounts have limited blast radius compared to AWS credentials, this still constitutes a hardcoded third-party service credential in version control.

---

**Finding A059-8 — INFO: Commented-out AWS EC2 hostname in prod.exs**

`config/prod.exs` line 22 (commented):
```elixir
# hostname: "ec2-13-210-120-188.ap-southeast-2.compute.amazonaws.com",
```

A public EC2 IP address (13.210.120.188) in the ap-southeast-2 region is present in a comment. While commented out, this reveals a historical infrastructure endpoint that may still be live or may assist in mapping the network topology.

---

### §2: Authentication and Authorization

**Finding A059-9 — HIGH: Guardian TTL is 52 weeks (1 year)**

`config/config.exs` line 135:
```elixir
ttl: {52, :weeks},
```

JWT tokens issued by Guardian have a one-year validity window. Combined with the hardcoded secret key (A059-3), any issued token cannot be revoked short of rotating the signing key (which would invalidate all active tokens). Even without A059-3, a one-year TTL is excessive for an API serving fleet management and vehicle location data. There is no evidence of a refresh token policy or token revocation mechanism in the assigned files.

**Note regarding assigned files:** `operators.ex` and `repo.ex` are context/data-access modules, not controllers or routers. Authorization checks at the context layer (i.e., whether `list_files/0` and `get_file!` are scoped to an authenticated user's organisation) cannot be evaluated from these files alone; this must be reviewed at the controller/router level. The `ApiServer.Operators` module has no organisation-scoping in any of its functions — `list_files/0` returns all records from the `files` table globally, and `get_file!/1` takes a bare ID with no ownership check. Whether this is protected at the controller layer is outside the assigned scope.

---

### §3: Input Validation and Injection

**Finding A059-10 — HIGH: Binary pattern matching in TCP parser performs no length bounds checking before slice**

`lib/api_server/tcp/tcp_commands.ex` line 92 (within `parse_data_message/3`):
```elixir
<<record::bytes-size(record_length), next_remainder::binary>> = remainder
```

`record_length` is decoded from the device-supplied binary payload (line 42). A device (or attacker) sending a crafted packet with a `record_length` value larger than the actual remaining binary will cause a `MatchError` (pattern match failure), crashing the serving `Task`. This is a denial-of-service vector against any TCP-connected device session. The same pattern repeats in `parse_data_record/3` (line 183), `parse_debug_record/3` (line 143), and field-level length parsing throughout `parse_data_record`. There is no guard ensuring `record_length <= byte_size(remainder)` before the destructuring match.

Similarly, `parse_analog32_field/1` (line 1523) does:
```elixir
[final_input1, final_input2, final_input3] = [
  Enum.at(analog_values, 0),
  Enum.at(analog_values, 1),
  Enum.at(analog_values, 2)
]
```
If the analog payload contains fewer than 3 values, `Enum.at` returns `nil` and the match succeeds, but downstream arithmetic on `nil` values will raise `ArithmeticError`. In `parse_driverid_field/1` (line 1597), `driverid_size_byte` is derived entirely from device-supplied data with no upper-bound validation.

---

**Finding A059-11 — MEDIUM: TCP server has no authentication or device verification before processing data records**

`lib/api_server/tcp/tcp.ex` — the `serve/2` / `read_line/3` / `loop_acceptor/1` chain accepts any TCP connection on the configured port and immediately begins processing binary frames. There is no IP allowlist, no TLS (the socket is opened with `:binary` and no SSL options at line 25), no pre-authentication challenge, and no rate limiting. The only device validation is in `parse_hello_message/1` (tcp_commands.ex line 20), which calls `device_lookup_with_hardware_id/1` — but if the device is not found, the error path returns `{:error, {:error, "error", %{}}}` and the `serve/2` function continues listening on the same socket (the error from `parse_hello_message` is passed back as the result of `Commands.parse`, then `Commands.run` is called on the error tuple). A device that fails the hello check is not disconnected. Data record frames (`<<4>>`) are processed without requiring a prior successful hello. Any host on the network that can reach the TCP port can inject telemetry records.

---

### §4: Session and CSRF

**§4: No issues found in the assigned files.** The assigned files (`operators.ex`, `repo.ex`, `tcp.ex`) do not implement session management or CSRF logic. The TCP server is a binary protocol handler unrelated to CSRF. Session configuration must be evaluated in the endpoint/router/plug pipeline, which is outside the assigned scope.

---

### §5: File and Data Handling

**Finding A059-12 — HIGH: Driver ID data (PII) logged to stdout via IO.puts in tcp_commands.ex**

`lib/api_server/tcp/tcp_commands.ex` lines 1666–1668:
```elixir
IO.puts(
  "driverid info parsed: type: #{driverid_type} data: #{driverid_data_encoded} final payload: #{inspect(driverid_parsed)}"
)
```

Every driver ID parsed from a device packet — including iButton codes (type 2, Base16-encoded 6-byte hardware ID) and Wiegand RFID card numbers (type 7) — is unconditionally written to standard output via `IO.puts`. This is PII (driver identification data) being written to process stdout on every single telemetry event that contains a driver ID. `IO.puts` output goes to the OS process stdout and is not controlled by the application's Logger level configuration. It cannot be silenced without code changes.

---

**Finding A059-13 — MEDIUM: Hardcoded customer code "TRILITY" and hardcoded hardware_id in parse_iridium**

`lib/api_server/tcp/tcp_commands.ex` lines 1756 and 1810:
```elixir
hardware_id = 462_743
customer = "vx_trility"
```

The `parse_iridium/2` function hardcodes both the target customer schema (`vx_trility`) and the hardware device ID (`462_743`). All Iridium-protocol messages are routed to a single customer, regardless of any device-to-customer mapping. This is a data isolation defect: if the TCP server ever receives Iridium traffic from a device that is not serial 462743 (or belongs to a different customer), the data is silently misattributed to the `vx_trility` customer schema. This is a cross-customer data boundary violation for fleet management data (checklist §5, fleet data must be scoped to the authenticated user's organisation).

---

**Finding A059-14 — INFO: IO.puts debug logging of device serial numbers and sensor data throughout tcp_commands.ex**

Multiple `IO.puts` calls throughout `tcp_commands.ex` log GPS coordinates, analog sensor values, and device serial numbers to stdout, gated only on membership in a hardcoded list of test serial numbers (e.g., `625_425`, the "yabby3" list at lines 780–821). These appear to be development debug statements. GPS coordinates and serial numbers constitute fleet tracking data that should not appear in plaintext in process logs outside of a controlled logging framework.

---

### §6: Dependencies

**§6: Cannot be fully evaluated from the assigned source files.** `mix.exs` and `mix.lock` are outside the assigned scope for this agent. However, the use of `Ecto.Adapters.MySQL` (not `MyXQL`, the modern replacement) in both repo configurations (`prod.exs`, `dev.exs`) is noted. The deprecated `Mariaex` adapter may be in use — this must be confirmed by a pass that reviews `mix.exs`/`mix.lock`.

---

### §7: Infrastructure Exposure

**Finding A059-15 — HIGH: AWS RDS Aurora cluster endpoint and region hardcoded in tracked config**

`config/prod.exs` line 36:
```elixir
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
```

The full RDS cluster endpoint is committed to version control. This reveals: the cluster identifier (`vxsandboxsydneytest-cluster-1`), the Aurora cluster DNS suffix (`cluster-c4fwadrw9quy`), and the AWS region (`ap-southeast-2`). Combined with the hardcoded credentials in A059-4, this gives a complete connection string for direct database access.

---

**Finding A059-16 — HIGH: TCP server has no TLS — device telemetry is transmitted in plaintext**

`lib/api_server/tcp/tcp.ex` line 25:
```elixir
:gen_tcp.listen(port, [:binary, reuseaddr: true, active: false])
```

The TCP listener uses plain `:gen_tcp` with no SSL options. Vehicle telemetry data including GPS coordinates, driver IDs, speed, and ignition state are transmitted over the network in plaintext binary frames. An on-path attacker can read all device data or inject crafted packets. For a fleet management system processing vehicle location data, the absence of transport security is a significant exposure.

---

**Finding A059-17 — MEDIUM: External MySQL hostname for third-party integration exposed in tracked config**

`config/prod.exs` line 17 (and `dev.exs` line 65):
```elixir
hostname: "svr49.tracking-intelligence.com",
```

The hostname of an external partner system (`svr49.tracking-intelligence.com`) is hardcoded in tracked config files alongside valid credentials (A059-4). This reveals the partner organisation's server infrastructure and provides a complete attack vector against that system.

---

**Finding A059-18 — INFO: Unused aliases in tcp.ex**

`lib/api_server/tcp/tcp.ex` lines 9–18 contain 10 aliases (`VXUser`, `VXThingEvent`, `VXThingEventOmega`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXFleetAssociation`, `VXRestriction`, `Geofence`, `VXThing`, `VXAblRecord`, `VXRayvenMessageLog`) and an `import Ecto.Query`. A comment at line 6 acknowledges these need cleaning up ("Clean these up after we know which ones we use"). None of these aliases appear to be referenced in `tcp.ex` itself (all database work is delegated to `tcp_commands.ex`). This is dead code that should be removed to reduce the attack surface understanding, but does not introduce a direct vulnerability.

---

## Summary of Findings

| ID | Severity | Location | Summary |
|---|---|---|---|
| A059-1 | CRITICAL | `config/config.exs`, `dev.exs`, `prod.exs` | AWS SES SMTP credentials (IAM key + password) hardcoded in three tracked files |
| A059-2 | CRITICAL | `config/config.exs`, `prod.secret.exs` | Phoenix `secret_key_base` hardcoded in tracked files; `.gitignore` exclusion is commented out |
| A059-3 | CRITICAL | `config/config.exs` | Guardian JWT signing secret hardcoded in tracked file; 52-week token TTL |
| A059-4 | CRITICAL | `config/prod.exs`, `config/dev.exs` | Database credentials for Aurora RDS and external MySQL hardcoded in tracked files |
| A059-5 | HIGH | `lib/api_server/tcp/tcp_commands.ex` | Plaintext third-party web service password hardcoded and written to database |
| A059-6 | MEDIUM | `.gitignore` | `prod.secret.exs` exclusion rule commented out; file is tracked |
| A059-7 | MEDIUM | `config/config.exs` | Geonames API username hardcoded |
| A059-8 | INFO | `config/prod.exs` | Historical AWS EC2 IP address in comment |
| A059-9 | HIGH | `config/config.exs` | Guardian JWT TTL of 52 weeks is excessive for a fleet data API |
| A059-10 | HIGH | `lib/api_server/tcp/tcp_commands.ex` | No bounds validation before binary slice from device-supplied length field; DoS via crafted packet |
| A059-11 | MEDIUM | `lib/api_server/tcp/tcp.ex` | TCP server accepts all connections with no TLS, no authentication, no rate limiting |
| A059-12 | HIGH | `lib/api_server/tcp/tcp_commands.ex` | Driver ID (PII) unconditionally logged to stdout via `IO.puts` on every telemetry event |
| A059-13 | MEDIUM | `lib/api_server/tcp/tcp_commands.ex` | Hardcoded hardware_id and customer code in `parse_iridium/2`; data isolation violation |
| A059-14 | INFO | `lib/api_server/tcp/tcp_commands.ex` | Debug `IO.puts` statements log GPS/sensor data to stdout for specific serial numbers |
| A059-15 | HIGH | `config/prod.exs` | Full RDS Aurora cluster endpoint (with region) committed to version control |
| A059-16 | HIGH | `lib/api_server/tcp/tcp.ex` | TCP server uses no TLS; vehicle telemetry transmitted in plaintext |
| A059-17 | MEDIUM | `config/prod.exs`, `config/dev.exs` | External partner hostname exposed in tracked config alongside credentials |
| A059-18 | INFO | `lib/api_server/tcp/tcp.ex` | Ten unused module aliases acknowledged as dead code |

<!-- A062.md -->
# Audit Report A062
**Agent:** A062
**Run:** 2026-02-27-01
**Stack:** Elixir/Phoenix — api_server
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server/tcp/tcp_commands.ex`
2. `lib/api_server/vx/device_database_lookup.ex`
3. `lib/api_server/vx/email.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server/tcp/tcp_commands.ex`

**Module name:** `ApiServer.TCP.Commands`

**`use` / `import` / `alias` at module level:**
- `import Ecto.Query, warn: false` (line 2)
- `alias ApiServer.FortyNineRepo` (line 3)
- `alias ApiServer.FortyNine.CalampPositionEvents` (line 4)
- `alias ApiServer.FortyNine.WebServicePositionQueue` (line 5)
- `alias ApiServer.Vx.DeviceDatabaseLookup` (line 6)
- `alias ApiServerWeb.UtilityController` (line 7)

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `parse_hello_message` | 1 | 9 |
| `parse_data_message` | 3 | 35 |
| `parse_debug_record` | 3 | 120 |
| `parse_data_record` | 3 | 158 |
| `parse_debug_field` | 1 | 1325 |
| `parse_gps_field` | 1 | 1331 |
| `parse_digital_field` | 1 | 1385 |
| `parse_analog_field` | 1 | 1454 |
| `parse_analog32_field` | 1 | 1470 |
| `parse_trip_field` | 1 | 1541 |
| `parse_total_field` | 1 | 1556 |
| `parse_driverid_field` | 1 | 1571 |
| `parse_commit_message` | 2 | 1673 |
| `parse_iridium` | 2 | 1679 |
| `parse` | 2 | 1903 |
| `run` | 1 (header) | 1959 |
| `run` (hello clause) | 1 | 1961 |
| `run` (commit clause) | 1 | 1966 |
| `run` (data clause) | 1 | 1976 |
| `run` (close clause) | 1 | 1982 |

**`defstruct` / `defexception` / `schema`:** None defined in this file.

---

### File 2: `lib/api_server/vx/device_database_lookup.ex`

**Module name:** `ApiServer.Vx.DeviceDatabaseLookup`

**`use` / `import` / `alias` at module level:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 13 |

**Schema defined:**
```
schema "DeviceDatabaseLookup" do
    field :hardwareid, :string, source: :hardwareID
    field :customer, :string, source: :databaseName
    field :custcode, :string, source: :CustCode
    field :iccid, :string, source: :ICCID
end
```
Primary key: `@primary_key {:ID, :id, autogenerate: true}` (line 5)

**`defstruct` / `defexception`:** None.

---

### File 3: `lib/api_server/vx/email.ex`

**Module name:** `ApiServer.Email`

**`use` / `import` / `alias` at module level:**
- `use Bamboo.Phoenix, view: ApiServer.EmailView` (line 2)

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `send_notification_email` | 3 | 4 |
| `send_test_email` | 3 | 14 |
| `send_enter_email` | 4 | 103 |
| `send_missing_serial_email` | 4 | 167 |
| `send_digital_matter_email` | 4 | 215 |
| `send_slow_email` | 4 | 262 |
| `send_exit_email` | 4 | 303 |

**`defstruct` / `defexception` / `schema`:** None.

---

## Checklist Review

---

### §1: Secrets and Configuration

**FINDING A062-1 — CRITICAL: Hardcoded third-party service password in source code**

File: `lib/api_server/tcp/tcp_commands.ex`, lines 1221–1222 and 1305–1306 (also 1891–1892 in `parse_iridium`)

The password `@trility!` for the downstream web service (`WSUSERNAME: "trility"`) is hardcoded directly in the source in three locations — once in `parse_data_record` (for integer serial match, line ~1221), once for string serial match (line ~1306), and once in `parse_iridium` (line ~1891):

```elixir
WSUSERNAME: "trility",
WSPASSWORD: "@trility!",
CONNECTIONNAME: "SVR49"
```

This credential is stored in the `[REDACTED-AWS-SMTP-PASSWORD]` table (field `WSPASSWORD`) and is written to the `FortyNineRepo` database, meaning it persists in plaintext in database rows. The password is also visible in version control history on any branch where this code was committed.

**FINDING A062-2 — MEDIUM: Hardcoded internal service username in source code**

Same locations as A062-1. `WSUSERNAME: "trility"` and `MOBILENAME: "1234"` are hardcoded credentials passed to the downstream FortyNine service. While the risk is lower than A062-1 (username alone without password), these values reveal service account names and should be read from application configuration, not compiled into the binary.

**FINDING A062-3 — MEDIUM: Hardcoded customer code and service endpoint identifier in source code**

File: `lib/api_server/tcp/tcp_commands.ex`, lines 1787 and 1810 (in `parse_iridium`)

```elixir
custcode: "TRILITY",
...
customer = "vx_trility"
```

The Iridium parser hardcodes the customer code and database name `"vx_trility"` rather than deriving them from the device lookup. This means all Iridium-origin data is unconditionally attributed to a single hardcoded customer, bypassing the device lookup that the rest of the codebase uses. If this string were ever rotated or if the mapping changes, the code would silently misdirect data.

**FINDING A062-4 — LOW: Hardcoded hardware ID in `parse_iridium`**

File: `lib/api_server/tcp/tcp_commands.ex`, line 1756:

```elixir
hardware_id = 462_743
```

The Iridium parser ignores the device-identity data carried in the parsed Iridium message and instead unconditionally assigns a single hardcoded serial number. This is a logic defect with a security dimension: all Iridium satellite messages are attributed to device 462743 regardless of which device actually sent them.

---

### §2: Authentication and Authorization

**FINDING A062-5 — HIGH: No authentication on TCP device connection; device identity accepted without verification**

File: `lib/api_server/tcp/tcp_commands.ex`, `parse_hello_message` (line 9)

The hello message handler accepts the serial number claimed in the binary payload at face value. After resolving the device via `UtilityController.device_lookup_with_hardware_id/1`, it immediately returns `{:ok, {:send, "hello", params}}` without any challenge-response, shared secret, TLS client certificate, or token verification. Any TCP client that sends a valid 4-byte little-endian serial number corresponding to a known device will be accepted as that device and its subsequent data records will be written to that device's account in the database.

**FINDING A062-6 — HIGH: Device data written to customer database with no per-customer boundary check**

File: `lib/api_server/tcp/tcp_commands.ex`, `parse_data_record` (around line 1119)

After building `thing_event`, the code calls:

```elixir
case ApiServer.Vx.get_vx_thing_with_hardware_id!(hardware_id, customer) do
  nil -> ""
  thing ->
    ApiServer.Vx.create_thingevent_record(to_save, customer)
```

The `customer` value originates from the device lookup table (`device.customer`, line 1025), which is populated from `[REDACTED-AWS-SMTP-PASSWORD]`. A spoofed serial number (the device provides its own serial in the hello message — see A062-5) can redirect event writes to any customer's database.

---

### §3: Input Validation and Injection

**FINDING A062-7 — HIGH: Binary parser performs no length bounds validation before fixed-size binary pattern match**

File: `lib/api_server/tcp/tcp_commands.ex`, multiple locations throughout the file.

Throughout `parse_hello_message`, `parse_data_message`, `parse_data_record`, `parse_gps_field`, `parse_trip_field`, `parse_total_field`, `parse_driverid_field`, and `parse_iridium`, the code uses fixed-size binary pattern matches such as:

```elixir
<<serial_number::bytes-size(4), modem_imei::bytes-size(16), sim_serial::bytes-size(21),
  product_id::bytes-size(1), hardware_revision::bytes-size(1), firmware_major::bytes-size(1),
  firmware_minor::bytes-size(1), flags::bytes-size(4), leftover::binary>> = remainder
```

Elixir pattern-matching on binary with `= remainder` raises a `MatchError` (and consequently crashes the current process) if `remainder` is shorter than the sum of the fixed-size fields. Because these functions are called from a TCP server process handling device input, a malicious or malfunctioning device sending a truncated packet will crash the handler process. Depending on the supervision strategy, this could be repeated to cause persistent disruption (denial of service).

There is no guard clause, `byte_size/1` pre-check, or `case` wrapper to produce a graceful `{:error, :malformed}` result.

**FINDING A062-8 — MEDIUM: `IO.puts` / `IO.inspect` used extensively for operational logging, including PII/fleet data**

File: `lib/api_server/tcp/tcp_commands.ex`, lines 25, 304–306, 381–383, 463–465, 553–555, 607–609, 640–642, 672–675, 769–771, 819–821, 1130, 1492, 1667, 1825.

Examples:

```elixir
IO.puts("Could not find device: #{inspect(serial)}")
IO.puts("Test unit 625425 found analog32 in field 4 #{inspect(field_four_data)}")
IO.puts("Analog values: #{inspect(analog_values)}")
IO.puts("driverid info parsed: type: #{driverid_type} data: #{driverid_data_encoded} final payload: #{inspect(driverid_parsed)}")
IO.inspect(error)
```

`IO.puts`/`IO.inspect` writes to stdout; in a production release this typically reaches the system journal or a log aggregator. Driver ID values (biometric identifiers — iButton and Weigand RFID card numbers), device serial numbers, GPS coordinates, and analog sensor readings are all emitted to stdout. This is PII and fleet-operations data that should not appear uncontrolled in logs. The `Logger` module with appropriate log levels should be used instead; production log levels can then suppress debug output without a code change.

**FINDING A062-9 — LOW: `parse_data_record` uses signed integer decoding for field lengths that are logically unsigned**

File: `lib/api_server/tcp/tcp_commands.ex`, lines 220–228 (field two length), 247–249 (field three), and several later field parsers.

Some field-length bytes are decoded as `little-signed-integer-size(8)` or `little-signed-integer-size(16)`. If the high bit of a length byte is set (values > 127 for 8-bit, > 32767 for 16-bit), the decoded length becomes negative. A subsequent `bytes-size(actual_field_length)` pattern match with a negative size raises a `FunctionClauseError` or `ArgumentError`, crashing the process. Wire-protocol field lengths should always be decoded as unsigned.

---

### §4: Session and CSRF

This module is a pure TCP binary-protocol parser with no HTTP session or CSRF surface. No Phoenix channels, cookies, or CSRF tokens are involved.

§4: No issues found.

---

### §5: File and Data Handling

**FINDING A062-10 — MEDIUM: Driver ID (biometric/RFID identifier) logged to stdout in plaintext**

File: `lib/api_server/tcp/tcp_commands.ex`, line 1666–1668:

```elixir
IO.puts(
  "driverid info parsed: type: #{driverid_type} data: #{driverid_data_encoded} final payload: #{inspect(driverid_parsed)}"
)
```

Driver ID data includes iButton serial numbers and Weigand RFID card numbers, which are used for driver identification and can constitute personal data under privacy legislation. Logging these to stdout in production exposes them in system logs and any log-aggregation tooling connected to the service.

**FINDING A062-11 — MEDIUM: `send_digital_matter_email` renders raw internal data struct directly into email HTML body**

File: `lib/api_server/vx/email.ex`, line 227:

```elixir
|> html_body("
  ...
  Data:<br><strong>"<> Kernel.inspect(data, limit: :infinity) <>"</strong><br>
  ...
")
```

`Kernel.inspect(data, limit: :infinity)` renders the full Elixir term representation of the `data` argument — whatever struct or map is passed — directly into the email HTML body with no sanitisation. If `data` contains HTML meta-characters (`<`, `>`, `&`, `"`) these will be rendered as raw HTML, which could produce misleading email content. More importantly, the `limit: :infinity` flag means arbitrarily large data structures will be serialised and included in the email body, which is a potential information-disclosure vector and could produce emails that are excessively large or contain internal system details. This function appears to be a debug/diagnostic email and should either be removed or have the data properly sanitised.

**FINDING A062-12 — LOW: `send_notification_email` ignores its `to` parameter; all notification emails are hardcoded to a single developer address**

File: `lib/api_server/vx/email.ex`, lines 4–12:

```elixir
def send_notification_email(to, subject, message) do
  from_email_address = "no-reply@mobilehourmeter.com"
  new_email()
  |> to("graham.oconnell@trackingsolutions.com.au")   # <-- hardcoded, ignores `to`
  |> from(from_email_address)
  ...
```

The function accepts a `to` parameter but ignores it, always sending to `graham.oconnell@trackingsolutions.com.au`. This is likely a development artefact that was never corrected before deployment. In production this means customer notification emails silently go to a developer rather than the intended recipient. The security concern is that customer-facing alert logic (geofence alerts, etc.) may silently fail to notify the correct party, and all such notifications are delivered to a single named individual's mailbox.

**FINDING A062-13 — LOW: Hardcoded image URL references a demo environment host in email templates**

File: `lib/api_server/vx/email.ex`, lines 46, 87, 152, 199, 246, 289, 336 (and similar):

```elixir
<img src='https://vx-demo.mobilehourmeter.com/img/logoleft_vx-demo.png'>
```

All email templates reference images hosted on `vx-demo.mobilehourmeter.com` — a demo/staging environment. If that host is unavailable or decommissioned, the production email logo will silently break. More relevantly for security, if the demo environment is controlled by a different party or becomes compromised, emails sent from the production system would load images from the attacker-controlled host, which enables email tracking pixel attacks and potential content substitution.

---

### §6: Dependencies

The assigned files do not contain dependency declarations. `mix.exs` and `mix.lock` are not in scope for this agent.

§6: No issues found in assigned files.

---

### §7: Infrastructure Exposure

**FINDING A062-14 — INFO: Internal service connection name `"SVR49"` hardcoded in source**

File: `lib/api_server/tcp/tcp_commands.ex`, lines 1222 and 1307 and 1892:

```elixir
CONNECTIONNAME: "SVR49"
```

This reveals the internal identifier for the FortyNine downstream service integration endpoint. Combined with the hardcoded username and password (A062-1, A062-2), this constitutes a complete set of credentials for the downstream service embedded in source. The connection name itself is low-risk in isolation but contributes to infrastructure topology disclosure in version control.

**FINDING A062-15 — INFO: Hardcoded list of production device serial numbers in source**

File: `lib/api_server/tcp/tcp_commands.ex`, lines 780–817 (yabby3 list), lines 888–904 and 1144–1160 (trility list), lines 1058 (special hardware IDs).

Large lists of production device serial numbers are hardcoded directly in the parsing logic. For example:

```elixir
when x in [598_608, 598_619, 598_627, 598_644, 598_646, 598_666, 598_673, 598_783,
           599_071, 599_307, 599_313, 599_314, 599_327, 599_336, 599_340, 550_798, ...]
```

These serial numbers identify specific physical devices deployed in the field for specific customers. Their presence in source (and therefore version control) exposes customer fleet asset enumeration data. An adversary with access to the repository can enumerate device serial numbers and spoof those devices on the TCP interface (see A062-5).

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A062-1 | CRITICAL | tcp_commands.ex | Hardcoded plaintext password `@trility!` for downstream FortyNine web service, persisted to database |
| A062-2 | MEDIUM | tcp_commands.ex | Hardcoded service username `trility` and mobile name `1234` in source |
| A062-3 | MEDIUM | tcp_commands.ex | Hardcoded customer code `TRILITY` / `vx_trility` in Iridium parser bypasses device lookup |
| A062-4 | LOW | tcp_commands.ex | Hardcoded hardware ID `462_743` in `parse_iridium`; all Iridium events attributed to one device |
| A062-5 | HIGH | tcp_commands.ex | No device authentication on TCP hello; device identity from unauthenticated binary payload |
| A062-6 | HIGH | tcp_commands.ex | Spoofed serial number can redirect event writes to arbitrary customer database |
| A062-7 | HIGH | tcp_commands.ex | Binary pattern match on device input without length guards; malformed packets crash process |
| A062-8 | MEDIUM | tcp_commands.ex | `IO.puts`/`IO.inspect` logs driver IDs, GPS coords, and serial numbers to stdout in production |
| A062-9 | LOW | tcp_commands.ex | Field lengths decoded as signed integers; values > 127 / > 32767 produce negative lengths and crash |
| A062-10 | MEDIUM | tcp_commands.ex | Driver ID (biometric RFID/iButton) logged to stdout in plaintext |
| A062-11 | MEDIUM | email.ex | `Kernel.inspect(data, limit: :infinity)` rendered into email HTML body without sanitisation |
| A062-12 | LOW | email.ex | `send_notification_email/3` ignores `to` parameter; all notifications go to hardcoded developer address |
| A062-13 | LOW | email.ex | Email image URLs reference demo environment host `vx-demo.mobilehourmeter.com` |
| A062-14 | INFO | tcp_commands.ex | Internal connection name `SVR49` hardcoded in source |
| A062-15 | INFO | tcp_commands.ex | Production device serial numbers enumerated in source, enabling asset disclosure and spoofing |

<!-- A065.md -->
# Security Audit Report — A065
**Agent:** A065
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server/vx/equipment.ex`
2. `lib/api_server/vx/equipment_assignment.ex`
3. `lib/api_server/vx/erp_import.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server/vx/equipment.ex`

**Module name:** `ApiServer.Vx.Equipment`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 20 |

**Schema defined:**

```elixir
@primary_key {:ID, :id, autogenerate: true}
schema "equipment" do
  field :id, :integer, source: :id
  field :name, :string, source: :name
  field :make, :string, source: :make
  field :model, :string, source: :model
  field :serial_number, :string, source: :serial_number
  field :class, :string, source: :class
  field :type, :string, source: :type
  field :created, :utc_datetime, source: :created
end
```

No `defstruct` or `defexception` defined.

**Module-level `use` / `import` / `alias`:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Ecto.Schema` | 2 |
| `import` | `Ecto.Changeset` | 3 |
| `alias` | `ApiServer.Vx` | 5 |

---

### File 2: `lib/api_server/vx/equipment_assignment.ex`

**Module name:** `ApiServer.Vx.EquipmentAssignment`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 20 |

**Schema defined:**

```elixir
@primary_key {:ID, :id, autogenerate: true}
schema "equipment_assignment" do
  field :id, :integer, source: :id
  field :equipment_id, :integer, source: :equipment_id
  field :device_group, :string, source: :device_group
  field :device_group_timezone, :string, source: :device_group_timezone
  field :assignment_start, :utc_datetime, source: :assignment_start
  field :assignment_end, :utc_datetime, source: :assignment_end
  field :created, :utc_datetime, source: :created
end
```

Note: `belongs_to :equipment` association is commented out on line 17.

No `defstruct` or `defexception` defined.

**Module-level `use` / `import` / `alias`:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Ecto.Schema` | 2 |
| `import` | `Ecto.Changeset` | 3 |
| `alias` | `ApiServer.Vx` | 5 |

---

### File 3: `lib/api_server/vx/erp_import.ex`

**Module name:** `ApiServer.Vx.ERPImport`

**Public functions (`def`):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 15 |

**Schema defined:**

```elixir
@primary_key {:id, :id, autogenerate: true}
schema "erp_imports" do
  field :raw_record, :string
  field :serialno, :string
  field :name, :string
  field :matched, :boolean
  field :type, :string
end
```

No `defstruct` or `defexception` defined.
No timestamps macro — no `inserted_at` / `updated_at` fields.

**Module-level `use` / `import` / `alias`:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Ecto.Schema` | 2 |
| `import` | `Ecto.Changeset` | 3 |

---

## Checklist Review

Supporting context reviewed beyond the three assigned files:

- `lib/api_server/vx/vx.ex` — query functions for equipment, equipment_assignment, erp_import
- `lib/api_server_web/controllers/utility_controller.ex` — `erp_import/2`, `create_equipment/3`, `create_equipment_assignment/3`, `pull_equipment_data_from_rayven/1`
- `lib/api_server_web/controllers/vx_fleet_controller.ex` — fleet/equipment endpoint handlers
- `lib/api_server_web/router.ex` — routing and pipeline assignments

---

### §1: Secrets and Configuration

No hardcoded credentials, API keys, or secret key bases found within the three assigned schema files. Internal employee email addresses used as ERP routing identifiers are examined under §2 below.

**§1: No issues found in the schema files themselves.**

---

### §2: Authentication and Authorization

**A065-1 — CRITICAL — `/erp-import` endpoint is unauthenticated**

The route `POST /erp-import` is declared in `router.ex` (line 190) inside the scope that uses only `pipe_through(:api_xml)` (line 180). This pipeline contains no `:authenticated` plug. There is no Guardian authentication applied to this endpoint.

The `erp_import/2` action in `utility_controller.ex` (line 5666) accepts a `"from"` string parameter supplied by the caller and uses it to resolve the target customer/tenant schema prefix:

```elixir
customer =
  case from do
    "SQLserver@sielift.com"  -> "vx_sielift"
    "rayven+cea@trackingsolutions.io" -> "vx_cea"
    ...
    _ -> "vx_dev"
  end
```

Because there is no authentication, any unauthenticated caller on the network can POST to `/erp-import` with an arbitrary `"from"` value. Since the email addresses used as keys are either publicly known domain formats or derivable from patterns already visible in the codebase, an attacker can trivially target any customer tenant. The action then:

- Reads and writes ERP import records into the named tenant's schema (`Vx.create_erp_import/2`, `Vx.check_for_existing_erp_record/2`)
- Triggers `process_rental_from_erp/2` and `process_service_from_erp/2`, which write operational fleet data (rentals, services) into the tenant database
- Calls `Vx.list_vxthings(customer)` and iterates all vehicle records, invoking `do_fix_info` on each — a potentially expensive operation that can be used as an amplified denial-of-service vector against any tenant

The `_ -> "vx_dev"` catch-all also means that any unrecognised `from` value silently routes to the `vx_dev` tenant rather than returning an error, which may pollute development data or mask abuse.

**Affected files:**
- `lib/api_server_web/router.ex` line 190
- `lib/api_server_web/controllers/utility_controller.ex` line 5666
- `lib/api_server/vx/erp_import.ex` (the schema written to)

---

**A065-2 — HIGH — Tenant resolution via user-controlled email string with no validation**

Even if authentication were added to `/erp-import`, the current tenant resolution logic maps a caller-supplied `"from"` string directly to an internal database schema prefix. This is an indirect authorisation check: the caller asserts their identity by providing an email address, and the server trusts it.

The pattern used in `erp_import/2` (utility_controller.ex lines 5668–5698):

```elixir
customer =
  case from do
    "SQLserver@sielift.com" -> "vx_sielift"
    ...
    _ -> "vx_dev"
  end
```

This is not equivalent to verifying that the JWT or session token belongs to a user authorised for that tenant. Any authenticated caller (if authentication is added) could still provide any `from` value and be routed to `vx_dev`, or if the allowed email addresses became known, to any customer tenant. The correct pattern is to derive the customer identifier exclusively from the authenticated token claims (as done in `vx_fleet_controller.ex` lines 20, 28 using `Guardian.Plug.current_claims(conn)["customer"]`).

---

**A065-3 — MEDIUM — `EquipmentAssignment` schema `unique_constraint` does not match business intent**

In `equipment_assignment.ex` line 24:

```elixir
|> unique_constraint(:equipment_id)
```

This imposes a unique constraint on `equipment_id` alone, meaning each piece of equipment can have at most one assignment record at any time in the database. The commented-out association on line 17 and the presence of `assignment_start` / `assignment_end` fields strongly suggest the intent is to track a history of assignments over time (i.e., multiple rows per `equipment_id` with non-overlapping time windows). The over-restrictive unique constraint will silently cause insert failures via changeset errors when attempting to close an old assignment and create a new one, potentially leaving assignment history incomplete or causing silent data loss in `create_equipment_assignment_record/2`. This is a data-integrity and security-relevant issue because incorrect assignment records directly affect `device_group_timezone` lookups used in rental period calculations and timezone-sensitive business logic throughout `utility_controller.ex`.

---

### §3: Input Validation and Injection

**A065-4 — MEDIUM — `raw_record` field stores unvalidated external JSON as a plain string; `Poison.decode!` raises on malformed data**

In `erp_import.ex`, `raw_record` is a `:string` field that stores JSON encoded by `Poison.encode!(record)` (`utility_controller.ex` line 5748). On retrieval, `vx.ex` lines 3212 and 3218 call:

```elixir
|> Enum.filter(fn(erp_import) -> Poison.decode!(erp_import.raw_record) == raw_record end)
```

`Poison.decode!/1` raises `Poison.ParseError` if the stored value is not valid JSON. Any corrupted row in `erp_imports` will crash this filter enumeration with an unhandled exception, halting the duplicate-check for the entire batch. There is no rescue or error-tuple variant used. The correct approach is `Poison.decode/1` (returns `{:ok, val}` / `{:error, reason}`) with explicit error handling.

---

**A065-5 — LOW — `Equipment.changeset/2` permits mass-assignment of the primary key field `id`**

`equipment.ex` line 22:

```elixir
|> cast(attrs, [:id, :name, :make, :model, :serial_number, :class, :type, :created])
```

`:id` is included in the cast list. The primary key (`ID`) is configured with `autogenerate: true`, but passing `:id` through `cast/3` means caller-supplied `id` values will be accepted and set on the changeset. If any code path in `utility_controller.ex` constructs attrs from partially user-controlled input and passes them to `create_equipment_record/2`, an attacker could force a specific primary key value, potentially causing conflicts with or overwriting existing records. The same pattern exists in `equipment_assignment.ex` line 22 (`:id` in cast list). The `:id` field should be removed from the cast list in both changesets.

---

**A065-6 — LOW — `Equipment.changeset/2` permits mass-assignment of `:created` timestamp**

`equipment.ex` line 22 also includes `:created` in the cast list. An attacker with write access to the create path could supply an arbitrary timestamp for the `created` field, undermining audit trail integrity. The same applies to `equipment_assignment.ex` line 22 (both `:created`, `:assignment_start`, `:assignment_end` are cast). While `assignment_start` and `assignment_end` are legitimate business inputs, `:created` should be set server-side only and excluded from the cast list.

---

### §4: Session and CSRF

The three schema files are not involved in session or CSRF handling.

**§4: No issues found in the assigned files.**

---

### §5: File and Data Handling

**A065-7 — MEDIUM — Equipment PII and fleet asset data logged via `IO.puts` to stdout**

In `utility_controller.ex`, the functions that invoke the assigned schemas log sensitive fleet data using `IO.puts` (not `Logger`), which writes directly to stdout with no log-level filtering. Notable instances:

- Line 3519: `IO.puts("[equipment] #{inspect(map)}")` — logs the full equipment map including `serial_number`, `name`, `make`, `model`, `class`, `type` for every device processed.
- Line 3528: `IO.puts("[equipment_id] #{inspect(equipment_id)}")` — logs equipment IDs.
- Line 3591: `IO.puts("[equipment_assignment] #{inspect(map)}")` — logs full assignment maps including `equipment_id` and `device_group_timezone`.
- Line 3647: `IO.puts("[EQUIPMENT] #{inspect(equipment)}")` — logs the full `%Equipment{}` struct.
- Line 3648: `IO.puts("[ASSIGNMENTS] #{inspect(equipment_assignments)}")` — logs the full `%EquipmentAssignment{}` struct.
- Line 4671: `IO.puts("[RAYVEN_DATA] #{inspect(rayven_data)}")` — logs raw Rayven API response including device metadata.

Using `IO.puts` rather than `Logger` means these messages cannot be suppressed by log level configuration in production and will always appear in application logs. In a fleet management context, `serial_number`, device group, and customer asset names are PII / commercially sensitive data. This data should not be written to logs at all in production, or at minimum should use `Logger.debug` so it can be disabled.

---

**A065-8 — LOW — ERP import response echoes caller-supplied rental data back to client**

In `utility_controller.ex` line 5732:

```elixir
|> Plug.Conn.send_resp(:ok, Poison.encode!(%{matches: 0, rentals: rentals}))
```

The full `rentals` list (which was POSTed by the caller and may contain customer fleet data, serial numbers, and contract details) is serialised and returned in the response body. For an unauthenticated endpoint (see A065-1), this means any caller receives back the payload they submitted, potentially confirming data was accepted. More significantly, if any server-side transformation or enrichment were added to `rentals` in future, this would become an information-disclosure path.

---

### §6: Dependencies

Dependency analysis is outside the scope of the three assigned schema files. No dependency declarations are made within these files.

**§6: No issues found in the assigned files.**

---

### §7: Infrastructure Exposure

**A065-9 — INFO — Hardcoded internal customer tenant schema names throughout utility_controller.ex**

The `erp_import/2` action and surrounding helper functions in `utility_controller.ex` (lines 5668–5698 and elsewhere) contain hardcoded PostgreSQL schema prefix strings: `"vx_sielift"`, `"vx_sie_latest"`, `"vx_cea"`, `"vx_komatsuau"`, `"vx_yocam"`, `"vx_redpath"`, `"vx_dev"`. These names reveal the full set of customer tenants hosted on this multi-tenant deployment and the naming convention used for their database schemas. If this source file were ever exposed (e.g., via a repository leak or public error page), these names would enumerate all tenant namespaces. These should be maintained in configuration rather than embedded in source code.

This finding directly relates to the `ERPImport` schema because the hardcoded strings are used as the `prefix:` argument in all `Repo` calls operating on `erp_imports`.

---

## Summary of Findings

| ID | Severity | Title |
|----|----------|-------|
| A065-1 | CRITICAL | `/erp-import` endpoint is unauthenticated |
| A065-2 | HIGH | Tenant resolution via user-controlled email string with no validation |
| A065-3 | MEDIUM | `EquipmentAssignment` unique_constraint prevents assignment history |
| A065-4 | MEDIUM | `Poison.decode!` raises on malformed `raw_record`; no error handling |
| A065-5 | LOW | Primary key `:id` included in changeset cast list (Equipment, EquipmentAssignment) |
| A065-6 | LOW | `:created` timestamp cast from caller input; audit trail can be falsified |
| A065-7 | MEDIUM | Fleet/equipment PII logged via `IO.puts` with no log-level control |
| A065-8 | LOW | ERP import response echoes caller-supplied fleet data |
| A065-9 | INFO | Hardcoded tenant schema names enumerate customer deployment topology |

<!-- A068.md -->
# Security Audit Pass 1 — A068
**Agent:** A068
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Run:** 2026-02-27-01
**Date:** 2026-02-27

---

## Assigned Files

- `lib/api_server/vx/geofence.ex`
- `lib/api_server/vx/mailer.ex`
- `lib/api_server/vx/rental_contracts.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server/vx/geofence.ex`

**Module name:** `ApiServer.Vx.Geofence`

**use / import / alias at module level:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)
- `import Ecto.Query, warn: false` (line 4)
- `alias ApiServer.Repo` (line 6)
- `alias ApiServer.Vx` (line 7)
- `alias ApiServer.Vx.VXThingEvent` (line 8)

**Schema defined:**
```
schema "geofences" do
  field :name, :string
  field :geojson, :string
end
@primary_key {:id, :id, autogenerate: true}
```

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 17 |
| `geojson_map_to_string` | 1 | 24 |
| `geojson_db_string_to_map` | 1 | 38 |

**Private functions (defp) — noted for context:**
- `does_event_cause_geofence_events_no_thing/5` (line 52)
- `check_event_for_left_events_no_thing/5` (line 69–70)
- `check_event_for_entered_events_no_thing/6` (line 86)
- `make_geofence_event_no_thing/5` (line 103)
- `engine_hours_at_event_no_thing/2` (line 119)

---

### File 2: `lib/api_server/vx/mailer.ex`

**Module name:** `ApiServer.Mailer`

**use / import / alias at module level:**
- `use Bamboo.Mailer, otp_app: :api_server` (line 2)

**Schema defined:** None

**Public functions (def):** None explicitly defined — all behaviour provided by Bamboo.Mailer macro (`deliver_now/1`, `deliver_later/1`).

---

### File 3: `lib/api_server/vx/rental_contracts.ex`

**Module name:** `ApiServer.Vx.RentalContract`

**use / import / alias at module level:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:**
```
@primary_key {:ID, :id, autogenerate: true}
schema "rental_contracts" do
  field :id, :integer, source: :id
  field :equipment_id, :integer, source: :equipment_id
  field :customer_id, :integer, source: :customer_id
  field :contract_reference, :string, source: :contract_reference
  field :contract_start, :date, source: :contract_start
  field :contract_end, :date, source: :contract_end
  field :billing_frequency, :string, source: :billing_frequency
  field :hours_per_billing_period, :integer, source: :hours_per_billing_period
  field :cost_units, :string, source: :cost_units
  field :cost_per_unit, :float, source: :cost_per_unit
  field :reporting_frequency, :string, source: :reporting_frequency
  field :created, :utc_datetime, source: :created
  field :sent_to_rayven, :integer, source: :sent_to_rayven
end
```

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 22 |

---

## Checklist Review

### §1: Secrets and Configuration

**A068-1 — CRITICAL: AWS SES SMTP credentials hardcoded in `config/config.exs` (tracked file)**

File: `config/config.exs`, lines 117–120.

```elixir
username: "[REDACTED-AWS-KEY-ID]",
password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

An AWS IAM access key ID (`[REDACTED-AWS-KEY-ID]`) and its SMTP secret are committed in plaintext in the base configuration file. This file is tracked by git and present from the initial commit (`e675b0b`). The same credentials are repeated verbatim in `config/prod.exs` (lines 45–48). Both files are tracked; git history cannot be cleaned without rewriting all commits. These credentials must be considered fully compromised and rotated immediately. Values must be moved to environment variables: `System.get_env("SES_SMTP_USERNAME")` and `System.get_env("SES_SMTP_PASSWORD")`.

**A068-2 — CRITICAL: Phoenix `secret_key_base` hardcoded in `config/config.exs` (tracked file)**

File: `config/config.exs`, line 15.

```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh",
```

A 64-byte `secret_key_base` is committed in the base config file. Any party with repository access can forge signed cookies and session tokens. This value must be rotated and loaded from `System.get_env("SECRET_KEY_BASE")`.

**A068-3 — CRITICAL: Guardian JWT `secret_key` hardcoded in `config/config.exs` (tracked file)**

File: `config/config.exs`, line 136.

```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The HMAC signing key used to issue and verify all JWTs is committed in plaintext. Any party with repository access can mint arbitrary valid authentication tokens for any user or customer, with full access to all fleet data. Rotate immediately and load from an environment variable.

**A068-4 — CRITICAL: Production database credentials hardcoded in `config/prod.exs` (tracked file)**

File: `config/prod.exs`, lines 13–25 and 27–37.

```elixir
# ApiServer.FortyNineRepo
username: "svr49_hi_x_user",
password: "Q973bFtc9z/cVW#mA",
hostname: "svr49.tracking-intelligence.com",

# ApiServer.Repo
username: "vxaurorasyduser",
password: "TRxbixk9fuZc",
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
```

Two sets of production database credentials are committed in plaintext in `prod.exs`, which is a tracked file present from the initial commit. This exposes direct database access to anyone with repository read access. Credentials must be rotated and loaded from environment variables.

**A068-5 — CRITICAL: `config/prod.secret.exs` committed to version control**

The `.gitignore` file (line 27) has the exclusion pattern `/config/*.secret.exs` commented out:

```
# /config/*.secret.exs
```

As a result, `config/prod.secret.exs` is tracked and was committed in the initial commit (`e675b0b`). That file contains an additional `secret_key_base`:

```elixir
secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```

The purpose of `prod.secret.exs` — to hold secrets outside version control — is entirely defeated. The `.gitignore` exclusion must be uncommented and git history reviewed.

**A068-6 — HIGH: AWS RDS hostname and internal service hostname reveal infrastructure topology in tracked config**

File: `config/prod.exs`, lines 18 and 36.

```elixir
hostname: "svr49.tracking-intelligence.com",
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
```

The AWS RDS cluster endpoint (including AWS account-specific subdomain `c4fwadrw9quy`) and an internal server hostname are committed in plaintext. Even after credential rotation, this reveals database topology and AWS account identifiers. Hostnames should be loaded from environment variables.

**A068-7 — HIGH: Geonames API username hardcoded in `config/config.exs`**

File: `config/config.exs`, lines 138–140.

```elixir
config :geonames,
  username: "vinxstudio",
```

A third-party service account credential is hardcoded in a tracked file. While less severe than database and JWT secrets, this credential belongs to an external account and should be loaded from an environment variable.

**A068-8 — HIGH: Guardian TTL set to 52 weeks**

File: `config/config.exs`, line 135.

```elixir
ttl: {52, :weeks},
```

JWT tokens are valid for one full year. In the event of token theft or the compromise of the `secret_key`, an attacker retains valid credentials for up to 52 weeks before expiry. Combined with A068-3 (the `secret_key` being committed to git), every token ever issued with this key must be considered compromised. Even after key rotation, a 52-week TTL is excessive for a fleet management API that holds GPS location and operator data. Recommended maximum is 24 hours with refresh tokens.

---

### §2: Authentication and Authorization

**A068-9 — MEDIUM: Two endpoints in `scope "/api/v1"` are placed before `pipe_through([:api, :authenticated])`**

File: `lib/api_server_web/router.ex`, lines 30–33.

```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)

  pipe_through([:api, :authenticated])
  ...
```

In Phoenix, `pipe_through` applies to all routes declared after it within the same scope block. The two routes declared before `pipe_through([:api, :authenticated])` — `/rhm/engine_usage` and `/rhm/monday_hour_meters` — are unauthenticated. These routes return fleet usage and meter data. Whether this is intentional should be documented. If these routes return any per-customer fleet data, they represent an information disclosure vulnerability.

Note: The geofence routes (`/rhm/geofences`, `/rhm/geofence`, `/rhm/reports/geofence_events`) and rental contract routes are all declared after `pipe_through([:api, :authenticated])` and are correctly authenticated.

§2: No further issues found for the three assigned files.

---

### §3: Input Validation and Injection

**A068-10 — MEDIUM: `Geofence.changeset/2` does not validate `:geojson` field**

File: `lib/api_server/vx/geofence.ex`, lines 17–21.

```elixir
def changeset(geofence, attrs) do
  geofence
  |> cast(attrs, [:name, :geojson])
  |> validate_required([:name])
end
```

The `:geojson` field is cast but not validated. There is no length limit, no format check, and no structural validation on the GeoJSON content. The `geojson_db_string_to_map/1` function deserialises this field via `Poison.decode/1` at query time; malformed or oversized payloads are silently turned into empty strings (`""`). While Poison decoding is safe against code injection, the absence of size limits means an authenticated user can store arbitrarily large GeoJSON blobs, creating a storage and memory pressure vector.

**A068-11 — MEDIUM: `RentalContract.changeset/2` has no `validate_required` calls**

File: `lib/api_server/vx/rental_contracts.ex`, lines 22–25.

```elixir
def changeset(rental_contracts, attrs) do
  rental_contracts
  |> cast(attrs, [:id, :equipment_id, :customer_id, :contract_reference, :contract_start,
                  :contract_end, :billing_frequency, :hours_per_billing_period, :cost_units,
                  :cost_per_unit, :reporting_frequency, :created, :sent_to_rayven])
end
```

The changeset casts all fields but performs no validation at all — no `validate_required`, no `validate_number`, no `validate_inclusion` for the `billing_frequency`, `cost_units`, or `reporting_frequency` enum-like string fields. This means:
- Rental contracts can be created with `nil` for all financial fields (`cost_per_unit`, `hours_per_billing_period`).
- Arithmetic operations performed downstream on these fields (e.g. rental overage calculations in the scheduler job) will encounter `nil` values and crash or produce incorrect results silently.
- String fields that likely represent bounded sets (`billing_frequency`, `reporting_frequency`) accept arbitrary input.

**A068-12 — LOW: `RentalContract.changeset/2` casts `:id` from user input**

File: `lib/api_server/vx/rental_contracts.ex`, line 24.

The `:id` field (which maps to the integer primary-key surrogate `id` column, separate from the declared `@primary_key {:ID, ...}`) is included in the cast list. Allowing callers to supply `:id` in attrs means a client can attempt to set or override the internal record identifier. This is redundant given the `@primary_key` declaration and could lead to confusion or unintended overwrites.

§3: No raw SQL fragment or atom-from-user-input issues found in the three assigned files.

---

### §4: Session and CSRF

§4: No issues found in the three assigned files. CSRF protection is applied via the `:browser` pipeline (`plug(:protect_from_forgery)`). The assigned files contain no session or channel logic.

---

### §5: File and Data Handling

**A068-13 — HIGH: Internal error detail returned to API clients in geofence create/update responses**

File: `lib/api_server_web/controllers/geofence_controller.ex`, lines 30–31 (referenced from context of `geofence.ex` public API).

```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error creating geofence\", \"reason\": \"#{inspect error}\" }")
```

and line 50:

```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }")
```

The full Ecto changeset error (or exception struct) is serialised via `inspect/1` and included verbatim in the HTTP 500 response body returned to the client. This can leak internal schema structure, field names, database constraint names, and stack trace fragments to an authenticated attacker. Additionally, line 30 calls `IO.inspect error` which echoes the same data to stdout/logs; in production this appears in the application log but confirms the pattern of treating internal errors as debug output.

**A068-14 — MEDIUM: GPS coordinates and vehicle location data included in geofence event responses without confirming cross-customer boundary protection**

File: `lib/api_server/vx/geofence.ex`, function `make_geofence_event_no_thing/5` (lines 103–116).

The returned geofence event maps include:
```elixir
latitude: event.latitude,
longitude: event.longitude
```

The data is correctly scoped to the authenticated customer's database prefix throughout (the `customer` value from JWT claims is passed as the Ecto prefix). However, the `does_event_cause_geofence_events_no_thing/5` and related private functions in `geofence.ex` are designed to operate independently of a `thing` struct — they accept raw `event` and `customer` arguments. If these functions are ever called from a context where the `customer` value is not verified against the authenticated user's claims (e.g. from the TCP ingestion pipeline), GPS data would flow without authorisation checks.

Inspection of `lib/api_server/tcp/tcp.ex` is outside this agent's file scope; this finding should be reviewed in conjunction with the TCP pipeline audit.

**A068-15 — LOW: `send_digital_matter_email` in `email.ex` (adjacent module) serialises raw fleet data via `Kernel.inspect/2` into email body**

File: `lib/api_server/vx/email.ex`, line 227 (not an assigned file, noted as adjacent context for the Mailer module).

```elixir
|> html_body("... "<> Kernel.inspect(data, limit: :infinity) <>"...")
```

This is an internal diagnostic/debug email function, but `limit: :infinity` means arbitrarily large Elixir terms — potentially containing full event structs with GPS data, hardware IDs, or customer identifiers — are serialised into an email. Email is an insecure transport and this pattern leaks fleet telemetry data outside the application boundary.

---

### §6: Dependencies

§6: The three assigned files do not introduce new dependencies directly. `ApiServer.Mailer` delegates entirely to `Bamboo.Mailer`. The use of `Poison` in `geofence.ex` (lines 29, 43) is noted — Poison is a legacy JSON library; Jason is the recommended replacement for Phoenix applications — however no known security advisory applies to the version in use at time of this audit. Dependency version checks are the responsibility of the mix.lock agent.

---

### §7: Infrastructure Exposure

**A068-16 — HIGH: AWS SES endpoint region hardcoded in tracked config files**

File: `config/config.exs`, line 113 and `config/prod.exs`, line 41.

```elixir
server: "email-smtp.us-west-2.amazonaws.com",
```

The AWS region `us-west-2` is hardcoded in tracked files. Combined with the RDS endpoint in `ap-southeast-2` (A068-6), this reveals that the application spans two AWS regions. While not directly exploitable on its own, this contributes to infrastructure topology disclosure in the git history.

§7: No CORS wildcard or permissive CSP issues found directly within the three assigned files. Router CORS status is noted at §2 (A068-9) for the unauthenticated routes.

---

## Summary of Findings

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A068-1 | CRITICAL | `config/config.exs` | AWS SES SMTP credentials hardcoded and committed |
| A068-2 | CRITICAL | `config/config.exs` | Phoenix `secret_key_base` hardcoded and committed |
| A068-3 | CRITICAL | `config/config.exs` | Guardian JWT `secret_key` hardcoded and committed |
| A068-4 | CRITICAL | `config/prod.exs` | Production database credentials hardcoded and committed |
| A068-5 | CRITICAL | `.gitignore` / `config/prod.secret.exs` | `prod.secret.exs` exclusion commented out; file committed to git |
| A068-6 | HIGH | `config/prod.exs` | AWS RDS hostname and internal hostname in tracked config |
| A068-7 | HIGH | `config/config.exs` | Geonames third-party API username hardcoded |
| A068-8 | HIGH | `config/config.exs` | Guardian JWT TTL of 52 weeks is excessive |
| A068-9 | MEDIUM | `router.ex` | Two routes declared before `pipe_through :authenticated` are unauthenticated |
| A068-10 | MEDIUM | `lib/api_server/vx/geofence.ex` | `changeset/2` does not validate or size-limit `:geojson` field |
| A068-11 | MEDIUM | `lib/api_server/vx/rental_contracts.ex` | `changeset/2` has no validation — all financial fields can be nil |
| A068-12 | LOW | `lib/api_server/vx/rental_contracts.ex` | `:id` field cast from user input in changeset |
| A068-13 | HIGH | `geofence_controller.ex` (context) | Internal Ecto error detail returned verbatim in HTTP 500 response |
| A068-14 | MEDIUM | `lib/api_server/vx/geofence.ex` | GPS data in `_no_thing` functions; TCP pipeline auth dependency unverified |
| A068-15 | LOW | `lib/api_server/vx/email.ex` (adjacent) | `inspect(data, limit: :infinity)` serialises fleet data into debug email |
| A068-16 | HIGH | `config/config.exs`, `config/prod.exs` | AWS region hardcoded in tracked files |

**Critical findings require immediate action before any further deployment: A068-1 through A068-5 represent fully committed, historically permanent exposure of credentials that must be rotated regardless of any code change.**

<!-- A071.md -->
# Pass 1 Security Audit — A071
**Agent:** A071
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Assigned files:**
- `lib/api_server/vx/rental_periods.ex`
- `lib/api_server/vx/scheduler.ex`
- `lib/api_server/vx/vx.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server/vx/rental_periods.ex`

**Module name:** `ApiServer.Vx.RentalPeriod`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 17 |

**Schemas / structs / exceptions:**

- `schema "rental_periods"` (lines 6–15)
  - Fields: `id` (integer), `contract_id` (integer), `period_start` (date), `period_end` (date), `hours_used` (float), `overage` (float), `is_completed` (integer), `created` (utc_datetime)
  - `@primary_key {:ID, :id, autogenerate: true}` (line 5)

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Ecto.Schema` | 2 |
| `import` | `Ecto.Changeset` | 3 |

---

### File 2: `lib/api_server/vx/scheduler.ex`

**Module name:** `ApiServer.Scheduler`

**Public functions (def):** None explicitly defined (all behaviour delegated via `use Quantum.Scheduler`).

**Schemas / structs / exceptions:** None.

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `Quantum.Scheduler, otp_app: :api_server` | 2–3 |

---

### File 3: `lib/api_server/vx/vx.ex`

**Module name:** `ApiServer.Vx`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `update_key_if_value` | 3 | 27 |
| `update_key_if_value` | 3 | 28 |
| `list_vxusers` | 1 | 33 |
| `get_vx_user!` | 2 | 40 |
| `get_vx_user_offset` | 2 | 47 |
| `get_vx_user_fleets!` | 2 | 54 |
| `create_vx_user` | 2 | 75 |
| `update_vx_user` | 3 | 93 |
| `update_vx_user_password` | 3 | 99 |
| `delete_vx_user` | 2 | 117 |
| `change_vx_user` | 1 | 130 |
| `list_vxaccessfobs` | 0 | 145 |
| `get_vx_access_fob!` | 1 | 163 |
| `get_vx_access_fob_by_code!` | 1 | 165 |
| `get_vx_access_fobs_for_fleets!` | 1 | 177 |
| `get_vx_fleet_for_access_fob` | 1 | 189 |
| `get_num_vx_admin_fobs` | 0 | 198 |
| `get_vx_admin_fobs` | 0 | 199 |
| `delete_vx_access_fob` | 1 | 215 |
| `list_vxfleets` | 1 | 222 |
| `list_vxfleets` | 2 | 227 |
| `get_list_of_valid_fleets_for_user` | 2 | 235 |
| `get_list_of_valid_equipment_for_user` | 2 | 243 |
| `list_vxfleets_with_equipment` | 2 | 264 |
| `get_vx_fleet_by_name` | 2 | 290 |
| `get_vx_fleet` | 2 | 296 |
| `create_vx_fleet` | 2 | 315 |
| `update_vx_fleet` | 3 | 333 |
| `delete_vx_fleet` | 2 | 351 |
| `change_vx_fleet` | 1 | 364 |
| `update_fleet_assocs` | 3 | 378 |
| `get_equipment_in_fleet` | 2 | 392 |
| `get_hardwareids_in_fleet` | 2 | 400 |
| `get_fleets_for_thing` | 2 | 408 |
| `get_branch_for_thing` | 2 | 416 |
| `list_vxfleetassociations` | 0 | 427 |
| `get_vx_fleet_association!` | 1 | 449 |
| `delete_vx_fleet_association` | 1 | 464 |
| `list_vxthings` | 1 | 470 |
| `list_vxthings_full` | 1 | 478 |
| `list_vxthings_lite` | 1 | 492 |
| `list_vxthing` | 2 | 498 |
| `list_vxthing_full` | 2 | 507 |
| `list_vxthing_lite` | 2 | 520 |
| `list_vxthings` | 2 | 528 |
| `list_augmented_things` | 2 | 539 |
| `list_augmented_things_with_rentals` | 1 | 555 |
| `list_augmented_things_with_rentals_in_fleet` | 3 | 568 |
| `list_augmented_things_in_fleet` | 3 | 589 |
| `list_vxthings_in_fleet` | 2 | 608 |
| `list_vxthings_with_checklists` | 1 | 623 |
| `get_lift_event_counts_for_thing_by_day` | 5 | 631 |
| `get_detailed_lift_event_counts_for_thing_by_day` | 6 | 651 |
| `get_list_lift_event_counts_for_thing_by_day` | 6 | 677 |
| `get_detailed_lift_event_counts_for_fleet_by_day` | 5 | 699 |
| `get_omega_engine_utilization` | 5 | 726 |
| `get_omega_operation_summary` | 5 | 749 |
| `list_vxthings_for_map` | 2 | 780 |
| `list_vxthings_for_map` | 2 | 795 |
| `augment_thing_with_fleets` | 2 | 811 |
| `augment_thing_with_services` | 2 | 816 |
| `get_hour_meter_start_rental` | 2 | 827 |
| `augment_thing_with_rental_periods` | 2 | 871 |
| `augment_thing_with_usage` | 2 | 940 |
| `get_avg_weekly_hours` | 2 | 968 |
| `get_avg_weekly_hours` | 3 | 981 |
| `get_summary_total_usage` | 1 | 985 |
| `get_usage_since_service` | 2 | 1006 |
| `fetch_actual_usage` | 2 | 1030 |
| `generate_usage_select` | 2 | 1042 |
| `fetch_actual_usage` | 5 | 1090 (category 4) |
| `fetch_actual_usage` | 5 | 1133 (category 2) |
| `fetch_actual_usage` | 5 | 1174 (category 3) |
| `fetch_actual_usage` | 5 | 1215 (generic) |
| `fetch_actual_usage_thing` | 4 | 1230 |
| `get_movements` | 5 | 1235 |
| `get_vx_thing!` | 1 | 1281 |
| `get_vx_thing!` | 2 | 1283 |
| `get_thing_name_with_hardware_id!` | 2 | 1290 |
| `get_fleet_name_with_id` | 2 | 1296 |
| `get_thing_category_with_hardware_id!` | 2 | 1303 |
| `get_thing_id_with_hardware_id!` | 2 | 1311 |
| `lookup_thing_with_name_serial` | 3 | 1319 |
| `lookup_thing_with_name` | 2 | 1328 |
| `get_vx_thing_with_hardware_id!` | 1 | 1337 |
| `get_vx_thing_with_hardware_id!` | 2 | 1347 |
| `get_augmented_thing_with_hardware_id!` | 2 | 1357 |
| `get_equipment_by_name` | 2 | 1363 |
| `get_equipment_by_serial` | 2 | 1371 |
| `get_equipment_assignments_by_id` | 2 | 1377 |
| `create_vx_thing` | 2 | 1395 |
| `update_vx_thing` | 3 | 1413 |
| `delete_vx_thing` | 1 | 1431 |
| `change_vx_thing` | 1 | 1444 |
| `list_vxthingsummaries` | 0 | 1459 |
| `get_vx_thing_summary!` | 1 | 1477 |
| `get_summary_for_hardwareid` | 2 | 1478 |
| `update_or_insert_summary` | 3 | 1484 |
| `create_vx_thing_summary` | 1 | 1501 |
| `update_vx_thing_summary` | 2 | 1519 |
| `delete_vx_thing_summary` | 1 | 1537 |
| `change_vx_thing_summary` | 1 | 1550 |
| `default_checklist_questions` | 0 | 1555 |
| `get_checklists` | 1 | 1586 |
| `list_vxthingevents` | 0 | 1622 |
| `get_vx_thing_event!` | 1 | 1640 |
| `get_most_recent_thingevent` | 2 | 1642 |
| `get_most_recent_thingevent_with_date` | 3 | 1651 |
| `get_most_recent_thingevent_with_omega` | 2 | 1660 |
| `get_thingevents_for_hardwareid` | 2 | 1673 |
| `get_thingevents_for_hardwareid` | 4 | 1680 |
| `create_vx_thing_event` | 2 | 1702 |
| `update_vx_thing_event` | 2 | 1720 |
| `delete_vx_thing_event` | 1 | 1738 |
| `change_vx_thing_event` | 1 | 1751 |
| `generate_avg_weekly_select` | 2 | 1755 |
| `convert_category_to_regular_units` | 2 | 1795 |
| `get_first_event` | 2 | 1824 |
| `get_actual_avg_weekly_hours` | 3 | 1842 (category 4) |
| `get_actual_avg_weekly_hours` | 4 | 1879 (category 4, input) |
| `get_actual_avg_weekly_hours` | 3 | 1916 (category 2) |
| `get_actual_avg_weekly_hours` | 4 | 1952 (category 2, 1) |
| `get_actual_avg_weekly_hours` | 3 | 1988 (category 3) |
| `get_actual_avg_weekly_hours` | 3 | 2026 (generic) |
| `list_service_records` | 1 | 2054 |
| `get_daily_usage` | 6 | 2100 |
| `get_impact_count_by_hardwareid` | 2 | 2170 |
| `get_events` | 5 | 2179 |
| `process_events` | 0 | 2192 |
| `process_events_subprocess` | 1 | 2547 |
| `get_vx_abl_record!` | 1 | 2611 |
| `create_vx_abl_record` | 1 | 2625 |
| `create_abl_record` | 2 | 2631 |
| `create_equipment_record` | 2 | 2637 |
| `get_equipment_id` | 2 | 2643 |
| `create_equipment_assignment_record` | 2 | 2650 |
| `update_vx_abl_record` | 2 | 2668 |
| `delete_vx_abl_record` | 1 | 2686 |
| `change_vx_abl_record` | 1 | 2699 |
| `get_rhm_user` | 3 | 2704 |
| `check_password` | 3 | 2712 |
| `get_rhm_user` | 2 | 2719 |
| `list_all_rentals` | 1 | 2730 |
| `list_open_rentals` | 1 | 2740 |
| `get_rental` | 2 | 2753 |
| `get_active_rental` | 2 | 2764 |
| `get_all_rentals_for_thing` | 2 | 2776 |
| `get_rental` | 4 | 2786 |
| `delete_rental` | 2 | 2798 |
| `update_rental` | 3 | 2802 |
| `create_rental_contract` | 2 | 2809 |
| `create_rental_period` | 2 | 2817 |
| `get_rental_periods_for_contract` | 2 | 2825 |
| `create_rental` | 2 | 2831 |
| `list_customers` | 1 | 2871 |
| `get_vx_customer!` | 2 | 2889 |
| `get_customer` | 3 | 2891 |
| `create_vx_customer` | 2 | 2916 |
| `update_vx_customer` | 3 | 2934 |
| `delete_vx_customer` | 2 | 2952 |
| `change_vx_customer` | 2 | 2965 |
| `list_vxaatuserfunctions` | 0 | 2980 |
| `get_vx_user_function!` | 1 | 2998 |
| `create_vx_user_function` | 1 | 3012 |
| `update_vx_user_function` | 2 | 3030 |
| `delete_vx_user_function` | 1 | 3048 |
| `change_vx_user_function` | 1 | 3061 |
| `list_vxaau_rest` | 0 | 3074 |
| `get_vx_restriction!` | 1 | 3092 |
| `create_vx_restriction` | 1 | 3106 |
| `add_fleet_to_user` | 3 | 3112 |
| `get_restriction` | 3 | 3124 |
| `remove_fleet_from_user` | 3 | 3132 |
| `update_vx_restriction` | 2 | 3150 |
| `delete_vx_restriction` | 1 | 3168 |
| `change_vx_restriction` | 1 | 3181 |
| `delete_erp_import` | 2 | 3189 |
| `create_erp_import` | 2 | 3193 |
| `update_erp_import` | 3 | 3199 |
| `check_for_existing_erp_record` | 2 | 3205 |
| `get_geofence_by_id` | 2 | 3223 |
| `get_geofences` | 1 | 3229 |
| `get_geofences_as_map` | 1 | 3234 |
| `create_geofence` | 2 | 3249 |
| `update_geofence` | 3 | 3255 |
| `delete_geofence` | 2 | 3261 |
| `create_thingevent_record` | 2 | 3265 |
| `update_thingevent_record` | 3 | 3271 |
| `delete_thingevent_record` | 2 | 3277 |
| `create_thingeventomega_record` | 2 | 3281 |
| `create_thingomegatires_record` | 2 | 3287 |
| `create_rayven_message_log_record` | 2 | 3293 |
| `update_rayven_stream_status_record` | 2 | 3299 |
| `count_rayven_events_to_stream` | 3 | 3305 |

**Schemas / structs / exceptions:** None defined in this module (context module only; uses schemas from aliased modules).

**use / import / alias at module level:**

| Directive | Value | Lines |
|-----------|-------|-------|
| `import` | `Ecto.Query, warn: false` | 6 |
| `alias` | `ApiServer.Repo` | 7 |
| `alias` | `ApiServer.Vx.VXUser` | 8 |
| `alias` | `ApiServer.Vx.VXThingEvent` | 9 |
| `alias` | `ApiServer.Vx.VXThingEventOmega` | 10 |
| `alias` | `ApiServer.Vx.VXThingEventOmegaTires` | 11 |
| `alias` | `ApiServer.Vx.VXFleetAssociation` | 12 |
| `alias` | `ApiServer.Vx.VXRestriction` | 13 |
| `alias` | `ApiServer.Vx.Geofence` | 14 |
| `alias` | `ApiServer.Vx.VXThing` | 15 |
| `alias` | `ApiServer.Vx.VXRental` | 16 |
| `alias` | `ApiServer.Vx.VXAblRecord` | 17 |
| `alias` | `ApiServer.Vx.VXRayvenMessageLog` | 18 |
| `alias` | `ApiServer.Vx.VXRayvenStreamStatus` | 19 |
| `alias` | `ApiServer.Vx.Equipment` | 20 |
| `alias` | `ApiServer.Vx.EquipmentAssignment` | 21 |
| `alias` | `ApiServer.Vx.RentalContract` | 22 |
| `alias` | `ApiServer.Vx.RentalPeriod` | 23 |
| `alias` (inline) | `ApiServer.Vx.VXAccessFob` | 134 |
| `alias` (inline) | `ApiServer.Vx.VXFleet` | 220 |
| `alias` (inline) | `ApiServer.Vx.VXThingEvent` | 1611 |
| `alias` (inline) | `ApiServer.Vx.VXAblRecord` | 2043 |
| `alias` (inline) | `ApiServer.Vx.VXRental` | 2728 |
| `alias` (inline) | `ApiServer.Vx.VXCustomer` | 2860 |
| `alias` (inline) | `ApiServer.Vx.VXUserFunction` | 2969 |
| `alias` (inline) | `ApiServer.Vx.ERPImport` | 3187 |

---

## Checklist Review

---

### §1: Secrets and Configuration

**A071-1 — CRITICAL — Hardcoded admin fob credential string in source**

`lib/api_server/vx/vx.ex`, lines 199–201:

```elixir
def get_vx_admin_fobs() do
  "000019333303000019333AEA000019330E4E0000193354AC00001933382D00001932FCA800001933001A"
end
```

A hardcoded string encoding seven physical access fob codes is embedded directly in source. This is an operational secret: anyone with access to the repository can read the exact fob IDs granted admin-level physical access to equipment. The fob codes cannot be rotated without a code change and redeployment. This directly contradicts the requirement that secrets must come from environment variables or a secrets manager, never from tracked files.

---

**A071-2 — HIGH — Hardcoded internal customer schema identifier in production code path**

`lib/api_server/vx/vx.ex`, lines 2196–2197 (`process_events/0`) and lines 2549–2550 (`process_events_subprocess/1`):

```elixir
customer = "vx_cea"
user_id = 37 # This is the admin user
```

The production customer schema name `"vx_cea"` and a specific admin user ID (`37`) are hardcoded inside two public functions. This reveals internal multi-tenant schema topology. If `process_events/0` is callable (e.g. via the scheduler), it will always operate against `vx_cea` regardless of context. This is both an information disclosure issue and a configuration correctness issue.

---

**A071-3 — HIGH — Hardcoded customer name in production branch logic**

`lib/api_server/vx/vx.ex`, line 3207:

```elixir
"vx_cea" ->
  # CEA only want to match on equipment name
```

The `check_for_existing_erp_record/2` function contains a hardcoded customer-specific schema name as a branch condition. This encodes internal deployment topology in source and creates a maintenance coupling between code and infrastructure naming.

---

**A071-4 — MEDIUM — Hardcoded email addresses for alert recipients**

`lib/api_server/vx/vx.ex`, lines 2306–2307, 2323, 2357–2358, 2375–2376, 2417, 2435–2436, 2477, 2495–2496, 2500, 2540–2541 (throughout `process_events/0`):

```elixir
email_to = ["shad.wall@clarkequipment.com","james.purdom@trackingsolutions.com.au","graham.oconnell@trackingsolutions.com.au"]
email_from = "no-reply@mobilehourmeter.com"
```

Multiple individual email addresses (including external parties) and a sender address are hardcoded in source. While most sending paths are commented out, two remain active (lines 2328–2329, 2377–2378, 2381–2382, 2437–2438, 2441–2442, 2497–2498, 2501–2502). Personal email addresses of named employees constitute PII embedded in source code.

---

**A071-5 — MEDIUM — Hardcoded date constants in `augment_thing_with_rental_periods/2`**

`lib/api_server/vx/vx.ex`, lines 874–879:

```elixir
from_date = "2019-01-01"
# Do something to change this to now.
to_date = "2020-07-05"
user_timezone = "US/Michigan"
```

Static date strings and a hardcoded timezone are embedded in a production function. The comment "Do something to change this to now" confirms these are unfinished placeholders. Any caller of this function receives data scoped to a fixed historical window regardless of actual request parameters. The hardcoded timezone `"US/Michigan"` also leaks a specific customer's operational geography.

---

**A071-6 — INFO — Hardcoded timezone in `augment_thing_with_usage/2`**

`lib/api_server/vx/vx.ex`, line 950:

```elixir
user_timezone = "+10:00"
```

A hardcoded UTC offset is used for all `this_week` and `this_month` usage calculations. This is likely wrong for most customers and leaks an assumed timezone (UTC+10, consistent with eastern Australia). Should be derived from user or customer configuration.

---

### §2: Authentication and Authorization

**A071-7 — CRITICAL — Plaintext password comparison in authentication functions**

`lib/api_server/vx/vx.ex`, lines 2704–2717:

```elixir
def get_rhm_user(email, password, customer) do
  VXUser
  |> Ecto.Query.where(aacemail: ^email)
  |> Ecto.Query.where(aacpassword: ^password)
  |> Ecto.Query.preload(:function)
  |> Repo.one(prefix: customer)
end

def check_password(user_id, password, customer) do
  VXUser
  |> Ecto.Query.where(aacid: ^user_id)
  |> Ecto.Query.where(aacpassword: ^password)
  |> Repo.one(prefix: customer)
end
```

Both `get_rhm_user/3` (3-arity) and `check_password/3` authenticate by issuing SQL queries that match on the raw `aacpassword` column. This means:
1. Passwords are stored in plaintext (or at most reversibly encoded) in the database — a violation of the checklist requirement that password hashing uses bcrypt or argon2.
2. Authentication is done via database equality rather than a constant-time hash comparison, making it vulnerable to timing attacks.
3. The column name `aacpassword` and query structure confirm the password is held in the user table in plaintext form.

This is the most severe authentication finding in the assigned files.

---

**A071-8 — HIGH — No changeset validation in `RentalPeriod.changeset/2`**

`lib/api_server/vx/rental_periods.ex`, lines 17–20:

```elixir
def changeset(rental_periods, attrs) do
  rental_periods
  |> cast(attrs, [:id, :contract_id, :period_start, :period_end, :hours_used, :overage, :is_completed, :created])
end
```

The changeset casts all fields but applies no `validate_required`, `validate_number`, or any other validation. Any caller can insert or update a `RentalPeriod` with an empty or malformed record. In particular, casting `:id` directly (overriding the autogenerated primary key `{:ID, :id, autogenerate: true}`) is unexpected and could allow callers to force-insert or collide on an arbitrary ID.

---

**A071-9 — HIGH — `list_vxfleetassociations/0` and several other functions query without tenant prefix**

`lib/api_server/vx/vx.ex`, lines 427–433:

```elixir
def list_vxfleetassociations do
  VXFleetAssociation
      |> Ecto.Query.where([r], r.aafgroupid != ^"29")
      |> Ecto.Query.preload(:fleet)
      |> Ecto.Query.preload(:thing)
      |> Repo.all
end
```

This function and several others (`list_vxaccessfobs/0`, `get_vx_access_fob!/1`, `get_vx_access_fob_by_code!/1`, `get_vx_access_fobs_for_fleets!/1`, `get_vx_fleet_for_access_fob/1`, `delete_vx_access_fob/1`, `get_vx_fleet_association!/1`, `delete_vx_fleet_association/1`, `list_vxthingevents/0`, `get_vx_thing_event!/1`, `get_vx_thing_summary!/1`, `create_vx_thing_summary/1`, `update_vx_thing_summary/2`, `delete_vx_thing_summary/1`, `change_vx_thing_summary/1`, `create_vx_abl_record/1`, `update_vx_abl_record/2`, `delete_vx_abl_record/1`, `list_vxaatuserfunctions/0`, `get_vx_user_function!/1`, `create_vx_user_function/1`, `update_vx_user_function/2`, `delete_vx_user_function/1`, `list_vxaau_rest/0`, `get_vx_restriction!/1`, `create_vx_restriction/1`, `update_vx_restriction/2`, `delete_vx_restriction/1`, `get_vx_thing_with_hardware_id!/1` (1-arity)) issue `Repo.*` calls **without a `prefix:` option**, bypassing the multi-tenant schema scoping pattern used throughout the rest of the codebase. This creates a cross-tenant data exposure risk: the query runs against whichever schema is the database user's default schema, or the OTP application default, rather than the authenticated customer's schema. If any of these no-prefix paths are reachable from a web request, data from one tenant may be returned to another.

---

**A071-10 — MEDIUM — `get_vx_admin_fobs/0` returns all admin fobs with no access control**

`lib/api_server/vx/vx.ex`, lines 198–201:

```elixir
def get_num_vx_admin_fobs(), do: 7
def get_vx_admin_fobs() do
  "000019333303000019333AEA000019330E4E0000193354AC00001933382D00001932FCA800001933001A"
end
```

These are public context functions with no authorization logic. Whether the callers enforce authorization is not visible in these files, but the function itself exposes the complete set of admin-privileged hardware credentials to any caller with module access.

---

### §3: Input Validation and Injection

**A071-11 — MEDIUM — SQL `fragment/1` interpolates caller-supplied timezone string without sanitization**

`lib/api_server/vx/vx.ex`, appearing throughout — representative examples at lines 638–639, 644–646, 658–659, 670–672, 685–686, 708–709, 719–721, 734–735, 738–745, 763–767, 1117–1118, 1258–1259, 2030, 2032, 2117–2118, 2132–2134, 2155–2156, 2160–2162, 2186–2187:

```elixir
fragment("DATE(CONVERT_TZ(?,'+00:00', ?))", field(te, :gmtdatetime), ^timezone)
fragment("CONVERT_TZ(?,'+00:00', ?) >= ?", field(te, :gmtdatetime), ^timezone, ^from)
```

The `timezone` parameter is interpolated as a bound parameter (`^timezone`) into MySQL `CONVERT_TZ` function calls via `fragment/1`. While Ecto's `^` binding parameterizes scalar values safely for most SQL injection contexts, the `CONVERT_TZ` named-zone argument (e.g. `"US/Michigan"`) is a string value processed by MySQL's timezone subsystem. The risk depends on whether the database's timezone tables are populated and whether MySQL sanitizes the zone argument. More critically, the functions accept `timezone` as a caller-supplied argument (e.g. `get_lift_event_counts_for_thing_by_day/5`, `get_movements/5`, `get_events/5`, `get_daily_usage/6`) with no validation or allowlist check on format. There is no evidence in these files that timezone is validated before reaching these queries. If a sufficiently long or specially crafted timezone string is accepted, MySQL may behave unexpectedly. This should be validated against an allowlist (e.g. Timex.Timezone zones or a `+HH:MM` pattern) before use.

---

**A071-12 — LOW — `rental_periods.ex` changeset casts `:id` (primary key) from external attrs**

`lib/api_server/vx/rental_periods.ex`, line 19:

```elixir
|> cast(attrs, [:id, :contract_id, ...])
```

Including `:id` in the cast list allows caller-supplied values to override the auto-generated primary key. In combination with the lack of any `validate_required` or permission checks within the changeset, this means an attacker able to reach `create_rental_period/2` could insert records with arbitrary IDs, potentially creating collisions or interfering with referential integrity.

---

### §4: Session and CSRF

§4: No session, CSRF, WebSocket, or channel configuration is present in the assigned files. These are context/schema modules. No issues found in scope.

---

### §5: File and Data Handling

**A071-13 — HIGH — GPS coordinates, vehicle data, driver IDs logged to stdout in production scheduler code**

`lib/api_server/vx/vx.ex`, throughout `process_events/0`, lines 2194, 2211, 2220, 2226, 2230, 2233, 2245, 2254, 2275, 2285–2295 etc.:

```elixir
IO.puts "[process_events] starting #{inspect time_start}"
IO.puts "[process_events] event geofence #{inspect time_start} #{inspect geofence_name}"
IO.puts "[geofence_name] going to send an exited_search of some description #{inspect time_start} #{inspect geofence_name}"
```

`process_events/0` uses `IO.puts` extensively to log runtime state. While the specific calls shown include timestamps and geofence names, the broader function processes vehicle event records containing `latitude`, `longitude`, `hardwareid`, and driver-association data. `IO.puts` bypasses the Logger infrastructure (which can be configured with log levels and backends in production) and writes directly to stdout/stderr. This means these outputs will appear in production logs unconditionally, cannot be filtered by log level, and are not subject to any PII-scrubbing middleware. Vehicle movement data (GPS location, hardware IDs, geofence membership) is PII-adjacent fleet data that should not appear in raw logs.

Additionally, the function contains hardcoded named email recipients (see A071-4) and is clearly intended as an internal batch process, yet it remains a fully public function callable from any context.

---

**A071-14 — MEDIUM — `process_events/0` returns GPS coordinates and vehicle names in email alerts sent to hardcoded external addresses**

`lib/api_server/vx/vx.ex`, lines 2296–2309, 2345–2360, 2405–2419, 2465–2479:

```elixir
data = %{
  vehicle_name: thing.aaddesc,
  vehicle_serial: thing.aadserialno,
  geofence_name: previous_name,
  time_left: Timex.format!(...),
  ...
}
email_to = ["shad.wall@clarkequipment.com", "james.purdom@trackingsolutions.com.au", "graham.oconnell@trackingsolutions.com.au"]
```

Active email paths (`ApiServer.Mailer.deliver_now()` is not commented out on lines 2329, 2378, 2382, 2438, 2442, 2498, 2502) send vehicle serial numbers, vehicle names, geofence names, and timestamps to hardcoded external addresses. This is cross-customer data disclosure if `process_events/0` processes data from multiple tenants (it currently hardcodes `vx_cea`, but if the function scope changes this risk escalates). The inclusion of external parties (`trackingsolutions.com.au`) in alert recipients is especially sensitive.

---

**A071-15 — INFO — `get_checklists/1` returns static stub data, ignores its argument**

`lib/api_server/vx/vx.ex`, lines 1586–1609:

```elixir
def get_checklists(hardwareid) do
  [
    %{gmtdatetime: DateTime.utc_now(), answers: [true, true, false, true], ...},
    ...
  ]
end
```

The `hardwareid` parameter is accepted but completely ignored; the function returns hardcoded stub checklist data. Any caller receives identical fabricated data regardless of which equipment is queried. This is not a direct security issue but could mask the absence of real checklist validation data in downstream security checks (e.g. equipment safety checks that rely on this result).

---

### §6: Dependencies

§6: No `mix.exs` or `mix.lock` are in the assigned files. Dependency review is out of scope for this agent.

---

### §7: Infrastructure Exposure

**A071-16 — MEDIUM — Internal schema namespace `"vx_cea"` hardcoded in multiple public functions**

(Cross-reference with A071-2 and A071-3.)

`lib/api_server/vx/vx.ex`, lines 2196, 2549, 3207.

The string `"vx_cea"` is a Postgres/MySQL schema prefix naming a specific customer deployment. Its presence in source exposes the internal naming convention used for multi-tenant schema isolation. An attacker who learns this pattern can infer other schema names by convention. All customer-scoped operations should receive the customer identifier from the authenticated session or configuration, never from hardcoded literals.

---

**A071-17 — LOW — Email sender domain `"no-reply@mobilehourmeter.com"` hardcoded**

`lib/api_server/vx/vx.ex`, lines 2307, 2358, 2419, 2478, 2540:

```elixir
email_from = "no-reply@mobilehourmeter.com"
```

The sender domain `mobilehourmeter.com` is different from the primary CIG/VX domain, potentially revealing infrastructure detail or a legacy domain. This should be moved to configuration.

---

## Summary of Findings

| ID | Severity | File | Line(s) | Description |
|----|----------|------|---------|-------------|
| A071-1 | CRITICAL | vx.ex | 199–201 | Hardcoded admin fob credential string in source |
| A071-2 | HIGH | vx.ex | 2196–2197, 2549–2550 | Hardcoded customer schema `vx_cea` and admin user ID 37 in process_events |
| A071-3 | HIGH | vx.ex | 3207 | Hardcoded customer name in check_for_existing_erp_record branch |
| A071-4 | MEDIUM | vx.ex | multiple in process_events | Hardcoded personal email addresses (PII) in source |
| A071-5 | MEDIUM | vx.ex | 874–879 | Hardcoded historical date range and timezone in augment_thing_with_rental_periods |
| A071-6 | INFO | vx.ex | 950 | Hardcoded timezone `+10:00` in augment_thing_with_usage |
| A071-7 | CRITICAL | vx.ex | 2704–2717 | Plaintext password comparison — passwords stored and compared without hashing |
| A071-8 | HIGH | rental_periods.ex | 17–20 | Changeset has no validation; casts primary key from external input |
| A071-9 | HIGH | vx.ex | 427–433 + others | Multiple functions query without tenant prefix — cross-tenant exposure risk |
| A071-10 | MEDIUM | vx.ex | 198–201 | get_vx_admin_fobs returns privileged hardware credentials with no access control |
| A071-11 | MEDIUM | vx.ex | many | Timezone string passed into SQL fragment without allowlist validation |
| A071-12 | LOW | rental_periods.ex | 19 | Changeset casts :id (primary key) from external attrs |
| A071-13 | HIGH | vx.ex | throughout process_events | Vehicle GPS/fleet data logged via IO.puts (bypasses Logger, always emits) |
| A071-14 | MEDIUM | vx.ex | 2296–2502 | Fleet/vehicle data emailed to hardcoded external addresses via live mailer paths |
| A071-15 | INFO | vx.ex | 1586–1609 | get_checklists/1 returns static stub data; argument ignored |
| A071-16 | MEDIUM | vx.ex | 2196, 2549, 3207 | Internal schema namespace pattern exposed via hardcoded `vx_cea` |
| A071-17 | LOW | vx.ex | 2307 et al. | Sender email domain `mobilehourmeter.com` hardcoded; reveals infrastructure detail |

<!-- A074.md -->
# Audit Report A074
**Agent:** A074
**Run:** 2026-02-27-01
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server/vx/vx_abl_record.ex`
2. `lib/api_server/vx/vx_access_fob.ex`
3. `lib/api_server/vx/vx_customer.ex`

Supporting files read for context (not assigned, evidence not required):
- `lib/api_server_web/controllers/vx_abl_record_controller.ex`
- `lib/api_server_web/controllers/vx_access_fob_controller.ex`
- `lib/api_server_web/controllers/vx_customer_controller.ex`
- `lib/api_server_web/controllers/file_controller.ex`
- `lib/api_server_web/router.ex`
- `lib/api_server/vx/vx.ex` (relevant excerpts)

---

## Reading Evidence

---

### File 1: `lib/api_server/vx/vx_abl_record.ex`

**Module:** `ApiServer.Vx.VXAblRecord`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `changeset` | 2 | 25 |
| `generate_service` | 10 | 31 |
| `clean_xml_value` | 1 | 54 |
| `clean_xml_number_value` | 1 | 63 |
| `expand_xml_to_struct` | 1 | 72 |

**Schema — `abl_data_changes`:**

Primary key: `{:ablid, :id, autogenerate: true}`

| Field | Type |
|---|---|
| `abldatetime` | `:utc_datetime` |
| `ablcustcode` | `:string` |
| `abluser` | `:string` |
| `abllogtype` | `:string` |
| `ablusragnt` | `:string` |
| `ablip_address` | `:string` |
| `abltable` | `:string` |
| `ablaction` | `:string` |
| `ablimagetype` | `:string` |
| `ablimage` | `:string` |
| `ablprocessed` | `:string` |
| `belongs_to :user` | `VXUser` (FK: `abluser` → `aacuser`, `define_field: false`) |

**Module-level use/import/alias:**

- `use Ecto.Schema`
- `import Ecto.Changeset`
- `alias ApiServer.Vx`

---

### File 2: `lib/api_server/vx/vx_access_fob.ex`

**Module:** `ApiServer.Vx.VXAccessFob`

**Public functions (def):** None defined in this file.

**Schema — `access_fobs`:**

Primary key: default (`:id`)

| Field | Type |
|---|---|
| `fob_code` | `:string` |
| `belongs_to :user` | `VXUser` (FK: `assigned_to_user` → `aacid`) |

**Module-level use/import/alias:**

- `use Ecto.Schema`
- Top-level `require Ecto.Query` (line 1, outside the module)
- Top-level `require Ecto.Adapters.SQL` (line 2, outside the module)

---

### File 3: `lib/api_server/vx/vx_customer.ex`

**Module:** `ApiServer.Vx.VXCustomer`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `convert_json_to_changeset` | 1 | 25 |
| `changeset` | 2 | 43 |

**Schema — `aaa_customers`:**

Primary key: `{:aaaid, :id, autogenerate: true}`

| Field | Type |
|---|---|
| `aaaaddr1` | `:string` |
| `aaaaddr2` | `:string` |
| `aaaaddr3` | `:string` |
| `aaacolour` | `:string` |
| `aaaname` | `:string` |
| `aaapcode` | `:string` |
| `aaaprimcont` | `:string` |
| `aaaprimemail` | `:string` |
| `aaaprimtel` | `:string` |
| `aaatz` | `:string` |
| `aaaudfcustcode` | `:string` |
| `aaacustcode` | `:string` |
| `belongs_to :rental` | `VXRental` (FK: `aaaid` → `abhcustomerid`, `define_field: false`) |

**Module-level use/import/alias:**

- `use Ecto.Schema`
- `import Ecto.Changeset`
- `alias ApiServer.Vx`

---

## Findings

---

### A074-1 — HIGH — XML Injection via Unsanitised User-Controlled Values in `generate_service/10`

**File:** `lib/api_server/vx/vx_abl_record.ex`, line 34
**Also present:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`, lines 148–160

`generate_service/10` constructs an XML document by direct Elixir string interpolation of its parameters into the XML literal string:

```elixir
abl_xml = "<?xml version='1.0'?><documentroot>
  <import_hour_meter>#{import_hour_meter}</import_hour_meter>
  <performed_by>#{performed_by}</performed_by>
  <hardwareid>#{thing.aadhardwareid}</hardwareid>
  ...
</documentroot>"
```

None of `import_hour_meter`, `performed_by`, `thing.aadhardwareid`, `existing_service_date`, `new_service_date`, `current_hour_meter`, `input_one_hour_meter`, or `usage.usage` are XML-escaped before interpolation. If any of these values contain characters such as `<`, `>`, `&`, `"`, or `'`, the resulting XML will be malformed or can be manipulated to inject arbitrary XML nodes.

The companion function `generate_service_record` in the controller (lines 148–160) has the identical pattern and the same values flow through, some of which originate directly or indirectly from user-supplied input (e.g. `new_service_date` from request parameters, `branch_name` from a DB value that was originally user-supplied).

`expand_xml_to_struct` (line 72) then parses the stored XML back via `XmlToMap.naive_map/1`. Injected structure in the stored XML would be parsed into unexpected map keys, potentially bypassing downstream filtering logic.

**Recommendation:** Use an XML library to produce well-formed XML with proper escaping, rather than string interpolation. At minimum, apply `&amp;`, `&lt;`, `&gt;` entity escaping to every interpolated value.

---

### A074-2 — HIGH — Hardcoded Access Fob Credentials (Admin Fob List)

**File:** `lib/api_server/vx/vx.ex`, lines 199–201 (observed during context reading for `VXAccessFob`)

```elixir
def get_vx_admin_fobs() do
  "000019333303000019333AEA000019330E4E0000193354AC00001933382D00001932FCA800001933001A"
end
```

Seven physical access-control fob codes are hardcoded as a hex string directly in source. These fob codes are used in `file_controller.ex` (line 33) as the seed of the binary access-file that is sent to hardware devices to control which fobs can operate the vehicle. Committing these credentials to version control means:

1. Anyone with read access to the repository knows all master/admin fob codes.
2. Rotating the codes requires a code change and deployment, not an operational action.
3. There is no mechanism to invalidate one code without redeploying.

**Recommendation:** Move admin fob codes to the application configuration, loaded from environment variables or a secrets manager, not embedded in source. The `file_controller.ex` endpoints are on the unauthenticated pipeline (see A074-4) which amplifies the exposure.

---

### A074-3 — HIGH — Information Disclosure: Internal Ecto Error Details Returned to Client

**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`, lines 27–28

```elixir
IO.inspect error
send_resp(conn, :internal_server_error,
  "{\"error\": \"error creating customer\", \"reason\": \"#{inspect error.errors}\" }")
```

On a changeset error during customer creation, the raw `inspect/1` output of `error.errors` — which is the Ecto changeset error list — is serialised directly into the HTTP response body sent to the client. This can expose:

- Internal database constraint names (e.g. `UQ1` is already used in `VXCustomer.changeset/2`)
- Column names from the underlying VX database schema
- Validation logic that aids enumeration attacks

Additionally, `IO.inspect error` writes the full error struct to stdout/logs with no redaction.

**Recommendation:** Return a generic error message to the client. Log the detailed error server-side via `Logger` at the appropriate level. Remove `IO.inspect`.

---

### A074-4 — HIGH — Missing Tenant/Customer Scoping: `VXAccessFob` Index and Delete Endpoints

**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`, lines 9–24
**Context:** `lib/api_server/vx/vx.ex`, lines 145–147 and 215–217

The `index` action calls `Vx.list_vxaccessfobs()` which performs `Repo.all(VXAccessFob)` — a full-table scan with no `prefix:` (tenant schema) qualifier and no filtering:

```elixir
def list_vxaccessfobs do
  Repo.all(VXAccessFob)
end
```

The `show` and `delete` actions similarly call `Vx.get_vx_access_fob!(id)` and `Vx.delete_vx_access_fob/1` with no tenant scoping. Compare this to `list_customers/1`, `get_vx_customer!/2`, and `delete_vx_customer/2` which all correctly pass `prefix: customer`.

All three actions return or delete fob records from across all customer tenants indiscriminately. This is an IDOR/cross-tenant data leak.

Note: `[REDACTED-AWS-SMTP-PASSWORD]` does not appear to be wired into the router (`router.ex` has no route to it), which means these endpoints are currently unreachable. However the underlying context functions (`list_vxaccessfobs`, `get_vx_access_fob!`) are also called from `file_controller.ex` which **is** on an unauthenticated pipeline (see A074-5). The schema module and context functions represent a latent cross-tenant vulnerability if routes are added.

**Recommendation:** Add `prefix: customer` to all access-fob queries. Remove or restrict the controller if the endpoints are not required.

---

### A074-5 — HIGH — Unauthenticated Access to Access Fob File Download Endpoints

**File:** `lib/api_server_web/router.ex`, lines 156–177
**Affected controller:** `lib/api_server_web/controllers/file_controller.ex`

The following routes are in the `pipe_through(:api)` scope (line 157) — **not** `pipe_through([:api, :authenticated])`:

```elixir
get("/files/getsize/:esn", FileController, :get_size)
get("/files/getfile/:esn", FileController, :send_file_download)
```

These endpoints:
- Accept a bare `esn` (hardware ID) parameter from any caller
- Look up all fleet fobs for the identified device
- Return the fob count (`:get_size`) or generate and deliver the complete binary access-control file including admin fob codes (`:get_file`)

No JWT or session authentication is required. Any party that can reach the API and knows (or guesses) a hardware ID can download the full access fob binary for any vehicle, including the seven hardcoded admin fobs. This bypasses the physical access control system.

**Recommendation:** Move these routes into the authenticated pipeline. Verify that the hardware device consuming these endpoints supports bearer token authentication; if not, implement a device-specific shared secret or mutual TLS.

---

### A074-6 — MEDIUM — `ablcustcode` Field Not Populated in `generate_service/10`

**File:** `lib/api_server/vx/vx_abl_record.ex`, lines 35–49

The `abl_changeset` map built in `generate_service/10` omits `ablcustcode`, setting `ablip_address` to the static string `"0.0.0.0"` instead of the actual caller IP. The changeset is then persisted via `Vx.create_abl_record/2`. In contrast, the controller version `generate_service_record/3` correctly captures `conn.remote_ip`.

The `generate_service/10` function (with the fake IP and missing `ablcustcode`) is a separate code path from `generate_service_record/3`. It is called elsewhere (e.g. from import/sync flows). Storing `0.0.0.0` as the originating IP degrades audit log integrity — if the ABL log is used for forensic or compliance purposes, these entries cannot be attributed.

**Recommendation:** Pass the real originating IP (or a meaningful system identifier for automated/import operations) and the customer code into the ABL record. Do not use `0.0.0.0` as a placeholder in production audit logs.

---

### A074-7 — MEDIUM — `convert_json_to_changeset/1` in `VXCustomer` Bypasses Ecto Changeset Validation

**File:** `lib/api_server/vx/vx_customer.ex`, lines 25–39

`convert_json_to_changeset/1` builds a plain `%{}` map by calling `Vx.update_key_if_value/3` for each field, then returns the raw map — not an `%Ecto.Changeset{}`. The result is passed directly to `Vx.create_vx_customer/2` and `Vx.update_vx_customer/3`, which then call `VXCustomer.changeset(struct, attrs)`.

The concern is the `aaacustcode` derivation at line 36:

```elixir
|> Vx.update_key_if_value(:aaacustcode,
    String.upcase(
      String.slice(
        String.replace(String.reverse(customer_json["name"]), " ", ""),
        0..8)))
```

If `customer_json["name"]` is `nil` (the key exists in the JSON but has a null value), `String.reverse(nil)` will raise a `FunctionClauseError` that is not caught. The `nil`-guard in `update_key_if_value/3` only prevents the key from being set when the **value** is nil, but the nil is already being passed into `String.reverse/1` before reaching `update_key_if_value/3`.

Additionally, `customer_json["aaaudfcustcode"]` and `customer_json["aaacolour"]` (lines 37–38) are accepted from the JSON payload with no validation — an attacker can set `aaaudfcustcode` to an arbitrary string. While the Ecto changeset would ultimately persist it, there is no length or format constraint on either field.

**Recommendation:** Guard `customer_json["name"]` for nil before the `String.reverse` pipeline. Move `aaacustcode` derivation into a changeset `validate_*` or `prepare_changes` step so it benefits from changeset error handling. Add length constraints on free-text fields.

---

### A074-8 — MEDIUM — `expand_xml_to_struct/1` Uses `Map.merge/2` to Merge XML Data onto a DB Struct

**File:** `lib/api_server/vx/vx_abl_record.ex`, lines 89–102

```elixir
Map.merge(abl_record, map_from_xml)
```

`abl_record` is an `%ApiServer.Vx.VXAblRecord{}` Ecto struct returned from the database. `Map.merge/2` is called with a plain map containing XML-derived keys. While the keys being merged (`new_service_date`, `old_service_date`, etc.) are controlled by the developer and not directly from user XML, the `hardwareid` value at line 75–87 is parsed directly from the stored `ablimage` XML with only a numeric parse and no further sanitisation. Any adversary able to write a crafted value into `ablimage` (possible via the XML injection identified in A074-1) could influence the `hardwareid` surfaced to callers.

The dead code at lines 80–84 is also notable: the two branches of the `if length(Integer.digits(value)) >= 10` conditional produce identical results, indicating an incomplete or abandoned length-check guard.

**Recommendation:** Use a typed struct or a purpose-built map with validated keys rather than `Map.merge/2` onto an Ecto struct. Remove or complete the dead length-check logic.

---

### A074-9 — LOW — `require` Directives Outside Module in `vx_access_fob.ex`

**File:** `lib/api_server/vx/vx_access_fob.ex`, lines 1–2

```elixir
require Ecto.Query
require Ecto.Adapters.SQL
```

Both `require` directives are placed **before** `defmodule`, making them file-level rather than module-level declarations. `Ecto.Adapters.SQL` is not used anywhere in the module body. Residual `require` statements for `Ecto.Adapters.SQL` are a common marker of removed raw SQL code; their continued presence suggests dead code cleanup has not been completed and could indicate a prior raw-SQL pattern that was partially removed.

**Recommendation:** Move `require` directives inside the `defmodule` block and remove the unused `require Ecto.Adapters.SQL`.

---

### A074-10 — LOW — `ablcustcode` Field in Schema Not Set via Changeset

**File:** `lib/api_server/vx/vx_abl_record.ex`, lines 27–28

The `changeset/2` function casts:

```elixir
cast(attrs, [:abldatetime, :abluser, :abllogtype, :ablusragnt, :ablip_address,
             :abltable, :ablaction, :ablimagetype, :ablimage, :ablprocessed])
```

The field `ablcustcode` is defined in the schema but is not included in the cast list. It can therefore only be set on the struct directly (bypassing changeset validation). The `generate_service/10` function also omits `ablcustcode` from its attrs map. This means `ablcustcode` will be `nil` for all records created through these code paths, despite the column existing in `abl_data_changes`. If this column is queried for reporting or access scoping, missing values will produce incorrect results.

**Recommendation:** Either include `ablcustcode` in the cast list and populate it at all call sites, or remove the field from the schema if it is no longer in use.

---

### A074-11 — INFO — `VXCustomer.changeset/2` Uses Non-Descriptive Unique Constraint Name

**File:** `lib/api_server/vx/vx_customer.ex`, line 47

```elixir
|> unique_constraint(:aaacustcode, name: :UQ1)
```

The constraint name `UQ1` provides no context about which table or column the uniqueness constraint applies to. While this is not a security issue, if `UQ1` is a name shared across multiple tables, Ecto may match the wrong constraint and surface misleading validation errors. Additionally, generic constraint names complicate database migration audits.

**Recommendation:** Use a descriptive constraint name (e.g. `aaa_customers_aaacustcode_index`).

---

## Checklist Summary

### §1: Secrets and Configuration
No hardcoded credentials found within the three assigned schema files themselves. A074-2 identifies hardcoded access fob codes in the broader `vx.ex` context module discovered while auditing `VXAccessFob` usage.

### §2: Authentication and Authorization
A074-4: `VXAccessFob` context functions lack tenant scoping (cross-tenant IDOR risk).
A074-5: File download endpoints using `VXAccessFob` data are on the unauthenticated pipeline.
No other auth issues found within the three schema modules themselves.

### §3: Input Validation and Injection
A074-1: XML injection via unsanitised string interpolation in `generate_service/10` and the controller equivalent.
A074-7: `convert_json_to_changeset/1` in `VXCustomer` passes `nil` to `String.reverse/1` which will raise at runtime.
No raw SQL fragments or atom creation from user input found in the three assigned files.

### §4: Session and CSRF
Not applicable to these schema/context modules directly. No session or CSRF logic present.

### §5: File and Data Handling
A074-3: Ecto error details (including constraint names) leaked to HTTP clients in `[REDACTED-AWS-SMTP-PASSWORD]`.
A074-6: Audit log (`abl_data_changes`) records created with fabricated IP address `0.0.0.0` from import paths, degrading forensic integrity.
A074-8: `Map.merge/2` onto Ecto struct from XML-derived data; dead code in integer length check.

### §6: Dependencies
Not assessed in this file set (no `mix.exs` or `mix.lock` changes observed).

### §7: Infrastructure Exposure
No hardcoded hostnames, IPs, or internal URLs found in the three assigned schema modules. The hardcoded admin fob hex codes (A074-2) are access-control credentials rather than infrastructure topology, but are noted under §1/§2.

<!-- A077.md -->
# Security Audit — Pass 1
**Agent:** A077
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01

---

## Assigned Files

1. `lib/api_server/vx/vx_fleet.ex`
2. `lib/api_server/vx/vx_fleet_association.ex`
3. `lib/api_server/vx/vx_rayven_message_log.ex`

---

## File 1: `lib/api_server/vx/vx_fleet.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXFleet`

**Public functions:**

| Name | Arity | Line |
|------|-------|------|
| `convert_json_to_changeset` | 1 | 19 |
| `changeset` | 2 | 27 |

**Schema defined:** `schema "aae_group"` with `@primary_key {:aaeid, :id, autogenerate: true}`

Schema fields:
- `:aaeid` (primary key, integer, autogenerate)
- `:aaecustcode` — `:string`
- `:aaedesc` — `:string`
- `:aaecolour` — `:string`
- `:aaetype` — `:integer`
- `:aaeshowfilter` — `:boolean`
- `has_many :fleet_thing_joins` → `ApiServer.Vx.VXFleetAssociation`, foreign_key `:aafgroupid`, `on_delete: :delete_all`

**use / import / alias at module level:**
- `use Ecto.Schema`
- `import Ecto.Changeset`
- `alias ApiServer.Vx`

---

### Checklist Review

**§1 Secrets and Configuration:** No secrets, credentials, API keys, or environment variable access in this file.
§1: No issues found.

**§2 Authentication and Authorization:**
The `changeset/2` function casts `:aaedesc`, `:aaecolour`, `:aaetype`, `:aaeshowfilter` and validates only `:aaedesc` as required. The `:aaecustcode` field is defined in the schema but is **not included in the cast list** in `changeset/2`, which means it cannot be set or updated via the standard changeset path. This is noted as an observation but not a direct security flaw in this schema file.

The `convert_json_to_changeset/1` function accepts a raw JSON map and extracts `fleet_json["name"]`, `fleet_json["color"]`, `fleet_json["type"]`, `fleet_json["show_in_filters"]` by string key. No validation or type-checking is performed on these values before constructing the attribute map. The caller (`VXFleetController.create_fleet/2` and `update_fleet/2`) passes the resulting map directly into `VXFleet.changeset/2` and then into `Vx.update_vx_fleet/3` or `Vx.create_vx_fleet/2`. Ecto's `cast/3` provides type coercion and will reject bad values at the changeset layer, which partially mitigates this, but there are no explicit format or length validations on `:aaecolour`, `:aaetype`, or `:aaeshowfilter`.

§2: No issues found (authorization is enforced at the controller/context level, not in this schema module).

**§3 Input Validation and Injection:**
`convert_json_to_changeset/1` does not validate the `type` field (`:aaetype`, integer) or the `color` field (`:aaecolour`, string) for acceptable values or lengths. There is no `validate_inclusion/3` on `:aaetype` to restrict it to known fleet type values, and no `validate_format` or `validate_length` on `:aaecolour`. Ecto will perform a type cast but will not reject arbitrarily long strings.

§3: See finding A077-1.

**§4 Session and CSRF:** Not applicable to this schema module.
§4: No issues found.

**§5 File and Data Handling:** No file operations. No Logger calls with fleet data in this file.
§5: No issues found.

**§6 Dependencies:** Not applicable to this module.
§6: No issues found.

**§7 Infrastructure Exposure:** No hostnames, IPs, or service URLs.
§7: No issues found.

---

## File 2: `lib/api_server/vx/vx_fleet_association.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXFleetAssociation`

**Public functions:** None (no `def` declarations; this is a pure schema module).

**Schema defined:** `schema "aaf_groups_things"` with `@primary_key {:aafid, :id, autogenerate: true}`

Schema fields:
- `:aafid` (primary key, integer, autogenerate)
- `:aafcustcode` — `:string`
- `belongs_to :fleet` → `ApiServer.Vx.VXFleet`, foreign_key `:aafgroupid`, references `:aaeid`
- `belongs_to :thing` → `ApiServer.Vx.VXThing`, foreign_key `:aafthingid`, references `:aadid`

**use / import / alias at module level:**
- `require Ecto.Query` (file-level, outside the module, line 1)
- `require Ecto.Adapters.SQL` (file-level, outside the module, line 2)
- `use Ecto.Schema` (inside module)

**No changeset function defined.**

---

### Checklist Review

**§1 Secrets and Configuration:** No secrets or credentials.
§1: No issues found.

**§2 Authentication and Authorization:**
The `[REDACTED-AWS-SMTP-PASSWORD]` (`lib/api_server_web/controllers/vx_fleet_association_controller.ex`) defines `index/2`, `show/2`, and `delete/2` actions that use this schema. These actions call `Vx.list_vxfleetassociations/0`, `Vx.get_vx_fleet_association!/1`, and `Vx.delete_vx_fleet_association/1` — **none of which scope by customer or authenticated user**. However, this controller is **not wired into the router** (`lib/api_server_web/router.ex` contains no reference to `[REDACTED-AWS-SMTP-PASSWORD]`). The controller appears to be dead/unused code. This is an important observation in the event it is ever added to the router without additional scoping.

§2: See finding A077-2.

**§3 Input Validation and Injection:**
`require Ecto.Adapters.SQL` appears at file scope (lines 1-2, outside the `defmodule` block). This is a structural anomaly — the `require` directives are placed before the module definition rather than inside it. While this is technically valid Elixir (the macros are available to the file), it is non-idiomatic and suggests the file may have been edited hastily or intended for direct SQL queries that were never completed or were removed. No actual `Ecto.Adapters.SQL.query` calls exist in this file.

No changeset is defined, so mass-assignment protection is absent. In `Vx.update_fleet_assocs/3`, `Repo.insert_all/3` is called with caller-supplied maps containing `:aafgroupid` and `:aafthingid` derived from user input — the fleet_id from the URL parameter and the `ids_in_fleet` list from the request body. The `aafgroupid` is constructed via `String.to_integer(fleet_id)` in the controller, which will raise an `ArgumentError` on non-integer input (no rescue), potentially causing a 500 response. The `aafthingid` values are taken directly from `ids_in_fleet` without type-checking.

§3: See findings A077-3, A077-4.

**§4 Session and CSRF:** Not applicable to this schema module.
§4: No issues found.

**§5 File and Data Handling:** No file operations, no Logger calls.
§5: No issues found.

**§6 Dependencies:** Not applicable to this module.
§6: No issues found.

**§7 Infrastructure Exposure:** No hostnames, IPs, or service URLs.
§7: No issues found.

---

## File 3: `lib/api_server/vx/vx_rayven_message_log.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXRayvenMessageLog`

**Public functions:**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 16 |

**Schema defined:** `schema "rayven_message_log"` with `@primary_key {:message_id, :id, autogenerate: true}`

Schema fields:
- `:message_id` (primary key, integer, autogenerate)
- `:message_direction` — `:string`
- `:message_type` — `:string`
- `:hardware_id` — `:integer`
- `:event_id` — `:integer`
- `:response` — `:string`
- `:message` — `:string`
- `:created` — `:utc_datetime`

**use / import / alias at module level:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

---

### Checklist Review

**§1 Secrets and Configuration:** No secrets or credentials.
§1: No issues found.

**§2 Authentication and Authorization:** Schema/changeset module; no authorization logic expected here.
§2: No issues found.

**§3 Input Validation and Injection:**
`changeset/2` casts `:message_direction`, `:message_type`, `:hardware_id`, `:event_id`, `:response`, `:message` but calls **no `validate_required/2`** and **no field-level validations** (no `validate_inclusion`, `validate_length`, `validate_format`). In particular:

- `:message_direction` and `:message_type` are free-form strings with no enumeration constraint. Any caller can insert arbitrary direction/type labels.
- `:response` and `:message` are unbounded strings. The `:message` field stores what appears to be a URL (`"https://my.rayven.io:8082"` observed in usage) but there is no length limit or format validation.
- `:created` is **not in the cast list**, meaning it must be set elsewhere (likely via database default) — this is acceptable.

The `:message` field stores a Rayven API endpoint URL. If the URL is ever constructed from external/user input upstream, the absence of format validation on this field is a concern.

§3: See finding A077-5.

**§4 Session and CSRF:** Not applicable to this schema module.
§4: No issues found.

**§5 File and Data Handling:**
The schema stores `:hardware_id` (equipment identifier) and `:event_id` (telemetry event). These are operational data fields. The table is queried in `utility_controller.ex` and `tcp.ex` without filtering by customer in the base queries when accessed via the context functions — but those queries do supply `prefix: customer` (Ecto multi-tenancy via schema prefix). The `:message` field stores Rayven API URLs which may encode endpoint information. No PII (driver names, GPS coordinates) is stored in this schema.
§5: No issues found.

**§6 Dependencies:** Not applicable to this module.
§6: No issues found.

**§7 Infrastructure Exposure:**
The `:message` field in the schema is used to store the Rayven API endpoint URL (`"https://my.rayven.io:8082"`) in log records. This is stored in the database, not hardcoded in this file. No hostnames or IPs are hardcoded in the schema itself.
§7: No issues found.

---

## Findings

### A077-1
**Severity:** LOW
**File:** `lib/api_server/vx/vx_fleet.ex`
**Location:** `changeset/2` (line 27–31), `convert_json_to_changeset/1` (line 19–25)
**Description:** The `changeset/2` function applies only a single `validate_required([:aaedesc])` validation. The fields `:aaecolour`, `:aaetype`, and `:aaeshowfilter` have no format, length, or inclusion constraints. `:aaetype` accepts any integer; no enumeration of valid fleet types is enforced at the schema level. `:aaecolour` accepts any string of any length, allowing very long values to reach the database. `convert_json_to_changeset/1` performs no pre-validation of the incoming JSON map values before constructing the attribute map.
**Risk:** Unexpected integer values for `:aaetype` could cause display or logic errors in consumers. Arbitrarily long strings for `:aaecolour` may cause database truncation errors or unexpected behaviour depending on column definition.
**Recommendation:** Add `validate_inclusion(:aaetype, [valid_type_ids])` and `validate_length(:aaecolour, max: N)` to `changeset/2`. Consider adding a `validate_format` for colour values (e.g. hex colour codes).

---

### A077-2
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_fleet_association.ex` (schema); `lib/api_server_web/controllers/vx_fleet_association_controller.ex` (controller)
**Location:** Controller `index/2` (line 9–12), `show/2` (line 14–17), `delete/2` (line 19–24)
**Description:** `[REDACTED-AWS-SMTP-PASSWORD]` contains three actions that operate on fleet association records without any customer scoping or ownership verification:
- `index/2` calls `Vx.list_vxfleetassociations/0` which returns all associations across all customers (no `prefix:` tenant filter, no authentication claim checked).
- `show/2` calls `Vx.get_vx_fleet_association!/1` with a bare ID, returning a record regardless of which customer it belongs to.
- `delete/2` calls `Vx.delete_vx_fleet_association/1` on any record retrieved by bare ID.

The controller is currently not registered in `router.ex` and therefore these routes are not accessible. However, the controller exists in the codebase and could be inadvertently enabled in a future router change, immediately creating cross-customer data exposure (IDOR) and unauthenticated cross-tenant deletion vulnerabilities.
**Risk:** If routes are added to the router, any authenticated user could enumerate and delete fleet associations belonging to other customers.
**Recommendation:** Either delete this controller entirely if it is not needed, or add customer-scoped versions of all three context functions and verify authentication claims before any operation. Do not add routes for this controller until ownership checks are implemented.

---

### A077-3
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_fleet_association.ex` (schema); used via `lib/api_server_web/controllers/vx_fleet_controller.ex` `manage_fleet/2` action
**Location:** Controller `manage_fleet/2` (lines 110–117); `Vx.update_fleet_assocs/3` in `vx.ex` (lines 378–390)
**Description:** In `manage_fleet/2`, `ids_in_fleet` is taken directly from the request body (`%{"equip_in_fleet" => ids_in_fleet}`) and mapped into association structs without type validation:
```elixir
formatted = ids_in_fleet
  |> Enum.map(fn(id) -> %{aafgroupid: String.to_integer(fleet_id), aafthingid: id} end)
```
The `aafthingid` values are used directly as-is (no `String.to_integer` call, no type coercion). These are passed to `Repo.insert_all/3` which bypasses Ecto changeset validation entirely. If the database column is typed as integer but a string is supplied, this may cause a runtime database error. More importantly, the fleet_id URL parameter is converted with `String.to_integer(fleet_id)` (no rescue), which raises `ArgumentError` on non-numeric input rather than returning a controlled error response, leaking an unhandled exception through to the fallback controller.

Additionally, the `customer` parameter in `manage_fleet/2` comes from the URL path (`%{"customer" => customer, ...}`), not from the authenticated JWT claims. There is no verification that the `customer` value in the URL matches the authenticated user's customer claim. An authenticated user from one customer can supply another customer's identifier in the URL and manage fleets in that tenant.
**Risk:** Cross-tenant fleet association manipulation. Authenticated users can modify fleet memberships in other customers' databases by supplying a different `customer` path parameter.
**Recommendation:** Replace `customer` URL parameter with the value from `ApiServer.Guardian.Plug.current_claims(conn)["customer"]` (as done in `get_fleets/2`). Wrap `String.to_integer(fleet_id)` in a rescue or use a pattern match to return a 400 error on non-integer input. Add a changeset for `VXFleetAssociation` and use it in `insert_all` or switch to individual `insert` calls with changeset validation.

---

### A077-4
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_fleet_association.ex`
**Location:** Lines 1–2 (file scope, outside `defmodule`)
**Description:** `require Ecto.Query` and `require Ecto.Adapters.SQL` appear at file scope, outside the `defmodule ApiServer.Vx.VXFleetAssociation do` block. This is non-idiomatic and indicates the file was prepared for direct raw SQL execution (via `Ecto.Adapters.SQL.query/3`) that was either never implemented or subsequently removed. The presence of `require Ecto.Adapters.SQL` at module top-level is a code smell that warrants a review of the git history to determine whether raw SQL was removed cleanly or whether fragments remain elsewhere in the codebase using this schema.
**Risk:** Low direct risk in the current state (no SQL execution calls present). However, the pattern suggests intent for raw SQL that may reappear. If `Ecto.Adapters.SQL.query/3` is used with string interpolation of user-controlled values (e.g. `fleet_id` or `customer`), SQL injection would result.
**Recommendation:** Remove the out-of-module `require` directives. If `Ecto.Adapters.SQL` is genuinely needed, place it inside the module. Review git history to confirm that any previously present raw SQL was removed and did not rely on string interpolation of user input.

---

### A077-5
**Severity:** LOW
**File:** `lib/api_server/vx/vx_rayven_message_log.ex`
**Location:** `changeset/2` (lines 16–19)
**Description:** The `changeset/2` function casts six fields but applies no `validate_required/2` and no field-level validations. Specifically:
- `:message_direction` and `:message_type` have no `validate_inclusion` constraint. Any arbitrary string can be stored, making log queries that filter by these fields unreliable.
- `:message` is an unbounded string. In observed usage it stores a URL (`"https://my.rayven.io:8082"`), but the field could accept arbitrarily large payloads with no length guard.
- `:response` is an unbounded string storing `inspect(status)` values; again no length limit.
**Risk:** Without length constraints, a programming error upstream that passes an unexpectedly large value (e.g. a full response body) could cause performance issues or exceed database column limits silently. Without enumeration constraints on `:message_direction` / `:message_type`, log integrity for audit/monitoring purposes is weakened.
**Recommendation:** Add `validate_required([:message_direction, :message_type, :hardware_id])`, `validate_inclusion(:message_direction, ["sent-tags", "received", ...])`, `validate_inclusion(:message_type, ["event", ...])`, and `validate_length(:message, max: 2048)` or similar appropriate limits to `changeset/2`.

---

### A077-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex` (controller for `VXFleet` schema)
**Location:** `create_fleet/2` (line 68), `delete_fleet/2` (line 91), `get_equipment_in_fleet/2` (line 105), `manage_fleet/2` (line 110), `update_fleet/2` (line 119)
**Description:** Multiple fleet controller actions accept `customer` as a URL path parameter and pass it directly to context functions as the database schema prefix without verifying it matches the authenticated user's `customer` claim from the JWT. For example:

```elixir
def delete_fleet(conn, %{"customer" => customer, "id" => id}) do
    vx_fleet = Vx.get_vx_fleet(id, customer)
    ...
    Vx.delete_vx_fleet(vx_fleet, customer)
```

The authenticated user's customer is available via `ApiServer.Guardian.Plug.current_claims(conn)["customer"]` but is not consulted. An authenticated user from customer `vx_abc` can pass `customer=vx_xyz` in the URL to read, create, update, or delete fleets belonging to `vx_xyz`.

By contrast, `get_fleets/2` (both clauses) and `get_fleets_with_equipment/2` correctly derive `customer` from JWT claims only. The inconsistency is a systematic IDOR vulnerability across the write/mutate and some read paths.
**Risk:** Cross-customer fleet data disclosure and modification. Any authenticated user can enumerate, create, update, delete fleets and manage equipment assignments in any other customer's database partition by simply supplying a different `customer` value in the URL.
**Recommendation:** Remove the `customer` URL parameter from all fleet endpoints and derive it exclusively from `ApiServer.Guardian.Plug.current_claims(conn)["customer"]`, matching the pattern already used in `get_fleets/2`.

---

### A077-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`
**Location:** `get_fleets/2` admin clause (lines 19–23), router `lib/api_server_web/router.ex` (line 103)
**Description:** The `get_fleets/2` action has two clauses. The first clause matches when the query parameter `admin=1` is present, and it returns **all fleets for the customer** without user-level scoping. The second clause (no `admin` parameter) returns only fleets accessible to the authenticated user.

The guard for the admin-all-fleets path is simply the presence of `"admin" => "1"` in the request parameters — this is a **client-supplied query parameter**, not a server-verified role or claim. Any authenticated user (regardless of their actual role) can append `?admin=1` to the `GET /api/v1/rhm/fleets` request and receive all customer fleets, bypassing the user-scoping that the second clause enforces.

There is no check against a JWT claim (e.g. `claims["role"] == "admin"`) or any other server-side authoritative source to verify the requester has administrative privileges.
**Risk:** Any authenticated user can bypass fleet visibility restrictions and enumerate all fleets within their customer partition by appending `?admin=1`.
**Recommendation:** Remove the query-parameter-based admin bypass. If an admin-all-fleets view is genuinely needed, gate it on a verifiable JWT claim (`claims["role"]` or similar) rather than a client-supplied parameter.

---

### A077-8
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`
**Location:** `create_fleet/2` line 86, `update_fleet/2` line 129
**Description:** Error responses include the raw output of `inspect(changeset)` or `inspect(result)` interpolated directly into the JSON error body returned to the client:

```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")
```

`inspect/1` on an Ecto Changeset can expose: field names, database column names, internal validation error atoms, and possibly partial data values that were submitted. This constitutes internal implementation disclosure in error responses.
**Risk:** Leaking internal schema field names and Ecto internals to API clients. In a multi-tenant fleet management context, this could expose column names or partial data that assists an attacker in crafting further requests.
**Recommendation:** Replace `inspect changeset` / `inspect result` with a user-facing message such as `"Validation failed"` or a structured error derived from `Ecto.Changeset.traverse_errors/2`. Log the full changeset server-side via `Logger.error/2` instead.

---

## Summary Table

| ID | Severity | File(s) | Topic |
|----|----------|---------|-------|
| A077-1 | LOW | `vx_fleet.ex` | Missing changeset validations on `:aaetype`, `:aaecolour` |
| A077-2 | HIGH | `vx_fleet_association.ex` / `vx_fleet_association_controller.ex` | Dead controller with no customer scoping — cross-tenant IDOR if routes ever enabled |
| A077-3 | MEDIUM | `vx_fleet_association.ex` (via `vx_fleet_controller.ex`) | `manage_fleet` uses URL `customer` param, no validation on `ids_in_fleet`, unhandled `String.to_integer` exception |
| A077-4 | MEDIUM | `vx_fleet_association.ex` | `require Ecto.Adapters.SQL` at file scope outside module — indicates removed raw SQL, verify no interpolation-based SQL remains |
| A077-5 | LOW | `vx_rayven_message_log.ex` | No `validate_required` or field constraints in `changeset/2` |
| A077-6 | MEDIUM | `vx_fleet_controller.ex` (VXFleet schema consumer) | `customer` URL param used instead of JWT claim on write/mutate fleet endpoints — cross-tenant IDOR |
| A077-7 | MEDIUM | `vx_fleet_controller.ex` | `?admin=1` query param bypasses user-scoped fleet visibility — no server-side role verification |
| A077-8 | LOW | `vx_fleet_controller.ex` | `inspect(changeset)` exposed in error responses — internal schema disclosure |

<!-- A080.md -->
# Audit Report A080
**Agent:** A080
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Auditor pass:** Pass 1

---

## Assigned Files

1. `lib/api_server/vx/vx_rayven_stream_status.ex`
2. `lib/api_server/vx/vx_rental.ex`
3. `lib/api_server/vx/vx_restriction.ex`

---

## Reading Evidence

### File 1 — `lib/api_server/vx/vx_rayven_stream_status.ex`

**Module name:** `ApiServer.Vx.VXRayvenStreamStatus`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 17 |

**Schema defined:** `"rayven_stream_status"` (primary key: `id` — autogenerate: true)

Fields:
- `:thing_id` — `:integer`
- `:hardware_id` — `:integer`
- `:last_event` — `:integer`
- `:last_event_time` — `:utc_datetime`
- `:streamed_at` — `:utc_datetime`
- `:delay` — `:integer`
- `:num_remaining` — `:integer`
- `:batch` — `:integer`

**use/import/alias:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

---

### File 2 — `lib/api_server/vx/vx_rental.ex`

**Module name:** `ApiServer.Vx.VXRental`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `get_all_anniversaries_between_dates` | 4 | 24 |
| `get_current_rental_period_start` | 2 | 112 |
| `calculate_period_end_date` | 3 | 119 |
| `has_anniversary_on_day?` | 3 | 146 |
| `changeset` | 2 | 158 |
| `generate_previous_period_anniversay` | 3 | 246 |

**Private functions (defp):**
- `get_all_subsequent_anniversaries/5` (line 77)
- `generate_next_period_anniversay/3` (line 176)
- `calculate_period_start_date/3` (line 468)

**Schema defined:** `"abh_rentals"` (primary key: `abhid` — autogenerate: true)

Fields:
- `:abhcustcode` — `:string`
- `:abhclient` — `:string`
- `:abhstartdate` — `:date`
- `:abhenddate` — `:date`
- `:abhtransdate` — `:utc_datetime`
- `:abhnotes` — `:string`
- `:abhrental_freq` — `:string`
- `:abhallowed_hours` — `:integer`
- `:abhreport_freq` — `:string`
- `:abhcustomerid` — `:integer`
- `:period_calculation` — `:string`

Associations:
- `has_one :customer` — `ApiServer.Vx.VXCustomer` (foreign_key: `:aaaid`, references: `:abhcustomerid`)
- `belongs_to :thing` — `ApiServer.Vx.VXThing` (foreign_key: `:abhthingid`, references: `:aadid`)

**use/import/alias:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

---

### File 3 — `lib/api_server/vx/vx_restriction.ex`

**Module name:** `ApiServer.Vx.VXRestriction`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `changeset` | 2 | 16 |

**Schema defined:** `"aau_rest"` (primary key: `aauid` — autogenerate: true)

Fields:
- `:aaucharval` — `:string`
- `:aaucustcode` — `:string`
- `:aaufun` — `:string`
- `:aaunumval` — `:integer`

Associations:
- `belongs_to :user` — `ApiServer.Vx.VXUser` (foreign_key: `:aauuser_id`, references: `:aacid`)

**use/import/alias:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

---

## Checklist Review

### §1: Secrets and Configuration

No hardcoded credentials, API keys, database passwords, secret key bases, AWS credentials, RDS endpoints, or infrastructure identifiers appear in any of the three assigned files. All three files are pure schema and business-logic modules with no configuration loading.

**§1: No issues found.**

---

### §2: Authentication and Authorization

Cross-file context examined: `lib/api_server_web/controllers/vx_rental_controller.ex`, `lib/api_server_web/controllers/vx_restriction_controller.ex`, `lib/api_server_web/router.ex`, and `lib/api_server/vx/vx.ex` were reviewed to understand how the schemas are consumed.

**Rental controller — `customer` sourced from URL path parameter, not the JWT (CRITICAL)**

Routes in the router pattern-match `customer` from the URL path:

```
post("/rhm/:customer/rentals/", VXRentalController, :update_rental)
put("/rhm/:customer/rentals/",  VXRentalController, :create_rental)
delete("/rhm/:customer/rentals/:id", VXRentalController, :delete_rental)
```

The controller actions `create_rental/2`, `update_rental/2`, and `delete_rental/2` destructure `customer` from `params` (the path/body parameter map) and pass it directly as the Ecto multi-tenant prefix:

```elixir
def create_rental(conn, %{"customer" => customer, "rental" => rental_params}) do
  ...
  case Vx.create_rental(changeset, customer) do

def update_rental(conn, %{"customer" => customer, "rental" => rental_params}) do
  rental = Vx.get_rental(rental_params["id"], customer)
  ...
  Vx.update_rental(rental, changeset, customer)

def delete_rental(conn, %{"customer" => customer, "id" => id}) do
  rental = Vx.get_rental(id, customer)
  ...
  Vx.delete_rental(rental, customer)
```

By contrast, the read-only actions `get_rentals/2` and `rhm_active_rental/2` correctly extract `customer` from the JWT claims:

```elixir
customer = ApiServer.Guardian.Plug.current_claims(conn)["customer"]
```

An authenticated user from customer A can supply any other customer's schema name in the URL and successfully create, update, or delete rental records in that customer's data partition. This is a cross-tenant access (IDOR / tenant escape) vulnerability affecting fleet management data.

**`generate_previous_period_anniversay/3` is a public function but is a pure calculation helper with no authorization implications in isolation.** The concern is in the controller layer calling it with unsanitised tenant context.

**`list_vxaau_rest/0` in `vx.ex` has no tenant prefix**

```elixir
def list_vxaau_rest do
  Repo.all(VXRestriction)   # no prefix: customer
end
```

This context function (called from `vx.ex`) queries the `aau_rest` table without a multi-tenant prefix, which could return restriction rows across all tenants. If exposed via any endpoint this is a data-leakage path. The similar `get_vx_restriction!/1` also lacks a tenant prefix.

**`create_vx_restriction/1` and `update_vx_restriction/2` / `delete_vx_restriction/1` in `vx.ex` also have no tenant prefix:**

```elixir
def create_vx_restriction(attrs \\ %{}) do
  %VXRestriction{} |> VXRestriction.changeset(attrs) |> Repo.insert()
end

def update_vx_restriction(%VXRestriction{} = vx_restriction, attrs) do
  vx_restriction |> VXRestriction.changeset(attrs) |> Repo.update()
end

def delete_vx_restriction(%VXRestriction{} = vx_restriction) do
  Repo.delete(vx_restriction)
end
```

These are contrast to `add_fleet_to_user/3` and `get_restriction/4` which do pass `prefix: customer`. This inconsistency means the scaffold-generated CRUD helpers for VXRestriction are unusable safely. `[REDACTED-AWS-SMTP-PASSWORD]` is currently empty (no actions), so these helpers are not currently exercised via HTTP, but they remain dangerous dead code.

**Finding raised below as A080-1 and A080-2.**

---

### §3: Input Validation and Injection

**VXRayvenStreamStatus — `changeset/2` has no `validate_required/2`**

All fields are accepted via `cast/3` but none are marked required. When `update_rayven_stream_status_record/2` calls this changeset for an upsert, it passes `attrs` that are mapped directly from internal pipeline data (not direct user input), so immediate injection risk is low. However the absence of required-field validation means the changeset provides no integrity guarantee.

**VXRental — `changeset/2` has no `validate_required/2`**

The rental changeset casts 11 fields but validates none as required. In `create_rental/2` and `update_rental/2`, the controller constructs the changeset via `VXRentalView.convert_json_to_changeset/1` from request body data and passes it to the context. The absence of required-field validation means a caller can create a rental with null `abhstartdate` or null `abhrental_freq`, which would cause runtime exceptions in the business-logic functions (`calculate_period_start_date/3` calls `Timex.format!/2` on `rental.abhstartdate` — a nil value here raises at runtime).

**`get_all_anniversaries_between_dates/4` — unchecked `Date.from_iso8601!` on caller-supplied strings**

```elixir
{_, to_datetime}   = NaiveDateTime.new(Date.from_iso8601!(to_date),   ~T[23:59:59.001])
{_, from_datetime} = NaiveDateTime.new(Date.from_iso8601!(from_date), ~T[00:00:01.001])
```

`Date.from_iso8601!/1` raises `ArgumentError` on malformed input. This is called from `VXRentalController.get_rental_anniversaries/2` with `to_date` and `from_date` taken directly from URL query parameters. An authenticated user supplying a non-ISO-8601 value will cause an unhandled exception; depending on the error handler this may leak a stack trace.

No raw SQL fragments (`Ecto.Adapters.SQL.query/3` or `fragment/1` with interpolated user input), `String.to_atom/1`, `binary_to_term/1`, or `Code.eval_string/1` were found in the three assigned files.

**Finding raised as A080-3 and A080-4.**

---

### §4: Session and CSRF

The three assigned files are schema/business-logic modules. They contain no plug, pipeline, channel, or session configuration. CSRF and WebSocket concerns are not applicable to these files directly.

**§4: No issues found in assigned files.**

---

### §5: File and Data Handling

**VXRestriction — `aaufun` field controls access/function gating with no validation**

`aaufun` is a free-text `:string` field. In `vx.ex` the value `"FLEET"` is hard-coded in queries:

```elixir
|> Ecto.Query.where(aaufun: ^"FLEET")
```

The `VXRestriction.changeset/2` accepts `aaufun` via `cast/3` with no `validate_inclusion/4` constraint. If a code path ever writes a restriction row sourced from user input without validating the `aaufun` value, an attacker could inject arbitrary function names or corrupt restriction records. Currently not directly exploitable via HTTP (controller is empty), but constitutes a missing integrity guard on security-sensitive data.

**VXRental — fleet/customer data returned without organisation scope check**

`list_all_rentals/1` and `list_open_rentals/1` in `vx.ex` return all rentals for the supplied `customer` prefix. The `customer` value for these calls in `get_rentals/2` and `get_midpac_style_rental_report/2` is correctly sourced from the JWT. However `create_rental`, `update_rental`, and `delete_rental` use an attacker-controlled `customer` (see A080-1), so rental records, vehicle details, serial numbers, allowed hours, and customer names can be read across tenant boundaries via the mutating endpoints.

**No PII logging (`Logger.*`) was found in any of the three assigned files.**

**§5: No additional issues beyond those captured in A080-1.**

---

### §6: Dependencies

The three assigned files use only `Ecto.Schema`, `Ecto.Changeset`, and the `Timex` library (via public API calls). No dependency declarations appear in these files; dependency audit is a `mix.exs`/`mix.lock` concern outside the scope of these three files.

**§6: No issues found in assigned files.**

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IPs, port numbers, CORS configuration, or TLS configuration appear in any of the three assigned files.

**§7: No issues found.**

---

## Findings

---

### A080-1 — CRITICAL: Tenant escape via attacker-controlled `customer` parameter in rental write endpoints

**File:** `lib/api_server_web/controllers/vx_rental_controller.ex` (controller consuming `VXRental` schema)
**Schema:** `lib/api_server/vx/vx_rental.ex`

**Routes:**
```
POST   /api/v1/rhm/:customer/rentals/    → VXRentalController.update_rental/2
PUT    /api/v1/rhm/:customer/rentals/    → VXRentalController.create_rental/2
DELETE /api/v1/rhm/:customer/rentals/:id → VXRentalController.delete_rental/2
```

**Evidence:**

```elixir
# create_rental — customer from URL param, NOT from JWT
def create_rental(conn, %{"customer" => customer, "rental" => rental_params}) do
  changeset = ApiServerWeb.VXRentalView.convert_json_to_changeset(rental_params)
  case Vx.create_rental(changeset, customer) do   # customer is attacker-controlled

# update_rental — customer from URL param, NOT from JWT
def update_rental(conn, %{"customer" => customer, "rental" => rental_params}) do
  rental = Vx.get_rental(rental_params["id"], customer)  # wrong tenant lookup

# delete_rental — customer from URL param, NOT from JWT
def delete_rental(conn, %{"customer" => customer, "id" => id}) do
  rental = Vx.get_rental(id, customer)   # wrong tenant lookup
```

Contrast with the read actions which correctly use:
```elixir
customer = ApiServer.Guardian.Plug.current_claims(conn)["customer"]
```

**Impact:** Any authenticated user can supply an arbitrary `customer` schema name in the URL path to create, update, or delete rental records in any other customer's partition. This exposes fleet vehicle records, serial numbers, rental contract terms, customer names, and allowed hours for the entire system.

**Recommendation:** Replace `%{"customer" => customer, ...}` destructuring with `ApiServer.Guardian.Plug.current_claims(conn)["customer"]` in all three write action heads. The URL `/:customer` path segment should be validated against the JWT claim or removed.

---

### A080-2 — HIGH: VXRestriction scaffold CRUD helpers operate without tenant prefix

**File:** `lib/api_server/vx/vx.ex` (consuming `lib/api_server/vx/vx_restriction.ex`)

```elixir
def list_vxaau_rest do
  Repo.all(VXRestriction)                          # no prefix: customer
end

def get_vx_restriction!(id), do: Repo.get!(VXRestriction, id)  # no prefix

def create_vx_restriction(attrs \\ %{}) do
  %VXRestriction{} |> VXRestriction.changeset(attrs) |> Repo.insert()  # no prefix
end

def update_vx_restriction(%VXRestriction{} = vx_restriction, attrs) do
  vx_restriction |> VXRestriction.changeset(attrs) |> Repo.update()   # no prefix
end

def delete_vx_restriction(%VXRestriction{} = vx_restriction) do
  Repo.delete(vx_restriction)                      # no prefix
end
```

The `aau_rest` table holds per-user fleet access restrictions which are security controls (rows with `aaufun = "FLEET"` gate which fleets a user may access). The tenant-unscoped helpers would read or write the default (un-prefixed) schema, which is likely either empty or the wrong tenant entirely. The production-correct equivalents `add_fleet_to_user/3` and `get_restriction/4` both use `prefix: customer`, confirming this is not intentional.

**Impact:** If any code path calls the scaffold helpers, restriction rows are written to or read from the wrong tenant, potentially granting or denying users access to fleets in another organisation, or silently failing. Currently the `[REDACTED-AWS-SMTP-PASSWORD]` is empty so there is no live HTTP path, but the helpers exist and can be called from elsewhere or added by a future developer without recognising the risk.

**Recommendation:** Add a `customer` parameter to all five scaffold helpers and pass `prefix: customer` to every `Repo.*` call, consistent with `add_fleet_to_user/3`. Alternatively, remove the scaffold helpers entirely and direct callers to the correctly-scoped helpers.

---

### A080-3 — MEDIUM: Unhandled exception on malformed date input in `get_rental_anniversaries`

**File:** `lib/api_server/vx/vx_rental.ex` (lines 25–26), called from `vx_rental_controller.ex` line 119

```elixir
def get_all_anniversaries_between_dates(rental, to_date, from_date, user_timezone) do
  {_, to_datetime}   = NaiveDateTime.new(Date.from_iso8601!(to_date),   ~T[23:59:59.001])
  {_, from_datetime} = NaiveDateTime.new(Date.from_iso8601!(from_date), ~T[00:00:01.001])
```

`Date.from_iso8601!/1` raises `ArgumentError` when the string is not a valid ISO-8601 date. The call site in the controller does not rescue this exception:

```elixir
# vx_rental_controller.ex line 119
all_anniversaries = VXRental.get_all_anniversaries_between_dates(rental, to_date, from_date, user_timezone)
```

`to_date` and `from_date` come directly from `%{"hardwareid" => hardwareid, "from" => from_date, "to" => to_date}` — user-supplied query parameters. A malformed value causes a 500, and depending on the error view configuration may return a stack trace to the caller.

**Recommendation:** Replace `Date.from_iso8601!/1` with `Date.from_iso8601/1` and pattern-match the `{:ok, date}` / `{:error, _}` result, returning a 400 Bad Request for invalid input.

---

### A080-4 — LOW: VXRayvenStreamStatus and VXRental changesets have no `validate_required` constraints

**Files:** `lib/api_server/vx/vx_rayven_stream_status.ex` (line 17), `lib/api_server/vx/vx_rental.ex` (line 158)

```elixir
# vx_rayven_stream_status.ex
def changeset(rayven_stream_status, attrs) do
  rayven_stream_status
  |> cast(attrs, [:thing_id, :hardware_id, :last_event, :last_event_time,
                  :streamed_at, :delay, :num_remaining, :batch])
  # no validate_required
end

# vx_rental.ex
def changeset(vx_rental, attrs) do
  vx_rental
  |> cast(attrs, [:abhid, :abhclient, :abhcustomerid, :abhthingid,
                  :abhstartdate, :abhenddate, :abhtransdate, :abhnotes,
                  :abhrentalfreq, :abhallowed_hours, :abhreport_freq,
                  :period_calculation])
  # no validate_required
end
```

For `VXRental`, the business-logic functions `calculate_period_start_date/3`, `get_all_anniversaries_between_dates/4`, and `generate_next_period_anniversay/3` all call `Timex.format!/2` or `NaiveDateTime.new/2` on `rental.abhstartdate` without nil-guarding it. A rental persisted with a null `abhstartdate` (which the changeset permits) will crash these functions at runtime when the scheduler or a reporting endpoint iterates over rentals.

**Recommendation:** Add `validate_required/2` to both changesets for the fields that are semantically mandatory. At minimum, `VXRental` should require `:abhstartdate` and `:abhrental_freq`.

---

### A080-5 — MEDIUM: Internal Ecto changeset details disclosed in HTTP error responses

**File:** `lib/api_server_web/controllers/vx_rental_controller.ex` (lines 169, 184)

```elixir
# Line 169
send_resp(conn, :internal_server_error,
  "{\"error\": \"Unknown error creating rental\",\"reason\": \"An error occured while creating this rental\", \"changeset\": \"#{inspect changeset}\"}\" }")

# Line 184
send_resp(conn, :internal_server_error,
  "{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }")
```

`inspect changeset` and `inspect result` on Ecto changesets and error tuples can expose internal field names, database constraint names, validation rule details, and Elixir module paths to API callers. This is an information-disclosure finding that assists an attacker in understanding the internal schema and error structure.

**Recommendation:** Replace `inspect changeset` / `inspect result` in HTTP responses with a static error message. Log the changeset/result server-side at an appropriate log level instead.

---

### A080-6 — INFO: `generate_previous_period_anniversay` is public but should be private

**File:** `lib/api_server/vx/vx_rental.ex` (line 246)

```elixir
def generate_previous_period_anniversay(current_anniversary, rental, user_timezone) do
```

This function is a pure internal date-arithmetic helper analogous to the private `generate_next_period_anniversay/3` (line 176, `defp`). It is called from `vx_rental_controller.ex` and `vx.ex` externally, however there is no semantic reason for it to be part of the public module API. The asymmetry (next is private, previous is public) increases the module's public surface area unnecessarily and also contains commented-out code blocks (lines 274–278, 388–398) suggesting ongoing development churn.

**Recommendation:** Evaluate whether callers can be moved into the module or whether the function should remain public for legitimate cross-module use. Clean up commented-out code.

---

## Summary Table

| ID | Severity | File(s) | Title |
|----|----------|---------|-------|
| A080-1 | CRITICAL | vx_rental.ex / vx_rental_controller.ex | Tenant escape via attacker-controlled `customer` in rental write endpoints |
| A080-2 | HIGH | vx_restriction.ex / vx.ex | VXRestriction scaffold CRUD helpers operate without tenant prefix |
| A080-3 | MEDIUM | vx_rental.ex | Unhandled exception on malformed date input (`Date.from_iso8601!`) |
| A080-4 | LOW | vx_rayven_stream_status.ex, vx_rental.ex | Changesets have no `validate_required` constraints |
| A080-5 | MEDIUM | vx_rental_controller.ex | Internal Ecto changeset details disclosed in HTTP error responses |
| A080-6 | INFO | vx_rental.ex | `generate_previous_period_anniversay` is unnecessarily public; stale commented-out code |

<!-- A083.md -->
# Audit Report A083
**Agent:** A083
**Run:** 2026-02-27-01
**Branch:** master
**Stack:** Elixir/Phoenix — api_server
**Assigned files:**
- `lib/api_server/vx/vx_thing.ex`
- `lib/api_server/vx/vx_thing_event.ex`
- `lib/api_server/vx/vx_thing_event_omega.ex`

---

## File 1: `lib/api_server/vx/vx_thing.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThing`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `convert_json_to_changeset` | 1 | 60 |
| `changeset` | 2 | 75 |

**Schema defined — `schema "aad_thing"`:**

Fields:
- `:aadid` (primary key, autogenerate)
- `:aadcustcode` (:string)
- `:aaddesc` (:string)
- `:aadintext` (:string)
- `:aadaddr` (:string)
- `:aadcustomerid` (:integer)
- `:aadcat` (:integer)
- `:aadhardwareid` (:integer)
- `:aadhw_type` (:integer)
- `:aadmake` (:string)
- `:aadmodel` (:string)
- `:aadserialno` (:string)
- `:aadmobile` (:string)
- `:aadimei` (:string)
- `:aadhourmeter` (:float)
- `:aadhourmeter1` (:float)
- `:aadhourmeter2` (:float)
- `:aadhourmeter3` (:float)
- `:aadhourmeter4` (:float)
- `:aadhourmeterprnt` (:float)
- `:aadodometer` (:integer)
- `:aadhourmeteromega` (:float)
- `:aadhourmeterothcan` (:float)
- `:aaddateintoservice` (:date)
- `:aadlastservice` (:date)
- `:aadvalid` (:string)
- `:aadserviceoffset` (:float)
- `:aadsvchrs` (:integer)
- `:aadrange_lat` (:float)
- `:aadrange_long` (:float)
- `:aadrange_dist` (:integer)
- `:aadrange_unit` (:string)
- `:service_calculation_input` (:string)
- `:reference_1` (:string)
- `:reference_2` (:string)
- `:reference_3` (:string)
- `:notes` (:string)
- `:equipment_date_into_service` (:date)

Associations:
- `has_many :fleet_thing_joins` (VXFleetAssociation)
- `has_many :rentals` (VXRental)
- `has_many :events` (VXThingEvent, via `:aadhardwareid`)
- `has_one :summary` (VXThingSummary, via `:aadhardwareid`)
- `has_one :info` (VXThingInfo, via `:aadhardwareid`)
- `has_one :customer` (VXCustomer, via `:aadcustomerid`)

**`use` / `import` / `alias` at module level:**
- Line 1: `require Ecto.Query` (file-level, outside module)
- Line 2: `require Ecto.Adapters.SQL` (file-level, outside module)
- Line 6: `use Ecto.Schema`
- Line 7: `import Ecto.Changeset`
- Line 8: `alias ApiServer.Vx`

---

### Checklist Review — `vx_thing.ex`

**§1: Secrets and Configuration**
No hardcoded credentials, API keys, or secrets. No config references. §1: No issues found.

**§2: Authentication and Authorization**
This is a schema/context module. No direct auth logic. The `changeset/2` does not include `:aadcustomerid` in its cast list, which is the correct defensive posture — customer ID cannot be changed through the standard changeset. However, `convert_json_to_changeset/1` builds a raw map from user-supplied JSON with no validation of types or bounds, and the `changeset/2` does not call `validate_required/2` for any field — no field is marked required. The absence of `validate_required` is a data-quality issue but not a direct security finding. The customer-scoping concern is addressed in the controller layer (reviewed separately). §2: No issues found in this file.

**§3: Input Validation and Injection**
`convert_json_to_changeset/1` (lines 60–73) directly maps user-supplied JSON values into a changeset map via `Vx.update_key_if_value/3`. There is no type coercion or validation in this function itself — that is deferred to `changeset/2` which uses `cast/3`. No raw SQL interpolation in this file. No `String.to_atom/1`, `binary_to_term`, or `Code.eval_string` calls. `require Ecto.Adapters.SQL` is present at the top of the file (line 2) but is never used within the module body — a dead `require`. §3: No exploitable issues in this file.

**§4: Session and CSRF**
Schema module — not applicable. §4: No issues found.

**§5: File and Data Handling**
No `Logger` calls. The schema contains GPS range fields (`:aadrange_lat`, `:aadrange_long`) and IMEI (`:aadimei`) and mobile number (`:aadmobile`) — these are PII/device-identity fields. No Logger calls emit these fields in this file. §5: No issues found in this file.

**§6: Dependencies**
No dependency declarations. §6: No issues found.

**§7: Infrastructure Exposure**
No hardcoded hostnames, IPs, or TLS config. §7: No issues found.

---

## File 2: `lib/api_server/vx/vx_thing_event.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingEvent`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `map_xml` | 1 | 71 |
| `changeset` | 2 | 111 |

**Schema defined — `schema "thingevents"`:**

Fields:
- `:id` (default integer primary key, auto)
- `:gmtdatetime` (:utc_datetime)
- `:hardwareid` (:integer)
- `:eventtype` (:integer)
- `:eventcode` (:integer)
- `:latitude` (:float)
- `:longitude` (:float)
- `:driverid` (:string)
- `:engineonelapsed` (:integer)
- `:totalengineseconds` (:integer)
- `:custcode` (:string)
- `:hardwaretype` (:integer)
- `:datetimesaved` (:utc_datetime)
- `:dateinqueue` (:utc_datetime)
- `:timeoffix` (:utc_datetime)
- `:altitude` (:integer)
- `:heading` (:float)
- `:speed` (:float)
- `:rssi` (:integer)
- `:gpsfixquality` (:integer)
- `:odometer` (:integer)
- `:mifaredriverid` (:string)
- `:ignition` (:integer)
- `:ignitionstatus` (:string)
- `:calcengineseconds` (:integer)
- `:input1elapsed` (:integer)
- `:input1status` (:string)
- `:input1totalseconds` (:integer)
- `:input1calctotalseconds` (:integer)
- `:input2elapsed` (:integer)
- `:input2status` (:string)
- `:input2totalseconds` (:integer)
- `:input2calctotalseconds` (:integer)
- `:input3elapsed` (:integer)
- `:input3status` (:string)
- `:input3totalseconds` (:integer)
- `:input3calctotalseconds` (:integer)
- `:input4elapsed` (:integer)
- `:input4status` (:string)
- `:input4totalseconds` (:integer)
- `:input4calctotalseconds` (:integer)
- `:prntelapsed` (:integer)
- `:prntstatus` (:string)
- `:prnttotalseconds` (:integer)
- `:prntcalctotalseconds` (:integer)
- `:rhmprestartchecklist` (:string)
- `:geofence` (:string)

Associations:
- `has_one :thingeventomega` (VXThingEventOmega, foreign_key: :id, references: :id)
- `belongs_to :thing` (VXThing, foreign_key: :hardwareid, references: :aadhardwareid, define_field: false)

**`use` / `import` / `alias` at module level:**
- Line 2: `use Ecto.Schema`
- Line 3: `import Ecto.Changeset`

---

### Checklist Review — `vx_thing_event.ex`

**§1: Secrets and Configuration**
No credentials or secrets. §1: No issues found.

**§2: Authentication and Authorization**
Schema/context module. The `map_xml/1` function (lines 71–108) processes an incoming XML-sourced data map. It sets `:custcode` directly from `data["custcode"]` (line 99) with no validation — a device-submitted message can declare any customer code string. The calling context (verified in `calamp_controller.ex` and `digital_matter_controller.ex`, outside audit scope) determines whether this is validated; however the schema itself provides no guard. The `changeset/2` includes `:custcode` as castable, meaning any caller who passes `:custcode` via attrs can write any customer code. This is flagged as a data-integrity / IDOR risk — see A083-2.

**§3: Input Validation and Injection**
`map_xml/1` uses `String.to_integer/1` and `String.to_float/1` directly on external device input (lines 79–98). These functions raise `ArgumentError` if the input is not parseable — they are not the safe `Integer.parse/1` / `Float.parse/1` variants that return `{:ok, val} | :error`. A device or attacker sending a malformed field value (e.g., an empty string or a non-numeric string) will crash the calling process. See A083-1. No raw SQL, no `String.to_atom`, no `binary_to_term`. §3: A083-1 raised.

**§4: Session and CSRF**
Not applicable. §4: No issues found.

**§5: File and Data Handling**
The schema stores GPS coordinates (`:latitude`, `:longitude`, `:altitude`, `:heading`, `:speed`), driver identity (`:driverid`, `:mifaredriverid`), and vehicle tracking data. No `Logger` calls are present in this file. No PII leakage via Logger in this file. §5: No issues found in this file.

**§6: Dependencies**
No dependency declarations. §6: No issues found.

**§7: Infrastructure Exposure**
No hardcoded hostnames or IPs. §7: No issues found.

---

## File 3: `lib/api_server/vx/vx_thing_event_omega.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingEventOmega`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `changeset` | 2 | 72 |

**Schema defined — `schema "thingomega"`:**

Fields:
- `:id` (default integer primary key — note: also used as the join key to `thingevents.id`)
- `:accelerometerx` (:float)
- `:accelerometery` (:float)
- `:accelerometerz` (:float)
- `:distancesincelastevent` (:integer)
- `:omegadriverid` (:string)
- `:seatbelt` (:integer)
- `:seated` (:integer)
- `:parkbrakerequest` (:integer)
- `:parkbreakreleased` (:integer)
- `:vehicleload` (:float)
- `:tilt` (:integer)
- `:height` (:integer)
- `:overload` (:integer)
- `:attretracted` (:integer)
- `:yellowled` (:integer)
- `:redled` (:integer)
- `:greenled` (:integer)
- `:liftenable` (:integer)
- `:safetyoverride` (:integer)
- `:doorclosed` (:integer)
- `:parkbrakerror` (:integer)
- `:batterynotcharged` (:integer)
- `:lowengineoil` (:integer)
- `:accnotcharged` (:integer)
- `:hydraulicfilgerblocked` (:integer)
- `:airfilterblocked` (:integer)
- `:attpressure` (:integer)
- `:oilcoolerfan` (:integer)
- `:lowerinterruption` (:integer)
- `:undersafetyheight` (:integer)
- `:joystickliftposition` (:integer)
- `:hydraulicoiltemperature` (:float)
- `:md3temperature` (:float)
- `:fuellevel` (:integer)
- `:md3status` (:integer)
- `:xa2status` (:integer)
- `:batteryvoltage` (:float)
- `:xa2temperature` (:float)
- `:boomangle` (:float)
- `:boomextension` (:integer)
- `:lift` (:integer)
- `:extension` (:integer)
- `:totalfuelconsumption` (:float)
- `:fuelrate` (:float)
- `:totalfuelidle` (:float)
- `:totalidlehour` (:float)
- `:totalenginehour` (:float)
- `:enginerpm` (:integer)
- `:capacity` (:integer)
- `:coolanttemperature` (:float)
- `:oiltemperature` (:float)
- `:engineerrorcode` (:string)
- `:vehiclespeed` (:integer)
- `:gearselection` (:integer)
- `:transerrorcode` (:string)
- `:prestartchecklist` (:integer)
- `:truckerrorcode` (:string)
- `:mc43status` (:integer)
- `:mc43temperature` (:integer)
- `:lc5status` (:integer)
- `:lc5temperature` (:integer)
- `:truckangle` (:float)

Association:
- `belongs_to :thingevent` (VXThingEvent, foreign_key: :id, references: :id, primary_key: true, define_field: false)

**`use` / `import` / `alias` at module level:**
- Line 2: `use Ecto.Schema`
- Line 3: `import Ecto.Changeset`

---

### Checklist Review — `vx_thing_event_omega.ex`

**§1: Secrets and Configuration**
No credentials or secrets. §1: No issues found.

**§2: Authentication and Authorization**
Schema module. `changeset/2` (line 72–76) includes `:id` in the cast list (line 74). The `:id` field is the primary key of `thingomega` and is also the foreign key linking to `thingevents.id`. Casting `:id` from user/device-supplied attrs means an external caller can supply an arbitrary event ID to force the omega record to associate with any event row in the database — a direct IDOR/record-hijacking vector. See A083-3.

**§3: Input Validation and Injection**
`changeset/2` casts a very large set of fields (line 74) including `:id`. `validate_required/2` only requires `:id`. No type validation beyond what Ecto's `cast/3` provides. No raw SQL, no `String.to_atom`, no `binary_to_term`. The only security concern is the castable `:id` — see A083-3.

**§4: Session and CSRF**
Not applicable. §4: No issues found.

**§5: File and Data Handling**
The schema records rich forklift telemetry: accelerometer axes, vehicle load, driver ID (`:omegadriverid`), safety override state (`:safetyoverride`), boom angles, engine RPM, fuel consumption, error codes. No `Logger` calls present in this file. §5: No issues found in this file.

**§6: Dependencies**
No dependency declarations. §6: No issues found.

**§7: Infrastructure Exposure**
No hardcoded hostnames or IPs. §7: No issues found.

---

## Cross-File and Controller-Layer Findings

The following findings arise from reviewing the assigned schema files in conjunction with their direct consumers (the controllers that use these schemas), which is required to fully evaluate §2 and §5 per the checklist.

### §2 — Unauthenticated Routes Serving Fleet Data

From `lib/api_server_web/router.ex` (lines 29–31), two routes are placed **before** `pipe_through([:api, :authenticated])` in the `/api/v1` scope:

```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)

  pipe_through([:api, :authenticated])
  ...
```

`combined_engine_usage` (controller lines 453–601) and `monday_hour_meters` (lines 377–436) both accept a `customers` query parameter as a comma-separated string, iterate over the supplied customer codes, call `Vx.list_vxthings_full(customer)` / `Vx.list_vxthings(customer)`, and return vehicle-level data including GPS coordinates (`:latitude`, `:longitude`), hour meter readings, serial numbers, and vehicle names — with **no authentication at all**. See A083-4.

### §2 — Unscoped `show` Action on VXThing

`VXThingController.show/2` (controller line 83–85) calls `Vx.get_vx_thing_with_hardware_id!(hardwareid)` — the **single-arity overload** (vx.ex line 1337–1345) which does **not** accept a `customer` prefix, querying the default schema with no customer scoping. This means a hardwareid from any customer can be retrieved by any authenticated user. See A083-5.

### §2 — Unscoped `VXThingEventController.index`

`VXThingEventController.index/2` (controller lines 9–12) calls `Vx.list_vxthingevents()` with no customer parameter, returning all `thingevents` rows across all customers to any authenticated user. This exposes GPS, driver, and vehicle data across customer boundaries. See A083-6.

### §5 — Internal Details Leaked in Error Responses

`VXThingController.create_thing/2` (line 250) and `VXThingController.update_thing/2` (line 278) return the full `inspect(changeset)` / `inspect(result)` in the HTTP response body on error:

```elixir
send_resp(conn, :internal_server_error,
  "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")
```

An Ecto changeset inspect output contains the schema struct with all field values, the repo module name, and potentially the full SQL error string from the database driver. This discloses internal schema structure, table/column names, and data values to API clients. See A083-7.

### §5 — `IO.puts` / `IO.inspect` Logging Device and Vehicle Data

`VXThingEventController.add_calculated_fields/2` (lines 78–80) uses `IO.puts/1` to write device hardware ID and hourmeter values to stdout. In production this goes to the Erlang VM log which may be captured by log aggregators without the controls applied to `Logger`. `write_partial_record/3` (line 67) calls `IO.inspect(changeset)` on error — again potentially emitting vehicle event data to stdout. While these are not `Logger` calls, they represent uncontrolled data emission. See A083-8.

---

## Findings Summary

### A083-1 — HIGH — Unsafe Parse Functions on Device Input in `map_xml/1`

**File:** `lib/api_server/vx/vx_thing_event.ex`, lines 79–98
**Section:** §3 Input Validation

`VXThingEvent.map_xml/1` uses `String.to_integer/1` and `String.to_float/1` on multiple fields sourced from external device-submitted data (`data["hardwareId"]`, `data["latitude"]`, `data["longitude"]`, etc.). Both functions raise `ArgumentError` (not `{:error, reason}`) when the input is not a valid numeric string. If a device or a man-in-the-middle submits a blank, `nil`, or non-numeric value for any mapped field, the calling process crashes.

In an OTP supervisor tree this means the process restarts, but in high-frequency device event ingestion the crashes will be logged and may exhaust supervisor restart budgets (max_restarts), causing the ingestion pipeline to go down. This is a denial-of-service vector against device data ingestion.

**Evidence:**
```elixir
hardwareid: String.to_integer(data["hardwareId"]),   # line 79
latitude:   String.to_float(data["latitude"]),       # line 82
longitude:  String.to_float(data["longitude"]),      # line 83
altitude:   String.to_integer(data["altitude"]),     # line 84
speed:      String.to_float(data["speed"]),          # line 85
```

**Recommendation:** Replace `String.to_integer/1` with `Integer.parse/1` and `String.to_float/1` with `Float.parse/1`, handling the `:error` return. Alternatively use a dedicated parsing/validation step that returns `{:ok, event} | {:error, reason}` before inserting.

---

### A083-2 — MEDIUM — Customer Code Accepted from Device-Submitted Payload in `map_xml/1`

**File:** `lib/api_server/vx/vx_thing_event.ex`, line 99
**Section:** §2 Authorization / §3 Input Validation

`map_xml/1` assigns `:custcode` directly from the device payload:

```elixir
custcode: data["custcode"],
```

The `changeset/2` also includes `:custcode` in the castable field list (line 143). This means any device or service that can POST to the event ingestion endpoint can declare an arbitrary customer code in the persisted event record. If downstream queries use `:custcode` to scope data retrieval, a tampered device message could cause event records to appear under a different customer's namespace.

**Recommendation:** The `:custcode` on an ingested event should be derived from the authenticated device/hardware identity (looked up from `aad_thing.aadcustcode`), not taken verbatim from the submitted payload. Remove `:custcode` from the `map_xml/1` mapping and from the castable field list if it is derived server-side.

---

### A083-3 — HIGH — Primary Key `:id` Is Castable in `VXThingEventOmega.changeset/2`

**File:** `lib/api_server/vx/vx_thing_event_omega.ex`, line 74
**Section:** §2 Authorization / IDOR

The `changeset/2` function includes `:id` in the `cast/3` field list:

```elixir
|> cast(attrs, [:accelerometerx, ..., :id, ...])
|> validate_required([:id])
```

The `:id` field is both the primary key of the `thingomega` table and the foreign key linking the omega record to `thingevents.id`. Because `:id` is castable from `attrs`, a caller who constructs the attrs map (e.g., from a device message or a crafted API call) can supply an arbitrary integer ID. This allows:

1. **Record hijacking:** associating an omega data payload with any event in `thingevents`, potentially overwriting or spoofing sensor data for another customer's vehicle event.
2. **IDOR:** if the omega record insert/update path does not independently verify the referenced `thingevents.id` belongs to the same customer, cross-customer data can be written.

**Recommendation:** Remove `:id` from the `cast/3` list. The `:id` for a new omega record should be set equal to the parent `thingevents.id` by the caller after that event is created, not from user/device-controlled input. Use `put_change/3` server-side rather than `cast/3`.

---

### A083-4 — CRITICAL — Unauthenticated Endpoints Return Multi-Customer Fleet and GPS Data

**File:** `lib/api_server_web/router.ex`, lines 29–32
**Controllers:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 377–436, 453–601
**Section:** §2 Authentication and Authorization / §5 Fleet Data Scoping

Two routes are registered in the `/api/v1` scope **before** the `pipe_through([:api, :authenticated])` call, making them publicly accessible with no authentication:

```
GET /api/v1/rhm/engine_usage
GET /api/v1/rhm/monday_hour_meters
```

`combined_engine_usage` accepts a `customers` query parameter (comma-separated customer code list) and returns per-vehicle daily engine usage data including customer code and hardware ID for all listed customers.

`monday_hour_meters` returns per-vehicle weekly GPS coordinates (latitude, longitude), vehicle names, hourmeter readings, and last-reported timestamps for all listed customers.

Neither action validates the caller's identity or verifies that the requesting party is authorised to access the listed customer codes. Any unauthenticated party on the network who can reach the API can enumerate vehicle GPS positions, names, and hour meters for any customer code they can guess or enumerate.

The comment in the router — `# Avoid authentication, locking to a specific database` — suggests this was intentional but does not justify the absence of authentication for endpoints that expose live GPS and fleet data.

**Recommendation:** Move these routes inside the `pipe_through([:api, :authenticated])` block. Add customer-scope validation so the authenticated user's `customer` claim is verified against the requested customer codes, or restrict these endpoints to an admin/internal role.

---

### A083-5 — HIGH — Unscoped `VXThingController.show/2` Queries Across Customer Boundaries

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 83–86
**Callee:** `lib/api_server/vx/vx.ex`, line 1337
**Section:** §2 IDOR / §5 Fleet Data Scoping

`VXThingController.show/2` calls the single-arity `Vx.get_vx_thing_with_hardware_id!(hardwareid)` which does not apply a customer prefix:

```elixir
def show(conn, %{"id" => hardwareid}) do
  vx_thing = Vx.get_vx_thing_with_hardware_id!(hardwareid)
  render(conn, "show.json", vx_thing: vx_thing)
end
```

```elixir
def get_vx_thing_with_hardware_id!(hardwareid) do
  VXThing
    |> Ecto.Query.where(aadhardwareid: ^hardwareid)
    ...
    |> Repo.one   # no prefix: customer
end
```

An authenticated user from customer A can query `GET /vx/things/:hardwareid` (or equivalent REST resource route) with a hardware ID belonging to customer B and receive that customer's vehicle data. The two-arity variant `get_vx_thing_with_hardware_id!(hardwareid, customer)` exists and is used by the majority of other actions — the `show/2` action appears to have been an oversight in using the unscoped variant.

**Recommendation:** Change `show/2` to extract `customer` from `Guardian.Plug.current_claims(conn)["customer"]` and call the two-arity `Vx.get_vx_thing_with_hardware_id!(hardwareid, customer)`.

---

### A083-6 — HIGH — `VXThingEventController.index/2` Returns All Events Across All Customers

**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, lines 9–12
**Section:** §2 IDOR / §5 Fleet Data Scoping

```elixir
def index(conn, _params) do
  vxthingevents = Vx.list_vxthingevents()
  render(conn, "index.json", vxthingevents: vxthingevents)
end
```

`Vx.list_vxthingevents/0` (not inspected in the assigned files, but the pattern is consistent with other `list_*` functions) almost certainly performs an unscoped `Repo.all(VXThingEvent)` across all customer schemas or the default schema. The `thingevents` table contains GPS coordinates, driver IDs, ignition status, speed, altitude, heading, and vehicle usage data. Any authenticated user — regardless of their customer — can call this endpoint and receive all event records.

**Recommendation:** Remove or gate this endpoint. If it is needed, scope it by extracting the customer from the JWT claims and applying the customer prefix via `Repo.all(prefix: customer)`.

---

### A083-7 — MEDIUM — Ecto Changeset / Internal Error Details Returned to API Client

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 250, 278
**Section:** §5 Information Disclosure

On insertion or update failure, the full `inspect(changeset)` or `inspect(result)` is interpolated directly into the HTTP 500 response body:

```elixir
send_resp(conn, :internal_server_error,
  "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")
```

`inspect` on an Ecto changeset produces a string that includes: module names, table/schema names, all field values present at the time of the changeset, the changeset errors map, and any database constraint error messages from the underlying MySQL driver. This information assists an attacker in mapping internal data structures and understanding database schema details.

**Recommendation:** Replace `inspect(changeset)` with a sanitised error message. Ecto changeset errors can be safely extracted with `changeset.errors` and rendered without leaking internal struct details. Log the full changeset internally via `Logger.error/2` and return only a generic error description to the client.

---

### A083-8 — LOW — `IO.puts` / `IO.inspect` Emitting Device and Vehicle Data Outside Logger

**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, lines 62, 67, 78–80
**Section:** §5 Data Handling

`IO.puts("Inserted")` (line 62), `IO.inspect(changeset)` (line 67), and `IO.puts("totalengineseconds is nil for #{record_to_add.hardwareid} but aadhourmeter is set to #{vx_thing.aadhourmeter}...")` (lines 78–80) write to stdout directly rather than via `Logger`.

The `IO.puts` on lines 78–80 emits a hardware ID and an aadhourmeter float value. The `IO.inspect(changeset)` call on line 67 can emit a full event changeset struct including latitude, longitude, driverid, and custcode on insert failure.

`Logger` calls respect the configured log level, can be compiled out in production, and are captured by log management tooling (e.g., CloudWatch Logs with structured filtering). Raw `IO` calls bypass all of these controls and go directly to the BEAM console/stdout stream, potentially landing in unfiltered log aggregators or operator terminals without PII controls applied.

**Recommendation:** Replace all `IO.puts` and `IO.inspect` calls in production code paths with `Logger.debug/2`, `Logger.info/2`, or `Logger.error/2` as appropriate. For the changeset error case, avoid logging full struct values — log only the error reason map.

---

## Summary Table

| ID | Severity | Section | File | Description |
|---|---|---|---|---|
| A083-1 | HIGH | §3 | vx_thing_event.ex | `String.to_integer/1` / `String.to_float/1` raise on malformed device input — DoS vector in event ingestion pipeline |
| A083-2 | MEDIUM | §2/§3 | vx_thing_event.ex | `:custcode` accepted verbatim from device payload in `map_xml/1`; should be derived server-side from hardware identity |
| A083-3 | HIGH | §2 | vx_thing_event_omega.ex | Primary key `:id` is castable in `changeset/2`, enabling IDOR / record hijacking on the `thingomega` table |
| A083-4 | CRITICAL | §2/§5 | router.ex / vx_thing_controller.ex | Two endpoints (`engine_usage`, `monday_hour_meters`) are fully unauthenticated and return multi-customer GPS and fleet data |
| A083-5 | HIGH | §2/§5 | vx_thing_controller.ex | `show/2` uses unscoped `get_vx_thing_with_hardware_id!/1` — any authenticated user can retrieve any customer's vehicle record |
| A083-6 | HIGH | §2/§5 | vx_thing_event_controller.ex | `index/2` calls unscoped `list_vxthingevents()` — returns GPS, driver, and vehicle event data across all customers |
| A083-7 | MEDIUM | §5 | vx_thing_controller.ex | `inspect(changeset)` / `inspect(result)` returned in HTTP 500 body — discloses internal schema structure and data values |
| A083-8 | LOW | §5 | vx_thing_event_controller.ex | `IO.puts` / `IO.inspect` emit hardware ID, hourmeter, and changeset data to stdout outside Logger controls |

<!-- A086.md -->
# Security Audit Pass 1 — Agent A086
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Auditor:** A086

---

## Files Reviewed

1. `lib/api_server/vx/vx_thing_event_omega_tires.ex`
2. `lib/api_server/vx/vx_thing_info.ex`
3. `lib/api_server/vx/vx_thing_summary.ex`

---

## File 1: `lib/api_server/vx/vx_thing_event_omega_tires.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingEventOmegaTires`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `changeset` | 2 | 58 |

**Schema defined:** `"thingomegatires"` (Ecto schema, no explicit primary key — inherits default `id`)

Schema fields:
- `:pressurewarning0` — `:integer`
- `:pressureleakage0` — `:integer`
- `:temperaturehigh0` — `:integer`
- `:receivetimeout0` — `:integer`
- `:carbatteryvoltageexceed0` — `:integer`
- `:sensorbatteryvoltagelow0` — `:integer`
- `:tirepressure0` — `:integer`
- `:temperature0` — `:integer`
- *(fields 1–5 repeat the same 8 fields with suffix 1 through 5)*
- `:pressurewarning1` through `:temperature5` — `:integer` (40 fields total, 8 per tire × 6 tires)
- `belongs_to :thingevent` — `ApiServer.Vx.VXThingEvent` with `foreign_key: :id, references: :id, primary_key: true, define_field: false`

**use / import / alias at module level:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

---

### Checklist Review

**§1: No issues found.**

**§2: No issues found.** (Schema/changeset module only; no authentication logic.)

**§3:**

> **A086-1** — LOW — Missing validation on all sensor fields in changeset.

`changeset/2` at line 60 casts all 48 sensor fields plus `:id` but calls `validate_required` only for `:id`. None of the sensor integer fields have `validate_number` bounds checks. Values such as `:tirepressure0`, `:temperature0`, etc. are accepted at any integer value, including negatives or impossibly large values. While this is a data-integrity concern rather than a direct injection risk (Ecto parameterises the insert), it means malformed telemetry data written via this changeset is not rejected. This could corrupt fleet analytics or trigger incorrect pressure/temperature alerts.

**§4: No issues found.**

**§5: No issues found.**

**§6: No issues found.**

**§7: No issues found.**

---

## File 2: `lib/api_server/vx/vx_thing_info.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingInfo`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `getWithHardwareId` | 2 | 24 |
| `service_performed` | 3 | 31 |
| `[REDACTED-AWS-SMTP-PASSWORD]` | 2 | 47 |
| `make_info_record` | 2 | 57 |
| `update_existing_record` | 3 | 74 |

**Schema defined:** `"thing_info"` with `@primary_key {:id, :id, autogenerate: true}`

Schema fields:
- `:averageweeklyusage` — `:float`
- `:pmnotificationid` — `:integer`
- `:pmnotificationdate` — `:date`
- `:usagesincenotification` — `:integer`
- `belongs_to :thing` — `VXThing` with `foreign_key: :hardwareid, references: :aadhardwareid`

**use / import / alias at module level:**
- `use Ecto.Schema`
- `import Ecto.Changeset`
- `require Ecto.Query`
- `require Ecto.Adapters.SQL`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXThing`
- `alias ApiServer.Vx.VXThingInfo`
- `alias ApiServer.Repo`

---

### Checklist Review

**§1:**

> **A086-2** — LOW — Hardcoded magic date and notification ID in `make_info_record/2`.

At lines 59 and 67, `make_info_record/2` initialises new `thing_info` records with a hardcoded `notification_date = ~D[2019-01-13]` and `pmnotificationid: 12`. These values are not configurable and are baked into production code. Any device that does not yet have a `thing_info` record will receive a fabricated historical PM notification dated 2019-01-13 with a fixed ID of 12. This is a data-integrity issue: it may cause incorrect PM service notifications to be presented to end-users or customers, and could mask legitimate PM state for fleet operators. It is not a security vulnerability per se but is flagged as LOW because it could affect business logic that drives customer-facing alerts.

**§2: No issues found.** (No authentication or authorisation logic in this module itself; `customer` is passed through as the Postgres schema prefix by callers.)

**§3:**

> **A086-3** — MEDIUM — `require Ecto.Adapters.SQL` present but no corresponding safe usage; unused `require` implies intent.

`Ecto.Adapters.SQL` is required at line 7 but is not directly called anywhere in this file. Its presence alongside `require Ecto.Query` suggests it was previously used (or is planned to be used) for raw SQL execution. While no active raw-SQL call is present here, the `require` should be removed to reduce the attack surface and avoid confusion during future maintenance. If raw SQL is introduced later, reviewers may not scrutinise it carefully because the `require` is already present. Classified MEDIUM because it is an indicator of unsafe pattern intent rather than an active vulnerability.

**§3 (continued):**

> **A086-4** — MEDIUM — No changeset-based validation on `Ecto.Changeset.change/2` calls in `make_info_record/2` and `update_existing_record/3`.

At lines 70, 92, and 43, all writes to the `thing_info` table use `Ecto.Changeset.change/2` (not `Ecto.Changeset.cast/3`). `Ecto.Changeset.change/2` performs no type-coercion, no validation, and no whitelist enforcement; it directly merges the provided map into the struct. If the `params` map in `make_info_record/2` or `update_existing_record/3` ever contains unexpected keys (e.g. due to upstream change), those keys will be silently included. The module also defines a `changeset/2` function (not shown — absent from this file; no public `changeset` def is present), but it is never called for these write paths. Writes should pass through a validated changeset.

**§4: No issues found.**

**§5:**

> **A086-5** — MEDIUM — `[REDACTED-AWS-SMTP-PASSWORD]` and `averageweeklyusage` are fleet operational data that flow through logging-visible code paths without PII audit trail, but no direct Logger leak is visible in this file. No issue within scope of this file.

Specifically: no `Logger` calls are present in `vx_thing_info.ex`. No PII leak found within this file.

**§5: No issues found** (within this file).

**§6: No issues found.**

**§7: No issues found.**

---

## File 3: `lib/api_server/vx/vx_thing_summary.ex`

### Reading Evidence

**Module name:** `ApiServer.Vx.VXThingSummary`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `changeset` | 2 | 49 |
| `make_or_update_summary` | 2/3 (default arg) | 56 |
| `validate_for_hardwareid` | 2 | 138 |
| `is_valid?` | 2 | 156 |

**Schema defined:** `"abm_summary"` with `@primary_key {:abmid, :id, autogenerate: true}`

Schema fields:
- `:abmgmtdatetime` — `:utc_datetime`
- `:abmdesc` — `:string`
- `:abmignitionstatus` — `:string`
- `:abmeventtype` — `:integer`
- `:abmeventcode` — `:integer`
- `:abmtotalengineseconds` — `:integer`
- `:abmcalctotalengineseconds` — `:integer`
- `:abmtotalenginesecondssinceservice` — `:integer`
- `:abmhourmeter1` — `:integer`
- `:abmcalchourmeter1` — `:integer`
- `:abmhourmeter1sinceservice` — `:integer`
- `:abmhourmeter2` — `:integer`
- `:abmcalchourmeter2` — `:integer`
- `:abmhourmeter2sinceservice` — `:integer`
- `:abmhourmeter3` — `:integer`
- `:abmcalchourmeter3` — `:integer`
- `:abmhourmeter3sinceservice` — `:integer`
- `:abmhourmeter4` — `:integer`
- `:abmcalchourmeter4` — `:integer`
- `:abmhourmeter4sinceservice` — `:integer`
- `:abmodometer` — `:integer`
- `:abmcalcodometer` — `:integer`
- `:abmodometersinceservice` — `:integer`
- `:abmlatitude` — `:float`
- `:abmlongitude` — `:float`
- `:abmheading` — `:float`
- `:abmspeed` — `:float`
- `:abmdriverid` — `:string`
- `:abmmifaredriverid` — `:string`
- `:abmcustcode` — `:string`
- `:abmusagesinceservice` — `:float`
- `:abmhourmeteromega` — `:float`
- `:abmcalchourmeteromega` — `:float`
- `:abmhourmeterothcan` — `:float`
- `:abmcalchourmeterothcan` — `:float`
- `:abmrhmprestartlastgmt` — `:utc_datetime`
- `:abmrhmprestartchecklist` — `:string`
- `belongs_to :thing` — `ApiServer.Vx.VXThing` with `foreign_key: :abmhardwareid, references: :aadhardwareid`

**use / import / alias at module level:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

---

### Checklist Review

**§1: No issues found.**

**§2:**

> **A086-6** — HIGH — `VXThingSummaryController.index/2` and `show/2` are in an unauthenticated scope and return cross-tenant fleet data including GPS coordinates, driver IDs, and odometer readings.

`[REDACTED-AWS-SMTP-PASSWORD]` is mounted at line 162 of `router.ex` inside the second `scope "/api/v1"` block at line 156, which uses only `pipe_through(:api)`. The `:authenticated` pipeline (`ApiServer.Guardian.AuthPipeline`) is NOT applied to this scope. As a result, the following actions are completely unauthenticated:

- `index` (line 9–11) — calls `Vx.list_vxthingsummaries()` which executes `Repo.all(VXThingSummary)` with no `prefix:` argument, returning ALL summary records for ALL customers.
- `show` (line 23–25) — calls `Vx.get_vx_thing_summary!(id)` with no customer scoping.
- `create` (line 14–21) — creates a summary record with no authentication.
- `update` (line 28–33) — updates any summary record by ID with no authentication.
- `delete` (line 36–40) — deletes any summary record by ID with no authentication.

The `abm_summary` table schema contains: GPS latitude/longitude (`:abmlatitude`, `:abmlongitude`), driver ID (`:abmdriverid`), Mifare driver ID (`:abmmifaredriverid`), customer code (`:abmcustcode`), heading, speed, odometer, and engine hours. This is highly sensitive fleet operational and PII data. Any unauthenticated caller can enumerate all customer vehicle positions and driver records, and can modify or delete summary records for any vehicle across all tenants. This is a critical multi-tenant data breach vector.

Note: `list_vxthingsummaries` also does not accept a `customer` prefix, meaning this is a full cross-tenant data dump with no authentication and no tenant scoping.

> **A086-7** — HIGH — `VXThingInfoController.fix_infos/2` and related `get_info/2` are in an unauthenticated scope with no customer ownership verification.

`GET /api/v1/rhm/:customer/fix_info` (router line 176) is in the second scope block using only `pipe_through(:api)` — no authentication. The `customer` parameter comes directly from the URL path. An unauthenticated caller can trigger recalculation of PM notification records for any customer schema by supplying an arbitrary `customer` value. While `fix_infos/2` does not directly return data (returns `{}`), it performs DB writes against the supplied `customer` schema, potentially resetting or corrupting PM service state for any tenant.

Additionally, `get_info/2` at line 17 is defined in the controller but is not routed (no GET route for `/:customer/info/:id` exists in the router), however the function is public and accessible if a route is added without review.

**§3:**

> **A086-8** — MEDIUM — Unsafe `Integer.parse/1` result used as primary key field without validating remainder.

In `make_or_update_summary/3` at lines 66–71, when `hardwareid` is not already an integer, the code pattern-matches `{hardwareid_parsed, result} = Integer.parse(hardwareid)`. `Integer.parse/1` returns `{integer, remainder_string}` — if the input is `"123abc"`, `hardwareid_parsed` will be `123` and `result` will be `"abc"`. The variable `result` is assigned but never checked. The parsed integer `123` will then be inserted as `abmhardwareid` even though the original input `"123abc"` is not a valid integer hardware ID. This silently truncates malformed input and writes corrupted data to the summary table. Additionally, `Integer.parse/1` raises no error on non-integer strings but returns `:error` as an atom when the string starts with a non-digit — this would cause a match error (crash) if `hardwareid` is a non-numeric string like `"abc"`, since `:error` cannot be matched to `{hardwareid_parsed, result}`. This is both a data-integrity issue and a potential crash vector.

> **A086-9** — LOW — `validate_for_hardwareid/2` discards the return value of `make_or_update_summary/3`.

At line 150, inside `validate_for_hardwareid/2`, the result of `make_or_update_summary(hardwareid, customer, summary)` is the return value of `ApiServer.Vx.update_or_insert_summary/3`, which returns `{:ok, record}` or `{:error, changeset}`. Neither branch is pattern-matched; errors are silently swallowed. If the DB write fails (e.g., constraint violation, connection failure), the caller receives no indication. The unused variable `timestamp = Timex.now()` at line 149 (also never used) suggests incomplete implementation.

> **A086-10** — LOW — Dead/unused variable `timestamp` in `validate_for_hardwareid/2`.

Line 149: `timestamp = Timex.now()` is assigned but never used. This is dead code; it adds an unnecessary external call (`Timex.now()`) and suggests the function was not fully implemented before being committed.

**§4: No issues found** (no session or channel logic in this module).

**§5:**

> **A086-11** — HIGH — Schema contains GPS coordinates, driver IDs, and vehicle location data (`abmlatitude`, `abmlongitude`, `abmdriverid`, `abmmifaredriverid`) exposed via unauthenticated REST endpoints (cross-reference A086-6).

The `abm_summary` schema is the direct backing model for the unauthenticated `[REDACTED-AWS-SMTP-PASSWORD]`. The combination of unprotected endpoints and a schema containing PII (driver IDs, Mifare driver card IDs) and GPS location data constitutes an information disclosure vulnerability. This finding is raised here to note the schema-level concern; the endpoint-level finding is A086-6.

> **A086-12** — MEDIUM — `make_or_update_summary/3` writes GPS coordinates and driver identity to `abm_summary` using `Ecto.Changeset.change/2` (not `cast/3`), bypassing the module's own `changeset/2`.

The module defines `changeset/2` at line 49 with a field whitelist, but `make_or_update_summary/3` at line 135 calls `ApiServer.Vx.update_or_insert_summary/3`, which internally calls `Ecto.Changeset.change(existing_summary, attrs)` directly. This means the field-level cast whitelist in `changeset/2` is completely bypassed for all routine summary updates. Any field in the `updated_summary` map (including latitude, longitude, driver IDs) is written without going through `validate_required([:abmcustcode])` or any other changeset validation.

**§6: No issues found** (no dependency declarations in these files).

**§7: No issues found** (no TLS, CORS, or inter-service communication in these files).

---

## Summary of Findings

| ID | Severity | File | Description |
|---|---|---|---|
| A086-1 | LOW | vx_thing_event_omega_tires.ex | No bounds validation on sensor integer fields in changeset |
| A086-2 | LOW | vx_thing_info.ex | Hardcoded magic date (2019-01-13) and PM notification ID (12) in `make_info_record/2` |
| A086-3 | MEDIUM | vx_thing_info.ex | `require Ecto.Adapters.SQL` present but unused — raw SQL intent indicator |
| A086-4 | MEDIUM | vx_thing_info.ex | All DB writes use `Ecto.Changeset.change/2` instead of validated `cast/3`, bypassing schema validation |
| A086-5 | — | vx_thing_info.ex | (No Logger PII leak found in this file — no issue.) |
| A086-6 | HIGH | vx_thing_summary.ex (via router) | `[REDACTED-AWS-SMTP-PASSWORD]` index/show/create/update/delete are unauthenticated and cross-tenant; expose GPS, driver IDs, fleet data for all customers |
| A086-7 | HIGH | vx_thing_info.ex (via router) | `fix_infos` endpoint is unauthenticated; arbitrary `customer` schema can be targeted by any caller |
| A086-8 | MEDIUM | vx_thing_summary.ex | `Integer.parse/1` result remainder not validated; silently truncates malformed hardware IDs and will crash on non-numeric strings |
| A086-9 | LOW | vx_thing_summary.ex | DB write result from `make_or_update_summary/3` silently discarded in `validate_for_hardwareid/2` |
| A086-10 | LOW | vx_thing_summary.ex | Dead code: `timestamp = Timex.now()` assigned and never used at line 149 |
| A086-11 | HIGH | vx_thing_summary.ex | Schema contains GPS coordinates and driver PII exposed via unauthenticated endpoints (reinforces A086-6) |
| A086-12 | MEDIUM | vx_thing_summary.ex | `make_or_update_summary/3` writes all fields via `Ecto.Changeset.change/2`, bypassing the module's own `changeset/2` validation whitelist |

### Critical Issues: 0
### High Issues: 3 (A086-6, A086-7, A086-11)
### Medium Issues: 4 (A086-3, A086-4, A086-8, A086-12)
### Low Issues: 4 (A086-1, A086-2, A086-9, A086-10)

---

*End of report — Agent A086 — 2026-02-27-01*

<!-- A089.md -->
# Audit Report — A089
**Agent:** A089
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server/vx/vx_user.ex`
2. `lib/api_server/vx/vx_user_function.ex`
3. `lib/api_server_web.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server/vx/vx_user.ex`

**Module name:** `ApiServer.Vx.VXUser`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `convert_json_to_changeset/1` | 1 | 57 |
| `password_changeset/2` | 2 | 73 |
| `changeset/2` | 2 | 78 |

**Schema defined:** `schema "aac_user"` with `@primary_key {:aacid, :id, autogenerate: true}`

Schema fields:
- `:aaccustcode` — `:string`
- `:aacuser` — `:string`
- `:aacfname` — `:string`
- `:aacsurname` — `:string`
- `:aaccredte` — `:utc_datetime`
- `:aacexpdte` — `:date`
- `:aaclastupdated` — `:utc_datetime`
- `:aacpassword` — `:string`   *(plaintext password column)*
- `:aacpasswordhash` — `:string`   *(hash column present but unused in any changeset)*
- `:aacpasswordresetcode` — `:string`
- `:aactz` — `:string`
- `:aacfirstopt` — `:string`
- `:aacemail` — `:string`
- `:aacdash` — `:integer`
- `:aacpwdlastupd` — `:utc_datetime`
- `:aacuserdriver` — `:string`
- `:aaclic1` — `:string`
- `:aaclic1class` — `:string`
- `:aaclic1issuedate` — `:date`
- `:aaclic1expdate` — `:date`
- `:aaclic1issuer` — `:string`
- `:aaclic2` — `:string`
- `:aaclic2class` — `:string`
- `:aaclic2issuedate` — `:date`
- `:aaclic2expdate` — `:date`
- `:aaclic2issuer` — `:string`
- `:aacusertype` — `:string`
- `:aacproxyenabled` — `:string`
- `:aactimezone` — `:string`
- `:aacdeffleet` — `:integer`
- `:aacdateformat` — `:string`
- `:aachourformat` — `:integer`
- `:aaclang` — `:string`
- `:aacuom` — `:string`
- `:aacmaprefresh` — `:integer`

Associations:
- `has_one :accessfob, ApiServer.Vx.VXAccessFob, foreign_key: :assigned_to_user`
- `has_one :function, ApiServer.Vx.VXUserFunction, foreign_key: :aatuser_id, on_replace: :update`
- `has_many :assigned_fleets, ApiServer.Vx.VXRestriction, foreign_key: :aauuser_id`
- `has_many :abl_records, ApiServer.Vx.VXAblRecord, foreign_key: :abluser, references: :aacuser`

**use / import / alias at module level:**
- `use Ecto.Schema` (line 5)
- `import Ecto.Changeset` (line 7)
- `alias ApiServer.Vx` (line 9)

**Top-level requires (file level, outside defmodule):**
- `require Ecto.Query` (line 1)
- `require Ecto.Adapters.SQL` (line 2)

---

### File 2: `lib/api_server/vx/vx_user_function.ex`

**Module name:** `ApiServer.Vx.VXUserFunction`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `changeset/2` | 2 | 14 |

**Schema defined:** `schema "aat_user_functions"` with `@primary_key {:aatid, :id, autogenerate: true}`

Schema fields:
- `:aatfunction_id` — `:integer`
- `:aatuser_id` — `:integer`

Associations:
- `belongs_to :user, ApiServer.Vx.VXUser, foreign_key: :aatuser_id, references: :aacid, primary_key: true, define_field: false`

**use / import / alias at module level:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

---

### File 3: `lib/api_server_web.ex`

**Module name:** `ApiServerWeb`

**Public functions (def / defmacro):**

| Name | Arity | Line |
|---|---|---|
| `controller/0` | 0 | 20 |
| `view/0` | 0 | 29 |
| `router/0` | 0 | 46 |
| `channel/0` | 0 | 54 |
| `__using__/1` (defmacro) | 1 | 64 |

**Defstruct / schema:** None.

**use / import / alias at module level:** None at module level. All `use`/`import` directives are inside quoted blocks within each function.

Injected into controllers (via `controller/0` quote):
- `use Phoenix.Controller, namespace: ApiServerWeb`
- `import Plug.Conn`
- `import ApiServerWeb.Router.Helpers`
- `import ApiServerWeb.Gettext`

Injected into views (via `view/0` quote):
- `use Phoenix.View, root: "lib/api_server_web/templates", namespace: ApiServerWeb`
- `import Phoenix.Controller, only: [get_flash: 2, view_module: 1]`
- `use Phoenix.HTML`
- `import ApiServerWeb.Router.Helpers`
- `import ApiServerWeb.ErrorHelpers`
- `import ApiServerWeb.Gettext`

Injected into routers (via `router/0` quote):
- `use Phoenix.Router`
- `import Plug.Conn`
- `import Phoenix.Controller`

Injected into channels (via `channel/0` quote):
- `use Phoenix.Channel`
- `import ApiServerWeb.Gettext`

---

## Findings

---

### A089-1 — CRITICAL: Passwords stored and compared in plaintext

**File:** `lib/api_server/vx/vx_user.ex`
**Lines:** 21, 66, 75, 80

The schema defines a field `:aacpassword` of type `:string` alongside a separate `:aacpasswordhash` field. The `password_changeset/2` function casts directly into `:aacpassword` without any hashing step. The `changeset/2` function also casts `:aacpassword` directly. `convert_json_to_changeset/1` maps `user_json["password"]` straight into `:aacpassword`.

Cross-referencing `lib/api_server/vx/vx.ex` (lines 2707 and 2715, surfaced by grep), authentication queries compare the stored value with the incoming value using a simple `where` clause:

```elixir
|> Ecto.Query.where(aacpassword: ^password)
```

And `lib/api_server_web/controllers/vx_user_controller.ex` (line 65) writes a new password directly as a map value:

```elixir
changeset = %{aacpassword: new_password}
```

No bcrypt, argon2, Comeonin, or any other password hashing library is present in `mix.exs`. The `:aacpasswordhash` field exists in the schema but is never populated or used.

**Impact:** All user passwords are stored as plaintext (or at most in whatever format the legacy database uses). A database breach exposes every user credential directly. An attacker who can read the DB or intercept queries obtains all passwords immediately. This affects authentication across the entire fleet management platform.

**Checklist reference:** §2 — Authentication and Authorization (password hashing requirement: bcrypt or argon2).

---

### A089-2 — CRITICAL: Password reset tokens have no expiry and no single-use enforcement

**File:** `lib/api_server/vx/vx_user.ex`
**Line:** 23

The schema has a single field for password reset: `:aacpasswordresetcode` (type `:string`). There is no corresponding expiry timestamp field (e.g., `:aacpasswordresetexpiry`) in the schema, and grep across the entire codebase finds zero references to this field outside its schema declaration.

This means:
1. No evidence that a reset code is ever invalidated after use (single-use enforcement absent).
2. No evidence that a reset code carries or is checked against an expiry time (time-limiting absent).

A password reset code that never expires is a permanent backdoor. Once issued, it can be used at any time, indefinitely, even after the user has changed their password through normal means.

**Checklist reference:** §2 — Authentication and Authorization (password reset tokens must be time-limited and single-use).

---

### A089-3 — HIGH: `password_changeset/2` applies no validation

**File:** `lib/api_server/vx/vx_user.ex`
**Lines:** 73–76

```elixir
def password_changeset(user, attrs) do
    user
        |> cast(attrs, [:aacpassword])
end
```

The `password_changeset/2` function casts the new password but applies:
- No `validate_required/2` — an empty or nil password can be set.
- No minimum length validation.
- No complexity validation.
- No hashing (see A089-1).

The controller (`vx_user_controller.ex` line 64) does gate on `new_password != nil && new_password != ""`, but that guard is in application logic, not in the changeset, meaning the data layer offers no protection if this changeset is reused elsewhere.

**Checklist reference:** §2 — Authentication and Authorization; §3 — Input Validation.

---

### A089-4 — HIGH: `changeset/2` password field accepts arbitrary input with no hashing or validation

**File:** `lib/api_server/vx/vx_user.ex`
**Lines:** 78–86

The main `changeset/2` includes `:aacpassword` in the cast list alongside user profile fields. No hashing is applied. No length or complexity validation is applied to the password. A password can be set to any string (including empty) when creating or updating a user through this changeset.

**Checklist reference:** §2 — Authentication and Authorization; §3 — Input Validation.

---

### A089-5 — HIGH: `convert_json_to_changeset/1` maps raw user-supplied password without hashing

**File:** `lib/api_server/vx/vx_user.ex`
**Lines:** 57–71

```elixir
|> Vx.update_key_if_value(:aacpassword, user_json["password"])
```

This function constructs a map from raw JSON input (presumably from an HTTP request body) and places the plaintext password directly into `:aacpassword`. No sanitisation, no hashing, no validation. The function returns a plain map, not a changeset, so Ecto changeset validations are bypassed entirely at this stage.

**Checklist reference:** §2 — Authentication and Authorization; §3 — Input Validation.

---

### A089-6 — MEDIUM: `VXUserFunction.changeset/2` casts non-existent field `:aatfunctionid`

**File:** `lib/api_server/vx/vx_user_function.ex`
**Lines:** 14–18

```elixir
def changeset(vx_user_function, attrs) do
  vx_user_function
  |> cast(attrs, [:aatuser_id, :aatfunctionid])
  |> validate_required([:aatuser_id, :aatfunctionid])
end
```

The schema defines the field as `:aatfunction_id` (with underscore before `id`), but the changeset casts and validates `:aatfunctionid` (no underscore). Ecto will silently ignore the unknown field during `cast/3`, meaning the function ID is never actually written through this changeset. `validate_required` on an unknown field will always produce a validation error, making this changeset non-functional. While not directly a security vulnerability, this indicates the changeset has never been exercised in tests and may be masking a privilege assignment failure — user function (permission level) updates may silently fail.

**Checklist reference:** §3 — Input Validation (changeset correctness).

---

### A089-7 — MEDIUM: `__using__/1` macro dispatches to `apply(__MODULE__, which, [])` where `which` is caller-supplied atom

**File:** `lib/api_server_web.ex`
**Lines:** 64–66**

```elixir
defmacro __using__(which) when is_atom(which) do
  apply(__MODULE__, which, [])
end
```

This macro accepts any atom and calls `apply/3` on it as a function name within `ApiServerWeb`. The guard `when is_atom(which)` confirms the value is an atom but does not whitelist it to the four valid values (`controller`, `view`, `router`, `channel`).

In practice this is compile-time only (invoked as `use ApiServerWeb, :controller`), so runtime exploitation via user input is not possible through this path. However, it is a pattern to note: if any future code path constructs this `use` call with a dynamic atom, it becomes a function-name injection point. As written, it will call any zero-arity public function on `ApiServerWeb` at compile time if a caller passes an unexpected atom.

The risk is low in the current codebase but the pattern is architecturally unsafe. A whitelist match (`case which do :controller -> ... end`) would be the correct implementation.

**Checklist reference:** §3 — Input Validation (atom-based dispatch / `Kernel.apply/3` with caller-controlled function name).

---

### A089-8 — INFO: Dead/commented code contains legacy credentials in a neighbouring file

This finding is noted for cross-agent awareness. Grep surfaced `lib/api_server_web/controllers/utility_controller.ex` lines 3353–3356 and 3374, which contain commented-out credentials (`kz2xA8Y+n#btU*dk`) for a Rayven API integration. These are outside the assigned file set (they are in `utility_controller.ex`) and have been flagged here only for completeness; the assigned agent for that file should record the primary finding. No credentials were found in the three assigned files.

**Checklist reference:** §1 — Secrets and Configuration.

---

## Checklist Section Summary

| Section | Status |
|---|---|
| §1 Secrets and Configuration | No issues found in the three assigned files. |
| §2 Authentication and Authorization | CRITICAL findings A089-1, A089-2; HIGH findings A089-3, A089-4, A089-5. |
| §3 Input Validation and Injection | HIGH finding A089-5; MEDIUM findings A089-6, A089-7. |
| §4 Session and CSRF | No issues found in the three assigned files. |
| §5 File and Data Handling | No issues found in the three assigned files. |
| §6 Dependencies | Not applicable to these three files (reviewed separately). Note: no password hashing dependency present in mix.exs — supports A089-1. |
| §7 Infrastructure Exposure | No issues found in the three assigned files. |

<!-- A092.md -->
# Audit Report A092
**Agent:** A092
**Run:** 2026-02-27-01
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server_web/auth_error_handler.ex`
2. `lib/api_server_web/auth_pipeline.ex`
3. `lib/api_server_web/channels/user_socket.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/auth_error_handler.ex`

**Module name:** `ApiServerWeb.AuthErrorHandler`

**Public functions:**
| Name | Arity | Line |
|------|-------|------|
| `auth_error` | 3 | 4 |

**defstruct / defexception / schema:** None

**Plugs / pipeline entries:** None (this module is used as an error handler, not a plug itself)

**use / import / alias at module level:**
- `import Plug.Conn` (line 2)

---

### File 2: `lib/api_server_web/auth_pipeline.ex`

**Module name:** `ApiServer.Guardian.AuthPipeline`

**Public functions:** None (plug pipeline only)

**defstruct / defexception / schema:** None

**Plugs:**
| Plug | Options | Line |
|------|---------|------|
| `Guardian.Plug.VerifyHeader` | `realm: "Bearer"` | 6 |
| `Guardian.Plug.EnsureAuthenticated` | *(commented out)* | 7 |
| `Guardian.Plug.LoadResource` | *(none)* | 8 |

**use / import / alias at module level:**
- `use Guardian.Plug.Pipeline, otp_app: :MyApi, module: ApiServer.Guardian, error_handler: ApiServerWeb.AuthErrorHandler` (lines 2–4)

---

### File 3: `lib/api_server_web/channels/user_socket.ex`

**Module name:** `ApiServerWeb.UserSocket`

**Public functions:**
| Name | Arity | Line |
|------|-------|------|
| `connect` | 2 | 22 |
| `id` | 1 | 36 |

**defstruct / defexception / schema:** None

**Plugs / pipeline entries:**
- `transport :websocket, Phoenix.Transports.WebSocket` (line 8)
- `transport :longpoll, Phoenix.Transports.LongPoll` (commented out, line 9)

**use / import / alias at module level:**
- `use Phoenix.Socket` (line 2)

---

## Findings

### A092-1 — CRITICAL: `Guardian.Plug.EnsureAuthenticated` is commented out in `auth_pipeline.ex`

**File:** `lib/api_server_web/auth_pipeline.ex`, line 7
**Checklist section:** §2 (Authentication and Authorization)

The plug that enforces authentication is commented out:

```elixir
plug Guardian.Plug.VerifyHeader, realm: "Bearer"
# plug Guardian.Plug.EnsureAuthenticated    <-- DISABLED
plug Guardian.Plug.LoadResource
```

`Guardian.Plug.VerifyHeader` only attempts to parse and verify a JWT from the `Authorization` header if one is present. It does not reject requests that omit the header entirely. `Guardian.Plug.LoadResource` will silently succeed with a `nil` resource when no token is present.

Without `EnsureAuthenticated`, any request to the `:authenticated` pipeline that simply omits the `Authorization` header will pass through as an unauthenticated request. All routes under the `pipe_through([:api, :authenticated])` block in `router.ex` — including user management, customer management, fleet operations, rental records, vehicle locations, geofences, and fleet map endpoints — are effectively unprotected.

This is a complete authentication bypass affecting every route in the `/api/v1` scope that calls `pipe_through([:api, :authenticated])` (router.ex lines 33–153).

**Affected routes include (non-exhaustive):**
- `GET /api/v1/rhm/:customer/users` — lists all users for a customer
- `DELETE /api/v1/rhm/:customer/user/:id` — deletes a user
- `GET /api/v1/rhm/customers` — lists all customers
- `DELETE /api/v1/rhm/customer/:id` — deletes a customer
- `GET /api/v1/rhm/fleetmap` — vehicle locations for all fleets
- `GET /api/v1/rhm/fleetmap/:fleetid` — vehicle locations for a fleet
- `PUT /api/v1/rhm/:customer/user/` — creates a user
- All fleet, rental, geofence, and export endpoints

---

### A092-2 — CRITICAL: `user_socket.ex` `connect/2` accepts all connections without any token validation

**File:** `lib/api_server_web/channels/user_socket.ex`, lines 22–24
**Checklist section:** §4 (Session and CSRF)

```elixir
def connect(_params, socket) do
  {:ok, socket}
end
```

The `connect/2` callback unconditionally returns `{:ok, socket}`, ignoring all parameters. Any WebSocket client can establish a socket connection without presenting any credentials. The params argument is explicitly ignored with the `_params` wildcard. The Phoenix-generated comment block (lines 15–21) acknowledges that token verification should be performed here but no implementation was added.

The `id/1` function returns `nil` (line 36), making all sockets anonymous, which means it is also impossible to forcibly disconnect a specific user's socket via `Endpoint.broadcast`.

---

### A092-3 — HIGH: `otp_app` atom mismatch in `auth_pipeline.ex` — `:MyApi` vs `:api_server`

**File:** `lib/api_server_web/auth_pipeline.ex`, line 2
**Checklist section:** §2 (Authentication and Authorization)

```elixir
use Guardian.Plug.Pipeline, otp_app: :MyApi,
```

The `otp_app` is set to `:MyApi` but the application's OTP app name is `:api_server` (as used in `endpoint.ex`, `guardian.ex`, and all config files). This is a copy-paste error from a template or example.

At runtime, Guardian's pipeline will attempt to read its configuration from the `:MyApi` OTP application environment, which does not exist. The Guardian secret key, issuer, and TTL are configured under `:api_server`. Depending on the Guardian version, this may cause the pipeline to fail open (treating tokens as valid when configuration cannot be loaded) or raise errors. In either case, the pipeline is not operating against its intended configuration.

---

### A092-4 — HIGH: WebSocket transport has no `check_origin` configuration in production

**File:** `lib/api_server_web/channels/user_socket.ex`, line 8
**Supporting file:** `lib/api_server_web/endpoint.ex`, line 4
**Config file:** `config/dev.exs`, line 13 (`check_origin: false`)
**Checklist section:** §4 (Session and CSRF)

The `transport :websocket` declaration carries no `check_origin` option:

```elixir
transport :websocket, Phoenix.Transports.WebSocket
```

`dev.exs` sets `check_origin: false` at the endpoint level, which disables origin checking for the dev environment. There is no corresponding `check_origin` setting found in `prod.exs` or `prod.secret.exs`. Because the `connect/2` callback also performs no authentication (A092-2), any cross-origin client can open a WebSocket connection from an arbitrary domain.

---

### A092-5 — HIGH: Two routes placed before `pipe_through` in the same scope block, bypassing all authentication

**File:** `lib/api_server_web/router.ex`, lines 28–33
**Checklist section:** §2 (Authentication and Authorization)

```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)

  pipe_through([:api, :authenticated])
  ...
end
```

In Phoenix, `pipe_through` applies only to routes defined after it in the same scope block. The two routes `GET /api/v1/rhm/engine_usage` and `GET /api/v1/rhm/monday_hour_meters` are defined before the `pipe_through([:api, :authenticated])` call and therefore receive no pipeline at all — not even the `:api` pipeline (no session, no content-type enforcement). These routes return fleet/engine data with no authentication whatsoever.

The comment "Avoid authentication, locking to a specific database" suggests this is intentional, but the security implication is that unauthenticated external callers can retrieve engine usage data for any hardware ID. These endpoints should be reviewed to confirm whether truly public access is acceptable, and if so, they should be moved to the unauthenticated scope (lines 156–177) for clarity.

---

### A092-6 — MEDIUM: Guardian token TTL is 52 weeks (one year) — excessively long

**File:** `config/config.exs`, line 135
**Checklist section:** §2 (Authentication and Authorization)

```elixir
config :api_server, ApiServer.Guardian,
  issuer: "rhmapi",
  ttl: {52, :weeks},
  secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

A JWT TTL of 52 weeks means a stolen or leaked token remains valid for up to one year. There is no evidence of a token revocation mechanism or refresh token policy in the codebase. Combined with the authentication bypass in A092-1, any token that has ever been issued remains exploitable for a full year.

---

### A092-7 — MEDIUM: Guardian `secret_key` is a hardcoded string in a tracked config file

**File:** `config/config.exs`, line 136
**Checklist section:** §1 (Secrets and Configuration)

```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The Guardian JWT signing secret is committed as a literal string in `config/config.exs`, which is tracked by version control. Anyone with read access to the repository (including historical commits) can obtain the signing secret and forge arbitrary JWTs. This secret should be loaded from an environment variable: `System.get_env("GUARDIAN_SECRET_KEY")`.

---

### A092-8 — MEDIUM: `auth_error_handler.ex` — discards error reason, but error type is still returned to client

**File:** `lib/api_server_web/auth_error_handler.ex`, lines 4–6
**Checklist section:** §5 (File and Data Handling — information disclosure in error responses)

```elixir
def auth_error(conn, {type, _reason}, _opts) do
  body = Poison.encode!(%{error: to_string(type)})
  send_resp(conn, 401, body)
end
```

The `_reason` is discarded (good), but `type` is serialised to a string and returned verbatim in the JSON response body. Guardian error types include atoms such as `:token_expired`, `:invalid_token`, `:unauthenticated`, `:no_resource_found`, `:already_authenticated`. Returning the specific error type enables an attacker to distinguish between "no token provided", "expired token", and "invalid token signature", which aids in probing the authentication system.

Additionally, the response has no `Content-Type: application/json` header set explicitly. The raw `send_resp/3` call bypasses Phoenix's view layer and will not set the content type, potentially causing clients to misparse the response.

---

### §1: Additional notes from context files

The following issues in context files are outside the three assigned files but are directly relevant to the security posture of the assigned modules and are noted for completeness:

- `config/prod.exs` contains hardcoded production database credentials (RDS hostname, username, password for both `FortyNineRepo` and `Repo`), an AWS SES SMTP access key ID, and SMTP password (lines 17, 35–36, 45, 48). This is a separate finding for the config-file audit agent but corroborates the pattern found in A092-7.
- `config/prod.secret.exs` contains a hardcoded `secret_key_base` (line 12). The file is intended to be excluded from version control per its own comment, but it was readable during this audit, suggesting it may be tracked.

---

## Checklist Section Summary

| Section | Status |
|---------|--------|
| §1 Secrets and Configuration | Issues found — A092-7 (Guardian secret hardcoded in tracked config) |
| §2 Authentication and Authorization | Issues found — A092-1 (EnsureAuthenticated commented out), A092-3 (otp_app mismatch), A092-5 (routes before pipe_through), A092-6 (52-week TTL) |
| §3 Input Validation and Injection | §3: No issues found in the three assigned files. |
| §4 Session and CSRF | Issues found — A092-2 (socket connect accepts all), A092-4 (no check_origin in production) |
| §5 File and Data Handling | Issues found — A092-8 (Guardian error type disclosed to client) |
| §6 Dependencies | §6: No issues found in the three assigned files. |
| §7 Infrastructure Exposure | §7: No issues found in the three assigned files. |

---

## Finding Index

| ID | Severity | File | Summary |
|----|----------|------|---------|
| A092-1 | CRITICAL | `auth_pipeline.ex:7` | `EnsureAuthenticated` plug commented out — authentication bypass on all protected routes |
| A092-2 | CRITICAL | `user_socket.ex:22` | `connect/2` returns `{:ok, socket}` unconditionally — no token validation on WebSocket connections |
| A092-3 | HIGH | `auth_pipeline.ex:2` | `otp_app: :MyApi` does not match application name `:api_server` — Guardian pipeline misconfigured |
| A092-4 | HIGH | `user_socket.ex:8` | No `check_origin` enforced for WebSocket transport in production |
| A092-5 | HIGH | `router.ex:30-31` | Two routes declared before `pipe_through` in authenticated scope — no pipeline applied |
| A092-6 | MEDIUM | `config/config.exs:135` | Guardian TTL is 52 weeks with no refresh/revocation policy |
| A092-7 | MEDIUM | `config/config.exs:136` | Guardian `secret_key` hardcoded as literal string in tracked config file |
| A092-8 | MEDIUM | `auth_error_handler.ex:5` | Guardian error type (`type` atom) returned verbatim in 401 response body |

<!-- A095.md -->
# Audit Report A095
**Agent:** A095
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Run:** 2026-02-27-01
**Checklist:** PASS1-CHECKLIST-api_server.md

---

## Assigned Files

1. `lib/api_server_web/controllers/calamp_controller.ex`
2. `lib/api_server_web/controllers/digital_matter_controller.ex`
3. `lib/api_server_web/controllers/fallback_controller.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/calamp_controller.ex`

**Module name:** `ApiServerWeb.CalampController`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `recieve_calamp_data` | 2 | 4 |

**Private functions (defp):**
| Name | Arity | Line |
|------|-------|------|
| `validate` | 3 | 31 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)

**Notes:** The function name `recieve_calamp_data` contains a spelling error ("recieve" instead of "receive"). No corresponding route for `CalampController` exists in `router.ex`; the controller is defined but unreachable via HTTP.

---

### File 2: `lib/api_server_web/controllers/digital_matter_controller.ex`

**Module name:** `ApiServerWeb.DigitalMatterController`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `get_g62_data` | 2 | 4 |

**Private functions (defp):** None.

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)

**Router registration (from router.ex):**
- `POST /` routed via `:api_xml` pipeline — no `:authenticated` plug.

---

### File 3: `lib/api_server_web/controllers/fallback_controller.ex`

**Module name:** `ApiServerWeb.FallbackController`

**Public functions (def):**
| Name | Arity | Line |
|------|-------|------|
| `call` | 2 | 9 (clause 1: `{:error, %Ecto.Changeset{}}`) |
| `call` | 2 | 15 (clause 2: `{:error, :not_found}`) |

**Private functions (defp):** None.

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 7)

---

## Checklist Review

### §1: Secrets and Configuration

**CalampController:** No secrets or hardcoded credentials observed in this file.

**DigitalMatterController (lines 9–11):**
- `email_to = ["graham.oconnell@trackingsolutions.com.au"]` — a real personal email address is hardcoded as a literal string in production controller code.
- `email_from = "no-reply@mobilehourmeter.com"` — hardcoded sender address.
- `subject = "Digital Matter - Raw Data"` — hardcoded string; minor, but consistent with the email block being development/debug code left in production.

The email-sending lines are commented out (`# ApiServer.Email.send_digital_matter_email(...)`), so the address is not currently transmitted, but the PII remains in source and will appear in version control history.

**FallbackController:** No secrets or hardcoded credentials.

---

### §2: Authentication and Authorization

**CalampController — `recieve_calamp_data/2`:**
- There is no route for `CalampController` in `router.ex`. The controller cannot be reached via HTTP. This may indicate dead code or an incomplete feature.
- The function hardcodes `customer = "vx_dev"` (line 5). If a route were ever added, there would be no customer scoping from the authenticated user.

**DigitalMatterController — `get_g62_data/2`:**
- Registered as `POST /` under the `:api_xml` pipeline only. The `:authenticated` plug (`ApiServer.Guardian.AuthPipeline`) is NOT applied to this route.
- Any caller can POST data to the root endpoint without any authentication token. The `hardware_id` comes directly from `params["SerNo"]` with no authentication check.
- The customer is hardcoded as `"vx_dev"` (line 200). There is no mechanism for the caller to identify which customer's data should be updated, and no check that the device belongs to any authenticated customer. Because the endpoint is unauthenticated, this is effectively an unauthenticated write endpoint to a fixed (development) customer database prefix.

**FallbackController:** Renders error responses. No authentication logic; §2 not applicable to this file directly.

---

### §3: Input Validation and Injection

**CalampController — `recieve_calamp_data/2`:**
- Input arrives as `%{xml: calamp_data}` (pattern-matched from parsed XML). No validation of the structure or field values within `calamp_data` is performed before it is passed to `ApiServer.Vx.VXThingEvent.map_xml/1`.
- `hardwareid` is extracted from the result of `map_xml` (external XML field) and passed directly to `ApiServer.Vx.get_most_recent_thingevent/2` and `ApiServer.Vx.get_vx_thing_with_hardware_id!/2`. From inspection of `vx.ex`, these functions use Ecto parameterized queries (`^hardwareid`), so there is no SQL injection risk at the query level. However, there is no prior validation that `hardwareid` is a non-nil, correctly typed value before it reaches the context.
- `IO.inspect` (line 10) and `IO.puts` (lines 34, 40, 43) are present in what appears to be production code. `IO.inspect new_event` will log the full deserialized GPS/telemetry event struct to stdout. This is a data leak in logs (see §5).
- The `validate/3` private function does not return a value; its result is discarded. It only performs `IO.puts` of computed diffs. No actual validation decision is made — the comment "# 2. Save the record if valid" is never reached by any save logic visible in this controller. This means the validation function is a no-op stub.

**DigitalMatterController — `get_g62_data/2`:**
- `hardware_id = params["SerNo"]` (line 5): raw string from unauthenticated HTTP POST, no validation or sanitization.
- `records = params["Records"]` (line 7): raw list from unauthenticated HTTP POST, no nil check or type check.
- `Enum.each(records, ...)` (line 20): if `records` is `nil` (i.e., the `Records` key is absent from the POST body), this will raise `Protocol.UndefinedError` at runtime because `Enum.each/2` does not accept `nil`.
- `record["Fields"]` (line 24): no nil-check; if `Fields` is absent, `Enum.find/2` will receive `nil` and raise `Protocol.UndefinedError`.
- `gps["Alt"]`, `gps["Head"]`, `gps["Spd"]` (lines 151, 158, 165): if `gps` is `nil` (no FType==0 field found), these will raise `KeyError` / `ArgumentError` at runtime.
- `driver_id["DriverID"]` (line 172): if `driver_id` is `nil` (no FType==3 field found), this will raise at runtime.
- `trip_hours["Dur"]` (line 139): if `trip_hours` is `nil` (no FType==26 field found), this will raise at runtime.
- `run_hours["RH"]` (line 197): inside `thing_event` map construction; `run_hours` nil case is handled for `odometer` (lines 142–148) but `totalengineseconds: run_hours["RH"]` (line 197) has no nil guard — if `run_hours` is `nil`, this will raise.
- None of the extracted fields pass through an Ecto changeset or any parameter schema before being written to the database via `ApiServer.Vx.create_thingevent_record/2`.
- `IO.inspect(error)` (line 218): Ecto changeset errors are logged to stdout in production code.
- The `customer` value used in the database prefix (`"vx_dev"`, line 200) is hardcoded. No injection risk from user input, but this is a hardcoded development value in what appears to be a production path.

**FallbackController:**
- Clause 1 renders changeset errors through `ApiServerWeb.ChangesetView`, which uses `Ecto.Changeset.traverse_errors/2`. This is the standard safe pattern; no user input is echoed unsanitized.
- Clause 2 renders a generic 404. No user input echoed.
- §3: No issues found.

---

### §4: Session and CSRF

**CalampController / DigitalMatterController:** Both controllers are under XML/API pipelines which do not include `plug(:protect_from_forgery)`. For machine-to-machine device endpoints receiving telemetry this is expected, but the absence of any authentication token requirement on the DigitalMatterController endpoint means there is no session or token mechanism protecting this write path at all.

**FallbackController:** §4: No issues found.

---

### §5: File and Data Handling

**CalampController:**
- `IO.inspect` on line 10 logs the complete deserialized `new_event` struct, which contains GPS coordinates, timestamps, engine data, and a `hardwareid`. This constitutes uncontrolled logging of fleet telemetry PII/location data.
- `IO.puts "GPS Diff: #{inspect gps_diff}"` (line 34), `IO.puts "Time since current: #{inspect event_time_diff}"` (line 40), `IO.puts "Accum diff: #{inspect accum_diff}"` (line 43) log computed values derived from device events to stdout.

**DigitalMatterController:**
- `IO.inspect(error)` (line 218) logs Ecto changeset error details to stdout. Changeset error structs may contain field names and rejected values, potentially including GPS coordinates or driver IDs.
- The `thing_event` map built at lines 178–198 includes `latitude`, `longitude`, `hardwareid`, `driverid` and other fleet data. These are passed to `create_thingevent_record/2` without validation. If the changeset fails, the full error (including the attempted values) is written to stdout via `IO.inspect`.

**Cross-customer data scoping (checklist §5, device-data section):**
- Both `CalampController.recieve_calamp_data/2` and `DigitalMatterController.get_g62_data/2` use the hardcoded string `"vx_dev"` as the customer/schema prefix. This means:
  - All incoming device data is written exclusively to the `vx_dev` schema, regardless of which actual customer the device belongs to.
  - There is no mapping from `hardware_id` (device serial) to the correct customer schema.
  - If this code were to be used with real customer data, all telemetry would be siloed into a single development namespace.
  - Conversely, data from different customers' devices could be commingled if they share hardware IDs across the `vx_dev` prefix.

**FallbackController:** §5: No issues found.

---

### §6: Dependencies

Not directly assessable from these three controller files. No dependency calls outside the application's own modules are made in these files beyond `Timex.parse/2` (DigitalMatterController line 108), `Poison.encode!/1`, and standard Phoenix/Plug functions. Dependency audit is covered by other agents reviewing `mix.exs` / `mix.lock`.

§6: No issues found specific to these files.

---

### §7: Infrastructure Exposure

**DigitalMatterController (lines 9–11):**
- Hardcoded email address `"graham.oconnell@trackingsolutions.com.au"` and domain `"mobilehourmeter.com"` are present in source. The email sending code is commented out, but these values are present in the repository and represent unnecessary exposure of an individual's email address and a service domain in version history.

**CalampController / DigitalMatterController:** No hardcoded IPs, hostnames, or infrastructure endpoints found in these files.

**FallbackController:** §7: No issues found.

---

## Findings

---

### A095-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** Router `scope "/"` — no `:authenticated` plug
**Section:** §2 Authentication and Authorization

`DigitalMatterController.get_g62_data/2` is registered at `POST /` under the `:api_xml` pipeline, which contains only `fetch_session` and `accepts`. The `:authenticated` plug (`ApiServer.Guardian.AuthPipeline`) is not in this pipeline. Any unauthenticated party on the network can POST arbitrary JSON/XML to the root URL and trigger a write to the `vx_dev` database schema. There is no API key, bearer token, shared secret, or device certificate check. This is an unauthenticated write endpoint to a production database.

---

### A095-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 5–7, 20, 24, 139, 151, 158, 165, 172, 197
**Section:** §3 Input Validation and Injection

No input validation is performed on any field received from the HTTP POST body before use. The following crash paths exist when fields are absent:
- `records` is `nil` → `Enum.each(nil, ...)` raises `Protocol.UndefinedError` (line 20).
- `record["Fields"]` is `nil` → `Enum.find(nil, ...)` raises `Protocol.UndefinedError` (line 24).
- `gps` is `nil` (no FType==0 record) → `gps["Alt"]` raises at lines 151, 158, 165, 184, 189, 190, 193.
- `driver_id` is `nil` → `driver_id["DriverID"]` raises at line 172.
- `trip_hours` is `nil` → `trip_hours["Dur"]` raises at line 139.
- `run_hours` is not `nil` but `run_hours["RH"]` is `nil` → `totalengineseconds: nil` is passed to the changeset without validation at line 197.

Because the endpoint is unauthenticated (see A095-1), any external caller can trivially trigger unhandled exceptions by omitting required fields. Depending on error handling upstream, this may result in 500 responses that expose stack traces or changeset details.

---

### A095-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 200
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Lines:** 5
**Section:** §2 Authorization / §5 Data Handling — Cross-customer scoping

Both device-data ingestion controllers hardcode `customer = "vx_dev"`. The customer schema prefix is never derived from the authenticated user, a device registration table, or any configuration. All telemetry from all devices is written to the `vx_dev` Postgres schema prefix. This violates the per-customer data isolation requirement. If this code path is active in production:
- Data belonging to different customers' devices could be commingled in a single schema.
- The correct per-customer schema is never selected, meaning the data is not associated with the correct customer at the database layer.

---

### A095-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Lines:** 10, 34, 40, 43
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 218
**Section:** §5 File and Data Handling — PII / Fleet Data in Logs

`IO.inspect` and `IO.puts` calls are present in production controller code and will write fleet telemetry to stdout (and thus to any configured log aggregator):

- `calamp_controller.ex` line 10: `IO.inspect new_event` — logs the complete deserialized GPS/engine event struct including GPS coordinates, engine seconds, hardware ID, and timestamps.
- `calamp_controller.ex` lines 34, 40, 43: `IO.puts` of GPS time diffs, event time diffs, and accumulated engine seconds.
- `digital_matter_controller.ex` line 218: `IO.inspect(error)` — logs Ecto changeset error structs that may contain rejected field values including GPS coordinates, driver IDs, and hardware IDs.

GPS coordinates, hardware IDs, and driver IDs constitute fleet PII and location data. Uncontrolled logging of this data may violate data handling policies and creates unnecessary exposure in log storage systems.

---

### A095-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 9
**Section:** §1 Secrets and Configuration / §7 Infrastructure Exposure

A personal email address (`graham.oconnell@trackingsolutions.com.au`) is hardcoded as a string literal in the production controller. Although the code block that uses it is commented out, the value is committed to version control and will persist in git history. This constitutes unnecessary PII exposure of an individual's email address in source code.

---

### A095-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Lines:** 4, 31–44
**Section:** §3 Input Validation / §2 Authorization

`recieve_calamp_data/2` has no corresponding route in `router.ex`. The controller is defined but unreachable via HTTP. This appears to be dead/incomplete code. The `validate/3` private function it calls is a stub that only performs `IO.puts` and returns no value; its result is unused and there is no save logic. If this controller is ever wired to a route in the future, it would:
1. Accept unauthenticated inbound XML data (no `:authenticated` pipeline in the XML scope).
2. Hardcode the customer as `"vx_dev"`.
3. Perform no actual validation (the `validate/3` result is discarded).
4. Not save any data (the save step is commented out/incomplete).

The controller's existence as dead code with these properties is a latent risk if a route is inadvertently added.

---

### A095-7
**Severity:** LOW
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Lines:** 246
**Section:** §5 File and Data Handling — Internal error detail in response

On line 246, when `create_thingevent_record` fails and returns an error, the controller responds to the HTTP client with:

```elixir
Plug.Conn.send_resp(400, Poison.encode!(%{message: Kernel.inspect(event_id)}))
```

`event_id` at this point holds `error.errors` (line 219), which is the Ecto changeset error keyword list. `Kernel.inspect/1` will render the full list including field names and validation error messages. This serializes internal database schema details (field names and validation rules) into the HTTP 400 response body visible to the caller.

---

### A095-8
**Severity:** LOW
**File:** `lib/api_server_web/controllers/fallback_controller.ex`
**Lines:** 9–13
**Section:** §5 File and Data Handling — Changeset error detail in response

`FallbackController.call/2` clause 1 renders Ecto changeset errors via `ApiServerWeb.ChangesetView.render("error.json", ...)`, which calls `Ecto.Changeset.traverse_errors/2` and returns all field-level validation errors as a JSON object. This is a common Phoenix pattern and the errors are typically user-facing validation messages, but it does expose internal schema field names to the client. This is LOW severity as it is standard Phoenix behaviour and the changeset errors are unlikely to reveal sensitive information, but it should be confirmed that no sensitive field names appear in error responses for the routes that use this fallback.

---

### A095-9
**Severity:** INFO
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Lines:** 4
**Section:** Code quality

The public function is named `recieve_calamp_data` — "recieve" is a misspelling of "receive". This is a cosmetic issue but could cause confusion if external callers or route helpers reference the function name by atom. Not a security issue.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A095-1 | HIGH | digital_matter_controller.ex | `POST /` endpoint has no authentication |
| A095-2 | HIGH | digital_matter_controller.ex | No input validation; multiple nil-crash paths on missing fields |
| A095-3 | HIGH | digital_matter_controller.ex, calamp_controller.ex | Customer hardcoded as `"vx_dev"` — no cross-customer data scoping |
| A095-4 | MEDIUM | calamp_controller.ex, digital_matter_controller.ex | `IO.inspect`/`IO.puts` log GPS coordinates, hardware IDs, driver IDs to stdout |
| A095-5 | MEDIUM | digital_matter_controller.ex | Personal email address hardcoded in source / version control |
| A095-6 | MEDIUM | calamp_controller.ex | Dead controller with no route, incomplete validation stub — latent risk |
| A095-7 | LOW | digital_matter_controller.ex | Ecto changeset error detail (`error.errors`) serialized into HTTP 400 response body |
| A095-8 | LOW | fallback_controller.ex | Changeset field names exposed in error JSON responses |
| A095-9 | INFO | calamp_controller.ex | Misspelled function name `recieve_calamp_data` |

<!-- A098.md -->
# Security Audit Report — A098
**Agent:** A098
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Auditor:** Pass 1 Security Audit Agent A098

---

## Assigned Files

1. `lib/api_server_web/controllers/file_controller.ex`
2. `lib/api_server_web/controllers/geofence_controller.ex`
3. `lib/api_server_web/controllers/page_controller.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/file_controller.ex`

**Module name:** `ApiServerWeb.FileController`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `get_size` | 2 | 12 |
| `send_file_download` | 2 | 28 |

**Private functions (defp):**

| Name | Arity | Line |
|------|-------|------|
| `generate_binary_file_contents` | 1 | 42 |
| `check_crc` | 1 | 52 |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**

```elixir
use ApiServerWeb, :controller
alias ApiServer.Operators
alias ApiServer.Operators.File
alias ApiServer.Vx
alias ApiServer.Vx.VXAccessFob
```

**action_fallback:** `ApiServerWeb.FallbackController`

---

### File 2: `lib/api_server_web/controllers/geofence_controller.ex`

**Module name:** `ApiServerWeb.GeofenceController`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `list_all_geofences` | 2 | 11 |
| `create_geofence` | 2 | 18 |
| `update_geofence` | 2 | 35 |
| `delete_geofence` | 2 | 57 |
| `process_things_geofences` | 2 | 73 |

**Private functions (defp):**

| Name | Arity | Line |
|------|-------|------|
| `check_geofences_for_unit` | 6 | 96 |
| `does_event_cause_geofence_events` | 4 | 115 |
| `check_event_for_left_events` | 6 (nil guard) | 132 |
| `check_event_for_left_events` | 6 | 133 |
| `check_event_for_entered_events` | 6 | 149 |
| `make_geofence_event` | 6 | 168 |
| `engine_hours_at_event` | 3 | 184 |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**

```elixir
use ApiServerWeb, :controller
alias ApiServer.Vx
alias ApiServer.Vx.Geofence
import Ecto.Query, warn: false
alias ApiServer.Repo
```

---

### File 3: `lib/api_server_web/controllers/page_controller.ex`

**Module name:** `ApiServerWeb.PageController`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `index` | 2 | 4 |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**

```elixir
use ApiServerWeb, :controller
```

---

## Checklist Review

### §1: Secrets and Configuration

Reviewed all three controller files for hardcoded credentials, API keys, secrets, or embedded infrastructure details.

`vx.ex` (context file, read for cross-reference) at line 200 contains a hardcoded string used by `get_vx_admin_fobs()`:

```elixir
def get_vx_admin_fobs() do
  "000019333303000019333AEA000019330E4E0000193354AC00001933382D00001932FCA800001933001A"
end
```

This string is consumed directly in `file_controller.ex` line 33 as the base of the `fobs_as_string` accumulator passed into binary file generation. This is a hardcoded credential/key value embedded in source — see finding A098-1.

`file_controller.ex`, `geofence_controller.ex`, `page_controller.ex`: No other hardcoded secrets, API keys, or database credentials found directly in these controller files.

---

### §2: Authentication and Authorization

**Router cross-reference (router.ex):**

The router defines two scopes under `/api/v1`:

**Scope 1 (lines 28–154):** Opens with two unauthenticated routes before calling `pipe_through([:api, :authenticated])`:

```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)

  pipe_through([:api, :authenticated])
  ...
  get("/rhm/geofences", GeofenceController, :list_all_geofences)
  put("/rhm/geofence", GeofenceController, :create_geofence)
  post("/rhm/geofence", GeofenceController, :update_geofence)
  delete("/rhm/geofence/:id", GeofenceController, :delete_geofence)
  get("/rhm/reports/geofence_events", GeofenceController, :process_things_geofences)
```

All GeofenceController routes are within the authenticated block.

**Scope 2 (lines 156–177):** Uses only `pipe_through(:api)` — no `:authenticated` plug:

```elixir
scope "/api/v1", ApiServerWeb do
  pipe_through(:api)
  ...
  get("/files/getsize/:esn", FileController, :get_size)
  get("/files/getfile/:esn", FileController, :send_file_download)
```

Both `FileController` actions (`get_size`, `send_file_download`) are in an **unauthenticated** scope. Any caller who can reach the server can query any device by ESN and retrieve the full access-fob binary for it — see finding A098-2.

`get_vx_thing_with_hardware_id!` (called without a `customer` argument) performs a cross-tenant query with no `prefix:` — it queries the global/default schema. This means device lookups in `file_controller.ex` are not scoped to any organisation — see finding A098-3.

`page_controller.ex` has a single `index/2` that renders a static HTML page. No auth required; this appears intentional for a root/landing page. Not flagged.

---

### §3: Input Validation and Injection

**file_controller.ex:**

The `hardwareid` parameter from the URL path segment `:esn` flows into:

1. `Vx.get_vx_thing_with_hardware_id!(hardwareid)` — parameterised Ecto query (safe).
2. String interpolation into the `version_name` filename at line 36:

```elixir
version_name = "SM-" <> date_string <> "-" <> hardwareid <> ".bin"
send_download(conn, {:binary, generate_binary_file_contents(fobs_as_string)}, filename: version_name)
```

The `hardwareid` is used as a component of the `Content-Disposition: attachment; filename=` header value passed directly to Phoenix's `send_download/3`. If `hardwareid` contains characters such as `"`, `;`, newline, or carriage return, it can corrupt or inject into the HTTP response header — see finding A098-4.

`generate_binary_file_contents/1` calls `Base.decode16!(operator_string)`. If `fob_code` values contain non-hex characters, this raises an exception and leaks a stack trace through the fallback controller. The input is from the database so this is LOW risk but worth noting — see finding A098-7.

**geofence_controller.ex:**

`create_geofence/2` and `update_geofence/2` pass `geofence_params` (raw request body map) into `Vx.create_geofence/2` and `Vx.update_geofence/3` respectively. Whether changeset validation occurs was checked via context reference. The controller itself does not apply any parameter filtering or validation before forwarding — input validation is entirely delegated downstream. If the context functions lack strict changesets, there is no safety net here. This is noted as an observation rather than a confirmed finding — see finding A098-8.

`create_geofence/2` line 31 and `update_geofence/2` line 50 construct raw JSON error responses by string interpolation of `inspect(error)`:

```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error creating geofence\", \"reason\": \"#{inspect error}\" }")
```

The `inspect error` output of an Ecto changeset or database error can contain table names, column names, constraint names, schema prefixes (which are customer identifiers), and SQL fragments — see finding A098-5.

No `String.to_atom/1` on user input, no `Code.eval_string/1`, no `:erlang.binary_to_term/1` found in the three files.

---

### §4: Session and CSRF

`page_controller.ex` is served under the `:browser` pipeline (based on router scope `"/"` using `pipe_through(:browser)`). The browser pipeline includes `plug(:protect_from_forgery)` and `plug(:put_secure_browser_headers)`.

The FileController and GeofenceController actions are served under `:api` / `:authenticated` pipelines which do not include CSRF protection. This is standard and expected for stateless JWT-authenticated API endpoints.

§4: No issues found in the three assigned files beyond the authentication gap already reported in §2.

---

### §5: File and Data Handling

**Path traversal — file_controller.ex:**

Special attention was given per task instructions. The `send_file_download/2` action does **not** write to the filesystem: it uses `send_download(conn, {:binary, data}, filename: version_name)`. Phoenix's `send_download/3` with the `:binary` tuple sends in-memory data, not a file read from disk. There is no `File.read`, `File.write`, `File.open`, or `:file.read` call. Classical path traversal (directory escape to read/write arbitrary files) is **not present**.

However, as noted in §3, `hardwareid` from user input is included in the `filename:` option passed to `send_download/3`, which sets the `Content-Disposition` header — see A098-4 for the header injection risk.

**Content type validation — file_controller.ex:**

The endpoint generates and sends a binary firmware file (`.bin`). It accepts no user-uploaded file; it produces output. Content-type validation of an *incoming upload* is therefore not applicable. The outgoing `Content-Type` is set by Phoenix based on the filename extension `.bin`; this is server-controlled and acceptable.

**Information disclosure in error responses:**

`geofence_controller.ex` lines 31, 50: `inspect(error)` in HTTP response bodies — see A098-5.

`file_controller.ex` lines 16, 46, 47: `IO.puts` calls write debug information (fleet join data, CRC values) to stdout. In production these will appear in application logs. The line 16 output includes `fleet_thing_joins` association data:

```elixir
IO.puts "#{inspect length(thing.fleet_thing_joins)} #{inspect thing.fleet_thing_joins}"
```

This logs fleet structure data to the application log on every request — see finding A098-6.

**PII / GPS / fleet data scoping:**

`process_things_geofences/2` returns geofence event records that include `latitude`, `longitude`, `ignitionstatus`, `eventtype`, `eventcode`, and `engine_hours_at_event`. The function correctly extracts `customer` from the JWT claims and passes it to all data-access calls as a schema prefix. Fleet data scoping is enforced.

`list_all_geofences/2`, `create_geofence/2`, `update_geofence/2`, `delete_geofence/2`: all extract `customer` from JWT claims and pass to context functions. Scoping is enforced.

---

### §6: Dependencies

Not assessed in these three controller files. No dependency declarations appear here.

§6: Not applicable to assigned files (no mix.exs/mix.lock changes assessed here).

---

### §7: Infrastructure Exposure

`file_controller.ex`: No hardcoded hostnames, IPs, or port numbers.

`geofence_controller.ex`: No hardcoded hostnames, IPs, or port numbers.

`page_controller.ex`: No hardcoded hostnames, IPs, or port numbers.

The router (reviewed for context) does not configure CORS directly; commented-out `CORSPlug` lines are present but inactive.

§7: No issues found in the three assigned files.

---

## Findings

### A098-1 — MEDIUM — Hardcoded Access Fob Keys in Source

**File:** `lib/api_server/vx/vx.ex` (line 200, consumed by `lib/api_server_web/controllers/file_controller.ex` line 33)

**Description:**
`Vx.get_vx_admin_fobs/0` returns a hardcoded hex string representing seven administrative access fob codes:

```elixir
def get_vx_admin_fobs() do
  "000019333303000019333AEA000019330E4E0000193354AC00001933382D00001932FCA800001933001A"
end
```

This string is prepended to every firmware binary generated by `send_file_download/2`. The fob codes are compiled into the application binary and are present in version control history. Any person with read access to the repository can extract these codes. Rotation of a compromised fob requires a code change and redeployment.

**Recommendation:** Store admin fob codes in application configuration loaded from an environment variable or secrets manager. Do not embed them in source.

---

### A098-2 — CRITICAL — FileController Endpoints Are Unauthenticated

**File:** `lib/api_server_web/controllers/file_controller.ex` (lines 12, 28)
**Router:** `lib/api_server_web/router.ex` (lines 165–166)

**Description:**
Both `get_size/2` and `send_file_download/2` are registered under the second `/api/v1` scope, which uses only `pipe_through(:api)` — the `:authenticated` plug is absent:

```elixir
scope "/api/v1", ApiServerWeb do
  pipe_through(:api)
  ...
  get("/files/getsize/:esn", FileController, :get_size)
  get("/files/getfile/:esn", FileController, :send_file_download)
```

Any unauthenticated caller who can reach the server can:

1. Enumerate device ESNs and retrieve associated fleet and access-fob counts (`get_size`).
2. Download the complete access-fob binary for any device — including all seven hardcoded admin fobs — by supplying only a hardware ID (`send_file_download`).

The access-fob binary governs physical access control (who is authorised to operate fleet equipment). Unauthenticated retrieval of this binary for an arbitrary device is a critical access-control failure.

**Recommendation:** Move the `/files/*` routes inside the authenticated scope, or add `plug ApiServer.Guardian.AuthPipeline` directly to the FileController. Additionally, verify that the authenticated caller's organisation owns the requested device (see A098-3).

---

### A098-3 — HIGH — FileController Device Lookup is Not Tenant-Scoped

**File:** `lib/api_server_web/controllers/file_controller.ex` (lines 14, 29)
**Context:** `lib/api_server/vx/vx.ex` (line 1337)

**Description:**
Both `get_size/2` and `send_file_download/2` call `Vx.get_vx_thing_with_hardware_id!/1` — the single-arity variant that does **not** accept a `customer` prefix:

```elixir
def get_vx_thing_with_hardware_id!(hardwareid) do
  VXThing
      |> Ecto.Query.where(aadhardwareid: ^hardwareid)
      ...
      |> Repo.one   # no prefix: customer
end
```

This queries the default schema with no tenant isolation. Even if authentication were added (A098-2), any authenticated user from any customer organisation could query devices belonging to other customers' organisations by ESN, then obtain their fleet's access-fob data.

The two-arity form `get_vx_thing_with_hardware_id!(hardwareid, customer)` exists and is used elsewhere. The file controller should use this form after extracting the customer from JWT claims.

**Recommendation:** After adding authentication (A098-2), extract `customer` from `ApiServer.Guardian.Plug.current_claims(conn)["customer"]` and call `Vx.get_vx_thing_with_hardware_id!(hardwareid, customer)` in both actions.

---

### A098-4 — MEDIUM — HTTP Header Injection via User-Controlled Hardware ID in Content-Disposition

**File:** `lib/api_server_web/controllers/file_controller.ex` (lines 35–38)

**Description:**
The `:esn` path parameter (`hardwareid`) is interpolated directly into the `filename:` option of `send_download/3`:

```elixir
version_name = "SM-" <> date_string <> "-" <> hardwareid <> ".bin"
send_download(conn, {:binary, generate_binary_file_contents(fobs_as_string)}, filename: version_name)
```

Phoenix's `send_download/3` sets a `Content-Disposition: attachment; filename="<version_name>"` response header. If `hardwareid` contains double-quote characters, semicolons, or CRLF sequences (`\r\n`), the resulting header value can be malformed or split, enabling:

- Header injection (CRLF injection) that injects additional HTTP response headers.
- Filename manipulation on the client side.

**Recommendation:** Sanitise `hardwareid` before use in the filename: allow only alphanumeric characters, hyphens, and underscores. Reject or strip any character outside this set before constructing `version_name`.

---

### A098-5 — MEDIUM — Internal Error Details Leaked in HTTP Responses

**File:** `lib/api_server_web/controllers/geofence_controller.ex` (lines 31, 50, 53, 66, 69)

**Description:**
Multiple error responses in `GeofenceController` construct raw JSON by string interpolation of `inspect(error)` or literal internal messages:

```elixir
# Line 31 — create_geofence
send_resp(conn, :internal_server_error,
  "{\"error\": \"error creating geofence\", \"reason\": \"#{inspect error}\" }")

# Line 50 — update_geofence
send_resp(conn, :internal_server_error,
  "{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }")
```

The `inspect/1` of an Ecto changeset or database error typically includes:
- Table and column names.
- Database constraint names (which embed schema/table structure).
- The customer schema prefix (which is the organisation identifier).
- Potentially partial SQL fragments from `Ecto.Adapters.SQL`.

Returning this data in HTTP responses discloses internal schema structure to API clients.

Additionally, line 53 returns `"no geofence matches ID"` and line 69 returns `"No geofence with that ID to delete"` with a 500 status code rather than 404, which is misleading and non-standard.

**Recommendation:**
1. Replace `inspect(error)` with a generic error message in all HTTP responses. Log the full error server-side.
2. Return 404 (not 500) when a resource is not found.

---

### A098-6 — LOW — Debug IO.puts Calls Log Fleet Data in Production

**File:** `lib/api_server_web/controllers/file_controller.ex` (lines 16, 46, 47)

**Description:**
Three `IO.puts` calls remain active in production code paths:

```elixir
# Line 16 — get_size and send_file_download
IO.puts "#{inspect length(thing.fleet_thing_joins)} #{inspect thing.fleet_thing_joins}"

# Lines 46–47 — generate_binary_file_contents
IO.puts "CRC: #{inspect crc}"
IO.puts "CRC_String: #{inspect crc16_xmodem}"
```

Line 16 logs `fleet_thing_joins` association data to stdout on every invocation. This includes fleet membership data for the device queried. In a container/cloud environment `IO.puts` writes to stdout, which is collected by log aggregation. Logging fleet structural data on every request is unnecessary operational noise and may expose fleet IDs in log systems accessible more broadly than the application itself.

**Recommendation:** Remove all `IO.puts` debug calls from production code. Use `Logger.debug/1` with appropriate log level gating if tracing is needed during development.

---

### A098-7 — LOW — Unhandled Pattern Match in engine_hours_at_event May Crash Process

**File:** `lib/api_server_web/controllers/geofence_controller.ex` (lines 184–205)

**Description:**
`engine_hours_at_event/3` uses a `case` expression on `thing.aadcat` with integer cases 2–9 but provides no catch-all clause:

```elixir
defp engine_hours_at_event(thing, event, customer) do
  case thing.aadcat do
    2 -> event.calcengineseconds/3600
    3 -> event.input1calctotalseconds/3600
    4 -> ...
    5 -> ...
    6 -> ...
    7 -> ...
    8 -> ...
    9 -> event.odometer/1
  end
end
```

If `aadcat` is `nil`, `0`, `1`, or any value outside 2–9, this raises a `CaseClauseError`. This will crash the request process. The `action_fallback` is not declared in this controller, so the error handling depends on Phoenix's default error handler — which may return a 500 with stack trace depending on `ErrorView` configuration.

**Recommendation:** Add a catch-all clause (e.g., `_ -> 0.0`) to prevent unexpected crashes and return a safe default.

---

### A098-8 — INFO — No Controller-Level Parameter Filtering Before Context Calls in GeofenceController

**File:** `lib/api_server_web/controllers/geofence_controller.ex` (lines 18–33, 35–55)

**Description:**
`create_geofence/2` and `update_geofence/2` forward the raw `geofence_params` map (derived from the request body) directly to `Vx.create_geofence/2` and `Vx.update_geofence/3` without any controller-level parameter filtering:

```elixir
def create_geofence(conn, %{"geofence" => geofence_params}) do
  customer = ApiServer.Guardian.Plug.current_claims(conn)["customer"]
  geojson = Geofence.geojson_map_to_string(geofence_params["geoJSON"])
  params = Map.put(geofence_params, "geojson", geojson)
  with {:ok, %Geofence{} = geofence} <- Vx.create_geofence(params, customer) do
    ...
```

Whether Ecto changesets in the context layer enforce strict whitelisting was not verified in this pass. If the context changesets use `cast/3` with explicit field lists this is safe; if they use permissive patterns, over-posting (mass assignment) is possible.

**Recommendation:** Confirm that `Vx.create_geofence/2` and `Vx.update_geofence/3` use strict `cast/3` field whitelists in their changesets. If not, apply parameter filtering at the controller level before forwarding.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A098-1 | MEDIUM | `vx.ex` (consumed by `file_controller.ex`) | Hardcoded admin access fob keys in source |
| A098-2 | CRITICAL | `file_controller.ex` / `router.ex` | FileController endpoints entirely unauthenticated |
| A098-3 | HIGH | `file_controller.ex` | Device lookup not tenant-scoped; cross-customer IDOR |
| A098-4 | MEDIUM | `file_controller.ex` | HTTP header injection via unsanitised hardwareid in Content-Disposition |
| A098-5 | MEDIUM | `geofence_controller.ex` | Internal Ecto/DB error details leaked in HTTP 500 responses |
| A098-6 | LOW | `file_controller.ex` | Active IO.puts debug calls log fleet data in production |
| A098-7 | LOW | `geofence_controller.ex` | Non-exhaustive case in engine_hours_at_event can crash request process |
| A098-8 | INFO | `geofence_controller.ex` | No controller-level parameter filtering before context calls |

<!-- A101.md -->
# Security Audit Report — A101
**Agent:** A101
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Run:** 2026-02-27-01
**Checklist:** PASS1-CHECKLIST-api_server.md

---

## Files Audited

1. `lib/api_server_web/controllers/pivotel_controller.ex`
2. `lib/api_server_web/controllers/utility_controller.ex`
3. `lib/api_server_web/controllers/vx_abl_record_controller.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server_web/controllers/pivotel_controller.ex`

**Module:** `ApiServerWeb.PivotelController`

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)

**defstruct / defexception / schema:** None.

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `get_pivotel_data/2` | 2 | 4 (pattern 1: xml match) |
| `get_pivotel_data/2` | 2 | 15 (pattern 2: catch-all) |
| `create_update_object/1` | 1 | 20 (pattern 1: LOCATION Cause) |
| `create_update_object/1` | 1 | 63 (pattern 2: ACCUM Cause) |
| `create_update_object/1` | 1 | 103 (pattern 3: catch-all) |

**Private functions (`defp`):**
- `convert_timestamp/1` (line 109)

---

### File 2: `lib/api_server_web/controllers/utility_controller.ex`

**Module:** `ApiServerWeb.UtilityController`

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `use Bamboo.Phoenix, view: ApiServer.EmailView` (line 3)
- `import Ecto.Query, warn: false` (line 5)
- `alias ApiServer.Vx` (line 6)
- `alias ApiServer.Vx.VXCustomer` (line 7)
- `alias ApiServer.Vx.ERPImport` (line 8)
- `alias ApiServer.Vx.VXThingInfo` (line 9)
- `alias ApiServer.Repo` (line 10)
- `alias ApiServer.Vx.VXThingEvent` (line 11)
- `alias ApiServer.Vx.VXThingEventOmega` (line 12)
- `alias ApiServer.Vx.VXThingEventOmegaTires` (line 13)
- `alias ApiServer.Vx.VXRayvenMessageLog` (line 14)
- `alias ApiServer.Vx.VXRayvenStreamStatus` (line 15)
- `alias ApiServer.Vx.DeviceDatabaseLookup` (line 16)
- `alias ApiServer.Vx.VXThingSummary` (line 17)
- `alias ApiServer.Vx.Equipment` (line 18)
- `alias ApiServer.Vx.EquipmentAssignment` (line 19)
- `alias ApiServer.Vx.VXRental` (line 20)
- `alias ApiServer.Vx.RentalPeriod` (line 21)
- `alias ApiServer.Vx.RentalContract` (line 22)

**Module attributes:**
- `@lookup_olson` — Windows-to-Olson timezone lookup table (lines 25–126)

**defstruct / defexception / schema:** None.

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `update_puls_firmware/1` | 1 | 128 |
| `bulk_daily_usage_summary/1` | 1 | 228 |
| `do_health_check/2` | 2 | 320 |
| `calculate_roi_value/2` | 2 | 324 |
| `process_incoming_omegawatch_data/2` | 2 | 328 |
| `process_prodisplay_event/2` | 2 | 333 |
| `do_error/2` | 2 | 982 |
| `do_geocode_lookup/2` | 2 | 991 |
| `sync_to_DISCorp/2` | 2 | 1052 |
| `sync_vehicles_to_rayven/1` | 1 | 1076 |
| `test_rental_messages/1` | 1 | 1203 |
| `send_vehicle_to_rayven/2` | 2 | 1445 |
| `send_to_rayven/7` | 7 | 1677 |
| `pull_from_rayven/1` | 1 | 1986 |
| `check_out_of_sequence_events/1` | 1 | 2009 |
| `get_tracker_ids/0` | 0 | 2078 |
| `device_lookup_with_hardware_id/1` | 1 | 2093 |
| `check_vehicles_for_rental_overage/3` | 3 | 2100 |
| `process_monthly_movements/0` | 0 | 2280 |
| `process_pronto/0` | 0 | 2463 |
| `process_ebs/0` | 0 | 2821 |
| `process_ebs_check_service/1` | 1 | 2972 |
| `process_ebs_get_hour_meter/2` | 2 | 2990 |
| `send_local_arrow_data/0` | 0 | 3036 |
| `check_vehicles_for_no_usage_historical/1` | 1 | 3170 |
| `process_events_for_next_usage/4` | 4 | 3213 |
| `sync_events_to_rayven/0` | 0 | 3298 |
| `rayven_login/2` | 2 | 3346 |
| `get_rayven_devices_for_project/2` | 2 | 3390 |
| `pull_data_from_rayven/1` | 1 | 3412 |
| `create_equipment/3` | 3 | 3453 |
| `get_equipment_id/2` | 2 | 3524 |
| `create_equipment_assignment/3` | 3 | 3533 |
| `create_rental_records/1` | 1 | 3596 |
| `sync_rental_contracts_to_rayven/1` | 1 | 3600 |
| `sync_rental_periods_to_rayven/1` | 1 | 3615 |
| `copy_rental_contracts/1` | 1 | 3623 |
| `pull_equipment_data_from_rayven/1` | 1 | 4647 |
| `pull_services_from_rayven/1` | 1 | 4729 |
| `refresh_rayven_stream_status/1` | 1 | 4900 |
| `sync_historical_events_to_rayven/1` | 1 | 5020 |
| `sync_historical_events_to_rayven/5` | 5 | 5091 |
| `send_events_to_rayven/6` | 6 | 5358 |
| `prepare_rayven_events/3` | 3 | 5416 |
| `check_for_future_date/2` | 2 | 5567 |
| `erp_import/2` | 2 | 5666 |
| `driverid_converter/2` | 2 | 6025 |
| `get_additional_data/1` | 1 | 6172 |
| `next_service/1` | 1 | 6225 |

**Private functions (`defp`):**
- `parse_prodisplay_thingevent/4` (line 701)
- `parse_prodisplay_thingomega_event/5` (line 806)
- `parse_prodisplay_thingomegatires_event/5` (line 923)
- `check_and_save_erp_record/3` (line 5735)
- `process_rental_from_erp/2` (line 5758)
- `find_or_make_customer/3` (line 5850)
- `process_services_from_erp/2` (line 5882)
- `process_service_from_erp/2` (line 5896)
- `get_dm_driverid/1` (line 6092)
- `rayven_ssl_opts/0` (line 6267)
- `rayven_cacerts/0` (line 6278)

---

### File 3: `lib/api_server_web/controllers/vx_abl_record_controller.ex`

**Module:** `ApiServerWeb.VXAblRecordController`

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXAblRecord` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

**defstruct / defexception / schema:** None.

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `create/2` | 2 | 9 |
| `show/2` | 2 | 18 |
| `update/2` | 2 | 23 |
| `delete/2` | 2 | 31 |
| `rhm_service_records/2` | 2 | 38 |
| `generate_service_record/3` | 3 | 66 |

---

## Checklist Review

---

### §1: Secrets and Configuration

**A101-1 — CRITICAL — Hardcoded third-party API keys in source (utility_controller.ex)**

Multiple live API keys are hardcoded directly in source code committed to the repository:

- **CalAmp PULS API key (old account):** `IwZTptJkQeOxZCoKRKVtI3IrIVwotFW6KRDS8O8OI-RKjmykQ95DPGlEE4yxjqbg` — embedded in URL string, line 146.
- **CalAmp PULS API key (new account):** `1SdeU1293s78waU_2P3vwCInz2oEOe-Rj6_AYqL-FwBzFtsG3n_o5mNsqat5rO4L` — embedded in URL strings at lines 171 and 204.
- **DISCorp API key:** `[REDACTED-AWS-SMTP-PASSWORD]` — line 1053, hardcoded in `sync_to_DISCorp/2`.
- **Rayven UID tokens** (used as authentication credentials in all Rayven API calls):
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 1747, used in `send_to_rayven/7` for `my.rayven.io`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 2000, `pull_from_rayven/1` for `my.rayven.io`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 3423, `pull_data_from_rayven/1`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 4759, `pull_services_from_rayven/1`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 3861, `copy_rental_contracts/1`.
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 3154, `send_local_arrow_data/0` (Rayven IOTX8 real endpoint).
  - `[REDACTED-AWS-SMTP-PASSWORD]` — line 3157 (commented out, speed-only endpoint; still present in source).

These are bearer/UID credentials that grant write access to production Rayven tenants and CalAmp device management. Any person with access to this repository can push arbitrary data to customer tracking systems or enumerate/modify device firmware. They must be moved to runtime environment variables or a secrets manager immediately.

**A101-2 — HIGH — Hardcoded Basic Auth credential in `update_puls_firmware/1` (utility_controller.ex, line 151)**

The `Authorization` header for all CalAmp PULS requests includes:

```elixir
Authorization: "Basic VHJhY2tpbmdTb2x1dGlvbnM6dHZWSFFVc0NBZXU0"
```

This is a Base64-encoded HTTP Basic credential. Decoding `[REDACTED-AWS-SMTP-PASSWORD]` yields `TrackingSolutions:tvVHQUsCAeu4`. This username:password pair for the CalAmp PULS service is committed in plaintext (Base64 is not encryption).

**A101-3 — HIGH — Password in commented-out Rayven login code (utility_controller.ex, lines 3353–3356)**

The `rayven_login/2` function body contains a JavaScript code block in a comment that embeds a cleartext Rayven password:

```
'email': 'graham.oconnell@trackingsolutions.com.au',
'password': 'kz2xA8Y+n#btU*dk'
```

And separately at line 3369:

```
'Authorization': 'Basic be93fbd8a8a936198a368b2bfb4a4e76e6850896a9398652c399a137916e7219',
```

Even though these are in comments and not executed, they are committed to source control, constituting credential exposure. The email/password pattern suggests this is a live Rayven account credential.

**A101-4 — HIGH — Hardcoded Postman tracing headers and host hints in `update_puls_firmware/1` (utility_controller.ex, lines 153–161)**

The request headers include:

```elixir
"Postman-Token": "4ca5f9eb-e694-4501-8a36-cab9a08d00b4,32f442cd-eb53-4915-b387-0202196c741a"
```

These are specific Postman tokens that reveal the original development workflow. While these do not grant access by themselves, they indicate the function was copy-pasted from Postman and never cleaned up. More importantly, hardcoding `Host: "puls.calamp.com"` and `"User-Agent": "PostmanRuntime/7.15.2"` is unnecessary and leaks infrastructure details.

**A101-5 — MEDIUM — Hardcoded internal/test Rayven URL with UID in commented code (utility_controller.ex, lines 2426–2428, 3154–3157, 4707)**

Several Rayven IOTX8 URLs with UID tokens appear in commented-out sections but remain in source:

```
https://iotx8.rayven.io:8082/api/main?uid=3064ab70dea22793431c9a950d0435540f87&deviceid=385F
https://iotx8.rayven.io:8082/api/main?uid=30644d88731f847a4d4694cad17e2fa05aa5&deviceid=385F
```

Additionally, line 4707 contains a commented-out URL with a plaintext Rayven password:

```
https://my.rayven.io:8082/api/customTableData?ctid=4483&email=graham.oconnell@trackingsolutions.com.au&pw=kz2xA8Y+n#btU*dk
```

This is the same password found in the `rayven_login` comment. Password in URL is logged in HTTP access logs by any intermediary.

---

### §2: Authentication and Authorization

**A101-6 — CRITICAL — Multiple sensitive endpoints exposed without authentication (router.ex cross-reference)**

Reviewing the router, the following routes are served by the audited controllers and are **outside** the `:authenticated` pipeline:

In the `scope "/"` block (no authentication at all):
- `POST /erp-import` → `UtilityController.erp_import/2`
- `POST /driverid-converter` → `UtilityController.driverid_converter/2`
- `GET /dis-sync` → `UtilityController.sync_to_DISCorp/2`
- `POST /test-omega-data` → `UtilityController.process_incoming_omegawatch_data/2`
- `POST /prodisplay/event` → `UtilityController.process_prodisplay_event/2`
- `GET /geocode` → `UtilityController.do_geocode_lookup/2`
- `GET /error/:status_code` → `UtilityController.do_error/2`

The `/erp-import` endpoint accepts rental and service data and writes it to customer databases. An unauthenticated attacker can POST arbitrary ERP records, injecting false service dates, rental records, and customer data across any supported customer tenant by manipulating the `from` field. The `from` field in `erp_import/2` is used to determine the target customer schema — this is not authenticated, it is user-controlled (see A101-7 below).

`/prodisplay/event` writes vehicle telemetry event records to multiple customer databases without authentication. This allows an unauthenticated actor to inject falsified location, ignition, and operational data.

`/test-omega-data` echoes back the request body without validation — low severity on its own but the endpoint is unnecessary in production.

`/dis-sync` makes an outbound POST to the DISCorp API with hardcoded credentials (see A101-1) and is callable by anyone without authentication.

**A101-7 — CRITICAL — Customer (tenant) determined from user-supplied `from` field without authentication (`erp_import/2`, utility_controller.ex, lines 5666–5698)**

The `erp_import/2` function uses the `from` parameter in the POST body to select which customer database schema to write into:

```elixir
customer =
  case from do
    "SQLserver@sielift.com"  -> "vx_sielift"
    "rayven+cea@trackingsolutions.io" -> "vx_cea"
    _ -> "vx_dev"
```

There is no authentication, no HMAC signature verification, and no IP allowlisting on this endpoint. Any caller can supply any email address from the known list (all of which are visible in the source code) and write service records and rentals directly into production customer schemas.

**A101-8 — HIGH — `driverid_converter/2` accepts and processes any `from` field without authentication (utility_controller.ex, lines 6025–6090)**

Same pattern as A101-7. The `from` field controls the customer target. The endpoint is unauthenticated and the customer selection logic is identical to `erp_import/2`.

**A101-9 — HIGH — No IDOR protection in `[REDACTED-AWS-SMTP-PASSWORD]` CRUD endpoints (vx_abl_record_controller.ex)**

`show/2` (line 18), `update/2` (line 23), and `delete/2` (line 31) accept an `id` parameter and call `Vx.get_vx_abl_record!(id)` directly with no check that the record belongs to the authenticated user's organisation. While these endpoints are under the `:authenticated` pipeline (per router line 112 mapping `/rhm/services`), an authenticated user from one customer could access or delete ABL records belonging to another customer by supplying a different `id`. The `create/2` action similarly does not enforce customer scoping on the written record.

Note: `rhm_service_records/2` is correctly authenticated and scopes by `customer` from the JWT claims. `generate_service_record/3` is also JWT-scoped. The IDOR risk is confined to the raw CRUD actions.

**A101-10 — MEDIUM — `process_prodisplay_event/2` hardcodes the target customer as `"vx_ceaomega"` (utility_controller.ex, line 339)**

The Prodisplay inbound webhook has no authentication at all (no pipeline), yet it hardcodes `customer = "vx_ceaomega"` and writes event records. The fallback path for SSSL and Mondial EVGL customers is also hardcoded (`"vx_sssl"`, `"vx_mondialevgl"`). While this limits cross-customer data injection from a single call, the absence of any token or signature verification means any internet actor can flood those three customer schemas with fabricated vehicle events.

---

### §3: Input Validation and Injection

**A101-11 — HIGH — XML constructed via string interpolation with unsanitised user/database values (vx_abl_record_controller.ex, lines 148–160; utility_controller.ex, lines 5577–5586, 6003–6004)**

In `generate_service_record/3` (vx_abl_record_controller.ex), the `abl_xml` variable is assembled by direct interpolation of values that originate from the database or from user-controlled request parameters:

```elixir
abl_xml = "<?xml version='1.0'?><documentroot>" <>
  "<performed_by>#{branch_name}</performed_by>" <>
  "<hardwareid>#{thing.aadhardwareid}</hardwareid>" <>
  ...
```

`branch_name` ultimately comes from `Vx.get_branch_for_thing/2`, which queries the database. If any of these string values contain XML special characters (`<`, `>`, `&`, `"`, `'`), the resulting XML will be malformed. If branch names or hardware descriptions are user-editable, this is an XML injection path. The same pattern appears in `check_for_future_date/2` (utility_controller.ex, lines 5577–5586) and `process_service_from_erp/2` (line 6003–6004) where event IDs, customer strings, hardware IDs, and timestamps are interpolated directly into XML.

**A101-12 — MEDIUM — `do_error/2` calls `Plug.Conn.Status.reason_phrase/1` with user-supplied integer, no bounds check (utility_controller.ex, lines 982–989)**

```elixir
def do_error(conn, %{"status_code" => status_code}) do
  status_code_int = String.to_integer(status_code)
  status_phrase = Plug.Conn.Status.reason_phrase(status_code_int)
```

`String.to_integer/1` will raise `ArgumentError` on non-integer input (unhandled). `Plug.Conn.Status.reason_phrase/1` raises `ArgumentError` for unknown status codes. These unhandled exceptions will be caught by Phoenix's error handler, but the stack trace may be returned to the client depending on the ErrorView configuration. The endpoint is also unauthenticated (router line 184).

**A101-13 — MEDIUM — `do_geocode_lookup/2` takes latitude and longitude from unauthenticated user input and passes them to external geocoding calls without validation (utility_controller.ex, lines 991–1050)**

```elixir
def do_geocode_lookup(conn, %{"lat" => inc_lat, "long" => inc_long}) do
  {f_lat, _} = Float.parse(inc_lat)
  {f_long, _} = Float.parse(inc_long)
```

`Float.parse/1` returns `:error` if the input cannot be parsed; the result is pattern-matched as a two-element tuple, so `:error` causes a `MatchError` (unhandled). This causes an uncaught exception visible to the caller. The endpoint is unauthenticated (router line 183). No bounds checking on latitude/longitude values (±90, ±180). SSRF is not applicable as the call goes to a Geonames dependency, but unvalidated float coordinates that are out of range may produce unexpected upstream behaviour.

**A101-14 — LOW — `create_update_object/1` in `pivotel_controller.ex` calls `String.to_float/1` on incoming message fields without guard (lines 55–56, 97–99)**

```elixir
:latitude  => String.to_float(latitude),
:longitude => String.to_float(longitude),
```

`String.to_float/1` raises `ArgumentError` if the input is not a valid float string. If Pivotel sends a malformed or missing float field, the process handling this request will crash. The catch-all `create_update_object/1` clause (line 103) returns an empty map but is only reached for an entirely different message structure, not for a LOCATION message with a bad latitude value.

**A101-15 — LOW — `get_additional_data/1` and `next_service/1` read local CSV files at runtime without path sanitisation (utility_controller.ex, lines 6172–6262)**

```elixir
File.stream!("vehicle_status.csv")
File.stream!("next_services.csv")
```

These use relative paths, meaning they resolve against the OS working directory at runtime (typically the OTP release root). The filenames are hardcoded so path traversal is not a risk here, but if these files are absent the entire `send_vehicle_to_rayven/2` call (which calls both functions) will raise a `File.Error` that is unhandled and will propagate up through the Task.async_stream. More critically, the contents of these CSV files are treated as trusted data piped into the Rayven payload. If an attacker can modify these files on the server (e.g. via a separate vulnerability), they can inject arbitrary data into every Rayven vehicle sync.

---

### §4: Session and CSRF

**A101-16 — HIGH — Inbound webhook endpoints (prodisplay, erp-import, driverid-converter, test-omega) served in the `:api_xml` pipeline which does not enforce CSRF protection and has no token verification**

The `:api_xml` pipeline (router lines 18–22) only sets `plug :fetch_session` and `plug :accepts, ["xml"]`. There is no CSRF plug, no API key middleware, and no bearer token requirement. For endpoints receiving webhook-style POST requests from third-party systems, CSRF is typically not the primary risk, but combined with the complete lack of any authentication (A101-6), there is no defence-in-depth.

§4: No other session/CSRF issues found in these three files specifically; CSRF is enabled in `:browser` pipeline (router line 8) and JWT auth in `:authenticated` pipeline. These files do not handle WebSocket channels.

---

### §5: File and Data Handling

**A101-17 — HIGH — Vehicle GPS coordinates, driver IDs, ignition status, and full event telemetry logged to console via `IO.puts` and `IO.inspect` in production code**

Numerous functions in `utility_controller.ex` and `pivotel_controller.ex` emit PII and fleet operational data to stdout, which in production typically lands in application logs accessible to any operator or log aggregation system:

- `pivotel_controller.ex` line 47: `IO.puts "Need to store a location event"` — though not the data itself, the surrounding context at lines 8 and 48 logs hardware IDs.
- `utility_controller.ex` line 246: logs `hardwareid`, `customer`, `to_date`, `from_date`, `timezone`, `category` in a single `IO.puts`.
- Lines 751–759: logs metadata, location (including latitude/longitude), truck, and TPMS data for specific hardware IDs.
- Lines 1092, 1100, etc.: logs hardware IDs and customer codes during Rayven sync.
- Line 5583 (check_for_future_date): the `abl_xml` string interpolated into log XML contains `event.gmtdatetime`, `event.hardwareid`, and `event.dateinqueue`.
- Line 6154: logs Wiegand driver ID parity bits.

GPS coordinates and driver IDs constitute PII under Australian privacy law and GDPR for any European customers. Driver Wiegand/card IDs at line 6154 (`IO.puts "upper_parity: ..."`) are less sensitive but still operational security data.

**A101-18 — MEDIUM — Error detail (Ecto changeset errors) returned verbatim to client in `process_prodisplay_event/2` (utility_controller.ex, lines 425–426, 434–436, 441–445)**

```elixir
Plug.Conn.send_resp(400,
  Poison.encode!(%{message: Kernel.inspect(thingomega_event_result)}))
```

When an Ecto changeset fails, `error.errors` is an Erlang keyword list of changeset validation errors. `Kernel.inspect/1` converts this to its Elixir term representation and returns it in the HTTP 400 response. This discloses internal schema field names and validation rules to unauthenticated callers. The same pattern applies to `event_id` (line 444): if the event write fails, the raw error structure is returned.

**A101-19 — MEDIUM — `process_ebs_get_hour_meter/2` hardcodes the customer schema prefix as `"vx_cea_latest"` (utility_controller.ex, line 3002)**

```elixir
|> Repo.all(prefix: "vx_cea_latest")
```

This function is called with a `hardwareid` parameter from CSV data (imported via `process_ebs/0` and `process_monthly_movements/0`). Regardless of which customer the calling context intends, the query always runs against `vx_cea_latest`. This is a logic bug that causes cross-customer data leakage: data from another customer's CSV import will be evaluated against CEA Latest's event database.

**A101-20 — MEDIUM — Fleet and rental data containing customer PII sent to Rayven without redaction (utility_controller.ex, send_vehicle_to_rayven/2, lines 1500–1512)**

The Rayven payload includes the end-customer's full address, primary contact name, telephone, and email address:

```elixir
address_1: rental.customer.aaaaddr1,
address_2: rental.customer.aaaaddr2,
primary_contact: rental.customer.aaaprimcont,
primary_telephone: rental.customer.aaaprimtel,
primary_email: rental.customer.aaaprimemail,
```

This data is transmitted to `my.rayven.io:8082` which is a third-party service. The appropriateness of this transfer should be reviewed against privacy agreements. The code itself makes no attempt to minimise or pseudonymise the data before transmission.

**A101-21 — INFO — `check_for_future_date/2` silently deletes telemetry events (utility_controller.ex, lines 5567–5616)**

Events with `gmtdatetime` more than 3600 seconds in the future relative to `dateinqueue` are permanently deleted from the database. While this is intentional behaviour, it operates without any operator notification (the email alert code is commented out at lines 5613–5614). Deleted events cannot be recovered. This is noted as an operational data integrity concern rather than a direct security finding.

---

### §6: Dependencies

§6: No dependency files (`mix.exs`, `mix.lock`) were assigned to this agent. Dependency review is deferred to the agent assigned those files.

---

### §7: Infrastructure Exposure

**A101-22 — HIGH — Production infrastructure hostnames, UIDs, and device IDs hardcoded in source (utility_controller.ex)**

The following production infrastructure endpoints are hardcoded in plain source:

- `https://my.rayven.io:8082` — production Rayven MQTT/HTTP gateway (multiple locations)
- `https://iotx8.rayven.io:8082` — Rayven IOTX8 instance (lines 3154, 3864, 3961)
- `https://external_apis.rayven.io` — Rayven external API (line 3392)
- `https://407110-01.disprism.com/updateEquipmentHourMeter` — DISCorp production endpoint (line 1054)
- `https://puls.calamp.com/service/firmware` — CalAmp PULS production service (lines 145, 170, 201)
- `https://api-test.mobilehourmeter.com/erp-import` — Internal test/staging endpoint (line 4805); the use of the word "test" suggests this may be a non-production service receiving production data.

Together with the hardcoded API keys (A101-1), this constitutes a full roadmap of the production integration topology visible to any repository reader.

**A101-23 — MEDIUM — `do_geocode_lookup/2` is accessible without authentication and makes outbound calls to Geonames (utility_controller.ex, lines 991–1050; router.ex line 183)**

The endpoint at `GET /geocode?lat=...&long=...` is served in the unauthenticated `scope "/"` pipeline. It makes outbound HTTP calls to `Geonames.find_nearby_streets_osm` and `Geonames.find_nearby_place_name` for any user-supplied coordinate pair. This could be abused to use the server as a geocoding proxy, consuming Geonames API quota. Additionally, the endpoint leaks whether the server has Geonames API access configured.

**A101-24 — INFO — TLS certificate loading for Rayven done correctly with `verify: :verify_peer` and custom CA bundle (utility_controller.ex, lines 6267–6291)**

The `rayven_ssl_opts/0` function correctly sets `verify: :verify_peer`, loads the system CA bundle via `:certifi`, and supplements it with a Sectigo Root R46 certificate from `priv/certs/`. This is the fix described in the most recent commit (`e486dd8`). No TLS misconfiguration was found here.

---

## Summary of Findings

| ID | Severity | File | Description |
|---|---|---|---|
| A101-1 | CRITICAL | utility_controller.ex | Multiple live API keys hardcoded in source (CalAmp, DISCorp, Rayven UIDs) |
| A101-2 | HIGH | utility_controller.ex | Base64-encoded HTTP Basic credential for CalAmp PULS hardcoded (line 151) |
| A101-3 | HIGH | utility_controller.ex | Cleartext Rayven password in comment block (lines 3353–3376) |
| A101-4 | HIGH | utility_controller.ex | Postman tokens and redundant Host header in production code (lines 153–161) |
| A101-5 | MEDIUM | utility_controller.ex | Rayven URL with UIDs and password in commented-out code (lines 2426, 4707) |
| A101-6 | CRITICAL | utility_controller.ex / router.ex | Sensitive write endpoints (erp-import, prodisplay, dis-sync) exposed without authentication |
| A101-7 | CRITICAL | utility_controller.ex | Customer/tenant determined from unauthenticated user-supplied `from` field in erp_import/2 |
| A101-8 | HIGH | utility_controller.ex | Same unauthenticated tenant selection in driverid_converter/2 |
| A101-9 | HIGH | vx_abl_record_controller.ex | IDOR: CRUD actions (show, update, delete) do not scope ABL records to authenticated user's organisation |
| A101-10 | MEDIUM | utility_controller.ex | Prodisplay webhook unauthenticated and hardcodes target customer |
| A101-11 | HIGH | vx_abl_record_controller.ex, utility_controller.ex | XML injection via string interpolation of unsanitised database/user values into abl_xml |
| A101-12 | MEDIUM | utility_controller.ex | Unhandled exception in do_error/2 on invalid status_code input |
| A101-13 | MEDIUM | utility_controller.ex | Unvalidated float parse in do_geocode_lookup/2 causes unhandled MatchError |
| A101-14 | LOW | pivotel_controller.ex | String.to_float/1 raises on malformed Pivotel message fields |
| A101-15 | LOW | utility_controller.ex | Runtime CSV file reads (vehicle_status.csv, next_services.csv) with no path validation; absence raises unhandled error |
| A101-16 | HIGH | utility_controller.ex / router.ex | No CSRF or token verification on inbound webhook endpoints |
| A101-17 | HIGH | utility_controller.ex, pivotel_controller.ex | GPS coordinates, driver IDs, and customer PII logged to stdout in production |
| A101-18 | MEDIUM | utility_controller.ex | Ecto changeset errors returned verbatim in HTTP 400 responses from prodisplay endpoint |
| A101-19 | MEDIUM | utility_controller.ex | process_ebs_get_hour_meter/2 hardcodes customer schema prefix as "vx_cea_latest" — cross-customer data leakage |
| A101-20 | MEDIUM | utility_controller.ex | Full customer PII (address, phone, email) transmitted to third-party Rayven service without redaction |
| A101-21 | INFO | utility_controller.ex | Future-dated events silently deleted; alert email commented out |
| A101-22 | HIGH | utility_controller.ex | All production infrastructure hostnames and device IDs hardcoded in source |
| A101-23 | MEDIUM | utility_controller.ex / router.ex | Unauthenticated geocode endpoint usable as Geonames API proxy |
| A101-24 | INFO | utility_controller.ex | TLS Rayven connection uses verify_peer with correct CA bundle — no finding |

<!-- A104.md -->
# Audit Report A104
**Run:** 2026-02-27-01
**Agent:** A104
**Repo:** api_server
**Branch:** master
**Stack:** Elixir/Phoenix

---

## Assigned Files

1. `lib/api_server_web/controllers/vx_access_fob_controller.ex`
2. `lib/api_server_web/controllers/vx_customer_controller.ex`
3. `lib/api_server_web/controllers/vx_fleet_association_controller.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/vx_access_fob_controller.ex`

**Module name:** `ApiServerWeb.VXAccessFobController`

**Public functions (def):**

| Name    | Arity | Line |
|---------|-------|------|
| index   | 2     | 9    |
| show    | 2     | 14   |
| delete  | 2     | 19   |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXAccessFob` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

---

### File 2: `lib/api_server_web/controllers/vx_customer_controller.ex`

**Module name:** `ApiServerWeb.VXCustomerController`

**Public functions (def):**

| Name    | Arity | Line |
|---------|-------|------|
| index   | 2     | 9    |
| create  | 2     | 16   |
| show    | 2     | 32   |
| update  | 2     | 39   |
| delete  | 2     | 51   |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXCustomer` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

---

### File 3: `lib/api_server_web/controllers/vx_fleet_association_controller.ex`

**Module name:** `ApiServerWeb.VXFleetAssociationController`

**Public functions (def):**

| Name    | Arity | Line |
|---------|-------|------|
| index   | 2     | 9    |
| show    | 2     | 14   |
| delete  | 2     | 19   |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXFleetAssociation` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

---

## Supporting Context Examined

The following files were read to evaluate the assigned controllers in full context:

- `lib/api_server_web/router.ex` — full router, all pipelines and scopes
- `lib/api_server_web/auth_pipeline.ex` — Guardian plug pipeline
- `lib/api_server/guardian.ex` — Guardian callbacks
- `lib/api_server/vx/vx.ex` — context functions (relevant excerpts: lines 140–217, 420–466, 2865–2960)
- `lib/api_server/vx/vx_access_fob.ex` — VXAccessFob schema
- `lib/api_server/vx/vx_customer.ex` — VXCustomer schema and changeset
- `lib/api_server/vx/vx_fleet_association.ex` — VXFleetAssociation schema
- `lib/api_server_web/controllers/fallback_controller.ex` — FallbackController
- `lib/api_server_web/views/vx_access_fob_view.ex` — VXAccessFobView
- `lib/api_server_web/views/vx_customer_view.ex` — VXCustomerView

---

## Checklist Review

### §1: Secrets and Configuration

No hardcoded secrets, credentials, API keys, or environment variable defaults are present in any of the three assigned controller files.

§1: No issues found.

---

### §2: Authentication and Authorization

#### A104-1 — CRITICAL: `Guardian.Plug.EnsureAuthenticated` is commented out — all authenticated routes are effectively unauthenticated

File: `lib/api_server_web/auth_pipeline.ex`, line 7

```elixir
plug Guardian.Plug.VerifyHeader, realm: "Bearer"
# plug Guardian.Plug.EnsureAuthenticated   <-- DISABLED
plug Guardian.Plug.LoadResource
```

The `:authenticated` pipeline only calls `VerifyHeader` (which parses and validates the token if present, but does NOT reject requests that carry no token) and `LoadResource` (which loads the user if a token was found). `EnsureAuthenticated` — the plug that actually rejects unauthenticated connections with a 401 — is commented out.

Consequence: every route registered under `pipe_through([:api, :authenticated])` in the router, including ALL customer, fleet, thing, user, geofence, and rental management routes, accepts requests that carry no `Authorization` header at all. An anonymous caller can invoke any of those endpoints without credentials.

This directly affects all three assigned controllers:
- `[REDACTED-AWS-SMTP-PASSWORD]` — index, create, show, update, delete (lines 139–143 of router)
- `[REDACTED-AWS-SMTP-PASSWORD]` — no routes currently registered (see A104-3), but the infrastructure flaw applies to any future registration
- `[REDACTED-AWS-SMTP-PASSWORD]` — same as above

**Remediation:** Uncomment `plug Guardian.Plug.EnsureAuthenticated` in `lib/api_server_web/auth_pipeline.ex`.

---

#### A104-2 — CRITICAL: IDOR — `[REDACTED-AWS-SMTP-PASSWORD]` performs no organisation-scoped queries; `index`, `show`, and `delete` operate across all tenants

File: `lib/api_server_web/controllers/vx_access_fob_controller.ex`

```elixir
def index(conn, _params) do
  vxaccessfobs = Vx.list_vxaccessfobs()          # no customer scope
  render(conn, "index.json", vxaccessfobs: vxaccessfobs)
end

def show(conn, %{"id" => id}) do
  vx_access_fob = Vx.get_vx_access_fob!(id)      # bare Repo.get! — no customer scope
  render(conn, "show.json", vx_access_fob: vx_access_fob)
end

def delete(conn, %{"id" => id}) do
  vx_access_fob = Vx.get_vx_access_fob!(id)      # bare Repo.get! — no customer scope
  with {:ok, %VXAccessFob{}} <- Vx.delete_vx_access_fob(vx_access_fob) do
    send_resp(conn, :no_content, "")
  end
end
```

The backing context functions (vx.ex lines 145–147 and 163):

```elixir
def list_vxaccessfobs do
  Repo.all(VXAccessFob)        # returns ALL rows in the table, all organisations
end

def get_vx_access_fob!(id), do: Repo.get!(VXAccessFob, id)   # no prefix/org filter
```

Neither the controllers nor the context functions extract a `customer` claim from the JWT or apply any organisation-scoped prefix. Any authenticated user (or, due to A104-1, any anonymous caller) can list, view, and permanently delete access fobs belonging to other organisations. The VXAccessFob schema has no `prefix:` (multi-tenant schema) support applied at query time.

Compare with the correct pattern demonstrated in `[REDACTED-AWS-SMTP-PASSWORD]` and the corresponding context functions, which pass `prefix: customer` to every Repo call.

---

#### A104-3 — HIGH: `[REDACTED-AWS-SMTP-PASSWORD]` and `[REDACTED-AWS-SMTP-PASSWORD]` are not registered in the router — dead code with unresolved security debt

Neither `ApiServerWeb.VXAccessFobController` nor `ApiServerWeb.VXFleetAssociationController` appears anywhere in `lib/api_server_web/router.ex`. The controllers compile and ship with the application but are unreachable through any declared route.

This creates a security debt risk: if routes are added in future (via a resources/4 macro or explicit get/post/delete declarations) without a security review, the IDOR and missing authentication issues documented in A104-1 and A104-2 will become immediately exploitable. There is no defence-in-depth mechanism (no organisation check, no customer claim extraction) in either controller.

---

#### A104-4 — CRITICAL: IDOR — `[REDACTED-AWS-SMTP-PASSWORD]` performs no organisation-scoped queries; `index`, `show`, and `delete` operate across all tenants

File: `lib/api_server_web/controllers/vx_fleet_association_controller.ex`

```elixir
def index(conn, _params) do
  vxfleetassociations = Vx.list_vxfleetassociations()          # no customer scope
  render(conn, "index.json", vxfleetassociations: vxfleetassociations)
end

def show(conn, %{"id" => id}) do
  vx_fleet_association = Vx.get_vx_fleet_association!(id)      # bare Repo.get! — no customer scope
  render(conn, "show.json", vx_fleet_association: vx_fleet_association)
end

def delete(conn, %{"id" => id}) do
  vx_fleet_association = Vx.get_vx_fleet_association!(id)      # bare Repo.get! — no customer scope
  with {:ok, %VXFleetAssociation{}} <- Vx.delete_vx_fleet_association(vx_fleet_association) do
    send_resp(conn, :no_content, "")
  end
end
```

The backing context functions (vx.ex lines 427–466):

```elixir
def list_vxfleetassociations do
  VXFleetAssociation
    |> Ecto.Query.where([r], r.aafgroupid != ^"29")
    |> Ecto.Query.preload(:fleet)
    |> Ecto.Query.preload(:thing)
    |> Repo.all                   # no prefix: customer — returns all organisations
end

def get_vx_fleet_association!(id), do: Repo.get!(VXFleetAssociation, id)  # no org filter
```

Fleet associations (the mapping of vehicles/things to fleets) represent core fleet management data. Unrestricted listing or deletion of these records across customer boundaries is a severe confidentiality and integrity violation. This is a cross-tenant IDOR of the same character as A104-2.

---

#### A104-5 — MEDIUM: `VXCustomerController.index` returns all customers in the caller's organisation-scoped schema prefix, but the `customer` claim is sourced from the JWT without independent verification against the authenticated user's actual organisation

File: `lib/api_server_web/controllers/vx_customer_controller.ex`, line 10

```elixir
def index(conn, _params) do
  customer = ApiServer.Guardian.Plug.current_claims(conn)["customer"]
  vx_customers = Vx.list_customers(customer)
  render(conn, "index.json", vx_customers: vx_customers)
end
```

The `customer` value is used as the Postgres schema prefix for all Repo calls in this controller. It is taken directly from the JWT claims and used as a raw schema-prefix string without independent cross-checking against the user record that was loaded by `LoadResource`. If a token can be crafted or the `customer` claim can be tampered with (JWT symmetric key compromise, or algorithm confusion), an attacker can pivot to an arbitrary organisation's schema by setting `customer` to a known schema name.

This is a systemic issue across the controller and the Vx context: the customer prefix is always trusted from the token, never verified against a server-side user-organisation mapping. The impact is conditional on token forgery, hence MEDIUM.

---

### §3: Input Validation and Injection

#### A104-6 — HIGH: Raw `inspect/1` of Ecto changeset errors returned verbatim in HTTP response body

File: `lib/api_server_web/controllers/vx_customer_controller.ex`, lines 27–28

```elixir
IO.inspect error
send_resp(conn, :internal_server_error,
  "{\"error\": \"error creating customer\", \"reason\": \"#{inspect error.errors}\" }")
```

`inspect error.errors` serialises the full Ecto changeset error keyword list directly into the JSON response body. This response is returned to the caller with HTTP 500. The exposed content includes:
- Internal database column names (`:aaacustcode`, `:aaaname`, etc.) derived from the schema
- Unique constraint names (`:UQ1`) — internal database object names
- Ecto validation metadata

Additionally, `IO.inspect error` writes the full error struct to stdout/the application log, which in production will be visible in log aggregation systems.

The `IO.inspect` call is a leftover debug statement. Neither `IO.inspect` nor `inspect/1` should be used in production error handling paths.

---

#### A104-7 — MEDIUM: `VXCustomerController.create` computes `aaacustcode` from user-supplied `name` inside the schema module without input length or character validation before the string manipulation chain

File: `lib/api_server/vx/vx_customer.ex`, line 36

```elixir
|> Vx.update_key_if_value(:aaacustcode,
    String.upcase(
      String.slice(
        String.replace(
          String.reverse(customer_json["name"]), " ", ""), 0..8)))
```

`customer_json["name"]` is the raw user-supplied value from the HTTP request body, passed through `String.reverse/1`, `String.replace/3`, `String.slice/2`, and `String.upcase/1` without length-bounding or character validation before the chain executes. A name value of unusual length or encoding (e.g., very long strings, or strings with complex Unicode grapheme clusters) will flow through these operations without a guard. While this is not a direct injection issue, it bypasses the Ecto `validate_required([:aaaname])` and `unique_constraint` defined later — the `aaacustcode` derivation happens before the changeset cast, so malformed input could cause runtime errors surfaced back through the `inspect error.errors` path (compounding A104-6).

---

### §4: Session and CSRF

The assigned controllers are JSON API controllers operating under the `:api` pipeline, which does not use `protect_from_forgery`. This is appropriate for token-authenticated JSON APIs. The Guardian bearer-token model does not rely on cookies and is not subject to CSRF.

§4: No issues found in the assigned files.

---

### §5: File and Data Handling

#### A104-8 — MEDIUM: Fleet association and access fob data (vehicle assignments, fob codes) returned with no organisation boundary enforcement

As documented under A104-2 and A104-4, `list_vxfleetassociations` returns vehicle-to-fleet assignment records across all customer schemas (no `prefix:` applied), and `list_vxaccessfobs` returns all access fob records including fob codes. The `VXAccessFobView` renders `fob_code` directly:

```elixir
def render("vx_access_fob.json", %{vx_access_fob: vx_access_fob}) do
  %{id: vx_access_fob.id,
    fob_code: vx_access_fob.fob_code}
end
```

`fob_code` is a physical access credential used to control operator access to forklifts. Exposure of fob codes across customer boundaries constitutes a safety and physical-security risk beyond the data confidentiality concern. This point reinforces A104-2 with a specific safety dimension.

---

### §6: Dependencies

Dependency review (`mix.exs`, `mix.lock`) is out of scope for the assigned files in this pass. No dependency concerns are introduced by the three assigned controllers.

§6: No issues found in assigned files.

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IPs, internal service URLs, CORS configuration, or TLS configuration is present in the three assigned controller files.

§7: No issues found.

---

## Findings Summary

| ID      | Severity | File(s)                                      | Description |
|---------|----------|----------------------------------------------|-------------|
| A104-1  | CRITICAL | `auth_pipeline.ex`                           | `EnsureAuthenticated` is commented out — all `:authenticated` routes accept unauthenticated requests |
| A104-2  | CRITICAL | `vx_access_fob_controller.ex`, `vx.ex`       | IDOR: `index`, `show`, `delete` have no organisation scope; all access fob records from all tenants are accessible |
| A104-3  | HIGH     | `vx_access_fob_controller.ex`, `vx_fleet_association_controller.ex`, `router.ex` | Both controllers are unregistered dead code with unresolved IDOR security debt — any future route registration exposes the flaws immediately |
| A104-4  | CRITICAL | `vx_fleet_association_controller.ex`, `vx.ex` | IDOR: `index`, `show`, `delete` have no organisation scope; all fleet-vehicle associations from all tenants are accessible |
| A104-5  | MEDIUM   | `vx_customer_controller.ex`, `guardian.ex`   | `customer` JWT claim used as raw Repo prefix without server-side organisation cross-check |
| A104-6  | HIGH     | `vx_customer_controller.ex`                  | Internal Ecto changeset errors (including schema column and constraint names) returned verbatim in HTTP 500 response body; `IO.inspect` debug call left in production code |
| A104-7  | MEDIUM   | `vx_customer.ex` (called from controller)    | User-supplied `name` string processed through multiple operations without length/character validation before changeset cast |
| A104-8  | MEDIUM   | `vx_access_fob_controller.ex`, `vx_fleet_association_controller.ex` | Physical fob codes and fleet-vehicle associations exposed with no tenant boundary — fob code exposure has physical access-control safety implications |

<!-- A107.md -->
# Audit Report A107
**Agent:** A107
**Run:** 2026-02-27-01
**Stack:** Elixir/Phoenix
**Branch:** master
**Assigned files:**
- lib/api_server_web/controllers/vx_fleet_controller.ex
- lib/api_server_web/controllers/vx_rental_controller.ex
- lib/api_server_web/controllers/vx_restriction_controller.ex

---

## Reading Evidence

### File 1: lib/api_server_web/controllers/vx_fleet_controller.ex

**Module name:** `ApiServerWeb.VXFleetController`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `create` | 2 | 9 |
| `get_fleets` | 2 | 19 (clause 1: admin) |
| `get_fleets` | 2 | 27 (clause 2: default) |
| `get_fleets_with_equipment` | 2 | 35 |
| `create_fleet` | 2 | 68 |
| `delete_fleet` | 2 | 91 |
| `get_equipment_in_fleet` | 2 | 105 |
| `manage_fleet` | 2 | 110 |
| `update_fleet` | 2 | 119 |

**defstruct / defexception / schema:** None defined in this module.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXFleet`
- `action_fallback ApiServerWeb.FallbackController`

---

### File 2: lib/api_server_web/controllers/vx_rental_controller.ex

**Module name:** `ApiServerWeb.VXRentalController`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `get_rentals` | 2 | 9 (clause 1: closed=1) |
| `get_rentals` | 2 | 30 (clause 2: default) |
| `get_midpac_style_rental_report` | 2 | 51 |
| `get_rental_anniversaries` | 2 | 110 |
| `create_rental` | 2 | 158 |
| `update_rental` | 2 | 174 |
| `delete_rental` | 2 | 191 |
| `rhm_active_rental` | 2 | 206 |

**defstruct / defexception / schema:** None defined in this module.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXRental`
- `action_fallback ApiServerWeb.FallbackController`

---

### File 3: lib/api_server_web/controllers/vx_restriction_controller.ex

**Module name:** `ApiServerWeb.VXRestrictionController`

**Public functions (def):** None.

**defstruct / defexception / schema:** None.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXRestriction`
- `action_fallback ApiServerWeb.FallbackController`

---

## Checklist Review

### §1: Secrets and Configuration

No config files, hardcoded credentials, API keys, or secrets present in these three controller files. No module attributes referencing secrets.

§1: No issues found.

---

### §2: Authentication and Authorization

**Router context (from lib/api_server_web/router.ex):**

The `/api/v1` scope has two sub-blocks. The first two routes in the scope — `GET /rhm/engine_usage` and `GET /rhm/monday_hour_meters` — appear **before** the `pipe_through([:api, :authenticated])` call (line 33). All routes added after that call (lines 36 onward), which includes all fleet and rental routes, go through `:authenticated` (i.e., `ApiServer.Guardian.AuthPipeline`).

**IDOR analysis — fleet controller:**

The `get_fleets/2` (both clauses), `get_fleets_with_equipment/2`, `create_fleet/2` all read `customer` from the JWT claims (`current_claims(conn)["customer"]`) and pass it as a scoping parameter to the Vx context. This is correct: the organisation is derived from the token, not from user-supplied input.

However, the following functions accept `customer` directly from request parameters (URL path segment `/:customer/`) and pass it to data-layer calls **without verifying it matches the authenticated token's customer claim**:

- `delete_fleet/2` (line 91): `%{"customer" => customer, "id" => id}` — `customer` from path, not from JWT.
- `get_equipment_in_fleet/2` (line 105): `%{"customer" => customer, "id" => fleet_id}` — `customer` from path, not from JWT.
- `manage_fleet/2` (line 110): `%{"customer" => customer, "id" => fleet_id, ...}` — `customer` from path, not from JWT.
- `update_fleet/2` (line 119): `%{"customer" => customer, "fleet" => fleet_params}` — `customer` from path, not from JWT.
- `create_fleet/2` (line 68): pattern match includes `%{"customer" => cust, ...}` from the path. The variable `cust` is bound from the path parameter but is **never used**; instead `customer` is re-read from the JWT claims (line 69). While the data operations use the JWT-derived `customer`, the unused `cust` variable is a dead-code smell, but functionally this function is safe.

**IDOR analysis — rental controller:**

The following rental functions accept `customer` from the route path segment `/:customer/` and use it directly for data access without verifying it against the JWT customer claim:

- `create_rental/2` (line 158): `%{"customer" => customer, ...}` — `customer` from path parameter used directly in `Vx.create_rental/2` and `Vx.get_rental/2`.
- `update_rental/2` (line 174): `%{"customer" => customer, ...}` — same issue.
- `delete_rental/2` (line 191): `%{"customer" => customer, ...}` — same issue.

The following rental functions correctly derive `customer` from JWT claims:
- `get_rentals/2` both clauses: JWT-derived.
- `get_midpac_style_rental_report/2`: JWT-derived.
- `get_rental_anniversaries/2`: JWT-derived.
- `rhm_active_rental/2`: JWT-derived.

Note: `get_rentals/2` clause 1 (line 9) matches `%{"customer" => _customer, "closed" => "1"}` — the `_customer` path param is explicitly discarded and the JWT claim is used. Correct.

---

**A107-1 — HIGH — IDOR: fleet write/delete operations trust URL-supplied customer parameter**

Files: `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 91, 105, 110, 119.

`delete_fleet/2`, `get_equipment_in_fleet/2`, `manage_fleet/2`, and `update_fleet/2` all destructure `customer` from the URL path parameter and pass it directly to Vx context calls (`Vx.get_vx_fleet/2`, `Vx.delete_vx_fleet/2`, `Vx.get_equipment_in_fleet/2`, `Vx.update_fleet_assocs/3`, `Vx.update_vx_fleet/3`) without checking that the supplied customer code matches the authenticated user's organisation from the JWT claims (`current_claims(conn)["customer"]`).

An authenticated user who belongs to customer `CUST_A` can supply `CUST_B` in the URL path and perform delete, update, and fleet membership management operations against another customer's fleets. The only scoping is the user-supplied string, not the token-bound identity.

Affected routes (from router.ex):
- `DELETE /api/v1/rhm/:customer/fleet/:id` → `delete_fleet/2`
- `GET /api/v1/rhm/:customer/fleet/:id/equipment` → `get_equipment_in_fleet/2`
- `POST /api/v1/rhm/:customer/fleet/:id/manage` → `manage_fleet/2`
- `POST /api/v1/rhm/:customer/fleet/` → `update_fleet/2`

Fix direction: Extract the authenticated customer from `ApiServer.Guardian.Plug.current_claims(conn)["customer"]` in each function (as is already done in `get_fleets/2`) and discard or validate the path parameter against it.

---

**A107-2 — HIGH — IDOR: rental write/delete operations trust URL-supplied customer parameter**

File: `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 158, 174, 191.

`create_rental/2`, `update_rental/2`, and `delete_rental/2` all destructure `customer` from the URL path parameter and use it directly for every data access call without verifying it against the JWT customer claim.

An authenticated user from customer `CUST_A` can supply `CUST_B` in the URL and create rentals, update rentals, or delete rentals against another organisation's data.

Affected routes:
- `PUT /api/v1/rhm/:customer/rentals/` → `create_rental/2`
- `POST /api/v1/rhm/:customer/rentals/` → `update_rental/2`
- `DELETE /api/v1/rhm/:customer/rentals/:id` → `delete_rental/2`

Fix direction: Same as A107-1 — derive `customer` from the JWT, not from the URL.

---

**A107-3 — MEDIUM — Unauthenticated endpoints before pipe_through in same scope block**

File: `lib/api_server_web/router.ex`, lines 30-32 (context for these controllers).

The router's first `/api/v1` scope block places two GET routes (`/rhm/engine_usage` and `/rhm/monday_hour_meters`) before the `pipe_through([:api, :authenticated])` macro call. In Phoenix, `pipe_through` applies to routes that follow it in the same scope, so these two routes receive no authentication pipeline. While these specific routes dispatch to `VXThingController` (not the files under audit), the pattern demonstrates that route ordering controls authentication — a developer adding a new route above line 33 in this block would silently bypass authentication. This is an architectural fragility that affects the entire `/api/v1` scope.

This finding is included because the fleet and rental controllers' security depends on this pipeline structure.

---

§2: Issues found — see A107-1, A107-2, A107-3.

---

### §3: Input Validation and Injection

**String.to_integer usage:** `manage_fleet/2` at line 113 calls `String.to_integer(fleet_id)` where `fleet_id` comes from the URL path parameter. If `fleet_id` is not a valid integer string, `String.to_integer/1` raises an `ArgumentError` at runtime. This is not caught and will result in an unhandled exception propagating up. No user-controlled atom creation (`String.to_atom/1`) is present. No `Code.eval_string/1`, no `:erlang.binary_to_term/1`, no `Kernel.apply/3` with user-controlled module/function names.

No raw SQL fragments with user input interpolation are visible in controller code; queries are delegated to the `Vx` context module (not in scope for this audit).

**Changeset usage:** `create_fleet/2` and `update_fleet/2` use `ApiServer.Vx.VXFleet.convert_json_to_changeset/1`. `create_rental/2` and `update_rental/2` use `ApiServerWeb.VXRentalView.convert_json_to_changeset/1`. The safety of these conversions depends on those functions (not in scope), but the controller does not perform any raw parameter interpolation into queries itself.

**A107-4 — LOW — Unguarded String.to_integer on user input may cause 500 crash**

File: `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 113.

```elixir
|> Enum.map(fn(id) -> %{aafgroupid: String.to_integer(fleet_id), aafthingid: id} end)
```

`fleet_id` is a URL path parameter (string). `String.to_integer/1` raises `ArgumentError` if the value is not a valid integer (e.g., a non-numeric string or path traversal attempt). This is not caught; the exception will propagate to the fallback controller or cause a 500. An attacker can trivially trigger repeated 500 responses. The `FallbackController` does not handle raw exceptions (only `{:error, %Ecto.Changeset{}}` and `{:error, :not_found}`), so the crash surfaces as an unhandled exception to the Phoenix error handler.

§3: Issue found — see A107-4.

---

### §4: Session and CSRF

These are JSON API controllers. CSRF protection (`protect_from_forgery`) is present only in the `:browser` pipeline, not in `:api` or `:authenticated`. This is standard for JWT-authenticated JSON APIs and is acceptable. No WebSocket/channel usage in these controllers. No session reads or writes in these controllers (session is fetched in the pipeline but not used in fleet/rental/restriction controllers).

§4: No issues found.

---

### §5: File and Data Handling

**Information disclosure in error responses:**

`create_fleet/2` at line 86 returns `inspect changeset` in a 500 response body:
```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")
```

`update_fleet/2` at line 129 does the same:
```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }")
```

`update_rental/2` at line 184:
```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }")
```

`create_rental/2` at line 169:
```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"Unknown error creating rental\",\"reason\": \"An error occured while creating this rental\", \"changeset\": \"#{inspect changeset}\"}\" }")
```

Ecto changeset `inspect` output can include field names, constraint names, and in some cases partial data values that reveal internal database schema details to the API client.

**A107-5 — MEDIUM — Internal Ecto changeset details leaked to API clients in error responses**

Files:
- `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 86 and 129.
- `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 169 and 184.

All four locations use `#{inspect changeset}` or `#{inspect result}` directly in the HTTP response body. Ecto changeset inspect output reveals internal database constraint names, field names, and schema structure to unauthenticated-perspective API clients (the authenticated caller). This is an information disclosure issue that aids reconnaissance.

Additionally, `create_rental/2` at line 169 contains a syntax error in the JSON string: the literal `}\"` before the closing `}` produces malformed JSON (`...\"changeset\": \"...\"}\" }`), which will cause client-side JSON parse failures.

**No PII in Logger calls:** No `Logger` calls are present in any of the three controller files. Fleet data and rental data (vehicle descriptions, serial numbers, customer names) are not logged.

**Data scoping to organisation:** Addressed under §2 above. The read paths correctly use JWT-derived customer. The write/delete paths have IDOR issues already noted (A107-1, A107-2).

§5: Issue found — see A107-5.

---

### §6: Dependencies

No `mix.exs` or `mix.lock` changes are introduced by these controller files. Dependency review is out of scope for individual controller files.

§6: No issues found (dependency review deferred to designated pass).

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IPs, port numbers, or AWS resource identifiers appear in these three files. No CORS configuration is present in these controllers. No direct TLS configuration. No inter-service HTTP calls originate from these controllers; all data access is through the `ApiServer.Vx` context module.

§7: No issues found.

---

## Findings Summary

| ID | Severity | File(s) | Summary |
|----|----------|---------|---------|
| A107-1 | HIGH | vx_fleet_controller.ex:91,105,110,119 | IDOR: delete_fleet, get_equipment_in_fleet, manage_fleet, update_fleet trust URL customer param, not JWT |
| A107-2 | HIGH | vx_rental_controller.ex:158,174,191 | IDOR: create_rental, update_rental, delete_rental trust URL customer param, not JWT |
| A107-3 | MEDIUM | router.ex:30-32 | Two routes before pipe_through — unauthenticated by accident of ordering; architectural fragility |
| A107-4 | LOW | vx_fleet_controller.ex:113 | Unguarded String.to_integer on user-supplied path param causes unhandled 500 |
| A107-5 | MEDIUM | vx_fleet_controller.ex:86,129 / vx_rental_controller.ex:169,184 | Ecto changeset internals leaked verbatim to API clients; also malformed JSON in create_rental error |

<!-- A110.md -->
# Audit Report A110 — api_server Pass 1
**Agent:** A110
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Date:** 2026-02-27

**Assigned files:**
- `lib/api_server_web/controllers/vx_thing_controller.ex`
- `lib/api_server_web/controllers/vx_thing_event_controller.ex`
- `lib/api_server_web/controllers/vx_thing_info_controller.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/vx_thing_controller.ex`

**Module name:** `ApiServerWeb.VXThingController`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `get_checklists` | 2 | 10 |
| `get_movements` | 2 | 16 |
| `get_hardware_with_checklists` | 2 | 21 |
| `get_pm_data` | 2 | 30 |
| `get_all_pm_data` | 2 | 36 |
| `get_fleet_map` | 2 (clause 1: `fleetname`) | 44 |
| `get_fleet_map` | 2 (clause 2: `fleetid` + `customer`) | 51 |
| `get_fleet_map` | 2 (clause 3: `fleetid` only) | 56 |
| `get_fleet_map` | 2 (clause 4: wildcard) | 64 |
| `create` | 2 | 74 |
| `show` | 2 | 83 |
| `delete` | 2 | 88 |
| `rhm_get_thing` | 2 | 95 |
| `rhm_get_thing_usage` | 2 | 100 |
| `rhm_get_things_usage` | 2 | 111 |
| `rhm_get_thing_events` | 2 | 144 |
| `rhm_get_things` | 2 (clause 1: `fleet_id`) | 153 |
| `rhm_get_things` | 2 (clause 2: no fleet_id) | 161 |
| `rhm_get_things_with_usage` | 2 (clause 1: `fleet_id`) | 169 |
| `rhm_get_things_with_usage` | 2 (clause 2: wildcard) | 176 |
| `rhm_get_things_names` | 2 | 223 |
| `rhm_get_thing_records` | 2 | 231 |
| `create_thing` | 2 | 240 |
| `update_thing` | 2 | 254 |
| `monday_hour_meters` | 2 | 377 |
| `get_next_monday_between_dates` | 4 | 438 |
| `combined_engine_usage` | 2 | 453 |
| `pape_export` | 2 (clause 1: `format: "csv"`) | 603 |
| `pape_export` | 2 (clause 2: wildcard) | 617 |
| `sielift_export` | 2 (clause 1: `format: "json"`, `fleet_id`) | 724 |
| `sielift_export` | 2 (clause 2: `format: "json"`) | 735 |
| `sielift_export` | 2 (clause 3: wildcard) | 746 |
| `update_thing_cached_fields` | 2 | 850 |
| `get_timezones` | 2 | 859 |

**Private functions (`defp`):** `things_with_usage/2` (line 184), `get_data_for_pape_export/1` (line 285), `get_data_for_sielift_export/3` (line 625), `ifnilzero/1` (line 622)

**defstruct / defexception / schema:** None defined in this module.

**use / import / alias:**
- `use ApiServerWeb, :controller` (line 2)
- `use Timex` (line 3)
- `alias ApiServer.Vx` (line 5)
- `alias ApiServer.Vx.VXThing` (line 6)
- `action_fallback ApiServerWeb.FallbackController` (line 8)

---

### File 2: `lib/api_server_web/controllers/vx_thing_event_controller.ex`

**Module name:** `ApiServerWeb.VXThingEventController`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `index` | 2 | 9 |
| `create` | 2 | 14 |
| `show` | 2 | 24 |
| `update` | 2 | 29 |
| `delete` | 2 | 38 |
| `write_partial_record` | 3 | 46 |
| `add_calculated_fields` | 2 | 74 |
| `get_current_omega_status` | 2 | 111 |

**Private functions (`defp`):** `calculated_hourmeter/2` (line 103)

**defstruct / defexception / schema:** None defined in this module.

**use / import / alias:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXThingEvent` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

---

### File 3: `lib/api_server_web/controllers/vx_thing_info_controller.ex`

**Module name:** `ApiServerWeb.VXThingInfoController`

**Public functions (`def`):**

| Name | Arity | Line |
|---|---|---|
| `fix_infos` | 2 | 9 |
| `get_info` | 2 | 17 |
| `do_fix_info` | 2 | 24 |

**defstruct / defexception / schema:** None defined in this module.

**use / import / alias:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXThingInfo` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

---

## Router Context (supporting evidence)

The router defines three scopes relevant to these controllers:

**Scope A — `/api/v1` with NO authentication pipeline (lines 28–32):**
```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)

  pipe_through([:api, :authenticated])
  ...
```
The `pipe_through([:api, :authenticated])` call on line 33 only applies to routes defined **after** it within the same scope block. The two routes above it — `combined_engine_usage` and `monday_hour_meters` — are defined before `pipe_through` and thus receive **no authentication pipeline**.

**Scope B — `/api/v1` unauthenticated (lines 156–177):** Uses only `pipe_through(:api)` (no `:authenticated`). Routes under this scope that relate to our files:
- `GET /rhm/timezones` → `VXThingController.get_timezones` (line 175)
- `GET /rhm/:customer/fix_info` → `VXThingInfoController.fix_infos` (line 176)
- Several `/vx/:customer/...` routes → `VXThingController` actions (lines 169–173)

---

## Checklist Review

### §1: Secrets and Configuration
No hardcoded credentials, API keys, secret key bases, AWS endpoints, or embedded secrets found in any of the three files. All configuration access is done via Guardian JWT claims at runtime.

**§1: No issues found.**

---

### §2: Authentication and Authorization

**Finding A110-1 — CRITICAL: Two fleet data endpoints serve unauthenticated requests**

In `router.ex`, the following routes are declared **before** `pipe_through([:api, :authenticated])` in the same scope block and therefore bypass authentication entirely:

```elixir
# router.ex lines 28–32
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)

  pipe_through([:api, :authenticated])
```

`combined_engine_usage/2` (line 453, `vx_thing_controller.ex`) accepts a `customers` query parameter as a comma-separated string and iterates over all of them, returning daily engine usage data for every vehicle across every named customer. `monday_hour_meters/2` (line 377) similarly accepts a `customers` string and returns per-vehicle GPS coordinates (`latitude`, `longitude`), hour meters, and last-reported timestamps for all vehicles belonging to the named customers.

Any unauthenticated caller who knows (or guesses) a customer identifier can retrieve full fleet telemetry — including GPS/location data — for that customer without presenting any credentials. The comment "Avoid authentication, locking to a specific database" suggests this was a deliberate shortcut that was never reverted.

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` lines 377–436, 453–601
**Router:** `lib/api_server_web/router.ex` lines 30–31

---

**Finding A110-2 — HIGH: `fix_infos` endpoint is unauthenticated and accepts arbitrary customer parameter**

`GET /rhm/:customer/fix_info` → `VXThingInfoController.fix_infos/2` routes through `pipe_through(:api)` only (router scope at line 156). No `:authenticated` pipeline is applied. The handler calls `Vx.list_vxthings(customer)` and then `do_fix_info/2` for every device belonging to the customer, allowing any caller to enumerate and trigger recalculation of all device info records for an arbitrary customer by supplying the customer identifier in the URL path.

**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex` lines 9–15
**Router:** `lib/api_server_web/router.ex` line 176

---

**Finding A110-3 — HIGH: Several VX endpoints (checklist, PM data, movements) are unauthenticated**

The following routes also reside in the unauthenticated scope B (`pipe_through(:api)` only, router lines 156–177):

```
GET /vx/:customer/thing/with_checklists   → VXThingController.get_hardware_with_checklists/2
GET /vx/:customer/thing/:hardwareid/checklists  → VXThingController.get_checklists/2
GET /vx/:customer/pmServicesAjax/:hardwareid    → VXThingController.get_pm_data/2
GET /vx/:customer/pmServicesAjax               → VXThingController.get_all_pm_data/2
GET /vx/:customer/thing/:hardwareid/movements/:day  → VXThingController.get_movements/2
```

These handlers accept `customer` and `hardwareid` directly from the URL path with no authentication check. Fleet checklist records, PM service data, and GPS movement tracks can be retrieved by any caller who knows (or guesses) a customer identifier and hardware ID.

`get_checklists/2` (line 10) notably receives `customer` in the pattern match but passes only `hardwareid` to `Vx.get_checklists/1`, meaning the customer parameter provides no access control — it is present in the signature but unused as a scope guard.

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` lines 10–27, 16–18
**Router:** `lib/api_server_web/router.ex` lines 169–172, 57

---

**Finding A110-4 — HIGH: IDOR in `VXThingController.show/2` and `VXThingController.delete/2` — no customer scoping**

`show/2` (line 83) fetches a device by hardware ID without any customer context:
```elixir
def show(conn, %{"id" => hardwareid}) do
  vx_thing = Vx.get_vx_thing_with_hardware_id!(hardwareid)
  render(conn, "show.json", vx_thing: vx_thing)
end
```

`delete/2` (line 88) fetches a device by internal database ID without any customer context:
```elixir
def delete(conn, %{"id" => id}) do
  vx_thing = Vx.get_vx_thing!(id)
  with {:ok, %VXThing{}} <- Vx.delete_vx_thing(vx_thing) do
    send_resp(conn, :no_content, "")
  end
end
```

Neither function verifies that the retrieved record belongs to the authenticated user's customer. An authenticated user from customer A can fetch or delete device records belonging to customer B by supplying a known or guessed hardware/database ID.

`VXThingController.create/2` (line 74) similarly calls `Vx.create_vx_thing(vx_thing_params)` without injecting or validating the authenticated customer, meaning a device can potentially be created under a customer that differs from the caller's identity.

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` lines 74–93

---

**Finding A110-5 — HIGH: IDOR in `[REDACTED-AWS-SMTP-PASSWORD]` — index/show/update/delete have no customer or org scoping**

`index/2` (line 9) calls `Vx.list_vxthingevents()` with no customer filter, returning all thing events across all customers.

`show/2` (line 24) fetches a single event record by raw numeric ID with no customer check:
```elixir
def show(conn, %{"id" => id}) do
  vx_thing_event = Vx.get_vx_thing_event!(id)
  render(conn, "show.json", vx_thing_event: vx_thing_event)
end
```

`update/2` (line 29) and `delete/2` (line 38) follow the same pattern — fetching by bare `id` with no ownership verification. An authenticated user can read, update, or delete event records (which contain GPS coordinates, ignition status, engine seconds, and timestamp data) belonging to other customers by enumerating IDs.

**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex` lines 9–44

---

**Finding A110-6 — MEDIUM: `rhm_get_thing/2` accepts `customer` from the URL path rather than the JWT claim**

```elixir
def rhm_get_thing(conn, %{"customer" => customer, "hardwareid" => hardwareid}) do
  {vx_thing, usage_data} = Vx.get_augmented_thing_with_hardware_id!(hardwareid, customer)
  render(conn, "rhm_thing.json", vx_thing: {vx_thing, usage_data})
end
```

The `customer` value comes from the URL path parameter (`/rhm/:customer/thing/:hardwareid`), not from `Guardian.Plug.current_claims(conn)["customer"]`. An authenticated user whose JWT claims customer="A" can supply customer="B" in the URL and retrieve device data for customer B. Several other pattern-match clauses in this controller correctly overwrite the URL-supplied `customer` with the JWT claim (e.g., `rhm_get_things/2` line 154, `rhm_get_things_names/2` line 224), but `rhm_get_thing/2` and the first clause of `rhm_get_things/2` (line 153) do not.

Also affects: `rhm_get_things/2` clause 1 (line 153) — `customer` from the URL path is shadow-replaced by the JWT claim on line 154, so the actual query is correctly scoped; however the function signature silently discards the URL parameter, which is confusing and inconsistent. The same inconsistency exists in `rhm_get_things_names/2` (line 223–224).

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` lines 95–98

---

### §3: Input Validation and Injection

**Finding A110-7 — HIGH: Changeset error detail exposed in HTTP response body**

`create_thing/2` (line 240) and `update_thing/2` (line 254) return the raw `inspect changeset` in the HTTP response body on error:

```elixir
# create_thing/2 line 250:
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")

# update_thing/2 line 278:
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }")
```

`inspect/1` on an Ecto changeset emits the full Elixir struct representation including all field names, attempted values, constraint names, and internal state. This discloses database schema structure (table column names, constraints) and may include customer-supplied data reflected back in a machine-readable internal format. This is information disclosure to the client.

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` lines 250, 278

---

**Finding A110-8 — MEDIUM: `customers` parameter in `combined_engine_usage` and `monday_hour_meters` is user-controlled and iterated without bound**

Both `combined_engine_usage/2` (line 453) and `monday_hour_meters/2` (line 377) split a user-supplied `customers` string on commas and iterate over every resulting element, performing N database queries (device listing + per-device queries) per customer:

```elixir
customers_list = customers |> String.split(",")
all_customers_combined = Enum.flat_map(customers_list, fn customer ->
  things = Vx.list_vxthings_full(customer)
  ...
end)
```

There is no limit on the length of the `customers` string or on the number of customers that can be requested. A caller (or an unauthenticated caller — see A110-1) can trigger unbounded database load by supplying a large number of customer identifiers. This is a denial-of-service amplification vector.

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` lines 377–436, 453–601

---

**Finding A110-9 — MEDIUM: `add_calculated_fields/2` in `[REDACTED-AWS-SMTP-PASSWORD]` is public and accepts arbitrary map input**

`add_calculated_fields/2` (line 74) is declared `def` (public) and operates on a raw map, calling `Vx.get_vx_thing_with_hardware_id!/2` using `record_to_add.hardwareid` directly from the input map without validation. While it is currently called only internally from `write_partial_record/3`, its public visibility means it can be called from other controllers or from test/external code without the caller having validated the hardwareid field. The function should be `defp`.

**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex` lines 74–101

---

**Finding A110-10 — LOW: `IO.puts` with device hardware ID in `add_calculated_fields/2`**

```elixir
IO.puts(
  "totalengineseconds is nil for #{record_to_add.hardwareid} but aadhourmeter is set to #{vx_thing.aadhourmeter}, setting totalengineseconds to 0 value"
)
```

This logs the hardware ID and hour meter value of a vehicle to standard output (which in production typically goes to application logs). Hardware IDs are device identifiers for fleet assets. Depending on log aggregation and access controls this may expose fleet asset identifiers in application logs.

**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex` lines 78–81

---

### §4: Session and CSRF

The three controllers operate as JSON API controllers; CSRF is handled at the pipeline level (the `:browser` pipeline applies `protect_from_forgery`, the `:api` pipeline does not, consistent with token-authenticated JSON APIs). No per-controller session manipulation is present.

**§4: No issues found in these files specifically.** (See A110-1/A110-2/A110-3 regarding missing authentication pipeline on some routes, which is a §2 concern.)

---

### §5: File and Data Handling

**Finding A110-11 — HIGH: GPS coordinates returned in `monday_hour_meters` response for unauthenticated callers**

`monday_hour_meters/2` (line 377–436) constructs a response map that explicitly includes `latitude` and `longitude` fields from device event records:

```elixir
%{
  vehicle_name: thing.aaddesc,
  hour_meter: last_event.calcengineseconds,
  latitude: last_event.latitude,
  longitude: last_event.longitude,
  last_reported: last_event.gmtdatetime,
  monday_date: date
}
```

This endpoint is unauthenticated (see A110-1). GPS coordinates for every vehicle across all named customer organisations are returned in plain JSON to any caller with no credentials. This is a direct data exposure of precise vehicle location data across customer boundaries with no access control.

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` lines 405–424
**Router:** `lib/api_server_web/router.ex` line 31

---

**Finding A110-12 — MEDIUM: Customer data boundary is not enforced for `get_movements/2`**

`get_movements/2` (line 16) accepts both `customer` and `hardwareid` from the URL path and passes them to `Vx.get_movements/5`. Movement data includes GPS tracks. While this endpoint is in the unauthenticated scope (A110-3), even in an authenticated context there is no verification that the authenticated user belongs to the named customer. The `customer` path parameter is trusted directly.

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` lines 16–18
**Router:** `lib/api_server_web/router.ex` line 57

---

**Finding A110-13 — MEDIUM: Customer identifier included in CSV export responses and JSON bodies, enabling cross-customer data confirmation**

`combined_engine_usage/2` (line 453) explicitly embeds the `customer` string into each row of the output JSON:

```elixir
%{
  hardwareid: hardwareid,
  customer: customer,
  ...
}
```

For an unauthenticated caller (A110-1), this provides confirmation of which customer owns which hardware ID, enabling enumeration and cross-referencing of customer-to-asset mappings.

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` lines 508–513

---

**Finding A110-14 — LOW: Dead commented-out code contains a hardcoded list of production customer identifiers**

Lines 303–373 contain a large block of commented-out code that includes a hardcoded list of 47 production customer identifiers:

```elixir
# customers =  ["vx_aforklifts","vx_altertrading","vx_arctech","vx_atlanticforklifts", ...]
```

These strings enumerate the full customer namespace in the repository's version history and in the current working tree. While not a runtime risk, they disclose production customer organisation identifiers to anyone with read access to the repository (including CI systems, contributors, and any future repository exposure).

**File:** `lib/api_server_web/controllers/vx_thing_controller.ex` line 303

---

**Finding A110-15 — INFO: `IO.puts "Inserted"` and `IO.inspect changeset` in `write_partial_record/3`**

```elixir
{:ok, te} ->
  IO.puts("Inserted")

{:error, changeset} ->
  case changeset.errors do
    _ ->
      IO.inspect(changeset)
  end
```

`IO.inspect(changeset)` on error will print the full changeset struct to standard output/logs, which may include field values from the device event record (hardware IDs, GPS data, engine data). In a production environment with log aggregation, this represents unnecessary logging of fleet telemetry detail. The `IO.puts("Inserted")` is debug noise. Neither line has a severity path to customer data exposure on its own, but they indicate absent structured logging hygiene.

**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex` lines 62–68

---

### §6: Dependencies
Not assessed in this pass (assigned files are controller modules only; `mix.exs` and `mix.lock` are outside this file assignment).

**§6: Not applicable to assigned files.**

---

### §7: Infrastructure Exposure

**Finding A110-16 — INFO: Hardcoded customer-identifier prefix pattern `vx_` is visible**

The naming convention for customer database namespaces (`vx_<name>`) is visible throughout the code and in the hardcoded customer list (A110-14). This is low-severity but confirms naming conventions to anyone reading the source.

**§7: No additional infrastructure exposure issues (no hardcoded IPs, hostnames, TLS config, or CORS configuration) found in these three files.**

---

## Summary of Findings

| ID | Severity | File | Description |
|---|---|---|---|
| A110-1 | CRITICAL | `vx_thing_controller.ex` + `router.ex` | `combined_engine_usage` and `monday_hour_meters` are unauthenticated — full fleet telemetry data accessible without credentials |
| A110-2 | HIGH | `vx_thing_info_controller.ex` + `router.ex` | `fix_infos` endpoint unauthenticated — arbitrary customer device info can be enumerated and recalculated |
| A110-3 | HIGH | `vx_thing_controller.ex` + `router.ex` | Multiple VX endpoints (checklists, PM data, GPS movements) unauthenticated — fleet data exposed without credentials |
| A110-4 | HIGH | `vx_thing_controller.ex` | IDOR in `show/2`, `delete/2`, `create/2` — no customer scoping; device records accessible/deletable across org boundaries |
| A110-5 | HIGH | `vx_thing_event_controller.ex` | IDOR in `index/2`, `show/2`, `update/2`, `delete/2` — event records (GPS, ignition, engine data) accessible across org boundaries by ID |
| A110-6 | MEDIUM | `vx_thing_controller.ex` | `rhm_get_thing/2` uses URL-path `customer` instead of JWT claim — authenticated user can read another org's device data |
| A110-7 | HIGH | `vx_thing_controller.ex` | `inspect changeset` returned in HTTP 500 body — database schema and field values disclosed to client |
| A110-8 | MEDIUM | `vx_thing_controller.ex` | Unbounded `customers` comma-list in `combined_engine_usage` and `monday_hour_meters` — DoS amplification |
| A110-9 | MEDIUM | `vx_thing_event_controller.ex` | `add_calculated_fields/2` is public (`def`) but should be private (`defp`) |
| A110-10 | LOW | `vx_thing_event_controller.ex` | `IO.puts` logs hardware ID and hour meter value to stdout/logs |
| A110-11 | HIGH | `vx_thing_controller.ex` | GPS latitude/longitude for all fleet vehicles returned by unauthenticated `monday_hour_meters` endpoint |
| A110-12 | MEDIUM | `vx_thing_controller.ex` | `get_movements/2` trusts `customer` from URL path — GPS movement tracks accessible without ownership check |
| A110-13 | MEDIUM | `vx_thing_controller.ex` | Customer identifier embedded in `combined_engine_usage` JSON output — enables enumeration of customer-to-asset mappings |
| A110-14 | LOW | `vx_thing_controller.ex` | Hardcoded list of 47 production customer identifiers in commented-out dead code |
| A110-15 | INFO | `vx_thing_event_controller.ex` | `IO.inspect(changeset)` and `IO.puts` debug output in production path — unstructured logging of device event data |
| A110-16 | INFO | `vx_thing_controller.ex` | Customer namespace prefix convention (`vx_`) disclosed in source |

<!-- A113.md -->
# Security Audit Report — A113
**Agent:** A113
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
2. `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
3. `lib/api_server_web/controllers/vx_user_controller.ex`

Supporting files read for context:
- `lib/api_server_web/router.ex`
- `lib/api_server_web/auth_pipeline.ex`
- `lib/api_server/guardian.ex`
- `lib/api_server/vx/vx_user.ex`
- `lib/api_server/vx/vx.ex` (relevant excerpts: lines 1–130, 2700–2726)
- `mix.exs`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/vx_thing_omega_controller.ex`

**Module name:** `ApiServerWeb.VXThingOmegaController`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `get_container_lift_report` | 2 | 10 |
| `get_lift_summary_report` | 2 | 22 (hardwareid clause) |
| `get_lift_list_report` | 2 | 33 |
| `get_lift_summary_report` | 2 | 44 (fleetid clause) |
| `get_operation_summary_report` | 2 | 53 |
| `get_engine_utilization_report` | 2 | 63 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `use Timex` (line 3)
- `alias ApiServer.Vx` (line 5)
- `alias ApiServer.Vx.VXThing` (line 6)
- `action_fallback ApiServerWeb.FallbackController` (line 8)

---

### File 2: `lib/api_server_web/controllers/vx_thing_summary_controller.ex`

**Module name:** `ApiServerWeb.VXThingSummaryController`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `index` | 2 | 9 |
| `create` | 2 | 14 |
| `show` | 2 | 23 |
| `update` | 2 | 28 |
| `delete` | 2 | 36 |
| `do_fix_summary` | 2 | 45 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXThingSummary` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

---

### File 3: `lib/api_server_web/controllers/vx_user_controller.ex`

**Module name:** `ApiServerWeb.VXUserController`

**Public functions (def):**

| Name | Arity | Line |
|---|---|---|
| `create` | 2 | 9 |
| `lookup_customer_from_conn` | 1 | 18 |
| `login` | 2 | 41 |
| `change_password` | 2 | 59 |
| `get_users` | 2 | 82 |
| `get_user_with_email` | 2 | 89 |
| `update_key_if_value` | 3 | 99 (nil clause) |
| `update_key_if_value` | 3 | 100 |
| `update_user` | 2 | 104 (user clause) |
| `update_user` | 2 | 127 (no-user clause) |
| `create_user` | 2 | 131 |
| `delete_user` | 2 | 153 |
| `get_user_fleets` | 2 | 168 |
| `manage_user_fleets` | 2 | 180 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXUser` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

---

## Supporting Context: Router (relevant excerpts)

The router defines two scopes under `/api/v1`:

**Scope 1** (lines 28–154): Starts with two unauthenticated routes, then calls `pipe_through([:api, :authenticated])` at line 33. All routes for VXThingOmegaController, VXUserController (user management), and VXFleetController fall under this pipe_through.

**Scope 2** (lines 156–177): Uses only `pipe_through(:api)` — no `:authenticated` pipeline. Routes here include:
- `POST /api/v1/rhm/:customer/login/` → `VXUserController.login`
- `resources "/vx/thingsummaries"` → `[REDACTED-AWS-SMTP-PASSWORD]` (all CRUD actions)

**Auth pipeline** (`lib/api_server_web/auth_pipeline.ex`):
```elixir
plug Guardian.Plug.VerifyHeader, realm: "Bearer"
# plug Guardian.Plug.EnsureAuthenticated   <-- COMMENTED OUT
plug Guardian.Plug.LoadResource
```

---

## Checklist Findings

### §1: Secrets and Configuration

§1: No issues found in the three assigned controller files. (Config file analysis is out of scope for these three files; no hardcoded credentials appear in controller code.)

---

### §2: Authentication and Authorization

**A113-1 — CRITICAL: `Guardian.Plug.EnsureAuthenticated` is commented out in the auth pipeline**

File: `lib/api_server_web/auth_pipeline.ex`, line 7.

```elixir
plug Guardian.Plug.VerifyHeader, realm: "Bearer"
# plug Guardian.Plug.EnsureAuthenticated   <-- COMMENTED OUT
plug Guardian.Plug.LoadResource
```

The `:authenticated` pipeline only verifies the header token if present and loads the resource. It does **not** reject requests with no token or an invalid token. Any route under `pipe_through([:api, :authenticated])` can be accessed without a valid JWT: the token is merely parsed if supplied, but its absence is not enforced.

Impact: All authenticated routes — including vehicle data retrieval, user management, fleet management, geofence operations, and all omega reports — are reachable by unauthenticated callers. This is the most severe finding in this file set.

---

**A113-2 — CRITICAL: Passwords stored and compared in plaintext**

Files: `lib/api_server/vx/vx.ex` lines 2704–2717; `lib/api_server_web/controllers/vx_user_controller.ex` lines 44, 63–66; `lib/api_server/vx/vx_user.ex` lines 21, 75, 80.

Authentication in `get_rhm_user/3` and `check_password/3` performs a database query filtering on the raw password field `aacpassword`:

```elixir
# vx.ex line 2706-2707
|> Ecto.Query.where(aacemail: ^email)
|> Ecto.Query.where(aacpassword: ^password)
```

The schema has a separate `aacpasswordhash` field (line 22 of vx_user.ex) that is never populated or consulted. The `update_vx_user_password` function stores the new password directly into `aacpassword` without hashing:

```elixir
# vx_user_controller.ex line 65
changeset = %{aacpassword: new_password}
```

No bcrypt, argon2, or Comeonin dependency is present in `mix.exs`. Passwords are stored and compared in cleartext. A database read by any means — SQL injection, insider access, backup disclosure — exposes every user credential directly.

---

**A113-3 — HIGH: VXThingSummaryController CRUD is fully unauthenticated**

File: `lib/api_server_web/router.ex`, line 162.

```elixir
scope "/api/v1", ApiServerWeb do
  pipe_through(:api)          # no :authenticated
  ...
  resources("/vx/thingsummaries", VXThingSummaryController, except: [:new, :edit])
```

`[REDACTED-AWS-SMTP-PASSWORD]` provides `index`, `create`, `show`, `update`, and `delete` actions. All five are served from the second scope which only passes through `:api` (fetch session + accept JSON). There is no authentication requirement. Any caller can list, read, create, modify, or delete thing summary records without a token.

Additionally, none of the controller actions extract a customer claim or restrict results by customer. `Vx.list_vxthingsummaries()` (called with no arguments at line 10) and `Vx.get_vx_thing_summary!(id)` do not appear to be scoped to a customer or tenant, meaning cross-customer data access is possible.

---

**A113-4 — HIGH: IDOR on `get_user_fleets` and `manage_user_fleets` — authenticated user_id not validated against JWT subject**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, lines 168–197.

```elixir
def get_user_fleets(conn, %{"user_id"=> user_id}) do
  customer = ApiServer.Guardian.Plug.current_claims(conn)["customer"]
  user_with_fleets = Vx.get_vx_user_fleets!(user_id, customer)
  ...

def manage_user_fleets(conn, %{"user_id" => user_id, "allowed_fleets" => allowed_fleets}) do
  customer = ApiServer.Guardian.Plug.current_claims(conn)["customer"]
  user_with_fleets = Vx.get_vx_user_fleets!(user_id, customer)
```

The `user_id` is taken directly from the URL parameter (`/rhm/user/:user_id/fleets`). The code reads the customer from the JWT claim, which provides tenant isolation, but it does not verify that `user_id` matches the authenticated user's own subject (`current_claims["sub"]`). Any authenticated user within the same customer tenant can supply another user's ID and read or modify that user's fleet assignments. This is a direct IDOR within the tenant.

---

**A113-5 — HIGH: IDOR on `update_user` and `delete_user` — no ownership check**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, lines 104–165.

`update_user` retrieves the user by `user_params["id"]` (line 105) and `delete_user` by the `id` URL parameter (line 154). The customer is taken from the JWT in `update_user`, but `delete_user` takes the `customer` parameter from the **URL** (line 153):

```elixir
def delete_user(conn, %{"customer" => customer, "id" => id}) do
  user = Vx.get_vx_user!(id, customer)
```

Neither function verifies that the requesting user is an administrator or has any elevated role. Any authenticated user in the customer can delete or update any other user in that customer.

For `update_user`, the customer is correctly drawn from the JWT claim (line 83-style — actually at line 105 the customer is taken from the request parameter: `%{"customer" => customer, "user" => user_params}`, not from the JWT), meaning a caller can supply a different customer string and — if the auth pipeline does not enforce token validity (see A113-1) — operate across tenants.

---

**A113-6 — HIGH: `update_user` and `create_user` take `customer` from URL/request body, not JWT**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, lines 104, 131, 153.

```elixir
def update_user(conn, %{"customer" => customer, "user" => user_params}) do
  user = Vx.get_vx_user!(user_params["id"], customer)

def create_user(conn, %{"customer" => customer, "user" => user_params}) do
  user = Vx.get_rhm_user(user_params["email"], customer)

def delete_user(conn, %{"customer" => customer, "id" => id}) do
  user = Vx.get_vx_user!(id, customer)
```

In all three functions the `customer` value used for all database operations is taken from the request payload or URL, not from `ApiServer.Guardian.Plug.current_claims(conn)["customer"]`. Compare to `get_users/2` (line 83) and `change_password/2` (line 60) which correctly read customer from the JWT. A caller can supply an arbitrary `customer` string to access or modify records in a different tenant's database schema. Combined with A113-1 (unenforced authentication), this is exploitable without any credentials.

---

**A113-7 — MEDIUM: `get_user_with_email` takes `customer` from request parameter, not JWT**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, lines 89–97.

```elixir
def get_user_with_email(conn, %{"email" => email, "customer" => customer}) do
  [user | _] = Vx.get_rhm_user(email, customer)
```

The customer is drawn from the request parameter rather than the JWT claim. Any authenticated caller can query user records from an arbitrary customer tenant by supplying a different `customer` value.

---

**A113-8 — MEDIUM: `login` customer origin mapping falls through to `vx_dev` default**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, lines 18–57.

`lookup_customer_from_conn/1` maps HTTP `Origin` headers to customer strings. The catch-all clause (line 37) maps any unrecognised origin — including no `Origin` header — to `"vx_dev"`:

```elixir
_ ->
  "vx_dev"
```

This `cust_from_origin` value is stored in the session (line 52) but the actual authentication uses the `customer` parameter from the POST body (line 44):

```elixir
user = Vx.get_rhm_user(email, password, customer)
case ApiServer.Guardian.encode_and_sign(user, %{customer: customer}) do
```

The session's `cust_from_origin` is therefore inconsistent with the token's customer claim. The session-stored customer (`vx_dev` for unknown origins) is stored but appears unused in other endpoints (which read from JWT). The inconsistency indicates dead/confusing code, but the default `vx_dev` assignment may allow enumeration of the dev/staging customer database from any client.

---

**A113-9 — MEDIUM: `login` does not distinguish failed authentication from missing user — information disclosure**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, lines 41–57.

```elixir
user = Vx.get_rhm_user(email, password, customer)
case ApiServer.Guardian.encode_and_sign(user, %{customer: customer}) do
  {:ok, token, _claims} -> ...
  {:error, _message} ->
    send_resp(conn, :internal_server_error, "{\"error\": \"Incorrect email address or password\"}")
end
```

`Vx.get_rhm_user/3` returns `nil` when no user is found. `Guardian.encode_and_sign(nil, ...)` hits the nil guard in `subject_for_token/2` which returns `{:error, :reason_for_error}`. The error path is handled, but if `Repo.one` raises because the query returns multiple rows (unlikely but possible given no unique constraint enforcement in the query), an unhandled exception propagates to `FallbackController`. More importantly, timing differences between "wrong password" and "user not found" are not mitigated — the raw DB query either returns nil immediately or performs a full query scan, creating a username enumeration timing oracle.

---

**A113-10 — LOW: No role/admin check on user-management operations**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, functions `create_user` (line 131), `delete_user` (line 153), `update_user` (line 104), `manage_user_fleets` (line 180).

None of these mutating user-management endpoints verify that the requesting user holds an administrative role (`aacusertype` or `function` association). Any authenticated user within the tenant can create, update, delete, or reassign fleets for other users.

---

### §3: Input Validation and Injection

**A113-11 — MEDIUM: Changeset leak in error responses exposes internal schema details**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, lines 73 and 119.

```elixir
send_resp(conn, :internal_server_error,
  "{\"error\": \"Unknown error updating user password\",\"reason\": \"An error occured while updating this user\",\"changeset\": \"#{inspect changeset}\"}\" }")
```

`inspect changeset` serialises the full `%Ecto.Changeset{}` struct into the HTTP response body. This exposes internal field names, validation error atoms, schema metadata, and potentially partially-populated field values to the client. The same pattern appears in `create_user` at line 147.

---

**A113-12 — LOW: `user_level` from client JSON mapped directly into changeset for `put_assoc`**

File: `lib/api_server/vx/vx_user.ex`, line 70 and `lib/api_server_web/controllers/vx_user_controller.ex` line 109.

`VXUser.convert_json_to_changeset/1` includes:

```elixir
|> Vx.update_key_if_value(:user_level, user_json["user_level"])
```

This value feeds into `VXUser.changeset/2` at line 81:

```elixir
|> put_assoc(:function, %{aatfunction_id: attrs.user_level}, required: true)
```

The `user_level` (which maps to a function/role record) is taken directly from the client-supplied JSON in `update_user` and `create_user` requests. There is no validation that the caller is authorised to set or change the user's role level. A regular user could elevate their own or another user's privileges by supplying an arbitrary `user_level` value.

---

§3 (remainder): No raw SQL fragment injection or `String.to_atom/1` from user input was found in the three assigned controller files. Queries in vx.ex use parameterised Ecto bindings (`^variable`).

---

### §4: Session and CSRF

**A113-13 — INFO: Login stores JWT in server-side session but all other endpoints use Bearer token from header**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, lines 51–52.

```elixir
|> put_session(:jwt, token)
|> put_session(:customer, cust_from_origin)
```

The session is populated on login, but the auth pipeline (`auth_pipeline.ex`) only uses `Guardian.Plug.VerifyHeader` — it does not call `Guardian.Plug.VerifySession`. The session values are therefore set but never consumed by the authentication system. This is dead code that wastes session storage and could create confusion in future development (e.g., a developer might add `VerifySession` believing the session is a valid auth path, creating dual-auth ambiguity).

---

§4 (remainder): CSRF protection is enabled in the `:browser` pipeline (`protect_from_forgery`), but the API controllers use the `:api` pipeline which does not include CSRF protection. This is normal and expected for token-authenticated JSON APIs.

---

### §5: File and Data Handling

**A113-14 — MEDIUM: Vehicle/fleet operational data returned without customer scoping in VXThingSummaryController**

File: `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 10.

```elixir
def index(conn, _params) do
  vxthingsummaries = Vx.list_vxthingsummaries()
  render(conn, "index.json", vxthingsummaries: vxthingsummaries)
end
```

`list_vxthingsummaries()` is called with no customer or tenant argument. Given the multi-tenant schema-prefix architecture used throughout the rest of the codebase (all other queries pass `prefix: customer`), this call either returns data from the default schema (which may be a shared or system schema) or raises. Either way there is no per-customer scoping, violating the fleet-management data boundary requirement (checklist §5: "verify that any endpoint returning vehicle locations, driver records, or customer assets is scoped to the authenticated user's organisation").

Similarly `show`, `update`, and `delete` call `Vx.get_vx_thing_summary!(id)` and `Vx.update_vx_thing_summary/2` / `Vx.delete_vx_thing_summary/1` without a customer prefix.

---

**A113-15 — INFO: `IO.inspect` of request headers logged to stdout in production**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, line 19.

```elixir
def lookup_customer_from_conn(conn) do
  IO.inspect get_req_header(conn, "origin")
```

`IO.inspect` writes directly to stdout. In a production OTP release this appears in the system journal/log. The `Origin` header itself is low-sensitivity, but this indicates debug instrumentation left in production code. Any future addition of higher-sensitivity header logging (e.g., `Authorization`) using this same pattern would be a disclosure issue.

---

§5 (remainder): No file upload handling or stack-trace-in-error-response patterns were found in the three assigned controller files beyond the changeset leak already noted (A113-11).

---

### §6: Dependencies

**A113-16 — HIGH: `mariaex ~> 0.8.2` is deprecated with no security support**

File: `mix.exs`, line 39.

```elixir
{:mariaex, "~>0.8.2"},
```

The checklist explicitly calls out Mariaex 0.8.2 as deprecated and without security support. This is the database driver for all data operations including those in the assigned files.

---

§6 (remainder): No `git:` source dependencies found. The `geonames` dependency uses a local `path:` reference (line 56) which should be reviewed separately. Dependency version audit (mix audit) is outside the scope of static file review.

---

### §7: Infrastructure Exposure

**A113-17 — MEDIUM: Hardcoded internal hostnames in `lookup_customer_from_conn` map**

File: `lib/api_server_web/controllers/vx_user_controller.ex`, lines 22–36.

```elixir
["http://cea-beta.mobilehourmeter.com"] -> "vx_cea"
["http://cea-omega.mobilehourmeter.com"] -> "vx_ceaomega"
["http://komatsuau-beta.mobilehourmeter.com"] -> "vx_komatsuau"
["http://komatsu-beta.mobilehourmeter.com"] -> "vx_komatsu"
["http://sielift-beta.mobilehourmeter.com"] -> "vx_sielift"
["http://demo.mobilehourmeter.com"] -> "vx_demo"
```

Customer-facing hostnames and their internal schema/database identifiers are hardcoded in source. This discloses customer names and the internal naming convention for database schema prefixes. All entries use `http://` rather than `https://`, indicating that these frontend applications may be served over unencrypted HTTP, or that the origin matching will fail for HTTPS-served frontends (the `Origin` header for an HTTPS page would be `https://...`, not `http://...`). The fallback to `vx_dev` for non-matching origins (including all HTTPS origins) is a separate operational concern (see A113-8).

---

§7 (remainder): No TLS termination, CORS configuration, or Content Security Policy handling was found in the three assigned controller files. CORS and endpoint configuration is outside scope for this file set.

---

## Summary of Findings

| ID | Severity | File | Description |
|---|---|---|---|
| A113-1 | CRITICAL | auth_pipeline.ex | `EnsureAuthenticated` plug commented out — all "authenticated" routes are actually unauthenticated |
| A113-2 | CRITICAL | vx_user_controller.ex / vx.ex | Passwords stored and compared in plaintext — no hashing |
| A113-3 | HIGH | router.ex / vx_thing_summary_controller.ex | VXThingSummaryController is fully unauthenticated and unscoped |
| A113-4 | HIGH | vx_user_controller.ex | IDOR: `get_user_fleets` and `manage_user_fleets` do not validate user_id against JWT sub |
| A113-5 | HIGH | vx_user_controller.ex | IDOR: `update_user` and `delete_user` have no ownership or admin check |
| A113-6 | HIGH | vx_user_controller.ex | `update_user`, `create_user`, `delete_user` use caller-supplied `customer` not JWT claim |
| A113-7 | MEDIUM | vx_user_controller.ex | `get_user_with_email` uses caller-supplied `customer` not JWT claim |
| A113-8 | MEDIUM | vx_user_controller.ex | Origin→customer mapping defaults unknown origins to `vx_dev`; all HTTPS origins fall through |
| A113-9 | MEDIUM | vx_user_controller.ex | Login error handling may expose timing oracle for username enumeration |
| A113-10 | LOW | vx_user_controller.ex | No role/admin check on mutating user-management operations |
| A113-11 | MEDIUM | vx_user_controller.ex | `inspect changeset` in error responses leaks internal schema detail to client |
| A113-12 | LOW | vx_user_controller.ex / vx_user.ex | Client-supplied `user_level` passed directly to role `put_assoc` — privilege escalation |
| A113-13 | INFO | vx_user_controller.ex | JWT stored in session but `VerifySession` not in pipeline — dead session code |
| A113-14 | MEDIUM | vx_thing_summary_controller.ex | Fleet asset data returned without customer/tenant scoping |
| A113-15 | INFO | vx_user_controller.ex | `IO.inspect` of request header in production code |
| A113-16 | HIGH | mix.exs | Mariaex 0.8.2 deprecated, no security support |
| A113-17 | MEDIUM | vx_user_controller.ex | Hardcoded customer hostnames and internal schema names; all use `http://` not `https://` |

<!-- A116.md -->
# Audit Report A116 — api_server Pass 1
**Agent:** A116
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Date:** 2026-02-27

Assigned files:
- `lib/api_server_web/controllers/vx_user_function_controller.ex`
- `lib/api_server_web/endpoint.ex`
- `lib/api_server_web/gettext.ex`

Supporting files read for context (not assigned but required for accurate analysis):
- `lib/api_server_web/router.ex`
- `config/config.exs`
- `config/prod.exs`
- `config/prod.secret.exs`
- `mix.exs`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/vx_user_function_controller.ex`

**Module name:** `ApiServerWeb.VXUserFunctionController`

**Public functions (`def`):** None. All action functions (index, create, show, update, delete) are commented out. No active public functions.

**defstruct / defexception / schema:** None.

**Plugs and pipelines:** None.

**use / import / alias at module level:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXUserFunction` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

---

### File 2: `lib/api_server_web/endpoint.ex`

**Module name:** `ApiServerWeb.Endpoint`

**Public functions (`def`):**
- `init/2` — arity 2, line 51

**defstruct / defexception / schema:** None.

**Plugs (in order):**
1. `plug Plug.Static` — at `/`, from `:api_server`, gzip: false (line 10–12)
2. `socket "/socket", ApiServerWeb.UserSocket` (line 4)
3. (dev only) `socket "/phoenix/live_reload/socket", Phoenix.LiveReloader.Socket` (line 17)
4. (dev only) `plug Phoenix.LiveReloader` (line 18)
5. (dev only) `plug Phoenix.CodeReloader` (line 19)
6. `plug Plug.Logger` (line 22)
7. `plug Plug.Parsers` — parsers: `[:urlencoded, :multipart, :json, :xml, Absinthe.Plug.Parser]`, pass: `["*/*"]`, json_decoder: Poison, xml_decoder: `:xmerl_scan` (lines 24–28)
8. `plug Plug.MethodOverride` (line 30)
9. `plug Plug.Head` (line 31)
10. `plug Plug.Session` — store: `:cookie`, key: `"_api_server_key"`, signing_salt: `"5CSDVUtC"` (lines 36–39)
11. `plug CORSPlug` — no arguments, default configuration (line 42)
12. `plug ApiServerWeb.Router` (line 43)

**use / import / alias at module level:**
- `use Phoenix.Endpoint, otp_app: :api_server` (line 2)

---

### File 3: `lib/api_server_web/gettext.ex`

**Module name:** `ApiServerWeb.Gettext`

**Public functions (`def`):** None. This module only uses the `Gettext` macro to inject translation helpers.

**defstruct / defexception / schema:** None.

**Plugs and pipelines:** None.

**use / import / alias at module level:**
- `use Gettext, otp_app: :api_server` (line 23)

---

## Checklist Findings

### §1: Secrets and Configuration

**A116-1** CRITICAL — Hardcoded `secret_key_base` in tracked source file
**File:** `config/config.exs`, line 15
```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh"
```
A 64-character production-quality secret key base is hardcoded directly in `config/config.exs`, which is committed to version control. This key is used to sign session cookies and other cryptographic material. Any party with repository read access can forge signed session cookies.

**A116-2** CRITICAL — Hardcoded AWS SES SMTP credentials in tracked source file
**File:** `config/config.exs`, lines 117–120
```elixir
username: "[REDACTED-AWS-KEY-ID]",
password: "[REDACTED-AWS-SMTP-PASSWORD]",
```
AWS IAM access key `[REDACTED-AWS-KEY-ID]` and its secret are hardcoded in the base config file. These credentials are replicated identically in `config/prod.exs` (lines 45–48). The key ID prefix `AKIA` indicates a long-lived IAM user access key. This gives any repository reader full SES send-as capability and potentially broader AWS access depending on the IAM policy attached to this user.

**A116-3** CRITICAL — Hardcoded Guardian JWT signing secret in tracked source file
**File:** `config/config.exs`, line 136
```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```
The Guardian JWT signing secret is hardcoded in version control. Any party with repository access can mint arbitrary valid JWT tokens for any user identity, bypassing all authentication.

**A116-4** CRITICAL — Hardcoded database password in tracked source file
**File:** `config/prod.exs`, lines 17 and 35
```elixir
# FortyNineRepo:
password: "Q973bFtc9z/cVW#mA",
hostname: "svr49.tracking-intelligence.com",

# Main Repo:
password: "TRxbixk9fuZc",
hostname: "vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com",
```
Two separate database passwords are hardcoded in `prod.exs`, which is a tracked file (it imports `prod.secret.exs` but is itself committed). Additionally, the RDS hostname and a third-party hostname (`svr49.tracking-intelligence.com`) are embedded, disclosing infrastructure topology.

**A116-5** HIGH — Hardcoded `secret_key_base` in `prod.secret.exs`
**File:** `config/prod.secret.exs`, line 12
```elixir
secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```
`prod.secret.exs` contains a separate production `secret_key_base`. While this file is listed as untracked (referenced via `import_config`), it was present in the repository snapshot audited and its content could be exposed if `.gitignore` is not correctly maintained. The more serious issue is that two different key base values exist across `config.exs` and `prod.secret.exs`, indicating the `config.exs` value may have been the live production key at some point.

**A116-6** MEDIUM — Guardian configured with a very long token TTL (52 weeks)
**File:** `config/config.exs`, line 135
```elixir
ttl: {52, :weeks},
```
JWT tokens are valid for one full year with no apparent refresh-token rotation policy evident in the config. A compromised token cannot be revoked before expiry unless a token revocation list is maintained (not observed in the codebase from available files). This significantly extends the window of exposure for any stolen token.

**A116-7** INFO — AWS RDS endpoint and internal hostnames hardcoded
**File:** `config/prod.exs`, lines 36 and 22
```
vxsandboxsydneytest-cluster-1.cluster-c4fwadrw9quy.ap-southeast-2.rds.amazonaws.com
svr49.tracking-intelligence.com
```
These hostnames disclose the AWS region (`ap-southeast-2`), the RDS cluster identifier, and a third-party server hostname. Exposure is limited if the repository is private, but these should be supplied via environment variables.

---

### §2: Authentication and Authorization

**A116-8** HIGH — Two unauthenticated routes serve fleet/vehicle data without authentication
**File:** `lib/api_server_web/router.ex`, lines 30–31
```elixir
scope "/api/v1", ApiServerWeb do
  # Avoid authentication, locking to a specific database
  get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
  get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)
  ...
  pipe_through([:api, :authenticated])
```
The `pipe_through([:api, :authenticated])` call appears on line 33, **after** the two `get` route definitions on lines 30–31. In Phoenix, routes are matched in the order they are declared within a scope, but the `pipe_through` macro applies to all routes within the scope when placed anywhere in it — however, the comment `# Avoid authentication, locking to a specific database` confirms that bypassing authentication is intentional for these two endpoints. These routes return fleet engine usage data (vehicle operational data) without any authentication. This must be confirmed as intentional and the scope of data returned must be verified to ensure it does not expose cross-customer fleet data.

**A116-9** HIGH — Multiple unauthenticated routes in the `:api` scope expose potentially sensitive data
**File:** `lib/api_server_web/router.ex`, lines 156–177
The second `/api/v1` scope uses only `pipe_through(:api)` with no `:authenticated` pipeline. Unauthenticated routes include:
- `GET /vx/:customer/thing/with_checklists` — returns hardware with checklists per customer
- `GET /vx/:customer/thing/:hardwareid/checklists` — returns checklists for a specific vehicle
- `GET /vx/:customer/pmServicesAjax/:hardwareid` — PM (preventive maintenance) data
- `GET /vx/:customer/pmServicesAjax` — all PM data
- `GET /vx/:customer/rentalStats` — rental statistics
- `GET /rhm/:customer/fix_info` — fix (GPS fix) info
- `GET /files/getsize/:esn` and `GET /files/getfile/:esn` — file access by ESN

The `:customer` path parameter means a caller who guesses or enumerates a valid customer identifier can retrieve fleet, checklist, maintenance, rental and GPS data for any customer without authentication. This is a potential IDOR and cross-tenant data exposure issue.

**A116-10** MEDIUM — Guardian JWT TTL of 52 weeks with no evidence of refresh token rotation (see also A116-6)
Tokens issued at login remain valid for one year. Without a server-side revocation list, logging out, changing a password, or disabling a user account does not invalidate previously issued tokens.

---

### §3: Input Validation and Injection

**A116-11** MEDIUM — XML parser configured with `:xmerl_scan` in endpoint
**File:** `lib/api_server_web/endpoint.ex`, line 28
```elixir
xml_decoder: :xmerl_scan
```
Erlang's `:xmerl_scan` is vulnerable to XML External Entity (XXE) attacks by default. It processes `DOCTYPE` declarations and external entity references unless explicitly disabled. Any endpoint accepting XML input (the `:api_xml` pipeline routes: POST `/`, POST `/test-omega-data`, POST `/prodisplay/event`, POST `/erp-import`) is potentially vulnerable to XXE — enabling server-side request forgery, internal network scanning, or file disclosure from the server filesystem. This finding pertains to the `endpoint.ex` parser configuration.

§3: No other issues found in the three assigned files (VXUserFunctionController has no active code; Gettext performs no input handling).

---

### §4: Session and CSRF

**A116-12** HIGH — Session cookie missing `secure`, `http_only`, and `same_site` flags
**File:** `lib/api_server_web/endpoint.ex`, lines 36–39
```elixir
plug Plug.Session,
  store: :cookie,
  key: "_api_server_key",
  signing_salt: "5CSDVUtC"
```
The `Plug.Session` configuration omits all three security cookie flags:
- No `secure: true` — the session cookie can be transmitted over unencrypted HTTP connections, allowing interception.
- No `http_only: true` — the cookie is accessible to JavaScript, making it vulnerable to XSS-based session theft. (Note: Phoenix/Plug does default `http_only` to `true` in some versions, but it is not explicitly set here, which is a configuration hygiene concern.)
- No `same_site: :strict` or `:lax` — the cookie is sent on cross-site requests, enabling CSRF attacks via cookie tossing and increasing CSRF surface area.

**A116-13** HIGH — No `encryption_salt` on session cookie — session contents are signed but not encrypted
**File:** `lib/api_server_web/endpoint.ex`, comment at line 33–35, configuration lines 36–39
The code comment explicitly notes: "The session will be stored in the cookie and signed, this means its contents can be read but not tampered with. Set `:encryption_salt` if you would also like to encrypt it." The `encryption_salt` is not set. Any data placed into the session is readable by the client (base64-encoded) and by any network observer who captures the cookie. If session data contains user identifiers, roles, or any sensitive information, this constitutes information disclosure.

**A116-14** HIGH — CORSPlug applied globally with default configuration (origin: "*")
**File:** `lib/api_server_web/endpoint.ex`, line 42
```elixir
plug CORSPlug
```
`CORSPlug` version `~> 1.5` defaults to `origin: "*"` when no options are provided. This allows any web origin to make credentialed or uncredentialed cross-origin requests to all endpoints, including authenticated API routes. For a fleet management API where authenticated endpoints handle customer vehicle data, driver records, and location data, wildcard CORS with `origin: "*"` is a significant security weakness. This is flagged by checklist §7 for authenticated endpoints. The router comments `# plug CORSPlug, origin: "*"` in the pipeline definitions also confirm the team was aware of the wildcard origin concern.

**A116-15** MEDIUM — No `check_origin` configuration visible for the WebSocket endpoint
**File:** `lib/api_server_web/endpoint.ex`, line 4
```elixir
socket "/socket", ApiServerWeb.UserSocket
```
No `check_origin` option is specified on the `socket` declaration. Phoenix defaults `check_origin` to `true` in production (checking the `Origin` header against the endpoint's configured URL), but this has not been explicitly configured. If the endpoint `url` host is not correctly set in production, the default check may pass unexpectedly. Explicit configuration is required per checklist §4.

**A116-16** INFO — CSRF protection is enabled for the `:browser` pipeline
**File:** `lib/api_server_web/router.ex`, line 8
```elixir
plug(:protect_from_forgery)
```
The browser pipeline correctly includes CSRF protection. However, none of the API routes use the `:browser` pipeline — they use `:api` or `:api_xml`, which do not include CSRF protection. For a JSON API using JWT authentication (stateless), this is typically acceptable. However, because session cookies are also set (via `Plug.Session` in the endpoint), endpoints that rely on session-based state remain CSRF-vulnerable.

---

### §5: File and Data Handling

§5: No issues found in the three assigned files. `[REDACTED-AWS-SMTP-PASSWORD]` has no active code. `Gettext` performs no data handling. `Endpoint` does not implement file handling logic directly beyond the static file plug.

Note for subsequent agents: The file download routes `GET /files/getsize/:esn` and `GET /files/getfile/:esn` in the router are unauthenticated and accept an `esn` path parameter — these should be reviewed for path traversal in `FileController`, which is not an assigned file for this agent.

---

### §6: Dependencies

**A116-17** HIGH — `mariaex ~> 0.8.2` is deprecated with no security support
**File:** `mix.exs`, line 39
```elixir
{:mariaex, "~>0.8.2"},
```
The checklist explicitly flags Mariaex 0.8.2 as deprecated with no security support. This library is the MySQL/MariaDB adapter and handles all database query execution. Any unpatched vulnerability in this driver (query construction, protocol handling, TLS negotiation) has no upstream fix path.

**A116-18** MEDIUM — Multiple dependencies pinned to approximate (`~>`) versions with older major versions
**File:** `mix.exs`
Several dependencies use `~>` version constraints pointing to old versions:
- `{:phoenix, "~> 1.5.9"}` — Phoenix 1.5.x is significantly outdated; Phoenix 1.7+ contains security improvements.
- `{:guardian, "~> 1.0"}` — Guardian 1.x; current is 2.x.
- `{:cowboy, "~> 1.0"}` — Cowboy 1.x is end-of-life; Cowboy 2.x is the supported version.
- `{:absinthe, "~> 1.4.0"}` and `{:absinthe_plug, "~> 1.4.0"}` — outdated.
- `{:distillery, "~> 1.5"}` — outdated release tooling.
- `{:phoenix_ecto, "~> 3.2"}` — outdated.

All dependencies should be reviewed against hex.pm advisory database (`mix hex.audit`).

**A116-19** INFO — Local path dependency for `geonames`
**File:** `mix.exs`, line 56
```elixir
{:geonames, path: "geonames-elixir"},
```
A local path dependency is used rather than a published hex.pm package. This dependency is not subject to hex.pm security advisories and its exact version and provenance cannot be verified through the normal dependency audit process. The source at `geonames-elixir/` must be manually reviewed.

---

### §7: Infrastructure Exposure

**A116-20** HIGH — CORS wildcard origin on all endpoints including authenticated API routes (see A116-14)
Covered under §4/A116-14. Restated here per checklist §7: `plug CORSPlug` with default `origin: "*"` is applied globally in `endpoint.ex` before the router, meaning every route — including authenticated fleet management endpoints — accepts cross-origin requests from any origin.

**A116-21** MEDIUM — No security headers (Content Security Policy, X-Frame-Options, X-Content-Type-Options) configured in endpoint
**File:** `lib/api_server_web/endpoint.ex`
The endpoint does not configure any security response headers beyond what the `:browser` pipeline's `put_secure_browser_headers/2` provides (which only applies to the browser pipeline in the router). For API responses, no `Content-Security-Policy`, `X-Frame-Options`, `X-Content-Type-Options`, or `Strict-Transport-Security` headers are set. The checklist §7 flags Content Security Policy review in the endpoint module.

**A116-22** MEDIUM — No `force_ssl` or HSTS configured in endpoint or production config
**File:** `config/prod.exs`
The `force_ssl` option is commented out in `prod.exs` (lines 80–82). There is no `https:` configuration in `prod.exs` — only `http: [port: 4000]`. This means the application may be serving all traffic, including authentication tokens and session cookies, over unencrypted HTTP. If TLS termination is handled by a load balancer, this should be documented; otherwise `force_ssl: [hsts: true]` must be enabled.

**A116-23** INFO — AWS region disclosed via SES endpoint and RDS hostname
**Files:** `config/config.exs` line 113, `config/prod.exs` line 36
`email-smtp.us-west-2.amazonaws.com` and `ap-southeast-2.rds.amazonaws.com` disclose two different AWS regions in use (`us-west-2` for SES, `ap-southeast-2` for RDS). Disclosure risk is low if the repository is private but is worth noting as infrastructure topology information.

---

## Summary Table

| ID      | Severity | Section | Description |
|---------|----------|---------|-------------|
| A116-1  | CRITICAL | §1 | Hardcoded `secret_key_base` in `config/config.exs` |
| A116-2  | CRITICAL | §1 | Hardcoded AWS SES SMTP credentials (IAM key + secret) in `config/config.exs` and `config/prod.exs` |
| A116-3  | CRITICAL | §1 | Hardcoded Guardian JWT signing secret in `config/config.exs` |
| A116-4  | CRITICAL | §1 | Hardcoded database passwords for two repos in `config/prod.exs` |
| A116-5  | HIGH     | §1 | `secret_key_base` in `prod.secret.exs` (potentially tracked) |
| A116-6  | MEDIUM   | §1/§2 | Guardian JWT TTL of 52 weeks — excessive token lifetime |
| A116-7  | INFO     | §1/§7 | AWS region and RDS/external hostnames hardcoded in config |
| A116-8  | HIGH     | §2 | Two unauthenticated routes serving vehicle/engine usage data |
| A116-9  | HIGH     | §2 | Unauthenticated `:api` scope exposes per-customer fleet, checklist, PM, rental, GPS data |
| A116-10 | MEDIUM   | §2 | 52-week JWT with no apparent token revocation mechanism |
| A116-11 | MEDIUM   | §3 | `:xmerl_scan` XML decoder vulnerable to XXE by default |
| A116-12 | HIGH     | §4 | Session cookie missing `secure`, `http_only`, `same_site` flags |
| A116-13 | HIGH     | §4 | Session cookie signed but not encrypted — contents readable by client |
| A116-14 | HIGH     | §4/§7 | `CORSPlug` with default `origin: "*"` applied globally |
| A116-15 | MEDIUM   | §4 | No explicit `check_origin` for WebSocket endpoint |
| A116-16 | INFO     | §4 | CSRF protection present in `:browser` pipeline only |
| A116-17 | HIGH     | §6 | Mariaex 0.8.2 — deprecated, no security support |
| A116-18 | MEDIUM   | §6 | Multiple outdated major-version dependencies (Phoenix 1.5, Cowboy 1.x, Guardian 1.x) |
| A116-19 | INFO     | §6 | Local path dependency `geonames-elixir` — not subject to hex.pm advisories |
| A116-20 | HIGH     | §7 | CORS wildcard origin covers authenticated fleet management routes (restatement of A116-14) |
| A116-21 | MEDIUM   | §7 | No security response headers (CSP, X-Frame-Options, HSTS) in endpoint |
| A116-22 | MEDIUM   | §7 | No `force_ssl`/HSTS configured — traffic may be served over HTTP |
| A116-23 | INFO     | §7 | AWS region topology disclosed via hardcoded SES/RDS endpoints |

**CRITICAL findings: 4**
**HIGH findings: 7**
**MEDIUM findings: 6**
**LOW findings: 0**
**INFO findings: 4**

<!-- A119.md -->
# Security Audit Report — A119
**Agent:** A119
**Repo:** api_server (Elixir/Phoenix)
**Branch:** master
**Run:** 2026-02-27-01
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server_web/resolvers/puls.ex`
2. `lib/api_server_web/resolvers/things.ex`
3. `lib/api_server_web/router.ex`

---

## Reading Evidence

---

### File 1: `lib/api_server_web/resolvers/puls.ex`

**Module:** `ApiServerWeb.Resolvers.Puls`

**Public functions:**

| Function | Arity | Line |
|----------|-------|------|
| `puls_record/3` | 3 | 3 |

**defstruct / defexception / schema:** None.

**Plugs / pipelines:** None (resolver module, not a controller/router).

**use / import / alias at module level:** None declared.

**Full text read:** Yes (lines 1–29).

---

### File 2: `lib/api_server_web/resolvers/things.ex`

**Module:** `ApiServerWeb.Resolvers.Things`

**Public functions:**

| Function | Arity | Line |
|----------|-------|------|
| `find_thing/3` | 3 | 3 |
| `get_all_things/3` | 3 | 13 |

**defstruct / defexception / schema:** None.

**Plugs / pipelines:** None (resolver module).

**use / import / alias at module level:** None declared.

**Full text read:** Yes (lines 1–22).

---

### File 3: `lib/api_server_web/router.ex`

**Module:** `ApiServerWeb.Router`

**use / import / alias at module level:**
- `use ApiServerWeb, :router`

**Pipelines defined:**

| Pipeline | Plugs |
|----------|-------|
| `:browser` | `accepts(["html"])`, `fetch_session`, `fetch_flash`, `protect_from_forgery`, `put_secure_browser_headers` |
| `:api` | `fetch_session`, `accepts(["json"])` (CORSPlug commented out) |
| `:api_xml` | `fetch_session`, `accepts(["xml"])` (CORSPlug commented out) |
| `:authenticated` | `ApiServer.Guardian.AuthPipeline` |

**All routes — scope `/api/v1` (first block):**

Lines 30–31: Two routes declared BEFORE the `pipe_through([:api, :authenticated])` call at line 33. These two routes are therefore unauthenticated:

| Method | Path | Controller | Action | Pipelines |
|--------|------|------------|--------|-----------|
| GET | `/api/v1/rhm/engine_usage` | `VXThingController` | `:combined_engine_usage` | **NONE** |
| GET | `/api/v1/rhm/monday_hour_meters` | `VXThingController` | `:monday_hour_meters` | **NONE** |

All subsequent routes in this scope (lines 35–153) are behind `[:api, :authenticated]`:

| Method | Path | Controller | Action |
|--------|------|------------|--------|
| GET | `/api/v1/rhm/pape_export` | `VXThingController` | `:pape_export` |
| GET | `/api/v1/rhm/sielift_export` | `VXThingController` | `:sielift_export` |
| GET | `/api/v1/rhm/reports/geofence_events` | `GeofenceController` | `:process_things_geofences` |
| GET | `/api/v1/rhm/work_in_progress` | `VXThingController` | `:sielift_export` |
| GET | `/api/v1/rhm/things_with_usage` | `VXThingController` | `:rhm_get_things_with_usage` |
| GET | `/api/v1/rhm/thing_records` | `VXThingController` | `:rhm_get_thing_records` |
| GET | `/api/v1/rhm/:customer/things/names` | `VXThingController` | `:rhm_get_things_names` |
| GET | `/api/v1/rhm/:customer/things` | `VXThingController` | `:rhm_get_things` |
| GET | `/api/v1/rhm/thing/:hardwareid/events` | `VXThingController` | `:rhm_get_thing_events` |
| GET | `/api/v1/rhm/thing/:hardwareid/usage` | `VXThingController` | `:rhm_get_thing_usage` |
| GET | `/api/v1/rhm/:customer/thing/:hardwareid` | `VXThingController` | `:rhm_get_thing` |
| GET | `/api/v1/rhm/thing/:hardwareid/active_rental` | `VXRentalController` | `:rhm_active_rental` |
| POST | `/api/v1/rhm/thing/` | `VXThingController` | `:update_thing` |
| PUT | `/api/v1/rhm/thing/` | `VXThingController` | `:create_thing` |
| GET | `/api/v1/rhm/thing/:hardwareid/omega_data` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_current_omega_status` |
| GET | `/api/v1/vx/:customer/thing/:hardwareid/movements/:day` | `VXThingController` | `:get_movements` |
| GET | `/api/v1/rhm/omega_thing/:hardwareid/container_lift_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_container_lift_report` |
| GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_summary_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_lift_summary_report` |
| GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_list_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_lift_list_report` |
| GET | `/api/v1/rhm/omega_fleet/:fleetid/lift_summary_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_lift_summary_report` |
| GET | `/api/v1/rhm/omega_thing/:hardwareid/engine_utilization_report` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_engine_utilization_report` |
| GET | `/api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` (x2 — duplicate) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_operation_summary_report` |
| GET | `/api/v1/rhm/fleets` | `VXFleetController` | `:get_fleets` |
| GET | `/api/v1/rhm/fleets_with_equipment` | `VXFleetController` | `:get_fleets_with_equipment` |
| PUT | `/api/v1/rhm/:customer/fleet/` | `VXFleetController` | `:create_fleet` |
| DELETE | `/api/v1/rhm/:customer/fleet/:id` | `VXFleetController` | `:delete_fleet` |
| POST | `/api/v1/rhm/:customer/fleet/` | `VXFleetController` | `:update_fleet` |
| GET | `/api/v1/rhm/:customer/fleet/:id/equipment` | `VXFleetController` | `:get_equipment_in_fleet` |
| POST | `/api/v1/rhm/:customer/fleet/:id/manage` | `VXFleetController` | `:manage_fleet` |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:rhm_service_records` |
| GET | `/api/v1/rhm/:customer/rentals` | `VXRentalController` | `:get_rentals` |
| POST | `/api/v1/rhm/:customer/rentals/` | `VXRentalController` | `:update_rental` |
| PUT | `/api/v1/rhm/:customer/rentals/` | `VXRentalController` | `:create_rental` |
| DELETE | `/api/v1/rhm/:customer/rentals/:id` | `VXRentalController` | `:delete_rental` |
| GET | `/api/v1/rhm/thing/:hardwareid/rental_anniversaries` | `VXRentalController` | `:get_rental_anniversaries` |
| GET | `/api/v1/rhm/rentals/midpac_style_report` | `VXRentalController` | `:get_midpac_style_rental_report` |
| POST | `/api/v1/rhm/user/change_password` | `VXUserController` | `:change_password` |
| GET | `/api/v1/rhm/user/:user_id/fleets` | `VXUserController` | `:get_user_fleets` |
| POST | `/api/v1/rhm/user/:user_id/fleets` | `VXUserController` | `:manage_user_fleets` |
| GET | `/api/v1/rhm/:customer/users` | `VXUserController` | `:get_users` |
| GET | `/api/v1/rhm/:customer/user/:email` | `VXUserController` | `:get_user_with_email` |
| POST | `/api/v1/rhm/:customer/user/` | `VXUserController` | `:update_user` |
| PUT | `/api/v1/rhm/:customer/user/` | `VXUserController` | `:create_user` |
| DELETE | `/api/v1/rhm/:customer/user/:id` | `VXUserController` | `:delete_user` |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:index` |
| GET | `/api/v1/rhm/customer/:id` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:show` |
| POST | `[REDACTED-AWS-SMTP-PASSWORD]` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:update` |
| PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:create` |
| DELETE | `/api/v1/rhm/customer/:id` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:delete` |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `VXThingController` | `:get_fleet_map` |
| GET | `/api/v1/rhm/fleetmap/:fleetid` | `VXThingController` | `:get_fleet_map` |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `GeofenceController` | `:list_all_geofences` |
| PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | `GeofenceController` | `:create_geofence` |
| POST | `[REDACTED-AWS-SMTP-PASSWORD]` | `GeofenceController` | `:update_geofence` |
| DELETE | `/api/v1/rhm/geofence/:id` | `GeofenceController` | `:delete_geofence` |

**All routes — scope `/api/v1` (second block, pipe_through `:api` only — NO authentication):**

| Method | Path | Controller | Action | Pipelines |
|--------|------|------------|--------|-----------|
| GET | `/api/v1/hc` | `UtilityController` | `:do_health_check` | `:api` only |
| POST | `/api/v1/rhm/:customer/login/` | `VXUserController` | `:login` | `:api` only |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` (index) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:index` | `:api` only |
| POST | `[REDACTED-AWS-SMTP-PASSWORD]` (create) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:create` | `:api` only |
| GET | `/api/v1/vx/thingsummaries/:id` (show) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:show` | `:api` only |
| PATCH/PUT | `/api/v1/vx/thingsummaries/:id` (update) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:update` | `:api` only |
| DELETE | `/api/v1/vx/thingsummaries/:id` (delete) | `[REDACTED-AWS-SMTP-PASSWORD]` | `:delete` | `:api` only |
| GET | `/api/v1/files/getsize/:esn` | `FileController` | `:get_size` | `:api` only |
| GET | `/api/v1/files/getfile/:esn` | `FileController` | `:send_file_download` | `:api` only |
| GET | `/api/v1/vx/:customer/thing/with_checklists` | `VXThingController` | `:get_hardware_with_checklists` | `:api` only |
| GET | `/api/v1/vx/:customer/thing/:hardwareid/checklists` | `VXThingController` | `:get_checklists` | `:api` only |
| GET | `/api/v1/vx/:customer/pmServicesAjax/:hardwareid` | `VXThingController` | `:get_pm_data` | `:api` only |
| GET | `/api/v1/vx/:customer/pmServicesAjax` | `VXThingController` | `:get_all_pm_data` | `:api` only |
| GET | `/api/v1/vx/:customer/rentalStats` | `VXThingController` | `:get_all_rental_stats` | `:api` only |
| GET | `[REDACTED-AWS-SMTP-PASSWORD]` | `VXThingController` | `:get_timezones` | `:api` only |
| GET | `/api/v1/rhm/:customer/fix_info` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:fix_infos` | `:api` only |

**All routes — scope `/` (pipe_through `:api_xml` only — NO authentication):**

| Method | Path | Controller | Action | Pipelines |
|--------|------|------------|--------|-----------|
| GET | `/` | `UtilityController` | `:do_health_check` | `:api_xml` only |
| GET | `/geocode` | `UtilityController` | `:do_geocode_lookup` | `:api_xml` only |
| GET | `/error/:status_code` | `UtilityController` | `:do_error` | `:api_xml` only |
| POST | `/test-omega-data` | `UtilityController` | `:process_incoming_omegawatch_data` | `:api_xml` only |
| POST | `/prodisplay/event` | `UtilityController` | `:process_prodisplay_event` | `:api_xml` only |
| POST | `/` | `[REDACTED-AWS-SMTP-PASSWORD]` | `:get_g62_data` | `:api_xml` only |
| POST | `/erp-import` | `UtilityController` | `:erp_import` | `:api_xml` only |
| POST | `/driverid-converter` | `UtilityController` | `:driverid_converter` | `:api_xml` only |
| GET | `/dis-sync` | `UtilityController` | `:sync_to_DISCorp` | `:api_xml` only |

**GraphQL routes:** Commented out (lines 195–202). No active GraphQL endpoints.

**Full text read:** Yes (lines 1–203).

---

## Checklist Review

### §1: Secrets and Configuration

**A119-1 — CRITICAL: `EnsureAuthenticated` plug is commented out in `AuthPipeline`**

File: `lib/api_server_web/auth_pipeline.ex`, line 7.

```elixir
plug Guardian.Plug.VerifyHeader, realm: "Bearer"
# plug Guardian.Plug.EnsureAuthenticated   <-- COMMENTED OUT
plug Guardian.Plug.LoadResource
```

The `:authenticated` pipeline only verifies and loads a token if one is present. It does **not** enforce that a valid token must be present. A request with no `Authorization` header will pass through `VerifyHeader` without error and reach `LoadResource`, which will silently load `nil` as the current resource. Controllers that assume `current_claims/1` or `current_resource/1` will not be nil after passing `:authenticated` may behave unpredictably. This effectively means that many routes advertised as authenticated are reachable without a token. This is the highest-severity finding in this file set.

---

**A119-2 — CRITICAL: Guardian `secret_key` hardcoded in tracked source file**

File: `config/config.exs`, line 136.

```elixir
config :api_server, ApiServer.Guardian,
  issuer: "rhmapi",
  ttl: {52, :weeks},
  secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The HMAC signing key used to sign and verify all JWTs is committed in cleartext to the repository. Any person with read access to the repository can forge arbitrary tokens for any user, customer, or role, completely bypassing authentication.

---

**A119-3 — CRITICAL: `prod.secret.exs` committed to version control and contains production `secret_key_base`**

The `.gitignore` file comments out the exclusion rule for `*.secret.exs`:

```
# /config/*.secret.exs
```

Confirmed via `git ls-files config/prod.secret.exs` — the file is tracked. It contains:

```elixir
config :api_server, ApiServerWeb.Endpoint,
  secret_key_base: "glcsjqnr64PEc+Las0f0pIwIBr/J91VELfvyzCWgXGWXOSg/Ow4eX0hWCNvspNjN"
```

The Phoenix `secret_key_base` protects session cookies and other signed/encrypted data. Exposure allows session forgery and cookie tampering in production.

---

**A119-4 — CRITICAL: CalAmp API credential hardcoded in resolver**

File: `lib/api_server_web/resolvers/puls.ex`, line 4.

```elixir
token = "VHJhY2tpbmdTb2x1dGlvbnM6U2tQREk4ZXo="
```

This is a Base64-encoded Basic Auth credential (`TrackingSolutions:SkPDI8ez` when decoded) for the CalAmp PULS telematics platform. It is hardcoded in source and committed to the repository.

Additionally, a second CalAmp/PULS credential appears in `utility_controller.ex`, line 151:
```
Authorization: "Basic VHJhY2tpbmdTb2x1dGlvbnM6dHZWSFFVc0NBZXU0"
```
(decoded: `TrackingSolutions:tvVHQUsCAeu4`)

These credentials provide access to telematics vehicle tracking data for the CalAmp fleet, enabling enumeration of fleet hardware IDs, ESNs, ICCIDs, and group assignments.

---

**A119-5 — HIGH: DISCorp API key hardcoded in source**

File: `lib/api_server_web/controllers/utility_controller.ex`, line 1053 (referenced via `sync_to_DISCorp`).

```elixir
api_key = "PZPwWHyAMFhPbt3UB8PWXtEw"
```

This third-party API key for DISCorp (`disprism.com`) is hardcoded in source. This key allows equipment hour meter updates to be pushed to the DISCorp system. If revoked or rotated the value must be changed in source, triggering a redeploy; and any repository reader can use the key directly.

---

**A119-6 — HIGH: Guardian token TTL is 52 weeks**

File: `config/config.exs`, line 135.

```elixir
ttl: {52, :weeks}
```

Tokens are valid for one full year. There is no evidence of refresh token rotation or token revocation infrastructure in the codebase. A stolen token remains valid for up to 52 weeks, providing an extremely wide attack window.

---

### §2: Authentication and Authorization

**A119-7 — CRITICAL: `EnsureAuthenticated` is disabled — authenticated routes are reachable without a token**

(See A119-1 above for full detail.) This is also an authorization finding: the `:authenticated` pipeline does not reject unauthenticated requests; it merely attempts to load credentials if they happen to be present. Routes intended to be protected may be accessible with no token whatsoever.

---

**A119-8 — CRITICAL: Full CRUD on `VXThingSummary` is unauthenticated and unscoped**

Router scope `/api/v1`, second block, line 162:
```elixir
resources("/vx/thingsummaries", VXThingSummaryController, except: [:new, :edit])
```
This registers `index`, `show`, `create`, `update`, and `delete` actions — all five behind `:api` only (no `:authenticated`). Inspection of `[REDACTED-AWS-SMTP-PASSWORD]` confirms:

- `index/2` calls `Vx.list_vxthingsummaries()` — returns all thing summaries across all customers, with no scoping.
- `show/2` accepts `id` from the URL directly: `Vx.get_vx_thing_summary!(id)` — no ownership check.
- `create/2` and `update/2` accept arbitrary params — no owner check.
- `delete/2` deletes by `id` with no ownership check.

Any unauthenticated internet client can enumerate, read, create, modify, or delete all thing summaries across all customer organisations. This is cross-customer data exposure without authentication.

---

**A119-9 — HIGH: File download endpoints are unauthenticated and leak access-fob key material**

Router (second scope, `:api` only):
```elixir
get("/files/getsize/:esn", FileController, :get_size)
get("/files/getfile/:esn", FileController, :send_file_download)
```

`FileController.send_file_download/2` retrieves all access fobs for the fleets associated with a hardware ID, concatenates their `fob_code` values, computes a CRC, and returns a binary file for download. This file is keying material for physical access control (forklift key fobs). No authentication is required; the only input is an ESN/hardware ID number, which is an enumerable integer.

`get_size/2` leaks the number of access fobs per vehicle, also without authentication.

---

**A119-10 — HIGH: `/vx/:customer/pmServicesAjax` and related VX endpoints are unauthenticated**

Router (second scope, `:api` only, lines 169–173):
```elixir
get("/vx/:customer/thing/with_checklists",   VXThingController, :get_hardware_with_checklists)
get("/vx/:customer/thing/:hardwareid/checklists", VXThingController, :get_checklists)
get("/vx/:customer/pmServicesAjax/:hardwareid",   VXThingController, :get_pm_data)
get("/vx/:customer/pmServicesAjax",               VXThingController, :get_all_pm_data)
get("/vx/:customer/rentalStats",                  VXThingController, :get_all_rental_stats)
```

None of these routes are behind `:authenticated`. They expose PM service data, checklist records, and rental statistics for any customer whose name is known or guessable. The `customer` path segment is not validated against any authenticated session.

---

**A119-11 — HIGH: `/rhm/:customer/fix_info` is an unauthenticated administrative maintenance action**

Router (second scope, line 176):
```elixir
get("/rhm/:customer/fix_info", VXThingInfoController, :fix_infos)
```

`VXThingInfoController.fix_infos/2` enumerates all things for a customer and triggers `do_fix_info` for each — a write/repair operation — without any authentication. Any caller who knows or guesses a customer identifier can trigger bulk data repair operations against arbitrary customer databases.

---

**A119-12 — HIGH: Two fleet data reporting routes lack authentication (pre-`pipe_through` position)**

Router, scope `/api/v1` first block, lines 30–31 (before `pipe_through([:api, :authenticated])` at line 33):
```elixir
get("/rhm/engine_usage",      VXThingController, :combined_engine_usage)
get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)
```

In Phoenix, `pipe_through` within a scope applies only to routes defined **after** it. These two routes appear before the `pipe_through` call and therefore receive no pipeline at all — not even `:api`. Confirmed by reading `combined_engine_usage/2`: it accepts `customers` as a comma-separated query parameter, iterates over all customer databases, and returns aggregated multi-customer engine usage data. `monday_hour_meters/2` similarly returns cross-customer hour-meter data. Both are sensitive fleet operational data accessible with a plain HTTP GET to any caller.

---

**A119-13 — MEDIUM: No authorization check in `Resolvers.Things` — customer from user input, not from authenticated session**

File: `lib/api_server_web/resolvers/things.ex`.

```elixir
def find_thing(_parent, %{aadhardwareid: hardwareid, customer: customer}, _resolution) do
  ...ApiServer.Vx.get_vx_thing_with_hardware_id!(hardwareid, customer)
```

```elixir
def get_all_things(_parent, %{customer: customer}, _resolution) do
  ...ApiServer.Vx.list_vxthings(customer)
```

Both resolvers accept `customer` directly from the GraphQL argument (`_resolution` parameter is ignored entirely). The `resolution` object carries the authenticated user's context including their org, but it is not consulted. An authenticated user could supply any `customer` value in the query and receive data for that organisation. This is an IDOR / cross-tenant data exposure.

Note: The GraphQL endpoint is currently commented out in the router (lines 195–202), so exploitation is not currently possible via HTTP. However the resolvers exist and would be exploitable if the endpoint is re-enabled. The pattern should be corrected regardless.

---

**A119-14 — MEDIUM: No authorization check in `Resolvers.Puls` — hardwareid from user input only**

File: `lib/api_server_web/resolvers/puls.ex`.

```elixir
def puls_record(parent, %{hardwareid: hardwareid}, resolution) do
```

`resolution` is accepted but never inspected. There is no check that the caller's authenticated organisation owns or is permitted to query the supplied `hardwareid`. Any authenticated user (if the GraphQL endpoint is re-enabled) could enumerate hardware IDs across all customers. ESNs, ICCIDs, and CalAmp group assignments would be returned.

---

**A119-15 — MEDIUM: `erp_import` and `driverid_converter` are unauthenticated**

Routes in scope `/` (`:api_xml` only):
```elixir
post("/erp-import",          UtilityController, :erp_import)
post("/driverid-converter",  UtilityController, :driverid_converter)
```

`erp_import/2` receives rental records and service records from an external source and writes them to the database. Customer selection is determined by the `from` field in the POST body — which is caller-controlled. An unauthenticated caller can inject arbitrary rental and service data into any customer database whose `from` address is known or guessable. `driverid_converter` similarly processes driver identity data without authentication. Both endpoints appear to be intended for machine-to-machine calls from known sources (e.g., `"SQLserver@sielift.com"`), but there is no token, shared secret, IP allowlist, or signature validation in the router or the controller.

---

**A119-16 — MEDIUM: `/dis-sync` triggers an outbound third-party API call without authentication**

Route in scope `/` (`:api_xml` only):
```elixir
get("/dis-sync", UtilityController, :sync_to_DISCorp)
```

Any unauthenticated caller can trigger a synchronisation of equipment hour-meter data to DISCorp, consuming the hardcoded API key (A119-5). No authentication, rate limiting, or authorisation is applied.

---

### §3: Input Validation and Injection

**A119-17 — MEDIUM: Unbounded recursive retry in `puls_record/3` — potential DoS / process exhaustion**

File: `lib/api_server_web/resolvers/puls.ex`, lines 12–17.

```elixir
:error ->
    IO.puts "Will attempt Re-send"
    receive do
    after
        60_000 ->
            puls_record(parent, %{hardwareid: hardwareid}, resolution)
    end
```

On HTTP error, the resolver waits 60 seconds and retries by recursing into itself — with no retry limit, no circuit breaker, and no backoff ceiling. If the CalAmp endpoint is persistently unavailable, this process will recurse indefinitely (until it hits Erlang's process stack limit). If multiple such queries arrive concurrently, request processes will pile up in the 60-second wait state, exhausting the available BEAM process pool and causing application-wide denial of service.

---

**A119-18 — LOW: `hardwareid` from user input interpolated directly into an external HTTP URL**

File: `lib/api_server_web/resolvers/puls.ex`, line 5.

```elixir
url = "https://puls.calamp.com/service2/lmu/#{hardwareid}"
```

`hardwareid` originates directly from the GraphQL argument without sanitization. While HTTPoison will percent-encode path segments in most cases, there is no explicit validation that `hardwareid` is numeric. A crafted value could cause unexpected URL construction (e.g., path traversal or query string injection into the CalAmp URL). The value should be validated as a numeric string before use.

---

### §4: Session and CSRF

**A119-19 — MEDIUM: `protect_from_forgery` is in the `:browser` pipeline which is never used**

The `:browser` pipeline (lines 4–10) defines `protect_from_forgery`. However, no scope in the router uses `pipe_through(:browser)`. All API scopes use `:api` or `:api_xml` which do not include CSRF protection. This is acceptable for a pure JSON/XML API that uses Bearer token authentication. Confirmed acceptable — noting only for completeness.

---

**A119-20 — INFO: `check_origin` configuration not visible in router; endpoint config not reviewed in this pass**

`check_origin` applies to WebSocket/channel connections. No channels are defined in the reviewed files. No finding raised; recommend verifying in `endpoint.ex`.

---

### §5: File and Data Handling

**A119-21 — HIGH: `send_file_download` returns access-fob keying material to unauthenticated callers**

(See A119-9 above.) The binary file returned by `FileController.send_file_download/2` contains concatenated `fob_code` values and a CRC, which constitutes physical access control keying material. Serving this to unauthenticated callers over the public internet is a physical security risk in addition to a logical security risk.

---

**A119-22 — MEDIUM: Internal diagnostic output (`IO.puts`, `IO.inspect`) present in production resolvers and controllers**

File: `lib/api_server_web/resolvers/puls.ex`, line 11: `IO.puts "Will attempt Re-send"`
File: `lib/api_server_web/controllers/file_controller.ex`, lines 16–17: `IO.puts "#{inspect length(thing.fleet_thing_joins)} #{inspect thing.fleet_thing_joins}"`
File: `lib/api_server_web/controllers/file_controller.ex`, line 45: `IO.puts "CRC: #{inspect crc}"`
File: `lib/api_server_web/controllers/file_controller.ex`, line 46: `IO.puts "CRC_String: #{inspect crc16_xmodem}"`

`IO.puts` and `IO.inspect` write to stdout, not to the structured Logger. They bypass log level filtering and will appear in production logs unconditionally, potentially leaking fleet join data, hardware IDs, and CRC values. Logger with appropriate level (`:debug`) should be used and these calls should be removed from production paths.

---

**A119-23 — MEDIUM: Cross-customer data exposure in `VXThingSummaryController.index`**

`Vx.list_vxthingsummaries()` returns all summaries across all customer organisations. The caller supplies no customer context, and the result is not filtered. Combined with the lack of authentication on this endpoint (A119-8), any caller receives all customers' thing summaries in a single call.

---

**A119-24 — INFO: `create_thing` error response leaks internal changeset details**

File: `lib/api_server_web/controllers/vx_thing_controller.ex`, line 250 (approximate):

```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")
```

`inspect changeset` on an Ecto changeset struct will include all field values and constraint errors in the response. This may expose database column names, validation rules, and partial data values to the client.

---

### §6: Dependencies

§6: Not assessed in this pass (assigned files do not include `mix.exs` or `mix.lock`). Defer to dedicated dependency audit pass.

---

### §7: Infrastructure Exposure

**A119-25 — HIGH: CalAmp PULS service URL and credentials expose external telematics infrastructure**

File: `lib/api_server_web/resolvers/puls.ex`, line 5:
```elixir
url = "https://puls.calamp.com/service2/lmu/#{hardwareid}"
```

Combined with the hardcoded credential (A119-4), this reveals the specific CalAmp endpoint path used for LMU device queries, the account used, and the credential. This information is sufficient to directly query the CalAmp API for any known hardware ID without going through the api_server application.

---

**A119-26 — HIGH: DISCorp endpoint URL and API key hardcoded in source**

File: `lib/api_server_web/controllers/utility_controller.ex`:
```elixir
api_key = "PZPwWHyAMFhPbt3UB8PWXtEw"
url = "https://407110-01.disprism.com/updateEquipmentHourMeter"
```

The account-specific subdomain `407110-01.disprism.com` identifies the customer account within DISCorp's infrastructure. Combined with the API key, this constitutes full credentials for direct API access to that DISCorp account.

---

**A119-27 — INFO: Duplicate route definition**

Router lines 92–100 define `GET /rhm/omega_fleet/:fleetid/operation_summary_report` twice with identical controller and action. The second definition is unreachable and the duplication may indicate copy-paste error or an incomplete refactoring.

---

## Summary of Findings

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A119-1 | CRITICAL | `auth_pipeline.ex` | `EnsureAuthenticated` commented out — tokens not enforced |
| A119-2 | CRITICAL | `config/config.exs` | Guardian JWT signing key hardcoded in tracked source |
| A119-3 | CRITICAL | `config/prod.secret.exs` | Production `secret_key_base` committed to version control |
| A119-4 | CRITICAL | `resolvers/puls.ex` | CalAmp API Basic Auth credential hardcoded in source |
| A119-5 | HIGH | `utility_controller.ex` | DISCorp API key hardcoded in source |
| A119-6 | HIGH | `config/config.exs` | Guardian TTL 52 weeks with no revocation mechanism |
| A119-7 | CRITICAL | `auth_pipeline.ex` | Auth pipeline does not reject unauthenticated requests |
| A119-8 | CRITICAL | `router.ex` / `vx_thing_summary_controller.ex` | Full CRUD on VXThingSummary unauthenticated and cross-tenant |
| A119-9 | HIGH | `router.ex` / `file_controller.ex` | Access-fob key material download requires no authentication |
| A119-10 | HIGH | `router.ex` | Multiple VX fleet data endpoints unauthenticated |
| A119-11 | HIGH | `router.ex` | Administrative `fix_info` action unauthenticated |
| A119-12 | HIGH | `router.ex` | Engine usage and hour-meter routes have no pipeline at all |
| A119-13 | MEDIUM | `resolvers/things.ex` | `customer` taken from GraphQL args; `resolution` context ignored — IDOR |
| A119-14 | MEDIUM | `resolvers/puls.ex` | No authorisation check; `resolution` context ignored |
| A119-15 | MEDIUM | `router.ex` | `erp-import` and `driverid-converter` unauthenticated |
| A119-16 | MEDIUM | `router.ex` | `dis-sync` triggers privileged third-party call unauthenticated |
| A119-17 | MEDIUM | `resolvers/puls.ex` | Unbounded recursive retry — process exhaustion / DoS |
| A119-18 | LOW | `resolvers/puls.ex` | `hardwareid` interpolated into external URL without validation |
| A119-19 | MEDIUM | `router.ex` | CSRF plug in unused `:browser` pipeline (informational) |
| A119-20 | INFO | `router.ex` | `check_origin` not verified in this pass |
| A119-21 | HIGH | `file_controller.ex` | Physical access-fob keying material served unauthenticated |
| A119-22 | MEDIUM | multiple | `IO.puts`/`IO.inspect` in production code leaks data to stdout |
| A119-23 | MEDIUM | `vx_thing_summary_controller.ex` | `index` returns all customers' summaries with no scoping |
| A119-24 | INFO | `vx_thing_controller.ex` | Ecto changeset details exposed in error response |
| A119-25 | HIGH | `resolvers/puls.ex` | CalAmp telematics URL + credential reveals external infrastructure |
| A119-26 | HIGH | `utility_controller.ex` | DISCorp account URL + API key reveals external infrastructure |
| A119-27 | INFO | `router.ex` | Duplicate route definition for `operation_summary_report` |

<!-- A122.md -->
# Security Audit Report — A122
**Agent:** A122
**Run:** 2026-02-27-01
**Branch:** master
**Stack:** Elixir/Phoenix
**Assigned files:**
- `lib/api_server_web/schema.ex`
- `lib/api_server_web/schema/thing_types.ex`
- `lib/api_server_web/views/changeset_view.ex`

**Supporting context read (not assigned, read for cross-reference):**
- `lib/api_server_web/resolvers/things.ex`
- `lib/api_server_web/resolvers/puls.ex`
- `lib/api_server_web/router.ex`
- `lib/api_server_web/endpoint.ex`
- `lib/api_server_web/views/error_helpers.ex`
- `lib/api_server/guardian.ex`
- `config/config.exs`

---

## Reading Evidence

### File 1: `lib/api_server_web/schema.ex`

**Module name:** `ApiServerWeb.Schema`

**Public functions (def):** None — this module uses Absinthe macro DSL only; no explicit `def` declarations are present.

**Schemas/types defined (via Absinthe query DSL):**
- Query field `:get_thing` (line 11) — args: `aadhardwareid` (non_null :string), `customer` (non_null :string) — resolver: `Resolvers.Things.find_thing/3`
- Query field `:get_puls_record` (line 18) — arg: `hardwareid` (non_null :string) — resolver: `Resolvers.Puls.puls_record/3`
- Query field `:get_all_things` (line 24) — arg: `customer` (non_null :string) — resolver: `Resolvers.Things.get_all_things/3`

**use / import / alias at module level:**
- `use Absinthe.Schema` (line 3)
- `import_types Absinthe.Type.Custom` (line 4)
- `import_types ApiServerWeb.Schema.ThingTypes` (line 5)
- `alias ApiServerWeb.Resolvers` (line 6)

**defstruct / defexception / schema:** None

---

### File 2: `lib/api_server_web/schema/thing_types.ex`

**Module name:** `ApiServerWeb.Schema.ThingTypes`

**Public functions (def):** None — Absinthe macro DSL only.

**Object types defined:**
- `:thing` (lines 5–37) — fields: `aadcustcode`, `aaddesc`, `aadintext`, `aadaddr`, `aadcustomerid`, `aadcat`, `aadhardwareid`, `aadhw_type`, `aadmake`, `aadmodel`, `aadserialno`, `aadmobile`, `aadimei`, `aadhourmeter`, `aadhourmeter1`, `aadhourmeter2`, `aadhourmeter3`, `aadhourmeter4`, `aadodometer`, `aadhourmeteromega`, `aadhourmeterothcan`, `aaddateintoservice`, `aadlastservice`, `aadvalid`, `aadserviceoffset`, `aadsvchrs`, `aadrange_lat`, `aadrange_long`, `aadrange_dist`, `aadrange_unit`, `service_calculation_input`
- `:puls_record` (lines 41–45) — fields: `esn`, `iccid`, `group`

**use / import / alias at module level:**
- `use Absinthe.Schema.Notation` (line 2)

**defstruct / defexception / schema:** None

---

### File 3: `lib/api_server_web/views/changeset_view.ex`

**Module name:** `ApiServerWeb.ChangesetView`

**Public functions (def):**
- `translate_errors/1` (line 10)
- `render/2` with clause `"error.json"` (line 14)

**use / import / alias at module level:**
- `use ApiServerWeb, :view` (line 2)

**defstruct / defexception / schema:** None

---

## Checklist Review

### §1: Secrets and Configuration

During cross-reference reading of `config/config.exs` (required to evaluate whether the GraphQL resolvers and schema connect to authenticated external services), the following hardcoded secrets were identified. These are reported here because they are directly relevant to the assigned resolver `Resolvers.Puls.puls_record/3`, which is the target resolver wired to the `:get_puls_record` query field in `schema.ex`.

**A122-1 — CRITICAL — Hardcoded AWS SES SMTP credentials in config.exs**

File: `config/config.exs`, lines 117–120

```elixir
username: "[REDACTED-AWS-KEY-ID]",
password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

An AWS IAM access key ID (`[REDACTED-AWS-KEY-ID]`) and its corresponding SMTP password are hardcoded in the committed configuration file `config/config.exs`. This file is tracked by git. AWS SES SMTP credentials derived from IAM keys provide programmatic access to send email from the associated AWS account and may provide a pivot to other AWS services depending on the IAM policy attached to this key. A commented-out prior credential set is also visible on lines 115–116, indicating key rotation has occurred but old values remain in version history.

**A122-2 — CRITICAL — Hardcoded Guardian JWT secret key in config.exs**

File: `config/config.exs`, line 136

```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

The Guardian JWT signing secret is hardcoded in the committed `config/config.exs`. Any party with read access to the repository can forge valid JWT tokens, impersonating any user on the platform, including administrative accounts.

**A122-3 — CRITICAL — Hardcoded Phoenix secret_key_base in config.exs**

File: `config/config.exs`, line 15

```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh",
```

The Phoenix `secret_key_base` is hardcoded in the committed `config/config.exs`. This key is used to sign and verify cookies and session data. A known `secret_key_base` allows an attacker to forge signed cookies, potentially achieving session hijacking or remote code execution via maliciously crafted serialized session payloads.

**A122-4 — CRITICAL — Hardcoded third-party API credential (CalAmp PULS) in resolver source code**

File: `lib/api_server_web/resolvers/puls.ex`, line 4

```elixir
token = "VHJhY2tpbmdTb2x1dGlvbnM6U2tQREk4ZXo="
```

A Base64-encoded Basic Auth credential (`TrackingSolutions:SkPDI8ez` when decoded) for the CalAmp PULS external API is hardcoded directly in the resolver source file. This resolver is wired to the `:get_puls_record` query field in the assigned `schema.ex`. The credential is committed to version control and grants access to CalAmp PULS device records, including ESN, ICCID, and group membership for tracked hardware assets.

---

### §2: Authentication and Authorization

**A122-5 — CRITICAL — All three GraphQL queries lack authentication and authorization**

File: `lib/api_server_web/schema.ex`, lines 8–28; `lib/api_server_web/router.ex`, lines 195–202

The GraphQL endpoint is currently commented out in the router:

```elixir
# forward "/graphql",
#   Absinthe.Plug,
#   schema: ApiServerWeb.Schema
# forward "/graphiql",
#   Absinthe.Plug.GraphiQL,
#   schema: ApiServerWeb.Schema,
#   interface: :simple
```

The GraphQL routes are not currently mounted. However, the schema itself contains no authentication middleware, no authorization context checks, and no `middleware` declarations on any query field. All three queries — `:get_thing`, `:get_puls_record`, and `:get_all_things` — resolve directly to business logic with no identity or permission verification. If the GraphQL endpoint is ever re-enabled (the code is present and trivially re-activated), all three queries will be unauthenticated and unauthorised by default.

The resolvers in `Resolvers.Things` accept a `customer` argument from the caller and use it directly to scope database queries (`list_vxthings(customer)`, `get_vx_thing_with_hardware_id!(hardwareid, customer)`). The customer value is entirely attacker-controlled; there is no verification that the authenticated identity has access to the requested customer's data. This constitutes an IDOR / broken object-level authorization vulnerability.

**A122-6 — HIGH — Guardian token TTL is 52 weeks**

File: `config/config.exs`, line 135

```elixir
ttl: {52, :weeks},
```

JWT tokens issued by Guardian are valid for one full year with no evidence of a refresh-token rotation mechanism. A compromised token remains valid for up to 52 weeks. Industry standard for access tokens is minutes to hours; long-lived tokens dramatically extend the window of exploitation for stolen credentials.

**A122-7 — HIGH — GraphiQL interactive IDE configured with no authentication guard**

File: `lib/api_server_web/router.ex`, lines 198–202

```elixir
# forward "/graphiql",
#   Absinthe.Plug.GraphiQL,
#   schema: ApiServerWeb.Schema,
#   interface: :simple
```

The GraphiQL endpoint (interactive query IDE) is commented out but present. It is mounted at the same level as the main `/graphql` endpoint with no `:authenticated` pipeline. If re-enabled, it would expose the full interactive schema explorer to unauthenticated users.

---

### §3: Input Validation and Injection

**A122-8 — HIGH — Resolver accepts caller-controlled `customer` parameter with no validation or ownership check**

Files: `lib/api_server_web/schema.ex` lines 12–13, 26; `lib/api_server_web/resolvers/things.ex` lines 3–10, 13–21

The `:get_thing` and `:get_all_things` query fields accept a `customer` argument as a non-null string and pass it directly to context-scoped database queries. The `_resolution` parameter (which in Absinthe carries the authenticated context, including the current user's identity) is discarded with `_resolution` in both resolver functions. There is no check that the caller-supplied `customer` value matches the customer associated with the authenticated token. Any authenticated user can query data for any customer by supplying an arbitrary string.

**A122-9 — MEDIUM — Unbounded retry loop in PULS resolver is a denial-of-service vector**

File: `lib/api_server_web/resolvers/puls.ex`, lines 10–16

```elixir
:error ->
    IO.puts "Will attempt Re-send"
    receive do
    after
        60_000 ->
            puls_record(parent, %{hardwareid: hardwareid}, resolution)
    end
```

On HTTP error, the resolver tail-recursively retries indefinitely, sleeping 60 seconds between attempts. Each blocked GraphQL worker process holds a scheduler thread for the duration. A caller can trigger this by querying `:get_puls_record` for an invalid or unreachable hardware ID. Multiple concurrent requests could exhaust the BEAM process pool or trigger stack overflow via unbounded recursion.

**A122-10 — MEDIUM — `hardwareid` passed to external URL with no validation**

File: `lib/api_server_web/resolvers/puls.ex`, line 5

```elixir
url = "https://puls.calamp.com/service2/lmu/#{hardwareid}"
```

The `hardwareid` argument is interpolated directly into a URL without any format validation. While HTTPS to an external host limits the injection surface, an attacker-controlled hardware ID could be crafted to probe internal SSRF paths if the HTTP client follows redirects to non-HTTPS targets, or to enumerate valid device IDs in the CalAmp system.

§3: No additional injection issues found in the assigned schema files themselves.

---

### §4: Session and CSRF

The assigned files (`schema.ex`, `thing_types.ex`, `changeset_view.ex`) do not define session handling or CSRF logic. Observations from cross-reference context:

The endpoint at `lib/api_server_web/endpoint.ex` line 39 uses a hardcoded `signing_salt: "5CSDVUtC"` for session cookies, but this is less critical than the `secret_key_base` finding already covered under A122-3.

§4: No issues found within the scope of the three assigned files.

---

### §5: File and Data Handling

**A122-11 — HIGH — `:thing` type exposes GPS geolocation fields (`aadrange_lat`, `aadrange_long`) via GraphQL with no authorisation**

File: `lib/api_server_web/schema/thing_types.ex`, lines 33–34

```elixir
field :aadrange_lat, :float
field :aadrange_long, :float
```

The `:thing` GraphQL type exposes vehicle GPS coordinates. Combined with A122-5 (no authentication on the GraphQL endpoint) and A122-8 (caller-controlled `customer` parameter), these fields would be accessible to unauthenticated users or users querying across customer boundaries if the GraphQL endpoint is re-enabled. This constitutes potential PII and physical location disclosure for fleet vehicles and their operators.

**A122-12 — MEDIUM — `:thing` type exposes IMEI and mobile numbers**

File: `lib/api_server_web/schema/thing_types.ex`, lines 22–23

```elixir
field :aadmobile, :string
field :aadimei, :string
```

IMEI numbers and mobile phone numbers are personally identifiable device identifiers. These are exposed in the GraphQL `:thing` type with no field-level access control. If the GraphQL endpoint is re-enabled without authentication, this information would be publicly readable.

**A122-13 — LOW — `IO.puts` in production resolver leaks operational information to stdout**

File: `lib/api_server_web/resolvers/puls.ex`, line 11

```elixir
IO.puts "Will attempt Re-send"
```

`IO.puts/1` writes directly to stdout and bypasses the application's Logger configuration (log level filtering, structured metadata, redaction). In a containerised production deployment, stdout is typically captured by the host log aggregator. This is a code quality / minor information disclosure issue; no sensitive data appears in this specific message, but the pattern indicates the resolver was written without production logging discipline.

---

### §6: Dependencies

§6: Not directly evaluable from the three assigned files. No dependency declarations are made within `schema.ex`, `thing_types.ex`, or `changeset_view.ex`. Dependency review is deferred to other assigned agents.

---

### §7: Infrastructure Exposure

**A122-14 — MEDIUM — CalAmp PULS API hostname hardcoded in resolver**

File: `lib/api_server_web/resolvers/puls.ex`, line 5

```elixir
url = "https://puls.calamp.com/service2/lmu/#{hardwareid}"
```

The third-party CalAmp PULS service URL is hardcoded in source code. While the hostname itself is a vendor endpoint rather than internal infrastructure, the full URL path structure for the CalAmp LMU device API is disclosed in the repository. This is a minor information exposure and configuration management issue; the URL should be externalised to application configuration.

**A122-15 — HIGH — CORSPlug applied globally with no origin restriction visible in endpoint**

File: `lib/api_server_web/endpoint.ex`, line 42

```elixir
plug CORSPlug
```

`CORSPlug` is applied to the entire application at the endpoint level with no explicit configuration visible in the endpoint file. The default `CORSPlug` configuration allows all origins (`*`). This means CORS is permissive for all routes including authenticated API routes. The router shows commented-out `CORSPlug, origin: "*"` configurations (lines 13, 19) suggesting the intent was per-pipeline CORS configuration, but the global endpoint-level plug overrides this. For authenticated endpoints, permissive CORS enables cross-origin requests from attacker-controlled pages against authenticated sessions.

§7: No issues found in the three assigned files themselves beyond the above.

---

### GraphQL Schema Specific Checks

**A122-16 — HIGH — Absinthe introspection is enabled by default (no disable configuration)**

File: `lib/api_server_web/schema.ex`

Absinthe enables GraphQL introspection by default and the schema contains no `Absinthe.Schema.disable_introspection/0` call or equivalent middleware to disable `__schema`, `__type`, and `__typename` introspection queries. If the GraphQL endpoint is re-enabled, any caller (authenticated or not) can enumerate the complete schema structure including all object types, field names, argument names, and types. This directly reveals internal data model field naming conventions (the `aad`-prefixed field names that map to what appear to be database column names).

**A122-17 — INFO — GraphQL schema has shallow nesting; no deep-query DoS risk identified**

The schema as defined has a single level of object nesting: queries return `:thing` and `:puls_record`, both of which are flat scalar types with no nested object fields. There are no recursive or deeply nested type relationships. DoS via deeply nested queries is not a current risk given the schema topology, but should be re-evaluated if the schema is extended with nested object types.

---

### Changeset View Specific Checks

**A122-18 — LOW — Changeset error response exposes field names from Ecto schema**

File: `lib/api_server_web/views/changeset_view.ex`, lines 10–18

```elixir
def translate_errors(changeset) do
  Ecto.Changeset.traverse_errors(changeset, &translate_error/1)
end

def render("error.json", %{changeset: changeset}) do
  %{errors: translate_errors(changeset)}
end
```

`Ecto.Changeset.traverse_errors/2` returns a map keyed by the changeset field names (i.e., the Ecto schema field names, which correspond to database column names). The entire map is forwarded directly to the client as `%{errors: ...}`. This discloses the exact field names of the Ecto schema to any client that triggers a validation error. In this application the fields are named with database column naming conventions (e.g., `aadcustcode`, `aadmobile`, `aadimei`). While the risk is lower than exposing stack traces, it provides schema enumeration capability to an attacker probing the API. The error messages themselves are routed through `translate_error/1` via Gettext, which filters the message text — but the map keys (field names) are passed through unmodified.

---

## Summary Table

| ID      | Severity | File(s)                              | Issue                                                             |
|---------|----------|--------------------------------------|-------------------------------------------------------------------|
| A122-1  | CRITICAL | config/config.exs                    | Hardcoded AWS SES SMTP credentials (IAM key + password)           |
| A122-2  | CRITICAL | config/config.exs                    | Hardcoded Guardian JWT signing secret                             |
| A122-3  | CRITICAL | config/config.exs                    | Hardcoded Phoenix secret_key_base                                 |
| A122-4  | CRITICAL | resolvers/puls.ex                    | Hardcoded CalAmp PULS Basic Auth credential in source code        |
| A122-5  | CRITICAL | schema.ex, router.ex                 | All GraphQL queries lack authentication and authorization middleware |
| A122-6  | HIGH     | config/config.exs                    | Guardian JWT TTL is 52 weeks — tokens effectively non-expiring    |
| A122-7  | HIGH     | router.ex                            | GraphiQL IDE present with no authentication guard                 |
| A122-8  | HIGH     | schema.ex, resolvers/things.ex       | Caller-controlled `customer` param, no ownership verification (IDOR) |
| A122-9  | MEDIUM   | resolvers/puls.ex                    | Unbounded recursive retry loop — denial-of-service vector         |
| A122-10 | MEDIUM   | resolvers/puls.ex                    | Unvalidated `hardwareid` interpolated into external URL           |
| A122-11 | HIGH     | schema/thing_types.ex                | GPS coordinates (`aadrange_lat`, `aadrange_long`) exposed in GraphQL type without authorisation |
| A122-12 | MEDIUM   | schema/thing_types.ex                | IMEI and mobile phone number fields exposed in GraphQL type       |
| A122-13 | LOW      | resolvers/puls.ex                    | `IO.puts` in production path bypasses Logger                      |
| A122-14 | MEDIUM   | resolvers/puls.ex                    | CalAmp API hostname hardcoded (configuration management)          |
| A122-15 | HIGH     | endpoint.ex                          | CORSPlug applied globally with default allow-all origin           |
| A122-16 | HIGH     | schema.ex                            | Absinthe introspection not disabled — schema enumeration risk     |
| A122-17 | INFO     | schema.ex, schema/thing_types.ex     | Schema nesting is shallow; deep-query DoS not a current risk      |
| A122-18 | LOW      | views/changeset_view.ex              | Changeset errors expose Ecto field names (schema enumeration)     |

---

*Report generated by agent A122. No source files were modified.*

<!-- A125.md -->
# Audit Report A125
**Agent:** A125
**Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Pass:** 1

---

## Assigned Files

- `lib/api_server_web/views/error_helpers.ex`
- `lib/api_server_web/views/error_view.ex`
- `lib/api_server_web/views/file_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/error_helpers.ex`

**Module:** `ApiServerWeb.ErrorHelpers`

**Public functions:**
| Name | Arity | Line |
|---|---|---|
| `error_tag` | 2 | 11 |
| `translate_error` | 1 | 20 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use Phoenix.HTML` (line 6)

---

### File 2: `lib/api_server_web/views/error_view.ex`

**Module:** `ApiServerWeb.ErrorView`

**Public functions:**
| Name | Arity | Line |
|---|---|---|
| `template_not_found` | 2 | 13 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :view` (line 2)

  This macro expands (via `lib/api_server_web.ex`) to:
  - `use Phoenix.View, root: "lib/api_server_web/templates", namespace: ApiServerWeb`
  - `import Phoenix.Controller, only: [get_flash: 2, view_module: 1]`
  - `use Phoenix.HTML`
  - `import ApiServerWeb.Router.Helpers`
  - `import ApiServerWeb.ErrorHelpers`
  - `import ApiServerWeb.Gettext`

**Notable:** The commented-out block at lines 5–8 shows the Phoenix scaffold's suggested `render("500.html", _assigns)` override was left commented out. No explicit `render("500.json", ...)` or `render("500.html", ...)` functions are defined. All rendering falls through to `template_not_found/2`.

---

### File 3: `lib/api_server_web/views/file_view.ex`

**Module:** `ApiServerWeb.FileView`

**Public functions:**
| Name | Arity | Line |
|---|---|---|
| `render/2` ("index.json") | 2 | 5 |
| `render/2` ("show.json") | 2 | 9 |
| `render/2` ("filesize.json") | 2 | 13 |
| `render/2` ("file.json") | 2 | 20 |

**defstruct / defexception / schema:** None defined.

**use / import / alias at module level:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.FileView` (line 3)

**Supporting context reviewed (not assigned, read for evidence):**
- `lib/api_server_web/controllers/file_controller.ex`: provides callers of these view renders.
- `lib/api_server/operators/file.ex`: Ecto schema for "files" table — fields: `custcode`, `esn`, timestamps.

---

## Checklist Review

### §1: Secrets and Configuration

No config files, credentials, API keys, environment variable reads, or hardcoded secrets appear in these three view files. The view layer does not touch configuration.

**§1: No issues found.**

---

### §2: Authentication and Authorization

These are pure view/rendering modules. They do not perform authentication, issue tokens, or make authorization decisions. No Guardian configuration, password handling, or IDOR-relevant logic is present.

**§2: No issues found.**

---

### §3: Input Validation and Injection

`error_helpers.ex`:
- `translate_error/1` passes error messages and options to `Gettext.dgettext/4` and `Gettext.dngettext/5`. The message string originates from Ecto changeset validation messages, which are developer-defined atoms/strings, not raw user input. Options (including `:count`) originate from Ecto as well. No `String.to_atom/1`, no `fragment/1`, no `binary_to_term/1`, no `Code.eval_string/1`.

`error_view.ex`:
- `template_not_found/2` passes the template name string (e.g. `"404.json"`) to `Phoenix.Controller.status_message_from_template/1`. This template name is Phoenix-controlled, not user-supplied.

`file_view.ex`:
- Pure data serialization from Ecto structs. No user-supplied strings are processed.

**§3: No issues found.**

---

### §4: Session and CSRF

These are view modules with no session access, no CSRF token handling, no channel connection logic, and no cookie interaction.

**§4: No issues found.**

---

### §5: File and Data Handling — HIGH PRIORITY

#### 5a. `error_view.ex` — Information Disclosure in Error Responses

The file defines a single catch-all function:

```elixir
def template_not_found(template, _assigns) do
  %{error: Phoenix.Controller.status_message_from_template(template)}
end
```

The `_assigns` parameter is discarded entirely. This means:

- Stack traces passed via `assigns[:reason]` or `assigns[:conn]` are NOT returned to clients.
- Database errors (e.g., from a rescued `Ecto.QueryError`) passed via assigns are NOT returned to clients.
- The response is always a sanitized HTTP status phrase (e.g., `%{error: "Internal Server Error"}`) derived solely from the template filename.

The commented-out scaffold code at lines 5–8 was the proposed override for `render("500.html", _assigns)` returning a plain string; that it was left commented is benign — the catch-all already covers it cleanly.

**No explicit `render("500.json", ...)` or `render("500.html", ...)` overrides exist.** The catch-all is the sole implementation. Assigns including any raw exception data, changeset errors, or stack frames are dropped via `_assigns`.

This implementation is acceptable from an information-disclosure perspective. There is one observation worth flagging at INFO level:

---

**A125-1** — INFO
**File:** `lib/api_server_web/views/error_view.ex`, line 13
**Title:** No explicit 500 render clause — reliance on Phoenix catch-all
**Detail:** There is no explicit `render("500.json", ...)` or `render("500.html", ...)` function. All error responses (including 500) fall through to `template_not_found/2`, which discards assigns and returns only a status phrase. While the current behaviour is safe, the absence of an explicit 500 handler means that any future developer adding a `render("500.json", assigns)` that logs or returns `assigns[:reason]` could introduce information disclosure without any obvious prior art in the file indicating the risk. The existing commented-out scaffold block (lines 5–8) could mislead a developer into adding an unsafe implementation. Recommend adding an explicit, documented `render("500.json", _assigns)` clause with a comment clearly stating that assigns must not be forwarded to the client.

---

#### 5b. `file_view.ex` — File Path / System Path Exposure

The four render functions serialize the following fields:

- `render("filesize.json")`: `hardwareid`, `size`, `num_fobs`
- `render("file.json")`: `hardwareid`, `size`, `num_fobs`, `fobs`
- `render("index.json")` / `render("show.json")`: delegate to `"file.json"` above

No filesystem paths, absolute paths, server paths, or system-level strings are serialized. The module does not reference `File`, `Path`, or `System` modules, and no string interpolation of path components occurs.

**No file path or internal system path exposure found in `file_view.ex`.**

However, the `fobs` field warrants attention:

---

**A125-2** — MEDIUM
**File:** `lib/api_server_web/views/file_view.ex`, lines 20–26
**Title:** `fobs` field serialized wholesale into JSON response without field selection
**Detail:** `render("file.json", ...)` passes `file.fobs` directly into the JSON response map without explicitly selecting which sub-fields are included. Review of `file_controller.ex` shows that `fobs` is assembled from `Vx.get_vx_access_fobs_for_fleets!/1` which returns `VXAccessFob` structs. The raw struct (including all database-populated fields) is placed into the response. If `VXAccessFob` contains internal identifiers, operator codes, fleet group IDs, or other fields beyond what the hardware client needs, those fields will be disclosed. The view should enumerate exactly which fob fields are safe to return (e.g., only `fob_code` if that is what the hardware requires) rather than passing the entire struct. The controller also constructs `fobs_as_string` from `user.accessfob.fob_code` in `send_file_download/2`, confirming that `fob_code` is the operative field — but `render("file.json")` may return more than that.
**Recommendation:** Replace `fobs: file.fobs` with an explicit field projection in the view, e.g., `fobs: Enum.map(file.fobs, & &1.fob_code)` or equivalent, after confirming which fields are intentionally public.

---

**A125-3** — LOW
**File:** `lib/api_server_web/views/file_view.ex`, lines 13–17 and 20–26
**Title:** `hardwareid` (ESN) is a sensitive hardware identifier exposed in all file responses
**Detail:** The `hardwareid` field (derived from the `esn` column — Electronic Serial Number of a Vx hardware device) is returned in every response from this view. While this is likely intentional (the client is the device itself, requesting its own access fob binary), the ESN uniquely identifies physical hardware. If these endpoints are accessible to any authenticated user rather than being scoped to the device's own fleet/organisation, this could contribute to asset enumeration across customer boundaries. This should be verified at the controller and router level (outside the scope of these three files). Flag for cross-reference with the controller/router audit pass.

---

#### 5c. `error_helpers.ex` — PII / Data Exposure in Error Tags

`error_tag/2` renders field-level validation errors from Ecto changesets into HTML `<span>` elements. The content is the translated error message (e.g., "can't be blank", "is invalid"), not field values. No PII values from the form are included in the error tag output.

**§5: Two findings raised (A125-2 MEDIUM, A125-3 LOW). One observation raised (A125-1 INFO). See above.**

---

### §6: Dependencies

No dependency declarations appear in view files. `mix.exs` and `mix.lock` are outside this assignment.

**§6: No issues found.**

---

### §7: Infrastructure Exposure

No hostnames, IP addresses, port numbers, AWS resource names, CORS configuration, TLS configuration, or inter-service call logic appears in these three view files.

**§7: No issues found.**

---

## Summary of Findings

| ID | Severity | File | Title |
|---|---|---|---|
| A125-1 | INFO | `error_view.ex` | No explicit 500 render clause — reliance on catch-all is safe now but fragile |
| A125-2 | MEDIUM | `file_view.ex` | `fobs` struct serialized wholesale without field selection — potential over-disclosure |
| A125-3 | LOW | `file_view.ex` | `hardwareid` (ESN) exposed in all file responses — verify cross-customer scoping at controller layer |

---

*End of report A125.*

<!-- A128.md -->
# Security Audit Report — A128
**Agent:** A128
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01

---

## Assigned Files

1. `lib/api_server_web/views/geofence_view.ex`
2. `lib/api_server_web/views/layout_view.ex`
3. `lib/api_server_web/views/page_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/geofence_view.ex`

**Module name:** `ApiServerWeb.GeofenceView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render/2` ("index.json") | 2 | 9 |
| `render/2` ("geofence.json") | 2 | 13 |
| `render/2` ("geofence_events.json") | 2 | 22 |

**defstruct / defexception / schema defined:** None.

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `ApiServerWeb, :view` | 2 |
| `alias` | `ApiServerWeb.GeofenceView` | 4 |
| `alias` | `ApiServerWeb.VXThingView` | 5 |
| `alias` | `ApiServer.Vx` | 6 |
| `alias` | `ApiServer.Vx.Geofence` | 7 |

---

### File 2: `lib/api_server_web/views/layout_view.ex`

**Module name:** `ApiServerWeb.LayoutView`

**Public functions (def):** None defined explicitly (all behaviour is inherited from `ApiServerWeb, :view`).

**defstruct / defexception / schema defined:** None.

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `ApiServerWeb, :view` | 2 |

---

### File 3: `lib/api_server_web/views/page_view.ex`

**Module name:** `ApiServerWeb.PageView`

**Public functions (def):** None defined explicitly (all behaviour is inherited from `ApiServerWeb, :view`).

**defstruct / defexception / schema defined:** None.

**use / import / alias at module level:**

| Directive | Value | Line |
|-----------|-------|------|
| `use` | `ApiServerWeb, :view` | 2 |

---

## Checklist Review

### §1: Secrets and Configuration

`geofence_view.ex`, `layout_view.ex`, and `page_view.ex` contain no config references, no credentials, no API keys, no hardcoded secrets, and no environment variable reads. No module attributes embed credentials or secret values.

§1: No issues found.

---

### §2: Authentication and Authorization

The view layer itself does not make authentication or authorization decisions; those are the responsibility of the controller and plug pipeline. However, the view is the final point of data serialisation before transmission to the client, so it is relevant to cross-customer data leakage.

**`render("geofence_events.json", ...)`** at line 22–30 of `geofence_view.ex`:

```elixir
def render("geofence_events.json", %{geofence_events: geofence_events, thing: thing}) do
  Enum.map(geofence_events, fn(event) ->
    %{
      thing: render_one(thing, VXThingView, "rhm_thing.json"),
      ...
    }
  end)
end
```

Each element of the returned list re-renders the `thing` record via `VXThingView.render("rhm_thing.json", ...)`. Inspection of `VXThingView` (read as supporting context) shows `rhm_thing.json` emits:
- `hardwareid`, `customerid`, `serialno`, `address`, `make`, `model`, `hardware_type`, `hour_meters` (with all offset sub-fields), `time_to_service`, `weeks_to_service`, `usage`, `fleets`, `summary` (GPS coordinates: `abmlatitude`, `abmlongitude`), and PM notification metadata.

The concern here is that the `thing` record is embedded into **every event record** in the list. If there are N geofence events, the same full vehicle profile (including GPS, service data, driver-facing fields) is serialised N times. This is an information density issue rather than a cross-customer issue (the controller already scopes the query to the JWT customer claim), but it does produce unnecessarily verbose GPS and fleet data in the payload. This is noted below as a LOW/INFO finding.

Authorization scoping in the controller (`geofence_controller.ex`) reads the customer from `Guardian.Plug.current_claims(conn)["customer"]` and passes it through all `Vx.*` queries. This is correct.

§2: No issues found (authorization defects are not in the view layer; view does not bypass scoping).

---

### §3: Input Validation and Injection

The three view files perform no input parsing, no Ecto queries, no SQL fragments, no atom creation from external input, and no deserialization of untrusted data. They are pure serialisation modules that map Elixir structs to JSON maps.

No `String.to_atom/1`, no `:erlang.binary_to_term/1`, no `Code.eval_string/1`, no `Kernel.apply/3` with user-controlled arguments.

§3: No issues found.

---

### §4: Session and CSRF

View modules do not interact with sessions, CSRF tokens, cookies, or WebSocket connections.

§4: No issues found.

---

### §5: File and Data Handling

**GPS coordinates in `geofence_events.json` response**

`render("geofence_events.json", ...)` at line 24–29 passes the raw `event` map through to the `:geofence_event` key without any field filtering:

```elixir
Enum.map(geofence_events, fn(event) ->
  %{
    thing: render_one(thing, VXThingView, "rhm_thing.json"),
    geofence_event: event
  }
end)
```

The `geofence_event` value is the raw internal event map as constructed in `GeofenceController.make_geofence_event/6` (and equivalently in `Geofence.make_geofence_event_no_thing/5`), which contains:

```elixir
%{
  status: ...,
  geofence_name: ...,
  datetime: ...,
  engine_hours_at_event: ...,
  ignitionstatus: ...,
  eventtype: ...,
  eventcode: ...,
  latitude: ...,
  longitude: ...
}
```

This is a computed internal map, not a raw database row. The fields are bounded and GPS coordinates (`latitude`, `longitude`) are intentionally part of the geofence event response — the feature is explicitly a "where was this vehicle when it crossed a geofence boundary" query. This exposure is consistent with the product's purpose and scoped to the authenticated customer.

**`thing` re-embedded per event (information density)**

As noted in §2, the full vehicle profile including GPS summary coordinates (`abmlatitude`, `abmlongitude`) from `VXThingSummaryView.render("rhm_thing_summary.json", ...)` is serialised once per geofence event rather than once per response. This causes the same GPS fix, service records, and PM notification data to be repeated N times. While not a direct vulnerability, it increases the attack surface area of any response interception and may reveal more telemetry than the caller intends to consume.

**`layout_view.ex` and `page_view.ex`** are empty modules with no render clauses; they cannot disclose data.

**Logger calls:** None in any of the three view files.

**Error disclosure in view layer:** None. The view files do not render error templates or expose stack traces.

§5: No critical issues found. See finding A128-1 below.

---

### §6: Dependencies

The view files themselves introduce no dependencies beyond what is already pulled in via `use ApiServerWeb, :view`. No `mix.exs` or `mix.lock` entries are referenced here.

§6: No issues found (dependencies assessed at repository level by other agents).

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IPs, ports, AWS resource identifiers, or inter-service URLs appear in any of the three view files. No CORS or CSP configuration is present in view modules (that belongs to the endpoint/router layer).

§7: No issues found.

---

## Findings

---

### A128-1 — INFO — Unnecessary GPS and Full Vehicle Profile Repeated Per Geofence Event

**File:** `lib/api_server_web/views/geofence_view.ex`, lines 22–30
**Severity:** INFO

**Description:**

The `render("geofence_events.json", ...)` clause embeds the complete vehicle profile (rendered via `VXThingView.render("rhm_thing.json", ...)`) inside every geofence event in the response list. The `rhm_thing.json` template includes GPS coordinates from the vehicle summary (`abmlatitude`, `abmlongitude`), hour meter offsets, PM notification metadata, service records, fleet memberships, and usage statistics.

If a vehicle has crossed N geofence boundaries in the requested period, the full vehicle profile is serialised N times in the response body. This unnecessarily multiplies the amount of sensitive fleet telemetry transmitted per API call.

**Code:**

```elixir
# geofence_view.ex lines 22-30
def render("geofence_events.json", %{geofence_events: geofence_events, thing: thing}) do
  Enum.map(geofence_events, fn(event) ->
    %{
      thing: render_one(thing, VXThingView, "rhm_thing.json"),
      geofence_event: event
    }
  end)
end
```

**Risk:**

- Each response for a day's worth of geofence crossings may contain dozens of copies of GPS coordinates, service intervals, PM notification dates, and fleet assignments.
- Larger response bodies increase the window for TLS interception, logging, and accidental exposure in proxy or CDN access logs.
- The `thing` object is identical in each list element; there is no reason to repeat it.

**Recommendation (report only — no source modification):**

The caller already has the vehicle context. The response structure should move `thing` to a top-level key outside the event list, rather than embedding it inside each event. This is an architectural improvement and does not constitute a vulnerability in the current threat model (data is already scoped to the authenticated customer), but it reduces unnecessary data exposure surface.

---

### A128-2 — LOW — `render("geofence_events.json")` Passes Raw Internal Event Map Without Explicit Field Whitelist

**File:** `lib/api_server_web/views/geofence_view.ex`, lines 24–29
**Severity:** LOW

**Description:**

The `geofence_event` field in the response is set to the raw map produced by `GeofenceController.make_geofence_event/6`. While that map is a controlled internal construct (not a direct Ecto schema struct), it is passed opaquely as `geofence_event: event` without an explicit field projection in the view. If the upstream controller or context function ever adds additional fields to the event map (for example, internal tracking IDs, raw database row data, or debugging fields), those fields will be silently included in the API response without any view-layer gatekeeping.

This pattern contrasts with the explicit field-by-field construction used in other views (e.g., `VXThingView.render("event_report.json", ...)` which individually maps each field to a named key in the output map).

**Code:**

```elixir
# geofence_view.ex lines 24-29
Enum.map(geofence_events, fn(event) ->
  %{
    thing: render_one(thing, VXThingView, "rhm_thing.json"),
    geofence_event: event     # <-- raw map passed through without field whitelist
  }
end)
```

**Risk:**

If `make_geofence_event` is ever modified to include internal fields (database IDs, raw event structs, debug metadata), they will leak into the API response with no view-layer barrier. The current map fields (`status`, `geofence_name`, `datetime`, `engine_hours_at_event`, `ignitionstatus`, `eventtype`, `eventcode`, `latitude`, `longitude`) are all reasonable to expose, but the pattern offers no protection against future additions.

**Recommendation (report only — no source modification):**

Explicitly project only the intended fields in the view layer for `geofence_event`, mirroring the pattern used in `VXThingView.render("event_report.json", ...)`.

---

*End of A128 findings. Total findings: 2 (0 CRITICAL, 0 HIGH, 0 MEDIUM, 1 LOW, 1 INFO).*

<!-- A131.md -->
# Security Audit Report — A131
**Agent:** A131
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Run:** 2026-02-27-01
**Auditor model:** claude-sonnet-4-6

---

## Assigned Files

1. `lib/api_server_web/views/vx_abl_record_view.ex`
2. `lib/api_server_web/views/vx_access_fob_view.ex`
3. `lib/api_server_web/views/vx_customer_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_abl_record_view.ex`

**Module name:** `ApiServerWeb.VXAblRecordView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render/2` ("index.json") | 2 | 8 |
| `render/2` ("show.json") | 2 | 12 |
| `render/2` ("vx_abl_record.json") | 2 | 16 |
| `render/2` ("services.json") | 2 | 22 |
| `clean_xml_value/1` | 1 | 28 |
| `clean_xml_number_value/1` | 1 | 37 |
| `render/2` ("service.json") | 2 | 46 |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXAblRecordView` (line 4)
- `alias ApiServer.Vx` (line 5)

---

### File 2: `lib/api_server_web/views/vx_access_fob_view.ex`

**Module name:** `ApiServerWeb.VXAccessFobView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render/2` ("index.json") | 2 | 5 |
| `render/2` ("show.json") | 2 | 9 |
| `render/2` ("vx_access_fob.json") | 2 | 13 |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXAccessFobView` (line 3)

---

### File 3: `lib/api_server_web/views/vx_customer_view.ex`

**Module name:** `ApiServerWeb.VXCustomerView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render/2` ("index.json") | 2 | 5 |
| `render/2` ("show.json") | 2 | 9 |
| `render/2` ("vx_customer.json") nil-clause | 2 | 13 |
| `render/2` ("vx_customer.json") | 2 | 14 |

**defstruct / defexception / schema defined:** None

**use / import / alias at module level:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXCustomerView` (line 3)

---

## Supporting Files Read (for context)

The following files were read to assess schema fields and authorization scope:

- `lib/api_server/vx/vx_abl_record.ex` — schema `abl_data_changes`; primary key `ablid`; fields include `ablimage` (raw XML blob), `ablip_address`, `ablusragnt` (user agent), `abluser`, `abllogtype`, `ablaction`, `abltable`, `ablimagetype`, `ablprocessed`.
- `lib/api_server/vx/vx_access_fob.ex` — schema `access_fobs`; fields `fob_code`, FK `assigned_to_user`.
- `lib/api_server/vx/vx_customer.ex` — schema `aaa_customers`; primary key `aaaid`; fields include `aaaprimcont`, `aaaprimemail`, `aaaprimtel`, `aaaudfcustcode`, `aaacolour`.
- `lib/api_server/vx/vx_user.ex` — schema `aac_user`; fields include `aacpassword`, `aacpasswordhash`, `[REDACTED-AWS-SMTP-PASSWORD]`.
- `lib/api_server/vx/vx_fleet.ex` — schema `aae_group`; primary key `aaeid`.
- `lib/api_server_web/controllers/vx_abl_record_controller.ex`
- `lib/api_server_web/controllers/vx_access_fob_controller.ex`
- `lib/api_server_web/controllers/vx_customer_controller.ex`
- `lib/api_server_web/router.ex`
- `lib/api_server/vx/vx.ex` (relevant sections)

---

## Checklist Review

### §1: Secrets and Configuration
These are view files. No config files, hardcoded credentials, API keys, or secrets are present in any of the three files.

**§1: No issues found.**

---

### §2: Authentication and Authorization

Relevant observations from the router and controllers:

- All three view modules are used by controllers that sit behind `pipe_through([:api, :authenticated])` in `router.ex`. The `[REDACTED-AWS-SMTP-PASSWORD]` `:rhm_service_records` action (line 112 of router) is within the authenticated scope.
- The `[REDACTED-AWS-SMTP-PASSWORD]` actions (`:index`, `:show`, `:update`, `:create`, `:delete`) are all within the authenticated scope (lines 139–143 of router).
- `[REDACTED-AWS-SMTP-PASSWORD]` (`:index`, `:show`, `:delete`) is **not registered in the router at all** — those controller actions exist in source but have no live route. This is an informational observation; there is no active exposure.

**Customer controller — IDOR in `show` and `delete`:** `VXCustomerController.show/2` calls `Vx.get_vx_customer!(id, customer)` where `customer` comes from the JWT claim, providing customer-scoped isolation. Similarly for `update` and `delete`. The `index` action calls `Vx.list_customers(customer)` also correctly scoped. No IDOR issue in the customer view/controller pairing.

**ABL record controller — missing customer scoping on `show`, `create`, `update`, `delete`:** The `[REDACTED-AWS-SMTP-PASSWORD]` defines `show/2`, `create/2`, `update/2`, and `delete/2` actions that call `Vx.get_vx_abl_record!(id)` and `Vx.create_vx_abl_record/1` without any customer prefix. However, these four actions are **not registered in the router**; only `:rhm_service_records` is registered and it correctly uses `customer` from JWT claims. This is an informational risk: if routes were added for these actions they would be unscoped.

---

**Finding:**

**A131-1** — MEDIUM — `[REDACTED-AWS-SMTP-PASSWORD]`: unscoped CRUD actions not yet routed

File: `lib/api_server_web/controllers/vx_abl_record_controller.ex` (lines 9–36)

The controller defines `create/2`, `show/2`, `update/2`, and `delete/2` actions that access `VXAblRecord` records without customer scoping — they call `Vx.get_vx_abl_record!(id)` and `Vx.create_vx_abl_record/1` which have no `prefix: customer` argument. These actions are currently not registered in the router so they are not reachable, but their presence creates a latent IDOR/cross-tenant data access risk if routes are ever added. The only routed action, `:rhm_service_records`, correctly scopes by customer JWT claim. The view `vx_abl_record_view.ex` will serve these unscoped results if the actions become reachable.

---

### §3: Input Validation and Injection
These files are view modules only. They contain no SQL queries, no atom creation from user input, no `binary_to_term`, and no `Code.eval_string`. The `clean_xml_value/1` and `clean_xml_number_value/1` helpers in `VXAblRecordView` perform basic nil-coalescing on already-parsed values — they do not process raw user input.

**§3: No issues found.**

---

### §4: Session and CSRF
View modules. No session handling or CSRF configuration is present.

**§4: No issues found.**

---

### §5: File and Data Handling

#### 5a. Over-exposure of sensitive fields in views

**VXAblRecordView — `service.json` template (lines 68–87):**

The `service.json` render exposes the following fields which warrant scrutiny:

- `ip_address: record.ablip_address` — the IP address of the user who performed the service action. This is internal audit-log data (a user's IP address). Exposing IP addresses of users in API responses is a PII/privacy concern; it may unnecessarily reveal information about user network locations to API consumers.
- `usr_agent: record.ablusragnt` — the full User-Agent string of the browser/client at the time of the action. This is also internal audit-log metadata not typically appropriate for API consumers.
- `custcode: record.ablcustcode` — the customer code. While not highly sensitive on its own, in a multi-tenant system this leaks the originating tenant identifier.
- `table: record.abltable` and `action: record.ablaction` — internal database table names and action codes (e.g., "UPD", "aad_thing") are schema implementation details that reveal the internal database structure.

**Finding:**

**A131-2** — MEDIUM — `VXAblRecordView` `service.json`: exposes internal audit metadata including user IP addresses and database internals

File: `lib/api_server_web/views/vx_abl_record_view.ex` (lines 68–87)

The `service.json` render clause exposes `ip_address` (the user's IP address at time of action), `usr_agent` (the full User-Agent string), `table` (internal database table name `"aad_thing"`), and `action` (internal DB operation code `"UPD"`). IP address and User-Agent are PII and internal audit metadata respectively. Exposing them to API consumers is unnecessary for the intended use case (service record listing) and constitutes over-exposure. The database table name and action code leak internal schema implementation details. The `ablimage` raw XML field is correctly withheld.

---

**VXAblRecordView — `vx_abl_record.json` template (lines 16–19):**

Renders `id: vx_abl_record.id` (the `ablid` raw primary key) and `ablcustcode`. The `ablid` is a raw database primary key. For an audit log record this is expected in a CRUD API context, but the template is only exercised by `show.json` and `index.json` which are not currently routed.

---

**VXAccessFobView — `vx_access_fob.json` template (lines 13–16):**

Renders `id: vx_access_fob.id` (raw DB primary key) and `fob_code`. The `fob_code` is the physical access fob identifier. Since the controller `index` action is not routed, exposure is currently inactive. However, `fob_code` is a physical security credential — knowledge of valid fob codes could facilitate physical access bypass. The schema shows `belongs_to :user` via `assigned_to_user` FK; the view correctly does not render the associated user data.

**Finding:**

**A131-3** — HIGH — `VXAccessFobView`: exposes physical access fob codes; no customer scoping on `list_vxaccessfobs`

File: `lib/api_server_web/views/vx_access_fob_view.ex` (lines 13–16)
Related: `lib/api_server_web/controllers/vx_access_fob_controller.ex` (line 10); `lib/api_server/vx/vx.ex` (line 146)

The `index` action calls `Vx.list_vxaccessfobs()` which performs `Repo.all(VXAccessFob)` with no customer prefix scoping — it would return all access fobs across all tenants. The view then renders `fob_code` (a physical security credential) for every record. The combination of (a) bulk enumeration, (b) cross-tenant scope, and (c) physical credential exposure makes this a HIGH finding. The actions are not currently registered in the router, mitigating active risk, but the code is latently dangerous if routes are added.

---

**VXCustomerView — `vx_customer.json` template (lines 18–33):**

The view renders the following fields from `VXCustomer`:
- `id: vx_customer.aaaid` — raw database primary key (`aaaid`). This is the internal integer primary key of the customer record.
- `code: vx_customer.aaacustcode`
- `name`, `address_line_1/2/3`, `post_code`
- `primary_contact_name: vx_customer.aaaprimcont`
- `primary_contact_telephone: vx_customer.aaaprimtel`
- `primary_contact_email: vx_customer.aaaprimemail`
- `timezone: vx_customer.aaatz`

The schema also contains `aaaudfcustcode` and `aaacolour` which are **commented out** in the view (lines 30–31). This is correctly withheld.

The rendered fields include the primary contact's name, telephone number, and email address. These are PII. In the context of a fleet management system, exposing customer contact PII via the API to authenticated users may be appropriate (customer records are a standard resource), but the API returns **all** customers visible to the JWT's `customer` prefix via `index`. The `primary_contact_telephone` and `primary_contact_email` fields especially should be reviewed as to whether all authenticated users of a tenant need access to contact details for all sub-customers.

**Finding:**

**A131-4** — LOW — `VXCustomerView`: exposes PII fields (contact name, telephone, email) for all customers in tenant

File: `lib/api_server_web/views/vx_customer_view.ex` (lines 22–29)

The `vx_customer.json` render includes `primary_contact_name`, `primary_contact_telephone`, and `primary_contact_email` for every customer record returned by the `index` endpoint. These are PII fields. The exposure is scoped to the authenticated user's tenant (the `list_customers` context function correctly uses `prefix: customer`), which limits the blast radius, but any authenticated user in the tenant can enumerate contact PII for all customers. Depending on the role model, read access to contact details may not be appropriate for all user types. The `aaaudfcustcode` and `aaacolour` fields are correctly commented out in the view.

---

**Finding:**

**A131-5** — MEDIUM — `VXCustomerController.create/2`: Ecto changeset error details returned to API caller

File: `lib/api_server_web/controllers/vx_customer_controller.ex` (line 28)

The `create/2` action's error branch sends a raw `inspect error.errors` string in the HTTP 500 response body:
```elixir
send_resp(conn, :internal_server_error, "{\"error\": \"error creating customer\", \"reason\": \"#{inspect error.errors}\" }")
```
Ecto changeset error tuples can contain internal field names (e.g., constraint names like `UQ1`), validation rule names, and database column identifiers. This discloses internal schema details to API consumers and violates the principle of minimal error disclosure. Additionally, `IO.inspect error` on line 27 logs the full error struct to stdout/logs, which may include sensitive data depending on the input. This is a controller-level finding directly affecting what the view layer returns.

---

#### 5b. PII / fleet data in Logger calls
The three view files contain no `Logger` calls.

**§5 summary:** Findings A131-2 (IP/UA/DB internals in audit view), A131-3 (fob code exposure + no tenant scoping), A131-4 (customer contact PII), A131-5 (error disclosure in customer create) raised above.

---

### §6: Dependencies
These are view files. No dependency declarations are present.

**§6: No issues found.**

---

### §7: Infrastructure Exposure
These are view files. No hardcoded hostnames, IPs, CORS configuration, or inter-service communication is present.

**§7: No issues found.**

---

## Findings Summary

| ID | Severity | Location | Title |
|----|----------|----------|-------|
| A131-1 | MEDIUM | `vx_abl_record_controller.ex` lines 9–36 | Unscoped CRUD actions (not routed, latent IDOR/cross-tenant risk) |
| A131-2 | MEDIUM | `vx_abl_record_view.ex` lines 68–87 | `service.json` exposes user IP address, User-Agent, and internal DB table/action names |
| A131-3 | HIGH | `vx_access_fob_view.ex` lines 13–16; `vx_access_fob_controller.ex` line 10 | Physical access fob codes exposed; `list_vxaccessfobs` has no tenant scoping |
| A131-4 | LOW | `vx_customer_view.ex` lines 22–29 | Contact PII (name, phone, email) exposed for all customers in tenant on index |
| A131-5 | MEDIUM | `vx_customer_controller.ex` line 28 | Raw Ecto error internals returned in HTTP 500 response body |

---

## Detailed Findings

### A131-1 — MEDIUM
**Title:** Unscoped VXAblRecord CRUD actions (latent IDOR / cross-tenant data access)

**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`, lines 9–36
**View affected:** `lib/api_server_web/views/vx_abl_record_view.ex`

**Description:**
`[REDACTED-AWS-SMTP-PASSWORD]` defines `create/2`, `show/2`, `update/2`, and `delete/2` actions. Each retrieves or modifies records using `Vx.get_vx_abl_record!(id)` and `Vx.create_vx_abl_record/1`, which call `Repo.get!` and `Repo.insert` with no `prefix: customer` argument. In a multi-tenant Postgres schema-per-tenant deployment (as confirmed by the scoped queries elsewhere in the codebase), omitting the prefix would cause the query to operate on the default schema or raise a runtime error, depending on the Repo configuration. At minimum this is an incomplete implementation. If routes were added, any authenticated user could potentially access audit records from other tenants by supplying an arbitrary ID.

The contrast with `rhm_service_records` (the only routed action) is clear: that action correctly derives `customer` from JWT claims and passes it as prefix.

**Recommendation:** Add customer scoping to all four unrouted actions before adding routes. Remove the actions entirely if they will never be needed, to reduce attack surface.

---

### A131-2 — MEDIUM
**Title:** `service.json` render exposes user IP addresses, User-Agent strings, and internal database table/action codes

**File:** `lib/api_server_web/views/vx_abl_record_view.ex`, lines 68–87

**Description:**
The `service.json` render clause (used by the live `/rhm/services` endpoint) serialises the following fields from the `abl_data_changes` audit log that should not be returned to API consumers:

- `ip_address: record.ablip_address` — the IP address of the user who performed the service action. This is PII under most privacy frameworks (GDPR Art. 4(1) considers IP addresses personal data). It is audit-log provenance data with no legitimate use by the frontend service consumer.
- `usr_agent: record.ablusragnt` — the full User-Agent header string stored at the time of the action. Again, internal audit provenance.
- `table: record.abltable` — the internal database table name (`"aad_thing"`). Leaks internal schema.
- `action: record.ablaction` — the internal operation code (`"UPD"`). Leaks internal audit semantics to external consumers.

**Recommendation:** Remove `ip_address`, `usr_agent`, `table`, and `action` from the `service.json` render clause. If any of these are genuinely needed by a consuming application, gate them behind a specific role/permission check.

---

### A131-3 — HIGH
**Title:** Physical access fob codes exposed by `VXAccessFobView`; `list_vxaccessfobs` has no tenant scoping

**File:** `lib/api_server_web/views/vx_access_fob_view.ex`, lines 13–16
**Related:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`, line 10
**Related:** `lib/api_server/vx/vx.ex`, line 146

**Description:**
The `vx_access_fob.json` render clause exposes `fob_code`. Access fob codes are physical security credentials — they are the identifiers programmed into RFID/proximity fobs that grant physical access to machinery or facilities. Enumerating valid fob codes provides an attacker with the information needed to clone fobs or bypass access controls.

Additionally, `Vx.list_vxaccessfobs/0` (called by `VXAccessFobController.index/2`) performs `Repo.all(VXAccessFob)` with no customer prefix. In a multi-tenant schema-per-tenant deployment this would return all access fobs across all tenants — a cross-tenant data leak.

While `[REDACTED-AWS-SMTP-PASSWORD]` is not currently registered in the router (no route exists for `:index`, `:show`, or `:delete`), the implementation is complete and the code is ready to be activated. The severity is rated HIGH because `fob_code` is a physical security credential and the underlying query is not tenant-scoped.

**Recommendation:**
1. Add `prefix: customer` to `Vx.list_vxaccessfobs/0` (or create a scoped variant) before routing the endpoint.
2. Evaluate whether `fob_code` needs to be returned in the API response at all, or whether a boolean `is_assigned` flag would suffice for the intended use case.
3. If `fob_code` must be returned, restrict the endpoint to privileged roles only.

---

### A131-4 — LOW
**Title:** Customer `index` endpoint exposes contact PII for all tenant sub-customers

**File:** `lib/api_server_web/views/vx_customer_view.ex`, lines 22–29
**Related:** `lib/api_server_web/controllers/vx_customer_controller.ex`, line 12
**Related:** `lib/api_server/vx/vx.ex`, line 2872

**Description:**
The `vx_customer.json` render clause includes `primary_contact_name`, `primary_contact_telephone`, and `primary_contact_email`. The `index` action returns all customers in the tenant (`Repo.all(VXCustomer, prefix: customer)`) meaning all authenticated users, regardless of role, can enumerate the name, telephone number, and email address of every contact person across all sub-customers in their tenant.

The customer scoping is correctly applied (prefix: customer), so cross-tenant leakage does not occur. The risk is intra-tenant: a low-privilege user (e.g., a driver or operator) should arguably not have read access to the contact details of other customers in the same tenant.

**Recommendation:** Review whether role-based access control should restrict access to contact PII fields. Consider a separate endpoint or projection for admin users vs. read-only users. At minimum, document the access control decision.

---

### A131-5 — MEDIUM
**Title:** Raw Ecto changeset error details returned in HTTP 500 response body

**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`, line 28
**View affected:** N/A (uses `send_resp` directly, bypassing the view layer)

**Description:**
The `create/2` action's else-branch constructs a response body containing `inspect error.errors`:

```elixir
send_resp(conn, :internal_server_error,
  "{\"error\": \"error creating customer\", \"reason\": \"#{inspect error.errors}\" }")
```

`inspect error.errors` on an Ecto changeset produces output such as:
```
[aaacustcode: {"has already been taken", [constraint: :unique, constraint_name: "UQ1"]}]
```

This discloses:
- Internal database column names (`aaacustcode`)
- Database constraint names (`UQ1`)
- Validation rule details

These details are unnecessary for the API consumer and aid an attacker in enumerating valid values or understanding the schema. Additionally, `IO.inspect error` (line 27) writes the full changeset to standard output/logs, which may include the input data submitted by the user.

The standard Phoenix approach (`action_fallback` with `FallbackController` and `ChangesetView`) is already available in this codebase (the controller declares `action_fallback ApiServerWeb.FallbackController`) but is not used in the `else` branch.

**Recommendation:** Replace the manual `send_resp` error branch with `{:error, changeset}` returned from the `with` expression so that `FallbackController` handles it, or produce a generic error message without internal field/constraint names.

<!-- A134.md -->
# Audit Report A134
**Agent:** A134
**Run:** 2026-02-27-01
**Stack:** Elixir/Phoenix — api_server
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server_web/views/vx_fleet_association_view.ex`
2. `lib/api_server_web/views/vx_fleet_view.ex`
3. `lib/api_server_web/views/vx_rental_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_fleet_association_view.ex`

**Module name:** `ApiServerWeb.VXFleetAssociationView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 ("index.json", %{vxfleetassociationss: ...}) | 5 |
| `render` | 2 ("show.json", %{vx_fleet_association: ...}) | 9 |
| `render` | 2 ("vx_fleet_association.json", %{vx_fleet_association: ...}) | 13 |

**defstruct / defexception / schema:** None defined in this file.

**use / import / alias at module level:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXFleetAssociationView` (line 3)

---

### File 2: `lib/api_server_web/views/vx_fleet_view.ex`

**Module name:** `ApiServerWeb.VXFleetView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 ("index.json", %{vxfleets: ...}) | 5 |
| `render` | 2 ("show.json", %{vx_fleet: ...}) | 9 |
| `render` | 2 ("vx_fleet.json", %{vx_fleet: ...}) | 13 |
| `render` | 2 ("rhm_fleets.json", %{vx_fleets: ...}) | 22 |
| `render` | 2 ("rhm_fleet.json", %{vx_fleet: ...}) | 25 |
| `render` | 2 ("rhm_fleets_with_equip.json", %{vx_fleets: ...}) | 34 |
| `render` | 2 ("rhm_fleet_with_equip.json", %{vx_fleet: ...}) | 37 |
| `render` | 2 ("rhm_fleet_equipment.json", %{results: ...}) | 47 |
| `render` | 2 ("assoc.json", %{vx_fleet: {fleet_id, equipment_id, equipment_name}}) | 51 |

**defstruct / defexception / schema:** None defined in this file.

**use / import / alias at module level:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXFleetView` (line 3)

---

### File 3: `lib/api_server_web/views/vx_rental_view.ex`

**Module name:** `ApiServerWeb.VXRentalView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 ("rhm_rentals.json", %{vx_rentals: ..., customer: ...}) | 8 |
| `render` | 2 ("rhm_rental.json", %{vx_rental: ..., customer: ...}) | 13 |
| `render` | 2 ("midpac_report.json", %{data: ...}) | 64 |
| `render` | 2 ("rental_anniversaries.json", %{all_anniversary_data: ...}) | 68 |
| `convert_json_to_changeset` | 1 | 73 |

**defstruct / defexception / schema:** None defined in this file.

**use / import / alias at module level:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServer.Vx` (line 3)
- `alias ApiServerWeb.VXRentalView` (line 4)
- `alias ApiServerWeb.VXThingView` (line 5)
- `alias ApiServerWeb.VXCustomerView` (line 6)

---

## Schema Field Coverage Analysis

Supporting schemas were read to assess whether views over-expose sensitive fields.

### `ApiServer.Vx.VXFleetAssociation` schema (`aaf_groups_things`)

Fields: `aafid` (PK), `aafcustcode`, `aafgroupid` (FK to fleet), `aafthingid` (FK to thing).

`VXFleetAssociationView.render("vx_fleet_association.json")` renders: `id` (aafid), `aafcustcode`.
The FK fields `aafgroupid` and `aafthingid` are not rendered. No sensitive fields omitted beyond the FKs — the customer code is an internal identifier but is surfaced (see findings).

### `ApiServer.Vx.VXFleet` schema (`aae_group`)

Fields: `aaeid` (PK), `aaecustcode`, `aaedesc`, `aaecolour`, `aaetype`, `aaeshowfilter`.

`VXFleetView.render("vx_fleet.json")` renders: `id`, `aaetype`, `aaeshowfilter`, `aaecolour`. Omits `aaecustcode`, `aaedesc`.
`VXFleetView.render("rhm_fleet.json")` renders: `id` (aaeid), `name` (aaedesc), `type` (aaetype), `show_in_filters` (aaeshowfilter), `color` (aaecolour). Omits `aaecustcode`.
`VXFleetView.render("rhm_fleet_with_equip.json")` renders: `id` (aaeid), `name` (aaedesc), `type` (aaetype), `show_in_filters` (aaeshowfilter), `equipment`. Omits `aaecustcode`, `aaecolour`. Note `equipment` is passed as a raw pre-built list from the controller — see findings.

### `ApiServer.Vx.VXRental` schema (`abh_rentals`)

Fields: `abhid` (PK), `abhcustcode`, `abhclient`, `abhstartdate`, `abhenddate`, `abhtransdate`, `abhnotes`, `abhrental_freq`, `abhallowed_hours`, `abhreport_freq`, `abhcustomerid`, `period_calculation`, plus associations `customer` and `thing`.

`VXRentalView.render("rhm_rental.json")` renders: `id`, `cust_code` (abhcustcode), `customer_id` (abhcustomerid), `thing_id` (abhthingid), `start_date`, `end_date`, `created_date` (abhtransdate), `notes`, `period` (abhrental_freq), `allowed_hours`, `reporting_period`, `period_calculation`, plus nested `thing` and `customer` renders and `usage` block.

The field `abhclient` is not rendered. All other schema fields are rendered. The `abhthingid` is rendered as `thing_id` even though a full nested `thing` object is also rendered. See findings below.

---

## Checklist Review

### §1: Secrets and Configuration

These are view modules only. No config files, credentials, API keys, module attributes with secrets, or hardcoded connection strings are present.

§1: No issues found.

---

### §2: Authentication and Authorization

#### VXFleetAssociationView / VXFleetAssociationController

The `[REDACTED-AWS-SMTP-PASSWORD]` defines three actions (`index`, `show`, `delete`). The controller **is not registered in the router** — no routes point to it. However, the `index` and `show`/`delete` actions contain a critical authorization defect that is relevant to the view's design:

- `Vx.list_vxfleetassociations()` (called by `index`) issues a global `Repo.all` with no `prefix:` (tenant/customer) scope. This would expose all fleet-to-thing association records across all customers.
- `Vx.get_vx_fleet_association!(id)` (called by `show` and `delete`) issues a `Repo.get!` with no tenant scope. Any authenticated user who can reach this endpoint could retrieve or delete any association record by ID.

Because the controller is not routed, the immediate exploitability is low, but the view and controller pair are ready-to-expose once a route is added. This pattern is flagged as a design defect.

#### VXFleetController

The `create` action (line 9–16) uses the scaffold-generated `show.json` template which calls `render("vx_fleet.json", ...)`. The `create` action uses no customer scoping from the JWT claim — it passes raw params from `vx_fleet_params` directly to `Vx.create_vx_fleet/1`. This is a controller-level concern but the view exposure is linked.

The `delete_fleet`, `update_fleet`, `get_equipment_in_fleet`, and `manage_fleet` actions all accept `customer` from the URL path parameter (`%{"customer" => customer}`), not from the JWT claim. See finding A134-3.

#### VXRentalController

`create_rental` and `update_rental` accept `customer` from the URL path (`%{"customer" => customer, ...}`), not from the JWT claim. An authenticated user from one tenant could pass a different customer code in the URL and create or modify rentals in another tenant's database prefix. See finding A134-3.

`delete_rental` similarly accepts `customer` from the path.

#### VXRentalView — `convert_json_to_changeset/1` in a View Module

See finding A134-4.

§2: Issues found — see A134-1, A134-2, A134-3.

---

### §3: Input Validation and Injection

No raw SQL fragments, `String.to_atom/1`, `Code.eval_string`, `:erlang.binary_to_term`, or `Kernel.apply` are present in any of the three view files.

`VXRentalView.convert_json_to_changeset/1` (lines 73–89) processes user-supplied JSON fields (string map keys) and maps them to internal atom-keyed map entries using `Vx.update_key_if_value/3`. The function uses bracket string-key access (`rental_json["period"]`, etc.) — no atom creation from user input. The `"28 Day Period"` match is a static literal comparison, not dynamic atom creation.

§3: No issues found.

---

### §4: Session and CSRF

View files only. No session, cookie, or CSRF configuration is present here.

§4: No issues found.

---

### §5: File and Data Handling

#### Pass-through renders (data leakage risk)

**`VXRentalView.render("midpac_report.json", %{data: data})`** (line 64–66):

```elixir
def render("midpac_report.json", %{data: data}) do
  data
end
```

This render function returns the `data` value **verbatim**, with zero transformation or field filtering. The `data` value is a list of maps constructed in the controller (`VXRentalController.get_midpac_style_rental_report/2`). While the controller constructs a selective map (vehicle_name, make, serial_number, at_customer, rental_start, rental_frequency, allowed_hours, operating hours, meter reading, usage, overtime, hours_since_last_service, hours_to_service, anniversary_date), the view provides no enforcement layer. If the controller is ever modified to pass richer structs, the view will blindly serialise all fields including any sensitive ones. The pattern also defeats the purpose of the view layer as a serialisation boundary.

**`VXRentalView.render("rental_anniversaries.json", %{all_anniversary_data: data})`** (line 68–70):

```elixir
def render("rental_anniversaries.json", %{all_anniversary_data: data}) do
  data
end
```

Identical pass-through pattern. The controller constructs the map selectively, but the view provides no guard.

See finding A134-5.

#### `VXRentalView.render("rhm_rental.json")` — Live database queries inside a view

Lines 15–26 call `Vx.fetch_actual_usage/5`, `Vx.get_usage_since_service/2`, and `Vx.get_avg_weekly_hours/2` directly from the view function. This places business logic and database I/O inside the view layer, which means errors from these calls (database errors, nil-pointer crashes) will surface as render errors, making stack traces potentially reachable through error responses. This is a structural concern but has a data-handling dimension.

See finding A134-6.

#### `VXFleetView.render("rhm_fleet_with_equip.json")` — Raw equipment map

Line 37–44 passes `vx_fleet.equipment` directly into the response:

```elixir
def render("rhm_fleet_with_equip.json", %{vx_fleet: vx_fleet}) do
  %{id: vx_fleet.aaeid,
    name: vx_fleet.aaedesc,
    ...
    equipment: vx_fleet.equipment
  }
end
```

The `equipment` field is a pre-built list from the controller (containing only `%{name: ..., hardwareid: ...}` entries), but the view applies no filtering. If the upstream data source changes (e.g., to include association or customer records), this will pass through silently.

See finding A134-7.

#### PII / GPS in Logger calls

No `Logger` calls are present in the three view files.

§5: Issues found — see A134-5, A134-6, A134-7.

---

### §6: Dependencies

View files only. No dependency declarations.

§6: No issues found.

---

### §7: Infrastructure Exposure

No hostnames, IPs, port numbers, CORS configuration, or inter-service call configuration is present in the view files.

§7: No issues found.

---

## Findings

---

### A134-1 — CRITICAL: VXFleetAssociationController index/show/delete have no tenant scoping

**Severity:** CRITICAL
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex` (context for the view's data source)
**Related view:** `lib/api_server_web/views/vx_fleet_association_view.ex`

`VXFleetAssociationController.index/2` calls `Vx.list_vxfleetassociations()` which executes:

```elixir
def list_vxfleetassociations do
  VXFleetAssociation
      |> Ecto.Query.where([r], r.aafgroupid != ^"29")
      |> Ecto.Query.preload(:fleet)
      |> Ecto.Query.preload(:thing)
      |> Repo.all      # no prefix: — hits the default/global schema
end
```

There is no `prefix:` option (no tenant isolation), no customer claim from the JWT, and no authorisation check that the requesting user belongs to the same tenant as the records returned. `Vx.get_vx_fleet_association!(id)` used in `show` and `delete` similarly calls `Repo.get!` without any tenant prefix.

The controller is not currently routed (no entry in `router.ex`). However, the scaffolded code exists on the master branch, is fully functional, and would immediately expose cross-tenant fleet-association data if a route were added. The view (`vx_fleet_association.json`) renders `aafcustcode` directly — confirming that customer-code data from other tenants would be returned to any authenticated caller.

**Recommendation:** Do not route this controller until tenant scoping is implemented. All three actions must pass the JWT claim's `customer` value to the data layer as a `prefix:` argument, and `show`/`delete` must verify the association's `aafcustcode` matches the requesting user's tenant before returning or acting on the record.

---

### A134-2 — HIGH: VXFleetAssociationView renders internal customer code (`aafcustcode`) in API responses

**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`, lines 13–16

```elixir
def render("vx_fleet_association.json", %{vx_fleet_association: vx_fleet_association}) do
  %{id: vx_fleet_association.id,
    aafcustcode: vx_fleet_association.aafcustcode}
end
```

The internal customer code (`aafcustcode`) is an internal tenant discriminator. Exposing it in API responses allows clients to enumerate tenant identifiers. In a multi-tenant fleet management system, internal customer codes should not be surfaced to end clients unless there is a documented requirement. The raw database column name is also leaked as the JSON key, which reveals schema internals.

**Recommendation:** Remove `aafcustcode` from the response, or if the client requires a tenant identifier, use a stable external ID that does not double as an internal discriminator.

---

### A134-3 — HIGH: Customer parameter accepted from URL path instead of JWT claim in rental and fleet mutation endpoints

**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex` (lines 158, 174, 191); `lib/api_server_web/controllers/vx_fleet_controller.ex` (lines 68, 91, 105, 110, 119)

Multiple mutation endpoints accept the `customer` tenant identifier from the URL path parameter rather than from the authenticated JWT claim:

```elixir
# vx_rental_controller.ex
def create_rental(conn, %{"customer" => customer, "rental" => rental_params}) do
def update_rental(conn, %{"customer" => customer, "rental" => rental_params}) do
def delete_rental(conn, %{"customer" => customer, "id" => id}) do

# vx_fleet_controller.ex
def create_fleet(conn, %{"customer" => cust, "fleet" => fleet_params}) do
def delete_fleet(conn, %{"customer" => customer, "id" => id}) do
def get_equipment_in_fleet(conn, %{"customer" => customer, "id" => fleet_id}) do
def manage_fleet(conn, %{"customer" => customer, "id" => fleet_id, ...}) do
def update_fleet(conn, %{"customer" => customer, "fleet" => fleet_params}) do
```

An authenticated user from tenant A can supply `customer=tenant_B` in the URL to create, update, or delete records in tenant B's database prefix. This is a cross-tenant IDOR/privilege escalation vulnerability. The views (`rhm_rental.json`, `rhm_fleet.json`) will then render the resulting records from the attacker-specified tenant.

Read-path endpoints (`get_rentals`, `get_fleets`, `get_fleets_with_equipment`) correctly extract customer from the JWT claim (`ApiServer.Guardian.Plug.current_claims(conn)["customer"]`), making the inconsistency more pronounced.

**Recommendation:** Extract the `customer` value exclusively from the JWT claim (`ApiServer.Guardian.Plug.current_claims(conn)["customer"]`) in all mutation actions. Discard any client-supplied customer value.

---

### A134-4 — MEDIUM: `convert_json_to_changeset/1` is a public function defined in a View module

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 73–89

```elixir
def convert_json_to_changeset(rental_json) do
  rental_period = case rental_json["period"] do
    "28 Day Period" -> "28DAY"
    _ -> rental_json["period"]
  end
  changeset = %{}
    |> Vx.update_key_if_value(:abhthingid, rental_json["thing_id"])
    |> Vx.update_key_if_value(:abhstartdate, rental_json["start_date"])
    ...
end
```

This function is business logic (transforming user input into a changeset) placed inside a view module. View modules in Phoenix are intended solely for serialising data to a response format. Having public business-logic functions in a view module:

1. Blurs the boundary between input processing and output rendering, making it harder to identify the attack surface during code review.
2. Makes the function accessible from any module that aliases the view, potentially bypassing controller-level guards.
3. The function is called directly from two controller actions (`create_rental`, `update_rental`), coupling the controller to the view in an unusual direction.

The function also performs no validation — it only maps values if present (`update_key_if_value`). There are no type checks, length limits, or allow-list checks on any of the string fields (`abhthingid`, `abhstartdate`, `abhenddate`, `abhcustomerid`, `abhnotes`, `abhrental_freq`, `abhallowed_hours`, `abhreport_freq`). The resulting map is passed directly to `Vx.create_rental/2` or `Vx.update_rental/3`.

**Recommendation:** Move `convert_json_to_changeset/1` into `ApiServer.Vx.VXRental` or a dedicated input-parsing module. Add input validation (type coercion and boundary checks) before constructing the changeset map. The controller should call the schema module, not the view.

---

### A134-5 — MEDIUM: Pass-through render functions provide no serialisation boundary

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 64–70

```elixir
def render("midpac_report.json", %{data: data}) do
  data
end

def render("rental_anniversaries.json", %{all_anniversary_data: data}) do
  data
end
```

Both render functions return their input argument verbatim. The view layer provides no field filtering, type normalisation, or serialisation control. Any change to the upstream controller that includes additional fields (e.g., passing full Ecto structs, adding internal IDs, including PII) will be immediately reflected in the API response without any view-layer guard.

In the case of `midpac_report.json`, the controller builds the map manually and is reasonably selective. However, `rental_anniversaries.json` also passes the pre-built `anniversary_data` list, which includes `with_customer` (customer name), `serial_number`, `vehicle_name`, and `make` fields about fleet assets. If the controller logic expands, sensitive fields could leak silently.

**Recommendation:** Replace pass-through renders with explicit field maps. Define the exact keys and values the API contract requires, mirroring the pattern used in `rhm_rental.json`.

---

### A134-6 — MEDIUM: Database queries executed inside view render function

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 15–26

```elixir
def render("rhm_rental.json", %{vx_rental: vx_rental, customer: customer}) do
  {last_week, for_month, since_service, hours_to_service, average_weekly} = cond do
    vx_rental.thing != nil ->
      last_week = Vx.fetch_actual_usage(vx_rental.thing.aadhardwareid, ...)
      for_month = Vx.fetch_actual_usage(vx_rental.thing.aadhardwareid, ...)
      {_, since_service} = Vx.get_usage_since_service(vx_rental.thing, customer)
      average_weekly = Vx.get_avg_weekly_hours(vx_rental.thing, customer)
      ...
  end
  ...
end
```

Multiple live database/business-logic calls (`Vx.fetch_actual_usage/5`, `Vx.get_usage_since_service/2`, `Vx.get_avg_weekly_hours/2`) are made directly inside the view render function. This violates the Phoenix MVC convention and creates the following security-relevant concerns:

1. Database errors (connection failures, unexpected nil results) occurring in the view will produce render errors rather than being handled at the controller layer. Depending on the `FallbackController` and `ErrorView` configuration, these may produce responses that include internal error detail.
2. The `customer` value used for these data fetches is passed through from the controller. If the controller passes an attacker-controlled customer code (see A134-3), the view will query that customer's database prefix for usage data — the view layer provides no independent check.
3. Performance failures in these view-layer queries are difficult to instrument or time out cleanly.

**Recommendation:** Move all data fetching to the controller. The view should receive pre-computed values (last_week, for_month, since_service, etc.) in the assigns map and perform only formatting/serialisation.

---

### A134-7 — LOW: `equipment` field passed through without filtering in `rhm_fleet_with_equip.json`

**Severity:** LOW
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, lines 37–44

```elixir
def render("rhm_fleet_with_equip.json", %{vx_fleet: vx_fleet}) do
  %{id: vx_fleet.aaeid,
    name: vx_fleet.aaedesc,
    type: vx_fleet.aaetype,
    show_in_filters: vx_fleet.aaeshowfilter,
    equipment: vx_fleet.equipment
  }
end
```

The `equipment` field is a pre-built list passed in from the controller. At present the controller builds it with only `%{name: vehicle_name, hardwareid: hardwareid}` entries. However, the view performs no field selection on the `equipment` list — it is passed through as-is. If the controller is changed to populate `equipment` with richer structs (e.g., Ecto-preloaded `VXThing` records), all fields including internal IDs, IMEI numbers, mobile numbers, and GPS coordinates would be serialised.

**Recommendation:** Render the equipment list explicitly in the view, selecting only the fields required for the API contract.

---

### A134-8 — INFO: Typo in `hours_to_service` JSON key in `rhm_rental.json`

**Severity:** INFO
**File:** `lib/api_server_web/views/vx_rental_view.ex`, line 55

```elixir
hours_to_serivce: hours_to_service,
```

The JSON key is misspelled as `hours_to_serivce` (transposed `i` and `v`). This is a bug rather than a security issue, but it is flagged as it represents an inconsistency in the API contract that may affect client-side processing and could mask incorrect values being silently ignored by API consumers.

**Recommendation:** Correct the key name to `hours_to_service` and update any API consumers that currently accept the misspelled key.

---

### A134-9 — INFO: `vx_fleet.json` template omits fleet name (`aaedesc`) — potential contract ambiguity

**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, lines 13–20

```elixir
def render("vx_fleet.json", %{vx_fleet: vx_fleet}) do
  %{
    id: vx_fleet.id,
    aaetype: vx_fleet.aaetype,
    aaeshowfilter: vx_fleet.aaeshowfilter,
    aaecolour: vx_fleet.aaecolour
  }
end
```

This template (used by the scaffolded `index.json` and `show.json` routes) omits `aaedesc` (the fleet name) and uses raw database column names as JSON keys (`aaetype`, `aaeshowfilter`, `aaecolour`). The `rhm_fleet.json` template (the primary application-facing template) maps these to semantic names. The existence of two parallel templates with different field sets and naming conventions is a maintenance risk — a client that receives `vx_fleet.json` instead of `rhm_fleet.json` will get column-named fields, which leaks schema structure.

**Recommendation:** If the `index.json`/`show.json` routes served by `vx_fleet.json` are still in use, align the template with `rhm_fleet.json` naming conventions. If these routes are unused, remove the templates.

---

## Summary Table

| ID | Severity | File | Title |
|----|----------|------|-------|
| A134-1 | CRITICAL | vx_fleet_association_view.ex / controller | VXFleetAssociationController has no tenant scoping on any action |
| A134-2 | HIGH | vx_fleet_association_view.ex | Internal customer code (`aafcustcode`) exposed in API response |
| A134-3 | HIGH | vx_rental_view.ex / vx_fleet_view.ex (controllers) | Customer tenant identifier accepted from URL path on mutation endpoints |
| A134-4 | MEDIUM | vx_rental_view.ex | Business logic (`convert_json_to_changeset`) placed in view module without input validation |
| A134-5 | MEDIUM | vx_rental_view.ex | Pass-through render functions provide no serialisation boundary |
| A134-6 | MEDIUM | vx_rental_view.ex | Database queries executed inside view render function |
| A134-7 | LOW | vx_fleet_view.ex | `equipment` field passed through without explicit field selection |
| A134-8 | INFO | vx_rental_view.ex | Typo in JSON key `hours_to_serivce` |
| A134-9 | INFO | vx_fleet_view.ex | `vx_fleet.json` template uses raw column names and is inconsistent with `rhm_fleet.json` |

<!-- A137.md -->
# Audit Report A137
**Agent:** A137
**Run:** 2026-02-27-01
**Branch:** master
**Stack:** Elixir/Phoenix — api_server
**Date:** 2026-02-27

---

## Assigned Files

1. `lib/api_server_web/views/vx_restriction_view.ex`
2. `lib/api_server_web/views/vx_thing_event_view.ex`
3. `lib/api_server_web/views/vx_thing_omega_view.ex`

Supporting context files read (not assigned, referenced for analysis):
- `lib/api_server_web/controllers/vx_thing_event_controller.ex`
- `lib/api_server_web/controllers/vx_restriction_controller.ex`
- `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
- `lib/api_server_web/router.ex`
- `lib/api_server/vx/vx_restriction.ex`
- `lib/api_server/vx/vx.ex` (relevant excerpts)

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_restriction_view.ex`

**Module name:** `ApiServerWeb.VXRestrictionView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 — `"index.json"` clause | 5 |
| `render` | 2 — `"show.json"` clause | 9 |
| `render` | 2 — `"vx_restriction.json"` clause | 13 |

**defstruct / defexception / schema defined:** None.

**use / import / alias at module level:**

| Kind | Value | Line |
|------|-------|------|
| `use` | `ApiServerWeb, :view` | 2 |
| `alias` | `ApiServerWeb.VXRestrictionView` | 3 |

---

### File 2: `lib/api_server_web/views/vx_thing_event_view.ex`

**Module name:** `ApiServerWeb.VXThingEventView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 — `"index.json"` clause | 5 |
| `render` | 2 — `"show.json"` clause | 9 |
| `render` | 2 — `"vx_thing_event.json"` clause | 13 |

**Private functions (defp, noted for completeness):**

| Name | Arity | Line |
|------|-------|------|
| `omega_to_map` | 1 | 18 |
| `thingevent_to_map` | 1 | 83 |

**defstruct / defexception / schema defined:** None.

**use / import / alias at module level:**

| Kind | Value | Line |
|------|-------|------|
| `use` | `ApiServerWeb, :view` | 2 |
| `alias` | `ApiServerWeb.VXThingEventView` | 3 |

**Fields serialised — `thingevent_to_map/1` (lines 84–131):**
`id`, `gmtdatetime`, `hardwareid`, `eventtype`, `eventcode`, `latitude`, `longitude`, `driverid`, `engineonelapsed`, `totalengineseconds`, `hardwaretype`, `datetimesaved`, `dateinqueue`, `timeoffix`, `altitude`, `heading`, `speed`, `rssi`, `gpsfixquality`, `odometer`, `mifaredriverid`, `ignition`, `ignitionstatus`, `calcengineseconds`, `input1elapsed`, `input1status`, `input1totalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `input2elapsed`, `input2status`, `input2totalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `input3elapsed`, `input3status`, `input3totalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `input4elapsed`, `input4status`, `input4totalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `prntelapsed`, `prntstatus`, `prnttotalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`.

**Fields serialised — `omega_to_map/1` (lines 19–81):**
`accelerometerx`, `accelerometery`, `accelerometerz`, `[REDACTED-AWS-SMTP-PASSWORD]`, `omegadriverid`, `seatbelt`, `seated`, `parkbrakerequest`, `parkbreakreleased`, `vehicleload`, `tilt`, `height`, `overload`, `attretracted`, `yellowled`, `redled`, `greenled`, `liftenable`, `safetyoverride`, `parkbrakerror`, `batterynotcharged`, `lowengineoil`, `accnotcharged`, `[REDACTED-AWS-SMTP-PASSWORD]`, `airfilterblocked`, `attpressure`, `oilcoolerfan`, `lowerinterruption`, `undersafetyheight`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `md3temperature`, `fuellevel`, `md3status`, `xa2status`, `batteryvoltage`, `xa2temperature`, `boomangle`, `boomextension`, `lift`, `extension`, `[REDACTED-AWS-SMTP-PASSWORD]`, `fuelrate`, `totalfuelidle`, `totalidlehour`, `totalenginehour`, `enginerpm`, `capacity`, `coolanttemperature`, `oiltemperature`, `engineerrorcode`, `vehiclespeed`, `gearselection`, `transerrorcode`, `prestartchecklist`, `truckerrorcode`, `mc43status`, `mc43temperature`, `lc5status`, `lc5temperature`.

---

### File 3: `lib/api_server_web/views/vx_thing_omega_view.ex`

**Module name:** `ApiServerWeb.VXThingOmegaView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 — `"container_lift_report.json"` clause | 6 |
| `render` | 2 — `"lift_summary_report_fleet.json"` clause | 17 |
| `render` | 2 — `"lift_summary_report.json"` clause | 39 |
| `render` | 2 — `"lift_list_report.json"` clause | 63 |
| `render` | 2 — `"engine_utilization_report.json"` clause | 77 |
| `render` | 2 — `"operation_summary_report.json"` clause | 92 |

**Private functions (defp):**

| Name | Arity | Line |
|------|-------|------|
| `translate_lift_type_to_string` | 1 | 139 |

**defstruct / defexception / schema defined:** None.

**use / import / alias at module level:**

| Kind | Value | Line |
|------|-------|------|
| `use` | `ApiServerWeb, :view` | 2 |
| `alias` | `ApiServerWeb.VXThingOmegaView` | 3 |

---

## Checklist Review

### §1: Secrets and Configuration

No config files, environment variable access, credentials, API keys, or secret material is present in any of the three view files. Views contain no module attributes, application env lookups, or comments referencing secrets.

**§1: No issues found.**

---

### §2: Authentication and Authorization

#### VXRestrictionView — missing controller actions and absent route

The `VXRestrictionView` exposes three render clauses: `index.json`, `show.json`, and `vx_restriction.json`. The corresponding `[REDACTED-AWS-SMTP-PASSWORD]` (`lib/api_server_web/controllers/vx_restriction_controller.ex`) is effectively empty — it contains only `use ApiServerWeb, :controller`, aliases, and `action_fallback`. No action functions (`index`, `show`, `create`, etc.) are implemented.

No route in `router.ex` references `[REDACTED-AWS-SMTP-PASSWORD]` for any CRUD action on restriction records. The view exists but the controller surface is unused at the HTTP level.

This is noted as an informational item: dead view/controller scaffold for a sensitive access-control data model (`aau_rest` table, which governs fleet access restrictions per user). The risk is latent — if routes are added in future without proper authorization, the full restriction table for any customer could be dumped.

#### VXThingEventController — `index` and CRUD actions are unrouted but exist

The router only exposes:
```
GET /api/v1/rhm/thing/:hardwareid/omega_data  ->  VXThingEventController.get_current_omega_status/2
```
The `index/2`, `show/2`, `create/2`, `update/2`, and `delete/2` actions on `[REDACTED-AWS-SMTP-PASSWORD]` are present in the controller source but are **not wired to any route** in `router.ex`. They are therefore unreachable via HTTP at present.

However, `index/2` calls `Vx.list_vxthingevents()`, which resolves to `Repo.all(VXThingEvent)` — a table scan with **no tenant scoping** and **no pagination**. If this action were ever routed (accidentally or deliberately), it would return all telemetry records across all customers. This is flagged below (A137-2).

#### VXThingEventController — `get_current_omega_status/2` (the one routed action)

This action correctly extracts `customer` from the Guardian JWT claims (`ApiServer.Guardian.Plug.current_claims(conn)["customer"]`) before calling `Vx.get_most_recent_thingevent_with_omega(hardwareid, customer)`. The customer context is enforced at the data layer, not the view layer.

The route is placed inside the `pipe_through([:api, :authenticated])` pipeline scope (line 33 of `router.ex`), so it is behind JWT authentication.

#### VXThingOmegaController — all actions

All six controller actions correctly extract `customer` and `user_id` from JWT claims before querying. All routes for these actions fall within the `pipe_through([:api, :authenticated])` block.

**Finding A137-1 (see below) — `index` action: unrouted but dangerous; `write_partial_record` and `add_calculated_fields` are public but not route-accessible.**

---

### §3: Input Validation and Injection

The view files themselves do not perform any user-input processing, SQL construction, atom creation, or deserialization. They are purely serializers mapping struct fields to map literals.

No `String.to_atom/1`, `fragment/1`, `binary_to_term/1`, `Code.eval_string/1`, or `Kernel.apply/3` usage is present in any of the three files.

**§3: No issues found in the view files themselves.**

---

### §4: Session and CSRF

View files do not configure sessions or CSRF. Not applicable.

**§4: No issues found.**

---

### §5: File and Data Handling

This section is the primary concern for view files in a fleet-management system.

#### VXThingEventView — GPS coordinates and driver IDs in the telemetry response

The `thingevent_to_map/1` private function (lines 84–131) serialises the following sensitive fields unconditionally into every API response for `vx_thing_event.json`:

- **GPS coordinates:** `latitude` (line 90), `longitude` (line 91), `altitude` (line 99), `heading` (line 100), `speed` (line 101), `gpsfixquality` (line 103), `timeoffix` (line 98).
- **Driver identification:** `driverid` (line 92), `mifaredriverid` (line 105).

The `omega_to_map/1` private function additionally serialises:
- `omegadriverid` (line 24) — a second driver ID field from the omega payload.
- Detailed vehicle state data (seatbelt, safety-override, load, error codes, etc.).

All of these fields are emitted in a single flat merged map via `Map.merge(thingevent_to_map(...), omega_to_map(...))` at line 14. There is no field filtering, masking, or role-based exclusion at the view layer.

The route `/api/v1/rhm/thing/:hardwareid/omega_data` is authenticated and customer-scoped (see §2), so the data is not publicly accessible. However, the issue is that **any authenticated user of a customer tenant receives the full GPS track, both driver ID fields, and all safety-override status** for a vehicle. There is no per-user role check to restrict access to sensitive fields such as `driverid`, `mifaredriverid`, and `omegadriverid`. This constitutes over-exposure of PII (driver identity) and real-time location data.

**Finding A137-3 (HIGH) — see below.**

#### VXThingOmegaView — `lift_list_report.json` exposes `operator` field

The `render("lift_list_report.json", ...)` clause (lines 63–75) serialises an `operator` field derived directly from the data layer tuple:

```elixir
fn({datetime, lift_type, vehicle_load, operator, thing_name}) ->
  %{
    ...
    operator: operator,
    ...
  }
```

The field name `operator` in the context of a lift-event report is likely a driver/operator identifier. This is confirmed by the controller calling `Vx.get_list_lift_event_counts_for_thing_by_day/7`. No masking or role-based suppression is applied.

**Finding A137-4 (MEDIUM) — see below.**

#### Logger / IO.puts diagnostic output in VXThingEventController

While not in the view files, the controller used by VXThingEventView contains `IO.puts/1` and `IO.inspect/1` calls (lines 63, 65–68, 79–81) that write hardware IDs, changeset contents (potentially including latitude/longitude/driverid fields), and operational data to stdout. In a production container these will appear in application logs. This is flagged below as A137-5.

---

### §6: Dependencies

No `mix.exs` or `mix.lock` reference appears in the assigned view files.

**§6: No issues found in assigned files.**

---

### §7: Infrastructure Exposure

The view files contain no hostnames, IP addresses, port numbers, CORS configuration, or inter-service call logic.

**§7: No issues found.**

---

## Findings

---

### A137-1 — INFO — Unrouted but public CRUD surface on VXThingEventController

**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex` (referenced by `VXThingEventView`)
**Lines:** 9–44 (`index`, `create`, `show`, `update`, `delete`)

The `[REDACTED-AWS-SMTP-PASSWORD]` exposes five standard CRUD actions and two additional public functions (`write_partial_record/3`, `add_calculated_fields/2`). None of the five CRUD actions is wired to a route in `router.ex`. Only `get_current_omega_status/2` is routed (line 56 of router).

The `index/2` action calls `Vx.list_vxthingevents()` which resolves to an unscoped `Repo.all(VXThingEvent)` — no tenant prefix, no pagination:

```elixir
# lib/api_server/vx/vx.ex line 1622
def list_vxthingevents do
  Repo.all(VXThingEvent)
end
```

If a route is accidentally added, or if a router change maps `resources "/vx_thing_events"` to this controller in the unauthenticated `pipe_through(:api)` scope, a full cross-tenant dump of the telemetry table (including GPS, driver IDs) would be publicly accessible.

**Recommendation:** Either delete the unused CRUD action scaffolding from `[REDACTED-AWS-SMTP-PASSWORD]`, or add a guard comment and explicit documentation that these actions must never be routed. If `list_vxthingevents/0` in `vx.ex` is retained, it must be given a tenant-scoped variant that accepts a customer prefix before any route is added.

---

### A137-2 — HIGH — `Vx.list_vxthingevents/0` has no tenant scoping and no pagination

**Severity:** HIGH
**File:** `lib/api_server/vx/vx.ex` line 1622 (context file, referenced by assigned view)

```elixir
def list_vxthingevents do
  Repo.all(VXThingEvent)
end
```

This function is called exclusively by `VXThingEventController.index/2`. It performs a full-table scan with no `prefix:` (customer schema), no `where` clause, and no limit. For a large fleet deployment the result set could contain millions of records with GPS tracks, driver IDs, and sensor data spanning all customers.

Although the route is currently absent, the function is a latent cross-tenant data-leak vector. The correct pattern used elsewhere in the codebase is `Repo.all(..., prefix: customer)`.

**Recommendation:** Add tenant scoping and pagination to `list_vxthingevents/0`, or remove it entirely if it is not intended for use.

---

### A137-3 — HIGH — Full GPS coordinates and dual driver IDs exposed in every telemetry response

**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`
**Lines:** 83–131 (`thingevent_to_map/1`), lines 18–81 (`omega_to_map/1`), line 14 (merge)

Every call to `render("vx_thing_event.json", ...)` (used by both the `show.json` and the `get_current_omega_status` route) serialises the following sensitive fields with no filtering or role check:

- **Real-time GPS:** `latitude`, `longitude`, `altitude`, `heading`, `speed`, `gpsfixquality`, `timeoffix`
- **Driver PII:** `driverid` (line 92), `mifaredriverid` (line 105), `omegadriverid` (omega line 24)

Three separate driver-identification fields are present in the same response. The `mifaredriverid` field specifically represents a Mifare card identifier (physical proximity card) — a hardware token number that could be used to clone or track an individual worker's identity across systems.

The route `/api/v1/rhm/thing/:hardwareid/omega_data` is authenticated and customer-scoped, so this is not a public data leak. However:

1. Any user within a tenant can query live GPS position and driver identity for any vehicle by hardware ID — there is no per-user role or fleet-membership check at the controller or view layer.
2. The three driver-identity fields (one from the core event, two from the omega payload) are duplicated and over-exposed in a way that is unlikely to all be required by every consumer of this endpoint.

**Recommendation:**
- Audit which client use-cases genuinely require `driverid`, `mifaredriverid`, and `omegadriverid` simultaneously. Expose only the minimum required.
- Apply a fleet-membership or role check in the controller before returning location data, consistent with the fleet-scoped access model visible in `get_list_of_valid_fleets_for_user/2` elsewhere in `vx.ex`.
- Consider a separate, more restricted endpoint for clients that only need operational state (seatbelt, park-brake, load) without GPS and driver identity.

---

### A137-4 — MEDIUM — Operator (driver) identity exposed in lift list report without role filtering

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`
**Lines:** 63–75 (`render("lift_list_report.json", ...)`)

The `lift_list_report.json` response includes an `operator` field in each lift event record:

```elixir
%{
  thing_name: thing_name,
  gmtdatetime: event_time,
  lift_type: translate_lift_type_to_string(lift_type),
  operator: operator,
  vehicle_load: vehicle_load
}
```

The `operator` value is sourced from the tuple returned by `Vx.get_list_lift_event_counts_for_thing_by_day/7` and represents a driver/operator identifier associated with each lift event. This report endpoint (`GET /api/v1/rhm/omega_thing/:hardwareid/lift_list_report`) is authenticated and customer-scoped in the controller, but there is no role-based check to determine whether the requesting user has permission to view individual operator-level attribution.

This creates a scenario where any authenticated user (e.g., a read-only fleet viewer) can enumerate every operator who used a particular piece of equipment over a date range, which may constitute processing of employee personal data under privacy regulations (e.g., GDPR, Australian Privacy Act).

**Recommendation:** Apply a role check in `VXThingOmegaController.get_lift_list_report/2` before serialising operator identity. If no role check is feasible in the short term, document the data-privacy impact and obtain a privacy review sign-off.

---

### A137-5 — MEDIUM — `IO.puts` / `IO.inspect` in production controller path leaks PII to application logs

**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Lines:** 63, 65–68, 79–81

Three diagnostic output calls are present in production controller code called by `write_partial_record/3` and `add_calculated_fields/2`:

```elixir
# Line 63
IO.puts("Inserted")

# Lines 65–68
{:error, changeset} ->
  case changeset.errors do
    _ ->
      IO.inspect(changeset)
  end

# Lines 79–81
IO.puts(
  "totalengineseconds is nil for #{record_to_add.hardwareid} but aadhourmeter is set to ..."
)
```

`IO.inspect(changeset)` will dump the full changeset struct to stdout, which may include `latitude`, `longitude`, `driverid`, and other sensor fields from the rejected record. `IO.puts` with `hardwareid` in the format string will also write equipment identifiers to logs.

In production these writes reach stdout/stderr and will be captured by container log aggregation (CloudWatch, etc.), where they may be retained, indexed, and accessible to log-system users who should not have visibility of individual GPS or driver records.

**Recommendation:** Replace all `IO.puts` and `IO.inspect` calls with structured `Logger` calls at appropriate levels (`Logger.debug` for success paths, `Logger.error` for changeset failures). Ensure that PII fields (`latitude`, `longitude`, `driverid`) are excluded from logged changeset details — log only the error keys, not the full changeset data.

---

### A137-6 — MEDIUM — VXRestrictionView exposes internal user-ID and customer-code fields

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_restriction_view.ex`
**Lines:** 13–21

The `vx_restriction.json` render clause serialises all fields of the `aau_rest` access-control table including:

```elixir
%{id: vx_restriction.id,
  aauid: vx_restriction.aauid,
  aauuser_id: vx_restriction.aauuser_id,
  aaucustcode: vx_restriction.aaucustcode,
  aaufun: vx_restriction.aaufun,
  aaucharval: vx_restriction.aaucharval,
  aaunumval: vx_restriction.aaunumval}
```

This table is the fleet-access control table (`aau_rest`): it maps users (`aauuser_id`) to the fleets (`aaunumval` where `aaufun = "FLEET"`) they are permitted to access. Exposing the full restriction row — including the internal user numeric ID, customer code, and the function code (`aaufun`) — provides a caller with a complete map of the tenant's user-to-fleet access matrix.

Although no HTTP route currently points to `[REDACTED-AWS-SMTP-PASSWORD]` (the controller is empty), the view is fully implemented and ready to serve this data. If a route is added without careful authorization gating, any authenticated user could enumerate all users' fleet permissions within the tenant.

**Recommendation:**
- If this view is ever routed, restrict its use to admin-role users only — never to general authenticated users.
- Consider stripping `aauuser_id` (raw database ID) from the response and returning only the fleet associations relevant to the requesting user.
- Add a comment in the view and controller explicitly documenting that this endpoint must be admin-only.

---

### A137-7 — LOW — Duplicate route definition for `operation_summary_report`

**Severity:** LOW
**File:** `lib/api_server_web/router.ex`
**Lines:** 91–100

The route `GET /api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` is defined twice:

```elixir
# Line 91–94
get(
  "/rhm/omega_fleet/:fleetid/operation_summary_report",
  VXThingOmegaController,
  :get_operation_summary_report
)

# Line 96–100 (duplicate)
get(
  "/rhm/omega_fleet/:fleetid/operation_summary_report",
  VXThingOmegaController,
  :get_operation_summary_report
)
```

In Phoenix, the first matching route takes precedence and the second is silently ignored. This is dead code that creates maintenance confusion and may mask a copy-paste error where a different action or path was intended for the second entry.

**Recommendation:** Remove the duplicate route definition. Review whether a distinct variant (e.g., with different parameters or a different path segment) was intended.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A137-1 | INFO | `vx_thing_event_controller.ex` | Unrouted CRUD scaffold — dangerous if ever routed; `index` has no tenant scope |
| A137-2 | HIGH | `vx.ex` (via view) | `list_vxthingevents/0` performs full cross-tenant table scan with no scope or pagination |
| A137-3 | HIGH | `vx_thing_event_view.ex` | GPS coordinates and three driver ID fields exposed in every telemetry response without per-user role check |
| A137-4 | MEDIUM | `vx_thing_omega_view.ex` | Operator identity serialised in lift-list report without role filtering — privacy impact |
| A137-5 | MEDIUM | `vx_thing_event_controller.ex` | `IO.puts`/`IO.inspect` in production path may write GPS coordinates and driver IDs to logs |
| A137-6 | MEDIUM | `vx_restriction_view.ex` | Full user-to-fleet access control matrix exposed if view is ever routed; no admin-only guard |
| A137-7 | LOW | `router.ex` | Duplicate route definition for `operation_summary_report` |

<!-- A140.md -->
# Audit Report A140
**Run:** 2026-02-27-01
**Agent:** A140
**Scope:** api_server — Elixir/Phoenix — branch: master
**Pass:** 1

---

## Assigned Files

1. `lib/api_server_web/views/vx_thing_summary_view.ex`
2. `lib/api_server_web/views/vx_thing_view.ex`
3. `lib/api_server_web/views/vx_user_function_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_thing_summary_view.ex`

**Module name:** `ApiServerWeb.VXThingSummaryView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 (`"index.json"`, `%{vxthingsummaries: ...}`) | 5 |
| `render` | 2 (`"show.json"`, `%{vx_thing_summary: ...}`) | 9 |
| `render` | 2 (`"vx_thing_summary.json"`, `%{vx_thing_summary: ...}`) | 13 |
| `render` | 2 (`"rhm_thing_summary.json"`, `%{vx_thing_summary: ...}`) | 57 |

**defstruct / defexception / schema:** None defined.

**use / import / alias:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXThingSummaryView` (line 3)

---

### File 2: `lib/api_server_web/views/vx_thing_view.ex`

**Module name:** `ApiServerWeb.VXThingView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 (`"index.json"`, `%{vxthings: ...}`) | 8 |
| `render` | 2 (`"show.json"`, `%{vx_thing: ...}`) | 12 |
| `render` | 2 (`"fleet_map.json"`, `%{vxthings: ...}`) | 16 |
| `render` | 2 (`"fleet_map.json"`, `%{vx_thing: thing}`) | 20 |
| `render` | 2 (`"hardware_with_checklists.json"`, `%{vx_things: ...}`) | 105 |
| `render` | 2 (`"pm_data.json"`, `%{vx_things: ...}`) | 109 |
| `render` | 2 (`"pm_data.json"`, `%{vx_thing: ...}`) | 113 |
| `render` | 2 (`"movements.json"`, `%{movements: ...}`) | 147 |
| `render` | 2 (`"movement.json"`, `%{vx_thing: movement}`) | 150 |
| `render` | 2 (`"checklists.json"`, `%{checklists: ...}`) | 164 |
| `render` | 2 (`"vx_checklist.json"`, `%{vx_thing: checklist}`) | 168 |
| `render` | 2 (`"vx_thing.json"`, `%{vx_thing: ...}`) | 176 |
| `render` | 2 (`"rhm_thing_usage.json"`, `%{usage: ...}`) | 220 |
| `render` | 2 (`"rhm_thing_usage_manual.json"`, `%{usage: ..., hardwareid: ..., customer: ...}`) | 224 |
| `render` | 2 (`"usage_report.json"`, `%{vx_thing: [...]}`) | 228 |
| `render` | 2 (`"usage_report_many.json"`, `%{vx_thing: [...], hardwareid: ..., customer: ...}`) | 265 |
| `render` | 2 (`"rhm_things_usage.json"`, `%{usage_by_hardwareid: ...}`) | 292 |
| `render` | 2 (`"rhm_thing_events.json"`, `%{events: ...}`) | 315 |
| `render` | 2 (`"event_report.json"`, `%{vx_thing: event}`) | 318 |
| `render` | 2 (`"rhm_thing.json"`, `%{vx_things: ...}`) | 351 |
| `render` | 2 (`"rhm_thing.json"`, `%{vx_thing: {vx_thing, usage_data}}`) | 354 |
| `render` | 2 (`"basic_thing.json"`, `%{vx_thing: nil}`) | 359 |
| `render` | 2 (`"basic_thing.json"`, `%{vx_thing: ...}`) | 360 |
| `render` | 2 (`"sielift_wip_export.json"`, `%{vx_thing: ...}`) | 396 |
| `render` | 2 (`"pape_exports.json"`, `%{vx_thing: ...}`) | 434 |
| `render` | 2 (`"pape_export.json"`, `%{vx_thing: [...]}`) | 437 |
| `render` | 2 (`"rhm_things_names.json"`, `%{vx_things: ...}`) | 449 |
| `render` | 2 (`"things_only.json"`, `%{thing_records: ...}`) | 453 |
| `info_to_map` | 1 | 487 |
| `thing_to_map` | 2 | 499 |

**defstruct / defexception / schema:** None defined.

**use / import / alias:**
- `use ApiServerWeb, :view` (line 2)
- `use Timex` (line 3)
- `alias ApiServerWeb.VXThingView` (line 4)
- `alias ApiServerWeb.VXThingSummaryView` (line 5)

---

### File 3: `lib/api_server_web/views/vx_user_function_view.ex`

**Module name:** `ApiServerWeb.VXUserFunctionView`

**Public functions (def):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 (`"index.json"`, `%{vxaatuserfunctions: ...}`) | 5 |
| `render` | 2 (`"show.json"`, `%{vx_user_function: ...}`) | 9 |
| `render` | 2 (`"vx_user_function.json"`, `%{vx_user_function: ...}`) | 13 |

**defstruct / defexception / schema:** None defined.

**use / import / alias:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXUserFunctionView` (line 3)

---

## Checklist Review

### §1: Secrets and Configuration

No config files, hardcoded credentials, API keys, secret key bases, pipeline variables, or AWS infrastructure references appear in any of the three view files.

§1: No issues found.

---

### §2: Authentication and Authorization

**Context established from controller review (`vx_thing_controller.ex`):** Most controller actions that feed these views correctly extract `customer` and `user_id` from Guardian JWT claims (e.g. `ApiServer.Guardian.Plug.current_claims(conn)["customer"]`) before passing data to the views. The views themselves are pure serialisation layers that receive pre-fetched structs and maps.

However, two concerns are raised at the view layer:

**A140-1 — MEDIUM — VXThingView: `vx_thing.json` exposes `aadimei` (IMEI) and internal IDs to API consumers**

`render("vx_thing.json", ...)` at line 176–218 of `vx_thing_view.ex` serialises `aadimei` (device IMEI number), `aadmobile` (mobile/SIM number), and `aadcustomerid` to the JSON response unconditionally. IMEI and SIM numbers are sensitive device identifiers that could aid device cloning or social-engineering attacks against mobile carriers. Their inclusion in a general-purpose API response (used for the full `show.json` and `index.json` responses) should be reviewed. If these are not required by clients, they should be removed from the serialised output.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 188–189 (`aadimei`, `aadmobile`).

**A140-2 — MEDIUM — VXThingView: `fleet_map.json` exposes full GPS coordinates, heading, speed, and driver identifiers in a single response**

`render("fleet_map.json", %{vx_thing: thing})` at lines 20–103 serialises `vlat`, `vlong`, `vign`, `vhd`, `vsp`, GPS coordinates, the driver ID (`abmdriverid`/`operator`), and the full `usage` struct for every vehicle in a fleet. If the route serving this template is not scoped to the authenticated user's organisation (or if the `customer` parameter can be arbitrarily supplied by the caller), this response constitutes a complete fleet position and operator disclosure across customer boundaries. This is a data-isolation concern rather than a purely view-layer defect, but the view does not perform any filtering.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 38–99.

§2: Two issues raised (A140-1, A140-2).

---

### §3: Input Validation and Injection

No user-controlled input is interpolated into Ecto queries or shell commands in these view files. The view modules do not call `String.to_atom/1`, `:erlang.binary_to_term/1`, `Code.eval_string/1`, or `Kernel.apply/3`.

**A140-3 — MEDIUM — VXThingView: Non-exhaustive `case` on `category` integer — no catch-all clause**

`render("usage_report.json", ...)` at lines 228–263 and `render("usage_report_many.json", ...)` at lines 265–290 both contain:

```elixir
days_usage = case category do
  2 -> daily_usage_input0
  3 -> daily_usage_input1
  4 -> daily_usage_input2
  5 -> daily_usage_input3
  6 -> daily_usage_input4
end
```

No `_` (catch-all) clause is present. If `category` takes any value other than 2–6 (for example, if a device reports category 1, 7, or any unexpected integer), the `case` will raise a `CaseClauseError` at runtime, causing an unhandled exception in the view and potentially a 500 response. Although `category` originates from a database value rather than direct user input, the absence of a default makes this a robustness and potential information-disclosure risk (unhandled exceptions may leak stack traces depending on error handler configuration). The same pattern is duplicated in both render clauses.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 234–245 and 270–281.

§3: One issue raised (A140-3).

---

### §4: Session and CSRF

View modules do not configure sessions, CSRF tokens, WebSocket channels, or cookie parameters. Not applicable to these files.

§4: No issues found.

---

### §5: File and Data Handling

**A140-4 — HIGH — VXThingSummaryView and VXThingView: GPS coordinates, driver IDs, and operator identifiers exposed in multiple JSON templates**

The following templates serialise real-time GPS position data (latitude, longitude, heading, speed) along with driver/operator identifiers to API responses:

- `vx_thing_summary_view.ex`: `render("vx_thing_summary.json", ...)` lines 13–54 — exposes `abmlatitude`, `abmlongitude`, `abmheading`, `abmspeed`, `abmdriverid`, `abmmifaredriverid`, `abmcustcode`.
- `vx_thing_summary_view.ex`: `render("rhm_thing_summary.json", ...)` lines 57–122 — exposes the same GPS fields plus a dedicated `gps` sub-object and `current_operator` sub-object containing `driver_id` and `mifare_driver_id`.
- `vx_thing_view.ex`: `render("fleet_map.json", ...)` lines 20–103 — `vlat`, `vlong`, `vhd`, `vsp` for every vehicle in the fleet map response.
- `vx_thing_view.ex`: `render("movement.json", ...)` lines 150–162 — `latitude`, `longitude`, `speed`, `operator` (driver ID).
- `vx_thing_view.ex`: `render("event_report.json", ...)` lines 318–349 — `location.latitude`, `location.longitude`, `operator` (driver ID).

Per checklist §5, api_server is a fleet management backend. Any endpoint returning vehicle locations, driver records, or customer assets must be scoped to the authenticated user's organisation. The view layer itself cannot enforce this scoping — it blindly serialises whatever data it receives. The risk is that if the controller layer fails to enforce customer/organisation scoping (see A140-2 regarding the `customer` parameter being supplied by the caller in some `fleet_map` routes), these views will expose cross-customer GPS and PII data without any view-layer guard.

Additionally, `abmmifaredriverid` (a physical RFID/Mifare card ID) is serialised by both `vx_thing_summary.json` and `rhm_thing_summary.json`. This is a physical access credential identifier. Its inclusion in API responses should be reviewed to confirm it is necessary for the consuming client and that it is not being exposed to unauthorised roles.

- Files: `lib/api_server_web/views/vx_thing_summary_view.ex` (lines 43–44, 65–67) and `lib/api_server_web/views/vx_thing_view.ex` (lines 44–46, 160, 341).

**A140-5 — LOW — VXThingView: Commented-out `IO.puts` debug statements include hardware IDs and usage data in source**

`thing_to_map/2` at lines 507–531 of `vx_thing_view.ex` contains a large commented-out block with multiple `IO.puts` statements that would log hardware IDs, time-remaining values, and daily usage figures to stdout if uncommented. While currently inactive, their presence represents a maintenance risk: if any developer uncomments this block during debugging, sensitive fleet operational data would be written to application logs. Commented-out debug logging that includes PII or sensitive operational data should be removed.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 519–529.

**A140-6 — LOW — VXThingView: `pm_data.json` hardcodes placeholder values in live response**

`render("pm_data.json", %{vx_thing: vx_thing})` at lines 113–145 includes the following hardcoded stub values in the serialised JSON response:

```elixir
previousweek: 0.1,
thisweek: 0.2,
avgperweek: 0.2,
mtdraw: 0.3,
weekstoservice: 0.4
```

These are clearly placeholder/stub values that were never replaced with real computed values. Clients consuming this endpoint will receive fabricated data, which could lead to incorrect preventive-maintenance decisions. This is not a security vulnerability, but it is a data-integrity issue that warrants a finding.

- File: `lib/api_server_web/views/vx_thing_view.ex`, lines 138–142.

§5: Three issues raised (A140-4, A140-5, A140-6).

---

### §6: Dependencies

View files do not declare dependencies. `mix.exs` and `mix.lock` are not in scope for this file assignment.

§6: No issues found.

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IP addresses, port numbers, CORS configuration, TLS settings, or inter-service authentication logic appear in these view files.

§7: No issues found.

---

## Summary of Findings

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A140-1 | MEDIUM | `vx_thing_view.ex` | `vx_thing.json` serialises IMEI (`aadimei`) and SIM (`aadmobile`) to all API consumers |
| A140-2 | MEDIUM | `vx_thing_view.ex` | `fleet_map.json` serialises full GPS + driver identity for entire fleet; relies solely on controller-layer scoping |
| A140-3 | MEDIUM | `vx_thing_view.ex` | Non-exhaustive `case` on `category` in `usage_report.json` and `usage_report_many.json` — no catch-all, will raise `CaseClauseError` on unexpected values |
| A140-4 | HIGH | `vx_thing_summary_view.ex`, `vx_thing_view.ex` | Multiple templates expose GPS coordinates, driver IDs, and Mifare card IDs with no view-layer scoping guard |
| A140-5 | LOW | `vx_thing_view.ex` | Commented-out `IO.puts` debug block in `thing_to_map/2` would log hardware IDs and operational data if re-enabled |
| A140-6 | LOW | `vx_thing_view.ex` | `pm_data.json` hardcodes placeholder numeric values (`0.1`, `0.2`, `0.3`, `0.4`) for five fields instead of real computed data |

<!-- A143.md -->
# Security Audit Report — A143
**Agent:** A143
**Run:** 2026-02-27-01
**Branch:** master
**Stack:** Elixir/Phoenix
**Assigned files:**
- `lib/api_server_web/views/vx_user_view.ex`
- `lib/api_server_web/xml_plug.ex`

**Checklist applied:** PASS1-CHECKLIST-api_server.md (all 7 sections)

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_user_view.ex`

**Module name:** `ApiServerWeb.VXUserView`

**Public functions (def, not defp):**

| Name | Arity | Line |
|------|-------|------|
| `render` | 2 — `"index.json"` clause | 5 |
| `render` | 2 — `"show.json"` clause | 9 |
| `render` | 2 — `"rhm_users.json"` clause | 13 |
| `render` | 2 — `"rhm_user.json"` clause | 17 |
| `render` | 2 — `"fleet_list.json"` clause | 58 |

**No defstruct, defexception, or schema defined.**

**use / import / alias at module level:**
```elixir
use ApiServerWeb, :view           # line 2
alias ApiServerWeb.VXUserView     # line 3
```

**No plug entries** (view module, not a plug or router).

---

### File 2: `lib/api_server_web/xml_plug.ex`

**Module name:** `Plug.Parsers.XML`

**Public functions (def, not defp):**

| Name | Arity | Line |
|------|-------|------|
| `parse` | 5 — matching `"xml"` subtype | 6 |
| `parse` | 5 — catch-all clause | 13 |

**Private functions:**

| Name | Arity | Line |
|------|-------|------|
| `decode` | 2 | 17 |

**No defstruct, defexception, or schema defined.**

**use / import / alias at module level:**
```elixir
@behaviour Plug.Parsers   # line 3
import Plug.Conn          # line 4
```

**Plug behaviour implemented:** `parse/5` (both clauses at lines 6 and 13).

---

## Supporting Context Read During Audit

The following additional files were read to fully assess the assigned files:

- `lib/api_server_web/endpoint.ex` — Plug.Parsers configuration and `xml_decoder` option
- `lib/api_server_web/router.ex` — pipeline and route scopes using `:api_xml`
- `lib/api_server/vx/vx_user.ex` — VXUser Ecto schema revealing all user fields
- `mix.exs` — dependency declarations including `elixir_xml_to_map ~> 0.1`
- `mix.lock` — pinned versions
- `config/config.exs` — application-wide configuration including hardcoded secrets

---

## Checklist Review

### §1: Secrets and Configuration

**Finding A143-1 (CRITICAL) — Hardcoded AWS SMTP credentials in config.exs**

`config/config.exs` lines 117–120 contain a live AWS SES SMTP username (IAM Access Key ID) and password in plaintext in a tracked source file:

```elixir
username: "[REDACTED-AWS-KEY-ID]",
password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

A commented-out prior set of credentials also appears on lines 115–116:
```elixir
# username: "[REDACTED-AWS-KEY-ID]",
# password: "[REDACTED-AWS-SMTP-PASSWORD]",
```

Both the active and former credentials are committed to version history. These must be rotated immediately. Credentials must be loaded from environment variables or a secrets manager and must never appear in tracked source files.

**Finding A143-2 (CRITICAL) — Hardcoded secret_key_base in config.exs**

`config/config.exs` line 15:
```elixir
secret_key_base: "djHcKcu+CWBtfoT6k1mLsC1ObkKOy1ZF1G840aRXnQ+oAgAU9efRLUJ+yTd3x/Fh",
```

The Phoenix `secret_key_base` is used to sign session cookies. This value is hardcoded in a tracked file. Any party with repository access can forge session tokens. This key must be regenerated, stored as an environment variable (`System.get_env("SECRET_KEY_BASE")`), and removed from the repository including its git history.

**Finding A143-3 (CRITICAL) — Hardcoded Guardian secret_key in config.exs**

`config/config.exs` line 136:
```elixir
secret_key: "wf1TLkCaEKIPY61A5LvxtPrUA63wrV/hz0RAtaDPh7BENw5WgsCPUN0/qH65BYmA"
```

This is the HMAC secret used to sign all Guardian JWT tokens. Any party with repository access can mint valid JWTs for any user. This key must be rotated immediately, stored as an environment variable, and removed from version history.

**Finding A143-4 (HIGH) — Guardian TTL set to 52 weeks**

`config/config.exs` line 135:
```elixir
ttl: {52, :weeks},
```

JWT tokens are valid for one year with no apparent refresh or revocation mechanism. If a token is compromised, it remains valid for up to 52 weeks. The TTL should be reduced to hours or days, with a refresh token strategy implemented.

**Finding A143-5 (INFO) — Hardcoded AWS SES region reveals infrastructure topology**

`config/config.exs` line 113:
```elixir
server: "email-smtp.us-west-2.amazonaws.com",
```

The AWS region (`us-west-2`) is hardcoded and disclosed in source. This is lower severity but contributes to infrastructure topology exposure per §7.

---

### §2: Authentication and Authorization

**Finding A143-6 (CRITICAL) — Two unauthenticated routes that return fleet/operational data**

`lib/api_server_web/router.ex` lines 30–31 define two routes that are placed **before** `pipe_through([:api, :authenticated])` and therefore receive **no authentication**:

```elixir
get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)
```

These routes sit inside the `scope "/api/v1"` block but outside the authenticated pipeline. Fleet operational data (engine usage, hour meters) is returned with no token verification. This is an IDOR risk — any unauthenticated caller can query these endpoints. Verify whether these routes are intentionally public; if not, move them inside the authenticated pipeline.

**Finding A143-7 (HIGH) — Password stored as plaintext alongside hash**

`lib/api_server/vx/vx_user.ex` line 21–22 shows the schema:
```elixir
field :aacpassword, :string
field :aacpasswordhash, :string
```

The presence of both a plaintext password field (`aacpassword`) and a hash field (`aacpasswordhash`) indicates the database stores or has stored plaintext passwords. The `password_changeset/2` function (line 73–76) casts `:aacpassword` directly with no hashing. The `convert_json_to_changeset/1` function (line 66) also maps `user_json["password"]` directly to `:aacpassword`. This is a CRITICAL risk if `aacpassword` is ever persisted. Password hashing must use bcrypt or argon2 and only the hash must be stored.

**Finding A143-8 (MEDIUM) — Guardian token TTL is 52 weeks with no revocation**

See A143-4. Noted here as an authentication concern — there is no evidence of a token blacklist or revocation store. Compromised tokens remain valid.

---

### §3: Input Validation and Injection

**Finding A143-9 (HIGH) — xml_plug.ex: `decoder` option is accepted but silently ignored; XML is always parsed by XmlToMap regardless of configured decoder**

`lib/api_server_web/xml_plug.ex` lines 6–11:
```elixir
def parse(conn, _, "xml", _headers, opts) do
  decoder = Keyword.get(opts, :xml_decoder) || raise ArgumentError, "XML parser expects a :xml_decoder option"
  conn
  |> read_body(opts)
  |> decode(decoder)
end
```

The `decoder` variable is retrieved from opts and passed to `decode/2`, but `decode/2` at lines 17–26 completely ignores it:

```elixir
defp decode({:ok, body, conn}, decoder) do
    case XmlToMap.naive_map(body) do
        map ->
            {:ok, %{xml: map}, conn}
        _ ->
            raise "Malformed XML"
    end
rescue
  e -> raise Plug.Parsers.ParseError, exception: e
end
```

The `decoder` argument is accepted in the `decode/2` function signature but never used. The actual parsing is always delegated to `XmlToMap.naive_map/1`. The endpoint (`endpoint.ex` line 28) specifies `xml_decoder: :xmerl_scan`, but this option is never applied. This is both a correctness defect and a security concern: the intent to control the XML backend via configuration is silently voided. Any future operator who changes `xml_decoder:` in the endpoint configuration will have no effect.

**Finding A143-10 (MEDIUM) — xml_plug.ex: no maximum body size limit enforced for XML input**

`lib/api_server_web/xml_plug.ex` line 9 calls `read_body(opts)`, which passes through the opts from `Plug.Parsers`. However, no explicit `length:` option is set in the endpoint's `Plug.Parsers` call for the XML parser. Without an explicit body size cap, an attacker could send a very large XML document, consuming memory during `XmlToMap.naive_map/1` parsing (which builds the entire document into an in-memory map). This is a denial-of-service amplification risk for the XML path specifically.

**Finding A143-11 (MEDIUM) — xml_plug.ex: catch-all match arm in `decode/2` is unreachable**

```elixir
case XmlToMap.naive_map(body) do
    map ->
        {:ok, %{xml: map}, conn}
    _ ->
        raise "Malformed XML"
end
```

The `_` arm is unreachable: the first arm `map ->` is an unconditional binding pattern that matches any value. `XmlToMap.naive_map/1` raises on malformed input rather than returning an error tuple, so malformed XML propagates as an uncaught exception. The `rescue` clause catches this and re-raises as `Plug.Parsers.ParseError`, which is correct behaviour. However, the dead `_ -> raise "Malformed XML"` arm is misleading and indicates the error handling logic was not reviewed carefully.

**§3 (SQL injection / atom creation / unsafe deserialization):** No issues found in the two assigned files. The view constructs a fixed-key map with no dynamic atom creation. The XML plug reads a binary body and passes it to a library; no `String.to_atom/1`, `binary_to_term/1`, or `Code.eval_string/1` calls are present in either assigned file.

---

### §4: Session and CSRF

**Finding A143-12 (HIGH) — Session cookie has no `secure`, `httponly`, or `samesite` flags configured**

`lib/api_server_web/endpoint.ex` lines 36–40:
```elixir
plug Plug.Session,
  store: :cookie,
  key: "_api_server_key",
  signing_salt: "5CSDVUtC"
```

No `secure: true`, `http_only: true`, or `same_site: "Strict"` options are set. The signing salt (`"5CSDVUtC"`) is short (8 bytes) and hardcoded. Without `secure: true`, session cookies can be sent over HTTP. Without `http_only: true`, they are accessible to JavaScript. This is noted here as contextual evidence read during review of the assigned files; the endpoint is not an assigned file but directly governs the security posture of all plug-handled requests.

**Finding A143-13 (MEDIUM) — CORSPlug applied globally with no origin restriction visible in config**

`lib/api_server_web/endpoint.ex` line 42:
```elixir
plug CORSPlug
```

`CORSPlug` is applied without any explicit `origin:` restriction at the endpoint level. The router has a commented-out `# plug CORSPlug, origin: "*"` in two pipelines (lines 13, 19). Without reviewing the `cors_plug` default configuration, the effective CORS policy defaults to `*` (allow all origins). For an authenticated API, this allows cross-origin requests from any domain. This was observed in supporting context during audit of the assigned files.

Note: Findings A143-12 and A143-13 are recorded here for completeness because they were observed in direct supporting context; the endpoint file itself is not an assigned file for this audit pass.

---

### §5: File and Data Handling

**§5 (vx_user_view.ex — sensitive field exposure check):**

The `render("rhm_user.json", ...)` function at lines 17–56 constructs the following map for API responses:

```elixir
user = %{
  id: user.aacid,
  customer_code: user.aaccustcode,
  first_name: user.aacfname,
  last_name: user.aacsurname,
  email: user.aacemail,
  offset: user.aactimezone,
  timezone: user.aactimezone,
  lang: user.aaclang,
  units: user.aacuom,
  default_dashboard: user.aacdash,
  date_format: user.aacdateformat,
  user_level: user_level
}
```

This explicit allowlist does **not** include `aacpassword`, `aacpasswordhash`, or `[REDACTED-AWS-SMTP-PASSWORD]`. The response shape is constructed by explicit key selection, not by serialising the whole struct. Password fields are not directly leaked by the view.

However, there is a conditional JWT inclusion at lines 18–23:
```elixir
jwt_component = cond do
  Map.has_key?(user, :jwt) ->
    %{jwt: user.jwt}
  true ->
    %{}
end
```

The JWT is included in the response when it is present on the user map. This is expected for the login flow (a JWT is issued and returned to the caller). This is standard practice and not a vulnerability in isolation, but it means the JWT secret exposure (A143-3) has direct downstream impact: an attacker who knows the secret can produce tokens that will be accepted by the API.

**Finding A143-14 (INFO) — `aacpassword` plaintext field exists on VXUser struct and is in scope in the view**

The VXUser schema (observed during review) contains `aacpassword` as a field. The view does not render it. However, the plaintext password field's mere existence in the database schema is a significant concern (see A143-7). If the view were modified carelessly (e.g., by using `Map.from_struct/1` or `Jason.encode!/1` on the raw struct), the plaintext password would be exposed in API responses. The explicit allowlist in the view is the only guard.

**§5 (xml_plug.ex — PII/data disclosure):** No Logger calls are present in `xml_plug.ex`. The module raises exceptions on parse errors but does not echo user-supplied XML back in error messages.

---

### §6: Dependencies

**Finding A143-15 (HIGH) — mariaex 0.8.4 is deprecated and has no security support**

`mix.lock` line 37:
```
"mariaex": {:hex, :mariaex, "0.8.4", ...}
```

`mix.exs` line 39 specifies `{:mariaex, "~>0.8.2"}`. The PASS1 checklist explicitly flags mariaex 0.8.2 as deprecated with no security support. The locked version 0.8.4 is in the same deprecated 0.8.x series. This library should be replaced with `myxql`, the current Elixir MySQL/MariaDB adapter, which is maintained and receives security updates.

**Finding A143-16 (MEDIUM) — elixir_xml_to_map pinned to 0.2.0, which is many major versions behind current (3.x)**

`mix.lock` line 21:
```
"elixir_xml_to_map": {:hex, :elixir_xml_to_map, "0.2.0", ...}
```

`mix.exs` line 52 specifies `{:elixir_xml_to_map, "~> 0.1"}`. The library is now at version 3.x. The 0.x series predates significant maintenance work. This should be updated to a current supported version.

**Finding A143-17 (MEDIUM) — Multiple dependencies are significantly out of date**

The following locked versions are substantially older than current releases, increasing the risk of unpatched vulnerabilities:

| Dependency | Locked Version | Current series | Note |
|---|---|---|------|
| `phoenix` | 1.5.13 | 1.7.x | Multiple security and bug fixes |
| `guardian` | 1.2.1 | 2.x | Major version behind |
| `ecto` | 2.2.12 | 3.x | Major version behind |
| `cowboy` | 1.1.2 | 2.x | Major version behind |
| `plug` | 1.13.6 | 1.16.x | Several patch updates |
| `httpoison` | 1.6.2 | 2.x | Major version behind |

**Finding A143-18 (INFO) — geonames dependency loaded from a local path, not hex.pm**

`mix.exs` line 56:
```elixir
{:geonames, path: "geonames-elixir"},
```

This dependency is loaded from a local filesystem path. It is not fetched from hex.pm and is not covered by `mix.lock` in the standard way. This makes it impossible to audit its provenance or verify its contents against a known hash. The contents of `geonames-elixir/` should be reviewed separately.

---

### §7: Infrastructure Exposure

**Finding A143-19 (MEDIUM) — AWS region and service endpoint hardcoded in config.exs**

`config/config.exs` line 113:
```elixir
server: "email-smtp.us-west-2.amazonaws.com",
```

The AWS region `us-west-2` is disclosed in source. See also A143-1 and A143-5.

**§7 (CORS, CSP, TLS, check_origin):** These are configured in the endpoint file, which is not an assigned file. Findings A143-12 and A143-13 are noted above from supporting context. No TLS termination configuration was observed in the assigned files.

---

## Summary of Findings

| ID | Severity | File | Description |
|----|----------|------|-------------|
| A143-1 | CRITICAL | `config/config.exs` | Hardcoded AWS SMTP credentials (live + former) in tracked file |
| A143-2 | CRITICAL | `config/config.exs` | Hardcoded `secret_key_base` in tracked file |
| A143-3 | CRITICAL | `config/config.exs` | Hardcoded Guardian JWT signing secret in tracked file |
| A143-4 | HIGH | `config/config.exs` | Guardian TTL set to 52 weeks — tokens valid for one year |
| A143-5 | INFO | `config/config.exs` | AWS region hardcoded, reveals infrastructure topology |
| A143-6 | CRITICAL | `router.ex` | Two routes serving fleet data with no authentication guard |
| A143-7 | HIGH | `vx/vx_user.ex` | Plaintext password field `aacpassword` in schema; no hashing in changeset |
| A143-8 | MEDIUM | `config/config.exs` | No JWT revocation mechanism; 52-week TTL compounds risk |
| A143-9 | HIGH | `xml_plug.ex` | `xml_decoder` option accepted but silently ignored; declared intent not honoured |
| A143-10 | MEDIUM | `xml_plug.ex` | No explicit XML body size cap; DoS amplification risk |
| A143-11 | MEDIUM | `xml_plug.ex` | Unreachable dead code arm in `decode/2`; error handling logic unclear |
| A143-12 | HIGH | `endpoint.ex` | Session cookie missing `secure`, `http_only`, `same_site` flags |
| A143-13 | MEDIUM | `endpoint.ex` | CORSPlug applied globally with no visible origin restriction |
| A143-14 | INFO | `vx_user_view.ex` | Plaintext password field in scope; allowlist is the only guard against accidental exposure |
| A143-15 | HIGH | `mix.lock` / `mix.exs` | mariaex 0.8.4 is deprecated, no security support |
| A143-16 | MEDIUM | `mix.lock` / `mix.exs` | elixir_xml_to_map 0.2.0 is many major versions behind (now 3.x) |
| A143-17 | MEDIUM | `mix.lock` / `mix.exs` | Multiple core dependencies significantly out of date |
| A143-18 | INFO | `mix.exs` | geonames loaded from local path, not hex.pm; provenance unverifiable |
| A143-19 | MEDIUM | `config/config.exs` | AWS region and SES endpoint hardcoded |

---

## XXE Assessment for xml_plug.ex

Per the specific instruction to assess XML injection and XXE in `xml_plug.ex`:

`XmlToMap.naive_map/1` (version 0.2.0, backed by erlsom 1.5.0) uses `erlsom:simple_form/1` internally. Erlsom does **not** resolve external entities; it is not a wrapper around xmerl. Based on published research ([vuln.be XXE in Erlang and Elixir](https://vuln.be/post/xxe-in-erlang-and-elixir/)) and erlsom's design, the XML parsing path through `XmlToMap.naive_map/1` is **not vulnerable to XXE** as erlsom does not expand external entity references.

However, two caveats apply:

1. The endpoint configuration (`endpoint.ex` line 28) specifies `xml_decoder: :xmerl_scan`. The `xmerl` library **is** vulnerable to XXE by default in older Erlang/OTP versions (the `allow_entities` default was only changed to `false` in a recent OTP release — [erlang/otp issue #7539](https://github.com/erlang/otp/issues/7539)). The xml_plug currently ignores this option entirely (finding A143-9), so xmerl is never actually invoked. However, if the `decode/2` function were ever corrected to honour the `decoder` option and pass through to `:xmerl_scan`, an XXE vulnerability would be introduced unless xmerl's entity expansion is explicitly disabled.

2. `XmlToMap.naive_map/1` is "naive" by design — it does not preserve XML namespaces or handle all XML constructs. Malformed or deeply nested XML could cause unexpected map structures that downstream code may handle incorrectly. No specific injection vector was identified in the assigned file.

**XXE conclusion:** The current code path is not directly exploitable for XXE. The risk of inadvertent XXE introduction upon any fix of finding A143-9 must be explicitly managed.

---

*Report by agent A143. No source files were modified. All findings are observations only.*

<!-- A147.md -->
# Security Audit Report — A147
**Agent:** A147
**Audit Run:** 2026-02-27-01
**Repo:** api_server
**Stack:** Elixir/Phoenix
**Branch:** master
**Date:** 2026-02-27

---

## Assigned Files

1. `priv/repo/migrations/20180829062447_create_files.exs`
2. `priv/repo/migrations/20180829154449_create_vxusers.exs`
3. `priv/repo/migrations/20180829154621_create_vxaccessfobs.exs`
4. `priv/repo/migrations/20180829154748_create_vxfleets.exs`
5. `priv/repo/migrations/20180829154831_create_vxfleetassociationss.exs`
6. `priv/repo/migrations/20180829155630_create_vxthings.exs`
7. `priv/repo/migrations/20180905123954_create_vxthingsummaries.exs`
8. `priv/repo/migrations/20180911054724_create_vxthingevents.exs`
9. `priv/repo/migrations/20181101052321_create_vxablrecords.exs`
10. `priv/repo/migrations/20190301032407_create_vxabhrental.exs`
11. `priv/repo/migrations/20190305003212_create_aaa_customers.exs`
12. `priv/repo/migrations/20190326223729_create_vxaatuserfunctions.exs`
13. `priv/repo/migrations/20190328050930_create_vxaau_rest.exs`
14. `priv/repo/seeds.exs`

---

## Reading Evidence

---

### File 1: `priv/repo/migrations/20180829062447_create_files.exs`

- **Migration timestamp:** 20180829062447
- **Module:** `ApiServer.Repo.Migrations.CreateFiles`
- **Table created:** `files`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `esn` — `:string`, no NOT NULL constraint, no unique index
  - `custcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 2: `priv/repo/migrations/20180829154449_create_vxusers.exs`

- **Migration timestamp:** 20180829154449
- **Module:** `ApiServer.Repo.Migrations.CreateVxusers`
- **Table created:** `vxusers`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aaccustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 3: `priv/repo/migrations/20180829154621_create_vxaccessfobs.exs`

- **Migration timestamp:** 20180829154621
- **Module:** `ApiServer.Repo.Migrations.CreateVxaccessfobs`
- **Table created:** `vxaccessfobs`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `fob_code` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 4: `priv/repo/migrations/20180829154748_create_vxfleets.exs`

- **Migration timestamp:** 20180829154748
- **Module:** `ApiServer.Repo.Migrations.CreateVxfleets`
- **Table created:** `vxfleets`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aaecustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 5: `priv/repo/migrations/20180829154831_create_vxfleetassociationss.exs`

- **Migration timestamp:** 20180829154831
- **Module:** `ApiServer.Repo.Migrations.CreateVxfleetassociationss`
- **Table created:** `[REDACTED-AWS-SMTP-PASSWORD]`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aafcustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **Note:** Table name contains a double-s suffix (`[REDACTED-AWS-SMTP-PASSWORD]`) — likely a typo in the original migration.
- **use/import/alias:** `use Ecto.Migration`

---

### File 6: `priv/repo/migrations/20180829155630_create_vxthings.exs`

- **Migration timestamp:** 20180829155630
- **Module:** `ApiServer.Repo.Migrations.CreateVxthings`
- **Table created:** `vxthings`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aadcustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 7: `priv/repo/migrations/20180905123954_create_vxthingsummaries.exs`

- **Migration timestamp:** 20180905123954
- **Module:** `ApiServer.Repo.Migrations.CreateVxthingsummaries`
- **Table created:** `vxthingsummaries`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `ambcustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 8: `priv/repo/migrations/20180911054724_create_vxthingevents.exs`

- **Migration timestamp:** 20180911054724
- **Module:** `ApiServer.Repo.Migrations.CreateVxthingevents`
- **Table created:** `vxthingevents`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `hardwareid` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 9: `priv/repo/migrations/20181101052321_create_vxablrecords.exs`

- **Migration timestamp:** 20181101052321
- **Module:** `ApiServer.Repo.Migrations.CreateVxablrecords`
- **Table created:** `vxablrecords`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `ablcustcode` — `:string`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 10: `priv/repo/migrations/20190301032407_create_vxabhrental.exs`

- **Migration timestamp:** 20190301032407
- **Module:** `ApiServer.Repo.Migrations.CreateVxabhrental`
- **Table created:** `vxabhrental`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `abhid` — `:integer`, no NOT NULL constraint, no unique index
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 11: `priv/repo/migrations/20190305003212_create_aaa_customers.exs`

- **Migration timestamp:** 20190305003212
- **Module:** `ApiServer.Repo.Migrations.CreateAaaCustomers`
- **Table created:** `aaa_customers`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aaaid` — `:integer`, no NOT NULL constraint, no unique index
  - `aaacustcode` — `:string`, no NOT NULL constraint, no unique index
  - `aaaname` — `:string`, no NOT NULL constraint
  - `aaaaddr1` — `:string`, no NOT NULL constraint
  - `aaaaddr2` — `:string`, no NOT NULL constraint
  - `aaaaddr3` — `:string`, no NOT NULL constraint
  - `aaapcode` — `:string`, no NOT NULL constraint (postal code)
  - `aaaprimcont` — `:string`, no NOT NULL constraint (primary contact name)
  - `aaaprimtel` — `:string`, no NOT NULL constraint (primary telephone)
  - `aaaprimemail` — `:string`, no NOT NULL constraint (primary email)
  - `aaatz` — `:string`, no NOT NULL constraint (timezone)
  - `aaaudfcustcode` — `:string`, no NOT NULL constraint
  - `aaacolour` — `:string`, no NOT NULL constraint
- **Timestamps:** None — `timestamps()` is NOT called in this migration.
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 12: `priv/repo/migrations/20190326223729_create_vxaatuserfunctions.exs`

- **Migration timestamp:** 20190326223729
- **Module:** `ApiServer.Repo.Migrations.CreateVxaatuserfunctions`
- **Table created:** `vxaatuserfunctions`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aatid` — `:integer`, no NOT NULL constraint, no unique index
  - `aatuser_id` — `:integer`, no NOT NULL constraint, no foreign key constraint
  - `aatfunctionid` — `:integer`, no NOT NULL constraint
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 13: `priv/repo/migrations/20190328050930_create_vxaau_rest.exs`

- **Migration timestamp:** 20190328050930
- **Module:** `ApiServer.Repo.Migrations.CreateVxaauRest`
- **Table created:** `vxaau_rest`
- **Columns defined:**
  - `id` — integer, primary key (implicit Ecto default)
  - `aauid` — `:integer`, no NOT NULL constraint, no unique index
  - `aauuser_id` — `:integer`, no NOT NULL constraint, no foreign key constraint
  - `aaucustcode` — `:string`, no NOT NULL constraint
  - `aaufun` — `:string`, no NOT NULL constraint (function/permission label)
  - `aaucharval` — `:string`, no NOT NULL constraint (character value parameter)
  - `aaunumval` — `:integer`, no NOT NULL constraint (numeric value parameter)
  - `inserted_at` — via `timestamps()`
  - `updated_at` — via `timestamps()`
- **Indexes created:** None
- **use/import/alias:** `use Ecto.Migration`

---

### File 14: `priv/repo/seeds.exs`

- **Content:** Boilerplate Phoenix seeds file only. Contains only comments — no executable code, no data insertion, no credentials, no test users.

---

## Checklist Review

### §1: Secrets and Configuration

No config files, `.gitignore`, `bitbucket-pipelines.yml`, or AWS configuration files are in scope for this batch. The `seeds.exs` file contains no hardcoded credentials, API keys, database passwords, or test user data — it is entirely comment-only.

§1: No issues found in assigned files.

---

### §2: Authentication and Authorization

No Guardian configuration, no password hashing, no token columns, and no authentication logic appear in any of these migration files. The `vxusers` table (`20180829154449`) stores only a single `aaccustcode` string column — it contains no `password`, `password_hash`, `token`, `secret`, or `pin` columns. The `vxaatuserfunctions` and `vxaau_rest` tables implement what appears to be a permission/function-association scheme; neither table has any foreign key constraints or indexes referencing a users table, creating a referential integrity gap at the database level.

See findings A147-3 and A147-4 below.

---

### §3: Input Validation and Injection

No Ecto query fragments, raw SQL, `String.to_atom/1`, or deserialization logic appear in migration files. Migration files are DDL-only.

§3: No issues found in assigned files.

---

### §4: Session and CSRF

Not applicable to migration or seeds files.

§4: No issues found in assigned files.

---

### §5: File and Data Handling

The `aaa_customers` table stores PII: primary contact name (`aaaprimcont`), telephone number (`aaaprimtel`), and email address (`aaaprimemail`), as well as postal address fields (`aaaaddr1`, `aaaaddr2`, `aaaaddr3`, `aaapcode`). No row-level security, encryption-at-rest markers, or audit timestamps are present on this table. This does not in itself constitute a code vulnerability but flags a data-governance concern relevant to §5.

See finding A147-5 below.

---

### §6: Dependencies

Not applicable to migration or seeds files.

§6: No issues found in assigned files.

---

### §7: Infrastructure Exposure

No hardcoded hostnames, IPs, CORS configuration, or TLS settings appear in migration or seeds files.

§7: No issues found in assigned files.

---

## Findings

---

### A147-1 — MEDIUM — Missing NOT NULL Constraints on Business-Critical Identifier Columns (Multiple Tables)

**Affected files:**
- `priv/repo/migrations/20180829062447_create_files.exs` — columns `esn`, `custcode`
- `priv/repo/migrations/20180829154449_create_vxusers.exs` — column `aaccustcode`
- `priv/repo/migrations/20180829154621_create_vxaccessfobs.exs` — column `fob_code`
- `priv/repo/migrations/20180829154748_create_vxfleets.exs` — column `aaecustcode`
- `priv/repo/migrations/20180829154831_create_vxfleetassociationss.exs` — column `aafcustcode`
- `priv/repo/migrations/20180829155630_create_vxthings.exs` — column `aadcustcode`
- `priv/repo/migrations/20180905123954_create_vxthingsummaries.exs` — column `ambcustcode`
- `priv/repo/migrations/20180911054724_create_vxthingevents.exs` — column `hardwareid`
- `priv/repo/migrations/20181101052321_create_vxablrecords.exs` — column `ablcustcode`
- `priv/repo/migrations/20190301032407_create_vxabhrental.exs` — column `abhid`
- `priv/repo/migrations/20190305003212_create_aaa_customers.exs` — all columns
- `priv/repo/migrations/20190326223729_create_vxaatuserfunctions.exs` — columns `aatid`, `aatuser_id`, `aatfunctionid`
- `priv/repo/migrations/20190328050930_create_vxaau_rest.exs` — columns `aauid`, `aauuser_id`, `aaucustcode`, `aaufun`, `aaucharval`, `aaunumval`

**Description:**
Every column across all 13 migration files is defined without a `null: false` constraint. In Ecto migrations, columns default to nullable unless `null: false` is explicitly set. For identifier and foreign-key columns such as `aaccustcode`, `fob_code`, `aatuser_id`, `aauuser_id`, and `aaucustcode`, a NULL value is logically meaningless and could allow orphaned or unscoped records to exist in the database. This is especially significant for the customer-code columns that appear to be the primary multi-tenancy scoping mechanism across all fleet tables — a NULL `custcode` row would be invisible to any per-customer query filter, potentially leaking into cross-customer result sets depending on application query construction.

**Recommendation:**
Add `null: false` to all business-critical columns via corrective migrations. At minimum, enforce NOT NULL on every column used for customer scoping (`*custcode`), user references (`*user_id`), and hardware identifiers (`esn`, `hardwareid`, `fob_code`).

---

### A147-2 — MEDIUM — Missing Unique Indexes on Customer-Code Identifier Columns and Access-Fob Code

**Affected files:**
- `priv/repo/migrations/20180829062447_create_files.exs` — `esn` (Electronic Serial Number — device identifier, expected unique)
- `priv/repo/migrations/20180829154621_create_vxaccessfobs.exs` — `fob_code` (access fob credential — expected unique)
- `priv/repo/migrations/20190305003212_create_aaa_customers.exs` — `aaacustcode`, `aaaid` (customer code and upstream system ID — both expected unique)

**Description:**
No indexes of any kind are present across all 13 migrations. The `fob_code` column in `vxaccessfobs` is a physical access credential (an RFID/NFC fob identifier). Without a unique index, the database permits multiple records with the same `fob_code`, which could allow a duplicate fob entry to be inserted and subsequently matched during access-control lookups, depending on application logic. The `esn` column represents a device Electronic Serial Number, which is a hardware identifier that should be unique per device. The `aaacustcode` and `aaaid` columns in `aaa_customers` represent customer identifiers synced from an upstream system; duplicates would corrupt multi-tenancy data isolation.

**Recommendation:**
Create unique indexes on `fob_code` (`vxaccessfobs`), `esn` (`files`), and both `aaacustcode` and `aaaid` (`aaa_customers`). For all other `*custcode` columns used as foreign references, create non-unique indexes to support query performance.

---

### A147-3 — MEDIUM — No Foreign Key Constraints on User-Reference Columns in Permission Tables

**Affected files:**
- `priv/repo/migrations/20190326223729_create_vxaatuserfunctions.exs` — column `aatuser_id`
- `priv/repo/migrations/20190328050930_create_vxaau_rest.exs` — column `aauuser_id`

**Description:**
The `vxaatuserfunctions` and `vxaau_rest` tables store per-user permission and function associations. Both contain `*user_id` integer columns that clearly reference a users entity, but no `references/2` foreign key constraint is declared. Without a foreign key constraint, permission records can remain in the table after the associated user is deleted or the user ID becomes invalid. Stale permission records could potentially be exploited if a new user is assigned a recycled ID that inherits the old user's permissions. Additionally, the absence of constraints means the application cannot rely on the database to enforce referential integrity, pushing all integrity responsibility onto application-layer code.

**Recommendation:**
Replace the bare `:integer` type for `aatuser_id` and `aauuser_id` with `references(:vxusers, on_delete: :delete_all)` (or equivalent) in corrective migrations to enforce referential integrity at the database level.

---

### A147-4 — LOW — `aaa_customers` Table Has No `timestamps()` — Audit Trail Gap

**Affected file:**
- `priv/repo/migrations/20190305003212_create_aaa_customers.exs`

**Description:**
The `aaa_customers` table is the only table in this migration batch that omits the `timestamps()` call. All other tables include `inserted_at` and `updated_at` columns. For a table that stores customer PII (contact name, telephone, email, address), the absence of `inserted_at`/`updated_at` means there is no database-level record of when a customer record was created or last modified. This impairs incident response, audit logging, and data-subject access request fulfillment under privacy regulations.

**Recommendation:**
Add a corrective migration to add `inserted_at` and `updated_at` columns to the `aaa_customers` table.

---

### A147-5 — LOW — PII Stored in `aaa_customers` With No Encryption Markers or Row-Level Access Controls at Schema Level

**Affected file:**
- `priv/repo/migrations/20190305003212_create_aaa_customers.exs`

**Description:**
The `aaa_customers` table stores the following PII fields in plain `:string` columns with no encryption, column-level access restriction, or masking defined at the schema level:
- `aaaprimcont` — primary contact name
- `aaaprimtel` — primary telephone number
- `aaaprimemail` — primary email address
- `aaaaddr1`, `aaaaddr2`, `aaaaddr3`, `aaapcode` — postal address

This is a data-governance observation: at the migration level, there is no mechanism preventing these values from being exposed in logs, debug outputs, or error messages. Combined with the absence of `timestamps()` (A147-4) and lack of NOT NULL or unique constraints on `aaaprimemail` (A147-1), there is no database-enforced uniqueness on the email address, which could allow duplicate customer records or complicate account-recovery flows.

**Recommendation:**
Confirm that application-layer controls (Ecto schemas, serializers, logger filters) prevent PII from leaking into logs or API error responses. Consider adding a unique index on `aaaprimemail`. Assess whether column-level encryption is appropriate for contact and address fields under applicable data-protection obligations.

---

### A147-6 — INFO — Table Name Typo: `[REDACTED-AWS-SMTP-PASSWORD]` (Double-s)

**Affected file:**
- `priv/repo/migrations/20180829154831_create_vxfleetassociationss.exs`

**Description:**
The table name `[REDACTED-AWS-SMTP-PASSWORD]` contains a trailing double-s, which is inconsistent with the naming convention of all other tables in this batch and is almost certainly a typographical error in the original migration. While this is not a security vulnerability, it is documented here as an INFO-level finding because: (a) the typo is now baked into the database schema and any correction requires a rename migration coordinated with application code; (b) it may cause confusion during future schema reviews or when auditing query scoping logic.

**Recommendation:**
Verify whether downstream code intentionally uses `[REDACTED-AWS-SMTP-PASSWORD]` or whether application code also contains the typo. If a rename is warranted, coordinate a migration with the application-layer schema module.

---

### A147-7 — INFO — seeds.exs Is Effectively Empty

**Affected file:**
- `priv/repo/seeds.exs`

**Description:**
The seeds file contains only the Phoenix-generated boilerplate comments and no executable code. This is not a security concern — it is preferable to an empty seeds file that inserts test credentials. Documented as INFO for completeness.

§: No action required.

---

## Summary Table

| ID      | Severity | File(s)                                                      | Issue                                                                 |
|---------|----------|--------------------------------------------------------------|-----------------------------------------------------------------------|
| A147-1  | MEDIUM   | All 13 migration files                                       | No NOT NULL constraints on any column                                 |
| A147-2  | MEDIUM   | create_files, create_vxaccessfobs, create_aaa_customers      | Missing unique indexes on fob_code, esn, aaacustcode, aaaid           |
| A147-3  | MEDIUM   | create_vxaatuserfunctions, create_vxaau_rest                 | No foreign key constraints on user_id reference columns               |
| A147-4  | LOW      | create_aaa_customers                                         | No timestamps() — PII table has no insert/update audit trail          |
| A147-5  | LOW      | create_aaa_customers                                         | PII stored in plain string columns with no encryption or uniqueness   |
| A147-6  | INFO     | create_vxfleetassociationss                                  | Table name typo (double-s suffix)                                     |
| A147-7  | INFO     | seeds.exs                                                    | Seeds file is empty (no action required)                              |

---

*End of report A147 — pass1 — 2026-02-27-01*


---

## Pass 2 — Test Coverage

<!-- B001.md -->
# Audit Report B001 — Pass 2
**Audit run:** 2026-02-27-01
**Agent:** B001
**Date:** 2026-02-27
**Scope:** Infrastructure / bootstrap source files

---

## Assigned Source Files

1. `lib/api_server.ex`
2. `lib/api_server/application.ex`
3. `lib/api_server/guardian.ex`
4. `lib/api_server/repo.ex`

---

## File 1 — `lib/api_server.ex`

### READING EVIDENCE

**Module:** `ApiServer`

**Functions / macros / callbacks defined:**
- None. The module body contains only a `@moduledoc` string (lines 1–9).

**Types / structs / constants:** None.

**Test file:** None (no `test/api_server_test.exs`).

**Indirect test coverage search:**
- Grep for `ApiServer` (bare module name) in `test/` returns only support infrastructure references (`ApiServer.Repo`, `ApiServer.DataCase`, etc.). No test references the `ApiServer` module itself.

### Findings

#### B001-1 — HIGH: `ApiServer` module has no test file and no indirect coverage

**Severity:** HIGH
**File:** `lib/api_server.ex`
**Lines:** 1–9

The top-level `ApiServer` module has no dedicated test file and is never referenced by any test. Although the module currently contains no functions (only a `@moduledoc`), it is the canonical namespace root for the application. Any future functions added here will inherit zero test coverage with no existing test scaffold.

**Recommendation:** Create `test/api_server_test.exs` as a baseline scaffold even if it contains only a module existence smoke test.

---

## File 2 — `lib/api_server/application.ex`

### READING EVIDENCE

**Module:** `ApiServer.Application`

**Functions / macros / callbacks defined:**

| Line | Visibility | Name / Arity | Description |
|------|------------|--------------|-------------|
| 6 | public (OTP callback) | `start/2` | Builds child spec list, starts `Supervisor.start_link/2` under strategy `:one_for_one` |
| 36 | public (OTP callback) | `config_change/3` | Delegates to `ApiServerWeb.Endpoint.config_change/2`, returns `:ok` |

**Child processes started in `start/2`:**
- `ApiServer.FortyNineRepo` (supervisor)
- `ApiServer.Repo` (supervisor)
- `ApiServerWeb.Endpoint` (supervisor)
- `ApiServer.Scheduler` (Quantum cron)
- `ApiServer.TCP.TaskSupervisor` (`Task.Supervisor`)
- Anonymous `Task` wrapping `ApiServer.TCP.accept(tcp_port)` with `restart: :permanent`
- `ConCache` named `:geocode_store`, `ttl_check_interval: false`

**Environment variable read:** `TCP_PORT` (line 9) — defaults to `"4001"` if absent.

**Supervision strategy:** `:one_for_one` (line 30).

**Types / structs / constants:** None.

**Test file:** None (no `test/api_server/application_test.exs`).

**Indirect test coverage search:**
- Grep for `ApiServer.Application`, `config_change`, `TCP_PORT` in `test/` returns zero matches.
- The application starts automatically in the test environment (standard Mix behaviour), so `start/2` is exercised at a process level — but no assertion is made about its behaviour, child count, or failure modes.

### Findings

#### B001-2 — HIGH: `ApiServer.Application` has no test file and no indirect coverage

**Severity:** HIGH
**File:** `lib/api_server/application.ex`
**Lines:** 1–40

Neither `start/2` nor `config_change/3` is exercised by any test. The supervisor tree starts as a side-effect of `ExUnit.start()`, but no test asserts on the resulting process topology, child registration, or restart behaviour.

**Recommendation:** Add `test/api_server/application_test.exs` with at minimum a smoke test that the named supervisor is alive and that required child processes are registered.

#### B001-3 — MEDIUM: `config_change/3` is completely untested

**Severity:** MEDIUM
**File:** `lib/api_server/application.ex`
**Lines:** 36–39

`config_change/3` delegates to `ApiServerWeb.Endpoint.config_change/2`. No test calls this callback, so any regression (e.g. accidentally reversing the argument order — `changed` vs `removed` are passed positionally) would go undetected.

**Recommendation:** Add a test that calls `ApiServer.Application.config_change(%{}, %{}, [])` and asserts `:ok` is returned.

#### B001-4 — MEDIUM: `TCP_PORT` environment variable — missing/invalid value path untested

**Severity:** MEDIUM
**File:** `lib/api_server/application.ex`
**Line:** 9

```elixir
tcp_port = String.to_integer(System.get_env("TCP_PORT") || "4001")
```

`String.to_integer/1` raises `ArgumentError` if `TCP_PORT` is set to a non-integer string (e.g. `"abc"` or `""`). There is no test verifying the default fallback path or the error path when the variable is malformed.

**Recommendation:** Add tests covering: (a) `TCP_PORT` unset (default `4001`), (b) `TCP_PORT` set to a valid integer string, (c) `TCP_PORT` set to an invalid string (expected to raise or be caught).

#### B001-5 — LOW: Supervisor child list — no test for partial startup failure

**Severity:** LOW
**File:** `lib/api_server/application.ex`
**Lines:** 12–26

The supervisor uses `:one_for_one`. If any child (e.g. `ApiServer.TCP.accept/1` TCP listener or `ConCache`) fails to start, the supervisor will attempt restarts but the overall system may silently degrade. No test validates behaviour when any individual child fails to initialise (e.g. when the TCP port is in use or `DATABASE_URL` is absent).

**Recommendation:** Add integration or unit tests mocking child startup failures to verify the supervisor tree handles restarts correctly.

#### B001-6 — LOW: Deprecated `Supervisor.Spec` import used

**Severity:** LOW
**File:** `lib/api_server/application.ex`
**Line:** 7

```elixir
import Supervisor.Spec
```

`Supervisor.Spec` was deprecated in Elixir 1.5. The `supervisor/2` helper (lines 14–17) is a deprecated API. While not a testing gap per se, there are no tests that would catch a future Elixir version removing these functions.

**Recommendation:** Migrate to the child spec map format (`%{id: ..., start: ..., type: :supervisor}`) and add a test confirming child specs are valid.

---

## File 3 — `lib/api_server/guardian.ex`

### READING EVIDENCE

**Module:** `ApiServer.Guardian`

Uses: `Guardian` (via `use Guardian, otp_app: :api_server`)
Alias: `ApiServer.Vx`

**Functions / macros / callbacks defined:**

| Line | Visibility | Name / Arity | Description |
|------|------------|--------------|-------------|
| 6–13 | public (Guardian callback) | `subject_for_token/2` — clause 1 | Guards `user == nil`; returns `{:error, :reason_for_error}` if nil; otherwise returns `{:ok, to_string(user.aacid)}` |
| 14–16 | public (Guardian callback) | `subject_for_token/2` — clause 2 | Catch-all; returns `{:error, :reason_for_error}` |
| 18–23 | public (Guardian callback) | `resource_from_claims/1` — clause 1 | Extracts `"sub"` and `"customer"` from claims, calls `Vx.get_vx_user!(id, customer)`, returns `{:ok, user}` |
| 24–26 | public (Guardian callback) | `resource_from_claims/1` — clause 2 | Catch-all; returns `{:error, :reason_for_error}` |

**Types / structs / constants:** None.

**Test file:** None (no `test/api_server/guardian_test.exs`).

**Indirect test coverage search:**
- Grep for `ApiServer.Guardian`, `subject_for_token`, `resource_from_claims` in `test/` returns zero matches.
- The existing controller tests (`vx_restriction_controller_test.exs`) do not set a Bearer token, meaning the Guardian pipeline is exercised without authentication — the `LoadResource` plug is invoked but returns `nil` resource. The callbacks themselves (`subject_for_token/2`, `resource_from_claims/1`) are never directly exercised.

### Findings

#### B001-7 — HIGH: `ApiServer.Guardian` has no test file and no indirect test coverage

**Severity:** HIGH
**File:** `lib/api_server/guardian.ex`
**Lines:** 1–27

The Guardian callbacks `subject_for_token/2` and `resource_from_claims/1` are the authentication foundation for the entire API (used in every authenticated controller action). Neither function is exercised by any test in the suite.

**Recommendation:** Create `test/api_server/guardian_test.exs` covering all clauses of both callbacks.

#### B001-8 — MEDIUM: `subject_for_token/2` — nil user path untested

**Severity:** MEDIUM
**File:** `lib/api_server/guardian.ex`
**Lines:** 6–13

```elixir
def subject_for_token(user, _claims) do
  if user == nil do
    {:error, :reason_for_error}
  else
    user_id = to_string(user.aacid)
    {:ok, user_id}
  end
end
```

The nil-user branch (line 7–8) is never tested. A token should not be creatable for a nil user, but there is no assertion verifying this contract.

**Recommendation:** Add a test: `assert {:error, :reason_for_error} = ApiServer.Guardian.subject_for_token(nil, %{})`.

#### B001-9 — MEDIUM: `subject_for_token/2` — catch-all clause 2 untested

**Severity:** MEDIUM
**File:** `lib/api_server/guardian.ex`
**Lines:** 14–16

```elixir
def subject_for_token(_, _) do
  {:error, :reason_for_error}
end
```

The catch-all second clause is never tested. It is unreachable when the first clause already matches all inputs (including nil), making the second clause dead code — a latent defect. No test exposes this.

**Recommendation:** Investigate whether clause 2 is actually reachable. If not, it should be removed; if so, add a test exercising it.

#### B001-10 — MEDIUM: `resource_from_claims/1` — missing `"sub"` key path untested

**Severity:** MEDIUM
**File:** `lib/api_server/guardian.ex`
**Lines:** 18–23**

```elixir
def resource_from_claims(claims) do
  id = claims["sub"]
  customer = claims["customer"]
  user = Vx.get_vx_user!(id, customer)
  {:ok, user}
end
```

If `claims["sub"]` or `claims["customer"]` is `nil` or absent, `Vx.get_vx_user!(nil, ...)` is called. Since `get_vx_user!/2` uses a bang function, it will raise `Ecto.NoResultsError` or similar — an unhandled exception rather than a graceful `{:error, ...}` tuple. No test covers this path.

**Recommendation:** Add tests for claims with missing `"sub"`, missing `"customer"`, and both absent, verifying graceful error handling rather than a raised exception.

#### B001-11 — MEDIUM: `resource_from_claims/1` — catch-all clause 2 untested

**Severity:** MEDIUM
**File:** `lib/api_server/guardian.ex`
**Lines:** 24–26

```elixir
def resource_from_claims(_claims) do
  {:error, :reason_for_error}
end
```

Identical issue to B001-9: the catch-all clause is never tested and is likely unreachable given clause 1 matches all map inputs (including maps with nil values).

**Recommendation:** Same as B001-9 — verify reachability, remove dead code, or add a test.

#### B001-12 — MEDIUM: `resource_from_claims/1` — exception from `Vx.get_vx_user!` is unhandled and untested

**Severity:** MEDIUM
**File:** `lib/api_server/guardian.ex`
**Lines:** 21**

```elixir
user = Vx.get_vx_user!(id, customer)
```

The bang variant raises on not-found. If a JWT is presented with a valid structure but a user ID that no longer exists in the database (deleted user, wrong tenant, etc.), a runtime exception propagates through the Guardian pipeline rather than returning `{:error, :reason_for_error}`. No test exercises this scenario.

**Recommendation:** Add a test that mocks `Vx.get_vx_user!` raising and asserts the error is handled gracefully. Consider using the non-bang `get_vx_user/2` with pattern matching instead.

#### B001-13 — LOW: Error atom `:reason_for_error` is a placeholder

**Severity:** LOW
**File:** `lib/api_server/guardian.ex`
**Lines:** 8, 15, 25

All error returns use the generic atom `:reason_for_error`, which is a Guardian scaffold placeholder. No test verifies that meaningful error atoms are returned, which makes it impossible for callers to distinguish between different failure modes (nil user vs. unknown user vs. missing claims).

**Recommendation:** Replace with specific atoms (e.g., `:user_not_found`, `:missing_claims`, `:invalid_token`) and add tests asserting the specific atoms.

---

## File 4 — `lib/api_server/repo.ex`

### READING EVIDENCE

**Module 1:** `ApiServer.Repo`

Uses: `Ecto.Repo, otp_app: :api_server`

**Functions / macros / callbacks defined:**

| Line | Visibility | Name / Arity | Description |
|------|------------|--------------|-------------|
| 8–10 | public (Ecto callback) | `init/2` | Reads `DATABASE_URL` env var; puts it into opts under `:url`; returns `{:ok, opts}` |

**Module 2:** `ApiServer.FortyNineRepo`

Uses: `Ecto.Repo, otp_app: :api_server`

**Functions / macros / callbacks defined:**
- None explicitly defined. `FortyNineRepo` relies entirely on `Ecto.Repo` defaults with no `init/2` override.

**Types / structs / constants:** None in either module.

**Test file:** None (no `test/api_server/repo_test.exs`).

**Indirect test coverage search:**
- `ApiServer.Repo` is referenced in `test/support/conn_case.ex`, `test/support/data_case.ex`, `test/support/channel_case.ex` only for sandbox checkout — the `init/2` callback itself is never directly tested.
- `ApiServer.FortyNineRepo` is not referenced in any test file.
- `test/test_helper.exs` has the Sandbox mode call commented out (line 3).

### Findings

#### B001-14 — HIGH: `ApiServer.Repo` has no dedicated test file; `init/2` is untested

**Severity:** HIGH
**File:** `lib/api_server/repo.ex`
**Lines:** 1–11

`ApiServer.Repo.init/2` reads `DATABASE_URL` from the environment and injects it into the keyword opts. This callback is critical for database connectivity. No test directly exercises it, meaning the following scenarios are unverified:

- `DATABASE_URL` is set: opts correctly contain `:url`.
- `DATABASE_URL` is unset (`nil`): `Keyword.put(opts, :url, nil)` is called — Ecto may silently ignore this or fall back to other config, but this is untested.

**Recommendation:** Add `test/api_server/repo_test.exs` testing `ApiServer.Repo.init(:runtime, [])` with and without `DATABASE_URL` set.

#### B001-15 — HIGH: `ApiServer.FortyNineRepo` has no test file and no indirect coverage

**Severity:** HIGH
**File:** `lib/api_server/repo.ex`
**Lines:** 13–15

`ApiServer.FortyNineRepo` has no `init/2` override. Its database URL must therefore be configured statically in `config/`. There is no test that checks `FortyNineRepo` connects, is accessible, or is properly configured. It is referenced in TCP command processing (`tcp_commands.ex`) using a schema prefix of `"trackingsolutions"` but is never tested.

**Recommendation:** Add tests (or at minimum a configuration assertion) verifying `FortyNineRepo` is properly configured and reachable in the test environment.

#### B001-16 — MEDIUM: `ApiServer.Repo.init/2` — `DATABASE_URL` nil/missing path untested

**Severity:** MEDIUM
**File:** `lib/api_server/repo.ex`
**Lines:** 8–10

```elixir
def init(_, opts) do
  {:ok, Keyword.put(opts, :url, System.get_env("DATABASE_URL"))}
end
```

`System.get_env("DATABASE_URL")` returns `nil` when the variable is not set. `Keyword.put(opts, :url, nil)` is then called. Ecto's behaviour when `:url` is `nil` depends on whether other connection options (`:hostname`, `:database`, etc.) are present in the config — but this fallback path is untested and could cause silent misconfiguration in production deployments.

**Recommendation:** Add a test that calls `init(:runtime, [])` in an environment where `DATABASE_URL` is unset and asserts the returned opts are handled predictably (either with a fallback or a meaningful error).

#### B001-17 — LOW: Test sandbox mode is commented out in `test_helper.exs`

**Severity:** LOW
**File:** `test/test_helper.exs`
**Line:** 3

```elixir
# Ecto.Adapters.SQL.Sandbox.mode(ApiServer.Repo, :manual)
```

The sandbox is set to `:manual` mode in `conn_case.ex` and `data_case.ex` via `setup` blocks, but the top-level `test_helper.exs` has the initial sandbox mode call commented out. This means the repo sandbox mode is not explicitly set before tests run; it relies on Ecto's default. While this is commonly acceptable, `ApiServer.FortyNineRepo` is never placed into sandbox mode at all, meaning any test that indirectly exercises `FortyNineRepo` writes would not be isolated within a transaction.

**Recommendation:** Ensure `ApiServer.FortyNineRepo` is also placed in sandbox mode (or document why it is excluded). Uncomment or add an explicit sandbox initialisation for both repos in `test_helper.exs`.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B001-1 | HIGH | `api_server.ex` | Module has no test file and no indirect coverage |
| B001-2 | HIGH | `application.ex` | `ApiServer.Application` has no test file |
| B001-3 | MEDIUM | `application.ex` | `config_change/3` completely untested |
| B001-4 | MEDIUM | `application.ex` | `TCP_PORT` invalid/missing value path untested |
| B001-5 | LOW | `application.ex` | No test for partial supervisor child startup failure |
| B001-6 | LOW | `application.ex` | Deprecated `Supervisor.Spec` import with no regression test |
| B001-7 | HIGH | `guardian.ex` | `ApiServer.Guardian` has no test file and no indirect coverage |
| B001-8 | MEDIUM | `guardian.ex` | `subject_for_token/2` nil-user branch untested |
| B001-9 | MEDIUM | `guardian.ex` | `subject_for_token/2` catch-all clause 2 untested / potentially dead code |
| B001-10 | MEDIUM | `guardian.ex` | `resource_from_claims/1` missing claims keys path untested |
| B001-11 | MEDIUM | `guardian.ex` | `resource_from_claims/1` catch-all clause 2 untested / potentially dead code |
| B001-12 | MEDIUM | `guardian.ex` | Unhandled exception from `Vx.get_vx_user!` in `resource_from_claims/1` |
| B001-13 | LOW | `guardian.ex` | Placeholder `:reason_for_error` atom used in all error returns |
| B001-14 | HIGH | `repo.ex` | `ApiServer.Repo.init/2` untested; no dedicated test file |
| B001-15 | HIGH | `repo.ex` | `ApiServer.FortyNineRepo` has no test file and no indirect coverage |
| B001-16 | MEDIUM | `repo.ex` | `Repo.init/2` nil `DATABASE_URL` path untested |
| B001-17 | LOW | `repo.ex` / `test_helper.exs` | `FortyNineRepo` never placed in sandbox mode; sandbox init commented out |

**Totals:** 5 HIGH, 7 MEDIUM, 4 LOW, 0 CRITICAL, 0 INFO

<!-- B002.md -->
# Audit Report B002
**Audit Run:** 2026-02-27-01
**Agent:** B002
**Pass:** 2 (Test Coverage)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server/fortynine/calamppositionevents.ex`
2. `lib/api_server/fortynine/webservicepositionqueue.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/fortynine/calamppositionevents.ex`

**Module name:** `ApiServer.FortyNine.CalampPositionEvents`

**Behaviours / use directives:**
- `use Ecto.Schema` (line 2)
- `use Bitwise` (line 3)
- `use Timex` (line 4)
- `import Ecto.Changeset` (line 5)

**Functions defined:**

| Function | Line | Visibility |
|----------|------|------------|
| `changeset/2` | 91 | Public (annotated `@doc false`) |

**Schema name:** `"calamppositionevents"` (line 7)

**Schema fields (all defined inside `schema` block, lines 7–88):**

| Field | Type |
|-------|------|
| `:datetimesaved` | `:utc_datetime` |
| `:gmtdatetime` | `:utc_datetime` |
| `:timeoffix` | `:utc_datetime` |
| `:hardwareid` | `:integer` |
| `:latitude` | `:float` |
| `:longitude` | `:float` |
| `:heading` | `:float` |
| `:speed` | `:float` |
| `:gpslock` | `:integer` |
| `:old` | `:integer` |
| `:ping` | `:integer` |
| `:motion` | `:integer` |
| `:speeding` | `:integer` |
| `:ignition` | `:integer` |
| `:ignitionstatus` | `:string` |
| `:rssi` | `:integer` |
| `:gpsfixquality` | `:integer` |
| `:eventtype` | `:integer` |
| `:eventcode` | `:integer` |
| `:sensor1` | `:integer` |
| `:sensor2` | `:integer` |
| `:odometer` | `:integer` |
| `:distancesincelastevent` | `:integer` |
| `:wsusername` | `:string` |
| `:wspassword` | `:string` |
| `:altitude` | `:integer` |
| `:error` | `:integer` |
| `:ioflagstatus` | `:integer` |
| `:alarmid` | `:integer` |
| `:errormsg` | `:string` |
| `:connectionname` | `:string` |
| `:weight` | `:float` |
| `:maxheight` | `:float` |
| `:fuelusage` | `:float` |
| `:engineonelapsed` | `:integer` |
| `:totalengineonelapsed` | `:integer` |
| `:input1elapsed` | `:integer` |
| `:input1status` | `:string` |
| `:input1flag` | `:integer` |
| `:totalinput1elapsed` | `:integer` |
| `:accelerometerx` | `:float` |
| `:accelerometery` | `:float` |
| `:accelerometerz` | `:float` |
| `:location` | `:string` |
| `:city` | `:string` |
| `:state` | `:string` |
| `:postcode` | `:string` |
| `:driverid` | `:string` |
| `:mifaredriverid` | `:string` |
| `:messageid` | `:integer` |
| `:originalmsg` | `:binary` |
| `:prestartchecklist` | `:string` |
| `:motiontotalelapsed` | `:integer` |
| `:containerliftcount` | `:integer` |
| `:appmsgtext` | `:string` |
| `:pulsecount` | `:integer` |
| `:totalfuel` | `:integer` |
| `:vehicleload` | `:integer` |
| `:rawvehicleload` | `:integer` |
| `:appmsgtext2` | `:string` |
| `:batteryvoltage` | `:float` |
| `:rpm` | `:float` |
| `:engcoolanttemp` | `:float` |
| `:engcoolantpressure` | `:float` |
| `:engcoolantlevelpercent` | `:float` |
| `:engoiltemp` | `:float` |
| `:engoilpressure` | `:float` |
| `:engcrankcasepressure` | `:float` |
| `:engoillevelpercent` | `:float` |
| `:engfuellevel1percent` | `:float` |
| `:engfuellevel2percent` | `:float` |
| `:engfuelrate` | `:float` |
| `:engtotalfuelused` | `:float` |
| `:engtotalfuelidle` | `:float` |
| `:engtotalhoursidle` | `:float` |
| `:engtotalhours` | `:float` |
| `:totalvehiclehours` | `:float` |
| `:totalptohours` | `:float` |
| `:engaveragefueleco` | `:float` |
| `:internalbatteryvoltage` | `:float` |

**`changeset/2` details (lines 91–95):**
- Casts all 80 schema fields
- `validate_required([:hardwareid])` — only `:hardwareid` is required

---

### File 2: `lib/api_server/fortynine/webservicepositionqueue.ex`

**Module name:** `ApiServer.FortyNine.WebServicePositionQueue`

**Behaviours / use directives:**
- `use Ecto.Schema` (line 2)
- `use Bitwise` (line 3)
- `use Timex` (line 4)
- `import Ecto.Changeset` (line 5)

**Functions defined:**

| Function | Line | Visibility |
|----------|------|------------|
| `changeset/2` | 37 | Public (annotated `@doc false`) |

**Schema name:** `"webservicepositionqueue"` (line 7)

**Schema fields (all defined inside `schema` block, lines 7–34):**

| Field | Type |
|-------|------|
| `:RECORDID` | `:integer` |
| `:datetimequeued` | `:utc_datetime` |
| `:utctimestamp` | `:utc_datetime` |
| `:HARDWAREID` | `:string` |
| `:MOBILENAME` | `:string` |
| `:driverID` | `:string` |
| `:LATITUDE` | `:float` |
| `:LONGITUDE` | `:float` |
| `:HEADING` | `:float` |
| `:SPEED` | `:float` |
| `:GPSLOCK` | `:integer` |
| `:OLD` | `:integer` |
| `:PING` | `:integer` |
| `:MOTION` | `:integer` |
| `:SPEEDING` | `:integer` |
| `:IGNITION` | `:integer` |
| `:IGNITIONSTATUS` | `:string` |
| `:RSSI` | `:integer` |
| `:SATS` | `:integer` |
| `:SENSOR1` | `:integer` |
| `:SENSOR2` | `:integer` |
| `:WSUSERNAME` | `:string` |
| `:WSPASSWORD` | `:string` |
| `:ERROR` | `:integer` |
| `:ERRORMSG` | `:string` |
| `:CONNECTIONNAME` | `:string` |

**`changeset/2` details (lines 37–41):**
- Casts all 26 schema fields
- `validate_required([:HARDWAREID])` — only `:HARDWAREID` is required

---

## Test Coverage Search Results

### Direct test files
No direct test files exist for either module. The known test files are:
- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`

### Grep results: indirect coverage search

Searches performed across `test/` for:
- `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`
- `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`
- `FortyNine.CalampPositionEvents`, `FortyNine.WebServicePositionQueue`
- `changeset` (scoped to test directory)

**Result: Zero matches found for either module or their `changeset/2` functions in any test file.**

### `calamp_controller_test.exs` contents
The file exists but is completely empty — the `use ApiServerWeb.ConnCase` line is commented out and no tests are defined:

```elixir
defmodule ApiServerWeb.CalampControllerTest do
    # use ApiServerWeb.ConnCase
end
```

### Production usage context
Both modules are used exclusively in:
- `lib/api_server/tcp/tcp_commands.ex` (lines 1186–1187, 1226–1227, 1271–1272, 1311–1312, 1856–1857, 1896–1897)

In each call site, the pattern is:
```elixir
%CalampPositionEvents{}
|> CalampPositionEvents.changeset(fortynine_calamppositionevent)

%WebServicePositionQueue{}
|> WebServicePositionQueue.changeset(fortynine_queued_event)
```

No tests cover `tcp_commands.ex` either (it is not in the known test file list).

---

## Findings

---

### B002-1
**Severity:** HIGH
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Issue:** No test file exists for `ApiServer.FortyNine.CalampPositionEvents`

There is no direct test file and no indirect test coverage found anywhere in the `test/` directory. The module defines an Ecto schema backed by a production database table (`[REDACTED-AWS-SMTP-PASSWORD]`) and a `changeset/2` function that is called from `tcp_commands.ex` at three distinct call sites (lines 1186, 1271, 1856). Any regression in changeset behaviour — such as a cast omission, a type mismatch, or a field being accidentally removed — would be completely invisible to the test suite.

---

### B002-2
**Severity:** HIGH
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Issue:** No test file exists for `ApiServer.FortyNine.WebServicePositionQueue`

There is no direct test file and no indirect test coverage found anywhere in the `test/` directory. The module defines an Ecto schema backed by `[REDACTED-AWS-SMTP-PASSWORD]` and a `changeset/2` function called from `tcp_commands.ex` at three distinct call sites (lines 1226, 1311, 1896). Identical risk profile to B002-1.

---

### B002-3
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Function:** `changeset/2` (line 91)
**Issue:** `changeset/2` has no test exercising its valid path

No test verifies that a valid attrs map with a `:hardwareid` value produces an `{:ok, changeset}` result with `changeset.valid? == true`. The function is the sole public API of the module and is exercised only from the TCP processing path, which itself has no tests.

---

### B002-4
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Function:** `changeset/2` (line 37)
**Issue:** `changeset/2` has no test exercising its valid path

Same situation as B002-3. No test verifies that a valid attrs map with a `:HARDWAREID` value produces a valid changeset.

---

### B002-5
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Function:** `changeset/2` (line 91)
**Issue:** `validate_required([:hardwareid])` failure path is untested

No test verifies that omitting `:hardwareid` from attrs causes `changeset.valid? == false` and produces the expected validation error on the `:hardwareid` field. A change to the `validate_required` call (e.g., accidentally widening or narrowing the required list) would not be caught.

---

### B002-6
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Function:** `changeset/2` (line 37)
**Issue:** `validate_required([:HARDWAREID])` failure path is untested

Same situation as B002-5. No test verifies the changeset is invalid when `:HARDWAREID` is absent from attrs.

---

### B002-7
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Function:** `changeset/2` (line 91)
**Issue:** Unknown/extra keys in attrs are not tested for safe rejection

`cast/3` silently drops fields not present in the permitted list. There is no test confirming that arbitrary or misspelled keys passed in attrs are silently ignored rather than causing an error, nor that the cast list itself is complete and accurate relative to the schema definition.

---

### B002-8
**Severity:** MEDIUM
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Function:** `changeset/2` (line 37)
**Issue:** Unknown/extra keys in attrs are not tested for safe rejection

Same situation as B002-7.

---

### B002-9
**Severity:** LOW
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Function:** `changeset/2` (line 91)
**Issue:** Edge cases for nil, empty, and boundary values are untested

No tests cover:
- Passing `nil` explicitly for optional float fields (e.g., `:latitude`, `:longitude`, `:speed`) to confirm they are accepted
- Passing an empty string for string fields (e.g., `:ignitionstatus`, `:errormsg`) to confirm behaviour
- Passing zero or negative integers for fields where only positive values are meaningful (e.g., `:hardwareid`, `:odometer`, `:speed`)
- Passing `nil` for `:hardwareid` explicitly (should produce a required validation error)
- Passing a binary value for `:originalmsg` to confirm `:binary` cast handling

---

### B002-10
**Severity:** LOW
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Function:** `changeset/2` (line 37)
**Issue:** Edge cases for nil, empty, and boundary values are untested

No tests cover:
- Passing `nil` for optional float fields (e.g., `:LATITUDE`, `:LONGITUDE`, `:SPEED`)
- Passing an empty string for `:HARDWAREID` — the `validate_required` check passes for empty strings in Ecto unless `validate_required` is combined with a length/format validation; this edge case is unverified
- Passing `nil` for `:HARDWAREID` explicitly
- Passing zero or negative values for numeric fields

---

### B002-11
**Severity:** LOW
**File:** `lib/api_server/fortynine/calamppositionevents.ex`
**Issue:** Unused `use Bitwise` and `use Timex` directives

Lines 3 and 4 import `Bitwise` and `Timex` into the module, but the module body (schema + changeset) makes no use of any functions from either library. This dead import has no test asserting the module compiles without warnings. While not a coverage gap per se, it indicates the module may be copy-pasted boilerplate and no test would catch a future accidental use of bitwise operators or Timex functions that could cause subtle type errors on field values.

---

### B002-12
**Severity:** LOW
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`
**Issue:** Unused `use Bitwise` and `use Timex` directives

Same situation as B002-11. Lines 3 and 4 of `webservicepositionqueue.ex` include `use Bitwise` and `use Timex` with no actual usage in the module.

---

### B002-13
**Severity:** INFO
**File:** `test/api_server_web/controllers/calamp_controller_test.exs`
**Issue:** CalAMP controller test file is an empty stub

The file at `test/api_server_web/controllers/calamp_controller_test.exs` exists but contains only a commented-out `use ApiServerWeb.ConnCase` line and no test cases. This is the closest test file to the CalAMP domain and indicates that controller-level integration tests were planned but never implemented. This leaves the full request-to-database pipeline (controller → tcp_commands → changeset → Repo.insert) completely untested.

---

## Summary Table

| ID | Severity | File | Issue |
|----|----------|------|-------|
| B002-1 | HIGH | calamppositionevents.ex | No test file exists |
| B002-2 | HIGH | webservicepositionqueue.ex | No test file exists |
| B002-3 | MEDIUM | calamppositionevents.ex | `changeset/2` valid path untested |
| B002-4 | MEDIUM | webservicepositionqueue.ex | `changeset/2` valid path untested |
| B002-5 | MEDIUM | calamppositionevents.ex | `validate_required` failure path untested |
| B002-6 | MEDIUM | webservicepositionqueue.ex | `validate_required` failure path untested |
| B002-7 | MEDIUM | calamppositionevents.ex | Cast with unknown/extra keys untested |
| B002-8 | MEDIUM | webservicepositionqueue.ex | Cast with unknown/extra keys untested |
| B002-9 | LOW | calamppositionevents.ex | Nil/empty/boundary edge cases untested |
| B002-10 | LOW | webservicepositionqueue.ex | Nil/empty/boundary edge cases untested |
| B002-11 | LOW | calamppositionevents.ex | Unused `use Bitwise` / `use Timex` — no compile-warning test |
| B002-12 | LOW | webservicepositionqueue.ex | Unused `use Bitwise` / `use Timex` — no compile-warning test |
| B002-13 | INFO | calamp_controller_test.exs | Controller test file is an empty stub |

**Total findings: 13** (2 HIGH, 6 MEDIUM, 4 LOW, 1 INFO)

<!-- B003.md -->
# Audit Report B003
**Audit run:** 2026-02-27-01
**Agent:** B003 (Pass 2)
**Assigned source files:**
- `lib/api_server/operators/file.ex`
- `lib/api_server/operators/operators.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/operators/file.ex`

**Module:** `ApiServer.Operators.File`

**Behaviours/macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined (line 6–11):** `"files"` table
| Field      | Type      | Line |
|------------|-----------|------|
| `:custcode` | `:string` | 7    |
| `:esn`      | `:string` | 8    |
| `timestamps()` | (inserted_at, updated_at) | 10 |

**Functions defined:**

| Name         | Arity | Line | Visibility |
|--------------|-------|------|------------|
| `changeset/2` | 2    | 14   | public     |

**Changeset logic (`changeset/2`, lines 14–18):**
- Casts `:esn` and `:custcode` from attrs.
- Validates both fields are required via `validate_required([:esn, :custcode])`.

---

### File 2: `lib/api_server/operators/operators.ex`

**Module:** `ApiServer.Operators`

**Aliases used:**
- `ApiServer.Repo` (line 7)
- `ApiServer.Operators.File` (line 8)

**Functions defined:**

| Name           | Arity | Line | Visibility |
|----------------|-------|------|------------|
| `list_files/0`  | 0    | 19   | public     |
| `get_file!/1`   | 1    | 37   | public     |
| `create_file/1` | 1    | 51   | public (default arg `%{}`) |
| `update_file/2` | 2    | 69   | public     |
| `delete_file/1` | 1    | 87   | public     |
| `change_file/1` | 1    | 100  | public     |

**Function summaries:**
- `list_files/0` (line 19–21): Returns `Repo.all(File)` — full table scan.
- `get_file!/1` (line 37): Returns single record via `Repo.get!`; raises `Ecto.NoResultsError` if not found.
- `create_file/1` (line 51–55): Builds new `%File{}`, applies changeset, calls `Repo.insert()`. Returns `{:ok, %File{}}` or `{:error, %Ecto.Changeset{}}`.
- `update_file/2` (line 69–73): Applies changeset to existing `%File{}`, calls `Repo.update()`. Returns `{:ok, %File{}}` or `{:error, %Ecto.Changeset{}}`.
- `delete_file/1` (line 87–89): Calls `Repo.delete(file)`. Returns `{:ok, %File{}}` or `{:error, %Ecto.Changeset{}}`.
- `change_file/1` (line 100–102): Returns a bare `%Ecto.Changeset{}` for form tracking; calls `File.changeset(file, %{})`.

---

## TEST COVERAGE SEARCH RESULTS

**Direct test files:** None exist for either module.

**Indirect coverage search — test directory scanned for:**
- `ApiServer.Operators` — 0 matches
- `ApiServer.Operators.File` — 0 matches
- `list_files`, `get_file`, `create_file`, `update_file`, `delete_file`, `change_file` — 0 matches
- `operators` (case-insensitive) — 0 matches
- `changeset` — matches only in `test/support/data_case.ex` (generic helper; no reference to `ApiServer.Operators.File`)

**Conclusion:** Zero test coverage exists for either module anywhere in the test suite.

---

## FINDINGS

---

### B003-1
**Severity:** HIGH
**File:** `lib/api_server/operators/file.ex`
**Finding:** No test file exists for `ApiServer.Operators.File`, and no indirect coverage was found anywhere in the test suite.

The schema module is completely untested. There is no test exercising `changeset/2`, no validation of required-field enforcement, and no confirmation that the schema maps correctly to the `"files"` table.

---

### B003-2
**Severity:** HIGH
**File:** `lib/api_server/operators/operators.ex`
**Finding:** No test file exists for `ApiServer.Operators`, and no indirect coverage was found anywhere in the test suite.

All six public context functions (`list_files/0`, `get_file!/1`, `create_file/1`, `update_file/2`, `delete_file/1`, `change_file/1`) are completely untested. The module is a standard Phoenix context generated by `mix phx.gen.context` and Phoenix itself generates a corresponding test file for such contexts; that generated test file is absent.

---

### B003-3
**Severity:** MEDIUM
**File:** `lib/api_server/operators/operators.ex` — `create_file/1` (line 51)
**Finding:** The success path `{:ok, %File{}}` for `create_file/1` is untested, and the failure path `{:error, %Ecto.Changeset{}}` (triggered when required fields `:esn` or `:custcode` are missing or invalid) is also untested.

Both branches documented in the `@doc` example are exercised by zero tests.

---

### B003-4
**Severity:** MEDIUM
**File:** `lib/api_server/operators/operators.ex` — `update_file/2` (line 69)
**Finding:** Both the success path and the validation-failure path of `update_file/2` are untested. Passing an invalid or empty attrs map should produce `{:error, %Ecto.Changeset{}}` but this is never verified.

---

### B003-5
**Severity:** MEDIUM
**File:** `lib/api_server/operators/operators.ex` — `get_file!/1` (line 37)
**Finding:** The exception path — calling `get_file!/1` with a non-existent ID and expecting `Ecto.NoResultsError` to be raised — is untested. This is the primary documented failure mode for this function.

---

### B003-6
**Severity:** MEDIUM
**File:** `lib/api_server/operators/file.ex` — `changeset/2` (line 14)
**Finding:** The `validate_required([:esn, :custcode])` constraint is untested. There is no test confirming that omitting `:esn`, omitting `:custcode`, or omitting both produces the expected changeset errors.

---

### B003-7
**Severity:** LOW
**File:** `lib/api_server/operators/file.ex` — `changeset/2` (line 14)
**Finding:** Edge cases for field values are untested:
- Empty string (`""`) for `:esn` or `:custcode` — Ecto's `validate_required` treats empty strings as blank by default, which would trigger a validation error, but this is never verified.
- Extremely long strings for `:esn` or `:custcode` — no maximum-length validation is defined and no test confirms or challenges this absence.
- `nil` explicitly passed for either field — untested.

---

### B003-8
**Severity:** LOW
**File:** `lib/api_server/operators/operators.ex` — `create_file/1` (line 51)
**Finding:** `create_file/1` accepts a default argument of `%{}`. Calling `create_file()` with no argument (empty map) is an edge case that should produce a validation failure; this path is untested and the default-arg behaviour is never exercised by any test.

---

### B003-9
**Severity:** LOW
**File:** `lib/api_server/operators/operators.ex` — `delete_file/1` (line 87)
**Finding:** `delete_file/1` is untested in both its success path and any potential constraint-violation failure path (e.g., a foreign-key constraint preventing deletion). There are no tests confirming the record is actually removed from the database after deletion.

---

### B003-10
**Severity:** INFO
**File:** `lib/api_server/operators/operators.ex` — `change_file/1` (line 100)
**Finding:** `change_file/1` is a form-tracking helper that returns a changeset with empty attrs. While it is low-risk, it is completely untested. The return value shape (`%Ecto.Changeset{source: %File{}}`) noted in the docstring is never verified.

---

## SUMMARY TABLE

| ID      | Severity | Module / Function                              | Description                                              |
|---------|----------|------------------------------------------------|----------------------------------------------------------|
| B003-1  | HIGH     | `ApiServer.Operators.File` (whole module)      | No test file; zero coverage for schema/changeset module  |
| B003-2  | HIGH     | `ApiServer.Operators` (whole module)           | No test file; all 6 context functions untested           |
| B003-3  | MEDIUM   | `Operators.create_file/1`                      | Both success and validation-failure paths untested       |
| B003-4  | MEDIUM   | `Operators.update_file/2`                      | Both success and validation-failure paths untested       |
| B003-5  | MEDIUM   | `Operators.get_file!/1`                        | `Ecto.NoResultsError` raise path untested                |
| B003-6  | MEDIUM   | `Operators.File.changeset/2`                   | `validate_required` constraints never tested             |
| B003-7  | LOW      | `Operators.File.changeset/2`                   | Edge cases: empty string, nil, oversized values untested |
| B003-8  | LOW      | `Operators.create_file/1` (default arg)        | Default empty-map argument path untested                 |
| B003-9  | LOW      | `Operators.delete_file/1`                      | Success path and FK-constraint failure path untested     |
| B003-10 | INFO     | `Operators.change_file/1`                      | Form-tracking helper entirely untested                   |

<!-- B004.md -->
# Audit B004 — Pass 2 Coverage Analysis
**Audit run:** 2026-02-27-01
**Agent:** B004
**Date:** 2026-02-27

---

## Source Files Reviewed

1. `lib/api_server/tcp/tcp.ex`
2. `lib/api_server/tcp/tcp_commands.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/tcp/tcp.ex`

**Module:** `ApiServer.TCP`

**Aliases / Imports:**
- `import Ecto.Query, warn: false`
- `alias ApiServer.Repo`
- `alias ApiServer.Vx.VXUser`
- `alias ApiServer.Vx.VXThingEvent`
- `alias ApiServer.Vx.VXThingEventOmega`
- `alias ApiServer.Vx.VXThingEventOmegaTires`
- `alias ApiServer.Vx.VXFleetAssociation`
- `alias ApiServer.Vx.VXRestriction`
- `alias ApiServer.Vx.Geofence`
- `alias ApiServer.Vx.VXThing`
- `alias ApiServer.Vx.VXAblRecord`
- `alias ApiServer.Vx.VXRayvenMessageLog`
- `require Logger`

**Functions defined:**

| Name | Visibility | Line | Notes |
|------|-----------|------|-------|
| `accept/1` | public | 23 | Opens TCP listen socket, calls `loop_acceptor/1` |
| `loop_acceptor/1` | private | 32 | Accepts connections, spawns task via `Task.Supervisor`, tail-recurses |
| `serve/2` | private | 48 | Reads a line, dispatches via `ApiServer.TCP.Commands.parse/2` and `run/1`, writes response |
| `read_line/3` | private | 90 | Binary protocol framing; dispatches on sync bytes and message type byte |
| `write_line/2` (text) | private | 135 | Sends binary text over socket |
| `write_line/2` (unknown_command) | private | 139 | Sends "UNKNOWN COMMAND\r\n" error response |
| `write_line/2` (closed) | private | 143 | Calls `exit(:shutdown)` |
| `write_line/2` (generic error) | private | 147 | Sends "ERROR\r\n" and calls `exit(error)` |

**Constants / Literals:**
- Sync bytes pattern: `<<2>>, <<85>>` (0x02, 0x55)
- Message type bytes dispatched: `<<0>>` (Hello), `<<5>>` (commit), `<<38>>` (close), `<<4>>` (data/continuation)
- Timeout on `gen_tcp.recv`: 5000 ms (hard-coded, line 91)

---

### File 2: `lib/api_server/tcp/tcp_commands.ex`

**Module:** `ApiServer.TCP.Commands`

**Aliases / Imports:**
- `import Ecto.Query, warn: false`
- `alias ApiServer.FortyNineRepo`
- `alias ApiServer.FortyNine.CalampPositionEvents`
- `alias ApiServer.FortyNine.WebServicePositionQueue`
- `alias ApiServer.Vx.DeviceDatabaseLookup`
- `alias ApiServerWeb.UtilityController`

**Functions defined:**

| Name | Visibility | Line | Notes |
|------|-----------|------|-------|
| `parse_hello_message/1` | public | 9 | Parses binary hello frame; looks up device by serial; returns `{:ok, {:send, "hello", params}}` or `{:error, ...}` |
| `parse_data_message/3` | public | 35 | Parses binary data frame; recurses for multiple records; dispatches to `parse_debug_record` or `parse_data_record` based on log_reason |
| `parse_debug_record/3` | public | 120 | Parses a debug record; dispatches to `parse_debug_field`; always returns `[]` |
| `parse_data_record/3` | public | 158 | Core data parsing: extracts up to 7 named fields, dispatches to GPS/trip/total/driverid/analog32 field parsers; writes to DB via Ecto and FortyNineRepo; returns `[]` |
| `parse_debug_field/1` | public | 1325 | Parses severity/module + ASCII from binary; returns ASCII codepoint integer |
| `parse_gps_field/1` | public | 1331 | Parses 20-byte GPS field binary; returns map with keys `Alt`, `FType`, `GpsStat`, `GpsUTC`, `Head`, `Lat`, `Long`, `PDOP`, `PosAcc`, `Spd`, `SpdAcc` |
| `parse_digital_field/1` | public | 1385 | Parses 6-byte digital I/O field; extracts battery status bits and two input bits; returns map with `FType => 2` |
| `parse_analog_field/1` | public | 1454 | Parses raw analog bytes; returns map with `FType => 6`, raw bytes and hex string |
| `parse_analog32_field/1` | public | 1470 | Parses 32-bit analog field; decodes up to 3 analog inputs from chunked hex; always emits `IO.puts`; returns map with `FType => 7` |
| `parse_trip_field/1` | public | 1541 | Parses 8-byte trip field; returns map with `Dist`, `FType => 26`, `Dur` |
| `parse_total_field/1` | public | 1556 | Parses 8-byte total field; returns map with `Odo`, `FType => 27`, `RH` |
| `parse_driverid_field/1` | public | 1571 | Parses driver ID field; handles iButton (type 2), Weigand 26-bit RFID (type 7), and other RFID sizes; always emits `IO.puts`; returns map with `FType => 3` |
| `parse_commit_message/2` | public | 1673 | Trivially returns `{:ok, {:send, "commit", params}}` |
| `parse_iridium/2` | public | 1679 | Parses Iridium satellite binary frame; hard-codes `hardware_id = 462_743` and `customer = "vx_trility"`; writes to DB; returns `{:send, "commit", params}` (note: not wrapped in `{:ok, ...}`) |
| `parse/2` | public | 1903 | Top-level parser dispatcher; matches message type byte and routes to appropriate sub-parser; returns command tuple or `""` |
| `run/1` (function head) | public | 1959 | Declares the `run/1` function |
| `run({:send, "hello", params})` | public | 1961 | Returns hello response binary `<<2, 85, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0>>` |
| `run({:send, "commit", params})` | public | 1966 | Returns commit success binary `<<2, 85, 6, 1, 0, 1>>` |
| `run({:processed, "data", params})` | public | 1976 | Returns `<<0>>` (noop marker) |
| `run({:close, "socket", params})` | public | 1982 | Returns `<<1>>` (close marker) |

**Hard-coded device serial/hardware ID whitelists (constants embedded in code):**
- Trility Iridium unit: `462_743` (hard-coded in `parse_iridium/2`, line 1756)
- Trility device list (integer guard): lines 886–904 (13 entries)
- Trility device list (integer guard): lines 1144–1161 (15 entries)
- Trility device list (string guard): lines 1231–1247 (15 entries)
- Yabby3 device list: lines 780–817 (30+ entries)
- Test unit: `625_425` (special-cased debug logging throughout)
- Special-case hardware IDs for `thing_event` shape: `[279_677, 370_775, 408_573, 408_538, 371_119]` (line 1058)

---

## Test Coverage Search Results

Searched `test/` for:
- `ApiServer.TCP`
- `TCP.Commands`
- `tcp_commands`
- `parse_hello`, `parse_data`, `parse_commit`, `parse_iridium`
- `parse_gps`, `parse_trip`, `parse_total`, `parse_debug`, `parse_analog`, `parse_driverid`, `parse_digital`
- `Commands.run`, `Commands.parse`

**Result: Zero matches.** No test file in the repository exercises any function in either `ApiServer.TCP` or `ApiServer.TCP.Commands`.

---

## Findings

---

### B004-1
**Severity:** HIGH
**File:** `lib/api_server/tcp/tcp.ex`
**Finding:** No test file exists for `ApiServer.TCP`. The entire TCP server module — connection acceptance, binary protocol framing, message dispatch, and socket lifecycle — has zero automated test coverage.

---

### B004-2
**Severity:** HIGH
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Finding:** No test file exists for `ApiServer.TCP.Commands`. This module contains the bulk of the application's binary protocol parsing and all database write logic for tracking device events. None of the 19 public functions have any automated test coverage.

---

### B004-3
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_hello_message/1` (line 9)
**Finding:** The device-not-found branch (`[]` return from `device_lookup_with_hardware_id`) is untested. The error return path `{:error, {:error, "error", %{}}}` propagates back to `serve/2` in `tcp.ex` where it is not handled explicitly (falls into the `_` catch-all at line 85 which is `:noop`), silently discarding the error. No test exercises either the success or failure path.

---

### B004-4
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_data_record/3` (line 158)
**Finding:** The function performs no fewer than seven levels of nested field parsing with distinct dispatch branches (field IDs 0, 3, 7, 26, 27, and catch-all) and conditional database writes. None of these branches are tested. In particular:
- The path where `field_one_empty == 0` (all-zero GPS payload) returns early with `[]`.
- The path where `remaining_field_data == ""` at any nesting level returns `%{}` silently.
- The DB write failure path (`{:error, error}` from `create_thingevent_record`, line 1129) calls `IO.inspect` and attempts `error.errors`, which will raise `KeyError` if `error` is a plain string or does not have an `.errors` field.

---

### B004-5
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_iridium/2` (line 1679)
**Finding:** `parse_iridium/2` has a hard-coded `hardware_id = 462_743` (line 1756) and `customer = "vx_trility"` (line 1810), making it non-generic and impossible to test without targeting that specific device. The function is never called from within `parse/2` (it is not dispatched on any message type byte in the `parse/2` case statement), meaning it appears to be dead code in the current dispatch path. No test exercises this function.

---

### B004-6
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_driverid_field/1` (line 1571)
**Finding:** Three distinct driverid type branches exist:
- Type 2 (iButton): expects exactly 6 bytes after the type byte. If the actual payload is shorter, a `MatchError` will be raised.
- Type 7 (Weigand RFID): 26-bit and non-26-bit sub-paths, with complex bit manipulation.
- Any other type: the outer `if/else` chain returns `nil` (neither branch matches), so `driverid_data_encoded` is `nil`. The map built at line 1659 will have `"driverID" => nil`, and the subsequent `IO.puts` at line 1666 will format `nil` without error, but callers may not expect `nil` in the `driverID` field.

None of these paths are tested.

---

### B004-7
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp.ex`
**Function:** `read_line/3` (line 90)
**Finding:** The binary pattern match on line 95-99 is unconditional:
```elixir
<<sync_byte_one :: bytes-size(1),
  sync_byte_two :: bytes-size(1),
  message_type :: bytes-size(1),
  payload_length_raw :: bytes-size(2),
  remainder :: binary>> = data
```
If the TCP client sends fewer than 5 bytes in a single recv (e.g. a truncated or malformed packet), this pattern match will raise `MatchError`, crashing the supervised Task. No test verifies this behaviour or the crash-and-restart semantics.

---

### B004-8
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse/2` (line 1903)
**Finding:** The `<<4>>` (Data Record Upload) branch at line 1927 calls `parse(next_remainder, params)` recursively, but discards the result of `parse_data_message/3` entirely (the return value `data_message_response` is bound but unused, and the recursive call's result is also discarded — execution falls through to the result of the `parse(next_remainder, params)` call). The intended accumulation of data message responses is silently lost. No test exercises multi-record uploads to expose this bug.

---

### B004-9
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_analog32_field/1` (line 1470)
**Finding:** Line 1523 performs a destructuring bind:
```elixir
[final_input1, final_input2, final_input3] = [
  Enum.at(analog_values, 0),
  Enum.at(analog_values, 1),
  Enum.at(analog_values, 2)
]
```
`Enum.at/2` returns `nil` for out-of-bounds indices, so if the analog payload contains fewer than 3 entries this bind succeeds but writes `nil` into the result map. If the payload contains 0 entries, all three fields are `nil`. Callers (line 1008–1019) guard with `if analog32_data["Analog_Input1"]`, which handles `nil`, but the silent `nil` is never surfaced to tests. More critically, if `analog_inputs` is empty, the `Enum.chunk_every/1` pipeline can produce an empty list without error but the assumption of exactly 3 inputs is never verified.

---

### B004-10
**Severity:** MEDIUM
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_data_record/3` (line 158) — DB write paths
**Finding:** Two separate database write paths exist:
1. `ApiServer.Vx.create_thingevent_record/2` (line 1125) into the primary database.
2. `FortyNineRepo.insert/2` for `[REDACTED-AWS-SMTP-PASSWORD]` and `[REDACTED-AWS-SMTP-PASSWORD]` (lines 1186–1228 and 1271–1313), guarded by a hard-coded serial number whitelist.

The second path has duplicated logic for integer serial numbers (lines 1143–1229) and string serial numbers (lines 1230–1317) that are structurally identical but differ only in the guard type. Neither path is tested, and the string-serial branch at line 1230 (`when trility in ["461858", ...]`) can never be reached given `serial_number` is always bound as an integer (parsed via `<<serial::little-signed-integer-size(32)>>`), making the string branch dead code.

---

### B004-11
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp.ex`
**Function:** `serve/2` (line 48)
**Finding:** The `result` binding in the `{:ok, _}` branch (lines 70–83) contains a `case msg` block with a `<<1>>` branch that calls `:gen_tcp.close(socket)` and then falls through to the recursive `serve(socket, params)` call at line 84. After closing the socket, the next `read_line` will receive `{:error, :closed}`, returning `{:ok, "closed", <<>>}` which leads to `{_, ""}` → `:noop` and the function returns without further recursion. This is the effective termination path, but there is no guard preventing the `serve` loop from continuing after `close`. No test verifies the connection teardown sequence.

---

### B004-12
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_gps_field/1` (line 1331)
**Finding:** The function expects exactly 20 bytes (`4+4+4+2+2+1+1+1+1+1 = 21`; actual pattern: `gps_datetime(4) + latitude(4) + longitude(4) + altitude(2) + speed(2) + speed_accuracy(1) + heading(1) + pdop(1) + position_accuracy(1) + gps_status(1) = 21` bytes). No test verifies that an undersized or oversized GPS field binary raises a clear error rather than a cryptic `MatchError`.

---

### B004-13
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_digital_field/1` (line 1385)
**Finding:** `Integer.digits(0, 2)` returns `[0]` in Elixir, not `[]`. The `length_inputs == 0` branch (line 1424) can therefore never be reached when `inputs == 0`, since `Integer.digits(0, 2)` produces a list of length 1. The guard `0 ->` for `length_inputs` is dead code. No test exercises this to detect the unreachable branch.

---

### B004-14
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_data_message/3` (line 35)
**Finding:** The `log_reason` case at line 52 maps integer literals (`1`, `2`, `3`, `11`, `17`, `16`, `23`) to `{event_code, event_type}` tuples. However `log_reason` at this point is a raw `bytes-size(1)` binary (`<<parsed_log_reason::little-signed-integer-size(8)>>` is extracted on line 48, but the `case log_reason` on line 52 matches against the raw binary `log_reason` binding, not `parsed_log_reason`). The integer literals `1`, `2`, etc. will never match a single-byte binary, so the entire case falls through to the `_` catch-all on every call. This is a semantic bug (the integer binding `parsed_log_reason` is computed but unused in the case, then both `event_code` and `event_type` are also unused in `parse_data_message` itself). No test exists to expose this.

---

### B004-15
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `parse_analog32_field/1` (line 1470) — `IO.puts` side-effect
**Finding:** Line 1492 unconditionally calls `IO.puts("Analog values: #{inspect(analog_values)}")` on every invocation. Similarly, `parse_driverid_field/1` calls `IO.puts` unconditionally at line 1666. These production log statements produce noise in any test output and could expose sensitive data. No tests suppress or capture this output.

---

### B004-16
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Function:** `run/1` (lines 1959–1986)
**Finding:** There is no catch-all clause for `run/1`. If `parse/2` returns an unexpected tuple shape (or `""` on an empty line that is passed through the `command == ""` guard in `tcp.ex` line 64), `run/1` will raise `FunctionClauseError`. The `""` case is already guarded in `tcp.ex` (line 64–66), but there is no test verifying this guard prevents the `FunctionClauseError`.

---

### B004-17
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`
**Finding:** The aliases `alias ApiServer.Vx.DeviceDatabaseLookup` (line 6) is imported but never referenced in the module body. This is unused dead code that no test would catch as it produces only a compiler warning, not a failure.

---

### B004-18
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp.ex`
**Finding:** The aliases for `VXUser`, `VXThingEvent`, `VXThingEventOmega`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXFleetAssociation`, `VXRestriction`, `Geofence`, `VXAblRecord`, and `VXRayvenMessageLog` (lines 9–18) are all imported but never used in the module body. The file itself has a comment acknowledging this: `# Clean these up after we know which ones we use`. No test would catch these stale imports.

---

## Summary Table

| ID | Severity | File | Subject |
|----|----------|------|---------|
| B004-1 | HIGH | tcp.ex | No test file — entire TCP server module unexercised |
| B004-2 | HIGH | tcp_commands.ex | No test file — all 19 public functions unexercised |
| B004-3 | MEDIUM | tcp_commands.ex | `parse_hello_message/1` — device-not-found error path untested; silent `:noop` on failure |
| B004-4 | MEDIUM | tcp_commands.ex | `parse_data_record/3` — all DB write branches untested; `error.errors` may raise `KeyError` |
| B004-5 | MEDIUM | tcp_commands.ex | `parse_iridium/2` — not reachable from `parse/2`; hard-coded device ID; dead code |
| B004-6 | MEDIUM | tcp_commands.ex | `parse_driverid_field/1` — type mismatch / `nil` driverid for unrecognised type; no tests |
| B004-7 | MEDIUM | tcp.ex | `read_line/3` — unconditional 5-byte pattern match crashes task on short frames |
| B004-8 | MEDIUM | tcp_commands.ex | `parse/2` message type `<<4>>` — `parse_data_message` return value silently discarded |
| B004-9 | MEDIUM | tcp_commands.ex | `parse_analog32_field/1` — silent `nil` fields when payload has fewer than 3 inputs |
| B004-10 | MEDIUM | tcp_commands.ex | `parse_data_record/3` — string-serial FortyNine branch is dead code (serial is always integer) |
| B004-11 | LOW | tcp.ex | `serve/2` — post-close loop continuation; teardown sequence untested |
| B004-12 | LOW | tcp_commands.ex | `parse_gps_field/1` — no edge case test for wrong-length GPS binary |
| B004-13 | LOW | tcp_commands.ex | `parse_digital_field/1` — `length_inputs == 0` branch is unreachable |
| B004-14 | LOW | tcp_commands.ex | `parse_data_message/3` — `case log_reason` matches binary not integer; always hits catch-all |
| B004-15 | LOW | tcp_commands.ex | `parse_analog32_field/1`, `parse_driverid_field/1` — unconditional `IO.puts` in hot path |
| B004-16 | LOW | tcp_commands.ex | `run/1` — no catch-all clause; unexpected tuple raises `FunctionClauseError` |
| B004-17 | INFO | tcp_commands.ex | `[REDACTED-AWS-SMTP-PASSWORD]` alias unused |
| B004-18 | INFO | tcp.ex | Nine aliases unused (Repo, VXUser, VXThingEvent, etc.) |

<!-- B005.md -->
# Audit Report B005
**Audit run:** 2026-02-27-01
**Agent:** B005 (Pass 2)
**Scope:** Test coverage analysis for four source files in `lib/api_server/vx/`

---

## Source Files Audited

1. `lib/api_server/vx/device_database_lookup.ex`
2. `lib/api_server/vx/email.ex`
3. `lib/api_server/vx/equipment.ex`
4. `lib/api_server/vx/equipment_assignment.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/vx/device_database_lookup.ex`

**Module:** `ApiServer.Vx.DeviceDatabaseLookup`

**Behaviours/macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:** `"DeviceDatabaseLookup"` (line 6)
- Primary key: `{:ID, :id, autogenerate: true}` (line 5)

**Schema fields:**
| Field atom       | Type      | DB column      |
|-----------------|-----------|----------------|
| `:hardwareid`   | `:string` | `hardwareID`   |
| `:customer`     | `:string` | `databaseName` |
| `:custcode`     | `:string` | `CustCode`     |
| `:iccid`        | `:string` | `ICCID`        |

**Functions defined:**
| Name          | Arity | Line | Visibility |
|---------------|-------|------|------------|
| `changeset/2` | 2     | 13   | public     |

**`changeset/2` behaviour:**
- Casts all four fields: `:hardwareid`, `:customer`, `:custcode`, `:iccid`
- No `validate_required` or `unique_constraint` calls

---

### File 2: `lib/api_server/vx/email.ex`

**Module:** `ApiServer.Email`

**Behaviours/macros used:**
- `use Bamboo.Phoenix, view: ApiServer.EmailView` (line 2)

**Functions defined:**
| Name                          | Arity | Line | Visibility |
|-------------------------------|-------|------|------------|
| `send_notification_email/3`   | 3     | 4    | public     |
| `send_test_email/3`           | 3     | 14   | public     |
| `send_enter_email/4`          | 4     | 103  | public     |
| `send_missing_serial_email/4` | 4     | 167  | public     |
| `send_digital_matter_email/4` | 4     | 215  | public     |
| `send_slow_email/4`           | 4     | 262  | public     |
| `send_exit_email/4`           | 4     | 303  | public     |

**Key observations:**
- `send_notification_email/3` ignores the `to` parameter entirely — the recipient is hardcoded to `"graham.oconnell@trackingsolutions.com.au"` (line 7); the `to` argument is silently discarded.
- `send_test_email/3` also ignores the `to` parameter; recipient is hardcoded (line 16). The `message` parameter is unused (commented-out `text_body` call, line 18); the body is a static hardcoded HTML blob.
- `send_enter_email/4`, `send_exit_email/4`, `send_missing_serial_email/4`, `send_slow_email/4`, and `send_digital_matter_email/4` all use bare map field access on the `data` argument (e.g. `data.person_name`, `data.geofence_name`, etc.) with no nil-guard or pattern match, meaning any missing key causes a runtime `KeyError`.
- `send_digital_matter_email/4` uses `Kernel.inspect(data, limit: :infinity)` (line 227) to dump arbitrary data into HTML — intended as a debug helper.
- From address in `send_notification_email/3` is hardcoded to `"no-reply@mobilehourmeter.com"` regardless of caller intent.

---

### File 3: `lib/api_server/vx/equipment.ex`

**Module:** `ApiServer.Vx.Equipment`

**Behaviours/macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)
- `alias ApiServer.Vx` (line 5) — unused in this file

**Schema defined:** `"equipment"` (line 8)
- Primary key: `{:ID, :id, autogenerate: true}` (line 7)

**Schema fields:**
| Field atom       | Type            | DB column       |
|-----------------|-----------------|-----------------|
| `:id`            | `:integer`      | `id`            |
| `:name`          | `:string`       | `name`          |
| `:make`          | `:string`       | `make`          |
| `:model`         | `:string`       | `model`         |
| `:serial_number` | `:string`       | `serial_number` |
| `:class`         | `:string`       | `class`         |
| `:type`          | `:string`       | `type`          |
| `:created`       | `:utc_datetime` | `created`       |

**Functions defined:**
| Name          | Arity | Line | Visibility |
|---------------|-------|------|------------|
| `changeset/2` | 2     | 20   | public     |

**`changeset/2` behaviour:**
- Casts all eight fields
- `validate_required([:serial_number])` (line 23)
- `unique_constraint(:serial_number, name: :serial_number)` (line 24)

**Note:** `:id` is declared both as the primary key alias (`@primary_key {:ID, :id, ...}`) and as a regular schema field (line 9), which may cause a field collision at compile/runtime.

---

### File 4: `lib/api_server/vx/equipment_assignment.ex`

**Module:** `ApiServer.Vx.EquipmentAssignment`

**Behaviours/macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)
- `alias ApiServer.Vx` (line 5) — unused in this file

**Schema defined:** `"equipment_assignment"` (line 8)
- Primary key: `{:ID, :id, autogenerate: true}` (line 7)

**Schema fields:**
| Field atom                | Type            | DB column                  |
|--------------------------|-----------------|----------------------------|
| `:id`                    | `:integer`      | `id`                       |
| `:equipment_id`          | `:integer`      | `equipment_id`             |
| `:device_group`          | `:string`       | `device_group`             |
| `:device_group_timezone` | `:string`       | `device_group_timezone`    |
| `:assignment_start`      | `:utc_datetime` | `assignment_start`         |
| `:assignment_end`        | `:utc_datetime` | `assignment_end`           |
| `:created`               | `:utc_datetime` | `created`                  |

**Commented-out code:**
- `belongs_to :equipment, ApiServer.Vx.Equipment, ...` (line 17) — association commented out

**Functions defined:**
| Name          | Arity | Line | Visibility |
|---------------|-------|------|------------|
| `changeset/2` | 2     | 20   | public     |

**`changeset/2` behaviour:**
- Casts all seven fields
- `validate_required([:equipment_id, :device_group])` (line 23)
- `unique_constraint(:equipment_id)` (line 24)

---

## Test Coverage Search Results

Searches performed against `test/` for:
- Module names: `[REDACTED-AWS-SMTP-PASSWORD]`, `ApiServer.Email`, `ApiServer.Vx.Equipment`, `EquipmentAssignment`
- Function names: `send_notification_email`, `send_test_email`, `send_enter_email`, `send_exit_email`, `send_missing_serial_email`, `send_digital_matter_email`, `send_slow_email`
- Case-insensitive partial names: `device_database_lookup`, `equipment_assignment`, `equipment`

**Result: Zero matches in all searches.** None of the four source files are referenced anywhere in the test suite.

The existing test files (`calamp_controller_test.exs` is an empty stub; `vx_restriction_controller_test.exs` covers only `ApiServer.Vx.VXRestriction`; `layout_view_test.exs` and `page_view_test.exs` cover view modules) provide no coverage for any of the audited modules.

---

## Findings

---

### B005-1
**Severity:** HIGH
**File:** `lib/api_server/vx/device_database_lookup.ex`
**Finding:** No test file exists for `ApiServer.Vx.DeviceDatabaseLookup`. The module has no direct or indirect test coverage whatsoever.
**Detail:** The `changeset/2` function casts four fields but applies no `validate_required` or `unique_constraint` validations. No test verifies the changeset accepts valid attrs, produces an `%Ecto.Changeset{}`, or that cast works correctly against the non-standard column name mappings (`hardwareID`, `databaseName`, `CustCode`, `ICCID`).

---

### B005-2
**Severity:** HIGH
**File:** `lib/api_server/vx/email.ex`
**Finding:** No test file exists for `ApiServer.Email`. None of its seven public functions are exercised by any test in the repository.
**Detail:** This module is responsible for all outbound email construction. The complete absence of tests means no verification that email structs are built correctly, that recipients/subjects/bodies are set as expected, or that missing `data` map keys are handled safely.

---

### B005-3
**Severity:** HIGH
**File:** `lib/api_server/vx/equipment.ex`
**Finding:** No test file exists for `ApiServer.Vx.Equipment`. The module has no direct or indirect test coverage.
**Detail:** `changeset/2` applies `validate_required([:serial_number])` and `unique_constraint(:serial_number, ...)`. Neither the happy path (valid attrs), the required-field validation path (missing `:serial_number`), nor the unique-constraint path is tested.

---

### B005-4
**Severity:** HIGH
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Finding:** No test file exists for `ApiServer.Vx.EquipmentAssignment`. The module has no direct or indirect test coverage.
**Detail:** `changeset/2` applies `validate_required([:equipment_id, :device_group])` and `unique_constraint(:equipment_id)`. No test covers valid attrs, missing required fields, or the unique constraint behaviour.

---

### B005-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/email.ex`
**Function:** `send_notification_email/3` (line 4)
**Finding:** The `to` parameter is silently ignored. The recipient is hardcoded to `"graham.oconnell@trackingsolutions.com.au"` regardless of what the caller passes. No test exists to catch this regression, and the broken contract (caller-supplied `to` is never used) is invisible without test coverage.

---

### B005-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/email.ex`
**Function:** `send_test_email/3` (line 14)
**Finding:** Both the `to` parameter and the `message` parameter are silently discarded. The `to` recipient is hardcoded; the `message` argument is commented out and the body is a static HTML blob. No test verifies the function signature contract or that callers' arguments are (or are not) used.

---

### B005-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/email.ex`
**Functions:** `send_enter_email/4` (line 103), `send_exit_email/4` (line 303), `send_missing_serial_email/4` (line 167), `send_slow_email/4` (line 262)
**Finding:** All four functions access `data` map fields using bare dot-access (e.g. `data.person_name`, `data.geofence_name`, `data.vehicle_name`, `data.vehicle_serial`, `data.time_left`, `data.time_returned`, `data.time_out`, `data.usage_out`, `data.event_reference`, `data.customer`, `data.hardware_id`, `data.diff`). If any expected key is absent from `data`, the call raises a `KeyError` at runtime. No test covers this error path, and no guards or pattern matches validate the `data` map shape before use.

---

### B005-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/equipment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** The `validate_required([:serial_number])` path is untested. No test confirms that a changeset built without `:serial_number` returns `{:error, changeset}` with the expected error on `:serial_number`.

---

### B005-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** The `validate_required([:equipment_id, :device_group])` path is untested. No test confirms that omitting `:equipment_id` or `:device_group` produces a changeset with the appropriate validation errors.

---

### B005-10
**Severity:** MEDIUM
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** The `unique_constraint(:equipment_id)` is untested. The constraint relies on a database-level unique index, but no integration test inserts a duplicate `equipment_id` and verifies the changeset returns the expected constraint error.

---

### B005-11
**Severity:** MEDIUM
**File:** `lib/api_server/vx/equipment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** The `unique_constraint(:serial_number, name: :serial_number)` is untested. No test verifies that inserting a duplicate `serial_number` is translated into a changeset error rather than propagating a raw database exception.

---

### B005-12
**Severity:** LOW
**File:** `lib/api_server/vx/device_database_lookup.ex`
**Function:** `changeset/2` (line 13)
**Finding:** No edge-case tests for nil or empty string values for any of the four fields. The changeset applies no `validate_required`, so nil values are accepted silently. There is no test confirming this is intentional behaviour.

---

### B005-13
**Severity:** LOW
**File:** `lib/api_server/vx/equipment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** No test covers passing an empty string `""` for `:serial_number`. Ecto's `validate_required` passes for empty strings by default (only nil is rejected); there is no `validate_length` or `validate_format` guard. The empty-string case is untested and likely unintended.

---

### B005-14
**Severity:** LOW
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Function:** `changeset/2` (line 20)
**Finding:** No test covers the boundary case of `:assignment_end` being earlier than or equal to `:assignment_start`. The changeset does not validate temporal ordering, and this logic gap is undetected without tests.

---

### B005-15
**Severity:** LOW
**File:** `lib/api_server/vx/email.ex`
**Function:** `send_enter_email/4` (line 103), `send_exit_email/4` (line 303)
**Finding:** No test covers the case where string fields in `data` are `nil`. Because the function builds the HTML body via string concatenation (`<> data.field <>`), a nil value will raise a `Protocol.UndefinedError` for `String.Chars` at runtime. The nil path is entirely untested.

---

### B005-16
**Severity:** INFO
**File:** `lib/api_server/vx/equipment.ex`
**Finding:** `alias ApiServer.Vx` is declared at line 5 but never used within the module. This is dead code. No test exercises any cross-module interaction.

---

### B005-17
**Severity:** INFO
**File:** `lib/api_server/vx/equipment_assignment.ex`
**Finding:** `alias ApiServer.Vx` is declared at line 5 but never used within the module. The `belongs_to` association to `ApiServer.Vx.Equipment` is commented out (line 17). Both represent dead or deferred code with no test coverage to document intended behaviour.

---

### B005-18
**Severity:** INFO
**File:** `lib/api_server/vx/email.ex`
**Function:** `send_digital_matter_email/4` (line 215)
**Finding:** This function appears to be a debug/diagnostic utility (it renders the entire raw `data` term via `Kernel.inspect` in the email body). No test exists to confirm it is not called in production paths, and no test verifies its output structure or that `Kernel.inspect(data, limit: :infinity)` on large/deeply nested data does not cause excessive memory use.

---

## Summary Table

| ID      | Severity | File                         | Subject                                                        |
|---------|----------|------------------------------|----------------------------------------------------------------|
| B005-1  | HIGH     | device_database_lookup.ex    | No test file — zero coverage for module                        |
| B005-2  | HIGH     | email.ex                     | No test file — zero coverage for module (7 public functions)   |
| B005-3  | HIGH     | equipment.ex                 | No test file — zero coverage for module                        |
| B005-4  | HIGH     | equipment_assignment.ex      | No test file — zero coverage for module                        |
| B005-5  | MEDIUM   | email.ex                     | `send_notification_email/3` silently discards `to` parameter   |
| B005-6  | MEDIUM   | email.ex                     | `send_test_email/3` discards both `to` and `message` params    |
| B005-7  | MEDIUM   | email.ex                     | Bare map dot-access on `data` raises `KeyError` if key missing |
| B005-8  | MEDIUM   | equipment.ex                 | `validate_required(:serial_number)` error path untested        |
| B005-9  | MEDIUM   | equipment_assignment.ex      | `validate_required` error paths untested                       |
| B005-10 | MEDIUM   | equipment_assignment.ex      | `unique_constraint(:equipment_id)` untested                    |
| B005-11 | MEDIUM   | equipment.ex                 | `unique_constraint(:serial_number)` untested                   |
| B005-12 | LOW      | device_database_lookup.ex    | Nil/empty edge cases not tested, no required validation        |
| B005-13 | LOW      | equipment.ex                 | Empty string for `:serial_number` passes `validate_required`   |
| B005-14 | LOW      | equipment_assignment.ex      | No temporal ordering validation for assignment dates           |
| B005-15 | LOW      | email.ex                     | Nil string values in `data` cause `Protocol.UndefinedError`    |
| B005-16 | INFO     | equipment.ex                 | Unused `alias ApiServer.Vx`                                    |
| B005-17 | INFO     | equipment_assignment.ex      | Unused alias; commented-out `belongs_to` association           |
| B005-18 | INFO     | email.ex                     | `send_digital_matter_email/4` appears to be a debug utility    |

<!-- B006.md -->
# Audit Report B006
**Audit run:** 2026-02-27-01
**Auditor:** Pass 2 agent B006
**Scope:** `lib/api_server/vx/erp_import.ex`, `lib/api_server/vx/geofence.ex`, `lib/api_server/vx/mailer.ex`, `lib/api_server/vx/rental_contracts.ex`

---

## READING EVIDENCE

### 1. `lib/api_server/vx/erp_import.ex`

**Module:** `ApiServer.Vx.ERPImport`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined (`erp_imports` table):**
| Field | Type |
|---|---|
| `id` | `:id` (primary key, autogenerate) |
| `raw_record` | `:string` |
| `serialno` | `:string` |
| `name` | `:string` |
| `matched` | `:boolean` |
| `type` | `:string` |

**Functions defined:**
| Name | Line | Visibility |
|---|---|---|
| `changeset/2` | 15 | public |

**Constraints / validations in `changeset/2`:**
- `cast/3` on all five fields
- `validate_required/2` on `:raw_record` only

---

### 2. `lib/api_server/vx/geofence.ex`

**Module:** `ApiServer.Vx.Geofence`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)
- `import Ecto.Query, warn: false` (line 4)

**Aliases:**
- `ApiServer.Repo` (line 6)
- `ApiServer.Vx` (line 7)
- `ApiServer.Vx.VXThingEvent` (line 8)

**Schema defined (`geofences` table):**
| Field | Type |
|---|---|
| `id` | `:id` (primary key, autogenerate) |
| `name` | `:string` |
| `geojson` | `:string` |

**Functions defined:**
| Name | Line | Visibility |
|---|---|---|
| `changeset/2` | 17 | public |
| `geojson_map_to_string/1` | 24 | public |
| `geojson_db_string_to_map/1` | 38 | public |
| `does_event_cause_geofence_events_no_thing/5` | 52 | private |
| `check_event_for_left_events_no_thing/5` (nil guard clause) | 69 | private |
| `check_event_for_left_events_no_thing/5` (general clause) | 70 | private |
| `check_event_for_entered_events_no_thing/6` | 86 | private |
| `make_geofence_event_no_thing/5` | 103 | private |
| `engine_hours_at_event_no_thing/2` | 119 | private |

**Constraints / validations in `changeset/2`:**
- `cast/3` on `:name` and `:geojson`
- `validate_required/2` on `:name`

**Notable logic in private functions:**
- `engine_hours_at_event_no_thing/2`: pattern-matches `event.hardwaretype` on `1` (calcengineseconds/3600) or `2` (Omega, Repo query). No `_` catch-all — an unknown hardwaretype raises a `FunctionClauseError` at runtime.
- `check_event_for_left_events_no_thing/5` nil guard: returns a bare list `[]` instead of the expected two-tuple `{[], []}`, which is inconsistent with the general clause return type and the destructuring at line 63 (`{fences_still_inside, left_events}`).

---

### 3. `lib/api_server/vx/mailer.ex`

**Module:** `ApiServer.Mailer`

**Behaviours / macros used:**
- `use Bamboo.Mailer, otp_app: :api_server` (line 2)

**Functions defined:** None explicitly; all functions (`deliver_now/1`, `deliver_later/1`, etc.) are injected by the `Bamboo.Mailer` macro.

---

### 4. `lib/api_server/vx/rental_contracts.ex`

**Module:** `ApiServer.Vx.RentalContract`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined (`rental_contracts` table):**
| Field | Type | DB source column |
|---|---|---|
| `ID` | `:id` (primary key, autogenerate) | `id` |
| `id` | `:integer` | `id` |
| `equipment_id` | `:integer` | `equipment_id` |
| `customer_id` | `:integer` | `customer_id` |
| `contract_reference` | `:string` | `contract_reference` |
| `contract_start` | `:date` | `contract_start` |
| `contract_end` | `:date` | `contract_end` |
| `billing_frequency` | `:string` | `billing_frequency` |
| `hours_per_billing_period` | `:integer` | `hours_per_billing_period` |
| `cost_units` | `:string` | `cost_units` |
| `cost_per_unit` | `:float` | `cost_per_unit` |
| `reporting_frequency` | `:string` | `reporting_frequency` |
| `created` | `:utc_datetime` | `created` |
| `sent_to_rayven` | `:integer` | `sent_to_rayven` |

**Functions defined:**
| Name | Line | Visibility |
|---|---|---|
| `changeset/2` | 22 | public |

**Constraints / validations in `changeset/2`:**
- `cast/3` on all 13 non-primary-key fields
- No `validate_required/2` calls — all fields are optional

---

## FINDINGS

---

### B006-1
**Severity:** HIGH
**File:** `lib/api_server/vx/erp_import.ex`
**Finding:** No test file exists and no indirect test coverage was found for `ApiServer.Vx.ERPImport`. Searching the entire `test/` directory for `ERPImport` and `erp_import` returned zero results.

**Impact:** The `changeset/2` function — including its cast logic and the `validate_required(:raw_record)` constraint — is completely untested.

---

### B006-2
**Severity:** HIGH
**File:** `lib/api_server/vx/geofence.ex`
**Finding:** No test file exists and no indirect test coverage was found for `ApiServer.Vx.Geofence`. Searching the entire `test/` directory for `Geofence` and `geofence` returned zero results.

**Impact:** All public and private functions, including the geofence enter/exit event logic, are completely untested.

---

### B006-3
**Severity:** HIGH
**File:** `lib/api_server/vx/mailer.ex`
**Finding:** No test file exists and no indirect test coverage was found for `ApiServer.Mailer`. Searching `test/` for `Mailer` and `mailer` returned zero results.

**Impact:** Email delivery is exercised in multiple places in production code (`vx.ex`, `utility_controller.ex`, `digital_matter_controller.ex`); none of these call paths are tested. Bamboo provides a test adapter specifically for this purpose but it has not been configured or used.

---

### B006-4
**Severity:** HIGH
**File:** `lib/api_server/vx/rental_contracts.ex`
**Finding:** No test file exists and no indirect test coverage was found for `ApiServer.Vx.RentalContract`. Searching the entire `test/` directory for `RentalContract` and `rental_contract` returned zero results.

**Impact:** The `changeset/2` function is completely untested.

---

### B006-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `changeset/2` (line 17)
**Finding:** The `changeset/2` function has no test coverage. Specifically, no test verifies that:
- `:name` is required (should produce a validation error when absent).
- `:geojson` is optional (should be accepted when nil/absent).
- Invalid attribute keys are filtered by `cast/3`.

---

### B006-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `geojson_map_to_string/1` (line 24)
**Finding:** No test covers this public function. Callers in `geofence_controller.ex` (lines 21, 42) pass user-supplied maps directly to it. Untested paths include:
- A valid map that encodes successfully.
- A value that causes `Poison.encode/1` to return an error tuple (returns `""` silently — this silent failure is also a code-quality concern).
- A `nil` argument (returns `""` — valid but untested).

---

### B006-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `geojson_db_string_to_map/1` (line 38)
**Finding:** No test covers this public function. It is called from `geofence_view.ex` (line 18) and `vx.ex` (line 3238). Untested paths include:
- A valid JSON string that decodes successfully.
- A malformed JSON string causing `Poison.decode/1` to return an error tuple (returns `""` silently).
- A `nil` argument (returns `""`).

---

### B006-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/erp_import.ex`
**Function:** `changeset/2` (line 15)
**Finding:** No test verifies that `validate_required(:raw_record)` correctly rejects a changeset where `raw_record` is nil or absent, nor that the other four fields are accepted as optional.

---

### B006-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/rental_contracts.ex`
**Function:** `changeset/2` (line 22)
**Finding:** No test covers the `changeset/2` function. Notably, the function has no `validate_required/2` call at all — every field, including logically mandatory fields such as `equipment_id`, `customer_id`, and `contract_start`, is optional. This means a completely blank `RentalContract` can be inserted without an error from the changeset layer. This is untested and may represent a missing constraint.

---

### B006-10
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `engine_hours_at_event_no_thing/2` (line 119)
**Finding:** The private function pattern-matches only on `hardwaretype` values `1` and `2`. There is no catch-all (`_`) clause. Any event with a `hardwaretype` other than `1` or `2` will raise an unhandled `FunctionClauseError` at runtime. This code path has no test coverage.

---

### B006-11
**Severity:** MEDIUM
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `check_event_for_left_events_no_thing/5` (line 69, nil guard clause)
**Finding:** The nil guard clause on line 69 returns a bare `[]` (a list), not the two-tuple `{[], []}` that is expected by the destructuring assignment on line 63:
```elixir
{fences_still_inside, left_events} = check_event_for_left_events_no_thing(...)
```
This will cause a `MatchError` (`** (MatchError) no match of right hand side value: []`) at runtime whenever `in_geofences` is `nil`. Because there are no tests, this bug has not been caught.

---

### B006-12
**Severity:** LOW
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `geojson_map_to_string/1` (line 24) and `geojson_db_string_to_map/1` (line 38)
**Finding:** Both functions silently return an empty string `""` on encode/decode failure rather than propagating `{:error, reason}` or raising. No test asserts this silent-failure contract, so callers have no documented or verified guarantee about the return value on error.

---

### B006-13
**Severity:** LOW
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `geojson_map_to_string/1` (line 24)
**Finding:** The `event_time` assignment inside `does_event_cause_geofence_events_no_thing/5` (line 56–60) has a dead binding: `datetime = Map.get(adt, :after)` assigns to a local variable `datetime` that is never used; the expression result is discarded. This is likely a bug — the intent was probably `event_time = Map.get(adt, :after)` — but is undetected due to absence of tests.

---

### B006-14
**Severity:** LOW
**File:** `lib/api_server/vx/rental_contracts.ex`
**Schema:** `rental_contracts` (line 5–20)
**Finding:** The schema declares both a custom primary key `{:ID, :id, autogenerate: true}` (uppercase atom `:ID`) and a regular field `field :id, :integer, source: :id` (line 7) mapping to the same underlying database column (`id`). This creates a shadowing situation where `:id` as a virtual field and `:ID` as the primary key both reference the same column. No test verifies that reads and writes behave correctly, and the `changeset/2` casts `:id` as a regular attribute (line 24) which may conflict with Ecto's primary-key handling.

---

### B006-15
**Severity:** LOW
**File:** `lib/api_server/vx/geofence.ex`
**Function:** `changeset/2` (line 17)
**Finding:** No edge-case tests exist for boundary inputs:
- Empty string `""` for `:name` (passes `validate_required` but is semantically invalid).
- Extremely large GeoJSON strings for `:geojson`.
- `:geojson` supplied as a non-string type (e.g., a map) — Ecto's `:string` type would cast it, but the result is untested.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|---|---|---|---|
| B006-1 | HIGH | `erp_import.ex` | No test coverage whatsoever for `ApiServer.Vx.ERPImport` |
| B006-2 | HIGH | `geofence.ex` | No test coverage whatsoever for `ApiServer.Vx.Geofence` |
| B006-3 | HIGH | `mailer.ex` | No test coverage for `ApiServer.Mailer`; Bamboo test adapter not used |
| B006-4 | HIGH | `rental_contracts.ex` | No test coverage whatsoever for `ApiServer.Vx.RentalContract` |
| B006-5 | MEDIUM | `geofence.ex` | `changeset/2` — `validate_required(:name)` never tested |
| B006-6 | MEDIUM | `geofence.ex` | `geojson_map_to_string/1` — no tests; silent error return untested |
| B006-7 | MEDIUM | `geofence.ex` | `geojson_db_string_to_map/1` — no tests; silent error return untested |
| B006-8 | MEDIUM | `erp_import.ex` | `changeset/2` — `validate_required(:raw_record)` never tested |
| B006-9 | MEDIUM | `rental_contracts.ex` | `changeset/2` — no `validate_required` at all; blank record possible |
| B006-10 | MEDIUM | `geofence.ex` | `engine_hours_at_event_no_thing/2` — no catch-all clause; unknown hardwaretype crashes |
| B006-11 | MEDIUM | `geofence.ex` | `check_event_for_left_events_no_thing/5` nil clause returns `[]` not `{[], []}` — runtime `MatchError` |
| B006-12 | LOW | `geofence.ex` | Silent `""` return on JSON encode/decode failure — no test documents contract |
| B006-13 | LOW | `geofence.ex` | Dead binding `datetime =` in `does_event_cause_geofence_events_no_thing/5` (line 57) — likely bug |
| B006-14 | LOW | `rental_contracts.ex` | Dual `:ID`/`:id` primary-key + field mapping to same column; cast of `:id` may conflict with Ecto PK |
| B006-15 | LOW | `geofence.ex` | No edge-case tests for `changeset/2` (empty string name, oversized geojson, non-string geojson) |

<!-- B007.md -->
# Audit Report B007
**Audit run:** 2026-02-27-01
**Agent:** B007 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)

---

## Assigned Source Files

1. `lib/api_server/vx/rental_periods.ex`
2. `lib/api_server/vx/scheduler.ex`
3. `lib/api_server/vx/vx_user_function.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server/vx/rental_periods.ex`

**Module:** `ApiServer.Vx.RentalPeriod`

**Behaviours / Use:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined** (`rental_periods` table, line 6):
| Field          | Type           | DB Source       |
|----------------|----------------|-----------------|
| `ID`           | `:id`          | primary key (autogenerate: true) |
| `id`           | `:integer`     | `id`            |
| `contract_id`  | `:integer`     | `contract_id`   |
| `period_start` | `:date`        | `period_start`  |
| `period_end`   | `:date`        | `period_end`    |
| `hours_used`   | `:float`       | `hours_used`    |
| `overage`      | `:float`       | `overage`       |
| `is_completed` | `:integer`     | `is_completed`  |
| `created`      | `:utc_datetime`| `created`       |

**Custom primary key:** `@primary_key {:ID, :id, autogenerate: true}` (line 5)
Note: `id` is also declared as a regular field (line 7) alongside the custom primary key `:ID`. This is a schema inconsistency (duplicate integer-type field shadowing).

**Functions defined:**
| Name        | Visibility | Line | Description |
|-------------|------------|------|-------------|
| `changeset/2` | public   | 17   | Casts all fields; no `validate_required` call |

---

### File 2: `lib/api_server/vx/scheduler.ex`

**Module:** `ApiServer.Scheduler`

**Behaviours / Use:**
- `use Quantum.Scheduler, otp_app: :api_server` (lines 2-3)

**Functions defined:**
- None explicitly defined. All public API (`add_job/2`, `delete_job/1`, `find_job/1`, `jobs/0`, `activate_job/1`, `deactivate_job/1`, `run_job/1`, etc.) is generated by the `Quantum.Scheduler` macro at compile time.

**Constants / config:** None in-file; schedule configuration lives in `config/*.exs`.

---

### File 3: `lib/api_server/vx/vx_user_function.ex`

**Module:** `ApiServer.Vx.VXUserFunction`

**Behaviours / Use:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined** (`aat_user_functions` table, line 6):
| Field            | Type       | Notes                          |
|------------------|------------|--------------------------------|
| `aatid`          | `:id`      | primary key (autogenerate: true) |
| `aatfunction_id` | `:integer` | (line 7)                       |
| `aatuser_id`     | `:integer` | (line 8)                       |

**Associations:**
- `belongs_to :user, ApiServer.Vx.VXUser` — foreign key `:aatuser_id`, references `:aacid`, `define_field: false` (line 10)

**Functions defined:**
| Name          | Visibility | Line | Description |
|---------------|------------|------|-------------|
| `changeset/2` | public (doc: `@doc false`) | 14 | Casts `:aatuser_id` and `:aatfunctionid`; validates both required |

**Note — field name mismatch (bug indicator):** The schema declares `aatfunction_id` (line 7) but `changeset/2` casts and validates `:aatfunctionid` (line 16-17, missing the underscore before `id`). The cast atom `:aatfunctionid` does not match any declared schema field `:aatfunction_id`, meaning the cast silently does nothing for that field and `validate_required` will always fail for `:aatfunctionid`.

---

## Test Coverage Search Results

Grep searched `test/` for:
- `RentalPeriod`, `rental_period`, `rental_periods`, `changeset` (no matches in module context)
- `ApiServer.Scheduler`, `Quantum.Scheduler`, `Scheduler`, `scheduler`
- `VXUserFunction`, `VxUserFunction`, `vx_user_function`, `aat_user_functions`

**All searches returned zero matches.** None of the four known test files reference these modules.

**Known test files reviewed:**
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — no references to any of the three audited modules
- `test/api_server_web/controllers/calamp_controller_test.exs` — not checked for these modules (unrelated domain)
- `test/api_server_web/views/layout_view_test.exs` — unrelated
- `test/api_server_web/views/page_view_test.exs` — unrelated

---

## Findings

---

### B007-1
**Severity:** HIGH
**File:** `lib/api_server/vx/rental_periods.ex`
**Finding:** No test file exists for `ApiServer.Vx.RentalPeriod` and no indirect test coverage was found in the test suite. The schema and `changeset/2` function are entirely untested.

---

### B007-2
**Severity:** HIGH
**File:** `lib/api_server/vx/scheduler.ex`
**Finding:** No test file exists for `ApiServer.Scheduler` and no indirect test coverage was found in the test suite. The Quantum-generated scheduler functions (job management, scheduling lifecycle) are entirely untested.

---

### B007-3
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_user_function.ex`
**Finding:** No test file exists for `ApiServer.Vx.VXUserFunction` and no indirect test coverage was found in the test suite. The schema and `changeset/2` function are entirely untested.

---

### B007-4
**Severity:** MEDIUM
**File:** `lib/api_server/vx/rental_periods.ex`
**Function:** `changeset/2` (line 17)
**Finding:** `changeset/2` contains no `validate_required/2` call. None of the eight fields are declared required. There is no test exercising this function with invalid/empty attrs to confirm whether omitting required validation is intentional. The absence of any validation means an empty struct `%RentalPeriod{}` with no attributes will produce a valid changeset.

---

### B007-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_user_function.ex`
**Function:** `changeset/2` (line 14)
**Finding:** `changeset/2` casts and validates `:aatfunctionid` (no underscore), but the schema field is named `:aatfunction_id` (with underscore, line 7). The atom `:aatfunctionid` is not a declared schema field. Ecto's `cast/3` silently ignores unknown fields, so `aatfunction_id` values are never applied to the changeset, and `validate_required([:aatuser_id, :aatfunctionid])` will always produce a required-field error for `:aatfunctionid` since it can never be set. No test exists to catch this silent failure path.

---

### B007-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/rental_periods.ex`
**Finding:** No test exercises the duplicate field declaration: `@primary_key {:ID, :id, autogenerate: true}` (line 5) alongside `field :id, :integer, source: :id` (line 7). This declares `:ID` as the primary key and also declares a regular field `:id` mapped to the same database column `id`. The interaction between these two declarations is untested and may cause unexpected query or insertion behaviour.

---

### B007-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/scheduler.ex`
**Finding:** Quantum scheduler job execution paths are entirely untested. There is no test confirming that jobs configured in `config/*.exs` are properly wired, that job callbacks are invoked, or that the scheduler process starts and stops cleanly within the OTP supervision tree.

---

### B007-8
**Severity:** LOW
**File:** `lib/api_server/vx/rental_periods.ex`
**Function:** `changeset/2` (line 17)
**Finding:** Edge cases for date fields (`period_start`, `period_end`) are untested: no test covers nil dates, invalid date formats, or the case where `period_end` is before `period_start`. The changeset performs no cross-field validation for date ordering.

---

### B007-9
**Severity:** LOW
**File:** `lib/api_server/vx/rental_periods.ex`
**Function:** `changeset/2` (line 17)
**Finding:** Edge cases for float fields (`hours_used`, `overage`) are untested: no test covers negative values, zero, or very large floats, none of which are guarded by validation.

---

### B007-10
**Severity:** LOW
**File:** `lib/api_server/vx/vx_user_function.ex`
**Function:** `changeset/2` (line 14)
**Finding:** The `belongs_to :user` association (line 10) uses `define_field: false`, relying on the manually declared `aatuser_id` field. No test verifies that the foreign key constraint to `ApiServer.Vx.VXUser` (via `:aacid`) is honoured, or that preloading the `:user` association works correctly.

---

### B007-11
**Severity:** INFO
**File:** `lib/api_server/vx/vx_user_function.ex`
**Finding:** `changeset/2` is marked `@doc false` (line 13), indicating it is intentionally treated as an internal/private function by the module author, yet it is defined as a public function (`def`, not `defp`). This inconsistency is untested and undocumented in any existing test.

---

## Summary Table

| ID      | Severity | File                        | Description |
|---------|----------|-----------------------------|-------------|
| B007-1  | HIGH     | rental_periods.ex           | No test file; zero coverage for module |
| B007-2  | HIGH     | scheduler.ex                | No test file; zero coverage for module |
| B007-3  | HIGH     | vx_user_function.ex         | No test file; zero coverage for module |
| B007-4  | MEDIUM   | rental_periods.ex           | `changeset/2` has no `validate_required`; untested intentionality |
| B007-5  | MEDIUM   | vx_user_function.ex         | Field name typo `:aatfunctionid` vs `:aatfunction_id` causes silent cast failure; untested |
| B007-6  | MEDIUM   | rental_periods.ex           | Duplicate primary key / field `id` declaration; untested interaction |
| B007-7  | MEDIUM   | scheduler.ex                | Quantum job execution and OTP supervision paths untested |
| B007-8  | LOW      | rental_periods.ex           | Date field edge cases (nil, ordering) untested |
| B007-9  | LOW      | rental_periods.ex           | Float field edge cases (negative, zero) untested |
| B007-10 | LOW      | vx_user_function.ex         | `belongs_to` association and FK constraint untested |
| B007-11 | INFO     | vx_user_function.ex         | `@doc false` on public `changeset/2` inconsistency |

<!-- B008.md -->
# B008 — Audit Report: `lib/api_server/vx/vx.ex`

**Audit run:** 2026-02-27-01
**Agent:** Pass 2 / B008
**Source file:** `C:/Projects/cig-audit/repos/api_server/lib/api_server/vx/vx.ex`
**Total lines:** 3,315

---

## READING EVIDENCE

### Module Name

`ApiServer.Vx`

### Aliases / Dependencies Declared

- `ApiServer.Repo`
- `ApiServer.Vx.VXUser`
- `ApiServer.Vx.VXThingEvent`
- `ApiServer.Vx.VXThingEventOmega`
- `ApiServer.Vx.VXThingEventOmegaTires`
- `ApiServer.Vx.VXFleetAssociation`
- `ApiServer.Vx.VXRestriction`
- `ApiServer.Vx.Geofence`
- `ApiServer.Vx.VXThing`
- `ApiServer.Vx.VXRental`
- `ApiServer.Vx.VXAblRecord`
- `ApiServer.Vx.VXRayvenMessageLog`
- `ApiServer.Vx.VXRayvenStreamStatus`
- `ApiServer.Vx.Equipment`
- `ApiServer.Vx.EquipmentAssignment`
- `ApiServer.Vx.RentalContract`
- `ApiServer.Vx.RentalPeriod`
- `ApiServer.Vx.VXAccessFob` (alias inside module body, line 134)
- `ApiServer.Vx.VXFleet` (alias inside module body, line 220)
- `ApiServer.Vx.VXThingSummary` (alias inside module body, line 1448)
- `ApiServer.Vx.VXAblRecord` (re-aliased at line 2043)
- `ApiServer.Vx.VXCustomer` (alias at line 2860)
- `ApiServer.Vx.VXUserFunction` (alias at line 2969)
- `ApiServer.Vx.ERPImport` (alias at line 3187)

### Every Public Function Defined (with line number)

| # | Function | Arity | Line |
|---|----------|-------|------|
| 1 | `update_key_if_value/3` (2 clauses) | 3 | 27–30 |
| 2 | `list_vxusers/1` | 1 | 33 |
| 3 | `get_vx_user!/2` | 2 | 40 |
| 4 | `get_vx_user_offset/2` | 2 | 47 |
| 5 | `get_vx_user_fleets!/2` | 2 | 54 |
| 6 | `create_vx_user/2` | 2 | 75 |
| 7 | `update_vx_user/3` | 3 | 93 |
| 8 | `update_vx_user_password/3` | 3 | 99 |
| 9 | `delete_vx_user/2` | 2 | 117 |
| 10 | `change_vx_user/1` | 1 | 130 |
| 11 | `list_vxaccessfobs/0` | 0 | 145 |
| 12 | `get_vx_access_fob!/1` | 1 | 163 |
| 13 | `get_vx_access_fob_by_code!/1` | 1 | 165 |
| 14 | `get_vx_access_fobs_for_fleets!/1` | 1 | 177 |
| 15 | `get_vx_fleet_for_access_fob/1` | 1 | 189 |
| 16 | `get_num_vx_admin_fobs/0` | 0 | 198 |
| 17 | `get_vx_admin_fobs/0` | 0 | 199 |
| 18 | `delete_vx_access_fob/1` | 1 | 215 |
| 19 | `list_vxfleets/1` | 1 | 222 |
| 20 | `list_vxfleets/2` | 2 | 227 |
| 21 | `get_list_of_valid_fleets_for_user/2` | 2 | 235 |
| 22 | `get_list_of_valid_equipment_for_user/2` | 2 | 243 |
| 23 | `list_vxfleets_with_equipment/2` | 2 | 264 |
| 24 | `get_vx_fleet_by_name/2` | 2 | 290 |
| 25 | `get_vx_fleet/2` | 2 | 296 |
| 26 | `create_vx_fleet/2` | 2 | 315 |
| 27 | `update_vx_fleet/3` | 3 | 333 |
| 28 | `delete_vx_fleet/2` | 2 | 351 |
| 29 | `change_vx_fleet/1` | 1 | 364 |
| 30 | `update_fleet_assocs/3` | 3 | 378 |
| 31 | `get_equipment_in_fleet/2` | 2 | 392 |
| 32 | `get_hardwareids_in_fleet/2` | 2 | 400 |
| 33 | `get_fleets_for_thing/2` | 2 | 408 |
| 34 | `get_branch_for_thing/2` | 2 | 416 |
| 35 | `list_vxfleetassociations/0` | 0 | 427 |
| 36 | `get_vx_fleet_association!/1` | 1 | 449 |
| 37 | `delete_vx_fleet_association/1` | 1 | 464 |
| 38 | `list_vxthings/1` | 1 | 470 |
| 39 | `list_vxthings_full/1` | 1 | 478 |
| 40 | `list_vxthings_lite/1` | 1 | 492 |
| 41 | `list_vxthing/2` | 2 | 498 |
| 42 | `list_vxthing_full/2` | 2 | 507 |
| 43 | `list_vxthing_lite/2` | 2 | 520 |
| 44 | `list_vxthings/2` | 2 | 528 |
| 45 | `list_augmented_things/2` | 2 | 539 |
| 46 | `list_augmented_things_with_rentals/1` | 1 | 555 |
| 47 | `list_augmented_things_with_rentals_in_fleet/3` | 3 | 568 |
| 48 | `list_augmented_things_in_fleet/3` | 3 | 589 |
| 49 | `list_vxthings_in_fleet/2` | 2 | 608 |
| 50 | `list_vxthings_with_checklists/1` | 1 | 623 |
| 51 | `get_lift_event_counts_for_thing_by_day/5` | 5 | 631 |
| 52 | `get_detailed_lift_event_counts_for_thing_by_day/6` | 6 | 651 |
| 53 | `get_list_lift_event_counts_for_thing_by_day/6` | 6 | 677 |
| 54 | `get_detailed_lift_event_counts_for_fleet_by_day/5` | 5 | 699 |
| 55 | `get_omega_engine_utilization/5` | 5 | 726 |
| 56 | `get_omega_operation_summary/5` | 5 | 749 |
| 57 | `list_vxthings_for_map/2` (2 clauses, different arg semantics) | 2 | 780, 795 |
| 58 | `augment_thing_with_fleets/2` | 2 | 811 |
| 59 | `augment_thing_with_services/2` | 2 | 816 |
| 60 | `get_hour_meter_start_rental/2` | 2 | 827 |
| 61 | `augment_thing_with_rental_periods/2` | 2 | 871 |
| 62 | `augment_thing_with_usage/2` | 2 | 940 |
| 63 | `get_avg_weekly_hours/2` | 2 | 968 |
| 64 | `get_avg_weekly_hours/3` | 3 | 981 |
| 65 | `get_summary_total_usage/1` | 1 | 985 |
| 66 | `get_usage_since_service/2` | 2 | 1006 |
| 67 | `fetch_actual_usage/2` | 2 | 1030 |
| 68 | `generate_usage_select/2` | 2 | 1042 |
| 69 | `fetch_actual_usage/5` (clause: category 4) | 5 | 1090 |
| 70 | `fetch_actual_usage/5` (clause: category 2) | 5 | 1133 |
| 71 | `fetch_actual_usage/5` (clause: category 3) | 5 | 1174 |
| 72 | `fetch_actual_usage/5` (catch-all clause) | 5 | 1215 |
| 73 | `fetch_actual_usage_thing/4` | 4 | 1230 |
| 74 | `get_movements/5` | 5 | 1235 |
| 75 | `get_vx_thing!/1` | 1 | 1281 |
| 76 | `get_vx_thing!/2` | 2 | 1283 |
| 77 | `get_thing_name_with_hardware_id!/2` | 2 | 1290 |
| 78 | `get_fleet_name_with_id/2` | 2 | 1296 |
| 79 | `get_thing_category_with_hardware_id!/2` | 2 | 1303 |
| 80 | `get_thing_id_with_hardware_id!/2` | 2 | 1311 |
| 81 | `lookup_thing_with_name_serial/3` | 3 | 1319 |
| 82 | `lookup_thing_with_name/2` | 2 | 1328 |
| 83 | `get_vx_thing_with_hardware_id!/1` | 1 | 1337 |
| 84 | `get_vx_thing_with_hardware_id!/2` | 2 | 1347 |
| 85 | `get_augmented_thing_with_hardware_id!/2` | 2 | 1357 |
| 86 | `get_equipment_by_name/2` | 2 | 1363 |
| 87 | `get_equipment_by_serial/2` | 2 | 1371 |
| 88 | `get_equipment_assignments_by_id/2` | 2 | 1377 |
| 89 | `create_vx_thing/2` | 2 | 1395 |
| 90 | `update_vx_thing/3` | 3 | 1413 |
| 91 | `delete_vx_thing/1` | 1 | 1431 |
| 92 | `change_vx_thing/1` | 1 | 1444 |
| 93 | `list_vxthingsummaries/0` | 0 | 1459 |
| 94 | `get_vx_thing_summary!/1` | 1 | 1477 |
| 95 | `get_summary_for_hardwareid/2` | 2 | 1478 |
| 96 | `update_or_insert_summary/3` | 3 | 1484 |
| 97 | `create_vx_thing_summary/1` | 1 | 1501 |
| 98 | `update_vx_thing_summary/2` | 2 | 1519 |
| 99 | `delete_vx_thing_summary/1` | 1 | 1537 |
| 100 | `change_vx_thing_summary/1` | 1 | 1550 |
| 101 | `default_checklist_questions/0` | 0 | 1555 |
| 102 | `get_checklists/1` | 1 | 1586 |
| 103 | `list_vxthingevents/0` | 0 | 1622 |
| 104 | `get_vx_thing_event!/1` | 1 | 1640 |
| 105 | `get_most_recent_thingevent/2` | 2 | 1642 |
| 106 | `get_most_recent_thingevent_with_date/3` | 3 | 1651 |
| 107 | `get_most_recent_thingevent_with_omega/2` | 2 | 1660 |
| 108 | `get_thingevents_for_hardwareid/2` | 2 | 1673 |
| 109 | `get_thingevents_for_hardwareid/4` | 4 | 1680 |
| 110 | `create_vx_thing_event/2` | 2 | 1702 |
| 111 | `update_vx_thing_event/2` | 2 | 1720 |
| 112 | `delete_vx_thing_event/1` | 1 | 1738 |
| 113 | `change_vx_thing_event/1` | 1 | 1751 |
| 114 | `generate_avg_weekly_select/2` | 2 | 1755 |
| 115 | `convert_category_to_regular_units/2` | 2 | 1795 |
| 116 | `get_first_event/2` | 2 | 1824 |
| 117 | `get_actual_avg_weekly_hours/3` (clause: category 4) | 3 | 1842 |
| 118 | `get_actual_avg_weekly_hours/4` (clause: category 4, input=_) | 4 | 1879 |
| 119 | `get_actual_avg_weekly_hours/3` (clause: category 2) | 3 | 1916 |
| 120 | `get_actual_avg_weekly_hours/4` (clause: category 2, input=1) | 4 | 1952 |
| 121 | `get_actual_avg_weekly_hours/3` (clause: category 3) | 3 | 1988 |
| 122 | `get_actual_avg_weekly_hours/3` (catch-all) | 3 | 2026 |
| 123 | `list_service_records/1` | 1 | 2054 |
| 124 | `get_daily_usage/6` | 6 | 2100 |
| 125 | `get_impact_count_by_hardwareid/2` | 2 | 2170 |
| 126 | `get_events/5` | 5 | 2179 |
| 127 | `process_events/0` | 0 | 2192 |
| 128 | `process_events_subprocess/1` | 1 | 2547 |
| 129 | `get_vx_abl_record!/1` | 1 | 2611 |
| 130 | `create_vx_abl_record/1` | 1 | 2625 |
| 131 | `create_abl_record/2` | 2 | 2631 |
| 132 | `create_equipment_record/2` | 2 | 2637 |
| 133 | `get_equipment_id/2` | 2 | 2643 |
| 134 | `create_equipment_assignment_record/2` | 2 | 2650 |
| 135 | `update_vx_abl_record/2` | 2 | 2668 |
| 136 | `delete_vx_abl_record/1` | 1 | 2686 |
| 137 | `change_vx_abl_record/1` | 1 | 2699 |
| 138 | `get_rhm_user/3` | 3 | 2704 |
| 139 | `check_password/3` | 3 | 2712 |
| 140 | `get_rhm_user/2` | 2 | 2719 |
| 141 | `list_all_rentals/1` | 1 | 2730 |
| 142 | `list_open_rentals/1` | 1 | 2740 |
| 143 | `get_rental/2` | 2 | 2753 |
| 144 | `get_active_rental/2` | 2 | 2764 |
| 145 | `get_all_rentals_for_thing/2` | 2 | 2776 |
| 146 | `get_rental/4` | 4 | 2786 |
| 147 | `delete_rental/2` | 2 | 2798 |
| 148 | `update_rental/3` | 3 | 2802 |
| 149 | `create_rental_contract/2` | 2 | 2809 |
| 150 | `create_rental_period/2` | 2 | 2817 |
| 151 | `get_rental_periods_for_contract/2` | 2 | 2825 |
| 152 | `create_rental/2` | 2 | 2831 |
| 153 | `list_customers/1` | 1 | 2871 |
| 154 | `get_vx_customer!/2` | 2 | 2889 |
| 155 | `get_customer/3` | 3 | 2891 |
| 156 | `create_vx_customer/2` | 2 | 2916 |
| 157 | `update_vx_customer/3` | 3 | 2934 |
| 158 | `delete_vx_customer/2` | 2 | 2952 |
| 159 | `change_vx_customer/2` | 2 | 2965 |
| 160 | `list_vxaatuserfunctions/0` | 0 | 2980 |
| 161 | `get_vx_user_function!/1` | 1 | 2998 |
| 162 | `create_vx_user_function/1` | 1 | 3012 |
| 163 | `update_vx_user_function/2` | 2 | 3030 |
| 164 | `delete_vx_user_function/1` | 1 | 3048 |
| 165 | `change_vx_user_function/1` | 1 | 3061 |
| 166 | `list_vxaau_rest/0` | 0 | 3074 |
| 167 | `get_vx_restriction!/1` | 1 | 3092 |
| 168 | `create_vx_restriction/1` | 1 | 3106 |
| 169 | `add_fleet_to_user/3` | 3 | 3112 |
| 170 | `get_restriction/3` | 3 | 3124 |
| 171 | `remove_fleet_from_user/3` | 3 | 3132 |
| 172 | `update_vx_restriction/2` | 2 | 3150 |
| 173 | `delete_vx_restriction/1` | 1 | 3168 |
| 174 | `change_vx_restriction/1` | 1 | 3181 |
| 175 | `delete_erp_import/2` | 2 | 3189 |
| 176 | `create_erp_import/2` | 2 | 3193 |
| 177 | `update_erp_import/3` | 3 | 3199 |
| 178 | `check_for_existing_erp_record/2` | 2 | 3205 |
| 179 | `get_geofence_by_id/2` | 2 | 3223 |
| 180 | `get_geofences/1` | 1 | 3229 |
| 181 | `get_geofences_as_map/1` | 1 | 3234 |
| 182 | `create_geofence/2` | 2 | 3249 |
| 183 | `update_geofence/3` | 3 | 3255 |
| 184 | `delete_geofence/2` | 2 | 3261 |
| 185 | `create_thingevent_record/2` | 2 | 3265 |
| 186 | `update_thingevent_record/3` | 3 | 3271 |
| 187 | `delete_thingevent_record/2` | 2 | 3277 |
| 188 | `create_thingeventomega_record/2` | 2 | 3281 |
| 189 | `create_thingomegatires_record/2` | 2 | 3287 |
| 190 | `create_rayven_message_log_record/2` | 2 | 3293 |
| 191 | `update_rayven_stream_status_record/2` | 2 | 3299 |
| 192 | `count_rayven_events_to_stream/3` | 3 | 3305 |

**Private functions declared (not exhaustive — excluded from coverage requirements):**
- `daily_usage_where/2` (line 2062) — private (`defp`)

### Constants / Hard-coded Values Noted

- `get_num_vx_admin_fobs/0` returns integer `7` (line 198)
- `get_vx_admin_fobs/0` returns a hardcoded hex string of 7 fob codes (line 200)
- `default_checklist_questions/0` returns a 25-element list of hardcoded strings (line 1555)
- `process_events/0` hardcodes customer `"vx_cea"`, user_id `37`, and specific email addresses (lines 2196–2307)
- `augment_thing_with_rental_periods/2` hardcodes `from_date = "2019-01-01"`, `to_date = "2020-07-05"`, and `user_timezone = "US/Michigan"` (lines 874–879)

---

## TEST COVERAGE ANALYSIS

### Test files in the repository

```
test/api_server_web/controllers/calamp_controller_test.exs
test/api_server_web/controllers/vx_restriction_controller_test.exs
test/api_server_web/views/layout_view_test.exs
test/api_server_web/views/page_view_test.exs
test/test_helper.exs
```

### Indirect coverage found

`test/api_server_web/controllers/vx_restriction_controller_test.exs` aliases `ApiServer.Vx` and calls exactly **one** context function:
- `create_vx_restriction/1` (line 12, used as a test fixture)

The tests for the restriction controller also exercise the HTTP endpoints which internally call `list_vxaau_rest/0`, `get_vx_restriction!/1`, `create_vx_restriction/1`, `update_vx_restriction/2`, and `delete_vx_restriction/1` indirectly through the controller layer.

No other test file references `ApiServer.Vx` or any function from `vx.ex`.

---

## FINDINGS

---

### B008-1 — No dedicated test file exists for `ApiServer.Vx`

**Severity:** HIGH

**Location:** `lib/api_server/vx/vx.ex`

The largest and most complex context module in the codebase (3,315 lines, ~192 public functions across ~30 functional groups) has no dedicated unit test file. No `test/api_server/vx/vx_test.exs` or equivalent exists. The only test file that references this module is the HTTP-layer `vx_restriction_controller_test.exs`, which exercises at most five of the 192 public functions, all through controller dispatch rather than direct context calls.

---

### B008-2 — VXUser CRUD and query functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 27–132

The following public functions have no test coverage whatsoever:

- `update_key_if_value/3` (lines 27–30)
- `list_vxusers/1` (line 33)
- `get_vx_user!/2` (line 40)
- `get_vx_user_offset/2` (line 47)
- `get_vx_user_fleets!/2` (line 54)
- `create_vx_user/2` (line 75)
- `update_vx_user/3` (line 93)
- `update_vx_user_password/3` (line 99)
- `delete_vx_user/2` (line 117)
- `change_vx_user/1` (line 130)
- `get_rhm_user/3` (line 2704)
- `get_rhm_user/2` (line 2719)
- `check_password/3` (line 2712)

`check_password/3` is particularly sensitive: it compares a plaintext password field directly in SQL (`aacpassword: ^password`), and has no test verifying correct vs. incorrect password behaviour.

---

### B008-3 — VXAccessFob functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 145–217

- `list_vxaccessfobs/0` (line 145)
- `get_vx_access_fob!/1` (line 163)
- `get_vx_access_fob_by_code!/1` (line 165)
- `get_vx_access_fobs_for_fleets!/1` (line 177)
- `get_vx_fleet_for_access_fob/1` (line 189)
- `get_num_vx_admin_fobs/0` (line 198)
- `get_vx_admin_fobs/0` (line 199)
- `delete_vx_access_fob/1` (line 215)

`get_vx_fleet_for_access_fob/1` contains an unchecked field access (`fob.user.aaclic1issuer`) that will crash with a `NilPointerError`-equivalent if `fob` is `nil` (access fob not found) or if `fob.user` is `nil`. Neither error path is tested.

---

### B008-4 — VXFleet and VXFleetAssociation functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 222–466

- `list_vxfleets/1`, `list_vxfleets/2` (lines 222, 227)
- `get_list_of_valid_fleets_for_user/2` (line 235)
- `get_list_of_valid_equipment_for_user/2` (line 243)
- `list_vxfleets_with_equipment/2` (line 264)
- `get_vx_fleet_by_name/2` (line 290)
- `get_vx_fleet/2` (line 296)
- `create_vx_fleet/2` (line 315)
- `update_vx_fleet/3` (line 333)
- `delete_vx_fleet/2` (line 351)
- `change_vx_fleet/1` (line 364)
- `update_fleet_assocs/3` (line 378)
- `get_equipment_in_fleet/2` (line 392)
- `get_hardwareids_in_fleet/2` (line 400)
- `get_fleets_for_thing/2` (line 408)
- `get_branch_for_thing/2` (line 416)
- `list_vxfleetassociations/0` (line 427)
- `get_vx_fleet_association!/1` (line 449)
- `delete_vx_fleet_association/1` (line 464)
- `add_fleet_to_user/3` (line 3112)
- `get_restriction/3` (line 3124)
- `remove_fleet_from_user/3` (line 3132)

`update_fleet_assocs/3` performs a `delete_all` followed by `insert_all` with no transaction wrapping visible in the function; partial failure (delete succeeds, insert fails) leaves the fleet without any associations. This error path is untested.

`get_branch_for_thing/2` calls `List.first` on a query result, which will return `nil` if no branch fleet exists. Callers are not guarded against `nil` and this is untested.

---

### B008-5 — VXThing listing and augmentation functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 470–966

- `list_vxthings/1`, `list_vxthings/2` (lines 470, 528)
- `list_vxthings_full/1` (line 478)
- `list_vxthings_lite/1` (line 492)
- `list_vxthing/2`, `list_vxthing_full/2`, `list_vxthing_lite/2` (lines 498, 507, 520)
- `list_augmented_things/2` (line 539)
- `list_augmented_things_with_rentals/1` (line 555)
- `list_augmented_things_with_rentals_in_fleet/3` (line 568)
- `list_augmented_things_in_fleet/3` (line 589)
- `list_vxthings_in_fleet/2` (line 608)
- `list_vxthings_with_checklists/1` (line 623)
- `list_vxthings_for_map/2` (lines 780, 795 — two clauses with different argument semantics but same arity; distinguishable only at runtime by content)
- `augment_thing_with_fleets/2` (line 811)
- `augment_thing_with_services/2` (line 816)
- `augment_thing_with_usage/2` (line 940)
- `augment_thing_with_rental_periods/2` (line 871)
- `get_hour_meter_start_rental/2` (line 827)
- `get_vx_thing!/1`, `get_vx_thing!/2` (lines 1281, 1283)
- `get_thing_name_with_hardware_id!/2` (line 1290)
- `get_fleet_name_with_id/2` (line 1296)
- `get_thing_category_with_hardware_id!/2` (line 1303)
- `get_thing_id_with_hardware_id!/2` (line 1311)
- `lookup_thing_with_name_serial/3` (line 1319)
- `lookup_thing_with_name/2` (line 1328)
- `get_vx_thing_with_hardware_id!/1`, `get_vx_thing_with_hardware_id!/2` (lines 1337, 1347)
- `get_augmented_thing_with_hardware_id!/2` (line 1357)
- `get_equipment_by_name/2` (line 1363)
- `get_equipment_by_serial/2` (line 1371)
- `get_equipment_assignments_by_id/2` (line 1377)
- `create_vx_thing/2`, `update_vx_thing/3`, `delete_vx_thing/1`, `change_vx_thing/1` (lines 1395, 1413, 1431, 1444)

`list_vxthings_for_map/2` has two clauses with the same arity whose distinction is purely semantic (one takes `user_id`, the other `fleet_id`). Elixir will always dispatch to the first clause; the second clause (line 795) is unreachable in normal usage without additional pattern matching. This is a latent bug with no test coverage.

`augment_thing_with_rental_periods/2` (line 871) contains hardcoded date constants (`"2019-01-01"` and `"2020-07-05"`) that make the function's output stale and incorrect for any real usage past July 2020. No test validates this.

---

### B008-6 — Usage calculation functions (`fetch_actual_usage`, `get_actual_avg_weekly_hours`, `get_summary_total_usage`, `convert_category_to_regular_units`) entirely untested

**Severity:** MEDIUM

**Location:** Lines 985–2041

These are algorithmically complex functions with multiple pattern-matched clauses for different device categories (2, 3, 4, 5, 6, 7, 8, 9, 12, 13, 14):

- `get_summary_total_usage/1` (line 985): 8-branch `case` on `thing.aadcat`; no fallback clause — passing an unexpected category raises `CaseClauseError`
- `fetch_actual_usage/2` (line 1030)
- `generate_usage_select/2` (line 1042): 9-branch `case`; no default clause — unrecognised category raises `CaseClauseError`
- `fetch_actual_usage/5` — 4 clauses (lines 1090, 1133, 1174, 1215)
- `fetch_actual_usage_thing/4` (line 1230)
- `get_avg_weekly_hours/2`, `get_avg_weekly_hours/3` (lines 968, 981)
- `get_actual_avg_weekly_hours/3` — 4 clauses (lines 1842, 1916, 1988, 2026)
- `get_actual_avg_weekly_hours/4` — 2 clauses (lines 1879, 1952)
- `convert_category_to_regular_units/2` (line 1795)
- `generate_avg_weekly_select/2` (line 1755): 8-branch `case`; no default clause — unrecognised category raises `CaseClauseError`
- `get_first_event/2` (line 1824)

The `fetch_actual_usage/5` clauses for categories 2, 3, and 4 use destructured single-element list pattern matches (`[min] = ...` and `[max] = ...`). If the database query returns more than one aggregate row, these will raise `MatchError`. This is untested.

---

### B008-7 — Lift event, Omega engine, and daily usage query functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 631–777, 2100–2177

- `get_lift_event_counts_for_thing_by_day/5` (line 631)
- `get_detailed_lift_event_counts_for_thing_by_day/6` (line 651)
- `get_list_lift_event_counts_for_thing_by_day/6` (line 677)
- `get_detailed_lift_event_counts_for_fleet_by_day/5` (line 699)
- `get_omega_engine_utilization/5` (line 726)
- `get_omega_operation_summary/5` (line 749)
- `get_daily_usage/6` (line 2100)
- `get_impact_count_by_hardwareid/2` (line 2170)
- `get_events/5` (line 2179)
- `get_movements/5` (line 1235)

All functions accept date-range arguments via ISO8601 strings. Invalid date strings (e.g., `"not-a-date"`) will raise `ArgumentError` from `Date.from_iso8601!` with no error handling. None of these paths are tested.

---

### B008-8 — VXThingEvent and VXThingSummary CRUD functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 1459–1553, 1622–1753

- `list_vxthingsummaries/0` (line 1459)
- `get_vx_thing_summary!/1` (line 1477)
- `get_summary_for_hardwareid/2` (line 1478)
- `update_or_insert_summary/3` (line 1484)
- `create_vx_thing_summary/1` (line 1501)
- `update_vx_thing_summary/2` (line 1519)
- `delete_vx_thing_summary/1` (line 1537)
- `change_vx_thing_summary/1` (line 1550)
- `list_vxthingevents/0` (line 1622)
- `get_vx_thing_event!/1` (line 1640)
- `get_most_recent_thingevent/2` (line 1642)
- `get_most_recent_thingevent_with_date/3` (line 1651)
- `get_most_recent_thingevent_with_omega/2` (line 1660)
- `get_thingevents_for_hardwareid/2` (line 1673)
- `get_thingevents_for_hardwareid/4` (line 1680)
- `create_vx_thing_event/2` (line 1702)
- `update_vx_thing_event/2` (line 1720)
- `delete_vx_thing_event/1` (line 1738)
- `change_vx_thing_event/1` (line 1751)
- `create_thingevent_record/2` (line 3265)
- `update_thingevent_record/3` (line 3271)
- `delete_thingevent_record/2` (line 3277)
- `create_thingeventomega_record/2` (line 3281)
- `create_thingomegatires_record/2` (line 3287)

---

### B008-9 — Rental, RentalContract, and RentalPeriod functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 2728–2858

- `list_all_rentals/1` (line 2730)
- `list_open_rentals/1` (line 2740)
- `get_rental/2` (line 2753)
- `get_active_rental/2` (line 2764)
- `get_all_rentals_for_thing/2` (line 2776)
- `get_rental/4` (line 2786)
- `delete_rental/2` (line 2798)
- `update_rental/3` (line 2802)
- `create_rental_contract/2` (line 2809)
- `create_rental_period/2` (line 2817)
- `get_rental_periods_for_contract/2` (line 2825)
- `create_rental/2` (line 2831)

`get_active_rental/2` uses `Ecto.Query.limit(1)` with `Repo.one`, which will raise if the query somehow returns more than one row. No test covers the case where a thing has multiple open rentals. `list_open_rentals/1` uses `or_where` in a way that returns rentals with a `nil` end date OR an end date in the future; the interaction between these two conditions is non-obvious and untested.

---

### B008-10 — VXCustomer, VXUserFunction CRUD functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 2860–3063

- `list_customers/1` (line 2871)
- `get_vx_customer!/2` (line 2889)
- `get_customer/3` (line 2891)
- `create_vx_customer/2` (line 2916)
- `update_vx_customer/3` (line 2934)
- `delete_vx_customer/2` (line 2952)
- `change_vx_customer/2` (line 2965)
- `list_vxaatuserfunctions/0` (line 2980)
- `get_vx_user_function!/1` (line 2998)
- `create_vx_user_function/1` (line 3012)
- `update_vx_user_function/2` (line 3030)
- `delete_vx_user_function/1` (line 3048)
- `change_vx_user_function/1` (line 3061)

---

### B008-11 — Geofence, ERPImport, Rayven, Equipment, and ABL record functions entirely untested

**Severity:** MEDIUM

**Location:** Lines 2043–2060, 2611–2701, 3187–3312

- `list_service_records/1` (line 2054)
- `get_vx_abl_record!/1` (line 2611)
- `create_vx_abl_record/1` (line 2625)
- `create_abl_record/2` (line 2631)
- `update_vx_abl_record/2` (line 2668)
- `delete_vx_abl_record/1` (line 2686)
- `change_vx_abl_record/1` (line 2699)
- `create_equipment_record/2` (line 2637)
- `get_equipment_id/2` (line 2643)
- `create_equipment_assignment_record/2` (line 2650)
- `delete_erp_import/2` (line 3189)
- `create_erp_import/2` (line 3193)
- `update_erp_import/3` (line 3199)
- `check_for_existing_erp_record/2` (line 3205)
- `get_geofence_by_id/2` (line 3223)
- `get_geofences/1` (line 3229)
- `get_geofences_as_map/1` (line 3234)
- `create_geofence/2` (line 3249)
- `update_geofence/3` (line 3255)
- `delete_geofence/2` (line 3261)
- `create_rayven_message_log_record/2` (line 3293)
- `update_rayven_stream_status_record/2` (line 3299)
- `count_rayven_events_to_stream/3` (line 3305)

`get_geofences_as_map/1` (line 3234) performs destructuring `[coord_block | _] = geomap["coordinates"]` and `fn([long, lat]) -> {long, lat} end` that will raise `MatchError` / `FunctionClauseError` on malformed GeoJSON. No test covers invalid or empty coordinate blocks.

`check_for_existing_erp_record/2` (line 3205) has a customer-specific code branch for `"vx_cea"` that filters differently from all other customers. The distinct logic paths are untested.

---

### B008-12 — `process_events/0` and `process_events_subprocess/1` untested; contain hardcoded production credentials

**Severity:** MEDIUM

**Location:** Lines 2192–2594

- `process_events/0` (line 2192)
- `process_events_subprocess/1` (line 2547)

Both functions are completely untested. `process_events/0` contains:
- Hardcoded customer tenant `"vx_cea"` (line 2196)
- Hardcoded user ID `37` (line 2198)
- Hardcoded production email addresses including personal names and addresses (lines 2306, 2357, 2417, 2477)
- Deep conditional nesting (~10 levels) with multiple `IO.puts` debug statements still present

`process_events_subprocess/1` has an inline comment on line 2548 stating "I don't think this is used anymore", yet the function remains public and untested.

---

### B008-13 — Checklist functions return stub/mock data; untested and not production-ready

**Severity:** MEDIUM

**Location:** Lines 1555–1609

- `default_checklist_questions/0` (line 1555)
- `get_checklists/1` (line 1586)

`get_checklists/1` ignores its `hardwareid` argument entirely and returns four hardcoded static checklist records with `DateTime.utc_now()` timestamps and fixed answer arrays. It does not query the database. There is no test verifying this stub behaviour or that callers handle it correctly.

---

### B008-14 — VXRestriction context functions partially tested only at HTTP layer

**Severity:** MEDIUM

**Location:** Lines 3074–3183

`create_vx_restriction/1`, `get_vx_restriction!/1`, `list_vxaau_rest/0`, `update_vx_restriction/2`, and `delete_vx_restriction/1` are exercised only through the HTTP controller test, which uses the test database default schema (no `prefix:` / tenant). The following functions are entirely untested even at the HTTP layer:

- `add_fleet_to_user/3` (line 3112) — inserts a `VXRestriction` with a tenant prefix
- `get_restriction/3` (line 3124)
- `remove_fleet_from_user/3` (line 3132)
- `change_vx_restriction/1` (line 3181)

---

### B008-15 — No test for invalid/nil category in `get_summary_total_usage/1` and `generate_usage_select/2`

**Severity:** LOW

**Location:** Lines 985, 1042

`get_summary_total_usage/1` has a `case thing.aadcat do` with clauses for values `2`–`9` but no `_` fallback. An unknown category value (e.g., category `1`, `10`, `11`, or any future category) raises `CaseClauseError`. Similarly, `generate_usage_select/2` handles categories `12`, `13`, `14`, `5`–`9` but omits category `2`, `3`, and `4` (which are handled by other `fetch_actual_usage` clauses) and has no default. No edge-case test exists for any unexpected category.

---

### B008-16 — No test for nil/empty inputs in date-range functions

**Severity:** LOW

**Location:** Lines 631, 651, 677, 699, 726, 749, 2100, 2179

Functions such as `get_lift_event_counts_for_thing_by_day/5`, `get_daily_usage/6`, and `get_events/5` call `Date.from_iso8601!/1` (bang variant) which will raise `ArgumentError` if passed `nil`, an empty string, or a non-ISO8601 string. No validation or rescue is present, and no test exercises these error paths.

---

### B008-17 — `augment_thing_with_usage/2` hardcodes timezone `"+10:00"`

**Severity:** LOW

**Location:** Line 950

`augment_thing_with_usage/2` hardcodes `user_timezone = "+10:00"` when computing `this_week` and `this_month` usage windows, regardless of the actual user's timezone. This means `this_week` and `this_month` fields returned to all users are computed in AEST regardless of their actual location. No test validates this behaviour or catches the regression risk.

---

## SUMMARY TABLE

| ID | Severity | Description |
|----|----------|-------------|
| B008-1 | HIGH | No dedicated test file for `ApiServer.Vx` (~192 public functions, 3,315 lines) |
| B008-2 | MEDIUM | VXUser CRUD, query, and authentication functions (13 functions) entirely untested |
| B008-3 | MEDIUM | VXAccessFob functions (8 functions) entirely untested; nil-crash risk in `get_vx_fleet_for_access_fob/1` |
| B008-4 | MEDIUM | VXFleet and VXFleetAssociation functions (21 functions) entirely untested; non-transactional `update_fleet_assocs/3` |
| B008-5 | MEDIUM | VXThing listing, lookup, and augmentation functions (~30 functions) untested; unreachable second clause in `list_vxthings_for_map/2`; hardcoded stale dates in `augment_thing_with_rental_periods/2` |
| B008-6 | MEDIUM | Usage calculation functions (12+ clauses) entirely untested; multiple `CaseClauseError` risks on unknown categories; destructured aggregate match risk |
| B008-7 | MEDIUM | Lift event, Omega, daily usage, movements, and impact query functions (10 functions) entirely untested; no date string validation |
| B008-8 | MEDIUM | VXThingEvent and VXThingSummary CRUD functions (24 functions) entirely untested |
| B008-9 | MEDIUM | Rental, RentalContract, and RentalPeriod functions (12 functions) entirely untested |
| B008-10 | MEDIUM | VXCustomer and VXUserFunction CRUD functions (13 functions) entirely untested |
| B008-11 | MEDIUM | Geofence, ERPImport, Rayven, Equipment, and ABL record functions (24 functions) entirely untested; GeoJSON malformed-input crash risk; `check_for_existing_erp_record/2` customer-branch logic untested |
| B008-12 | MEDIUM | `process_events/0` and `process_events_subprocess/1` untested; hardcoded production emails and tenant; stale debug `IO.puts` |
| B008-13 | MEDIUM | `get_checklists/1` returns hardcoded stub data ignoring its argument; no test or note that it is a stub |
| B008-14 | MEDIUM | VXRestriction context tested only via HTTP layer; `add_fleet_to_user/3`, `get_restriction/3`, `remove_fleet_from_user/3`, `change_vx_restriction/1` untested |
| B008-15 | LOW | No fallback clause in `get_summary_total_usage/1` and `generate_usage_select/2`; unknown categories raise uncaught `CaseClauseError` |
| B008-16 | LOW | No nil/empty-string guard on `Date.from_iso8601!` calls in all date-range query functions |
| B008-17 | LOW | `augment_thing_with_usage/2` hardcodes timezone `"+10:00"` for all users |

<!-- B009.md -->
# Audit Report B009
**Audit Run:** 2026-02-27-01
**Pass:** 2
**Agent:** B009
**Date:** 2026-02-27

## Assigned Source Files

1. `lib/api_server/vx/vx_abl_record.ex`
2. `lib/api_server/vx/vx_access_fob.ex`
3. `lib/api_server/vx/vx_customer.ex`
4. `lib/api_server/vx/vx_fleet.ex`

---

## Reading Evidence

### File 1: `lib/api_server/vx/vx_abl_record.ex`

**Module:** `ApiServer.Vx.VXAblRecord`

**Schema / Struct:**
- Table: `abl_data_changes`
- Primary key: `ablid` (`:id`, autogenerate: true)
- Fields:
  - `:abldatetime` (`:utc_datetime`)
  - `:ablcustcode` (`:string`)
  - `:abluser` (`:string`)
  - `:abllogtype` (`:string`)
  - `:ablusragnt` (`:string`)
  - `:ablip_address` (`:string`)
  - `:abltable` (`:string`)
  - `:ablaction` (`:string`)
  - `:ablimagetype` (`:string`)
  - `:ablimage` (`:string`)
  - `:ablprocessed` (`:string`)
- Association: `belongs_to :user, ApiServer.Vx.VXUser` (foreign_key: `:abluser`, references: `:aacuser`, define_field: false)

**Functions defined:**

| Line | Visibility | Name / Arity |
|------|-----------|--------------|
| 25   | public    | `changeset/2` |
| 31   | public    | `generate_service/10` |
| 54   | public    | `clean_xml_value/1` |
| 63   | public    | `clean_xml_number_value/1` |
| 72   | public    | `expand_xml_to_struct/1` |

**Notable logic in `expand_xml_to_struct/1`:**
- Calls `XmlToMap.naive_map/1` on `abl_record.ablimage`
- Parses `hardwareid` via `Integer.parse/1` with three case branches: `:error`, `{value, _}`, and `_` (catch-all)
- The `{value, _}` branch has a dead-code `if` at lines 80-84: both branches return `value` identically, making the length check a no-op

**Notable logic in `generate_service/10`:**
- Builds an XML string and calls `Vx.create_abl_record/2`
- `estimated_service_date` and `estimated_service_hours` are hardcoded to `""` (lines 32-33)
- Returns the `:ok` or `:error` atom from `create_abl_record`

---

### File 2: `lib/api_server/vx/vx_access_fob.ex`

**Module:** `ApiServer.Vx.VXAccessFob`

**Schema / Struct:**
- Table: `access_fobs`
- Primary key: default (`:id`)
- Fields:
  - `:fob_code` (`:string`)
- Association: `belongs_to :user, ApiServer.Vx.VXUser` (foreign_key: `:assigned_to_user`, references: `:aacid`)

**Functions defined:** None (schema-only module, no functions beyond Ecto-generated callbacks)

---

### File 3: `lib/api_server/vx/vx_customer.ex`

**Module:** `ApiServer.Vx.VXCustomer`

**Schema / Struct:**
- Table: `aaa_customers`
- Primary key: `aaaid` (`:id`, autogenerate: true)
- Fields:
  - `:aaaaddr1`, `:aaaaddr2`, `:aaaaddr3` (`:string`)
  - `:aaacolour` (`:string`)
  - `:aaaname` (`:string`)
  - `:aaapcode` (`:string`)
  - `:aaaprimcont` (`:string`)
  - `:aaaprimemail` (`:string`)
  - `:aaaprimtel` (`:string`)
  - `:aaatz` (`:string`)
  - `:aaaudfcustcode` (`:string`)
  - `:aaacustcode` (`:string`)
- Association: `belongs_to :rental, ApiServer.Vx.VXRental` (foreign_key: `:aaaid`, references: `:abhcustomerid`, primary_key: true, define_field: false)

**Functions defined:**

| Line | Visibility | Name / Arity |
|------|-----------|--------------|
| 25   | public    | `convert_json_to_changeset/1` |
| 43   | public    | `changeset/2` |

**Notable logic in `convert_json_to_changeset/1`:**
- Derives `:aaacustcode` from `customer_json["name"]` via a chain: `String.reverse/1` -> `String.replace/2` -> `String.slice/2` -> `String.upcase/1` (line 36)
- This will raise a `FunctionClauseError` if `customer_json["name"]` is `nil` (all String functions reject nil)

**Notable logic in `changeset/2`:**
- Validates `validate_required([:aaaname])`
- Applies `unique_constraint(:aaacustcode, name: :UQ1)`

---

### File 4: `lib/api_server/vx/vx_fleet.ex`

**Module:** `ApiServer.Vx.VXFleet`

**Schema / Struct:**
- Table: `aae_group`
- Primary key: `aaeid` (`:id`, autogenerate: true)
- Fields:
  - `:aaecustcode` (`:string`)
  - `:aaedesc` (`:string`)
  - `:aaecolour` (`:string`)
  - `:aaetype` (`:integer`)
  - `:aaeshowfilter` (`:boolean`)
- Association: `has_many :fleet_thing_joins, ApiServer.Vx.VXFleetAssociation` (foreign_key: `:aafgroupid`, on_delete: `:delete_all`)

**Functions defined:**

| Line | Visibility | Name / Arity |
|------|-----------|--------------|
| 19   | public    | `convert_json_to_changeset/1` |
| 27   | public    | `changeset/2` |

**Notable logic in `changeset/2`:**
- Validates `validate_required([:aaedesc])`
- No unique constraints

---

## Test Coverage Search Results

Searches performed against `test/` directory for:
- Module names: `VXAblRecord`, `VXAccessFob`, `VXCustomer`, `VXFleet`, `VxAblRecord`, `VxAccessFob`, `VxCustomer`, `VxFleet`
- Snake-case variants: `vx_abl_record`, `vx_access_fob`, `vx_customer`, `vx_fleet`
- Function names: `generate_service`, `clean_xml_value`, `clean_xml_number_value`, `expand_xml_to_struct`, `convert_json_to_changeset`
- Table names: `abl_data_changes`, `access_fobs`, `aaa_customers`, `aae_group`

**Result: Zero matches found in any test file for any of the above terms.**

The four known test files (`calamp_controller_test.exs`, `vx_restriction_controller_test.exs`, `layout_view_test.exs`, `page_view_test.exs`) contain no references to these modules or their functions.

---

## Findings

---

### B009-1
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Finding:** No test file exists for module `ApiServer.Vx.VXAblRecord` and no indirect test coverage was found anywhere in the test suite.

This module contains five public functions including complex XML-building logic (`generate_service/10`), XML-parsing logic (`expand_xml_to_struct/1`), and two utility helpers (`clean_xml_value/1`, `clean_xml_number_value/1`). The module is actively called from `vx_abl_record_controller.ex` and `vx.ex`. None of these code paths are exercised by any test.

---

### B009-2
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_access_fob.ex`
**Finding:** No test file exists for module `ApiServer.Vx.VXAccessFob` and no indirect test coverage was found anywhere in the test suite.

While the module itself is schema-only (no custom functions), the schema mapping and association (`belongs_to :user` via `assigned_to_user` / `aacid`) are never exercised in tests. Any regression in field mappings or association configuration would go undetected.

---

### B009-3
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_customer.ex`
**Finding:** No test file exists for module `ApiServer.Vx.VXCustomer` and no indirect test coverage was found anywhere in the test suite.

Both public functions (`convert_json_to_changeset/1` and `changeset/2`) are called from `vx_customer_controller.ex` and `vx.ex` respectively but are entirely untested.

---

### B009-4
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_fleet.ex`
**Finding:** No test file exists for module `ApiServer.Vx.VXFleet` and no indirect test coverage was found anywhere in the test suite.

Both public functions (`convert_json_to_changeset/1` and `changeset/2`) are called from `vx_fleet_controller.ex` and `vx.ex` respectively but are entirely untested.

---

### B009-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `generate_service/10` (line 31)
**Finding:** The `generate_service/10` function has no test exercising it.

This function accepts ten parameters, builds an XML string, and delegates persistence to `Vx.create_abl_record/2`. The function returns the status atom (`:ok` or `:error`) from that call. No test covers:
- The happy path where `create_abl_record` returns `{:ok, _}`
- The failure path where `create_abl_record` returns `{:error, _}`
- The XML structure produced (field ordering, special characters in interpolated values)

---

### B009-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `expand_xml_to_struct/1` (line 72)
**Finding:** The `expand_xml_to_struct/1` function has no test exercising it.

This function parses free-form XML stored in `ablimage`. No test covers:
- Malformed or empty XML input (would raise from `XmlToMap.naive_map/1`)
- A `hardwareid` that parses successfully vs. one that returns `:error`
- Fields missing from the XML document (missing keys return `nil` via `clean_xml_value`)
- The `_` catch-all branch of the `Integer.parse` case (line 85), which is unreachable given `Integer.parse/1` only returns `:error` or `{integer, remainder}`, making the branch dead code

---

### B009-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `changeset/2` (line 25)
**Finding:** The `changeset/2` function has no test exercising it.

There are no tests for valid attribute casting or for verifying which fields are accepted by the cast. The `ablcustcode` field is declared in the schema but is absent from the `cast/3` field list in the changeset, meaning it can never be set through a changeset — this silent omission is untested.

---

### B009-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_customer.ex`
**Function:** `convert_json_to_changeset/1` (line 25)
**Finding:** The `convert_json_to_changeset/1` function has no test exercising it.

No test covers:
- A fully populated JSON map (happy path)
- A JSON map with missing optional keys (nil values passed to `Vx.update_key_if_value/3`)
- The `"name"` key being absent or nil — line 36 applies `String.reverse/1` directly to the value, which will raise `FunctionClauseError` if `customer_json["name"]` is `nil`

---

### B009-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_customer.ex`
**Function:** `changeset/2` (line 43)
**Finding:** The `changeset/2` function has no test exercising it.

No test covers:
- Missing required field `:aaaname` (should produce a validation error)
- Duplicate `:aaacustcode` triggering the `unique_constraint` named `:UQ1`
- Valid full attribute cast

---

### B009-10
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_fleet.ex`
**Function:** `convert_json_to_changeset/1` (line 19)
**Finding:** The `convert_json_to_changeset/1` function has no test exercising it.

No test covers:
- A fully populated JSON map
- A JSON map with nil values for any key (delegated to `Vx.update_key_if_value/3`)
- Type coercion of `:aaetype` (integer) or `:aaeshowfilter` (boolean) from JSON string representations

---

### B009-11
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_fleet.ex`
**Function:** `changeset/2` (line 27)
**Finding:** The `changeset/2` function has no test exercising it.

No test covers:
- Missing required field `:aaedesc` (should produce a validation error)
- Valid attribute casting including integer and boolean fields
- The `aaecustcode` field is declared in the schema but absent from the `cast/3` field list, silently making it uncastable via changeset — untested

---

### B009-12
**Severity:** LOW
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `clean_xml_value/1` (line 54)
**Finding:** The `clean_xml_value/1` helper has no test exercising it.

No edge cases are tested:
- Input of `%{}` (the empty map sentinel) — should return `nil`
- Input of a normal string value — should pass through unchanged
- Input of `nil`, `0`, `false`, or other falsy values — these will pass through the `true ->` branch, but the intent may be to also sanitize these

---

### B009-13
**Severity:** LOW
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `clean_xml_number_value/1` (line 63)
**Finding:** The `clean_xml_number_value/1` helper has no test exercising it.

No edge cases are tested:
- Input of `%{}` — should return `0`
- Input of a valid integer — should pass through unchanged
- Input of `nil` — passes through unchanged (returns `nil`), which may be incorrect for a "number value" cleaner

---

### B009-14
**Severity:** LOW
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `expand_xml_to_struct/1` (line 72)
**Finding:** Dead code branch at lines 80-84 is untested and unreachable.

Inside the `Integer.parse` case, the `{value, _}` branch contains:
```elixir
if length(Integer.digits(value)) >= 10 do
  value
else
  value
end
```
Both arms return `value` identically, making the condition a no-op. This dead code suggests an incomplete implementation (the original intent was likely to handle large IDs differently). No test documents the intended behaviour.

---

### B009-15
**Severity:** LOW
**File:** `lib/api_server/vx/vx_customer.ex`
**Function:** `convert_json_to_changeset/1` (line 36)
**Finding:** The `aaacustcode` derivation from `customer_json["name"]` is not tested for boundary cases.

The derivation reverses the name, removes spaces, takes the first 9 characters, and uppercases the result. No test covers:
- A name shorter than 9 characters after removing spaces
- A name consisting entirely of spaces (produces an empty string after `String.replace`, then `String.slice` and `String.upcase` of `""`)
- Unicode/multi-byte characters in the name where `String.slice` operates on graphemes

---

### B009-16
**Severity:** LOW
**File:** `lib/api_server/vx/vx_abl_record.ex`
**Function:** `generate_service/10` (line 31)
**Finding:** `estimated_service_date` and `estimated_service_hours` are hardcoded to empty strings.

Lines 32-33 set these to `""` unconditionally and embed them in the XML payload. This appears to be unfinished functionality. The parameters are not represented in the function signature, suggesting either placeholder logic or a regression from a refactor. No test documents whether this is intentional.

---

## Summary Table

| ID     | Severity | File                    | Subject                                      |
|--------|----------|-------------------------|----------------------------------------------|
| B009-1 | HIGH     | vx_abl_record.ex        | No test file or indirect coverage            |
| B009-2 | HIGH     | vx_access_fob.ex        | No test file or indirect coverage            |
| B009-3 | HIGH     | vx_customer.ex          | No test file or indirect coverage            |
| B009-4 | HIGH     | vx_fleet.ex             | No test file or indirect coverage            |
| B009-5 | MEDIUM   | vx_abl_record.ex        | `generate_service/10` untested               |
| B009-6 | MEDIUM   | vx_abl_record.ex        | `expand_xml_to_struct/1` untested            |
| B009-7 | MEDIUM   | vx_abl_record.ex        | `changeset/2` untested                       |
| B009-8 | MEDIUM   | vx_customer.ex          | `convert_json_to_changeset/1` untested       |
| B009-9 | MEDIUM   | vx_customer.ex          | `changeset/2` untested                       |
| B009-10| MEDIUM   | vx_fleet.ex             | `convert_json_to_changeset/1` untested       |
| B009-11| MEDIUM   | vx_fleet.ex             | `changeset/2` untested                       |
| B009-12| LOW      | vx_abl_record.ex        | `clean_xml_value/1` edge cases untested      |
| B009-13| LOW      | vx_abl_record.ex        | `clean_xml_number_value/1` edge cases untested|
| B009-14| LOW      | vx_abl_record.ex        | Dead code branch in `expand_xml_to_struct/1` |
| B009-15| LOW      | vx_customer.ex          | `aaacustcode` derivation boundary cases      |
| B009-16| LOW      | vx_abl_record.ex        | Hardcoded empty strings in `generate_service`|

**Total findings: 16**
**HIGH: 4 | MEDIUM: 7 | LOW: 5**

<!-- B010.md -->
# Audit Report B010
**Audit run:** 2026-02-27-01
**Agent:** Pass 2 / B010
**Scope:** `lib/api_server/vx/vx_fleet_association.ex`, `lib/api_server/vx/vx_rayven_message_log.ex`, `lib/api_server/vx/vx_rayven_stream_status.ex`, `lib/api_server/vx/vx_rental.ex`

---

## READING EVIDENCE

### 1. `ApiServer.Vx.VXFleetAssociation`
**File:** `lib/api_server/vx/vx_fleet_association.ex`

**Macros/Callbacks defined:**
- `use Ecto.Schema` (line 5) — injects Ecto schema macros

**Schema defined:** `aaf_groups_things` (line 8)
- Primary key: `aafid` (`:id`, autogenerate: true) — line 7
- Field: `aafcustcode` (`:string`) — line 9
- Association: `belongs_to :fleet` → `ApiServer.Vx.VXFleet`, foreign_key `:aafgroupid`, references `:aaeid` — line 10
- Association: `belongs_to :thing` → `ApiServer.Vx.VXThing`, foreign_key `:aafthingid`, references `:aadid` — line 11

**Public functions defined:** none (schema only; no `changeset/2` or query functions)

**Top-level requires (outside module):**
- `require Ecto.Query` (line 1)
- `require Ecto.Adapters.SQL` (line 2)

---

### 2. `ApiServer.Vx.VXRayvenMessageLog`
**File:** `lib/api_server/vx/vx_rayven_message_log.ex`

**Macros/Callbacks defined:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:** `rayven_message_log` (line 6)
- Primary key: `message_id` (`:id`, autogenerate: true) — line 5
- Field: `message_direction` (`:string`) — line 7
- Field: `message_type` (`:string`) — line 8
- Field: `hardware_id` (`:integer`) — line 9
- Field: `event_id` (`:integer`) — line 10
- Field: `response` (`:string`) — line 11
- Field: `message` (`:string`) — line 12
- Field: `created` (`:utc_datetime`) — line 13

**Public functions defined:**
- `changeset/2` (line 16) — casts `[:message_direction, :message_type, :hardware_id, :event_id, :response, :message]`

**Notable omissions:** `created` field is NOT included in the cast list; no `validate_required` calls.

---

### 3. `ApiServer.Vx.VXRayvenStreamStatus`
**File:** `lib/api_server/vx/vx_rayven_stream_status.ex`

**Macros/Callbacks defined:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:** `rayven_stream_status` (line 6)
- Primary key: `id` (`:id`, autogenerate: true) — line 5
- Field: `thing_id` (`:integer`) — line 7
- Field: `hardware_id` (`:integer`) — line 8
- Field: `last_event` (`:integer`) — line 9
- Field: `last_event_time` (`:utc_datetime`) — line 10
- Field: `streamed_at` (`:utc_datetime`) — line 11
- Field: `delay` (`:integer`) — line 12
- Field: `num_remaining` (`:integer`) — line 13
- Field: `batch` (`:integer`) — line 14

**Public functions defined:**
- `changeset/2` (line 17) — casts all eight fields; no `validate_required` calls

---

### 4. `ApiServer.Vx.VXRental`
**File:** `lib/api_server/vx/vx_rental.ex`

**Macros/Callbacks defined:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema defined:** `abh_rentals` (line 6)
- Primary key: `abhid` (`:id`, autogenerate: true) — line 5
- Field: `abhcustcode` (`:string`) — line 7
- Field: `abhclient` (`:string`) — line 8
- Field: `abhstartdate` (`:date`) — line 9
- Field: `abhenddate` (`:date`) — line 10
- Field: `abhtransdate` (`:utc_datetime`) — line 11
- Field: `abhnotes` (`:string`) — line 12
- Field: `abhrental_freq` (`:string`) — line 13
- Field: `abhallowed_hours` (`:integer`) — line 14
- Field: `abhreport_freq` (`:string`) — line 15
- Field: `abhcustomerid` (`:integer`) — line 16
- Field: `period_calculation` (`:string`) — line 17
- Association: `has_one :customer` → `ApiServer.Vx.VXCustomer`, foreign_key `:aaaid`, references `:abhcustomerid` — line 19
- Association: `belongs_to :thing` → `ApiServer.Vx.VXThing`, foreign_key `:abhthingid`, references `:aadid` — line 20

**Public functions defined:**
- `get_all_anniversaries_between_dates/4` (line 24) — computes list of period anniversary dates between two date strings; dispatches on `period_calculation` ("CALENDAR" vs other) and `abhrental_freq`
- `get_current_rental_period_start/2` (line 112) — returns period start datetime for the current moment in the given timezone
- `calculate_period_end_date/3` (line 119) — shifts a period start datetime forward by one rental frequency unit; handles "28DAY", "MONTHLY", "OTHER", "WEEKLY", "DAILY", "OUT OF CONTRACT", and a default fallback
- `has_anniversary_on_day?/3` (line 146) — returns boolean; true if the given day coincides with a period start
- `generate_previous_period_anniversay/3` (line 246) — public; returns the previous period start date; handles all `abhrental_freq` values with complex end-of-contract edge cases
- `changeset/2` (line 158) — casts rental fields; no `validate_required`

**Private functions defined:**
- `get_all_subsequent_anniversaries/5` (line 77) — recursive tail-accumulation of anniversary list, stops at `to_datetime` or rental end date
- `generate_next_period_anniversay/3` (line 176) — computes next period boundary from a given datetime, respecting `period_calculation` and `abhenddate`
- `calculate_period_start_date/3` (line 468) — returns period start for an arbitrary check datetime; dispatches on all `abhrental_freq` values and `period_calculation`

---

## TEST COVERAGE SEARCH RESULTS

Grep for module names (`VXFleetAssociation`, `VXRayvenMessageLog`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXRental`) across `test/` — **zero matches**.

Grep for public function names (`get_all_anniversaries_between_dates`, `get_current_rental_period_start`, `calculate_period_end_date`, `has_anniversary_on_day`, `generate_previous_period_anniversay`, `changeset`) across `test/` — **zero matches** for any of these functions in connection with the audited modules.

The only test files present in the repository are:
- `test/api_server_web/controllers/calamp_controller_test.exs` — empty module body
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — tests `VXRestriction` only
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`

None of these files reference or indirectly exercise any of the four audited modules.

---

## FINDINGS

### B010-1 — HIGH: `VXFleetAssociation` has no test file and no indirect test coverage

**File:** `lib/api_server/vx/vx_fleet_association.ex`
**Severity:** HIGH

No direct test file exists for `ApiServer.Vx.VXFleetAssociation`. No test in the repository exercises this module at all (confirmed by full grep of test directory for the module name and file name). The schema defines foreign-key associations to both `VXFleet` and `VXThing` that are never exercised by automated tests.

---

### B010-2 — HIGH: `VXRayvenMessageLog` has no test file and no indirect test coverage

**File:** `lib/api_server/vx/vx_rayven_message_log.ex`
**Severity:** HIGH

No direct test file exists for `ApiServer.Vx.VXRayvenMessageLog`. No test in the repository exercises this module. The `changeset/2` function, the schema fields, and the primary-key configuration are entirely untested.

---

### B010-3 — HIGH: `[REDACTED-AWS-SMTP-PASSWORD]` has no test file and no indirect test coverage

**File:** `lib/api_server/vx/vx_rayven_stream_status.ex`
**Severity:** HIGH

No direct test file exists for `ApiServer.Vx.VXRayvenStreamStatus`. No test in the repository exercises this module. The `changeset/2` function and all schema fields are entirely untested.

---

### B010-4 — HIGH: `VXRental` has no test file and no indirect test coverage

**File:** `lib/api_server/vx/vx_rental.ex`
**Severity:** HIGH

No direct test file exists for `ApiServer.Vx.VXRental`. No test in the repository exercises this module despite it being the most functionally complex module in the assigned set. All five public functions and two private functions (totalling hundreds of lines of business logic for rental period calculation) are entirely untested.

---

### B010-5 — MEDIUM: `get_all_anniversaries_between_dates/4` — no test coverage for any code path

**File:** `lib/api_server/vx/vx_rental.ex`, line 24
**Severity:** MEDIUM

This function is used in `vx.ex` (line 882) and `utility_controller.ex` (lines 2172, 3727) and `vx_rental_controller.ex` (line 119). It contains two separate top-level `cond` branches (one for `"CALENDAR"`, one for all other `period_calculation` values), each with three sub-branches (contract starts before period, contract starts after period, contract starts during period). None of these branches are tested.

---

### B010-6 — MEDIUM: `generate_previous_period_anniversay/3` — no test coverage for any code path

**File:** `lib/api_server/vx/vx_rental.ex`, line 246
**Severity:** MEDIUM

This public function is called from `vx.ex` (line 885), `utility_controller.ex` (lines 2181, 3736), and `vx_rental_controller.ex` (lines 67, 122). It contains complex branch logic for every `abhrental_freq` value ("28DAY", "MONTHLY", "OTHER", "WEEKLY", "DAILY", "OUT OF CONTRACT", and a catch-all). The `"MONTHLY"` and `"WEEKLY"` arms each contain nested `period_calculation`-based branches and end-of-contract boundary logic. None of this is tested.

---

### B010-7 — MEDIUM: `calculate_period_end_date/3` — no test coverage for any code path

**File:** `lib/api_server/vx/vx_rental.ex`, line 119
**Severity:** MEDIUM

This public function is called from `utility_controller.ex` (lines 4182, 4345) and `vx_rental_controller.ex` (line 218). It dispatches on six distinct `abhrental_freq` values plus a default. None of these arms are tested.

---

### B010-8 — MEDIUM: `has_anniversary_on_day?/3` — no test coverage for any code path

**File:** `lib/api_server/vx/vx_rental.ex`, line 146
**Severity:** MEDIUM

This public function is called from `vx_rental_controller.ex` (line 65). It delegates to `calculate_period_start_date/3` and computes a day-level diff. Neither the `true` nor `false` return path is tested.

---

### B010-9 — MEDIUM: `get_current_rental_period_start/2` — no test coverage

**File:** `lib/api_server/vx/vx_rental.ex`, line 112
**Severity:** MEDIUM

This public function is called from `vx_rental_controller.ex` (lines 18, 38, 218) and `utility_controller.ex` (lines 4175, 4338). It relies on `Timex.now/1` (wall-clock time) internally, making it time-dependent and requiring mocking or careful fixture setup; no such test exists.

---

### B010-10 — MEDIUM: `VXRental.changeset/2` — no validation tests; `validate_required` absent

**File:** `lib/api_server/vx/vx_rental.ex`, line 158
**Severity:** MEDIUM

`changeset/2` casts eleven fields but performs no `validate_required/2` or any other validation. This means invalid or incomplete structs silently pass changeset validation. There are no tests confirming which fields are required or what constitutes an invalid rental struct. Same issue exists for `VXRayvenMessageLog.changeset/2` (line 16) and `VXRayvenStreamStatus.changeset/2` (line 17).

---

### B010-11 — MEDIUM: `VXRayvenMessageLog.changeset/2` omits `created` field from cast — untested

**File:** `lib/api_server/vx/vx_rayven_message_log.ex`, line 16-19
**Severity:** MEDIUM

The `created` field is declared in the schema (line 13) but is not included in the `cast/3` call. This means `created` can never be set through the changeset. Whether this is intentional (e.g., set at the database level) or an oversight is not documented, and there is no test that would catch a regression if the field were added or removed from the cast list.

---

### B010-12 — MEDIUM: `generate_next_period_anniversay/3` (private) — complex rental end-date capping logic untested

**File:** `lib/api_server/vx/vx_rental.ex`, line 176
**Severity:** MEDIUM

This private function is called by both `get_all_anniversaries_between_dates/4` and `get_all_subsequent_anniversaries/5`. It contains a conditional that clamps the next anniversary to `rental_end_datetime` when the computed next period would exceed the end date (lines 235-243). This capping behaviour is business-critical but never tested.

---

### B010-13 — LOW: `get_all_anniversaries_between_dates/4` — nil/boundary edge cases untested

**File:** `lib/api_server/vx/vx_rental.ex`, line 24
**Severity:** LOW

The following edge cases are unexercised by any test:
- `rental.abhenddate == nil` (open-ended contract) through the full anniversary generation loop
- `to_date` equal to `from_date` (single-day range)
- `rental.abhstartdate` exactly equal to `from_date` or `to_date`
- Invalid ISO 8601 date strings passed as `to_date`/`from_date` (the function calls `Date.from_iso8601!/1` which raises on bad input)

---

### B010-14 — LOW: `calculate_period_start_date/3` — "MONTHLY"/"CONTRACT" branch and unrecognised `period_calculation` value untested

**File:** `lib/api_server/vx/vx_rental.ex`, line 468
**Severity:** LOW

The `"MONTHLY"` arm at line 490 handles both `"CALENDAR"` and `"CONTRACT"` `period_calculation` values, but neither is tested. The `"WEEKLY"` arm uses `Timex.weekday/1` comparison arithmetic (line 590) without tests for week-boundary wrap-around. The default (`_`) arm at line 606 silently falls through to weekly logic; no test documents this behaviour.

---

### B010-15 — LOW: `VXFleetAssociation` has top-level `require` statements outside the module

**File:** `lib/api_server/vx/vx_fleet_association.ex`, lines 1-2
**Severity:** LOW

`require Ecto.Query` and `require Ecto.Adapters.SQL` appear at the top of the file, outside the module definition. These requires affect the entire compilation unit but appear to be unused inside the module (there are no query functions defined). This is a code-quality concern: the requires suggest query functions were planned or removed, and there are no tests to document the intended behaviour of this module beyond schema definition.

---

### B010-16 — LOW: `generate_previous_period_anniversay/3` — note on typo in public API name

**File:** `lib/api_server/vx/vx_rental.ex`, line 246
**Severity:** LOW (INFO)

The public function is spelled `generate_previous_period_anniversay` (missing the last `r` in "anniversary"). The same misspelling appears on the private `generate_next_period_anniversay/3` (line 176). Because these names are referenced across multiple callers in `vx.ex`, `utility_controller.ex`, and `vx_rental_controller.ex`, a rename would require coordinated updates. The absence of any test means this inconsistency has gone undetected and any future renaming would have no safety net.

---

## SUMMARY TABLE

| ID      | Severity | File                          | Description |
|---------|----------|-------------------------------|-------------|
| B010-1  | HIGH     | vx_fleet_association.ex       | No test file; zero test coverage |
| B010-2  | HIGH     | vx_rayven_message_log.ex      | No test file; zero test coverage |
| B010-3  | HIGH     | vx_rayven_stream_status.ex    | No test file; zero test coverage |
| B010-4  | HIGH     | vx_rental.ex                  | No test file; zero test coverage for all business logic |
| B010-5  | MEDIUM   | vx_rental.ex:24               | `get_all_anniversaries_between_dates/4` untested |
| B010-6  | MEDIUM   | vx_rental.ex:246              | `generate_previous_period_anniversay/3` untested |
| B010-7  | MEDIUM   | vx_rental.ex:119              | `calculate_period_end_date/3` untested |
| B010-8  | MEDIUM   | vx_rental.ex:146              | `has_anniversary_on_day?/3` untested |
| B010-9  | MEDIUM   | vx_rental.ex:112              | `get_current_rental_period_start/2` untested; time-dependent |
| B010-10 | MEDIUM   | vx_rental.ex:158 (and others) | `changeset/2` has no `validate_required`; untested |
| B010-11 | MEDIUM   | vx_rayven_message_log.ex:16   | `created` field omitted from `changeset/2` cast; untested |
| B010-12 | MEDIUM   | vx_rental.ex:176              | `generate_next_period_anniversay/3` end-date capping untested |
| B010-13 | LOW      | vx_rental.ex:24               | `get_all_anniversaries_between_dates/4` nil/boundary cases |
| B010-14 | LOW      | vx_rental.ex:468              | `calculate_period_start_date/3` MONTHLY CONTRACT branch and default untested |
| B010-15 | LOW      | vx_fleet_association.ex:1-2   | Top-level `require` outside module; unused; no tests documenting intent |
| B010-16 | LOW      | vx_rental.ex:176,246          | Consistent typo in public/private function names; no test safety net |

<!-- B011.md -->
# Audit Report B011
**Audit run:** 2026-02-27-01
**Agent:** B011 (Pass 2)
**Assigned source files:**
- `lib/api_server/vx/vx_restriction.ex`
- `lib/api_server/vx/vx_thing.ex`
- `lib/api_server/vx/vx_thing_event.ex`
- `lib/api_server/vx/vx_thing_event_omega.ex`

---

## Reading Evidence

### File 1: `lib/api_server/vx/vx_restriction.ex`

**Module:** `ApiServer.Vx.VXRestriction`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema:** `"aau_rest"` (line 6)
- Primary key: `aauid` (`:id`, autogenerate: true)
- Fields:
  - `aaucharval` — `:string` (line 7)
  - `aaucustcode` — `:string` (line 8)
  - `aaufun` — `:string` (line 9)
  - `aaunumval` — `:integer` (line 10)
- Associations:
  - `belongs_to :user, ApiServer.Vx.VXUser` — foreign key `aauuser_id`, references `aacid` (line 12)

**Public functions defined:**
| Function | Line | Notes |
|---|---|---|
| `changeset/2` | 16 | Casts `[:aauuser_id, :aaucustcode, :aaufun, :aaucharval, :aaunumval]`; `validate_required([:aauuser_id])` |

---

### File 2: `lib/api_server/vx/vx_thing.ex`

**Module:** `ApiServer.Vx.VXThing`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 6)
- `import Ecto.Changeset` (line 7)
- `alias ApiServer.Vx` (line 8)
- `require Ecto.Query` (line 1)
- `require Ecto.Adapters.SQL` (line 2)

**Schema:** `"aad_thing"` (line 11)
- Primary key: `aadid` (`:id`, autogenerate: true)
- Fields (lines 12–48): `aadcustcode`, `aaddesc`, `aadintext`, `aadaddr`, `aadcustomerid`, `aadcat`, `aadhardwareid`, `aadhw_type`, `aadmake`, `aadmodel`, `aadserialno`, `aadmobile`, `aadimei`, `aadhourmeter`, `aadhourmeter1`–`aadhourmeter4`, `aadhourmeterprnt`, `aadodometer`, `aadhourmeteromega`, `aadhourmeterothcan`, `aaddateintoservice`, `aadlastservice`, `aadvalid`, `aadserviceoffset`, `aadsvchrs`, `aadrange_lat`, `aadrange_long`, `aadrange_dist`, `aadrange_unit`, `service_calculation_input`, `reference_1`, `reference_2`, `reference_3`, `notes`, `equipment_date_into_service`
- Associations:
  - `has_many :fleet_thing_joins` — `ApiServer.Vx.VXFleetAssociation` (line 50)
  - `has_many :rentals` — `ApiServer.Vx.VXRental` (line 51)
  - `has_many :events` — `ApiServer.Vx.VXThingEvent` (line 52)
  - `has_one :summary` — `ApiServer.Vx.VXThingSummary` (line 55)
  - `has_one :info` — `ApiServer.Vx.VXThingInfo` (line 56)
  - `has_one :customer` — `ApiServer.Vx.VXCustomer` (line 57)

**Public functions defined:**
| Function | Line | Notes |
|---|---|---|
| `convert_json_to_changeset/1` | 60 | Builds a bare map `%{}` from a JSON-shaped map using `Vx.update_key_if_value/3` pipeline; returns the map (not an Ecto changeset struct) |
| `changeset/2` | 75 | Casts a fixed subset of fields; no `validate_required` call |

---

### File 3: `lib/api_server/vx/vx_thing_event.ex`

**Module:** `ApiServer.Vx.VXThingEvent`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema:** `"thingevents"` (line 5)
- Primary key: implicit `id` (default Ecto integer)
- Fields (lines 6–51): `gmtdatetime`, `hardwareid`, `eventtype`, `eventcode`, `latitude`, `longitude`, `driverid`, `engineonelapsed`, `totalengineseconds`, `custcode`, `hardwaretype`, `datetimesaved`, `dateinqueue`, `timeoffix`, `altitude`, `heading`, `speed`, `rssi`, `gpsfixquality`, `odometer`, `mifaredriverid`, `ignition`, `ignitionstatus`, `calcengineseconds`, `input1elapsed`–`input4elapsed` (with status/totalseconds/calctotalseconds variants), `prntelapsed`, `prntstatus`, `prnttotalseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `geofence`
- Commented-out field: `llpoint` (Geo.Point) (line 52)
- Associations:
  - `has_one :thingeventomega, ApiServer.Vx.VXThingEventOmega` — foreign key `:id`, references `:id` (line 54)
  - `belongs_to :thing, ApiServer.Vx.VXThing` — foreign key `:hardwareid`, references `:aadhardwareid`, `define_field: false` (lines 56–60)

**Public functions defined:**
| Function | Line | Notes |
|---|---|---|
| `map_xml/1` | 71 | Maps a raw string-keyed map (from XML parse) to a typed Elixir map suitable for insertion; uses `String.to_integer/1`, `String.to_float/1`, `DateTime.from_naive!/2`, `NaiveDateTime.from_iso8601!/1`; hardcodes `rhmprestartchecklist: ""` and `geofence: ""`; omits several schema fields (`driverid` uses string interpolation; `mifaredriverid`, `calcengineseconds`, `[REDACTED-AWS-SMTP-PASSWORD]` commented out) |
| `changeset/2` | 111 | Casts all schema fields; `validate_required([:hardwareid])` (line 161) |

---

### File 4: `lib/api_server/vx/vx_thing_event_omega.ex`

**Module:** `ApiServer.Vx.VXThingEventOmega`

**Behaviours / macros used:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema:** `"thingomega"` (line 5)
- Primary key: implicit `id`
- Fields (lines 6–68): `accelerometerx`, `accelerometery`, `accelerometerz`, `[REDACTED-AWS-SMTP-PASSWORD]`, `omegadriverid`, `seatbelt`, `seated`, `parkbrakerequest`, `parkbreakreleased`, `vehicleload`, `tilt`, `height`, `overload`, `attretracted`, `yellowled`, `redled`, `greenled`, `liftenable`, `safetyoverride`, `doorclosed`, `parkbrakerror`, `batterynotcharged`, `lowengineoil`, `accnotcharged`, `[REDACTED-AWS-SMTP-PASSWORD]`, `airfilterblocked`, `attpressure`, `oilcoolerfan`, `lowerinterruption`, `undersafetyheight`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `md3temperature`, `fuellevel`, `md3status`, `xa2status`, `batteryvoltage`, `xa2temperature`, `boomangle`, `boomextension`, `lift`, `extension`, `[REDACTED-AWS-SMTP-PASSWORD]`, `fuelrate`, `totalfuelidle`, `totalidlehour`, `totalenginehour`, `enginerpm`, `capacity`, `coolanttemperature`, `oiltemperature`, `engineerrorcode`, `vehiclespeed`, `gearselection`, `transerrorcode`, `prestartchecklist`, `truckerrorcode`, `mc43status`, `mc43temperature`, `lc5status`, `lc5temperature`, `truckangle`
- Associations:
  - `belongs_to :thingevent, ApiServer.Vx.VXThingEvent` — `foreign_key: :id`, `references: :id`, `primary_key: true`, `define_field: false` (line 69)

**Public functions defined:**
| Function | Line | Notes |
|---|---|---|
| `changeset/2` | 72 | Casts all 64+ fields; `validate_required([:id])` (line 75) |

---

## Test Coverage Summary

| Source file | Dedicated test file | Indirect coverage found |
|---|---|---|
| `vx_restriction.ex` | `vx_restriction_controller_test.exs` (YES) | `changeset/2` exercised indirectly via controller create/update |
| `vx_thing.ex` | None | None — zero test references found |
| `vx_thing_event.ex` | None | None — zero test references found |
| `vx_thing_event_omega.ex` | None | None — zero test references found |

---

## Findings

### B011-1
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing.ex`
**Finding:** No test file exists for `ApiServer.Vx.VXThing`. No test in the entire test suite references the module name, either function, or any of the table/schema names (`aad_thing`, `VXThing`, `convert_json_to_changeset`, `aadcustcode`, etc.).

The module has two public functions (`convert_json_to_changeset/1` and `changeset/2`) and a rich schema with 35+ fields. Neither function is exercised by any test.

---

### B011-2
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Finding:** No test file exists for `ApiServer.Vx.VXThingEvent`. No test in the entire test suite references the module, either public function (`map_xml/1`, `changeset/2`), or the underlying table name (`thingevents`).

---

### B011-3
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_event_omega.ex`
**Finding:** No test file exists for `ApiServer.Vx.VXThingEventOmega`. No test in the entire test suite references the module, its only public function (`changeset/2`), or the underlying table name (`thingomega`).

---

### B011-4
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Function:** `map_xml/1` (line 71)
**Finding:** `map_xml/1` is entirely untested. This function uses several bang functions that will raise on malformed input:
- `NaiveDateTime.from_iso8601!/1` — raises `ArgumentError` if the string is not a valid ISO 8601 datetime
- `DateTime.from_naive!/2` — raises if the naive datetime or timezone is invalid
- `String.to_integer/1` — raises `ArgumentError` if the string cannot be parsed as an integer
- `String.to_float/1` — raises `ArgumentError` if the string cannot be parsed as a float

There are no tests verifying that `map_xml/1` returns the correct structure with a well-formed input, and no tests verifying behaviour (or failure) when any required key is missing or malformed.

---

### B011-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing.ex`
**Function:** `convert_json_to_changeset/1` (line 60)
**Finding:** `convert_json_to_changeset/1` is entirely untested. The function returns a plain `%{}` map (not an Ecto changeset) constructed via a pipeline of `Vx.update_key_if_value/3` calls. There are no tests verifying:
- That the correct keys are populated from corresponding JSON keys.
- Behaviour when JSON keys are missing or `nil` (the logic depends on `Vx.update_key_if_value/3` semantics for nil values).
- That the returned map is correctly shaped for downstream use.

---

### B011-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing.ex`
**Function:** `changeset/2` (line 75)
**Finding:** `changeset/2` for `VXThing` is entirely untested. Unlike `VXRestriction.changeset/2`, there is no controller test or any other test that exercises this function. Notably, the changeset has no `validate_required/2` call, meaning a struct with all nil fields would pass validation — this design decision is not covered by any test.

---

### B011-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Function:** `changeset/2` (line 111)
**Finding:** `changeset/2` for `VXThingEvent` is entirely untested. The function casts a very large set of fields (49 fields) and validates only `:hardwareid`. There are no tests verifying the required-field validation or that the cast fields are accepted/rejected correctly.

---

### B011-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_event_omega.ex`
**Function:** `changeset/2` (line 72)
**Finding:** `changeset/2` for `VXThingEventOmega` is entirely untested. The function casts 64+ fields and validates only `:id`. The use of `:id` as both primary key and foreign key (`belongs_to :thingevent`, `primary_key: true`) is an unusual pattern with no test confirming correct persistence or validation behaviour.

---

### B011-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_restriction.ex`
**Function:** `changeset/2` (line 16)
**Finding:** The `changeset/2` function is exercised only indirectly through the controller test (`vx_restriction_controller_test.exs`) via `Vx.create_vx_restriction/1` and `Vx.update_vx_restriction/2`. There is no direct unit test of `VXRestriction.changeset/2` itself. Specifically:
- The `@invalid_attrs` test sets all fields to `nil`, which tests `validate_required([:aauuser_id])` via the controller path, but no test covers a case where `aauuser_id` is present but other optional fields take boundary values (empty string, 0, very large integer).
- The `@create_attrs` fixture includes `aauid: 42` in the test map, but `aauid` is the auto-generated primary key and is not in the `cast/3` field list — this inconsistency is untested at the schema level.

---

### B011-10
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Function:** `map_xml/1` (line 71)
**Finding:** Several schema fields present in `changeset/2` are explicitly omitted from `map_xml/1` with inline comments (lines 103–106):
- `driverid` is populated via string interpolation `"#{data["driverid"]}"` rather than direct assignment, meaning a `nil` value in the source would silently become the string `""`.
- `mifaredriverid`, `calcengineseconds`, and `[REDACTED-AWS-SMTP-PASSWORD]` are commented out entirely with the note "need the thing record for this one".

These omissions and silent coercions are not validated by any test.

---

### B011-11
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event_omega.ex`
**Schema:** `"thingomega"` (line 5)
**Finding:** The `[REDACTED-AWS-SMTP-PASSWORD]` field (line 9) is declared in the schema but is absent from the `cast/3` call in `changeset/2` (line 74). This means the field can never be set via the changeset. This discrepancy is undocumented and untested.

---

### B011-12
**Severity:** LOW
**File:** `lib/api_server/vx/vx_restriction.ex`
**Finding:** There is no test covering the `belongs_to :user` association (line 12). No test verifies behaviour when the referenced `VXUser` record does not exist (referential integrity), or that the foreign key constraint fires correctly. The controller test fixture uses `aauuser_id: 42` directly without creating a corresponding user record, which may indicate the database is not enforcing the foreign key or the association logic is untested end-to-end.

---

### B011-13
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing.ex`
**Finding:** `require Ecto.Query` (line 1) and `require Ecto.Adapters.SQL` (line 2) appear at the top level outside the module, meaning they affect the compilation unit but no functions in the module use raw SQL queries or dynamic Ecto.Query macros. This dead `require` usage is not flagged by any test and may indicate removed or planned functionality with no coverage.

---

### B011-14
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_event.ex`
**Finding:** The `llpoint` field (line 52) is commented out: `# field :llpoint, Geo.Point`. This suggests a `Geo` PostGIS integration was planned or previously implemented. There is no test and no documentation explaining why this field is disabled. The `geofence` field (line 51) is a `:string` that silently receives an empty string `""` from `map_xml/1`, suggesting the geo logic may be partially stubbed.

---

### B011-15
**Severity:** INFO
**File:** `lib/api_server/vx/vx_restriction_controller_test.exs`
**Finding:** The controller test references `vx_restriction_path(conn, :show, id)` after create (line 32) and checks the response body includes `"aauid" => 42`. However, `aauid` is the auto-generated primary key (`@primary_key {:aauid, :id, autogenerate: true}`), and the `@create_attrs` fixture specifies `aauid: 42`. Since `aauid` is the primary key and is autogenerated, attempting to set it via `cast` (which does not include `aauid` in the cast list) should have no effect, and the actual generated ID would differ from `42`. The test assertion `"aauid" => 42` is likely incorrect and would fail if run, or the view is rendering a value from `@create_attrs` rather than the persisted record. This is an existing test correctness issue.

<!-- B012.md -->
# Audit Report B012
**Audit run:** 2026-02-27-01
**Agent:** Pass 2 / B012
**Scope:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`, `lib/api_server/vx/vx_thing_info.ex`, `lib/api_server/vx/vx_thing_summary.ex`, `lib/api_server/vx/vx_user.ex`

---

## READING EVIDENCE

### 1. `ApiServer.Vx.VXThingEventOmegaTires`
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`

**Behaviours / use macros:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema (`"thingomegatires"`, lines 5–56):**
- Primary key: implicitly `id` (default Ecto integer PK; also used as the belongs_to FK)
- Fields (all `:integer`): `pressurewarning0`–`pressurewarning5`, `pressureleakage0`–`pressureleakage5`, `temperaturehigh0`–`temperaturehigh5`, `receivetimeout0`–`receivetimeout5`, `[REDACTED-AWS-SMTP-PASSWORD]`–`[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`–`[REDACTED-AWS-SMTP-PASSWORD]`, `tirepressure0`–`tirepressure5`, `temperature0`–`temperature5` (48 fields total, 8 per tire × 6 tires)
- Association: `belongs_to :thingevent, ApiServer.Vx.VXThingEvent` (FK `:id` → references `:id`, `define_field: false`, `primary_key: true`)

**Public functions:**
| Line | Name | Arity |
|------|------|-------|
| 58 | `changeset/2` | `(vx_thing_event_omega_tires, attrs)` |

**changeset/2 details:**
- Casts all 49 fields (`:id` + 48 tire data fields)
- `validate_required([:id])`

---

### 2. `ApiServer.Vx.VXThingInfo`
**File:** `lib/api_server/vx/vx_thing_info.ex`

**Behaviours / use macros:**
- `use Ecto.Schema` (line 4)
- `import Ecto.Changeset` (line 5)
- `require Ecto.Query`, `require Ecto.Adapters.SQL` (lines 6–7)

**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXThing`, `ApiServer.Vx.VXThingInfo`, `ApiServer.Repo`

**Schema (`"thing_info"`, lines 15–22):**
- Primary key: `{:id, :id, autogenerate: true}` (line 14)
- Fields: `averageweeklyusage` (`:float`), `pmnotificationid` (`:integer`), `pmnotificationdate` (`:date`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`)
- Association: `belongs_to :thing, VXThing` (FK `:hardwareid` → references `:aadhardwareid`)

**Note:** No `changeset/2` is defined in this module (unlike the other three schemas). Data manipulation uses `Ecto.Changeset.change/2` directly inside functions.

**Public functions:**
| Line | Name | Arity |
|------|------|-------|
| 24 | `getWithHardwareId/2` | `(hardwareid, customer)` |
| 31 | `service_performed/3` | `(hardwareid, new_service_date, customer)` |
| 47 | `[REDACTED-AWS-SMTP-PASSWORD]` | `(hardwareid, customer)` |
| 57 | `make_info_record/2` | `(hardwareid, customer)` |
| 74 | `update_existing_record/3` | `(existing, hardwareid, customer)` |

**Notable logic:**
- `getWithHardwareId/2`: single Ecto query with `Repo.one/2` using a customer-scoped prefix.
- `service_performed/3`: fetches record, resets PM notification fields only when `info != nil && info.pmnotificationdate <= new_service_date`. Returns `nil` implicitly when the guard fails.
- `[REDACTED-AWS-SMTP-PASSWORD]`: dispatches to `make_info_record/2` (new record) or `update_existing_record/3` (existing record).
- `make_info_record/2`: hardcodes `pmnotificationid: 12` and `notification_date: ~D[2019-01-13]`; calculates `hours_since_notified` from that epoch.
- `update_existing_record/3`: conditional on `pmnotificationdate != nil && pmnotificationdate > ~D[1970-01-01]`; branches to include or exclude `[REDACTED-AWS-SMTP-PASSWORD]` calculation.

---

### 3. `ApiServer.Vx.VXThingSummary`
**File:** `lib/api_server/vx/vx_thing_summary.ex`

**Behaviours / use macros:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema (`"abm_summary"`, lines 6–46):**
- Primary key: `{:abmid, :id, autogenerate: true}` (line 5)
- Fields (41 total): `abmgmtdatetime` (`:utc_datetime`), `abmdesc` (`:string`), `abmignitionstatus` (`:string`), `abmeventtype` (`:integer`), `abmeventcode` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `abmhourmeter1`–`abmhourmeter4` (`:integer`), `abmcalchourmeter1`–`abmcalchourmeter4` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]`–`[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `abmodometer` (`:integer`), `abmcalcodometer` (`:integer`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:integer`), `abmlatitude` (`:float`), `abmlongitude` (`:float`), `abmheading` (`:float`), `abmspeed` (`:float`), `abmdriverid` (`:string`), `abmmifaredriverid` (`:string`), `abmcustcode` (`:string`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:float`), `abmhourmeteromega` (`:float`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:float`), `abmhourmeterothcan` (`:float`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:float`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:utc_datetime`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:string`)
- Association: `belongs_to :thing, ApiServer.Vx.VXThing` (FK `:abmhardwareid` → references `:aadhardwareid`)

**Public functions:**
| Line | Name | Arity |
|------|------|-------|
| 49 | `changeset/2` | `(vx_thing_summary, attrs)` |
| 56 | `make_or_update_summary/3` | `(hardwareid, customer, existingSummary \\ %VXThingSummary{})` |
| 138 | `validate_for_hardwareid/2` | `(hardwareid, customer)` |
| 156 | `is_valid?/2` | `(summary_record, thing_event)` |

**Notable logic:**
- `make_or_update_summary/3`: resolves most-recent event preferring omega variant; parses `hardwareid` as integer; conditionally merges omega hourmeter fields based on two separate guards (`thing_event.thingeventomega` present, then `thing.aadhourmeteromega && thing_event.thingeventomega`). Unused binding `result` on line 135 (variable `result` assigned but not returned under a name; last expression is the `result = ...` assignment which is the implicit return).
- `validate_for_hardwareid/2`: creates summary when nil; otherwise validates staleness and updates. Assigns `timestamp = Timex.now()` on line 149 but never uses it (dead code).
- `is_valid?/2`: compares five fields across summary and event structs; returns `false` if either argument is `nil`.

---

### 4. `ApiServer.Vx.VXUser`
**File:** `lib/api_server/vx/vx_user.ex`

**Behaviours / use macros:**
- `use Ecto.Schema` (line 5)
- `import Ecto.Changeset` (line 7)
- `require Ecto.Query`, `require Ecto.Adapters.SQL` (top-level, lines 1–2, outside `defmodule`)
- `alias ApiServer.Vx` (line 9)

**Schema (`"aac_user"`, lines 13–55):**
- Primary key: `{:aacid, :id, autogenerate: true}` (line 12)
- Fields (32 total): `aaccustcode` (`:string`), `aacuser` (`:string`), `aacfname` (`:string`), `aacsurname` (`:string`), `aaccredte` (`:utc_datetime`), `aacexpdte` (`:date`), `aaclastupdated` (`:utc_datetime`), `aacpassword` (`:string`), `aacpasswordhash` (`:string`), `[REDACTED-AWS-SMTP-PASSWORD]` (`:string`), `aactz` (`:string`), `aacfirstopt` (`:string`), `aacemail` (`:string`), `aacdash` (`:integer`), `aacpwdlastupd` (`:utc_datetime`), `aacuserdriver` (`:string`), `aaclic1`/`aaclic2` license fields (10 fields), `aacusertype` (`:string`), `aacproxyenabled` (`:string`), `aactimezone` (`:string`), `aacdeffleet` (`:integer`), `aacdateformat` (`:string`), `aachourformat` (`:integer`), `aaclang` (`:string`), `aacuom` (`:string`), `aacmaprefresh` (`:integer`)
- Associations: `has_one :accessfob`, `has_one :function` (`VXUserFunction`, `on_replace: :update`), `has_many :assigned_fleets` (`VXRestriction`), `has_many :abl_records` (`VXAblRecord`)

**Public functions:**
| Line | Name | Arity |
|------|------|-------|
| 57 | `convert_json_to_changeset/1` | `(user_json)` |
| 73 | `password_changeset/2` | `(user, attrs)` |
| 78 | `changeset/2` | `(user, attrs)` |

**Notable logic:**
- `convert_json_to_changeset/1`: builds a plain map (not an `Ecto.Changeset`) by piping through `Vx.update_key_if_value/3` calls. Maps `"units"` to `:aacuom` twice (lines 62 and 67 — duplicate key). Maps `:user_level` (an atom key) into the map despite this not being a valid schema field. Commented-out `aactz`/`offset` mapping (line 68).
- `password_changeset/2`: casts only `:aacpassword`; no `validate_required` or hashing.
- `changeset/2`: casts core fields; uses `put_assoc(:function, ...)` with `attrs.user_level` (atom-key access — will crash if `attrs` is a plain map with string keys); validates `:aacemail` presence and format (`~r/@/`); enforces unique constraint on `:aacuser`.

---

## TEST COVERAGE SEARCH RESULTS

All four module names and all public function names were searched against `C:/Projects/cig-audit/repos/api_server/test/` using `Grep`. **Zero matches** were found for any of the following patterns:

- `[REDACTED-AWS-SMTP-PASSWORD]`, `thingomegatires`
- `VXThingInfo`, `thing_info`, `getWithHardwareId`, `service_performed`, `[REDACTED-AWS-SMTP-PASSWORD]`, `make_info_record`, `update_existing_record`
- `VXThingSummary`, `abm_summary`, `make_or_update_summary`, `validate_for_hardwareid`, `is_valid?`
- `VXUser`, `aac_user`, `convert_json_to_changeset`, `password_changeset`

The four known test files (`calamp_controller_test.exs`, `vx_restriction_controller_test.exs`, `layout_view_test.exs`, `page_view_test.exs`) contain no references to these modules. No indirect test coverage exists anywhere in the test suite.

---

## FINDINGS

### B012-1
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`
**Finding:** No test file exists and no test in the suite exercises `ApiServer.Vx.VXThingEventOmegaTires`. The module defines a 48-field Ecto schema and a `changeset/2`. Zero coverage.

---

### B012-2
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_info.ex`
**Finding:** No test file exists and no test in the suite exercises `ApiServer.Vx.VXThingInfo`. The module defines five public functions (`getWithHardwareId/2`, `service_performed/3`, `[REDACTED-AWS-SMTP-PASSWORD]`, `make_info_record/2`, `update_existing_record/3`). Zero coverage.

---

### B012-3
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_thing_summary.ex`
**Finding:** No test file exists and no test in the suite exercises `ApiServer.Vx.VXThingSummary`. The module defines four public functions (`changeset/2`, `make_or_update_summary/3`, `validate_for_hardwareid/2`, `is_valid?/2`). Zero coverage.

---

### B012-4
**Severity:** HIGH
**File:** `lib/api_server/vx/vx_user.ex`
**Finding:** No test file exists and no test in the suite exercises `ApiServer.Vx.VXUser`. The module defines three public functions (`convert_json_to_changeset/1`, `password_changeset/2`, `changeset/2`). Zero coverage.

---

### B012-5
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_info.ex`, `service_performed/3` (line 31)
**Finding:** The early-exit path when `info == nil` (i.e., no `thing_info` record exists for the given `hardwareid`) is untested. The function silently returns `nil` in this case. Callers may not handle a `nil` return, and no test verifies the nil-info guard fires correctly.

---

### B012-6
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_info.ex`, `service_performed/3` (line 36)
**Finding:** The condition `info.pmnotificationdate <= new_service_date` is untested for the case where the condition is `false` (i.e., `new_service_date` is before `pmnotificationdate`). The update is silently skipped and `nil` is returned; no test verifies this negative path.

---

### B012-7
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_info.ex`, `update_existing_record/3` (line 74)
**Finding:** The `cond` branch at line 85 (`true ->`) — reached when `pmnotificationdate` is `nil` or equals `~D[1970-01-01]` — is untested. This branch sets `usagesincenotification: 0` and skips the `fetch_actual_usage` call. The sentinel date `~D[1970-01-01]` boundary is also never tested (e.g., a record with exactly that date, or one day before/after).

---

### B012-8
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `make_or_update_summary/3` (line 56)
**Finding:** The fallback path at line 59–61 — where `get_most_recent_thingevent_with_omega/2` returns `nil` and the function falls back to `get_most_recent_thingevent/2` — is untested. No test verifies that the fallback produces a correct summary or that the final result is valid when no omega event exists.

---

### B012-9
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `make_or_update_summary/3` (line 66)
**Finding:** The `hardwareid` integer-parsing branch at lines 69–71 (`Integer.parse(hardwareid)`) is untested. When `hardwareid` is a non-integer string, `Integer.parse/1` returns `{integer, remainder}` and the remainder is silently discarded. If parsing fails entirely, `Integer.parse/1` returns `:error`, causing a destructuring crash `{hardwareid_parsed, result} = :error`. No test covers string input, partial-parse input, or unparseable input.

---

### B012-10
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `is_valid?/2` (line 156)
**Finding:** `is_valid?/2` is untested. It is a pure function with two branches (`nil`-guard returning `false`, and the five-field equality check returning a boolean). Both the `true` and `false` outcomes of the equality branch are untested. This function controls whether a summary record is refreshed or reused across the system.

---

### B012-11
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_user.ex`, `changeset/2` (line 78)
**Finding:** `changeset/2` is untested. It includes `put_assoc(:function, %{aatfunction_id: attrs.user_level}, required: true)` which accesses `attrs.user_level` using atom-key struct/map access. If `attrs` is a plain map with string keys (as is typical from JSON input), this raises a `KeyError` at runtime. No test covers this path, the email format validation, the unique constraint on `:aacuser`, or required field validation.

---

### B012-12
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_user.ex`, `convert_json_to_changeset/1` (line 57)
**Finding:** `convert_json_to_changeset/1` is untested. The function contains a duplicate mapping of `"units"` to `:aacuom` (lines 62 and 67), meaning the first assignment is always silently overwritten. It also maps a `:user_level` atom key that is not a valid schema field, which will be ignored by downstream changesets. No test verifies correct output, the duplicate-key behaviour, or handling of nil/missing JSON keys.

---

### B012-13
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_user.ex`, `password_changeset/2` (line 73)
**Finding:** `password_changeset/2` is untested. It casts `:aacpassword` in plain text with no hashing, no strength validation, and no `validate_required`. No test verifies that the changeset correctly accepts or rejects password updates.

---

### B012-14
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`, `changeset/2` (line 58)
**Finding:** Edge cases for `changeset/2` are untested: (a) all 48 tire fields absent (only `:id` provided — the only required field); (b) non-integer values supplied for integer fields; (c) `id` missing (should produce a required-field validation error). The schema supports 6 tires; no test verifies partial tire data (e.g., only tires 0–2 populated).

---

### B012-15
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_info.ex`, `make_info_record/2` (line 57)
**Finding:** The hardcoded `notification_date = ~D[2019-01-13]` and `pmnotificationid: 12` constants are never tested. These magic values look like a one-time migration artifact. No test verifies that newly created `thing_info` records carry the correct initial values, or that `NaiveDateTime.new/2` succeeds for this date (it always should, but the `{_, notification_datetime}` destructuring silently discards errors).

---

### B012-16
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `validate_for_hardwareid/2` (line 138)
**Finding:** The unused variable `timestamp = Timex.now()` at line 149 is dead code — it is assigned but never referenced. While not a correctness bug, it is untested dead logic that may have been intended to stamp the update time on the record and was inadvertently omitted.

---

### B012-17
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `make_or_update_summary/3` (lines 103–117 and 119–133)
**Finding:** Two consecutive `if` guards both test `thing_event.thingeventomega` and then `thing.aadhourmeteromega && thing_event.thingeventomega`. When both conditions are true, the second block overwrites the first, making the first block's result unreachable in practice. No test exercises the case where the first block executes but the second does not (i.e., `thing_event.thingeventomega` is set but `thing.aadhourmeteromega` is nil/false).

---

### B012-18
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_summary.ex`, `make_or_update_summary/3` (line 104)
**Finding:** The `nil`-guard for `thing_event.thingeventomega.totalenginehour` (returning `0.0`) is duplicated identically at lines 104–108 and 120–124. No test verifies that `0.0` is correctly stored when `totalenginehour` is `nil`, nor that `Float.round/2` at line 108/124 correctly handles boundary float values.

---

### B012-19
**Severity:** LOW
**File:** `lib/api_server/vx/vx_user.ex`, `changeset/2` (line 83)
**Finding:** The email format regex `~r/@/` (line 83) only checks for the presence of the `@` character. It does not validate a domain part, local part, or TLD. Edge cases such as `"@"`, `"a@"`, `"@b"`, and multiple `@` symbols are unchecked and untested.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B012-1 | HIGH | vx_thing_event_omega_tires.ex | No tests — entire module uncovered |
| B012-2 | HIGH | vx_thing_info.ex | No tests — entire module uncovered |
| B012-3 | HIGH | vx_thing_summary.ex | No tests — entire module uncovered |
| B012-4 | HIGH | vx_user.ex | No tests — entire module uncovered |
| B012-5 | MEDIUM | vx_thing_info.ex | `service_performed/3`: nil-info path untested |
| B012-6 | MEDIUM | vx_thing_info.ex | `service_performed/3`: date-before-notification path untested |
| B012-7 | MEDIUM | vx_thing_info.ex | `update_existing_record/3`: nil/epoch date branch and sentinel boundary untested |
| B012-8 | MEDIUM | vx_thing_summary.ex | `make_or_update_summary/3`: no-omega-event fallback path untested |
| B012-9 | MEDIUM | vx_thing_summary.ex | `make_or_update_summary/3`: string hardwareid parsing (crash on `:error`) untested |
| B012-10 | MEDIUM | vx_thing_summary.ex | `is_valid?/2`: pure function entirely untested |
| B012-11 | MEDIUM | vx_user.ex | `changeset/2`: atom-key access crash risk on string-key map untested |
| B012-12 | MEDIUM | vx_user.ex | `convert_json_to_changeset/1`: duplicate key and invalid field mapping untested |
| B012-13 | MEDIUM | vx_user.ex | `password_changeset/2`: no hashing/validation, entirely untested |
| B012-14 | LOW | vx_thing_event_omega_tires.ex | `changeset/2`: partial/empty/invalid field edge cases untested |
| B012-15 | LOW | vx_thing_info.ex | `make_info_record/2`: hardcoded magic constants untested |
| B012-16 | LOW | vx_thing_summary.ex | `validate_for_hardwareid/2`: unused dead variable `timestamp` |
| B012-17 | LOW | vx_thing_summary.ex | `make_or_update_summary/3`: first omega block unreachable when second fires |
| B012-18 | LOW | vx_thing_summary.ex | `make_or_update_summary/3`: duplicated nil-guard for `totalenginehour` untested |
| B012-19 | LOW | vx_user.ex | `changeset/2`: overly permissive email regex edge cases untested |

<!-- B013.md -->
# Audit Report B013
**Audit Run:** 2026-02-27-01
**Agent:** Pass 2 / B013
**Scope:** Coverage gaps for three web-layer source files

---

## Source Files Audited

1. `lib/api_server_web.ex`
2. `lib/api_server_web/auth_error_handler.ex`
3. `lib/api_server_web/auth_pipeline.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server_web.ex`

**Module:** `ApiServerWeb`

**Functions/Macros defined:**

| Line | Name | Kind |
|------|------|------|
| 20 | `controller/0` | public def |
| 29 | `view/0` | public def |
| 46 | `router/0` | public def |
| 54 | `channel/0` | public def |
| 64 | `__using__/1` | public defmacro |

**Types / Constants / Structs:** None defined directly; each function returns a `quote` block that injects standard Phoenix/Plug imports into the calling module.

**Notes:**
- `controller/0` injects: `use Phoenix.Controller`, `import Plug.Conn`, `import ApiServerWeb.Router.Helpers`, `import ApiServerWeb.Gettext`.
- `view/0` injects: `use Phoenix.View`, `import Phoenix.Controller` (get_flash/view_module), `use Phoenix.HTML`, `import ApiServerWeb.Router.Helpers`, `import ApiServerWeb.ErrorHelpers`, `import ApiServerWeb.Gettext`.
- `router/0` injects: `use Phoenix.Router`, `import Plug.Conn`, `import Phoenix.Controller`.
- `channel/0` injects: `use Phoenix.Channel`, `import ApiServerWeb.Gettext`.
- `__using__/1` dispatches to `apply(__MODULE__, which, [])` — calls one of the four functions above based on the atom argument.
- `channel/0` has no callers anywhere in the codebase (no `use ApiServerWeb, :channel` found).

---

### File 2: `lib/api_server_web/auth_error_handler.ex`

**Module:** `ApiServerWeb.AuthErrorHandler`

**Functions defined:**

| Line | Name | Kind |
|------|------|------|
| 4 | `auth_error/3` | public def |

**Signature:** `auth_error(conn, {type, _reason}, _opts)`

**Behaviour:** Encodes `%{error: to_string(type)}` via `Poison.encode!`, then calls `send_resp(conn, 401, body)`.

**Types / Constants / Structs:** None.

**Notes:**
- `_reason` is discarded; the error reason is never surfaced to the caller.
- Uses `Poison` (not Jason) — inconsistent with the rest of the Phoenix 1.4+ ecosystem which defaults to Jason.

---

### File 3: `lib/api_server_web/auth_pipeline.ex`

**Module:** `ApiServer.Guardian.AuthPipeline`

**Plugs defined (via `use Guardian.Plug.Pipeline`):**

| Line | Name | Notes |
|------|------|-------|
| 6 | `Guardian.Plug.VerifyHeader` | `realm: "Bearer"` — validates Bearer token in Authorization header |
| 7 | `Guardian.Plug.EnsureAuthenticated` | **commented out** — authentication is NOT enforced |
| 8 | `Guardian.Plug.LoadResource` | loads the resource associated with the verified token |

**Configuration:**
- `otp_app: :MyApi` — atom literal `:MyApi` (capitalised) used instead of `:api_server`.
- `module: ApiServer.Guardian`
- `error_handler: ApiServerWeb.AuthErrorHandler`

**Types / Constants / Structs:** None.

**Notes:**
- The pipeline is registered in `router.ex` line 25 as the `:authenticated` pipeline and applied to the majority of `/api/v1` routes via `pipe_through([:api, :authenticated])`.
- Because `EnsureAuthenticated` is commented out, all routes in the `:authenticated` pipeline accept unauthenticated requests without rejection.

---

## Test Coverage Search Results

### Direct test files

| Source file | Direct test file | Exists? |
|-------------|-----------------|---------|
| `lib/api_server_web.ex` | `test/api_server_web_test.exs` | No |
| `lib/api_server_web/auth_error_handler.ex` | `test/api_server_web/auth_error_handler_test.exs` | No |
| `lib/api_server_web/auth_pipeline.ex` | `test/api_server_web/auth_pipeline_test.exs` | No |

### Indirect coverage search

Grep for `AuthErrorHandler`, `auth_error` in `test/` — **no matches**.
Grep for `AuthPipeline`, `Guardian.Plug`, `auth_pipeline` in `test/` — **no matches**.
Grep for `authorization`, `Bearer`, `token`, `401`, `authenticated` in `test/` — **no matches**.

The four known test files were read in full:

- `test/api_server_web/controllers/calamp_controller_test.exs` — empty stub; `use ApiServerWeb.ConnCase` is commented out. No tests.
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — exercises CRUD on `VXRestriction`. All requests are made without an Authorization header; no auth behaviour is tested.
- `test/api_server_web/views/layout_view_test.exs` — empty body; only `use ApiServerWeb.ConnCase`.
- `test/api_server_web/views/page_view_test.exs` — empty body; only `use ApiServerWeb.ConnCase`.

**Conclusion:** There is zero direct or indirect test coverage for all three assigned source files.

---

## Findings

---

### B013-1
**Severity:** HIGH
**File:** `lib/api_server_web/auth_error_handler.ex`
**Finding:** No test file exists and no indirect test coverage found for `ApiServerWeb.AuthErrorHandler`. The sole public function `auth_error/3` — which returns the 401 error response for all JWT authentication failures — is completely untested. Any regression in this handler (wrong status code, malformed JSON body, Poison serialisation failure) would be invisible before deployment.

---

### B013-2
**Severity:** HIGH
**File:** `lib/api_server_web/auth_pipeline.ex`
**Finding:** No test file exists and no indirect test coverage found for `ApiServer.Guardian.AuthPipeline`. The pipeline is plugged into the `:authenticated` pipeline used by the majority of API routes, yet no test sends a request with a valid token, an invalid token, or no token to any of those routes. The interaction between `VerifyHeader`, `LoadResource`, and `AuthErrorHandler` is entirely untested.

---

### B013-3
**Severity:** HIGH
**File:** `lib/api_server_web.ex`
**Finding:** No test file exists for `ApiServerWeb`. While the `controller/0`, `view/0`, and `router/0` macros are exercised transitively at compile time by other modules, that compilation behaviour is not covered by any explicit unit or integration test. The `channel/0` function has no callers at all (no `use ApiServerWeb, :channel` found in the codebase) and is therefore dead code with zero test coverage.

---

### B013-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/auth_pipeline.ex`
**Finding:** `Guardian.Plug.EnsureAuthenticated` is commented out (line 7). This means that even if a request reaches the `:authenticated` pipeline with no token or an expired token, `VerifyHeader` will silently fail to set a subject and `LoadResource` will likely load `nil`, but the request will still proceed to the controller. There is no test asserting that an unauthenticated request to a protected route receives a 401 response. The combination of commented-out enforcement and zero test coverage means the security boundary is unverifiable.

---

### B013-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/auth_pipeline.ex`
**Finding:** `otp_app` is set to `:MyApi` (line 2) instead of `:api_server`, which is the atom used by every other module in the application (`Guardian`, `Endpoint`, `Repo`, `Mailer`, `Scheduler`, `Gettext`). Guardian reads its secret key and other configuration from the OTP application environment under this atom. If the `:MyApi` application environment key is not explicitly configured in `config/config.exs` (or equivalent), Guardian will silently fall back to defaults or raise at runtime. No test exists that would catch a misconfiguration of this atom.

---

### B013-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/auth_error_handler.ex`
**Finding:** The `_reason` parameter of `auth_error/3` is ignored (line 4). Guardian passes structured reason atoms such as `:token_expired`, `:invalid_token`, `:unauthenticated`, etc. Discarding this information means the API client receives a generic `{"error": "unauthenticated"}` (or similar) for all failure modes, making it impossible to distinguish a missing token from an expired one. There is no test covering any of the distinct failure-type inputs.

---

### B013-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/auth_error_handler.ex`
**Finding:** `auth_error/3` uses `Poison.encode!/1` (line 5). The rest of the application uses Jason as the JSON encoder (the default for Phoenix 1.4+). There is no test verifying the serialised response body format, meaning a dependency change or encoder mismatch could produce malformed or unexpected output silently.

---

### B013-8
**Severity:** LOW
**File:** `lib/api_server_web/auth_error_handler.ex`
**Finding:** No edge-case tests exist for `auth_error/3` with unusual `type` values. The function calls `to_string(type)` on the first element of the second argument tuple. If `type` is not a simple atom (e.g., it is a nested tuple, a struct, or a large binary), `to_string/1` behaviour may be unexpected. No boundary tests exist for these inputs.

---

### B013-9
**Severity:** LOW
**File:** `lib/api_server_web.ex`
**Finding:** The `__using__/1` macro (line 64) calls `apply(__MODULE__, which, [])` where `which` must be an atom matching one of the four defined functions. If called with an unrecognised atom (e.g., `use ApiServerWeb, :socket`), `apply/3` will raise `[REDACTED-AWS-SMTP-PASSWORD]` at compile time with no user-friendly error message. There is no guard clause, fallback clause, or test for an invalid `which` argument.

---

### B013-10
**Severity:** INFO
**File:** `lib/api_server_web.ex`
**Finding:** `channel/0` (line 54) is defined but has no callers in the codebase. No channel modules use `use ApiServerWeb, :channel`. This function appears to be dead code left over from the Phoenix project generator scaffold. No tests exist for it, and its removal would have no functional impact.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B013-1 | HIGH | `auth_error_handler.ex` | No test coverage whatsoever for `auth_error/3` |
| B013-2 | HIGH | `auth_pipeline.ex` | No test coverage for the Guardian auth pipeline |
| B013-3 | HIGH | `api_server_web.ex` | No test file; `channel/0` is dead code with no coverage |
| B013-4 | MEDIUM | `auth_pipeline.ex` | `EnsureAuthenticated` commented out; no test asserts 401 on unauthenticated requests |
| B013-5 | MEDIUM | `auth_pipeline.ex` | `otp_app: :MyApi` mismatches application atom `:api_server`; no test catches misconfiguration |
| B013-6 | MEDIUM | `auth_error_handler.ex` | `_reason` discarded; distinct failure types produce identical responses; no tests |
| B013-7 | MEDIUM | `auth_error_handler.ex` | Uses `Poison` instead of `Jason`; inconsistency untested |
| B013-8 | LOW | `auth_error_handler.ex` | No edge-case tests for unusual `type` values in `auth_error/3` |
| B013-9 | LOW | `api_server_web.ex` | `__using__/1` raises uninformatively on unknown atom; no tests for invalid input |
| B013-10 | INFO | `api_server_web.ex` | `channel/0` is dead code; never called anywhere in codebase |

<!-- B014.md -->
# Audit Report B014
**Audit run:** 2026-02-27-01
**Agent:** Pass 2 / B014
**Scope:** ApiServerWeb.UserSocket, ApiServerWeb.Endpoint, ApiServerWeb.Gettext, Plug.Parsers.XML (xml_plug.ex)

---

## 1. Reading Evidence

### 1.1 `lib/api_server_web/channels/user_socket.ex`

**Module:** `ApiServerWeb.UserSocket`

| Kind | Name | Line |
|------|------|------|
| `use` macro | `Phoenix.Socket` | 2 |
| transport declaration | `:websocket` via `Phoenix.Transports.WebSocket` | 8 |
| public function | `connect/2` — accepts any params, returns `{:ok, socket}` | 22–24 |
| public function | `id/1` — always returns `nil` (anonymous socket) | 36 |

**Constants / config:**
- The `channel "room:*"` line is commented out; no channels are mounted.
- The `:longpoll` transport is commented out.

**Notes:**
- `connect/2` performs no authentication: every connection is unconditionally accepted.
- `id/1` always returns `nil`, making all sockets anonymous (no per-user broadcast possible).

---

### 1.2 `lib/api_server_web/endpoint.ex`

**Module:** `ApiServerWeb.Endpoint`

| Kind | Name | Line |
|------|------|------|
| `use` macro | `Phoenix.Endpoint, otp_app: :api_server` | 2 |
| socket mount | `/socket` → `ApiServerWeb.UserSocket` | 4 |
| plug | `Plug.Static` — serves `priv/static`, `gzip: false` | 10–12 |
| conditional plugs | `Phoenix.LiveReloader.Socket`, `Phoenix.LiveReloader`, `Phoenix.CodeReloader` (dev only) | 16–20 |
| plug | `Plug.Logger` | 22 |
| plug | `Plug.Parsers` with `:urlencoded`, `:multipart`, `:json`, `:xml`, `Absinthe.Plug.Parser`; `json_decoder: Poison`, `xml_decoder: :xmerl_scan` | 24–28 |
| plug | `Plug.MethodOverride` | 30 |
| plug | `Plug.Head` | 31 |
| plug | `Plug.Session` — cookie store, key `_api_server_key`, `signing_salt: "5CSDVUtC"` | 36–39 |
| plug | `CORSPlug` | 42 |
| plug | `ApiServerWeb.Router` | 43 |
| public callback | `init/2` — conditionally reads `PORT` env var | 51–58 |

**Constants:**
- `signing_salt: "5CSDVUtC"` — hardcoded literal in source.
- Session key: `"_api_server_key"`.
- `gzip: false` on static serving.

---

### 1.3 `lib/api_server_web/gettext.ex`

**Module:** `ApiServerWeb.Gettext`

| Kind | Name | Line |
|------|------|------|
| `use` macro | `Gettext, otp_app: :api_server` | 23 |

No functions or callbacks are defined directly in this file. All public macros (`gettext/1`, `ngettext/3`, `dgettext/2`, etc.) are injected by the `Gettext` library at compile time.

---

### 1.4 `lib/api_server_web/xml_plug.ex`

**Module:** `Plug.Parsers.XML`

| Kind | Name | Line |
|------|------|------|
| `@behaviour` | `Plug.Parsers` | 3 |
| public function | `parse/5` — XML content-type clause: reads body, decodes via `XmlToMap.naive_map/1`, returns `{:ok, %{xml: map}, conn}` | 6–11 |
| public function | `parse/5` — catch-all clause: returns `{:next, conn}` | 13–15 |
| private function | `decode/2` — wraps `XmlToMap.naive_map/1`; raises `Plug.Parsers.ParseError` on exception; hardcoded `raise "Malformed XML"` branch is unreachable | 17–26 |

**Constants / behaviours:**
- Decoder is retrieved from opts via `Keyword.get(opts, :xml_decoder)` — raises `ArgumentError` if missing.
- The `_` catch-all branch inside the `case` (line 21) is dead code: `XmlToMap.naive_map/1` either returns a value or raises; the `_ -> raise "Malformed XML"` arm can never be reached because the `case` has no failing pattern.
- Only the `:ok` tuple from `read_body/2` is handled; the `{:more, partial_body, conn}` and `{:error, reason}` tuples returned by `Plug.Conn.read_body/2` are not pattern-matched, meaning large or erroring request bodies will cause a `FunctionClauseError` at runtime.

---

## 2. Test Coverage Search Results

### 2.1 `test/support/channel_case.ex`
- Defines `ApiServerWeb.ChannelCase` which sets `@endpoint ApiServerWeb.Endpoint` and uses `Phoenix.ChannelTest`.
- **No test file uses `ApiServerWeb.ChannelCase`** — confirmed by the absence of any `*_channel_test.exs` file in the test tree.
- The case template is therefore defined but never instantiated; it provides zero actual coverage.

### 2.2 Grep results across all test files

| Search term | Files matched | Notes |
|-------------|---------------|-------|
| `UserSocket` | 0 | No tests reference the socket module |
| `connect` | 0 | `connect/2` callback never exercised |
| `id(_socket)` / `user_socket` | 0 | `id/1` never exercised |
| `ApiServerWeb.Endpoint` | 2 (conn_case.ex, channel_case.ex) | Only used as `@endpoint` config in support files, never tested directly |
| `Endpoint.init` / `load_from_system_env` / `PORT` | 0 | `init/2` never tested |
| `Gettext` | 0 | No test references the Gettext module |
| `Plug.Parsers.XML` / `xml_plug` / `XmlToMap` / `xml_decoder` | 0 | XML plug never tested |
| `xml` / `XML` / `parse` (in test dir) | 0 | No XML parsing tests at all |

### 2.3 Existing test files assessed for indirect coverage

| Test file | Relevant to assigned files? |
|-----------|----------------------------|
| `calamp_controller_test.exs` | Body is empty (`use` line commented out); no tests execute. |
| `vx_restriction_controller_test.exs` | Exercises JSON endpoints via `ConnCase`; does not send XML payloads. |
| `layout_view_test.exs` | Empty — no tests. |
| `page_view_test.exs` | Empty — no tests. |

**Conclusion: zero test coverage exists for all four assigned source files.**

---

## 3. Findings

---

### B014-1 — No test file for `ApiServerWeb.UserSocket`
**Severity:** HIGH
**File:** `lib/api_server_web/channels/user_socket.ex`

No dedicated test file exists for `ApiServerWeb.UserSocket`. Although `test/support/channel_case.ex` defines the `ChannelCase` helper and sets the correct `@endpoint`, no test module in the repository ever `use`s `ApiServerWeb.ChannelCase`, meaning the helper is dead infrastructure. Neither `connect/2` nor `id/1` is exercised by any test.

---

### B014-2 — `connect/2` has no authentication and is never tested
**Severity:** HIGH
**File:** `lib/api_server_web/channels/user_socket.ex`, line 22–24

`connect/2` unconditionally returns `{:ok, socket}` regardless of the params received. There is no token verification, no credential check, and no rejection path. No test verifies this behaviour, nor is there any test confirming that invalid/missing credentials are (or are not) rejected. This is both a security gap (unauthenticated WebSocket access) and a coverage gap.

---

### B014-3 — `id/1` always returns `nil` and is never tested
**Severity:** MEDIUM
**File:** `lib/api_server_web/channels/user_socket.ex`, line 36

`id/1` always returns `nil`, making all sockets permanently anonymous. No test verifies this return value, nor is there a test confirming that per-user broadcast (e.g. `Endpoint.broadcast/3` keyed on socket id) is not expected. If per-user disconnect broadcasts are ever needed, the hardcoded `nil` will silently prevent them.

---

### B014-4 — No test file for `ApiServerWeb.Endpoint`
**Severity:** HIGH
**File:** `lib/api_server_web/endpoint.ex`

No dedicated test file exists for `ApiServerWeb.Endpoint`. The endpoint is referenced as `@endpoint` in support files but its own configuration — plug pipeline order, session configuration, CORS, parser setup — is never verified in isolation.

---

### B014-5 — `init/2` `load_from_system_env` branch is never tested
**Severity:** MEDIUM
**File:** `lib/api_server_web/endpoint.ex`, lines 51–58

The `init/2` callback has two branches:
1. `load_from_system_env: true` — reads the `PORT` environment variable and raises if absent.
2. The else branch — returns config unchanged.

Neither branch is covered by a test. In particular, the error path (`PORT` not set) which raises a runtime exception is untested and could silently break deployments.

---

### B014-6 — Hardcoded `signing_salt` in endpoint configuration
**Severity:** MEDIUM
**File:** `lib/api_server_web/endpoint.ex`, line 39

The session `signing_salt` value `"5CSDVUtC"` is a literal string committed to source code. No test verifies that this value is configurable via environment or application config. While this is primarily a security concern, it also represents a missing test for configuration hygiene (verifying that the value is loaded from config rather than hardcoded).

---

### B014-7 — No test file for `ApiServerWeb.Gettext`
**Severity:** HIGH
**File:** `lib/api_server_web/gettext.ex`

No test file exists for `ApiServerWeb.Gettext`. The module is a thin wrapper over the `Gettext` library, but no test verifies that translation files are present, that the `otp_app` binding is correct, or that `gettext/1`, `ngettext/3`, or `dgettext/2` resolve strings as expected.

---

### B014-8 — No test file for `Plug.Parsers.XML`
**Severity:** HIGH
**File:** `lib/api_server_web/xml_plug.ex`

No test file exists for the custom XML parser plug. The module implements `Plug.Parsers` behaviour and is referenced in the endpoint's `Plug.Parsers` configuration (endpoint.ex line 25). No integration or unit test sends an XML-content-typed request through the pipeline.

---

### B014-9 — `parse/5` XML clause: `{:more, ...}` and `{:error, ...}` tuples from `read_body/2` not handled
**Severity:** MEDIUM
**File:** `lib/api_server_web/xml_plug.ex`, lines 6–11 and 17–26

`Plug.Conn.read_body/2` can return three shapes:
- `{:ok, body, conn}` — handled by `decode/2`.
- `{:more, partial_body, conn}` — not matched; causes `FunctionClauseError` at runtime for requests whose body exceeds the read buffer.
- `{:error, reason}` — not matched; causes `FunctionClauseError` for network read errors.

Neither the missing pattern-match branches nor the resulting runtime errors are covered by any test.

---

### B014-10 — Dead code branch in `decode/2`: `_ -> raise "Malformed XML"` is unreachable
**Severity:** LOW
**File:** `lib/api_server_web/xml_plug.ex`, lines 19–22

The `case XmlToMap.naive_map(body) do` expression has a wildcard arm (`_ -> raise "Malformed XML"`) that can never be reached: `XmlToMap.naive_map/1` either returns a value (matched by `map ->`) or raises an exception (caught by the surrounding `rescue`). The dead arm creates a false impression of error handling. No test probes malformed XML to expose this gap.

---

### B014-11 — `decode/2` does not handle `{:more, ...}` / `{:error, ...}` from `read_body` (error path untested)
**Severity:** MEDIUM
**File:** `lib/api_server_web/xml_plug.ex`, lines 17–26

Related to B014-9: the `decode/2` private function is only defined for the `{:ok, body, conn}` pattern. The missing clauses for `:more` and `:error` results are untested error paths that would produce unhelpful `FunctionClauseError` exceptions rather than proper `Plug.Parsers.ParseError` responses.

---

### B014-12 — XML parser: missing `:xml_decoder` option raises `ArgumentError` — untested
**Severity:** LOW
**File:** `lib/api_server_web/xml_plug.ex`, line 7

The `parse/5` XML clause raises an `ArgumentError` when no `:xml_decoder` opt is provided. This error path is never exercised by any test. While the endpoint currently supplies the decoder, a misconfiguration would produce an unhelpful crash rather than a meaningful error message.

---

### B014-13 — `calamp_controller_test.exs` is an empty stub
**Severity:** INFO
**File:** `test/api_server_web/controllers/calamp_controller_test.exs`

The `use ApiServerWeb.ConnCase` line is commented out and the module body is empty. This stub provides no coverage and gives a false impression of a tested module. Any XML payloads that would exercise `Plug.Parsers.XML` via the Calamp controller are absent.

---

### B014-14 — `ChannelCase` support module is defined but never used
**Severity:** INFO
**File:** `test/support/channel_case.ex`

`ApiServerWeb.ChannelCase` is fully implemented (Ecto sandbox setup, `Phoenix.ChannelTest` import) but no test file in the repository uses it. The infrastructure for socket/channel testing exists but no tests have been written against it.

---

## 4. Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B014-1 | HIGH | user_socket.ex | No test file exists for `ApiServerWeb.UserSocket` |
| B014-2 | HIGH | user_socket.ex | `connect/2` has no auth and is completely untested |
| B014-3 | MEDIUM | user_socket.ex | `id/1` always returns `nil`; never tested |
| B014-4 | HIGH | endpoint.ex | No test file exists for `ApiServerWeb.Endpoint` |
| B014-5 | MEDIUM | endpoint.ex | `init/2` both branches (including raise on missing PORT) untested |
| B014-6 | MEDIUM | endpoint.ex | Hardcoded `signing_salt` literal; no config-hygiene test |
| B014-7 | HIGH | gettext.ex | No test file exists for `ApiServerWeb.Gettext` |
| B014-8 | HIGH | xml_plug.ex | No test file exists for `Plug.Parsers.XML` |
| B014-9 | MEDIUM | xml_plug.ex | `{:more, ...}` and `{:error, ...}` from `read_body/2` not handled or tested |
| B014-10 | LOW | xml_plug.ex | Dead `_ -> raise "Malformed XML"` branch in `decode/2` |
| B014-11 | MEDIUM | xml_plug.ex | `decode/2` missing clauses for `:more`/`:error`; error path untested |
| B014-12 | LOW | xml_plug.ex | Missing `:xml_decoder` option raises `ArgumentError`; untested |
| B014-13 | INFO | calamp_controller_test.exs | Test file is an empty stub; no coverage provided |
| B014-14 | INFO | channel_case.ex | `ChannelCase` support module defined but never used by any test |

<!-- B015.md -->
# Audit Report B015
**Audit Run:** 2026-02-27-01
**Agent:** Pass 2 / B015
**Scope:** Controller test coverage analysis
**Files Audited:**
- `lib/api_server_web/controllers/calamp_controller.ex`
- `lib/api_server_web/controllers/digital_matter_controller.ex`
- `lib/api_server_web/controllers/fallback_controller.ex`
- `lib/api_server_web/controllers/file_controller.ex`

---

## READING EVIDENCE

### 1. `ApiServerWeb.CalampController`
**File:** `lib/api_server_web/controllers/calamp_controller.ex`

**Functions defined:**

| Line | Visibility | Name | Signature |
|------|-----------|------|-----------|
| 4 | public | `recieve_calamp_data/2` | `(conn, %{xml: calamp_data})` |
| 31 | private | `validate/3` | `(new_event, current_event, thing)` |

**Types / structs / constants:** None defined in this module.

**Notes:**
- `recieve_calamp_data` contains a typo in the name ("recieve" instead of "receive").
- The action hardcodes `customer = "vx_dev"`.
- Steps 2 (save record), 3 (update SummaryRecord), and 4 (update ThingInfo) are commented out — only step 1 (generate ThingEvent) and the final `send_resp` are executed.
- `validate/3` performs three `DateTime.diff` and one arithmetic comparison but returns no value and has no side effects — its result is discarded by the caller.
- `IO.inspect` and multiple `IO.puts` calls are left in production code paths.

---

### 2. `ApiServerWeb.DigitalMatterController`
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`

**Functions defined:**

| Line | Visibility | Name | Signature |
|------|-----------|------|-----------|
| 4 | public | `get_g62_data/2` | `(conn, params)` |

**Types / structs / constants:** None defined in this module.

**Notes:**
- Routed at `POST /` (root scope, `api_xml` pipeline) — see `router.ex` line 188.
- Iterates over `params["Records"]` with `Enum.each/2`, processing each record individually.
- `reason` is pattern-matched for values 1, 2, 3, 11, 16, 17; all other values fall through to `{255, reason}`.
- `date_formatted` falls back to raw `record["DateUTC"]` string or `"invalid"` on parse error.
- `driver_id["DriverID"]` access at line 172–176 will raise `FunctionClauseError` / `[REDACTED-AWS-SMTP-PASSWORD]` if `driver_id` is `nil` (i.e., no FType 3 field found in the record).
- `trip_hours["Dur"]` at line 139 will raise if `trip_hours` is `nil` (no FType 26 field).
- `run_hours["RH"]` at line 197 will raise if `run_hours` is `nil` despite the `nil` guard only protecting `run_hours["Odo"]` at lines 142–148.
- Customer is hardcoded to `"CEA"` (line 200) and `"vx_dev"` (line 200).
- Email sending is commented out (lines 17–18 and lines 229–238).
- The function does not return a unified response: the `Enum.each` side-effects attempt to send responses per-record but `conn` is not threaded through; after the `Enum.each` the function returns `:ok` (the return of `Enum.each`) which leaves the connection hanging if the `get_vx_thing_with_hardware_id!` path is hit on every iteration without a final explicit response outside the loop.

---

### 3. `ApiServerWeb.FallbackController`
**File:** `lib/api_server_web/controllers/fallback_controller.ex`

**Functions defined:**

| Line | Visibility | Name | Signature |
|------|-----------|------|-----------|
| 9 | public | `call/2` | `(conn, {:error, %Ecto.Changeset{} = changeset})` — renders 422 |
| 15 | public | `call/2` | `(conn, {:error, :not_found})` — renders 404 |

**Types / structs / constants:** None defined in this module.

**Notes:**
- Module is a Phoenix action-fallback controller; `call/2` is invoked by Phoenix when a controller action returns an `{:error, ...}` tuple and the controller declares `action_fallback ApiServerWeb.FallbackController`.
- Only `ApiServerWeb.FileController` in the audited set uses `action_fallback` pointing to this module.
- No clause handles `{:error, :unauthorized}`, `{:error, :forbidden}`, or any other error atom.

---

### 4. `ApiServerWeb.FileController`
**File:** `lib/api_server_web/controllers/file_controller.ex`

**Functions defined:**

| Line | Visibility | Name | Signature |
|------|-----------|------|-----------|
| 12 | public | `get_size/2` | `(conn, %{"esn" => hardwareid})` |
| 28 | public | `send_file_download/2` | `(conn, %{"esn" => hardwareid})` |
| 42 | private | `generate_binary_file_contents/1` | `(operator_string)` |
| 52 | private | `check_crc/1` | `(crc_string)` |

**Types / structs / constants:** None defined in this module.

**Notes:**
- Routed at `GET /api/v1/files/getsize/:esn` and `GET /api/v1/files/getfile/:esn` — both under the unauthenticated `api` pipeline (router.ex lines 165–166).
- `check_crc/1` handles only CRC hex strings of length 1–4; a length outside that range raises `CaseClauseError`.
- `IO.puts` calls are left in production paths (lines 16, 45, 46).
- `action_fallback ApiServerWeb.FallbackController` is declared; however, neither public action returns `{:error, ...}` tuples — they call `Vx.get_vx_thing_with_hardware_id!` (bang function, raises on not found) and `send_download`/`render`, so the fallback is effectively unreachable for these actions.

---

## TEST COVERAGE ANALYSIS

### Direct test file: `test/api_server_web/controllers/calamp_controller_test.exs`

The file contains:
```elixir
defmodule ApiServerWeb.CalampControllerTest do
    # use ApiServerWeb.ConnCase

end
```

The `use ApiServerWeb.ConnCase` line is commented out. There are **zero test cases** defined. The file is a stub with no executable content.

### Indirect coverage (grep of entire `test/` tree)

| Search term | Matches |
|-------------|---------|
| `[REDACTED-AWS-SMTP-PASSWORD]` | 0 |
| `digital_matter` | 0 |
| `get_g62_data` | 0 |
| `FallbackController` | 0 |
| `fallback_controller` | 0 |
| `action_fallback` | 0 |
| `FileController` | 0 |
| `file_controller` | 0 |
| `get_size` | 0 |
| `send_file_download` | 0 |
| `generate_binary` | 0 |
| `check_crc` | 0 |

**All four source files have zero test coverage** — direct or indirect.

---

## FINDINGS

---

### B015-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Finding:** The test file `test/api_server_web/controllers/calamp_controller_test.exs` exists but is entirely empty (the `use ApiServerWeb.ConnCase` macro is commented out and no test cases are defined). The sole public action `recieve_calamp_data/2` has zero test coverage.

**Evidence:**
```elixir
defmodule ApiServerWeb.CalampControllerTest do
    # use ApiServerWeb.ConnCase
end
```
No `test` blocks anywhere in the file. No indirect coverage found in the rest of the test suite.

---

### B015-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.DigitalMatterController` and no indirect coverage was found anywhere in the test suite. The single public action `get_g62_data/2` — which is the root POST handler for the entire application and processes incoming device telemetry — is completely untested.

---

### B015-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/fallback_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.FallbackController` and no indirect coverage was found. Both `call/2` clauses (422 Changeset error, 404 not-found) are untested.

---

### B015-4
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.FileController` and no indirect coverage was found. Both public actions `get_size/2` and `send_file_download/2` are completely untested.

---

### B015-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Function:** `recieve_calamp_data/2` (line 4)
**Finding:** The success path (`send_resp(conn, :ok, "{}")`) is untested. There is no test verifying that a well-formed XML payload results in a 200 response.

---

### B015-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Function:** `recieve_calamp_data/2` (line 4)
**Finding:** The private `validate/3` function (line 31) is called but its return value is discarded. No test exists to verify correct behaviour when `current_event` is `nil` (i.e., `ApiServer.Vx.get_most_recent_thingevent/2` returns `nil`). `DateTime.diff(new_event.gmtdatetime, nil.gmtdatetime)` would raise at runtime.

---

### B015-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** The not-found path (`ApiServer.Vx.get_vx_thing_with_hardware_id!` returning `nil`, line 202) is untested. There is no test verifying that the function responds with HTTP 400 and the expected JSON body when the hardware ID is unknown.

---

### B015-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** The Ecto error path (line 217: `{:error, error}`) when `ApiServer.Vx.create_thingevent_record/2` fails is untested. There is no test verifying the HTTP 400 response and the error message body returned in that case.

---

### B015-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** The date-parse error path (line 113: `{:error, error}`) when `Timex.parse/2` fails is untested. No test verifies the fallback to the raw `record["DateUTC"]` string or the `"invalid"` sentinel value.

---

### B015-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/fallback_controller.ex`
**Function:** `call/2` — Changeset clause (line 9)
**Finding:** The 422 Unprocessable Entity response path for Ecto Changeset errors is untested. No test verifies that the changeset error JSON is rendered correctly.

---

### B015-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/fallback_controller.ex`
**Function:** `call/2` — not-found clause (line 15)
**Finding:** The 404 Not Found response path is untested. No test verifies the correct HTTP status and error view rendering.

---

### B015-12
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Function:** `get_size/2` (line 12)
**Finding:** The success path for `get_size/2` is untested. No test verifies the JSON response containing `size`, `hardwareid`, and `num_fobs` fields.

---

### B015-13
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Function:** `send_file_download/2` (line 28)
**Finding:** The success path for `send_file_download/2` is untested. No test verifies the binary file download response, including the dynamically generated filename (`SM-<unix_ts>-<hardwareid>.bin`) and the CRC-appended binary content.

---

### B015-14
**Severity:** LOW
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Function:** `recieve_calamp_data/2` (line 4)
**Finding:** No edge-case tests exist for malformed or missing XML payload fields (e.g., missing `document_root`, `nil` `hardwareid`, missing datetime fields). Pattern-match on `%{xml: calamp_data}` will cause a `FunctionClauseError` if the key is absent.

---

### B015-15
**Severity:** LOW
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** No test covers the case where `params["Records"]` is `nil` or an empty list. An empty list causes no records to be processed and no response to be sent, leaving the connection open. A `nil` value causes `Enum.each/2` to raise `Protocol.UndefinedError`.

---

### B015-16
**Severity:** LOW
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** No test covers records where `driver_id` (FType 3) is `nil`. At line 172, `driver_id["DriverID"]` will raise `[REDACTED-AWS-SMTP-PASSWORD]` (map access on `nil`) when no FType 3 field is present in a record. Similarly, `trip_hours["Dur"]` at line 139 raises when FType 26 is absent, and `run_hours["RH"]` at line 197 raises when FType 27 is absent despite the surrounding nil guard only covering `run_hours["Odo"]`.

---

### B015-17
**Severity:** LOW
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`
**Function:** `get_g62_data/2` (line 4)
**Finding:** No test covers unmapped `reason` values (the `_` catch-all producing `{255, reason}`). The behaviour of downstream processing for a `{255, reason}` event code is untested.

---

### B015-18
**Severity:** LOW
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Function:** `check_crc/1` (line 52)
**Finding:** `check_crc/1` handles only hex CRC strings of length 1, 2, 3, or 4. A CRC value that produces a hex string longer than 4 characters (theoretically impossible for CRC-16 but worth guarding) or of length 0 will raise `CaseClauseError`. No test covers any of these boundary cases.

---

### B015-19
**Severity:** LOW
**File:** `lib/api_server_web/controllers/file_controller.ex`
**Function:** `get_size/2` and `send_file_download/2` (lines 12, 28)
**Finding:** Both actions use the bang variant `Vx.get_vx_thing_with_hardware_id!/1` (no customer argument — different arity from the version in other controllers). If the hardware ID does not exist this raises an exception rather than returning an error tuple, bypassing the declared `action_fallback`. No test covers the not-found scenario.

---

### B015-20
**Severity:** INFO
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Finding:** The function name `recieve_calamp_data` is a misspelling of "receive". While not a test coverage gap, it is a code quality issue that would affect any route helper or test that references the action by name.

---

### B015-21
**Severity:** INFO
**File:** `lib/api_server_web/controllers/calamp_controller.ex`, `lib/api_server_web/controllers/digital_matter_controller.ex`, `lib/api_server_web/controllers/file_controller.ex`
**Finding:** Multiple `IO.inspect` and `IO.puts` calls are present in production code paths across three of the four audited controllers. These are not test-related issues but indicate debug instrumentation that was never removed, and they cannot be verified as intentional by any test.

---

### B015-22
**Severity:** INFO
**File:** `lib/api_server_web/controllers/calamp_controller.ex`
**Finding:** The CalAmp controller route is not visible in `router.ex` — no route maps to `CalampController`. The controller exists and has a public action but is apparently not reachable via any HTTP route. This means even an integration test framework would not be able to exercise it through the router without directly invoking the controller function.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B015-1 | HIGH | calamp_controller.ex | Test file exists but is empty (ConnCase commented out, no test cases) |
| B015-2 | HIGH | digital_matter_controller.ex | No test file, no indirect coverage; root POST handler fully untested |
| B015-3 | HIGH | fallback_controller.ex | No test file, no indirect coverage; both call/2 clauses untested |
| B015-4 | HIGH | file_controller.ex | No test file, no indirect coverage; both public actions untested |
| B015-5 | MEDIUM | calamp_controller.ex | `recieve_calamp_data/2` success path (200 response) untested |
| B015-6 | MEDIUM | calamp_controller.ex | `validate/3` called with potentially nil `current_event`; nil crash path untested |
| B015-7 | MEDIUM | digital_matter_controller.ex | `get_g62_data/2` not-found 400 path untested |
| B015-8 | MEDIUM | digital_matter_controller.ex | `get_g62_data/2` Ecto create error path untested |
| B015-9 | MEDIUM | digital_matter_controller.ex | `get_g62_data/2` Timex parse error/fallback path untested |
| B015-10 | MEDIUM | fallback_controller.ex | `call/2` Changeset 422 response untested |
| B015-11 | MEDIUM | fallback_controller.ex | `call/2` :not_found 404 response untested |
| B015-12 | MEDIUM | file_controller.ex | `get_size/2` success path untested |
| B015-13 | MEDIUM | file_controller.ex | `send_file_download/2` success path untested |
| B015-14 | LOW | calamp_controller.ex | No edge-case tests for malformed/missing XML fields |
| B015-15 | LOW | digital_matter_controller.ex | No test for nil or empty `Records` list |
| B015-16 | LOW | digital_matter_controller.ex | No test for records missing FType 3/26/27 fields (nil access crash) |
| B015-17 | LOW | digital_matter_controller.ex | No test for unmapped `reason` values in catch-all clause |
| B015-18 | LOW | file_controller.ex | `check_crc/1` boundary cases for length 0 or > 4 untested |
| B015-19 | LOW | file_controller.ex | Bang function not-found crash path bypasses fallback; untested |
| B015-20 | INFO | calamp_controller.ex | Misspelled function name `recieve_calamp_data` |
| B015-21 | INFO | calamp, digital_matter, file controllers | `IO.inspect`/`IO.puts` left in production code paths |
| B015-22 | INFO | calamp_controller.ex | No router entry found for CalampController; action unreachable via HTTP |

<!-- B016.md -->
# Audit Report B016
**Audit run:** 2026-02-27-01
**Agent:** B016
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/controllers/geofence_controller.ex`
2. `lib/api_server_web/controllers/page_controller.ex`
3. `lib/api_server_web/controllers/pivotel_controller.ex`
4. `lib/api_server_web/controllers/utility_controller.ex`

---

## Test Coverage Search Results

A grep for all four module names (`GeofenceController`, `PageController`, `PivotelController`, `UtilityController`) across the entire `test/` directory returned **no matches**. A second sweep covering all public function names from these modules also returned **no matches**. The known test files (`calamp_controller_test.exs`, `vx_restriction_controller_test.exs`, `layout_view_test.exs`, `page_view_test.exs`) contain no references to any of these controllers.

**Conclusion: zero test coverage exists — direct or indirect — for any of the four assigned source files.**

---

## READING EVIDENCE

### 1. `ApiServerWeb.GeofenceController`

**Module:** `ApiServerWeb.GeofenceController`
**Aliases/imports:** `ApiServer.Vx`, `ApiServer.Vx.Geofence`, `Ecto.Query`, `ApiServer.Repo`

| Line | Name | Visibility | Type |
|------|------|-----------|------|
| 11 | `list_all_geofences/2` | public | action (`conn`, `_params`) |
| 18 | `create_geofence/2` | public | action (`conn`, `%{"geofence" => …}`) |
| 35 | `update_geofence/2` | public | action (`conn`, `%{"geofence" => …}`) |
| 57 | `delete_geofence/2` | public | action (`conn`, `%{"id" => id}`) |
| 73 | `process_things_geofences/2` | public | action (`conn`, `%{"hardwareid" => …, "from" => …, "to" => …}`) |
| 96 | `check_geofences_for_unit/6` | private | helper |
| 115 | `does_event_cause_geofence_events/6` | private | helper |
| 132 | `check_event_for_left_events/6` (nil clause) | private | helper |
| 133 | `check_event_for_left_events/6` (list clause) | private | helper |
| 149 | `check_event_for_entered_events/7` | private | helper |
| 168 | `make_geofence_event/6` | private | helper |
| 184 | `engine_hours_at_event/3` | private | helper — nine `aadcat` branches (2–9) |

**Constants/structs defined:** none directly; relies on `%Geofence{}` struct from alias.

---

### 2. `ApiServerWeb.PageController`

**Module:** `ApiServerWeb.PageController`

| Line | Name | Visibility | Type |
|------|------|-----------|------|
| 4 | `index/2` | public | action (`conn`, `_params`) |

**Constants/structs defined:** none.

---

### 3. `ApiServerWeb.PivotelController`

**Module:** `ApiServerWeb.PivotelController`

| Line | Name | Visibility | Type |
|------|------|-----------|------|
| 4 | `get_pivotel_data/2` (PSG_MOmsg_send clause) | public | action — matched pattern `%{xml: %{"PSG_MOmsg_send" => …}}` |
| 15 | `get_pivotel_data/2` (fallback clause) | public | action — `%{}` catch-all → 500 |
| 20 | `create_update_object/1` (LOCATION cause clause) | public | parser |
| 63 | `create_update_object/1` (ACCUM cause clause) | public | parser |
| 103 | `create_update_object/1` (fallback clause) | public | parser → returns `%{}` |
| 109 | `convert_timestamp/1` | private | timestamp converter |

**Constants/structs defined:** none.

---

### 4. `ApiServerWeb.UtilityController`

**Module:** `ApiServerWeb.UtilityController`
**Behaviour/use:** `Bamboo.Phoenix` (view: `ApiServer.EmailView`)
**Key aliases:** `ApiServer.Vx`, `VXCustomer`, `ERPImport`, `VXThingInfo`, `Repo`, `VXThingEvent`, `VXThingEventOmega`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXRayvenMessageLog`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXThingSummary`, `Equipment`, `EquipmentAssignment`, `VXRental`, `RentalPeriod`, `RentalContract`

**Module-level constant:**

| Lines | Name | Type |
|-------|------|------|
| 25–126 | `@lookup_olson` | module attribute — list of `{windows_tz, olson_tz}` tuples (93 entries) |

**Functions:**

| Line | Name | Visibility | Notes |
|------|------|-----------|-------|
| 128 | `update_puls_firmware/1` | public | No `conn`; calls CalAmp PULS HTTP API |
| 228 | `bulk_daily_usage_summary/1` | public | No `conn`; writes CSV file; hard-coded dates |
| 320 | `do_health_check/2` | public | action — returns 200 `{}` |
| 324 | `calculate_roi_value/2` | public | action — body is **empty** (no implementation) |
| 328 | `process_incoming_omegawatch_data/2` | public | action — echoes params |
| 333 | `process_prodisplay_event/2` | public | action — 4-key pattern match; writes to three DB tables; dual-customer routing (vx_sssl, vx_mondialevgl) |
| 701 | `parse_prodisplay_thingevent/4` | private | parses event metadata |
| 806 | `parse_prodisplay_thingomega_event/5` | private | parses omega event |
| 923 | `parse_prodisplay_thingomegatires_event/5` | private | parses tires event |
| 982 | `do_error/2` | public | action — reflects arbitrary HTTP status code |
| 991 | `do_geocode_lookup/2` | public | action — lat/long reverse geocode via Geonames/ConCache |
| 1052 | `sync_to_DISCorp/2` | public | action — hard-coded payload; calls DISCorp API |
| 1076 | `sync_vehicles_to_rayven/1` | public | No `conn`; customer-specific allowlist logic |
| 1203 | `test_rental_messages/1` | public | No `conn`; iterates things, actual send is commented out |
| 1445 | `send_vehicle_to_rayven/2` | public | No `conn`; builds and sends vehicle JSON to Rayven |
| 1677 | `send_to_rayven/7` | public | No `conn`; core Rayven HTTP POST; handles nil/empty serialno; logs to DB |
| 1986 | `pull_from_rayven/1` | public | No `conn`; pulls from Rayven API pull endpoint |
| 2009 | `check_out_of_sequence_events/1` | public | No `conn`; analyses event ordering |
| 2078 | `get_tracker_ids/0` | public | No `conn`; queries DeviceDatabaseLookup |
| 2093 | `device_lookup_with_hardware_id/1` | public | No `conn`; DB lookup |
| 2100 | `check_vehicles_for_rental_overage/3` | public | No `conn`; generates CSV + sends email |
| 2280 | `process_monthly_movements/0` | public | No `conn`; reads local CSV files |
| 2463 | `process_pronto/0` | public | No `conn`; reads local CSV file; calls `Vx.get_most_recent_thingevent_with_date` |
| 2821 | `process_ebs/0` | public | No `conn`; reads local CSV file |
| 2972 | `process_ebs_check_service/1` | public | Pure string check; no `conn` |
| 2990 | `process_ebs_get_hour_meter/2` | public | DB query; no `conn` |
| 3036 | `send_local_arrow_data/0` | public | No `conn`; reads CSV + sends to Rayven IOTX8 |
| 3170 | `check_vehicles_for_no_usage_historical/1` | public | No `conn`; writes usage_report.csv |
| 3213 | `process_events_for_next_usage/4` | public | No `conn`; recursive |
| 3298 | `sync_events_to_rayven/0` | public | No `conn`; hard-coded customer `vx_sielift` |
| 3346 | `rayven_login/2` | public | No `conn`; **body is entirely comments** — no implementation |
| 3390 | `get_rayven_devices_for_project/2` | public | No `conn`; calls Rayven external API |
| 3412 | `pull_data_from_rayven/1` | public | No `conn`; calls Rayven apipull endpoint |
| 3453 | `create_equipment/3` | public | No `conn`; creates Equipment record |
| 3524 | `get_equipment_id/2` | public | No `conn`; DB lookup |
| 3533 | `create_equipment_assignment/3` | public | No `conn`; uses `@lookup_olson` for timezone mapping |
| 3596 | `create_rental_records/1` | public | No `conn`; **body is comment only** — no implementation |
| 3600 | `sync_rental_contracts_to_rayven/1` | public | No `conn`; **body returns a bare map literal** — no implementation |
| 3615 | `sync_rental_periods_to_rayven/1` | public | No `conn`; **body returns `%{}`** — no implementation |
| 3623 | `copy_rental_contracts/1` | public | No `conn`; complex rental period + Rayven sync |
| 4647 | `pull_equipment_data_from_rayven/1` | public | No `conn`; iterates customer devices, calls Rayven |
| 4729 | `pull_services_from_rayven/1` | public | No `conn`; calls Rayven apipull + posts to erp-import endpoint |
| 4900 | `refresh_rayven_stream_status/1` | public | No `conn`; async_stream with rescue block |
| 5020 | `sync_historical_events_to_rayven/1` | public | No `conn`; calls `refresh_rayven_stream_status` then dispatches per-unit |
| 5091 | `sync_historical_events_to_rayven/5` | public | No `conn`; overload with `(customer, batch_number, batch_size, tracker_ids, delay)` |
| 5358 | `send_events_to_rayven/6` | public | No `conn`; checks for future dates, prepares and sends events |
| 5416 | `prepare_rayven_events/3` | public | No `conn`; maps events to Rayven payload format |
| 5567 | `check_for_future_date/2` | public | No `conn`; deletes or corrects future-dated events |
| 5666 | `erp_import/2` | public | action — processes ERP rentals and services; `from` email → customer mapping |
| 6025 | `driverid_converter/2` | public | action — converts Wiegand driver IDs |
| 6172 | `get_additional_data/1` | public | No `conn`; reads `vehicle_status.csv` |
| 6225 | `next_service/1` | public | No `conn`; reads `next_services.csv` |
| 6264 | `rayven_ssl_opts/0` | private | builds SSL opts list |
| 6278 | `rayven_cacerts/0` | private | loads CA certs from disk + certifi |
| 5735 | `check_and_save_erp_record/3` | private | saves ERP import record |
| 5758 | `process_rental_from_erp/2` | private | creates/updates rental from ERP payload |
| 5850 | `find_or_make_customer/3` | private | finds or creates VXCustomer |
| 5882 | `process_services_from_erp/2` | private | unused within this file (called nowhere within the module) |
| 5896 | `process_service_from_erp/2` | private | processes a single service record from ERP |
| 6092 | `get_dm_driverid/1` | private | bit-manipulation Wiegand conversion |

---

## Findings

---

### B016-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/geofence_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.GeofenceController`, and no indirect test coverage was found anywhere in `test/`. The module contains five public HTTP actions including create, update, and delete operations against a geofence database, plus a complex geofence event processor (`process_things_geofences`).

---

### B016-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/page_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.PageController`, and no indirect coverage was found. While this controller contains only a single trivial `index/2` action, the existing `test/api_server_web/views/page_view_test.exs` tests the view layer only and does not exercise the controller action or its rendered output end-to-end.

---

### B016-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/pivotel_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.PivotelController`, and no indirect coverage was found. The controller receives XML-wrapped Pivotel satellite device messages, parses them into telemetry records, and delegates to `VXThingEventController.write_partial_record/3`. None of the three `create_update_object/1` clauses, the fallback 500 path, or the `convert_timestamp/1` helper are tested.

---

### B016-4
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.UtilityController`, and no indirect coverage was found. The module is 6,293 lines and contains approximately 50 public functions, including critical production HTTP actions (`erp_import/2`, `driverid_converter/2`, `do_health_check/2`, `process_prodisplay_event/2`, `do_geocode_lookup/2`, `do_error/2`) and numerous scheduler/batch functions that interact directly with the database and external HTTP APIs (Rayven, CalAmp PULS, DISCorp, Geonames).

---

### B016-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/geofence_controller.ex`
**Function:** `create_geofence/2` (line 18)
**Finding:** The failure branch `{:error, error}` at line 29–32 returns a 500 with an `inspect`-formatted error in the response body. This path is untested. A changeset validation error or DB constraint violation would hit this path in production.

---

### B016-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/geofence_controller.ex`
**Function:** `update_geofence/2` (line 35)
**Finding:** Two untested failure paths exist: (a) the `geofence == nil` branch at line 52–54, which returns a 500 when no geofence matches the supplied ID; (b) the `status != :ok` branch at line 50, which returns a 500 on update failure.

---

### B016-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/geofence_controller.ex`
**Function:** `delete_geofence/2` (line 57)
**Finding:** Two untested failure paths: (a) `geofence` is falsy (nil) → returns 500 "No geofence with that ID to delete" (line 69); (b) `{:error, _}` from `Vx.delete_geofence/2` → returns 500 (line 66).

---

### B016-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/geofence_controller.ex`
**Function:** `process_things_geofences/2` (line 73)
**Finding:** No test exercises this action. It calls `Date.from_iso8601!` (bang — raises on bad input), `Timex.to_datetime`, `Vx.get_augmented_thing_with_hardware_id!`, and `Vx.get_geofences_as_map`. Invalid date strings or unknown hardware IDs will raise an uncaught exception, and no test verifies graceful error handling or correct event calculation.

---

### B016-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/geofence_controller.ex`
**Function:** `engine_hours_at_event/3` (line 184)
**Finding:** Nine `aadcat` branches (2–9) are completely untested. Branch 4 (`aadcat == 4`, Omega) and branch 5 (`aadcat == 5`, J1939) both execute `Repo.one(Ecto.assoc(event, :thingeventomega))` which can return `nil`, leading to a `nil.totalenginehour` crash. No test verifies any of the nine paths or nil-safety.

---

### B016-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/pivotel_controller.ex`
**Function:** `get_pivotel_data/2` (line 4, PSG_MOmsg_send clause)
**Finding:** The happy-path action is untested. It calls `create_update_object/1` then delegates to `VXThingEventController.write_partial_record/3`. No test verifies the `{:ok, "{}"}` response.

---

### B016-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/pivotel_controller.ex`
**Function:** `get_pivotel_data/2` (line 15, fallback clause)
**Finding:** The fallback catch-all that returns a 500 is untested. It is reached whenever the `xml` key is missing from params or the XML does not match the expected structure.

---

### B016-12
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/pivotel_controller.ex`
**Function:** `create_update_object/1` — LOCATION clause (line 20) and ACCUM clause (line 63)
**Finding:** Both parsing clauses are untested. The LOCATION clause calls `String.to_float(latitude)` and `String.to_float(longitude)` which will crash if either value is not a valid float string. The ACCUM clause similarly calls `String.to_float/1` three times. No test verifies correct map construction or error resilience.

---

### B016-13
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/pivotel_controller.ex`
**Function:** `create_update_object/1` — fallback clause (line 103)
**Finding:** The fallback clause returns `%{}` when the message does not match known structures. This is then passed to `write_partial_record/3` as an empty map. No test verifies that an unrecognised message is handled gracefully end-to-end.

---

### B016-14
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `erp_import/2` (line 5666)
**Finding:** This is a critical ingestion endpoint used in production by multiple customers (SieLift, CEA, Komatsu AU, Yocam, Redpath). The `from`-to-customer mapping is untested, as are all rental and service processing code paths, the fallback `"vx_dev"` customer for unrecognised senders, the duplicate-check filter logic (`Vx.check_for_existing_erp_record`), and the error branch for `process_rental_from_erp` (line 5832–5834).

---

### B016-15
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `process_prodisplay_event/2` (line 333)
**Finding:** This action contains four deeply nested `case` branches covering ceaomega-only, vx_mondialevgl dual-write, and vx_sssl dual-write paths. Every branch is untested. The action also hard-codes the customer `"vx_ceaomega"` at line 339 regardless of the JWT claim, which means it cannot serve multi-tenant traffic without a code change.

---

### B016-16
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `driverid_converter/2` (line 6025)
**Finding:** The Wiegand bit-manipulation logic in `get_dm_driverid/1` (line 6092) is complex and entirely untested. It calls `String.split_at(driverid, 3)` and `String.to_integer` on the resulting parts without validation — a driverid shorter than 3 characters will produce an empty string, and `String.to_integer("")` will raise `ArgumentError`.

---

### B016-17
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `check_for_future_date/2` (line 5567)
**Finding:** This function permanently deletes events from the database (`Vx.delete_thingevent_record`) when `gmtdatetime - dateinqueue > 3600` seconds. It also modifies event timestamps in-place for smaller differences. Both mutation paths are completely untested. A bug here silently destroys production telemetry data.

---

### B016-18
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `send_to_rayven/7` (line 1677)
**Finding:** The `nil` and `""` serial number branches (lines 1687–1730) silently do nothing (commented-out email code). No test verifies that these silent-drop paths are reached correctly, and a vehicle with no serial number will never emit an error to the caller.

---

### B016-19
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `do_geocode_lookup/2` (line 991)
**Finding:** Uses `Float.parse/1` on user-supplied lat/long, then calls `Geonames.find_nearby_streets_osm/1` and `Geonames.find_nearby_place_name/1` via `ConCache.get_or_store/3`. The `streets` variable at line 1016 has three branches: a single-item map (count == 7), a list (non-nil), and fallback to place name. The single-item branch at line 1016 calls `IO.inspect()` and pipes to `Map.get("name")` — the `IO.inspect` return value is the same map, so it works, but non-string `lat`/`long` params or a nil Geonames response in the fallback will crash unchecked.

---

### B016-20
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `process_ebs_get_hour_meter/2` (line 2990)
**Finding:** Hard-codes `prefix: "vx_cea_latest"` (line 3002) regardless of the `customer` argument passed in. This means it always queries one specific customer's database. No test exists to detect this customer-scoping bug.

---

### B016-21
**Severity:** LOW
**File:** `lib/api_server_web/controllers/geofence_controller.ex`
**Function:** `check_event_for_left_events/6` (line 132)
**Finding:** The nil-clause guard at line 132 returns bare `[]` (a list) instead of the tuple `{[], []}` that the caller at line 126 destructures into `{fences_still_inside, left_events}`. This is a **latent runtime crash**: if `currently_in_geofences` is `nil`, the pattern match `{fences_still_inside, left_events} = []` will raise `MatchError`. No test covers this nil path.

---

### B016-22
**Severity:** LOW
**File:** `lib/api_server_web/controllers/geofence_controller.ex`
**Function:** `process_things_geofences/2` (line 73)
**Finding:** `from_date` and `to_date` are parsed with `Date.from_iso8601!` (bang). No test verifies error handling for invalid date format strings (e.g., `"not-a-date"`), which would raise `ArgumentError` and produce an unformatted 500 response.

---

### B016-23
**Severity:** LOW
**File:** `lib/api_server_web/controllers/pivotel_controller.ex`
**Function:** `convert_timestamp/1` (line 109)
**Finding:** Uses `NaiveDateTime.from_iso8601!` and `DateTime.from_naive!` (both bang). No test covers a malformed timestamp string, which would raise and crash the process.

---

### B016-24
**Severity:** LOW
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `calculate_roi_value/2` (line 324)
**Finding:** This is a public HTTP action whose body is completely empty (no return value, no response sent to `conn`). Elixir will return `nil` from the function and Phoenix will raise a `Plug.Conn.NotSentError`. No test detects this broken action.

---

### B016-25
**Severity:** LOW
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Functions:** `rayven_login/2` (line 3346), `create_rental_records/1` (line 3596), `sync_rental_contracts_to_rayven/1` (line 3600), `sync_rental_periods_to_rayven/1` (line 3615)
**Finding:** These four public functions have no real implementation: `rayven_login/2` contains only comments; `create_rental_records/1` contains only a comment; `sync_rental_contracts_to_rayven/1` and `sync_rental_periods_to_rayven/1` return bare map literals and do nothing. These stubs are callable from routes or schedulers with no visible indication they are not implemented, and no test documents their stub status.

---

### B016-26
**Severity:** LOW
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `create_equipment_assignment/3` (line 3533)
**Finding:** Uses `@lookup_olson` to map Windows timezone names to Olson names. The lookup at line 3568 returns `nil` if the timezone string is not in the table, setting `mapped_device_group_timezone` to `nil`. No test verifies the timezone-mapping path, the nil fallback, or the "append Standard Time" retry at line 3571.

---

### B016-27
**Severity:** LOW
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `get_additional_data/1` (line 6172) and `next_service/1` (line 6225)
**Finding:** Both functions read local CSV files (`vehicle_status.csv`, `next_services.csv`) using `File.stream!`. If the file does not exist, `File.stream!` raises `File.Error`. In a deployed environment where these files are absent, any call to `send_vehicle_to_rayven/2` will crash. No test verifies the file-present or file-absent behaviour.

---

### B016-28
**Severity:** LOW
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Function:** `erp_import/2` (line 5666) — `process_rental_from_erp/2` sub-call
**Finding:** `process_rental_from_erp/2` at line 5758 calls `Vx.get_rental/4` with a pattern `{:ok, new_rental}` but `Vx.get_rental/4` may also return a plain struct or `nil` (lines 5826–5843). The current match at line 5823–5826 handles `{:ok, new_rental}` but this looks inconsistent with the nil and `existing_rental` clauses below it — the function appears to mix return-value conventions. No test exercises these branches to confirm correctness.

---

### B016-29
**Severity:** INFO
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Finding:** The module contains multiple `IO.puts` and `IO.inspect` calls scattered throughout production action and batch functions (e.g., lines 133, 182, 187, 259, 329, 742, 752, 1019, 1034, 1045, 1071, 1078, 1092, etc.). While not a test coverage gap, these debug statements will log potentially sensitive data (hardware IDs, customer codes, request bodies) to stdout in production. No test verifies or gates their presence.

---

### B016-30
**Severity:** INFO
**File:** `lib/api_server_web/controllers/utility_controller.ex`
**Finding:** The `update_puls_firmware/1` function at line 128 contains API keys for CalAmp PULS hard-coded in comments (lines 140–141): `IwZTptJkQeOxZCoKRKVtI3IrIVwotFW6KRDS8O8OI-RKjmykQ95DPGlEE4yxjqbg` and `1SdeU1293s78waU_2P3vwCInz2oEOe-Rj6_AYqL-FwBzFtsG3n_o5mNsqat5rO4L`. The active key used in the live call at line 146 is also embedded as a string literal. Similarly, `send_to_rayven/7` at line 1747 hard-codes a Rayven UID token. These credentials are committed to source control. This is an informational note for the secrets audit pass; it also means no test can safely exercise these functions without live credential exposure.

---

## Summary Table

| ID | Severity | File | Subject |
|----|----------|------|---------|
| B016-1 | HIGH | geofence_controller.ex | Entire module has no test coverage |
| B016-2 | HIGH | page_controller.ex | Entire module has no test coverage |
| B016-3 | HIGH | pivotel_controller.ex | Entire module has no test coverage |
| B016-4 | HIGH | utility_controller.ex | Entire module (6,293 lines, ~50 public functions) has no test coverage |
| B016-5 | MEDIUM | geofence_controller.ex | `create_geofence/2` error path untested |
| B016-6 | MEDIUM | geofence_controller.ex | `update_geofence/2` nil-geofence and update-failure paths untested |
| B016-7 | MEDIUM | geofence_controller.ex | `delete_geofence/2` nil-geofence and DB-error paths untested |
| B016-8 | MEDIUM | geofence_controller.ex | `process_things_geofences/2` entirely untested; bang functions on user input |
| B016-9 | MEDIUM | geofence_controller.ex | `engine_hours_at_event/3` nine branches untested; nil crash risk on aadcat 4/5 |
| B016-10 | MEDIUM | pivotel_controller.ex | `get_pivotel_data/2` happy path untested |
| B016-11 | MEDIUM | pivotel_controller.ex | `get_pivotel_data/2` fallback 500 path untested |
| B016-12 | MEDIUM | pivotel_controller.ex | `create_update_object/1` LOCATION and ACCUM clauses untested; `String.to_float` on unvalidated input |
| B016-13 | MEDIUM | pivotel_controller.ex | `create_update_object/1` fallback clause passes `%{}` to downstream untested |
| B016-14 | MEDIUM | utility_controller.ex | `erp_import/2` critical ingestion endpoint entirely untested |
| B016-15 | MEDIUM | utility_controller.ex | `process_prodisplay_event/2` complex multi-customer routing entirely untested; hard-coded customer |
| B016-16 | MEDIUM | utility_controller.ex | `driverid_converter/2` and `get_dm_driverid/1` bit-manipulation untested; crash on short input |
| B016-17 | MEDIUM | utility_controller.ex | `check_for_future_date/2` silently deletes/modifies DB records, entirely untested |
| B016-18 | MEDIUM | utility_controller.ex | `send_to_rayven/7` nil/empty serial silent-drop paths untested |
| B016-19 | MEDIUM | utility_controller.ex | `do_geocode_lookup/2` Geonames nil response and street-count branches untested |
| B016-20 | MEDIUM | utility_controller.ex | `process_ebs_get_hour_meter/2` hard-codes customer prefix regardless of argument |
| B016-21 | LOW | geofence_controller.ex | `check_event_for_left_events/6` nil clause returns `[]` not `{[], []}` — latent `MatchError` |
| B016-22 | LOW | geofence_controller.ex | Bang date parsing in `process_things_geofences/2` — no invalid-input test |
| B016-23 | LOW | pivotel_controller.ex | Bang timestamp parsing in `convert_timestamp/1` — no invalid-input test |
| B016-24 | LOW | utility_controller.ex | `calculate_roi_value/2` has empty body — will raise `NotSentError` in production |
| B016-25 | LOW | utility_controller.ex | Four stub functions with no implementation are publicly callable |
| B016-26 | LOW | utility_controller.ex | `create_equipment_assignment/3` timezone-lookup nil path untested |
| B016-27 | LOW | utility_controller.ex | `get_additional_data/1` and `next_service/1` read local CSV files; crash if absent |
| B016-28 | LOW | utility_controller.ex | `process_rental_from_erp/2` mixed return-value conventions on `Vx.get_rental/4` |
| B016-29 | INFO | utility_controller.ex | Pervasive `IO.puts`/`IO.inspect` debug logging in production code |
| B016-30 | INFO | utility_controller.ex | API keys and Rayven UID tokens hard-coded as string literals in source |

<!-- B017.md -->
# Audit Report B017
**Audit run:** 2026-02-27-01
**Agent:** B017 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/controllers/vx_abl_record_controller.ex`
2. `lib/api_server_web/controllers/vx_access_fob_controller.ex`
3. `lib/api_server_web/controllers/vx_customer_controller.ex`

---

## Test Coverage Search

The full test directory was searched for all module names, controller names, and every public function name defined in the three source files. No matches were found in any test file.

Test files present in the repository:
- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`
- `test/test_helper.exs`

None of these files reference any module, function, or alias from the three assigned controllers.

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/vx_abl_record_controller.ex`

**Module:** `ApiServerWeb.VXAblRecordController`

**Aliases / dependencies:**
- `ApiServer.Vx`
- `ApiServer.Vx.VXAblRecord`
- `ApiServerWeb.FallbackController` (action_fallback)
- `ApiServer.Guardian.Plug` (JWT claims)
- `Timex` (date shifting / between?)
- `NaiveDateTime`, `Date`, `DateTime`
- `ApiServer.Vx` context functions: `create_vx_abl_record/1`, `get_vx_abl_record!/1`, `update_vx_abl_record/2`, `delete_vx_abl_record/1`, `list_service_records/1`, `get_hardwareids_in_fleet/2`, `get_vx_user_offset/2`, `get_branch_for_thing/2`, `fetch_actual_usage/5`, `create_abl_record/2`

**Public functions defined:**

| Line | Name | Signature |
|------|------|-----------|
| 9    | `create/2` | `(conn, %{"vx_abl_record" => vx_abl_record_params})` |
| 18   | `show/2` | `(conn, %{"id" => id})` |
| 23   | `update/2` | `(conn, %{"id" => id, "vx_abl_record" => vx_abl_record_params})` |
| 31   | `delete/2` | `(conn, %{"id" => id})` |
| 38   | `rhm_service_records/2` | `(conn, params)` |
| 66   | `generate_service_record/3` | `(conn, thing, new_service_date)` |

**Types / structs / constants defined:** None directly in this file.

**Notable logic in `rhm_service_records/2`:**
- Reads JWT customer claim.
- Optionally filters by `fleet_id` parameter.
- Optionally filters by `from`/`to` date range (parsed with `Date.from_iso8601!`, shifted via `Timex.shift`).
- Multi-step pipeline: expand XML to struct, filter nil `hardwareid`, filter nil/malformed `new_service_date` (must be exactly 10 chars), filter by fleet membership, filter by date range.

**Notable logic in `generate_service_record/3`:**
- Reads JWT customer and user_id claims.
- Looks up user timezone.
- Builds XML string for service record.
- Conditionally computes `current_hour_meter` and `input_one_hour_meter` from `thing.summary` (nil-guarded).
- Computes `usage` via `fetch_actual_usage/5` only when `existing_service_date` is non-nil.
- Returns the status atom from `create_abl_record/2`.

---

### File 2: `lib/api_server_web/controllers/vx_access_fob_controller.ex`

**Module:** `ApiServerWeb.VXAccessFobController`

**Aliases / dependencies:**
- `ApiServer.Vx`
- `ApiServer.Vx.VXAccessFob`
- `ApiServerWeb.FallbackController` (action_fallback)
- `ApiServer.Vx` context functions: `list_vxaccessfobs/0`, `get_vx_access_fob!/1`, `delete_vx_access_fob/1`

**Public functions defined:**

| Line | Name | Signature |
|------|------|-----------|
| 9    | `index/2` | `(conn, _params)` |
| 14   | `show/2` | `(conn, %{"id" => id})` |
| 19   | `delete/2` | `(conn, %{"id" => id})` |

**Types / structs / constants defined:** None.

**Notable observations:**
- `index/2` lists all access fobs with no customer/tenant scoping; there is no JWT claim extraction.
- No `create` or `update` action is present; this is intentional (fobs are presumably created elsewhere).

---

### File 3: `lib/api_server_web/controllers/vx_customer_controller.ex`

**Module:** `ApiServerWeb.VXCustomerController`

**Aliases / dependencies:**
- `ApiServer.Vx`
- `ApiServer.Vx.VXCustomer`
- `ApiServerWeb.FallbackController` (action_fallback)
- `ApiServer.Guardian.Plug` (JWT claims)
- `ApiServer.Vx` context functions: `list_customers/1`, `create_vx_customer/2`, `get_vx_customer!/2`, `update_vx_customer/3`, `delete_vx_customer/2`
- `VXCustomer.convert_json_to_changeset/1`

**Public functions defined:**

| Line | Name | Signature |
|------|------|-----------|
| 9    | `index/2` | `(conn, _params)` |
| 16   | `create/2` | `(conn, %{"customer" => vx_customer})` |
| 32   | `show/2` | `(conn, %{"id" => id})` |
| 39   | `update/2` | `(conn, %{"customer" => vx_customer_params})` |
| 51   | `delete/2` | `(conn, %{"id" => id})` |

**Types / structs / constants defined:** None.

**Notable logic in `create/2`:**
- Uses an explicit `else` branch that catches `{:error, error}` and returns a raw JSON string with `500 Internal Server Error`, bypassing the standard FallbackController and Phoenix view layer (line 26-29).
- `IO.inspect error` is called in the error path (debug output left in production code).

**Notable logic in `update/2`:**
- Extracts the customer id from the body parameter `vx_customer_params["id"]` rather than from the URL path parameter; there is no separate `%{"id" => id}` pattern in the function head.

---

## Findings

---

### B017-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Title:** No test file and zero indirect test coverage for `[REDACTED-AWS-SMTP-PASSWORD]`

**Description:**
There is no direct test file for this controller and no test in the entire test suite references any of its module name, actions, or helper functions. All six public functions (`create/2`, `show/2`, `update/2`, `delete/2`, `rhm_service_records/2`, `generate_service_record/3`) are completely untested.

**Evidence:** Grep for `VXAblRecord`, `vx_abl_record`, `rhm_service_records`, `generate_service_record` across `test/**/*.exs` returned no matches.

---

### B017-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`
**Title:** No test file and zero indirect test coverage for `[REDACTED-AWS-SMTP-PASSWORD]`

**Description:**
There is no direct test file for this controller and no test in the entire test suite references any of its module name, actions, or context calls. All three public functions (`index/2`, `show/2`, `delete/2`) are completely untested.

**Evidence:** Grep for `VXAccessFob`, `vx_access_fob`, `AccessFob` across `test/**/*.exs` returned no matches.

---

### B017-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Title:** No test file and zero indirect test coverage for `[REDACTED-AWS-SMTP-PASSWORD]`

**Description:**
There is no direct test file for this controller and no test in the entire test suite references any of its module name, actions, or context calls. All five public functions (`index/2`, `create/2`, `show/2`, `update/2`, `delete/2`) are completely untested.

**Evidence:** Grep for `VXCustomer`, `vx_customer` across `test/**/*.exs` returned no matches.

---

### B017-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `create/2` (line 9)
**Title:** Error path for `Vx.create_vx_abl_record/1` failure is untested

**Description:**
The `with` expression on line 10 delegates its error case to `FallbackController`. There is no test verifying that a changeset validation failure (e.g., missing required fields, duplicate key) produces the correct HTTP error response. The FallbackController rendering for this specific controller and error shape has never been exercised.

---

### B017-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `show/2` (line 18)
**Title:** Not-found error path for `Vx.get_vx_abl_record!/1` is untested

**Description:**
`get_vx_abl_record!` raises `Ecto.NoResultsError` when the record does not exist. The FallbackController is expected to convert this to a 404, but no test exercises the case of fetching a non-existent abl record ID.

---

### B017-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `update/2` (line 23)
**Title:** Error paths for `update` (not found, changeset error) are untested

**Description:**
Two distinct failure modes exist: (1) `get_vx_abl_record!` raises on a non-existent ID and (2) `update_vx_abl_record` returns `{:error, changeset}`. Neither path has any test coverage.

---

### B017-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `delete/2` (line 31)
**Title:** Error path for `delete` (not found, delete failure) is untested

**Description:**
`get_vx_abl_record!` can raise and `delete_vx_abl_record` can return an error tuple. Neither failure scenario is tested.

---

### B017-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `rhm_service_records/2` (line 38)
**Title:** All branches of `rhm_service_records/2` are untested

**Description:**
This function contains multiple conditional branches covering: presence/absence of `fleet_id`, presence/absence of `from`/`to` date parameters, and multi-stage record filtering. None of the following paths has test coverage:
- Request with no optional parameters (returns all records).
- Request filtered by `fleet_id`.
- Request filtered by date range.
- Request combining both `fleet_id` and date range.

---

### B017-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `generate_service_record/3` (line 66)
**Title:** `generate_service_record/3` is entirely untested

**Description:**
This function contains significant business logic: timezone-aware usage calculation, XML construction, and multiple nil-guard branches. None of its code paths (success, nil summary, nil existing service date, nil branch) has test coverage.

---

### B017-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`
**Function:** `show/2` (line 14), `delete/2` (line 19)
**Title:** Not-found error paths for `get_vx_access_fob!` are untested

**Description:**
Both `show/2` and `delete/2` call `Vx.get_vx_access_fob!(id)` which raises on a missing record. The resulting FallbackController 404 response path has never been tested.

---

### B017-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`
**Function:** `delete/2` (line 19)
**Title:** Delete failure error path is untested

**Description:**
`Vx.delete_vx_access_fob/1` can return `{:error, changeset}` (e.g., if the record has database constraints). The fallback handling of that error tuple is not tested.

---

### B017-12
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `create/2` (line 16)
**Title:** Error path in `create/2` bypasses FallbackController and is untested

**Description:**
The `else` branch (lines 26-29) catches `{:error, error}` and manually sends a raw JSON string with status 500. This path:
(a) is not exercised by any test,
(b) bypasses the standard Phoenix view/FallbackController pipeline, and
(c) calls `IO.inspect error` which emits debug output to stdout in production.
The raw string interpolation `"#{inspect error.errors}"` may produce malformed JSON if the error message contains double-quote characters.

---

### B017-13
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `show/2` (line 32), `update/2` (line 39), `delete/2` (line 51)
**Title:** Not-found error paths for `get_vx_customer!` are untested

**Description:**
All three actions call `Vx.get_vx_customer!(id, customer)` which raises `Ecto.NoResultsError` for unknown IDs. No test exercises the 404 response path for any of these actions.

---

### B017-14
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `update/2` (line 39)
**Title:** Update changeset failure path is untested

**Description:**
`Vx.update_vx_customer/3` returns `{:error, changeset}` on validation failure. This error is delegated to FallbackController (via the `with` expression). No test exercises this path.

---

### B017-15
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `delete/2` (line 51)
**Title:** Delete failure path is untested

**Description:**
`Vx.delete_vx_customer/2` can return an error tuple (e.g., foreign key constraint). No test exercises this failure path.

---

### B017-16
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `rhm_service_records/2` (line 38)
**Title:** Edge cases in date parsing within `rhm_service_records/2` are untested

**Description:**
`Date.from_iso8601!` is called with user-supplied `params["from"]` and `params["to"]` (line 51) and with `record.new_service_date` (line 61). Malformed or out-of-range date strings will raise `ArgumentError` or `MatchError` at runtime. No test covers:
- Invalid ISO 8601 date strings for `from`/`to`.
- `new_service_date` fields that pass the length-10 filter but are not valid ISO 8601 dates.
- Boundary dates (e.g., leap day, end of year).

---

### B017-17
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`
**Function:** `generate_service_record/3` (line 66)
**Title:** `thing.aadsvchrs` nil case in arithmetic is untested

**Description:**
Line 144 computes `hours_to_service = thing.aadsvchrs - usage`. If `thing.aadsvchrs` is `nil`, this will raise `ArithmeticError`. No test exercises this nil case. Similarly, `usage` is always an integer/float when `existing_service_date` is non-nil, but `fetch_actual_usage/5` could return unexpected types.

---

### B017-18
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`
**Function:** `index/2` (line 9)
**Title:** `index/2` has no customer/tenant scoping and this is untested

**Description:**
Unlike the other controllers that extract a customer claim from the JWT, `index/2` calls `Vx.list_vxaccessfobs()` with no arguments, returning all access fobs regardless of tenant. There is no test confirming whether this is intentional (global admin endpoint) or an access-control omission. The multi-tenant behaviour (or lack of it) has never been verified by a test.

---

### B017-19
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `create/2` (line 16)
**Title:** Potential JSON injection in manually constructed error response body

**Description:**
Line 28 constructs the response body via string interpolation:
```elixir
"{\"error\": \"error creating customer\", \"reason\": \"#{inspect error.errors}\" }"
```
If `error.errors` contains a double-quote or backslash, the resulting string will be malformed JSON. No test verifies the shape or safety of this error response.

---

### B017-20
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`
**Function:** `update/2` (line 39)
**Title:** ID sourced from request body rather than URL path parameter

**Description:**
`update/2` does not pattern-match an `id` from the URL path; instead it reads `vx_customer_params["id"]` from the JSON body (line 42). If the body omits the `id` key, this will be `nil`, and `get_vx_customer!(nil, customer)` behaviour is untested. There is also no test verifying that a mismatch between a URL path ID and a body ID is handled correctly, as the URL path ID is not used at all.

---

## Summary Table

| ID     | Severity | File                              | Area |
|--------|----------|-----------------------------------|------|
| B017-1 | HIGH     | vx_abl_record_controller.ex       | No test coverage at all |
| B017-2 | HIGH     | vx_access_fob_controller.ex       | No test coverage at all |
| B017-3 | HIGH     | vx_customer_controller.ex         | No test coverage at all |
| B017-4 | MEDIUM   | vx_abl_record_controller.ex       | `create` error path untested |
| B017-5 | MEDIUM   | vx_abl_record_controller.ex       | `show` not-found untested |
| B017-6 | MEDIUM   | vx_abl_record_controller.ex       | `update` error paths untested |
| B017-7 | MEDIUM   | vx_abl_record_controller.ex       | `delete` error paths untested |
| B017-8 | MEDIUM   | vx_abl_record_controller.ex       | `rhm_service_records` all branches untested |
| B017-9 | MEDIUM   | vx_abl_record_controller.ex       | `generate_service_record` entirely untested |
| B017-10| MEDIUM   | vx_access_fob_controller.ex       | `show`/`delete` not-found untested |
| B017-11| MEDIUM   | vx_access_fob_controller.ex       | `delete` failure path untested |
| B017-12| MEDIUM   | vx_customer_controller.ex         | `create` error bypasses FallbackController, untested |
| B017-13| MEDIUM   | vx_customer_controller.ex         | `show`/`update`/`delete` not-found untested |
| B017-14| MEDIUM   | vx_customer_controller.ex         | `update` changeset failure untested |
| B017-15| MEDIUM   | vx_customer_controller.ex         | `delete` failure path untested |
| B017-16| LOW      | vx_abl_record_controller.ex       | Date parsing edge cases untested |
| B017-17| LOW      | vx_abl_record_controller.ex       | `generate_service_record` nil arithmetic |
| B017-18| LOW      | vx_access_fob_controller.ex       | `index` tenant scoping unverified by tests |
| B017-19| LOW      | vx_customer_controller.ex         | JSON injection in error response body |
| B017-20| LOW      | vx_customer_controller.ex         | `update` ID sourced from body, nil case untested |

**Total findings: 20**
**HIGH: 3 | MEDIUM: 12 | LOW: 5**

<!-- B018.md -->
# Audit Report B018 — Test Coverage Analysis
**Audit run:** 2026-02-27-01
**Agent:** B018
**Pass:** 2
**Scope:** Controller test coverage for four VX controllers

---

## Source Files Audited

| # | File |
|---|------|
| 1 | `lib/api_server_web/controllers/vx_fleet_association_controller.ex` |
| 2 | `lib/api_server_web/controllers/vx_fleet_controller.ex` |
| 3 | `lib/api_server_web/controllers/vx_rental_controller.ex` |
| 4 | `lib/api_server_web/controllers/vx_restriction_controller.ex` |

---

## Reading Evidence

### 1. ApiServerWeb.VXFleetAssociationController
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`

**Module aliases:**
- `ApiServer.Vx` (alias `Vx`)
- `ApiServer.Vx.VXFleetAssociation` (alias `VXFleetAssociation`)

**Fallback:** `action_fallback ApiServerWeb.FallbackController`

**Public functions defined:**

| Function | Arity | Line |
|----------|-------|------|
| `index/2` | 2 | 9 |
| `show/2` | 2 | 14 |
| `delete/2` | 2 | 19 |

**Types / structs / constants defined:** None.

**Notes:**
- `index/2` calls `Vx.list_vxfleetassociations()` and renders `"index.json"`.
- `show/2` calls `Vx.get_vx_fleet_association!(id)` — the bang form will raise on not-found, delegating error handling to `FallbackController`.
- `delete/2` calls `Vx.get_vx_fleet_association!(id)` (bang) then `Vx.delete_vx_fleet_association/1` inside a `with`; returns 204 on success; the `with` failure case falls to `FallbackController`.

---

### 2. ApiServerWeb.VXFleetController
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`

**Module aliases:**
- `ApiServer.Vx` (alias `Vx`)
- `ApiServer.Vx.VXFleet` (alias `VXFleet`)

**Fallback:** `action_fallback ApiServerWeb.FallbackController`

**Public functions defined:**

| Function | Arity | Line | Notes |
|----------|-------|------|-------|
| `create/2` | 2 | 9 | Pattern matches `%{"vx_fleet" => vx_fleet_params}` |
| `get_fleets/2` | 2 | 19 | Clause 1: pattern matches `%{"admin" => "1"}` — admin list |
| `get_fleets/2` | 2 | 27 | Clause 2: catch-all — user-scoped list |
| `get_fleets_with_equipment/2` | 2 | 35 | Returns fleets with nested equipment list |
| `create_fleet/2` | 2 | 68 | Pattern matches `%{"customer" => cust, "fleet" => fleet_params}` |
| `delete_fleet/2` | 2 | 91 | Pattern matches `%{"customer" => customer, "id" => id}` |
| `get_equipment_in_fleet/2` | 2 | 105 | Pattern matches `%{"customer" => customer, "id" => fleet_id}` |
| `manage_fleet/2` | 2 | 110 | Pattern matches `%{"customer" => customer, "id" => fleet_id, "equip_in_fleet" => ids_in_fleet}` |
| `update_fleet/2` | 2 | 119 | Pattern matches `%{"customer" => customer, "fleet" => fleet_params}` |

**Types / structs / constants defined:** None.

**Key internal logic:**
- `create_fleet/2` (line 76): explicit duplicate-name guard — returns 500 if `length(fleets_with_same_name) > 0`.
- `delete_fleet/2` (line 93): explicit nil guard — returns 500 if fleet not found.
- `update_fleet/2` (line 122): explicit nil guard — returns 500 if fleet not found.
- `get_fleets_with_equipment/2` (lines 46–60): non-trivial `Enum.reduce` building nested fleet/equipment structure; handles `nil` vehicle_name at line 48.

---

### 3. ApiServerWeb.VXRentalController
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`

**Module aliases:**
- `ApiServer.Vx` (alias `Vx`)
- `ApiServer.Vx.VXRental` (alias `VXRental`)

**Fallback:** `action_fallback ApiServerWeb.FallbackController`

**Public functions defined:**

| Function | Arity | Line | Notes |
|----------|-------|------|-------|
| `get_rentals/2` | 2 | 9 | Clause 1: pattern matches `%{"customer" => _, "closed" => "1"}` — all rentals including closed |
| `get_rentals/2` | 2 | 30 | Clause 2: catch-all — open rentals only |
| `get_midpac_style_rental_report/2` | 2 | 51 | Pattern matches `%{"on" => on_date}` |
| `get_rental_anniversaries/2` | 2 | 110 | Pattern matches `%{"hardwareid" => hardwareid, "from" => from_date, "to" => to_date}` |
| `create_rental/2` | 2 | 158 | Pattern matches `%{"customer" => customer, "rental" => rental_params}` |
| `update_rental/2` | 2 | 174 | Pattern matches `%{"customer" => customer, "rental" => rental_params}` |
| `delete_rental/2` | 2 | 191 | Pattern matches `%{"customer" => customer, "id" => id}` |
| `rhm_active_rental/2` | 2 | 206 | Pattern matches `%{"hardwareid" => hardwareid}` |

**Types / structs / constants defined:** None.

**Key internal logic:**
- `get_rentals/2` (both clauses): inline period_usage/overage calculation via `Enum.map` — complex business logic inline.
- `get_midpac_style_rental_report/2` (line 65): calls `VXRental.has_anniversary_on_day?/3`; conditionally returns `nil` rows and filters them out; accesses `rental.customer` which may be `nil` (guarded at line 75).
- `create_rental/2` (line 169): malformed JSON string in error response — extra `}"` at end of string: `"...\"changeset\": \"#{inspect changeset}\"}\" }"`.
- `update_rental/2` (line 177): nil guard for missing rental; returns 500.
- `delete_rental/2` (line 193): nil guard for missing rental; returns 500.
- `rhm_active_rental/2` (line 214): case on `nil` — returns 500 when no active rental found; the computed `period_start`, `period_usage`, `overage` values (lines 218–225) are computed but **never actually stored back** into `active_rental` before `render/3` is called (the `Map.put_new` results are discarded).

---

### 4. ApiServerWeb.VXRestrictionController
**File:** `lib/api_server_web/controllers/vx_restriction_controller.ex`

**Module aliases:**
- `ApiServer.Vx` (alias `Vx`)
- `ApiServer.Vx.VXRestriction` (alias `VXRestriction`)

**Fallback:** `action_fallback ApiServerWeb.FallbackController`

**Public functions defined:** None.

**Types / structs / constants defined:** None.

**Notes:** The module body is empty — it contains only `use ApiServerWeb, :controller`, two aliases, `action_fallback`, and nothing else. The module defines zero action functions.

---

## Test File Evidence

### Direct test file: `test/api_server_web/controllers/vx_restriction_controller_test.exs`

The test module `ApiServerWeb.VXRestrictionControllerTest` uses `ApiServerWeb.ConnCase` and defines tests for the following actions:

| Describe block | Test name | HTTP method + path helper | Expected status |
|----------------|-----------|---------------------------|-----------------|
| `"index"` | `"lists all vxaau_rest"` | `GET vx_restriction_path(conn, :index)` | 200 |
| `"create vx_restriction"` | `"renders vx_restriction when data is valid"` | `POST vx_restriction_path(conn, :create)` | 201 |
| `"create vx_restriction"` | `"renders errors when data is invalid"` | `POST vx_restriction_path(conn, :create)` | 422 |
| `"update vx_restriction"` | `"renders vx_restriction when data is valid"` | `PUT vx_restriction_path(conn, :update, ...)` | 200 |
| `"update vx_restriction"` | `"renders errors when data is invalid"` | `PUT vx_restriction_path(conn, :update, ...)` | 422 |
| `"delete vx_restriction"` | `"deletes chosen vx_restriction"` | `DELETE vx_restriction_path(conn, :delete, ...)` | 204 |

**Attributes defined:**
- `@create_attrs` — all fields populated with valid values (line 7)
- `@update_attrs` — all fields populated with updated valid values (line 8)
- `@invalid_attrs` — all fields set to `nil` (line 9)

**Helper:** `fixture(:vx_restriction)` at line 11 creates a restriction via `Vx.create_vx_restriction/1`.

**Support module:** `test/support/conn_case.ex` — `ApiServerWeb.ConnCase` uses `Phoenix.ConnTest`, imports `ApiServerWeb.Router.Helpers`, sets `@endpoint ApiServerWeb.Endpoint`. The `setup` block checks out a SQL sandbox connection and wraps each test in a transaction (non-async mode).

### Indirect coverage search results

Grep of entire `test/` directory for `VXFleetAssociation`, `VXFleetController`, `VXRentalController`, and all their public function names: **zero matches found in any test file.**

Only two controller test files exist in the repository:
- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`

---

## VXRestrictionController — Action vs Test Mapping

| Action expected by test | Present in controller source? |
|-------------------------|-------------------------------|
| `index/2` | NO — not defined |
| `create/2` | NO — not defined |
| `show/2` | NO — not defined |
| `update/2` | NO — not defined |
| `delete/2` | NO — not defined |

The controller module (`vx_restriction_controller.ex`) contains **no action functions whatsoever**. The test file exercises five distinct actions (index, create, show, update, delete) that route to this controller, but none of them exist in the module. The tests will fail or exercise dead/misrouted code at runtime.

---

## Findings

---

### B018-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.VXFleetAssociationController`. No direct test file was found and no indirect test coverage was located anywhere in the `test/` directory. All three public actions (`index/2`, `show/2`, `delete/2`) are completely untested.

---

### B018-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.VXFleetController`. No direct test file was found and no indirect test coverage was located anywhere in the `test/` directory. All nine public action clauses (`create/2`, `get_fleets/2` clause 1, `get_fleets/2` clause 2, `get_fleets_with_equipment/2`, `create_fleet/2`, `delete_fleet/2`, `get_equipment_in_fleet/2`, `manage_fleet/2`, `update_fleet/2`) are completely untested.

---

### B018-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`
**Finding:** No test file exists for `ApiServerWeb.VXRentalController`. No direct test file was found and no indirect test coverage was located anywhere in the `test/` directory. All eight public action clauses are completely untested.

---

### B018-4
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_restriction_controller.ex`
**Finding:** The controller module body is empty — it defines no action functions. The direct test file `test/api_server_web/controllers/vx_restriction_controller_test.exs` exists and exercises five actions (`index`, `create`, `show`, `update`, `delete`), but none of these actions are implemented in the controller. This means the controller has been stubbed out and all tests against it test non-existent functionality. The tests themselves are therefore vacuous or will fail at routing time.

---

### B018-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 19 vs line 27
**Finding:** `get_fleets/2` has two clauses — one for admin users (`%{"admin" => "1"}`) and one for non-admin users (catch-all). There is no test for either clause. The admin clause calls `Vx.list_vxfleets(customer)` while the non-admin clause calls `Vx.list_vxfleets(user_id, customer)` — different arities. The diverging code paths are fully untested.

---

### B018-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 76–88
**Finding:** `create_fleet/2` contains a duplicate-name guard that returns HTTP 500 when a fleet with the same name already exists. This error path is untested.

---

### B018-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 93–102
**Finding:** `delete_fleet/2` contains a nil-guard path returning HTTP 500 when no fleet with the given ID exists. This error path is untested.

---

### B018-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 122–133
**Finding:** `update_fleet/2` contains a nil-guard path returning HTTP 500 when no fleet with the given ID exists. This error path is untested.

---

### B018-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 9–28 vs lines 30–49
**Finding:** `get_rentals/2` has two clauses — one for closed rentals (`%{"closed" => "1"}`) and one for open rentals (catch-all). Neither clause is tested. The two clauses call different context functions (`Vx.list_all_rentals/1` vs `Vx.list_open_rentals/1`) and represent distinct business behaviors.

---

### B018-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 191–203
**Finding:** `delete_rental/2` has a nil-guard path returning HTTP 500 when no rental with the given ID exists. This error path is untested.

---

### B018-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 174–189
**Finding:** `update_rental/2` has a nil-guard path returning HTTP 500 when no rental with the given ID exists. This error path is untested.

---

### B018-12
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 214
**Finding:** `rhm_active_rental/2` has a `nil` case returning HTTP 500 when no active rental exists for the given hardware ID. This error path is untested.

---

### B018-13
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, lines 40–63
**Finding:** `get_fleets_with_equipment/2` contains non-trivial inline `Enum.reduce` logic that builds a nested fleet/equipment data structure. It has two branches: creating a new fleet entry (when not yet in accumulator) and merging equipment into an existing entry. The nil-vehicle-name guard at line 48 is a third branch. None of these logic paths are tested.

---

### B018-14
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 62–108
**Finding:** `get_midpac_style_rental_report/2` contains complex conditional logic: it checks for anniversary on the given day, conditionally computes `previous_anniversary` (which may be nil), and filters out nil results. The branch where `previous_anniversary == nil` returns nil and is filtered out is untested. The branch where `rental.customer` is nil (line 75) is also untested.

---

### B018-15
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 118–154
**Finding:** `get_rental_anniversaries/2` iterates all rentals for a thing and all anniversaries within a date range, computing usage for each period. The inner `previous_anniversary == nil` guard at line 123 (filtering out nil entries) is untested, as is the `rental.customer == nil` guard at line 127.

---

### B018-16
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 14
**Finding:** `show/2` uses `Vx.get_vx_fleet_association!(id)` (bang variant). No test covers the not-found case (which would raise and be caught by `FallbackController`). Additionally, no test covers a non-integer or malformed `id` parameter.

---

### B018-17
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 110
**Finding:** `manage_fleet/2` pattern-matches on `"equip_in_fleet"` as a list and maps over it with `String.to_integer/1`. No test covers the case where `ids_in_fleet` is empty, contains non-integer strings, or contains duplicate IDs.

---

### B018-18
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 9
**Finding:** `get_rentals/2` (closed clause) pattern-matches on the string `"1"` for the `"closed"` parameter. No test covers the boundary between open-only and closed results, nor the case where the rental list is empty.

---

### B018-19
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 59
**Finding:** `get_midpac_style_rental_report/2` calls `Date.from_iso8601!/1` on the `on_date` parameter at line 59. No test covers an invalid date string (e.g. `"not-a-date"` or `"2026-13-01"`), which would raise `ArgumentError` and produce an unhandled 500 rather than a structured error response.

---

### B018-20
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_restriction_controller_test.exs`
**Finding:** The test file uses `fixture/1` (line 11) rather than ExMachina or Ecto factory patterns. The `fixture` function is a deprecated pattern in newer Phoenix/ExUnit conventions; it also shares state with `@create_attrs` rather than generating unique values, which could cause false-positive passes if uniqueness constraints are missing. This is an observation about test quality rather than a coverage gap.

---

### B018-21
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, lines 218–225
**Finding:** In `rhm_active_rental/2`, the results of `Map.put_new(:period_start, ...)`, `Map.put_new(:period_usage, ...)`, and `Map.put_new(:overage, ...)` (lines 222–225) are not bound to any variable before the `render/3` call on line 229. The `active_rental` struct passed to the view is therefore missing the computed `period_start`, `period_usage`, and `overage` keys. This is a likely runtime logic bug; however since there are no tests, it is currently undetected. Reported as INFO here; the behavioral bug itself should be escalated by a separate pass.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B018-1 | HIGH | vx_fleet_association_controller.ex | No test file — all 3 actions untested |
| B018-2 | HIGH | vx_fleet_controller.ex | No test file — all 9 action clauses untested |
| B018-3 | HIGH | vx_rental_controller.ex | No test file — all 8 action clauses untested |
| B018-4 | HIGH | vx_restriction_controller.ex | Controller body is empty; test file exists but tests non-existent actions |
| B018-5 | MEDIUM | vx_fleet_controller.ex | `get_fleets/2` admin vs non-admin clauses both untested |
| B018-6 | MEDIUM | vx_fleet_controller.ex | `create_fleet/2` duplicate-name error path untested |
| B018-7 | MEDIUM | vx_fleet_controller.ex | `delete_fleet/2` not-found error path untested |
| B018-8 | MEDIUM | vx_fleet_controller.ex | `update_fleet/2` not-found error path untested |
| B018-9 | MEDIUM | vx_rental_controller.ex | `get_rentals/2` closed vs open clauses both untested |
| B018-10 | MEDIUM | vx_rental_controller.ex | `delete_rental/2` not-found error path untested |
| B018-11 | MEDIUM | vx_rental_controller.ex | `update_rental/2` not-found error path untested |
| B018-12 | MEDIUM | vx_rental_controller.ex | `rhm_active_rental/2` no-active-rental error path untested |
| B018-13 | MEDIUM | vx_fleet_controller.ex | `get_fleets_with_equipment/2` reduce logic branches untested |
| B018-14 | MEDIUM | vx_rental_controller.ex | `get_midpac_style_rental_report/2` nil-anniversary and nil-customer branches untested |
| B018-15 | MEDIUM | vx_rental_controller.ex | `get_rental_anniversaries/2` nil-anniversary and nil-customer branches untested |
| B018-16 | LOW | vx_fleet_association_controller.ex | `show/2` not-found and malformed-id cases untested |
| B018-17 | LOW | vx_fleet_controller.ex | `manage_fleet/2` empty/invalid `equip_in_fleet` list untested |
| B018-18 | LOW | vx_rental_controller.ex | `get_rentals/2` empty-list and closed-boundary edge cases untested |
| B018-19 | LOW | vx_rental_controller.ex | `get_midpac_style_rental_report/2` invalid date string raises unhandled error |
| B018-20 | INFO | vx_restriction_controller_test.exs | Deprecated `fixture/1` pattern used in test setup |
| B018-21 | INFO | vx_rental_controller.ex | `rhm_active_rental/2` discards computed `Map.put_new` results before render |

<!-- B019.md -->
# Audit Report B019
**Audit Run:** 2026-02-27-01
**Agent:** B019 (Pass 2)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/controllers/vx_thing_controller.ex`
2. `lib/api_server_web/controllers/vx_thing_event_controller.ex`
3. `lib/api_server_web/controllers/vx_thing_info_controller.ex`

---

## Reading Evidence

### 1. `ApiServerWeb.VXThingController`
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`

**Public functions defined:**

| Function | Arity | Line | Notes |
|---|---|---|---|
| `get_checklists/2` | 2 | 10 | Pattern-matches `customer`, `hardwareid` |
| `get_movements/2` | 2 | 16 | Pattern-matches `customer`, `hardwareid`, `day`, `timezone` |
| `get_hardware_with_checklists/2` | 2 | 21 | Pattern-matches `customer` |
| `get_pm_data/2` | 2 | 30 | Pattern-matches `customer`, `hardwareid` |
| `get_all_pm_data/2` | 2 | 36 | Pattern-matches `customer` |
| `get_fleet_map/2` (clause 1) | 2 | 44 | Pattern-matches `customer`, `fleetname` |
| `get_fleet_map/2` (clause 2) | 2 | 51 | Pattern-matches `customer`, `fleetid` |
| `get_fleet_map/2` (clause 3) | 2 | 56 | Pattern-matches `fleetid` only |
| `get_fleet_map/2` (clause 4) | 2 | 64 | Catch-all `_` |
| `create/2` | 2 | 74 | Pattern-matches `vx_thing` params |
| `show/2` | 2 | 83 | Pattern-matches `id` (hardwareid) |
| `delete/2` | 2 | 88 | Pattern-matches `id` |
| `rhm_get_thing/2` | 2 | 95 | Pattern-matches `customer`, `hardwareid` |
| `rhm_get_thing_usage/2` | 2 | 100 | Pattern-matches `hardwareid`, `from`, `to`, `timezone` |
| `rhm_get_things_usage/2` | 2 | 111 | Pattern-matches `fleetid`, `from`, `to`, `timezone`; returns CSV |
| `rhm_get_thing_events/2` | 2 | 144 | Pattern-matches `hardwareid`, `from`, `to`, `timezone` |
| `rhm_get_things/2` (clause 1) | 2 | 153 | Pattern-matches `customer`, `fleet_id` |
| `rhm_get_things/2` (clause 2) | 2 | 161 | Pattern-matches `customer` |
| `rhm_get_things_with_usage/2` (clause 1) | 2 | 169 | Pattern-matches `fleet_id` |
| `rhm_get_things_with_usage/2` (clause 2) | 2 | 176 | Catch-all `_params` |
| `rhm_get_things_names/2` | 2 | 223 | Pattern-matches `customer` |
| `rhm_get_thing_records/2` | 2 | 231 | Pattern-matches `%{}` (any params) |
| `create_thing/2` | 2 | 240 | Pattern-matches `thing` params |
| `update_thing/2` | 2 | 254 | Pattern-matches `thing` params |
| `monday_hour_meters/2` | 2 | 377 | Pattern-matches `from`, `to`, `customers` |
| `get_next_monday_between_dates/4` | 4 | 438 | Recursive helper |
| `combined_engine_usage/2` | 2 | 453 | Pattern-matches `format: "csv"`, `from`, `to`, `customers` |
| `pape_export/2` (clause 1) | 2 | 603 | Pattern-matches `format: "csv"` |
| `pape_export/2` (clause 2) | 2 | 617 | Catch-all `_` |
| `sielift_export/2` (clause 1) | 2 | 724 | Pattern-matches `format: "json"`, `fleet_id` |
| `sielift_export/2` (clause 2) | 2 | 735 | Pattern-matches `format: "json"` (no fleet) |
| `sielift_export/2` (clause 3) | 2 | 746 | Catch-all (CSV output) |
| `update_thing_cached_fields/2` | 2 | 850 | Non-conn utility, called by VXThingEventController |
| `get_timezones/2` | 2 | 859 | Catch-all `_` |

**Private functions defined:**

| Function | Line |
|---|---|
| `things_with_usage/2` | 184 |
| `get_data_for_pape_export/1` | 285 |
| `ifnilzero/1` | 622–623 |
| `get_data_for_sielift_export/3` | 625 |

**Types/Structs/Constants:** None defined directly in this file. Aliases `ApiServer.Vx` and `ApiServer.Vx.VXThing`.

---

### 2. `ApiServerWeb.VXThingEventController`
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`

**Public functions defined:**

| Function | Arity | Line | Notes |
|---|---|---|---|
| `index/2` | 2 | 9 | Lists all thing events |
| `create/2` | 2 | 14 | Pattern-matches `vx_thing_event` params |
| `show/2` | 2 | 24 | Pattern-matches `id` |
| `update/2` | 2 | 29 | Pattern-matches `id`, `vx_thing_event` params |
| `delete/2` | 2 | 38 | Pattern-matches `id` |
| `write_partial_record/3` | 3 | 46 | Non-conn; merges with most recent event and saves |
| `add_calculated_fields/2` | 2 | 74 | Non-conn; computes calc hourmeter fields |
| `get_current_omega_status/2` | 2 | 111 | Pattern-matches `hardwareid` |

**Private functions defined:**

| Function | Line |
|---|---|
| `calculated_hourmeter/2` | 103 |

**Types/Structs/Constants:** None defined directly. Aliases `ApiServer.Vx` and `ApiServer.Vx.VXThingEvent`.

---

### 3. `ApiServerWeb.VXThingInfoController`
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`

**Public functions defined:**

| Function | Arity | Line | Notes |
|---|---|---|---|
| `fix_infos/2` | 2 | 9 | Pattern-matches `customer`; iterates all things and fixes info |
| `get_info/2` | 2 | 17 | Pattern-matches `id`, `customer`; always returns `{}` regardless of result |
| `do_fix_info/2` | 2 | 24 | Non-conn; delegates to `VXThingInfo.validateForHardwareId/2` |

**Types/Structs/Constants:** None defined directly. Aliases `ApiServer.Vx` and `ApiServer.Vx.VXThingInfo`.

---

## Test Coverage Search Results

**Test files searched:** All `.exs` files under `test/`

```
test/api_server_web/controllers/calamp_controller_test.exs
test/api_server_web/controllers/vx_restriction_controller_test.exs
test/api_server_web/views/layout_view_test.exs
test/api_server_web/views/page_view_test.exs
test/test_helper.exs
```

**Grep results for module names** (`VXThingController`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`): **0 matches**

**Grep results for all public function names** across all three modules: **0 matches**

**Conclusion:** There is zero test coverage — direct or indirect — for all three source files.

---

## Findings

---

### B019-1
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Finding:** No test file exists and no indirect test coverage exists for `ApiServerWeb.VXThingController`. This is the largest and most complex controller in the repository. It contains 29 public functions/clauses covering core fleet management, PM data, usage data, CSV exports, and vehicle CRUD operations. None are exercised by any test in the test suite.

---

### B019-2
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Finding:** No test file exists and no indirect test coverage exists for `ApiServerWeb.VXThingEventController`. This module contains 8 public functions including standard CRUD actions and the critical `write_partial_record/3` function, which is called by external controllers (e.g., `CalampController`) to persist incoming device telemetry events. The complete absence of tests means record-writing and hourmeter calculation logic is entirely unverified.

---

### B019-3
**Severity:** HIGH
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`
**Finding:** No test file exists and no indirect test coverage exists for `ApiServerWeb.VXThingInfoController`. All three public functions (`fix_infos/2`, `get_info/2`, `do_fix_info/2`) are untested.

---

### B019-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `update_thing/2` (line 254)
**Finding:** The `update_thing/2` action contains a conditional branch where `thing == nil` results in a 500 response with the message `"no fleet to edit"` (line 281). The success path also contains a conditional service-record generation branch (lines 271–273). Neither the nil-thing path, nor the service-record conditional, nor the `{:error, changeset}` path from `Vx.update_vx_thing/3` (line 278) is tested.

---

### B019-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `create_thing/2` (line 240)
**Finding:** The `{:error, changeset}` branch (line 249–251) returns a 500 response. This error path is entirely untested.

---

### B019-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `create/2` (line 74)
**Finding:** The `with` expression delegates to `Vx.create_vx_thing/1`. The failure path — where `Vx.create_vx_thing/1` returns an error tuple — falls through to `action_fallback`. This fallback path is untested.

---

### B019-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `delete/2` (line 88)
**Finding:** The `with` expression delegates to `Vx.delete_vx_thing/1`. The failure path (non-ok tuple) falls through to `action_fallback`. This fallback path is untested. Additionally, the happy path (204 No Content) is untested.

---

### B019-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Function:** `write_partial_record/3` (line 46)
**Finding:** The `{:error, changeset}` branch (lines 64–68) on `Vx.create_vx_thing_event/2` is untested. This function is called from other controllers in the live event-ingestion path and a silent error at this point could cause data loss. The branch currently calls `IO.inspect(changeset)` and returns without surfacing the error to the caller.

---

### B019-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Function:** `add_calculated_fields/2` (line 74)
**Finding:** The nil-guard branch (lines 77–83) where `totalengineseconds` is nil but `aadhourmeter` is not nil has no test coverage. This branch silently resets `totalengineseconds` to `0`, which is a data-mutation side effect that warrants explicit verification.

---

### B019-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Function:** `create/2` (line 14) and `update/2` (line 29)
**Finding:** Both the `create` and `update` actions use `with` pattern matching delegating to `Vx` context functions. The fallback error paths (non-ok tuples) are untested.

---

### B019-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`
**Function:** `get_info/2` (line 17)
**Finding:** The response from `VXThingInfo.validateForHardwareId/2` is called but its return value is discarded — the function always responds with `send_resp(conn, :ok, "{}")`. This means a validation failure or error from the underlying call would still return HTTP 200. This logic gap is untested and the discarded return value is never asserted.

---

### B019-12
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `rhm_get_things_usage/2` (line 111)
**Finding:** This function produces a CSV file attachment response by iterating over every hardware ID in a fleet. There is no test verifying the CSV content type header (`text/csv`), the `content-disposition` attachment header, the CSV structure, or the behaviour when the fleet is empty or the fleet ID does not exist.

---

### B019-13
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `get_fleet_map/2` (4 clauses, lines 44–72)
**Finding:** All four pattern-match clauses of `get_fleet_map/2` are untested. In particular, clause 1 (matching `fleetname`) and clause 2 (matching `fleetid` with explicit `customer`) shadow each other in ambiguous ways and the routing-vs-clause dispatch is never exercised in tests.

---

### B019-14
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`
**Function:** `calculated_hourmeter/2` (line 103)
**Finding:** The private helper `calculated_hourmeter/2` has three logical cases: `offset_in_hours == nil`, `offset_in_hours == 0`, and a positive offset. The boundary case of `offset_in_hours` being a negative value (representing a backwards adjustment) is never exercised. No tests exist for any branch.

---

### B019-15
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `get_movements/2` (line 16)
**Finding:** `Date.from_iso8601!/1` is called on both `day` and used directly (same value passed twice for start and end date). No test verifies behaviour with an invalid date string, which will raise an exception rather than returning a structured error response.

---

### B019-16
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `monday_hour_meters/2` (line 377) and `get_next_monday_between_dates/4` (line 438)
**Finding:** The recursive `get_next_monday_between_dates/4` function is untested. Edge cases include: `from_date == to_date` (single-day range), a range spanning no Mondays, and date-parsing failure from `Date.from_iso8601!`. The `NaiveDateTime.new/2` tuple destructuring at lines 381–382 is also unchecked for error tuples.

---

### B019-17
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `get_data_for_sielift_export/3` (line 625)
**Finding:** The `aadcat` category value is used in a `case` expression (lines 643–654) that matches only values 2–6. No `_` catch-all clause exists, so an unexpected category value would raise a `CaseClauseError` at runtime. This is untested.

---

### B019-18
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `combined_engine_usage/2` (line 453)
**Finding:** The inner `case` on `category` (lines 495–506) also matches only values 2–6 with no catch-all. An unexpected category would raise a `CaseClauseError`. No test exercises this path, including the empty-customers-list or empty-things-list edge cases.

---

### B019-19
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `update_thing/2` (line 254)
**Finding:** The `Map.has_key?(changeset, :aadlastservice)` check at line 271 operates on a plain map returned by `VXThing.convert_json_to_changeset/1` (not an Ecto changeset). If the changeset conversion fails silently or returns an unexpected structure, this could produce a runtime error. No test verifies this structural assumption.

---

### B019-20
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Finding:** There is a large block of commented-out code beginning at line 300 (`combined_engine_usage` alternate implementation) and at line 780 (`sielift_export_local`). This dead code adds maintenance noise and was noted as it could indicate abandoned or partially migrated functionality. No test coverage concern applies to commented code directly, but the live counterparts (`combined_engine_usage/2` at line 453 and `sielift_export/2`) are themselves untested.

---

### B019-21
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`
**Function:** `things_with_usage/2` (line 184)
**Finding:** The private helper contains a duplicate `now = Timex.now()` assignment (lines 185 and 189). The first value is immediately shadowed and never used. This is a latent code-quality defect; while not a test coverage gap per se, any future test would need to account for which `now` binding is actually operative.

---

## Summary Table

| ID | Severity | File | Function / Scope |
|---|---|---|---|
| B019-1 | HIGH | vx_thing_controller.ex | Entire module — no tests |
| B019-2 | HIGH | vx_thing_event_controller.ex | Entire module — no tests |
| B019-3 | HIGH | vx_thing_info_controller.ex | Entire module — no tests |
| B019-4 | MEDIUM | vx_thing_controller.ex | `update_thing/2` — nil-thing, error, service-record paths |
| B019-5 | MEDIUM | vx_thing_controller.ex | `create_thing/2` — error path |
| B019-6 | MEDIUM | vx_thing_controller.ex | `create/2` — fallback error path |
| B019-7 | MEDIUM | vx_thing_controller.ex | `delete/2` — happy path and fallback |
| B019-8 | MEDIUM | vx_thing_event_controller.ex | `write_partial_record/3` — error branch |
| B019-9 | MEDIUM | vx_thing_event_controller.ex | `add_calculated_fields/2` — nil totalengineseconds branch |
| B019-10 | MEDIUM | vx_thing_event_controller.ex | `create/2`, `update/2` — fallback error paths |
| B019-11 | MEDIUM | vx_thing_info_controller.ex | `get_info/2` — discarded return value, always 200 |
| B019-12 | MEDIUM | vx_thing_controller.ex | `rhm_get_things_usage/2` — CSV output |
| B019-13 | MEDIUM | vx_thing_controller.ex | `get_fleet_map/2` — all 4 clauses |
| B019-14 | LOW | vx_thing_event_controller.ex | `calculated_hourmeter/2` — boundary/negative offset |
| B019-15 | LOW | vx_thing_controller.ex | `get_movements/2` — invalid date string |
| B019-16 | LOW | vx_thing_controller.ex | `monday_hour_meters/2`, `get_next_monday_between_dates/4` |
| B019-17 | LOW | vx_thing_controller.ex | `get_data_for_sielift_export/3` — missing case catch-all |
| B019-18 | LOW | vx_thing_controller.ex | `combined_engine_usage/2` — missing case catch-all |
| B019-19 | LOW | vx_thing_controller.ex | `update_thing/2` — changeset structure assumption |
| B019-20 | INFO | vx_thing_controller.ex | Large blocks of commented-out dead code |
| B019-21 | INFO | vx_thing_controller.ex | `things_with_usage/2` — duplicate `now` binding |

<!-- B020.md -->
# Audit Report B020
**Audit run:** 2026-02-27-01
**Agent:** B020 (Pass 2)
**Scope:** Test coverage gaps for four VX controllers

---

## Source Files Audited

1. `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
2. `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
3. `lib/api_server_web/controllers/vx_user_controller.ex`
4. `lib/api_server_web/controllers/vx_user_function_controller.ex`

---

## Test Coverage Search Results

Searched the entire `test/` directory for:
- Module names: `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXUserController`, `[REDACTED-AWS-SMTP-PASSWORD]`
- Case-insensitive path patterns: `vx_thing_omega`, `vx_thing_summary`, `vx_user_controller`, `vx_user_function`
- All individual public function names across all four files

**Result: Zero matches found.** No test file — direct or indirect — exercises any function in any of the four assigned source files.

The only existing controller test files are:
- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`

Neither references any of the audited modules.

---

## Reading Evidence

### 1. `ApiServerWeb.VXThingOmegaController`

**Module:** `ApiServerWeb.VXThingOmegaController`
**Uses:** `ApiServerWeb` (:controller), `Timex`
**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXThing`
**Action fallback:** `ApiServerWeb.FallbackController`

**Public functions defined:**

| Line | Function | Signature |
|------|----------|-----------|
| 10 | `get_container_lift_report/2` | `(conn, %{"hardwareid", "from", "to"})` |
| 22 | `get_lift_summary_report/2` | `(conn, %{"hardwareid", "from", "to"})` — clause 1 |
| 33 | `get_lift_list_report/2` | `(conn, %{"hardwareid", "from", "to"})` |
| 44 | `get_lift_summary_report/2` | `(conn, %{"fleetid", "from", "to"})` — clause 2 |
| 53 | `get_operation_summary_report/2` | `(conn, %{"fleetid", "from", "to"})` |
| 63 | `get_engine_utilization_report/2` | `(conn, %{"hardwareid", "from", "to"})` |

**Types / structs / constants:** None defined.

**Notes:**
- `get_lift_summary_report/2` has two clauses dispatched by parameter key (`hardwareid` vs `fleetid`). Both are untested.
- All actions call `ApiServer.Guardian.Plug.current_claims/1` (requires authenticated connection) and delegate to `ApiServer.Vx` context functions before rendering. No guard, `with`, or error branch is written into these actions — errors would propagate to `FallbackController`.

---

### 2. `ApiServerWeb.VXThingSummaryController`

**Module:** `ApiServerWeb.VXThingSummaryController`
**Uses:** `ApiServerWeb` (:controller)
**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXThingSummary`
**Action fallback:** `ApiServerWeb.FallbackController`

**Public functions defined:**

| Line | Function | Signature |
|------|----------|-----------|
| 9  | `index/2`        | `(conn, _params)` |
| 14 | `create/2`       | `(conn, %{"vx_thing_summary" => ...})` |
| 23 | `show/2`         | `(conn, %{"id" => id})` |
| 28 | `update/2`       | `(conn, %{"id" => id, "vx_thing_summary" => ...})` |
| 36 | `delete/2`       | `(conn, %{"id" => id})` |
| 45 | `do_fix_summary/2` | `(hardwareid, customer)` — non-action public helper |

**Types / structs / constants:** None defined.

**Notes:**
- `create/2` uses `with {:ok, %VXThingSummary{}} <- ...` — the error branch is delegated to `FallbackController` (untested failure path for invalid params).
- `update/2` similarly relies on `with` for error propagation.
- `do_fix_summary/2` is a public function (not a Phoenix action) that calls `VXThingSummary.validate_for_hardwareid/2`. It has no tests and no callers visible within this file.

---

### 3. `ApiServerWeb.VXUserController`

**Module:** `ApiServerWeb.VXUserController`
**Uses:** `ApiServerWeb` (:controller)
**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXUser`
**Action fallback:** `ApiServerWeb.FallbackController`

**Public functions defined:**

| Line | Function | Signature |
|------|----------|-----------|
| 9   | `create/2`                 | `(conn, %{"vx_user" => ...})` |
| 18  | `lookup_customer_from_conn/1` | `(conn)` — non-action public helper |
| 41  | `login/2`                  | `(conn, %{"customer", "password", "email"})` |
| 59  | `change_password/2`        | `(conn, %{"current_password", "new_password"})` |
| 82  | `get_users/2`              | `(conn, %{"customer" => _})` |
| 89  | `get_user_with_email/2`    | `(conn, %{"email", "customer"})` |
| 99  | `update_key_if_value/3`    | `(map, key_to_save, nil)` — clause 1 (nil guard) |
| 100 | `update_key_if_value/3`    | `(map, key_to_save, value_to_add)` — clause 2 |
| 104 | `update_user/2`            | `(conn, %{"customer", "user"})` — clause 1 |
| 127 | `update_user/2`            | `(conn, %{"customer"})` — clause 2 (missing "user" key) |
| 131 | `create_user/2`            | `(conn, %{"customer", "user"})` |
| 153 | `delete_user/2`            | `(conn, %{"customer", "id"})` |
| 168 | `get_user_fleets/2`        | `(conn, %{"user_id"})` |
| 180 | `manage_user_fleets/2`     | `(conn, %{"user_id", "allowed_fleets"})` |

**Types / structs / constants:** None defined.

**Notes:**
- `lookup_customer_from_conn/1` contains a hardcoded origin-to-customer mapping covering 7 specific origins plus a catch-all defaulting to `"vx_dev"`. The catch-all is security-sensitive (unknown origins silently become `"vx_dev"`).
- `login/2` calls `Vx.get_rhm_user/3` without guarding against `nil` or non-map returns before passing to `Guardian.encode_and_sign/2`. A bad credential could raise rather than returning the `{:error, _}` branch.
- `get_user_with_email/2` uses `[user | _] = Vx.get_rhm_user(email, customer)` — a match error will raise (not a graceful 404/500) if the list is empty.
- `change_password/2` has an inline `case changeset.errors do _ -> ...` that catches all errors with a single wildcard — the specific error branch is unreachable dead code.
- `update_user/2` clause 2 (line 127) returns a plain 500 with no "user" key. This defensive fallback is never tested.
- `IO.inspect` left in `lookup_customer_from_conn/1` (line 19) — production debug output.

---

### 4. `ApiServerWeb.VXUserFunctionController`

**Module:** `ApiServerWeb.VXUserFunctionController`
**Uses:** `ApiServerWeb` (:controller)
**Aliases:** `ApiServer.Vx`, `ApiServer.Vx.VXUserFunction`
**Action fallback:** `ApiServerWeb.FallbackController`

**Public functions defined:** None (all action function bodies are commented out).

**Types / structs / constants:** None defined.

**Notes:**
- The entire action set (`index`, `create`, `show`, `update`, `delete`) is commented out. The module compiles but exposes no endpoints. There is nothing to test at runtime, but the commented-out code represents dead scaffolding that may confuse future developers.

---

## Findings

### B020-1 — HIGH: No test file exists for `[REDACTED-AWS-SMTP-PASSWORD]`

**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
**Severity:** HIGH

No test file exists and no indirect test coverage was found. The module defines six public action functions (with one polymorphic function having two clauses). Zero lines of this controller are exercised by the test suite.

---

### B020-2 — HIGH: No test file exists for `[REDACTED-AWS-SMTP-PASSWORD]`

**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
**Severity:** HIGH

No test file exists and no indirect test coverage was found. The module defines five Phoenix actions plus one public non-action helper (`do_fix_summary/2`). Zero lines are covered.

---

### B020-3 — HIGH: No test file exists for `VXUserController`

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** HIGH

No test file exists and no indirect test coverage was found. This is the most complex of the four controllers, with 14 distinct public functions/clauses including authentication (`login/2`), password change, user CRUD, and fleet management. Zero lines are covered.

---

### B020-4 — HIGH: No test file exists for `[REDACTED-AWS-SMTP-PASSWORD]`

**File:** `lib/api_server_web/controllers/vx_user_function_controller.ex`
**Severity:** HIGH

No test file exists. The module has no active functions (all are commented out), but the module itself has no tests confirming it compiles cleanly or that the action_fallback is wired correctly. Severity is lower in practice but remains HIGH by policy (source file with no test file at all).

---

### B020-5 — MEDIUM: All six actions in `[REDACTED-AWS-SMTP-PASSWORD]` untested

**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
**Severity:** MEDIUM
**Lines:** 10, 22, 33, 44, 53, 63

Each of `get_container_lift_report/2`, `get_lift_summary_report/2` (both clauses), `get_lift_list_report/2`, `get_operation_summary_report/2`, and `get_engine_utilization_report/2` lacks any test. Both the happy path (valid date range and hardware/fleet ID) and the error path (invalid ID causing `Vx.get_thing_name_with_hardware_id!/2` to raise) are untested.

---

### B020-6 — MEDIUM: All five actions in `[REDACTED-AWS-SMTP-PASSWORD]` untested

**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
**Severity:** MEDIUM
**Lines:** 9, 14, 23, 28, 36

`index/2`, `create/2`, `show/2`, `update/2`, and `delete/2` are all untested. This is a full CRUD controller with no test coverage at all — happy paths, invalid-data paths, and not-found paths are all missing.

---

### B020-7 — MEDIUM: `do_fix_summary/2` public helper untested

**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
**Severity:** MEDIUM
**Line:** 45

`do_fix_summary/2` is a public function that delegates to `VXThingSummary.validate_for_hardwareid/2`. It is not a Phoenix action (takes `hardwareid` and `customer`, not `conn`), has no callers visible in this file, and has no tests. Its purpose and expected return values are unclear.

---

### B020-8 — MEDIUM: `login/2` action completely untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 41–57

Authentication is the highest-risk path in this controller. Neither the success path (valid credentials → JWT token issued, session set) nor the failure path (`{:error, _message}` from `Guardian.encode_and_sign/2` → 500 response) is exercised by any test.

---

### B020-9 — MEDIUM: `change_password/2` action untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 59–80

No test covers: successful password change, incorrect current password (`user == nil`), empty `new_password`, or Ecto changeset error on update.

---

### B020-10 — MEDIUM: `create_user/2`, `update_user/2`, `delete_user/2` untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 104–165

All three user-mutation actions are untested. Error branches — duplicate email on create (line 133–134), duplicate email on update (line 116), generic Ecto error on update (line 118), delete failure (line 159–160), and the defensive `update_user/2` clause with no "user" key (line 127–129) — are completely unexercised.

---

### B020-11 — MEDIUM: `get_users/2`, `get_user_with_email/2`, `get_user_fleets/2`, `manage_user_fleets/2` untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 82, 89, 168, 180

All four read/fleet-management actions lack tests. No happy path or error path is verified.

---

### B020-12 — MEDIUM: `lookup_customer_from_conn/1` untested — security-sensitive

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** MEDIUM
**Lines:** 18–39

This function maps the HTTP `Origin` header to a customer tenant string. The catch-all clause (`_`) silently maps any unrecognised origin to `"vx_dev"`. There are no tests for any of the seven named origin strings, the default, or malformed/absent Origin headers. A regression here could cause data from one tenant to be served under another tenant context.

---

### B020-13 — MEDIUM: `get_container_lift_report/2` — missing-parameter clause untested

**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
**Severity:** MEDIUM

All omega controller actions use only a single pattern-match clause with required keys (`hardwareid`/`fleetid`, `from`, `to`). If any required parameter is absent the request will fall through to `FallbackController`. This fallback behaviour is never verified.

---

### B020-14 — LOW: `get_user_with_email/2` — empty-list match raises uncaught exception

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Line:** 90

```elixir
[user | _] = Vx.get_rhm_user(email, customer)
```

If `Vx.get_rhm_user/2` returns an empty list `[]`, this match raises a `MatchError` rather than executing the `nil` branch below it. The nil guard on line 92 (`if user != nil`) would never be reached in that scenario. No test documents or guards against this edge case.

---

### B020-15 — LOW: `change_password/2` — dead error-branch code

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Lines:** 71–74

The inner `case changeset.errors do` at line 71 has only a wildcard clause (`_`), making any specific pattern match on changeset errors unreachable. The structure mirrors a copy-paste from `update_user/2` (which does have a specific `[aacuser: ...]` clause) but was not adapted. No test surfaces this dead code.

---

### B020-16 — LOW: `update_key_if_value/3` utility function untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Lines:** 99–102

This two-clause public utility function (nil-value no-op vs. map insert) is called internally but has no direct unit tests. Edge cases — passing an existing key (note: `Map.put_new/3` does NOT overwrite) and passing a non-nil value to a map that already contains the key — are unverified.

---

### B020-17 — LOW: `IO.inspect` debug call in production code path

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Line:** 19

```elixir
IO.inspect get_req_header(conn, "origin")
```

`lookup_customer_from_conn/1` is called on every `login/2` request. The `IO.inspect` will emit the `Origin` header value to stdout/logs on every login attempt. No test asserts this is absent or that it does not leak PII.

---

### B020-18 — LOW: Boundary/edge cases for date range parameters never tested

**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
**Severity:** LOW

All six omega controller actions accept `from_date` and `to_date` as raw string parameters with no validation before passing to `Vx` context functions. Edge cases — empty string, invalid date format, `from > to`, identical from/to — are entirely untested and the behaviour in each case is unknown.

---

### B020-19 — LOW: `manage_user_fleets/2` — side-effect operations untested

**File:** `lib/api_server_web/controllers/vx_user_controller.ex`
**Severity:** LOW
**Lines:** 180–197

This action performs `Enum.each` mutations (add and remove fleet assignments) with no error handling on individual operations. If any `Vx.add_fleet_to_user/3` or `Vx.remove_fleet_from_user/3` call fails, the error is silently swallowed and the function still returns `200 OK`. No test verifies partial-failure behaviour.

---

## Summary Table

| ID      | Severity | File                              | Description |
|---------|----------|-----------------------------------|-------------|
| B020-1  | HIGH     | vx_thing_omega_controller.ex      | No test file at all |
| B020-2  | HIGH     | vx_thing_summary_controller.ex    | No test file at all |
| B020-3  | HIGH     | vx_user_controller.ex             | No test file at all |
| B020-4  | HIGH     | vx_user_function_controller.ex    | No test file at all |
| B020-5  | MEDIUM   | vx_thing_omega_controller.ex      | All 6 actions (both clauses) untested |
| B020-6  | MEDIUM   | vx_thing_summary_controller.ex    | All 5 CRUD actions untested |
| B020-7  | MEDIUM   | vx_thing_summary_controller.ex    | `do_fix_summary/2` helper untested |
| B020-8  | MEDIUM   | vx_user_controller.ex             | `login/2` auth action untested |
| B020-9  | MEDIUM   | vx_user_controller.ex             | `change_password/2` untested |
| B020-10 | MEDIUM   | vx_user_controller.ex             | `create_user/2`, `update_user/2`, `delete_user/2` untested |
| B020-11 | MEDIUM   | vx_user_controller.ex             | `get_users/2`, `get_user_with_email/2`, `get_user_fleets/2`, `manage_user_fleets/2` untested |
| B020-12 | MEDIUM   | vx_user_controller.ex             | `lookup_customer_from_conn/1` security mapping untested |
| B020-13 | MEDIUM   | vx_thing_omega_controller.ex      | Missing-parameter fallback path untested |
| B020-14 | LOW      | vx_user_controller.ex             | `get_user_with_email/2` empty-list match raises uncaught exception |
| B020-15 | LOW      | vx_user_controller.ex             | Dead error-branch in `change_password/2` |
| B020-16 | LOW      | vx_user_controller.ex             | `update_key_if_value/3` utility untested |
| B020-17 | LOW      | vx_user_controller.ex             | `IO.inspect` debug leak on every login |
| B020-18 | LOW      | vx_thing_omega_controller.ex      | Date range boundary/edge cases untested |
| B020-19 | LOW      | vx_user_controller.ex             | `manage_user_fleets/2` silently swallows per-fleet errors |

<!-- B021.md -->
# Audit Report B021
**Audit Run:** 2026-02-27-01
**Agent:** B021 (Pass 2)
**Files Reviewed:**
- `lib/api_server_web/resolvers/puls.ex`
- `lib/api_server_web/resolvers/things.ex`

---

## READING EVIDENCE

### File 1: `lib/api_server_web/resolvers/puls.ex`

**Module:** `ApiServerWeb.Resolvers.Puls`

**Public Functions Defined:**

| Function | Arity | Line |
|----------|-------|------|
| `puls_record/3` | 3 | 3 |

**Types / Structs / Constants:**
- Hardcoded Base64 API token on line 4: `token = "VHJhY2tpbmdTb2x1dGlvbnM6U2tQREk4ZXo="`
- Hardcoded external API base URL on line 5: `"https://puls.calamp.com/service2/lmu/#{hardwareid}"`
- No module-level constants, structs, or typespecs defined.

**Behaviour summary:**
`puls_record/3` accepts a `hardwareid` argument, constructs an HTTP GET request to the CalAMP PULS API using a hardcoded Basic Auth token, decodes the JSON response with `Poison.decode!/1`, and returns `{:ok, record}` containing `esn`, `iccid`, and `group` fields. On `:error` from `HTTPoison.get/3`, it blocks in a `receive/after` block for 60 seconds then recursively calls itself.

---

### File 2: `lib/api_server_web/resolvers/things.ex`

**Module:** `ApiServerWeb.Resolvers.Things`

**Public Functions Defined:**

| Function | Arity | Line |
|----------|-------|------|
| `find_thing/3` | 3 | 3 |
| `get_all_things/3` | 3 | 13 |

**Types / Structs / Constants:**
- No module-level constants, structs, or typespecs defined.

**Behaviour summary:**
- `find_thing/3` accepts `aadhardwareid` and `customer`, delegates to `ApiServer.Vx.get_vx_thing_with_hardware_id!/2`, returns `{:ok, thing}` or `{:error, "Thing with HardwareId ... not found"}` when the result is `nil`.
- `get_all_things/3` accepts `customer`, delegates to `ApiServer.Vx.list_vxthings/1`, returns `{:ok, things}` (with `aadhardwareid` coerced to string via `Integer.to_string/1`) or `{:error, "Error fetching things for ..."}` when the result is `nil`.

---

## TEST COVERAGE INVESTIGATION

**Direct test files:** None exist for either module.

**Indirect coverage search — test directory scanned for:**
- Module names: `Resolvers.Puls`, `ApiServerWeb.Resolvers.Puls`, `Resolvers.Things`, `ApiServerWeb.Resolvers.Things`
- Function names: `puls_record`, `find_thing`, `get_all_things`
- Related symbols: `HTTPoison`, `Poison.decode`, `puls`, `get_vx_thing`, `list_vxthings`

**Result:** Zero matches found across all 5 test files in the test directory.

The only test files present in the repository are:
- `test/api_server_web/controllers/calamp_controller_test.exs` — empty (module body contains no test cases)
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — tests CRUD for `VXRestriction`; no GraphQL resolver coverage
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`
- `test/test_helper.exs`

Neither resolver module is exercised by any existing test.

---

## FINDINGS

---

### B021-1
**Severity:** HIGH
**File:** `lib/api_server_web/resolvers/puls.ex`
**Finding:** No test file exists for `ApiServerWeb.Resolvers.Puls` and zero indirect test coverage was found anywhere in the test suite.
**Detail:** The module `ApiServerWeb.Resolvers.Puls` has no corresponding test file and is not referenced by any existing test. The sole public function `puls_record/3` — which is wired as the resolver for the `:get_puls_record` GraphQL query in `ApiServerWeb.Schema` — is completely untested.

---

### B021-2
**Severity:** HIGH
**File:** `lib/api_server_web/resolvers/things.ex`
**Finding:** No test file exists for `ApiServerWeb.Resolvers.Things` and zero indirect test coverage was found anywhere in the test suite.
**Detail:** The module `ApiServerWeb.Resolvers.Things` has no corresponding test file and is not referenced by any existing test. Both public functions `find_thing/3` and `get_all_things/3` — which are wired as resolvers for `:get_thing` and `:get_all_things` GraphQL queries in `ApiServerWeb.Schema` — are completely untested.

---

### B021-3
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (line 3)
**Finding:** The `:ok` success path of the PULS API call (lines 18–24) is untested.
**Detail:** No test exercises the happy path where `HTTPoison.get/3` returns `{:ok, response}`, `Poison.decode!/1` succeeds, and the function returns `{:ok, %{esn: ..., iccid: ..., group: ...}}`.

---

### B021-4
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (lines 10–17)
**Finding:** The `:error` retry path is untested.
**Detail:** When `HTTPoison.get/3` returns `{:error, _}`, the function enters a `receive/after` block that blocks the calling process for 60 seconds before recursively retrying. No test exercises this path. This behaviour is also dangerous in production (see B021-7), making test coverage especially important.

---

### B021-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/things.ex`
**Function:** `find_thing/3` (line 3)
**Finding:** Both the success path and the `nil`-not-found error path are untested.
**Detail:** No test exercises `find_thing/3` returning `{:ok, thing}` for a found record, nor returning `{:error, "Thing with HardwareId ... not found"}` when the context returns `nil`.

---

### B021-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/things.ex`
**Function:** `get_all_things/3` (line 13)
**Finding:** Both the success path and the `nil`-error path are untested.
**Detail:** No test exercises `get_all_things/3` returning `{:ok, things}` with the `aadhardwareid` integer-to-string coercion applied, nor the `{:error, "Error fetching things for ..."}` error path when `list_vxthings/1` returns `nil`.

---

### B021-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (lines 10–17)
**Finding:** Unbounded recursive retry on HTTP error creates a process-blocking loop with no termination condition.
**Detail:** On any `HTTPoison` error, the resolver blocks its calling process for 60 seconds via `receive/after` and then calls itself recursively with no retry limit, no backoff cap, and no circuit-breaker. If the remote PULS service is persistently unavailable, this will permanently block the GraphQL request-handling process and accumulate stack frames indefinitely. No test verifies or documents the intended retry behaviour or its limits.

---

### B021-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (line 19)
**Finding:** `Poison.decode!/1` (bang form) is used without rescue; a malformed or unexpected API response will raise an unhandled exception.
**Detail:** If the PULS API returns a non-JSON body, an empty body, or a JSON object missing the keys `"esn"`, `"iccid"`, or `"group"`, `Poison.decode!/1` or `Map.fetch!/2` will raise a runtime exception that propagates unhandled to the caller. No test exercises these failure paths.

---

### B021-9
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (line 4)
**Finding:** API credentials are hardcoded as a plaintext Base64 string in source code.
**Detail:** The Basic Auth token `"VHJhY2tpbmdTb2x1dGlvbnM6U2tQREk4ZXo="` is committed in source. No test covers the case where the credential is rotated, missing from the environment, or invalid, because it cannot be injected or mocked in the current design.

---

### B021-10
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/things.ex`
**Function:** `get_all_things/3` (line 18)
**Finding:** The `Integer.to_string/1` coercion of `aadhardwareid` is untested for edge cases.
**Detail:** No test verifies the coercion behaviour when `aadhardwareid` is `0`, a negative integer, or already a string (which would cause `Integer.to_string/1` to raise `ArgumentError`). The schema defines `aadhardwareid` as `:string` on the GraphQL type but the underlying database field is an integer, making this conversion critical to the API contract.

---

### B021-11
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/things.ex`
**Function:** `find_thing/3` (line 3)
**Finding:** The `nil`-guard pattern for the not-found case may not behave as expected given the function is named with a bang (`get_vx_thing_with_hardware_id!`).
**Detail:** The delegated context function `ApiServer.Vx.get_vx_thing_with_hardware_id!/2` uses the Elixir convention of a trailing `!` to indicate it raises on error rather than returning `nil`. The `nil ->` branch in the `case` statement would therefore be unreachable if the function raises on not-found, meaning the intended error handling path `{:error, "Thing with HardwareId ... not found"}` would never be returned. No test verifies which behaviour actually occurs.

---

### B021-12
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/puls.ex`
**Function:** `puls_record/3` (line 5)
**Finding:** No test covers the case where `hardwareid` is an empty string or contains characters that would produce an invalid URL.
**Detail:** The `hardwareid` argument is interpolated directly into the URL path with no validation or encoding. An empty string, whitespace, or URL-unsafe characters would produce a malformed request to the PULS API with no error guard before the HTTP call.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B021-1 | HIGH | `resolvers/puls.ex` | No test file; entire module untested |
| B021-2 | HIGH | `resolvers/things.ex` | No test file; entire module untested |
| B021-3 | MEDIUM | `resolvers/puls.ex` | `puls_record/3` success path untested |
| B021-4 | MEDIUM | `resolvers/puls.ex` | `puls_record/3` `:error` retry path untested |
| B021-5 | MEDIUM | `resolvers/things.ex` | `find_thing/3` success and not-found paths untested |
| B021-6 | MEDIUM | `resolvers/things.ex` | `get_all_things/3` success and nil-error paths untested |
| B021-7 | MEDIUM | `resolvers/puls.ex` | Unbounded recursive retry loop — untested and dangerous |
| B021-8 | MEDIUM | `resolvers/puls.ex` | `Poison.decode!` / `Map.fetch!` raise on bad API response; untested |
| B021-9 | LOW | `resolvers/puls.ex` | Hardcoded API credential prevents mocking/rotation testing |
| B021-10 | LOW | `resolvers/things.ex` | `Integer.to_string/1` edge cases untested |
| B021-11 | LOW | `resolvers/things.ex` | Bang-function `nil` guard likely unreachable; untested |
| B021-12 | LOW | `resolvers/puls.ex` | Empty/invalid `hardwareid` not validated before URL construction |

<!-- B022.md -->
# Audit Report B022
**Audit run:** 2026-02-27-01
**Agent:** B022
**Pass:** 2 (Test Coverage)
**Files audited:**
- `lib/api_server_web/router.ex`
- `lib/api_server_web/schema.ex`
- `lib/api_server_web/schema/thing_types.ex`

---

## READING EVIDENCE

### File: `lib/api_server_web/router.ex`

**Module:** `ApiServerWeb.Router`

**Pipelines defined:**
- `:browser` — HTML, session, CSRF, secure headers
- `:api` — JSON, session
- `:api_xml` — XML, session
- `:authenticated` — `ApiServer.Guardian.AuthPipeline`

**Routes — scope `/api/v1` (unauthenticated block, lines 28–32):**

| # | Method | Path | Controller | Action |
|---|--------|------|------------|--------|
| R01 | GET | `/api/v1/rhm/engine_usage` | VXThingController | `:combined_engine_usage` |
| R02 | GET | `/api/v1/rhm/monday_hour_meters` | VXThingController | `:monday_hour_meters` |

**Routes — scope `/api/v1` (`:api` + `:authenticated` pipelines, lines 33–154):**

| # | Method | Path | Controller | Action |
|---|--------|------|------------|--------|
| R03 | GET | `/api/v1/rhm/pape_export` | VXThingController | `:pape_export` |
| R04 | GET | `/api/v1/rhm/sielift_export` | VXThingController | `:sielift_export` |
| R05 | GET | `/api/v1/rhm/reports/geofence_events` | GeofenceController | `:process_things_geofences` |
| R06 | GET | `/api/v1/rhm/work_in_progress` | VXThingController | `:sielift_export` (alias — was `:work_in_progress`) |
| R07 | GET | `/api/v1/rhm/things_with_usage` | VXThingController | `:rhm_get_things_with_usage` |
| R08 | GET | `/api/v1/rhm/thing_records` | VXThingController | `:rhm_get_thing_records` |
| R09 | GET | `/api/v1/rhm/:customer/things/names` | VXThingController | `:rhm_get_things_names` |
| R10 | GET | `/api/v1/rhm/:customer/things` | VXThingController | `:rhm_get_things` |
| R11 | GET | `/api/v1/rhm/thing/:hardwareid/events` | VXThingController | `:rhm_get_thing_events` |
| R12 | GET | `/api/v1/rhm/thing/:hardwareid/usage` | VXThingController | `:rhm_get_thing_usage` |
| R13 | GET | `/api/v1/rhm/:customer/thing/:hardwareid` | VXThingController | `:rhm_get_thing` |
| R14 | GET | `/api/v1/rhm/thing/:hardwareid/active_rental` | VXRentalController | `:rhm_active_rental` |
| R15 | POST | `/api/v1/rhm/thing/` | VXThingController | `:update_thing` |
| R16 | PUT | `/api/v1/rhm/thing/` | VXThingController | `:create_thing` |
| R17 | GET | `/api/v1/rhm/thing/:hardwareid/omega_data` | VXThingEventController | `:get_current_omega_status` |
| R18 | GET | `/api/v1/vx/:customer/thing/:hardwareid/movements/:day` | VXThingController | `:get_movements` |
| R19 | GET | `/api/v1/rhm/omega_thing/:hardwareid/container_lift_report` | VXThingOmegaController | `:get_container_lift_report` |
| R20 | GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_summary_report` | VXThingOmegaController | `:get_lift_summary_report` |
| R21 | GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_list_report` | VXThingOmegaController | `:get_lift_list_report` |
| R22 | GET | `/api/v1/rhm/omega_fleet/:fleetid/lift_summary_report` | VXThingOmegaController | `:get_lift_summary_report` |
| R23 | GET | `/api/v1/rhm/omega_thing/:hardwareid/engine_utilization_report` | VXThingOmegaController | `:get_engine_utilization_report` |
| R24 | GET | `/api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` | VXThingOmegaController | `:get_operation_summary_report` |
| R25 | GET | `/api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` | VXThingOmegaController | `:get_operation_summary_report` (DUPLICATE of R24) |
| R26 | GET | `/api/v1/rhm/fleets` | VXFleetController | `:get_fleets` |
| R27 | GET | `/api/v1/rhm/fleets_with_equipment` | VXFleetController | `:get_fleets_with_equipment` |
| R28 | PUT | `/api/v1/rhm/:customer/fleet/` | VXFleetController | `:create_fleet` |
| R29 | DELETE | `/api/v1/rhm/:customer/fleet/:id` | VXFleetController | `:delete_fleet` |
| R30 | POST | `/api/v1/rhm/:customer/fleet/` | VXFleetController | `:update_fleet` |
| R31 | GET | `/api/v1/rhm/:customer/fleet/:id/equipment` | VXFleetController | `:get_equipment_in_fleet` |
| R32 | POST | `/api/v1/rhm/:customer/fleet/:id/manage` | VXFleetController | `:manage_fleet` |
| R33 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXAblRecordController | `:rhm_service_records` |
| R34 | GET | `/api/v1/rhm/:customer/rentals` | VXRentalController | `:get_rentals` |
| R35 | POST | `/api/v1/rhm/:customer/rentals/` | VXRentalController | `:update_rental` |
| R36 | PUT | `/api/v1/rhm/:customer/rentals/` | VXRentalController | `:create_rental` |
| R37 | DELETE | `/api/v1/rhm/:customer/rentals/:id` | VXRentalController | `:delete_rental` |
| R38 | GET | `/api/v1/rhm/thing/:hardwareid/rental_anniversaries` | VXRentalController | `:get_rental_anniversaries` |
| R39 | GET | `/api/v1/rhm/rentals/midpac_style_report` | VXRentalController | `:get_midpac_style_rental_report` |
| R40 | POST | `/api/v1/rhm/user/change_password` | VXUserController | `:change_password` |
| R41 | GET | `/api/v1/rhm/user/:user_id/fleets` | VXUserController | `:get_user_fleets` |
| R42 | POST | `/api/v1/rhm/user/:user_id/fleets` | VXUserController | `:manage_user_fleets` |
| R43 | GET | `/api/v1/rhm/:customer/users` | VXUserController | `:get_users` |
| R44 | GET | `/api/v1/rhm/:customer/user/:email` | VXUserController | `:get_user_with_email` |
| R45 | POST | `/api/v1/rhm/:customer/user/` | VXUserController | `:update_user` |
| R46 | PUT | `/api/v1/rhm/:customer/user/` | VXUserController | `:create_user` |
| R47 | DELETE | `/api/v1/rhm/:customer/user/:id` | VXUserController | `:delete_user` |
| R48 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXCustomerController | `:index` |
| R49 | GET | `/api/v1/rhm/customer/:id` | VXCustomerController | `:show` |
| R50 | POST | `[REDACTED-AWS-SMTP-PASSWORD]` | VXCustomerController | `:update` |
| R51 | PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | VXCustomerController | `:create` |
| R52 | DELETE | `/api/v1/rhm/customer/:id` | VXCustomerController | `:delete` |
| R53 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXThingController | `:get_fleet_map` |
| R54 | GET | `/api/v1/rhm/fleetmap/:fleetid` | VXThingController | `:get_fleet_map` |
| R55 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | GeofenceController | `:list_all_geofences` |
| R56 | PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | GeofenceController | `:create_geofence` |
| R57 | POST | `[REDACTED-AWS-SMTP-PASSWORD]` | GeofenceController | `:update_geofence` |
| R58 | DELETE | `/api/v1/rhm/geofence/:id` | GeofenceController | `:delete_geofence` |

**Routes — scope `/api/v1` (`:api` pipeline only, lines 156–177):**

| # | Method | Path | Controller | Action |
|---|--------|------|------------|--------|
| R59 | GET | `/api/v1/hc` | UtilityController | `:do_health_check` |
| R60 | POST | `/api/v1/rhm/:customer/login/` | VXUserController | `:login` |
| R61–R66 | (REST) | `[REDACTED-AWS-SMTP-PASSWORD]` | VXThingSummaryController | `resources` (index, show, create, update, delete) |
| R67 | GET | `/api/v1/files/getsize/:esn` | FileController | `:get_size` |
| R68 | GET | `/api/v1/files/getfile/:esn` | FileController | `:send_file_download` |
| R69 | GET | `/api/v1/vx/:customer/thing/with_checklists` | VXThingController | `:get_hardware_with_checklists` |
| R70 | GET | `/api/v1/vx/:customer/thing/:hardwareid/checklists` | VXThingController | `:get_checklists` |
| R71 | GET | `/api/v1/vx/:customer/pmServicesAjax/:hardwareid` | VXThingController | `:get_pm_data` |
| R72 | GET | `/api/v1/vx/:customer/pmServicesAjax` | VXThingController | `:get_all_pm_data` |
| R73 | GET | `/api/v1/vx/:customer/rentalStats` | VXThingController | `:get_all_rental_stats` |
| R74 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXThingController | `:get_timezones` |
| R75 | GET | `/api/v1/rhm/:customer/fix_info` | VXThingInfoController | `:fix_infos` |

**Routes — scope `/` (`:api_xml` pipeline, lines 179–193):**

| # | Method | Path | Controller | Action |
|---|--------|------|------------|--------|
| R76 | GET | `/` | UtilityController | `:do_health_check` |
| R77 | GET | `/geocode` | UtilityController | `:do_geocode_lookup` |
| R78 | GET | `/error/:status_code` | UtilityController | `:do_error` |
| R79 | POST | `/test-omega-data` | UtilityController | `:process_incoming_omegawatch_data` |
| R80 | POST | `/prodisplay/event` | UtilityController | `:process_prodisplay_event` |
| R81 | POST | `/` | DigitalMatterController | `:get_g62_data` |
| R82 | POST | `/erp-import` | UtilityController | `:erp_import` |
| R83 | POST | `/driverid-converter` | UtilityController | `:driverid_converter` |
| R84 | GET | `/dis-sync` | UtilityController | `:sync_to_DISCorp` |

**Note:** GraphQL forwarding (`/graphql`, `/graphiql`) is commented out at lines 195–202.

---

### File: `lib/api_server_web/schema.ex`

**Module:** `ApiServerWeb.Schema`

**Queries defined:**

| # | Field | Return Type | Args | Resolver | Line |
|---|-------|-------------|------|----------|------|
| Q01 | `:get_thing` | `:thing` | `aadhardwareid` (non_null string), `customer` (non_null string) | `Resolvers.Things.find_thing/3` | 11 |
| Q02 | `:get_puls_record` | `:puls_record` | `hardwareid` (non_null string) | `Resolvers.Puls.puls_record/3` | 18 |
| Q03 | `:get_all_things` | `list_of(:thing)` | `customer` (non_null string) | `Resolvers.Things.get_all_things/3` | 24 |

**Mutations defined:** None.
**Subscriptions defined:** None.

---

### File: `lib/api_server_web/schema/thing_types.ex`

**Module:** `ApiServerWeb.Schema.ThingTypes`

**Types defined:**

| # | Object | Fields | Line |
|---|--------|--------|------|
| T01 | `:thing` | `aadcustcode`, `aaddesc`, `aadintext`, `aadaddr`, `aadcustomerid`, `aadcat`, `aadhardwareid`, `aadhw_type`, `aadmake`, `aadmodel`, `aadserialno`, `aadmobile`, `aadimei`, `aadhourmeter`, `aadhourmeter1`, `aadhourmeter2`, `aadhourmeter3`, `aadhourmeter4`, `aadodometer`, `aadhourmeteromega`, `aadhourmeterothcan`, `aaddateintoservice`, `aadlastservice`, `aadvalid`, `aadserviceoffset`, `aadsvchrs`, `aadrange_lat`, `aadrange_long`, `aadrange_dist`, `aadrange_unit`, `service_calculation_input` | 5–37 |
| T02 | `:puls_record` | `esn`, `iccid`, `group` | 41–45 |

---

## TEST COVERAGE SEARCH RESULTS

The entire `test/` tree contains exactly five test files:
- `test/api_server_web/controllers/calamp_controller_test.exs` — empty stub (module body contains only a commented-out `use` line, no test cases)
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — tests `VXRestriction` CRUD; uses routes not present in `router.ex` (generated path helpers for a resource that is not declared in the router)
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`
- `test/test_helper.exs`

Grep searches for `ApiServerWeb.Router`, `ApiServerWeb.Schema`, `ApiServerWeb.Schema.ThingTypes`, every controller module name, every GraphQL query name, and every route path prefix returned **zero matches** in any test file.

---

## FINDINGS

---

### B022-1 — No tests exist for `router.ex`
**Severity:** HIGH
**File:** `lib/api_server_web/router.ex`

There is no test file for `ApiServerWeb.Router` and no test file anywhere in the test suite exercises any of the 84 routes defined in the router. The `calamp_controller_test.exs` file is an empty stub. Zero routes have integration-level test coverage.

---

### B022-2 — No tests exist for `schema.ex`
**Severity:** HIGH
**File:** `lib/api_server_web/schema.ex`

`ApiServerWeb.Schema` has no test file and no indirect test coverage. None of the three GraphQL queries (`get_thing`, `get_puls_record`, `get_all_things`) are exercised by any test. Additionally, the GraphQL endpoint is commented out in `router.ex` (lines 195–202), making the schema dead code from the HTTP layer's perspective. No test validates that the schema compiles correctly or that resolvers return expected data shapes.

---

### B022-3 — No tests exist for `thing_types.ex`
**Severity:** HIGH
**File:** `lib/api_server_web/schema/thing_types.ex`

`ApiServerWeb.Schema.ThingTypes` has no test file and no indirect test coverage. Neither the `:thing` object nor the `:puls_record` object is referenced in any test. Because the GraphQL endpoint is also commented out (see B022-2), these type definitions are entirely untested dead code.

---

### B022-4 — All 84 routes individually untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`

Every individual route (R01–R84) lacks a test exercising its success path. This includes all CRUD operations for customers, users, fleets, rentals, geofences, and things; all export/report endpoints; the health-check endpoint; the DigitalMatter ingest endpoint; the ERP-import, driver-id-converter, and DISCorp sync endpoints; and all VX-prefixed endpoints.

---

### B022-5 — Authentication pipeline (`:authenticated`) never tested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 24–26, 33

The `ApiServer.Guardian.AuthPipeline` plug is applied to all routes in the first authenticated block (R03–R58). No test verifies that unauthenticated requests to those routes are rejected (e.g., return 401/403), nor that a valid JWT grants access. The authentication boundary is completely uncovered.

---

### B022-6 — Unauthenticated routes R01 and R02 bypass authentication silently and are untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 29–31

Routes R01 (`/rhm/engine_usage`) and R02 (`/rhm/monday_hour_meters`) are declared before `pipe_through([:api, :authenticated])` is called, meaning they are intentionally public. No test confirms they are reachable without a token, nor that their response content is correct.

---

### B022-7 — Duplicate route declaration
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 91–100

The route `GET /api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` → `VXThingOmegaController.:get_operation_summary_report` is declared twice (R24 and R25, lines 91–94 and 97–100). Phoenix will only match the first declaration; the second is dead. No test detects this or verifies the intended behaviour.

---

### B022-8 — `work_in_progress` route silently aliased to `sielift_export`
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 41–42

The commented-out original route (`VXThingController.:work_in_progress`) has been replaced with a route that calls `:sielift_export` instead. The comment retains the original intent. No test validates that this aliasing is correct or intentional, and there is no test for the endpoint at all.

---

### B022-9 — GraphQL endpoint commented out but schema and types remain active code
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 195–202; `lib/api_server_web/schema.ex`; `lib/api_server_web/schema/thing_types.ex`

The `/graphql` and `/graphiql` forwards are commented out, meaning the schema defined in `schema.ex` and `thing_types.ex` is never reachable at runtime. No test or static check guards against this divergence. If the GraphQL endpoint is intentionally disabled, the schema files should be removed or clearly marked; if the endpoint is intended to be re-enabled, the missing test coverage becomes a blocker.

---

### B022-10 — GraphQL queries missing argument validation and error-path tests
**Severity:** MEDIUM
**File:** `lib/api_server_web/schema.ex`, lines 11–27

All three queries (`get_thing`, `get_puls_record`, `get_all_things`) declare `non_null` arguments. No test verifies:
- behaviour when a required argument is omitted (Absinthe validation error)
- behaviour when the resolver returns `{:error, reason}`
- behaviour when the requested customer or hardwareid does not exist (not-found path)

---

### B022-11 — `:puls_record` type missing fields present in typical PULS data
**Severity:** LOW
**File:** `lib/api_server_web/schema/thing_types.ex`, lines 41–45

The `:puls_record` object exposes only three fields (`esn`, `iccid`, `group`). No test validates that these are the complete and correct fields returned by `Resolvers.Puls.puls_record/3`, nor that additional PULS fields are intentionally omitted.

---

### B022-12 — `[REDACTED-AWS-SMTP-PASSWORD]` resources route not tested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, line 162

`resources("/vx/thingsummaries", VXThingSummaryController, except: [:new, :edit])` generates five REST actions (index, show, create, update, delete). None of these actions has a test, despite being structurally similar to the `VXRestriction` resource for which a test scaffold exists (but is also unused by the router).

---

### B022-13 — File download endpoint untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 165–166

`GET /api/v1/files/getsize/:esn` and `GET /api/v1/files/getfile/:esn` are untested. The file-download endpoint in particular has high risk for path-traversal or missing-file error conditions that should be covered.

---

### B022-14 — Destructive routes (DELETE) entirely untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, lines 106, 118, 136, 143, 153

All five `DELETE` routes (fleet, rental, user, customer, geofence) have no test coverage. No test verifies correct deletion, 404 on unknown IDs, authorization enforcement, or cascade behaviour.

---

### B022-15 — `calamp_controller_test.exs` is an empty stub
**Severity:** LOW
**File:** `test/api_server_web/controllers/calamp_controller_test.exs`

The test file exists but contains only a commented-out `use ApiServerWeb.ConnCase` and no test cases. `CalampController` (if it exists) has zero coverage. The stub gives a false impression of test presence.

---

## SUMMARY TABLE

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B022-1 | HIGH | router.ex | No tests for the router module at all |
| B022-2 | HIGH | schema.ex | No tests for the GraphQL schema |
| B022-3 | HIGH | schema/thing_types.ex | No tests for GraphQL type definitions |
| B022-4 | MEDIUM | router.ex | All 84 routes individually untested |
| B022-5 | MEDIUM | router.ex | Authentication pipeline never tested |
| B022-6 | MEDIUM | router.ex | Intentionally public routes R01/R02 untested |
| B022-7 | MEDIUM | router.ex | Duplicate route declaration (operation_summary_report) |
| B022-8 | MEDIUM | router.ex | `work_in_progress` silently aliased to `sielift_export`, untested |
| B022-9 | MEDIUM | router.ex / schema.ex | GraphQL endpoint commented out, schema is dead but untested |
| B022-10 | MEDIUM | schema.ex | GraphQL query error paths and missing-arg paths untested |
| B022-11 | LOW | schema/thing_types.ex | `:puls_record` field completeness unverified |
| B022-12 | MEDIUM | router.ex | VXThingSummaryController resources route untested |
| B022-13 | MEDIUM | router.ex | File download endpoints untested |
| B022-14 | MEDIUM | router.ex | All DELETE routes untested |
| B022-15 | LOW | calamp_controller_test.exs | Test file is an empty stub |

<!-- B023.md -->
# Audit Report B023
**Audit run:** 2026-02-27-01
**Agent:** B023 (Pass 2)
**Scope:** View layer — changeset, error helpers, error view, file view

---

## Source Files Examined

1. `lib/api_server_web/views/changeset_view.ex`
2. `lib/api_server_web/views/error_helpers.ex`
3. `lib/api_server_web/views/error_view.ex`
4. `lib/api_server_web/views/file_view.ex`

---

## Reading Evidence

### 1. `ApiServerWeb.ChangesetView`
**File:** `lib/api_server_web/views/changeset_view.ex`

| Line | Definition |
|------|-----------|
| 1    | `defmodule ApiServerWeb.ChangesetView` |
| 2    | `use ApiServerWeb, :view` |
| 10   | `def translate_errors(changeset)` — public; traverses changeset errors via `Ecto.Changeset.traverse_errors/2` and `translate_error/1` |
| 14   | `def render("error.json", %{changeset: changeset})` — public render clause; returns `%{errors: translate_errors(changeset)}` |

No types or module-level constants defined.

Called from: `lib/api_server_web/controllers/fallback_controller.ex` line 12 — `render(conn, ApiServerWeb.ChangesetView, "error.json", changeset: changeset)`.

---

### 2. `ApiServerWeb.ErrorHelpers`
**File:** `lib/api_server_web/views/error_helpers.ex`

| Line | Definition |
|------|-----------|
| 1    | `defmodule ApiServerWeb.ErrorHelpers` |
| 6    | `use Phoenix.HTML` |
| 11   | `def error_tag(form, field)` — public; generates HTML `<span>` tags for inline form errors using `content_tag/3` |
| 20   | `def translate_error({msg, opts})` — public; translates a single `{msg, opts}` error tuple via Gettext, with plural-form branching on `opts[:count]` |

No types or module-level constants defined.

Imported globally by `lib/api_server_web.ex` line 41 (`import ApiServerWeb.ErrorHelpers`) into every view module, so `translate_error/1` is available in all views and is called indirectly by `ChangesetView.translate_errors/1`.

---

### 3. `ApiServerWeb.ErrorView`
**File:** `lib/api_server_web/views/error_view.ex`

| Line | Definition |
|------|-----------|
| 1    | `defmodule ApiServerWeb.ErrorView` |
| 2    | `use ApiServerWeb, :view` |
| 13   | `def template_not_found(template, _assigns)` — public (Phoenix callback); returns `%{error: Phoenix.Controller.status_message_from_template(template)}` for any unmatched template |

No explicit `render/2` clauses, no types or constants defined.

Called from: `lib/api_server_web/controllers/fallback_controller.ex` line 18 — `render(ApiServerWeb.ErrorView, :"404")`.

---

### 4. `ApiServerWeb.FileView`
**File:** `lib/api_server_web/views/file_view.ex`

| Line | Definition |
|------|-----------|
| 1    | `defmodule ApiServerWeb.FileView` |
| 2    | `use ApiServerWeb, :view` |
| 3    | `alias ApiServerWeb.FileView` |
| 5    | `def render("index.json", %{files: files})` — public; returns `%{data: render_many(...)}` |
| 9    | `def render("show.json", %{file: file})` — public; returns `%{data: render_one(...)}` |
| 13   | `def render("filesize.json", %{file: file})` — public; returns `%{hardwareid:, size:, num_fobs:}` |
| 20   | `def render("file.json", %{file: file})` — public; returns `%{hardwareid:, size:, num_fobs:, fobs:}` |

No types or module-level constants defined.

Called from: `lib/api_server_web/controllers/file_controller.ex` line 24 — `render(conn, "filesize.json", ...)`.

---

## Test Coverage Search Results

### Direct test files
None exist for any of the four modules (confirmed — no files in `test/api_server_web/views/` for these modules).

### Indirect coverage search
All test files in the repository:
- `test/api_server_web/controllers/calamp_controller_test.exs` — empty stub (only module declaration, no tests)
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — exercises CRUD on `VXRestriction`; posts invalid attrs and asserts `json_response(conn, 422)["errors"] != %{}`
- `test/api_server_web/views/layout_view_test.exs` — empty stub
- `test/api_server_web/views/page_view_test.exs` — empty stub
- `test/test_helper.exs`

Grep results for all module names (`ChangesetView`, `ErrorHelpers`, `ErrorView`, `FileView`, `translate_errors`, `translate_error`, `error_tag`, `template_not_found`) across all test files: **no matches**.

The `vx_restriction_controller_test.exs` "renders errors when data is invalid" test does indirectly exercise the pipeline that calls `FallbackController` -> `ChangesetView.render("error.json")` -> `translate_errors/1` -> `ErrorHelpers.translate_error/1`, but only at the HTTP response boundary (it asserts `["errors"] != %{}`). It does not assert the specific structure, error messages, or translation behaviour of these view modules directly.

---

## Findings

---

### B023-1
**Severity:** HIGH
**File:** `lib/api_server_web/views/changeset_view.ex`
**Finding:** No dedicated test file exists for `ApiServerWeb.ChangesetView`. The module has two public functions (`translate_errors/1` and `render("error.json", ...)`). No test directly constructs a changeset and asserts the rendered JSON structure. The single indirect exercise in `vx_restriction_controller_test.exs` only asserts `["errors"] != %{}` — it does not verify the shape of the errors map, field names, or translated messages.

---

### B023-2
**Severity:** HIGH
**File:** `lib/api_server_web/views/error_helpers.ex`
**Finding:** No dedicated test file exists for `ApiServerWeb.ErrorHelpers`. Neither `translate_error/1` nor `error_tag/2` is directly tested. The module is imported globally into all views but no test exercises these functions in isolation or verifies their output.

---

### B023-3
**Severity:** HIGH
**File:** `lib/api_server_web/views/error_view.ex`
**Finding:** No dedicated test file exists for `ApiServerWeb.ErrorView`. The `template_not_found/2` callback is the module's only function and has no test coverage. No test verifies that arbitrary template names (e.g., `"500.json"`, `"404.html"`) are correctly mapped to their status messages via `Phoenix.Controller.status_message_from_template/1`.

---

### B023-4
**Severity:** HIGH
**File:** `lib/api_server_web/views/file_view.ex`
**Finding:** No dedicated test file and no indirect test coverage exist for `ApiServerWeb.FileView`. All four render clauses (`"index.json"`, `"show.json"`, `"filesize.json"`, `"file.json"`) are completely untested. There is no test file for `FileController` either, so the view is never exercised at any level of the test suite.

---

### B023-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/changeset_view.ex`
**Function:** `translate_errors/1` (line 10)
**Finding:** The function is never called with a changeset that contains multiple errors on the same field, or errors on nested/embedded changesets. The single indirect test only posts entirely nil attributes against one schema. Edge cases such as: (a) a changeset with multiple validation errors on one field, (b) a changeset with association/embed errors, and (c) an empty changeset (no errors) are all untested.

---

### B023-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/error_helpers.ex`
**Function:** `translate_error/1` (line 20)
**Finding:** The function contains an explicit branch at line 38: `if count = opts[:count]` — the plural-form path (`Gettext.dngettext/6`) versus the singular path (`Gettext.dgettext/5`). Neither branch is tested directly. An error with a `:count` option (e.g., a `length` or `format` validation with a count constraint) would follow a different code path that is wholly unexercised.

---

### B023-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/error_helpers.ex`
**Function:** `error_tag/2` (line 11)
**Finding:** `error_tag/2` generates HTML `<span>` elements for form field errors. It is never tested. No test verifies: (a) that it returns an empty list when the field has no errors, (b) that it returns one `<span>` per error when multiple errors exist on the same field, or (c) that the generated HTML has the correct `class="help-block"` attribute.

---

### B023-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/error_view.ex`
**Function:** `template_not_found/2` (line 13)
**Finding:** The `template_not_found/2` callback is triggered for every HTTP error status that has no explicit render clause. No test verifies that it correctly returns `%{error: "Not Found"}` for `"404.json"`, `%{error: "Internal Server Error"}` for `"500.json"`, or any other status code. The fallback controller calls this path for 404 responses but no test asserts on the response body structure.

---

### B023-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/file_view.ex`
**Function:** `render("filesize.json", ...)` (line 13) and `render("file.json", ...)` (line 20)
**Finding:** Both clauses are called from production code (`FileController.get_size/2` and indirectly via `render_many`/`render_one`) but have zero test coverage. The `"filesize.json"` clause omits the `fobs` field that `"file.json"` includes — no test verifies this intentional difference or that both serialise all expected fields correctly.

---

### B023-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/file_view.ex`
**Function:** `render("index.json", ...)` (line 5), `render("show.json", ...)` (line 9)
**Finding:** The `"index.json"` and `"show.json"` clauses use `render_many/3` and `render_one/3` respectively, delegating to `"file.json"`. No test verifies that the `%{data: [...]}` wrapper is present, that an empty list is correctly serialised for an empty index, or that `render_one` returns `%{data: null}` (not a list) for a show response.

---

### B023-11
**Severity:** LOW
**File:** `lib/api_server_web/views/changeset_view.ex`
**Function:** `render("error.json", ...)` (line 14)
**Finding:** The rendered JSON key is `"errors"` (plural). No test verifies that the key is exactly `"errors"` and not `"error"` (singular). A typo or regression in the key name would not be caught by the existing assertion (`json_response(conn, 422)["errors"] != %{}` would merely return `nil != %{}` which is true and would not fail the test).

---

### B023-12
**Severity:** LOW
**File:** `lib/api_server_web/views/file_view.ex`
**Function:** `render("file.json", ...)` (line 20)
**Finding:** The `fobs` field is included in `"file.json"` output but omitted from `"filesize.json"`. There is no test to document or enforce this contract. If a caller uses `"filesize.json"` expecting `fobs` to be present, the omission would not be caught.

---

### B023-13
**Severity:** INFO
**File:** `lib/api_server_web/views/error_view.ex`
**Finding:** Lines 5–8 contain a commented-out `render("500.html", _assigns)` clause that would return a plain string instead of a map. Its absence means `template_not_found/2` handles 500 responses, returning a JSON map. The commented code is dead and creates no coverage gap, but its presence may cause confusion about the intended 500 response format.

---

### B023-14
**Severity:** INFO
**File:** `lib/api_server_web/views/file_view.ex`
**Finding:** `FileController` (`lib/api_server_web/controllers/file_controller.ex`) contains `IO.puts` debug calls on lines 16 and 46 that will write to stdout in production. These are not a test-coverage gap in `FileView` itself, but they indicate the file handling code path has never been cleaned up, which is consistent with the complete absence of tests for `FileView`.

---

## Summary Table

| ID      | Severity | File                   | Description |
|---------|----------|------------------------|-------------|
| B023-1  | HIGH     | changeset_view.ex      | No test file; no direct assertions on rendered changeset errors |
| B023-2  | HIGH     | error_helpers.ex       | No test file; both public functions completely untested |
| B023-3  | HIGH     | error_view.ex          | No test file; `template_not_found/2` untested |
| B023-4  | HIGH     | file_view.ex           | No test file; all four render clauses untested |
| B023-5  | MEDIUM   | changeset_view.ex      | `translate_errors/1` not tested with multiple errors, nested changesets, or empty changeset |
| B023-6  | MEDIUM   | error_helpers.ex       | `translate_error/1` plural-form branch (`opts[:count]` path) untested |
| B023-7  | MEDIUM   | error_helpers.ex       | `error_tag/2` never exercised by any test |
| B023-8  | MEDIUM   | error_view.ex          | `template_not_found/2` response body structure never asserted |
| B023-9  | MEDIUM   | file_view.ex           | `"filesize.json"` and `"file.json"` render clauses untested |
| B023-10 | MEDIUM   | file_view.ex           | `"index.json"` and `"show.json"` render clauses, including `render_many`/`render_one` wrapping, untested |
| B023-11 | LOW      | changeset_view.ex      | `"errors"` key name not verified; regression would silently pass existing test |
| B023-12 | LOW      | file_view.ex           | `fobs` field presence contract between `"file.json"` and `"filesize.json"` not enforced by tests |
| B023-13 | INFO     | error_view.ex          | Commented-out `render("500.html", ...)` clause creates dead-code confusion |
| B023-14 | INFO     | file_view.ex (context) | `IO.puts` debug statements in `FileController` indicate the associated view path has never been cleaned up |

<!-- B024.md -->
# Audit Report B024
**Audit run:** 2026-02-27-01
**Agent:** B024 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/views/geofence_view.ex`
2. `lib/api_server_web/views/layout_view.ex`
3. `lib/api_server_web/views/page_view.ex`
4. `lib/api_server_web/views/vx_abl_record_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/geofence_view.ex`

**Module name:** `ApiServerWeb.GeofenceView`

**Uses/aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.GeofenceView` (line 4)
- `alias ApiServerWeb.VXThingView` (line 5)
- `alias ApiServer.Vx` (line 6)
- `alias ApiServer.Vx.Geofence` (line 7)

**Functions defined:**

| Line | Name | Arity | Clause / Pattern |
|------|------|-------|-----------------|
| 9 | `render/2` | 2 | `"index.json"` with `%{geofences: geofences}` |
| 13 | `render/2` | 2 | `"geofence.json"` with `%{geofence: geofence}` |
| 22 | `render/2` | 2 | `"geofence_events.json"` with `%{geofence_events: geofence_events, thing: thing}` |

**Types / constants defined:** None.

**Delegations / notable calls:**
- `Geofence.geojson_db_string_to_map/1` called in `render("geofence.json", ...)` (line 18)
- `render_one/3` called with `VXThingView, "rhm_thing.json"` in `render("geofence_events.json", ...)` (line 26)

---

### File 2: `lib/api_server_web/views/layout_view.ex`

**Module name:** `ApiServerWeb.LayoutView`

**Uses/aliases:**
- `use ApiServerWeb, :view` (line 2)

**Functions defined:** None explicitly. All functions are injected by `use ApiServerWeb, :view` at compile time.

**Types / constants defined:** None.

---

### File 3: `lib/api_server_web/views/page_view.ex`

**Module name:** `ApiServerWeb.PageView`

**Uses/aliases:**
- `use ApiServerWeb, :view` (line 2)

**Functions defined:** None explicitly. All functions are injected by `use ApiServerWeb, :view` at compile time.

**Types / constants defined:** None.

---

### File 4: `lib/api_server_web/views/vx_abl_record_view.ex`

**Module name:** `ApiServerWeb.VXAblRecordView`

**Uses/aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXAblRecordView` (line 4)
- `alias ApiServer.Vx` (line 5)

**Functions defined:**

| Line | Name | Arity | Clause / Pattern |
|------|------|-------|-----------------|
| 8 | `render/2` | 2 | `"index.json"` with `%{vxablrecords: vxablrecords}` |
| 12 | `render/2` | 2 | `"show.json"` with `%{vx_abl_record: vx_abl_record}` |
| 16 | `render/2` | 2 | `"vx_abl_record.json"` with `%{vx_abl_record: vx_abl_record}` |
| 22 | `render/2` | 2 | `"services.json"` with `%{records: records, customer: customer}` |
| 28 | `clean_xml_value/1` | 1 | general; returns `nil` when value is `%{}`, else returns value |
| 37 | `clean_xml_number_value/1` | 1 | general; returns `0` when value is `%{}`, else returns value |
| 46 | `render/2` | 2 | `"service.json"` with `%{vx_abl_record: {record, customer}}` |

**Types / constants defined:** None.

**Notable logic in `render("service.json", ...)`:**
- Branches on `is_integer(record.hardwareid)` to resolve vehicle name and fleets via `Vx.get_vx_thing_with_hardware_id!/2` (line 49).
- Secondary nil-check on `thing` result (line 50).
- Branches on `record.user != nil` to compose user name from struct fields vs. fallback `record.abluser` (line 60-65).

---

## Test File Analysis

### `test/api_server_web/views/layout_view_test.exs`

Full content:
```elixir
defmodule ApiServerWeb.LayoutViewTest do
  use ApiServerWeb.ConnCase, async: true
end
```

This file declares the test module but contains **zero test cases**. No `test/2` or `describe/2` blocks are present.

### `test/api_server_web/views/page_view_test.exs`

Full content:
```elixir
defmodule ApiServerWeb.PageViewTest do
  use ApiServerWeb.ConnCase, async: true
end
```

This file declares the test module but contains **zero test cases**. No `test/2` or `describe/2` blocks are present.

---

## Indirect Coverage Search Results

### `ApiServerWeb.GeofenceView`

- Grep for `GeofenceView`, `geofence_view`, `geofence_events`, `geofence.json`, `index.json` across all test files (`test/**/*.exs`): **no matches found**.

### `ApiServerWeb.VXAblRecordView`

- Grep for `VXAblRecordView`, `vx_abl_record_view`, `vx_abl_record`, `clean_xml_value`, `clean_xml_number_value`, `services.json`, `service.json`, `show.json` across all test files (`test/**/*.exs`): **no matches found**.

### Complete test file inventory

The repository contains exactly five test files:
1. `test/api_server_web/controllers/calamp_controller_test.exs`
2. `test/api_server_web/controllers/vx_restriction_controller_test.exs`
3. `test/api_server_web/views/layout_view_test.exs`
4. `test/api_server_web/views/page_view_test.exs`
5. `test/test_helper.exs`

No test file exercises `GeofenceView` or `VXAblRecordView` in any form.

---

## Findings

---

### B024-1

**Severity:** HIGH
**File:** `lib/api_server_web/views/geofence_view.ex`
**Finding:** No test file exists for `ApiServerWeb.GeofenceView` and no indirect coverage was found in any test file in the repository. The module is entirely untested.

**Evidence:** Grep for `GeofenceView`, all render template strings (`"index.json"`, `"geofence.json"`, `"geofence_events.json"`), and all related identifiers across `test/**/*.exs` returned zero matches. No dedicated test file exists under `test/api_server_web/views/`.

**Affected functions:**
- `render/2` — `"index.json"` (line 9)
- `render/2` — `"geofence.json"` (line 13)
- `render/2` — `"geofence_events.json"` (line 22)

---

### B024-2

**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXAblRecordView` and no indirect coverage was found in any test file in the repository. The module is entirely untested.

**Evidence:** Grep for `VXAblRecordView`, all render template strings, `clean_xml_value`, `clean_xml_number_value`, and related identifiers across `test/**/*.exs` returned zero matches. No dedicated test file exists under `test/api_server_web/views/`.

**Affected functions:**
- `render/2` — `"index.json"` (line 8)
- `render/2` — `"show.json"` (line 12)
- `render/2` — `"vx_abl_record.json"` (line 16)
- `render/2` — `"services.json"` (line 22)
- `render/2` — `"service.json"` (line 46)
- `clean_xml_value/1` (line 28)
- `clean_xml_number_value/1` (line 37)

---

### B024-3

**Severity:** HIGH
**File:** `lib/api_server_web/views/layout_view.ex`
**Finding:** The dedicated test file `test/api_server_web/views/layout_view_test.exs` exists but is completely empty — it declares the test module with `use ApiServerWeb.ConnCase, async: true` and contains zero test cases. The file provides no coverage whatsoever.

**Evidence:**
```elixir
defmodule ApiServerWeb.LayoutViewTest do
  use ApiServerWeb.ConnCase, async: true
end
```
No `test/2`, `describe/2`, or assertion of any kind is present.

**Note:** `ApiServerWeb.LayoutView` has no explicitly defined functions (the module body is `use ApiServerWeb, :view` only), so the injected macro-generated helpers from the view layer are also untested.

---

### B024-4

**Severity:** HIGH
**File:** `lib/api_server_web/views/page_view.ex`
**Finding:** The dedicated test file `test/api_server_web/views/page_view_test.exs` exists but is completely empty — it declares the test module with `use ApiServerWeb.ConnCase, async: true` and contains zero test cases. The file provides no coverage whatsoever.

**Evidence:**
```elixir
defmodule ApiServerWeb.PageViewTest do
  use ApiServerWeb.ConnCase, async: true
end
```
No `test/2`, `describe/2`, or assertion of any kind is present.

**Note:** `ApiServerWeb.PageView` has no explicitly defined functions (the module body is `use ApiServerWeb, :view` only), so the injected macro-generated helpers from the view layer are also untested.

---

### B024-5

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** `clean_xml_value/1` (line 28) has no tests for either branch: the `value == %{}` branch (returns `nil`) and the default branch (returns the value unchanged). This function is referenced as a utility but never exercised.

**Evidence:** No test file references `clean_xml_value` anywhere in the test suite. The function has two distinct cond branches.

---

### B024-6

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** `clean_xml_number_value/1` (line 37) has no tests for either branch: the `value == %{}` branch (returns `0`) and the default branch (returns the value unchanged). This function mirrors `clean_xml_value/1` with different sentinel output and is similarly untested.

**Evidence:** No test file references `clean_xml_number_value` anywhere in the test suite.

---

### B024-7

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** The `render("service.json", ...)` clause (line 46) contains multi-branch conditional logic with four distinct execution paths that are all untested:

1. `is_integer(record.hardwareid)` is true AND `Vx.get_vx_thing_with_hardware_id!` returns a non-nil thing — vehicle name and fleets are derived from the thing record.
2. `is_integer(record.hardwareid)` is true AND `Vx.get_vx_thing_with_hardware_id!` returns `nil` — vehicle name falls back to `record.hardwareid`, fleets become `[]`.
3. `is_integer(record.hardwareid)` is false — vehicle name is `record.hardwareid`, fleets are `[]`.
4. `record.user` is non-nil — user name is composed from `aacfname <> " " <> aacsurname`.
5. `record.user` is nil — user name falls back to `record.abluser`.

None of these paths are tested.

---

### B024-8

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/geofence_view.ex`
**Finding:** `render("geofence_events.json", ...)` (line 22) delegates to `VXThingView.render("rhm_thing.json", ...)` via `render_one/3`. The interaction between `GeofenceView` and `VXThingView` is untested, meaning any contract mismatch between the two views would not be detected.

**Evidence:** No test exercises `"geofence_events.json"` rendering or the cross-view delegation.

---

### B024-9

**Severity:** MEDIUM
**File:** `lib/api_server_web/views/geofence_view.ex`
**Finding:** `render("geofence.json", ...)` (line 13) calls `Geofence.geojson_db_string_to_map/1` (line 18). There are no tests verifying the rendered output when this function returns a valid map, when the geofence has no geometry, or when the geojson field contains malformed data.

**Evidence:** No test exercises `"geofence.json"` rendering. The return value of `geojson_db_string_to_map/1` is passed directly into the response map without validation or error handling.

---

### B024-10

**Severity:** LOW
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** `render("services.json", ...)` (line 22) is untested for the edge case of an empty `records` list. An empty list would produce an empty JSON array; a non-empty list with mixed `hardwareid` types would exercise all branches of `render("service.json", ...)`. Neither case is covered.

---

### B024-11

**Severity:** LOW
**File:** `lib/api_server_web/views/geofence_view.ex`
**Finding:** `render("index.json", ...)` (line 9) is untested for the edge case of an empty `geofences` list. `render_many/3` on an empty list returns `[]`; this is the minimal valid response and is not verified.

---

### B024-12

**Severity:** LOW
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`
**Finding:** `render("index.json", ...)` (line 8) wraps its output in a `%{data: ...}` envelope, while `render("services.json", ...)` (line 22) returns a bare list with no envelope. This inconsistency in response shape is untested and could cause client-side contract bugs that would go undetected.

---

### B024-13

**Severity:** INFO
**File:** `lib/api_server_web/views/layout_view.ex`
**Finding:** The module contains no explicitly defined functions; it is a standard Phoenix-generated scaffold. The empty test file is consistent with Phoenix generator output and represents a known generator artifact. However, if the application renders HTML layouts, integration-level rendering smoke tests would be appropriate.

---

### B024-14

**Severity:** INFO
**File:** `lib/api_server_web/views/page_view.ex`
**Finding:** The module contains no explicitly defined functions; it is a standard Phoenix-generated scaffold. The empty test file is consistent with Phoenix generator output. If the application serves any HTML pages, at least a basic render test would confirm the view resolves correctly.

---

## Summary Table

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B024-1 | HIGH | geofence_view.ex | No test file and no indirect coverage; module entirely untested |
| B024-2 | HIGH | vx_abl_record_view.ex | No test file and no indirect coverage; module entirely untested |
| B024-3 | HIGH | layout_view.ex | Dedicated test file is empty (zero test cases) |
| B024-4 | HIGH | page_view.ex | Dedicated test file is empty (zero test cases) |
| B024-5 | MEDIUM | vx_abl_record_view.ex | `clean_xml_value/1` both branches untested |
| B024-6 | MEDIUM | vx_abl_record_view.ex | `clean_xml_number_value/1` both branches untested |
| B024-7 | MEDIUM | vx_abl_record_view.ex | `render("service.json", ...)` multi-branch logic entirely untested |
| B024-8 | MEDIUM | geofence_view.ex | Cross-view delegation to `VXThingView` in `render("geofence_events.json", ...)` untested |
| B024-9 | MEDIUM | geofence_view.ex | `render("geofence.json", ...)` with `geojson_db_string_to_map/1` call untested |
| B024-10 | LOW | vx_abl_record_view.ex | `render("services.json", ...)` empty list edge case untested |
| B024-11 | LOW | geofence_view.ex | `render("index.json", ...)` empty list edge case untested |
| B024-12 | LOW | vx_abl_record_view.ex | Inconsistent response envelope shape across render clauses untested |
| B024-13 | INFO | layout_view.ex | Scaffold-only module; empty test is a generator artifact |
| B024-14 | INFO | page_view.ex | Scaffold-only module; empty test is a generator artifact |

<!-- B025.md -->
# Audit Report B025
**Audit run:** 2026-02-27-01
**Agent:** B025 (Pass 2)
**Assigned source files:**
- `lib/api_server_web/views/vx_access_fob_view.ex`
- `lib/api_server_web/views/vx_customer_view.ex`
- `lib/api_server_web/views/vx_fleet_association_view.ex`
- `lib/api_server_web/views/vx_fleet_view.ex`

---

## Test Coverage Search Summary

The entire `test/` tree was searched for each module name, each render template string, and each domain keyword. The full test suite consists of exactly five files:

| File | Contains coverage of assigned modules? |
|---|---|
| `test/api_server_web/controllers/calamp_controller_test.exs` | No (empty module body) |
| `test/api_server_web/controllers/vx_restriction_controller_test.exs` | No |
| `test/api_server_web/views/layout_view_test.exs` | No (empty module body) |
| `test/api_server_web/views/page_view_test.exs` | No (empty module body) |
| `test/test_helper.exs` | No |

No direct or indirect test coverage exists for any of the four assigned source files.

---

## Reading Evidence

### 1. `ApiServerWeb.VXAccessFobView`
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`

**Module-level macros/imports:**
- Line 2: `use ApiServerWeb, :view`
- Line 3: `alias ApiServerWeb.VXAccessFobView`

**Public functions defined:**

| Line | Signature |
|---|---|
| 5 | `render("index.json", %{vxaccessfobs: vxaccessfobs})` |
| 9 | `render("show.json", %{vx_access_fob: vx_access_fob})` |
| 13 | `render("vx_access_fob.json", %{vx_access_fob: vx_access_fob})` |

**Types / constants:** None.

**Behaviour notes:**
- `"index.json"` wraps the result list in a `%{data: ...}` envelope.
- `"show.json"` wraps the single record in a `%{data: ...}` envelope.
- `"vx_access_fob.json"` projects two fields: `id` and `fob_code`.
- No nil-guard or association-loaded guard on the leaf render clause.

---

### 2. `ApiServerWeb.VXCustomerView`
**File:** `lib/api_server_web/views/vx_customer_view.ex`

**Module-level macros/imports:**
- Line 2: `use ApiServerWeb, :view`
- Line 3: `alias ApiServerWeb.VXCustomerView`

**Public functions defined:**

| Line | Signature |
|---|---|
| 5 | `render("index.json", %{vx_customers: vx_customers})` |
| 9 | `render("show.json", %{vx_customer: vx_customer})` |
| 13 | `render("vx_customer.json", %{vx_customer: nil})` |
| 14 | `render("vx_customer.json", %{vx_customer: vx_customer})` |

**Types / constants:** None.

**Behaviour notes:**
- `"index.json"` does NOT wrap the result in a `%{data: ...}` envelope (inconsistent with other views in this set).
- `"show.json"` does NOT wrap the result in a `%{data: ...}` envelope (same inconsistency).
- `"vx_customer.json"` has two clauses: an explicit nil-guard returning `%{}` (line 13), and a full clause that checks `Ecto.assoc_loaded?/1` at runtime, returning `%{}` when the association is not loaded.
- Commented-out fields: `aaaudfcustcode` and `aaacolour` (lines 30–31).

---

### 3. `ApiServerWeb.VXFleetAssociationView`
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`

**Module-level macros/imports:**
- Line 2: `use ApiServerWeb, :view`
- Line 3: `alias ApiServerWeb.VXFleetAssociationView`

**Public functions defined:**

| Line | Signature |
|---|---|
| 5 | `render("index.json", %{vxfleetassociationss: vxfleetassociationss})` |
| 9 | `render("show.json", %{vx_fleet_association: vx_fleet_association})` |
| 13 | `render("vx_fleet_association.json", %{vx_fleet_association: vx_fleet_association})` |

**Types / constants:** None.

**Behaviour notes:**
- The `"index.json"` key is `[REDACTED-AWS-SMTP-PASSWORD]` (double `s`) — a likely typo that would cause a pattern-match failure if the controller uses a differently-spelled key.
- `"index.json"` and `"show.json"` both wrap output in `%{data: ...}`.
- Leaf render projects two fields: `id` and `aafcustcode`.
- No nil-guard on the leaf render clause.

---

### 4. `ApiServerWeb.VXFleetView`
**File:** `lib/api_server_web/views/vx_fleet_view.ex`

**Module-level macros/imports:**
- Line 2: `use ApiServerWeb, :view`
- Line 3: `alias ApiServerWeb.VXFleetView`

**Public functions defined:**

| Line | Signature |
|---|---|
| 5 | `render("index.json", %{vxfleets: vxfleets})` |
| 9 | `render("show.json", %{vx_fleet: vx_fleet})` |
| 13 | `render("vx_fleet.json", %{vx_fleet: vx_fleet})` |
| 22 | `render("rhm_fleets.json", %{vx_fleets: vx_fleets})` |
| 25 | `render("rhm_fleet.json", %{vx_fleet: vx_fleet})` |
| 34 | `render("rhm_fleets_with_equip.json", %{vx_fleets: vx_fleets})` |
| 37 | `render("rhm_fleet_with_equip.json", %{vx_fleet: vx_fleet})` |
| 47 | `render("rhm_fleet_equipment.json", %{results: results})` |
| 51 | `render("assoc.json", %{vx_fleet: {fleet_id, equipment_id, equipment_name}})` |

**Types / constants:** None.

**Behaviour notes:**
- `"index.json"` / `"show.json"` wrap in `%{data: ...}`; the RHM templates do not.
- `"rhm_fleet_with_equip.json"` accesses `vx_fleet.equipment`, which is presumably a preloaded association; no guard against it being unloaded.
- `"assoc.json"` destructures a 3-tuple from the `results` list — an unusual shape that is easy to break silently.
- Nine distinct render clauses versus the simpler two-or-three clauses in the other views.

---

## Findings

### B025-1
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXAccessFobView`, and no indirect coverage was found anywhere in the test suite. All three render clauses (`"index.json"`, `"show.json"`, `"vx_access_fob.json"`) are completely untested.

---

### B025-2
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_customer_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXCustomerView`, and no indirect coverage was found anywhere in the test suite. All four render clauses are completely untested.

---

### B025-3
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXFleetAssociationView`, and no indirect coverage was found anywhere in the test suite. All three render clauses are completely untested.

---

### B025-4
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Finding:** No test file exists for `ApiServerWeb.VXFleetView`, and no indirect coverage was found anywhere in the test suite. All nine render clauses are completely untested.

---

### B025-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_customer_view.ex`
**Function:** `render("vx_customer.json", ...)` — lines 13–34
**Finding:** The `Ecto.assoc_loaded?/1` branch (returns `%{}` when the association is not loaded) is untested. This is a non-trivial runtime code path; an unloaded association silently producing an empty map `%{}` could mask data bugs in callers that forget to preload.

---

### B025-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Function:** `render("rhm_fleet_with_equip.json", ...)` — line 37
**Finding:** `vx_fleet.equipment` is accessed without any guard for an unloaded or nil association. No test exercises this clause at all, so neither the happy path nor the failure path (unloaded association raising `Ecto.Association.NotLoaded`) is covered.

---

### B025-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Function:** `render("assoc.json", %{vx_fleet: {fleet_id, equipment_id, equipment_name}})` — line 51
**Finding:** This clause destructures a raw 3-tuple bound under the key `:vx_fleet`, which is an unconventional shape for a Phoenix view. No test exercises this, so a shape mismatch (e.g., a 2-tuple or a struct) would raise a `FunctionClauseError` at runtime with no test-time warning.

---

### B025-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`
**Function:** `render("index.json", ...)` — line 5
**Finding:** The `index.json` assign key is spelled `[REDACTED-AWS-SMTP-PASSWORD]` (double trailing `s`). This is almost certainly a typo. Because this clause is completely untested, the mismatch between the key name expected by the view and the key name assigned by the controller will not be caught until runtime, at which point it raises a `FunctionClauseError`.

---

### B025-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_customer_view.ex`
**Finding:** `render("index.json", ...)` and `render("show.json", ...)` do not wrap their output in a `%{data: ...}` envelope, while all other views in this set (`VXAccessFobView`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXFleetView`) do. This envelope inconsistency is untested, so any API client relying on a consistent shape will receive different JSON structures from different endpoints without any test-time indication of the divergence.

---

### B025-10
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`
**Function:** `render("vx_access_fob.json", ...)` — line 13
**Finding:** No nil-guard clause exists for `vx_access_fob`. If `render_one/3` is called with a nil struct (e.g., a not-found resource passed through incorrectly), the clause will raise a `KeyError` or `FunctionClauseError`. This edge case is untested.

---

### B025-11
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`
**Function:** `render("vx_fleet_association.json", ...)` — line 13
**Finding:** No nil-guard clause exists for `vx_fleet_association`. Same nil-propagation risk as B025-10. Untested.

---

### B025-12
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Function:** `render("vx_fleet.json", ...)` — line 13
**Finding:** No nil-guard clause exists for `vx_fleet` in the standard CRUD template. Untested.

---

### B025-13
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_fleet_view.ex`
**Finding:** The `render("rhm_fleets_with_equip.json", ...)` and `render("rhm_fleet_with_equip.json", ...)` pair (lines 34–44) are not tested with an empty list. `render_many/3` on an empty list returns `[]`, but no test confirms that the caller handles an empty equipment list gracefully without a separate RHM-specific empty-state code path.

---

### B025-14
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_customer_view.ex`
**Lines:** 30–31
**Finding:** Two fields (`aaaudfcustcode`, `aaacolour`) are commented out. There are no tests to signal if and when these should be reinstated. Their presence in comments suggests they were intentionally omitted rather than removed, but without tests this cannot be verified.

---

## Summary Table

| ID | Severity | File | Description |
|---|---|---|---|
| B025-1 | HIGH | vx_access_fob_view.ex | No test coverage whatsoever |
| B025-2 | HIGH | vx_customer_view.ex | No test coverage whatsoever |
| B025-3 | HIGH | vx_fleet_association_view.ex | No test coverage whatsoever |
| B025-4 | HIGH | vx_fleet_view.ex | No test coverage whatsoever |
| B025-5 | MEDIUM | vx_customer_view.ex | `assoc_loaded?` false branch untested |
| B025-6 | MEDIUM | vx_fleet_view.ex | `rhm_fleet_with_equip.json` equipment association not guarded or tested |
| B025-7 | MEDIUM | vx_fleet_view.ex | `assoc.json` 3-tuple destructure untested and fragile |
| B025-8 | MEDIUM | vx_fleet_association_view.ex | Typo `[REDACTED-AWS-SMTP-PASSWORD]` in index assign key, undetected by tests |
| B025-9 | MEDIUM | vx_customer_view.ex | Missing `%{data: ...}` envelope inconsistency undetected by tests |
| B025-10 | LOW | vx_access_fob_view.ex | No nil-guard on leaf render clause |
| B025-11 | LOW | vx_fleet_association_view.ex | No nil-guard on leaf render clause |
| B025-12 | LOW | vx_fleet_view.ex | No nil-guard on standard `vx_fleet.json` clause |
| B025-13 | LOW | vx_fleet_view.ex | Empty-list path for `rhm_fleets_with_equip.json` untested |
| B025-14 | INFO | vx_customer_view.ex | Commented-out fields with no test intent |

<!-- B026.md -->
# Audit Report B026
**Audit run:** 2026-02-27-01
**Agent:** B026 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/views/vx_rental_view.ex`
2. `lib/api_server_web/views/vx_restriction_view.ex`
3. `lib/api_server_web/views/vx_thing_event_view.ex`
4. `lib/api_server_web/views/vx_thing_omega_view.ex`

---

## Reading Evidence

### 1. `lib/api_server_web/views/vx_rental_view.ex`

**Module:** `ApiServerWeb.VXRentalView`

**Aliases:**
- `ApiServer.Vx`
- `ApiServerWeb.VXRentalView`
- `ApiServerWeb.VXThingView`
- `ApiServerWeb.VXCustomerView`

**Functions defined:**

| Line | Visibility | Name / Clause | Notes |
|------|-----------|---------------|-------|
| 8    | public    | `render/2` — `"rhm_rentals.json"` | Renders a list of rentals for a customer; delegates to `"rhm_rental.json"` |
| 13   | public    | `render/2` — `"rhm_rental.json"` | Renders a single rental; calls `Vx.fetch_actual_usage/5`, `Vx.get_usage_since_service/2`, `Vx.get_avg_weekly_hours/2`; branches on `vx_rental.thing != nil` (lines 16–26) and `Map.has_key?(vx_rental, :overage)` (lines 29–34) |
| 64   | public    | `render/2` — `"midpac_report.json"` | Pass-through; returns `data` unchanged |
| 68   | public    | `render/2` — `"rental_anniversaries.json"` | Pass-through; returns `data` unchanged |
| 73   | public    | `convert_json_to_changeset/1` | Converts inbound rental JSON map to a changeset map; contains a `case` on `rental_json["period"]` matching `"28 Day Period"` → `"28DAY"` with a catch-all |

**Types / constants:** None explicitly defined.

**Notable code-quality observation:** Line 55 contains a typo in the JSON key name: `hours_to_serivce` (should be `hours_to_service`). This is a data contract bug, not a test coverage gap per se, but noted as evidence.

---

### 2. `lib/api_server_web/views/vx_restriction_view.ex`

**Module:** `ApiServerWeb.VXRestrictionView`

**Aliases:**
- `ApiServerWeb.VXRestrictionView`

**Functions defined:**

| Line | Visibility | Name / Clause | Notes |
|------|-----------|---------------|-------|
| 5    | public    | `render/2` — `"index.json"` | Wraps list in `%{data: ...}` using `render_many/3` |
| 9    | public    | `render/2` — `"show.json"` | Wraps single record in `%{data: ...}` using `render_one/3` |
| 13   | public    | `render/2` — `"vx_restriction.json"` | Maps all seven schema fields to JSON keys |

**Types / constants:** None.

---

### 3. `lib/api_server_web/views/vx_thing_event_view.ex`

**Module:** `ApiServerWeb.VXThingEventView`

**Aliases:**
- `ApiServerWeb.VXThingEventView`

**Functions defined:**

| Line | Visibility | Name / Clause | Notes |
|------|-----------|---------------|-------|
| 5    | public    | `render/2` — `"index.json"` | Wraps list in `%{data: ...}` using `render_many/3` |
| 9    | public    | `render/2` — `"show.json"` | Returns `render_one/3` result directly (no `%{data:}` wrapper — note asymmetry with index) |
| 13   | public    | `render/2` — `"vx_thing_event.json"` | Merges `thingevent_to_map/1` and `omega_to_map/1`; requires `vx_thing_event.thingeventomega` to be loaded (will crash if association is nil/not-loaded) |
| 18   | private   | `omega_to_map/1` | Maps 61 omega fields to a plain map |
| 83   | private   | `thingevent_to_map/1` | Maps 30 core thingevent fields to a plain map |

**Types / constants:** None.

**Notable code-quality observation:** `render("show.json", ...)` on line 9–11 returns the merged map directly without a `%{data: ...}` wrapper, while `render("index.json", ...)` wraps in `%{data: ...}`. This is an asymmetry that may be intentional or a bug; no tests confirm expected shape.

---

### 4. `lib/api_server_web/views/vx_thing_omega_view.ex`

**Module:** `ApiServerWeb.VXThingOmegaView`

**Aliases:**
- `ApiServerWeb.VXThingOmegaView`

**Functions defined:**

| Line | Visibility | Name / Clause | Notes |
|------|-----------|---------------|-------|
| 6    | public    | `render/2` — `"container_lift_report.json"` | Formats a list of `{date_tuple, day_name, lift_count}` tuples |
| 17   | public    | `render/2` — `"lift_summary_report_fleet.json"` | Formats a list of 8-element tuples (date, day_name, 6 counts) |
| 39   | public    | `render/2` — `"lift_summary_report.json"` | Formats a list of 9-element tuples (adds `thing_name`) |
| 63   | public    | `render/2` — `"lift_list_report.json"` | Formats lift list; calls `Timex.to_datetime/1` and `translate_lift_type_to_string/1` |
| 77   | public    | `render/2` — `"engine_utilization_report.json"` | Formats engine use data; computes `high_idle` via `max(0, engine_hours - idle_hours)` |
| 92   | public    | `render/2` — `"operation_summary_report.json"` | Computes three averages with division-by-zero guards; uses `Decimal` arithmetic |
| 139  | private   | `translate_lift_type_to_string/1` | `case` on integer lift_type: 0→"20", 1→"30", 2→"40", 4→"chain", 8→"bottom", _→"unknown" |

**Types / constants:** None.

---

## Test Coverage Investigation

### Test files searched

All `.exs` files under `test/` were enumerated. The full set is:

- `test/api_server_web/controllers/calamp_controller_test.exs`
- `test/api_server_web/controllers/vx_restriction_controller_test.exs`
- `test/api_server_web/views/layout_view_test.exs`
- `test/api_server_web/views/page_view_test.exs`
- `test/test_helper.exs`

### Grep results

- Searches for `VXRentalView`, `VxRentalView`, `vx_rental_view`: **0 matches** in any test file.
- Searches for `VXRestrictionView`, `VxRestrictionView`, `vx_restriction_view`: **0 matches** in any test file. (The controller test exercises the view indirectly via HTTP round-trips.)
- Searches for `VXThingEventView`, `VxThingEventView`, `vx_thing_event_view`: **0 matches** in any test file.
- Searches for `VXThingOmegaView`, `VxThingOmegaView`, `vx_thing_omega_view`: **0 matches** in any test file.
- Searches for render template name strings (`rhm_rental`, `midpac_report`, `rental_anniversaries`, `container_lift_report`, `lift_summary_report`, `lift_list_report`, `engine_utilization`, `operation_summary`): **0 matches**.
- Searches for `convert_json_to_changeset`, `thingevent`, `thing_event`: **0 matches**.

### Indirect coverage via `vx_restriction_controller_test.exs`

The controller test does exercise `VXRestrictionView` indirectly because the controller calls `render/2` and the test asserts on JSON responses. Specifically covered:

- `render("index.json", ...)` — covered by the "lists all vxaau_rest" test (line 22–24 of test).
- `render("show.json", ...)` — covered by the create-then-show and update-then-show tests (lines 29–40, 52–64).
- `render("vx_restriction.json", ...)` — covered by the show assertions that verify all seven fields.

However, this is controller-level integration coverage with no isolated unit tests for the view itself.

---

## Findings

---

### B026-1 — No test file exists for `VXRentalView`
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_rental_view.ex`
**Detail:** There is no direct test file and no indirect test coverage found anywhere in the test suite for `ApiServerWeb.VXRentalView`. All four public render clauses and `convert_json_to_changeset/1` are completely untested.

---

### B026-2 — No test file exists for `VXThingEventView`
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`
**Detail:** There is no direct test file and no indirect test coverage found anywhere in the test suite for `ApiServerWeb.VXThingEventView`. All three public render clauses and both private helper functions are completely untested.

---

### B026-3 — No test file exists for `VXThingOmegaView`
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`
**Detail:** There is no direct test file and no indirect test coverage found anywhere in the test suite for `ApiServerWeb.VXThingOmegaView`. All six public render clauses and the private `translate_lift_type_to_string/1` function are completely untested.

---

### B026-4 — No unit test file exists for `VXRestrictionView`
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_restriction_view.ex`
**Detail:** There is no direct unit test file for `ApiServerWeb.VXRestrictionView`. Indirect coverage exists only through `vx_restriction_controller_test.exs`, which exercises the view as a side-effect of HTTP requests. Isolated view-level assertions (e.g., testing the shape of the rendered map in isolation) are absent. The existing controller test does provide meaningful but incomplete coverage.

---

### B026-5 — `render("rhm_rental.json")` — `thing == nil` branch untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 16–26
**Detail:** The `cond` block at line 15 has two branches: one where `vx_rental.thing != nil` (performs Vx context calls) and a fallback `true` branch that returns `{0,0,0,0,0}`. No test exercises the `thing == nil` path to confirm defaults are rendered correctly.

---

### B026-6 — `render("rhm_rental.json")` — `overage` present branch untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 28–34
**Detail:** The `cond` block at line 28 branches on `Map.has_key?(vx_rental, :overage)`. No test exercises the path where `overage`, `period_start`, and `period_usage` are present on the rental struct, so the `DateTime.to_date/1` conversion on `period_start` is never verified.

---

### B026-7 — `convert_json_to_changeset/1` — "28 Day Period" branch untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 73–89
**Detail:** The `case` on `rental_json["period"]` at line 74 has a specific match for `"28 Day Period"` that converts it to `"28DAY"`. The catch-all branch is also untested. Neither branch has any test coverage; incorrect period conversion would silently produce wrong data.

---

### B026-8 — `convert_json_to_changeset/1` — nil/missing fields behaviour untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 73–89
**Detail:** The function calls `Vx.update_key_if_value/3` for every field. No test verifies that missing (nil) JSON keys are correctly omitted from the resulting changeset map, nor that partial inputs produce partial maps.

---

### B026-9 — `render("vx_thing_event.json")` crashes if `thingeventomega` association is nil or not loaded
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`, line 14
**Detail:** `omega_to_map(vx_thing_event.thingeventomega)` will raise a `KeyError` or `FunctionClauseError` if `thingeventomega` is `nil` or an `Ecto.Association.NotLoaded` struct. There is no guard, no test confirming behavior when the association is missing, and no documentation of the precondition.

---

### B026-10 — `render("operation_summary_report.json")` — division-by-zero guards only partially cover Decimal edge cases
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, lines 103–122
**Detail:** The function guards `operating_hours == 0` and `Decimal.to_integer(lift_count) == 0` before performing `Decimal.div/2`. However, no tests exist to confirm that:
1. The guards actually prevent `Decimal.div/2` from being called with a zero denominator.
2. The comparison `operating_hours == 0` works correctly when `operating_hours` is a `Decimal` value (Decimal zero does not `==` integer `0` in all contexts in Elixir).
3. The computed averages are rounded correctly.

---

### B026-11 — `translate_lift_type_to_string/1` — unmapped integer values silently return "unknown"
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, lines 139–154
**Detail:** Lift type integers 3, 5, 6, 7, and any value > 8 fall through to the `_` catch-all and return `"unknown"`. No test verifies that invalid/unexpected lift type codes are handled gracefully or that the mapped values (0→"20", 1→"30", 2→"40", 4→"chain", 8→"bottom") are correct. Note also that lift type integer `3` (which may represent a valid hardware state) silently becomes `"unknown"` with no log or error.

---

### B026-12 — `render("show.json")` in `VXThingEventView` lacks `%{data:}` wrapper — asymmetry with `index.json` untested
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`, lines 9–11
**Detail:** `render("show.json", ...)` returns the flat merged map directly, while `render("index.json", ...)` wraps results in `%{data: ...}`. This asymmetry differs from the Phoenix generator convention and from the pattern used in `VXRestrictionView`. No test exists to confirm which shape is expected by API clients; if this is unintentional it is an API contract bug.

---

### B026-13 — `render("rhm_rentals.json")` not tested with empty list
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_rental_view.ex`, lines 8–12
**Detail:** No test checks that rendering an empty `vx_rentals` list returns an empty JSON array rather than raising or returning nil.

---

### B026-14 — `render("lift_list_report.json")` — `Timex.to_datetime/1` not tested with boundary inputs
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, lines 63–75
**Detail:** The `Timex.to_datetime/1` call on line 65 converts a raw datetime tuple. No tests exist for edge inputs such as an invalid datetime tuple, a naive datetime, or a timezone-aware datetime that Timex may handle differently.

---

### B026-15 — `render("engine_utilization_report.json")` — `high_idle` computed as `max(0, engine_hours - idle_hours)` with no test for negative intermediate value
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, line 86
**Detail:** When `idle_hours > engine_hours` (e.g., due to data anomalies), `high_idle` is clamped to 0 by `max/2`. No test verifies this clamping behavior or that the subtraction works correctly when the fields are `Decimal` vs. numeric types.

---

### B026-16 — `VXRestrictionView` — no test for `render("index.json")` with non-empty list
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_restriction_view.ex`, lines 5–7
**Detail:** The controller test for `index` only asserts `"data" == []` (empty list). No test verifies the rendered shape of a non-empty list, meaning the `render_many/3` path through `"vx_restriction.json"` is never exercised from the index route with actual data.

---

### B026-17 — Typo in JSON key `hours_to_serivce` in `VXRentalView`
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_rental_view.ex`, line 55
**Detail:** The rendered JSON field is named `hours_to_serivce` (misspelling of "service"). Because no tests assert on this key name, the bug has gone undetected. Any API client relying on a correctly-spelled key would silently receive no value.

---

## Summary Table

| ID     | Severity | File                          | Description |
|--------|----------|-------------------------------|-------------|
| B026-1 | HIGH     | vx_rental_view.ex             | No test coverage at all for VXRentalView |
| B026-2 | HIGH     | vx_thing_event_view.ex        | No test coverage at all for VXThingEventView |
| B026-3 | HIGH     | vx_thing_omega_view.ex        | No test coverage at all for VXThingOmegaView |
| B026-4 | HIGH     | vx_restriction_view.ex        | No unit test file; only indirect controller coverage |
| B026-5 | MEDIUM   | vx_rental_view.ex             | `thing == nil` branch of rhm_rental.json untested |
| B026-6 | MEDIUM   | vx_rental_view.ex             | `overage` present branch untested |
| B026-7 | MEDIUM   | vx_rental_view.ex             | `convert_json_to_changeset/1` period branches untested |
| B026-8 | MEDIUM   | vx_rental_view.ex             | `convert_json_to_changeset/1` nil/missing fields untested |
| B026-9 | MEDIUM   | vx_thing_event_view.ex        | Crash if `thingeventomega` association not loaded |
| B026-10| MEDIUM   | vx_thing_omega_view.ex        | Division-by-zero guards and Decimal comparison untested |
| B026-11| MEDIUM   | vx_thing_omega_view.ex        | `translate_lift_type_to_string/1` values and unknown fallback untested |
| B026-12| MEDIUM   | vx_thing_event_view.ex        | `show.json` missing `%{data:}` wrapper — asymmetry untested |
| B026-13| LOW      | vx_rental_view.ex             | `rhm_rentals.json` not tested with empty list |
| B026-14| LOW      | vx_thing_omega_view.ex        | `lift_list_report.json` Timex conversion edge cases untested |
| B026-15| LOW      | vx_thing_omega_view.ex        | `high_idle` clamping to 0 not tested |
| B026-16| LOW      | vx_restriction_view.ex        | `index.json` only tested with empty list |
| B026-17| LOW      | vx_rental_view.ex             | Typo `hours_to_serivce` undetected due to absence of tests |

<!-- B027.md -->
# Audit Report B027
**Audit Run:** 2026-02-27-01
**Agent:** B027 (Pass 2)
**Repository:** api_server (Elixir/Phoenix)
**Date:** 2026-02-27

---

## Assigned Source Files

1. `lib/api_server_web/views/vx_thing_summary_view.ex`
2. `lib/api_server_web/views/vx_thing_view.ex`
3. `lib/api_server_web/views/vx_user_function_view.ex`
4. `lib/api_server_web/views/vx_user_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_thing_summary_view.ex`

**Module:** `ApiServerWeb.VXThingSummaryView`

**Uses / Aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXThingSummaryView` (line 3)

**Functions defined:**

| Line | Function Signature |
|------|--------------------|
| 5    | `render("index.json", %{vxthingsummaries: vxthingsummaries})` |
| 9    | `render("show.json", %{vx_thing_summary: vx_thing_summary})` |
| 13   | `render("vx_thing_summary.json", %{vx_thing_summary: vx_thing_summary})` |
| 57   | `render("rhm_thing_summary.json", %{vx_thing_summary: summary})` |

**Types / Constants:** None defined explicitly.

**Notes:**
- `render/2` with `"vx_thing_summary.json"` serializes 32 fields from the summary struct (lines 14–53).
- `render/2` with `"rhm_thing_summary.json"` produces a restructured nested map (lines 57–122), including nested sub-maps for `current_operator`, `gps`, `hour_meters` (with sub-inputs 0–4, odometer, omega, canbus).

---

### File 2: `lib/api_server_web/views/vx_thing_view.ex`

**Module:** `ApiServerWeb.VXThingView`

**Uses / Aliases:**
- `use ApiServerWeb, :view` (line 2)
- `use Timex` (line 3)
- `alias ApiServerWeb.VXThingView` (line 4)
- `alias ApiServerWeb.VXThingSummaryView` (line 5)

**Functions defined:**

| Line | Function Signature |
|------|--------------------|
| 8    | `render("index.json", %{vxthings: vxthings})` |
| 12   | `render("show.json", %{vx_thing: vx_thing})` |
| 16   | `render("fleet_map.json", %{vxthings: vxthings})` (collection) |
| 20   | `render("fleet_map.json", %{vx_thing: thing})` (single; pattern-matched tuple `{vx_thing, usage}`) |
| 105  | `render("hardware_with_checklists.json", %{vx_things: vx_things})` |
| 109  | `render("pm_data.json", %{vx_things: vx_things})` (collection) |
| 113  | `render("pm_data.json", %{vx_thing: vx_thing})` (single) |
| 147  | `render("movements.json", %{movements: movements})` |
| 150  | `render("movement.json", %{vx_thing: movement})` |
| 164  | `render("checklists.json", %{checklists: checklists})` |
| 168  | `render("vx_checklist.json", %{vx_thing: checklist})` |
| 176  | `render("vx_thing.json", %{vx_thing: vx_thing})` |
| 220  | `render("rhm_thing_usage.json", %{usage: usage})` |
| 224  | `render("rhm_thing_usage_manual.json", %{usage: usage, hardwareid: hardwareid, customer: customer})` |
| 228  | `render("usage_report.json", %{vx_thing: [...]})` (12-element destructured list) |
| 265  | `render("usage_report_many.json", %{vx_thing: [...], hardwareid: hardwareid, customer: customer})` (12-element list + extras) |
| 292  | `render("rhm_things_usage.json", %{usage_by_hardwareid: usages})` |
| 315  | `render("rhm_thing_events.json", %{events: events})` |
| 318  | `render("event_report.json", %{vx_thing: event})` |
| 351  | `render("rhm_thing.json", %{vx_things: vx_things})` (collection) |
| 354  | `render("rhm_thing.json", %{vx_thing: {vx_thing, usage_data}})` (single tuple) |
| 359  | `render("basic_thing.json", %{vx_thing: nil})` (nil guard clause) |
| 360  | `render("basic_thing.json", %{vx_thing: vx_thing})` |
| 396  | `render("sielift_wip_export.json", %{vx_thing: wip_reports})` |
| 434  | `render("pape_exports.json", %{vx_thing: vx_things})` |
| 437  | `render("pape_export.json", %{vx_thing: [aadserialno, aadhardwareid, abmgmtdatetime, engine_hours]})` |
| 449  | `render("rhm_things_names.json", %{vx_things: vx_things})` |
| 453  | `render("things_only.json", %{thing_records: thing_records})` |
| 487  | `info_to_map(thing_info)` (public helper) |
| 499  | `thing_to_map(vx_thing, usage_data)` (public helper) |

**Types / Constants:** None defined explicitly.

**Notes:**
- `render("fleet_map.json", %{vx_thing: thing})` (line 20): contains branching logic via `cond`; when `vx_thing.summary != nil` it performs arithmetic (`round/1`, division) that can raise `ArithmeticError` or `FunctionClauseError` if `usage.average_weekly_usage` is zero or nil (partially guarded).
- `render("pm_data.json", %{vx_thing: vx_thing})` (line 113): guards `nil` explicitly but performs `Float.round/1` and division without further nil-guard on numeric fields once the outer `cond` passes.
- `render("usage_report.json", ...)` and `render("usage_report_many.json", ...)` (lines 228, 265): `case category do` matches only integers 2–5 (input0–input4) with no `_` catch-all; an unexpected category value will raise `CaseClauseError`.
- `render("event_report.json", ...)` (line 318): `cond` on `event.eventtype` is well-structured but the inner `case event.eventcode` has a `_` wildcard.
- `thing_to_map/2` (line 499): contains a dead-code guard `if vx_thing == nil` (line 541) that is unreachable because pattern-matching earlier already dereferences `vx_thing` fields; the guard silently returns `%{}` and will never fire in practice, masking any actual `nil` passed directly.
- Large block of commented-out code retained in production source (lines 507–532).

---

### File 3: `lib/api_server_web/views/vx_user_function_view.ex`

**Module:** `ApiServerWeb.VXUserFunctionView`

**Uses / Aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXUserFunctionView` (line 3)

**Functions defined:**

| Line | Function Signature |
|------|--------------------|
| 5    | `render("index.json", %{vxaatuserfunctions: vxaatuserfunctions})` |
| 9    | `render("show.json", %{vx_user_function: vx_user_function})` |
| 13   | `render("vx_user_function.json", %{vx_user_function: vx_user_function})` |

**Types / Constants:** None defined explicitly.

---

### File 4: `lib/api_server_web/views/vx_user_view.ex`

**Module:** `ApiServerWeb.VXUserView`

**Uses / Aliases:**
- `use ApiServerWeb, :view` (line 2)
- `alias ApiServerWeb.VXUserView` (line 3)

**Functions defined:**

| Line | Function Signature |
|------|--------------------|
| 5    | `render("index.json", %{vxusers: vxusers})` |
| 9    | `render("show.json", %{vx_user: vx_user})` |
| 13   | `render("rhm_users.json", %{vx_users: users})` |
| 17   | `render("rhm_user.json", %{vx_user: user})` |
| 58   | `render("fleet_list.json", %{fleet_list: fleet_list})` |

**Types / Constants:** None defined explicitly.

**Notes:**
- `render("rhm_user.json", ...)` (line 17): contains three `cond` branches testing `Map.has_key?/2` for `:jwt`, `:message`, and `:function`; when `:function` is present but `user.function.aatfunction_id` is nil, a `nil` user_level is emitted silently with no validation.
- `render("show.json", ...)` (line 9) uses `render_one/3` (not `%{data: ...}` wrapper), which is inconsistent with `render("index.json", ...)` that wraps in `%{data: ...}`. This pattern asymmetry is not tested.

---

## Test Coverage Search Results

### Search methodology
Searched the entire test directory (`test/`) for:
- Module names: `VXThingSummaryView`, `VXThingView`, `VXUserFunctionView`, `VXUserView` (and snake_case variants)
- Template key strings: `vx_thing_summary`, `rhm_thing_summary`, `fleet_map`, `pm_data`, `usage_report`, `event_report`, `rhm_thing`, `basic_thing`, `sielift_wip`, `pape_export`, `rhm_things_names`, `things_only`, `rhm_user`, `fleet_list`

### Result
**Zero matches found** in any of the five test files present in the repository:
- `test/api_server_web/controllers/calamp_controller_test.exs` — stub module only (no test body)
- `test/api_server_web/controllers/vx_restriction_controller_test.exs` — tests `[REDACTED-AWS-SMTP-PASSWORD]` only
- `test/api_server_web/views/layout_view_test.exs` — tests `LayoutView` only
- `test/api_server_web/views/page_view_test.exs` — tests `PageView` only
- `test/test_helper.exs` — ExUnit configuration only

None of the four assigned view modules are exercised by any test, directly or indirectly.

---

## Findings

### B027-1
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`
**Title:** No test coverage whatsoever for `ApiServerWeb.VXThingSummaryView`

No test file exists for this module, and no indirect test coverage was found anywhere in the test suite. All four `render/2` clauses — `"index.json"`, `"show.json"`, `"vx_thing_summary.json"`, and `"rhm_thing_summary.json"` — are completely untested. The `"vx_thing_summary.json"` render maps 32 struct fields; field name errors or omissions would go undetected. The `"rhm_thing_summary.json"` render produces a deeply nested restructuring of the same data into a different shape; no test verifies that both renderings are consistent or correct.

---

### B027-2
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Title:** No test coverage whatsoever for `ApiServerWeb.VXThingView`

No test file exists for this module, and no indirect test coverage was found anywhere in the test suite. This is the largest view in the repository with 29 `render/2` clauses plus two public helper functions (`info_to_map/1`, `thing_to_map/2`). None are exercised by any test.

---

### B027-3
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_user_function_view.ex`
**Title:** No test coverage whatsoever for `ApiServerWeb.VXUserFunctionView`

No test file exists for this module, and no indirect test coverage was found anywhere in the test suite. All three `render/2` clauses are untested.

---

### B027-4
**Severity:** HIGH
**File:** `lib/api_server_web/views/vx_user_view.ex`
**Title:** No test coverage whatsoever for `ApiServerWeb.VXUserView`

No test file exists for this module, and no indirect test coverage was found anywhere in the test suite. All five `render/2` clauses, including the JWT-bearing `"rhm_user.json"` render used in authentication flows, are completely untested.

---

### B027-5
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `render("usage_report.json", ...)` (line 228), `render("usage_report_many.json", ...)` (line 265)
**Title:** Unhandled `category` values cause `CaseClauseError` at runtime

Both `usage_report` render functions destructure a 12-element list and pass `category` into a `case` expression that matches only integer values `2`, `3`, `4`, `5`, and `6`. There is no `_` wildcard/catch-all clause. Any `category` value outside that set (e.g., `nil`, `1`, `7`, or any non-integer) will raise an uncaught `CaseClauseError` at runtime, producing a 500 response to the caller. No test exercises the valid path, let alone the error path.

---

### B027-6
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `render("fleet_map.json", %{vx_thing: thing})` (line 20)
**Title:** Arithmetic paths when `vx_thing.summary` is nil are untested; silent fallback returns empty string

When `vx_thing.summary` is `nil`, the `cond` at line 22 falls through to `true -> ""` (line 101), returning an empty string `""` rather than a map. This causes `render_many/3` (called at line 17) to produce a list mixing maps and empty strings, which may cause JSON encoding errors or unexpected API responses downstream. No test exercises either the `summary != nil` path or the `nil` path.

---

### B027-7
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `render("basic_thing.json", %{vx_thing: vx_thing})` (line 360)
**Title:** Unloaded Ecto association path is untested

Line 361 explicitly checks `!Ecto.assoc_loaded?(vx_thing)` and returns `%{}` if the association is not loaded. This defensive path is entirely untested. Callers receiving an empty map when they expected a full thing object would have a silent data loss bug with no coverage to detect it.

---

### B027-8
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `thing_to_map/2` (line 499)
**Title:** Dead `nil` guard creates silent incorrect behavior; untested

The guard `if vx_thing == nil do %{} else ...` at line 541 is unreachable in practice because the function body already dereferences `vx_thing` fields (e.g., `vx_thing.aadsvchrs`, `vx_thing.fleets`, etc.) before reaching line 541. If `vx_thing` were actually `nil`, the function would crash at first field access, not silently return `%{}`. The guard provides false confidence. No test covers `thing_to_map/2` in any form (nil or non-nil).

---

### B027-9
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_user_view.ex`
**Function:** `render("rhm_user.json", %{vx_user: user})` (line 17)
**Title:** JWT presence/absence conditional paths are untested

The `"rhm_user.json"` render has three conditional branches testing `Map.has_key?/2`:
1. `:jwt` present vs. absent — determines whether a JWT token is included in the response.
2. `:message` present vs. absent — determines whether a login nag screen message is included.
3. `:function` present/non-nil vs. absent — determines the `user_level` (defaulting to `2`).

The path where `:jwt` is present (login response) is especially security-sensitive: an error in this branch would suppress the token from being returned to the client. None of the three branches are tested in any combination.

---

### B027-10
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_user_view.ex`
**Function:** `render("show.json", ...)` (line 9) vs. `render("index.json", ...)` (line 5)
**Title:** Asymmetric response envelope between `show` and `index` is untested

`render("index.json", ...)` wraps its result in `%{data: render_many(...)}`, but `render("show.json", ...)` calls `render_one/3` directly without a `%{data: ...}` wrapper. This is inconsistent with the standard Phoenix JSON API convention and with how `VXUserFunctionView` handles the same pair of clauses (lines 5–11 in `vx_user_function_view.ex`, which wraps `show.json` with `%{data: ...}`). No test exercises either clause to catch this discrepancy.

---

### B027-11
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Function:** `render("pm_data.json", %{vx_thing: vx_thing})` (line 113)
**Title:** `nil` vx_thing path returns `%{}` silently; numeric computation paths untested

When `vx_thing` is `nil` (line 114), the function returns an empty map `%{}` with no indication to the caller that the record was missing. When `vx_thing` is non-nil but `summary` or `summary.abmusagesinceservice` is `nil`, `tts` defaults to `0` and `lastmeterreading` defaults to `0`. The mixed-type `Float.round/1` calls (which require float input) could raise `FunctionClauseError` if the underlying DB fields return integers rather than floats. None of these paths are tested.

---

### B027-12
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`
**Function:** `render("vx_thing_summary.json", ...)` vs. `render("rhm_thing_summary.json", ...)`
**Title:** Two renderings of the same struct data are never cross-validated

`"vx_thing_summary.json"` (line 13) and `"rhm_thing_summary.json"` (line 57) render the same underlying struct but produce different shapes. There are no tests verifying that both renderings include all required fields and that no field is accidentally dropped or renamed in one but not the other. Given the 32 flat fields in the first render and the restructured nested form in the second, divergence is a realistic risk during future maintenance.

---

### B027-13
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_view.ex`
**Title:** Large block of commented-out production code in `thing_to_map/2` (lines 507–532)

Lines 507–532 contain a commented-out `predicted_service_date` computation with multiple `IO.puts` debug calls. The inline comment acknowledges the computation was intentionally deferred due to a known edge-case bug (predicted dates thousands of years in the past when usage is very low). There are no tests and no documentation of what the correct behaviour should be, increasing the risk that the feature will be reintroduced incorrectly in the future.

---

### B027-14
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_user_view.ex`
**Function:** `render("rhm_user.json", ...)` (line 32–37)
**Title:** `user_level` defaults to hardcoded integer `2` when `:function` key is absent; no edge-case coverage

When the `:function` key is absent from the user map, `user_level` silently defaults to `2` (line 36). The meaning of level `2` is not documented. Additionally, when `:function` is present but `user.function.aatfunction_id` is `nil`, `nil` propagates into the `:user_level` field of the response without any explicit guard. No tests cover the `nil` function_id sub-case or verify the default value semantics.

---

## Summary Table

| ID      | Severity | File                             | Description |
|---------|----------|----------------------------------|-------------|
| B027-1  | HIGH     | vx_thing_summary_view.ex         | No tests at all for the module |
| B027-2  | HIGH     | vx_thing_view.ex                 | No tests at all for the module (29 render clauses + 2 helpers) |
| B027-3  | HIGH     | vx_user_function_view.ex         | No tests at all for the module |
| B027-4  | HIGH     | vx_user_view.ex                  | No tests at all for the module |
| B027-5  | MEDIUM   | vx_thing_view.ex                 | `CaseClauseError` on invalid `category` in `usage_report` renderers |
| B027-6  | MEDIUM   | vx_thing_view.ex                 | `fleet_map` returns `""` (not a map) when summary is nil |
| B027-7  | MEDIUM   | vx_thing_view.ex                 | Unloaded Ecto assoc path in `basic_thing` silently returns `%{}` |
| B027-8  | MEDIUM   | vx_thing_view.ex                 | Dead nil guard in `thing_to_map/2` masks real crash path |
| B027-9  | MEDIUM   | vx_user_view.ex                  | JWT / message / function conditional branches in `rhm_user` untested |
| B027-10 | MEDIUM   | vx_user_view.ex                  | `show.json` missing `%{data:}` wrapper, inconsistent with `index.json` |
| B027-11 | MEDIUM   | vx_thing_view.ex                 | `pm_data` nil/numeric edge cases untested; possible `FunctionClauseError` |
| B027-12 | LOW      | vx_thing_summary_view.ex         | Two renderings of same struct never cross-validated |
| B027-13 | LOW      | vx_thing_view.ex                 | Dead/commented-out code with known bug left in production source |
| B027-14 | LOW      | vx_user_view.ex                  | `user_level` default and nil `aatfunction_id` path undocumented/untested |


---

## Pass 3 — Documentation

<!-- B001.md -->
# Pass 3: Documentation — B001
**Agent:** B001
**Files:**
- `lib/api_server.ex`
- `lib/api_server/application.ex`
- `lib/api_server/guardian.ex`
- `lib/api_server/repo.ex`

**Date:** 2026-02-27

---

## lib/api_server.ex

### Reading Evidence

**Module:** `ApiServer`

**Public functions:** None defined.

**Types / errors / constants defined:** None.

**Documentation present:**
- `@moduledoc` present (lines 2–8): boilerplate Phoenix-generated text describing contexts and business logic.

### Findings

No findings for this file. The module contains no public functions and its `@moduledoc` is present. The doc text is generic boilerplate but is not inaccurate — it makes no claims that contradict the (empty) implementation.

---

## lib/api_server/application.ex

### Reading Evidence

**Module:** `ApiServer.Application`

**Public functions:**

| Function | Line |
|---|---|
| `start/2` | 6 |
| `config_change/3` | 36 |

**Types / errors / constants defined:** None.

**Documentation present:**
- No `@moduledoc`.
- No `@doc` on `start/2`.
- No `@doc` on `config_change/3`.

### Findings

#### B001-1 — Missing @moduledoc in ApiServer.Application
**Severity:** LOW
**File:** `lib/api_server/application.ex`, line 1

`ApiServer.Application` has no `@moduledoc`. The module is the OTP application entry point and starts several non-trivial children (two Ecto repos, a Phoenix endpoint, a Quantum scheduler, a TCP server backed by a `Task.Supervisor`, and a `ConCache` geocode store). The absence of a module-level docstring means there is no description of the supervision tree or the TCP port configuration mechanism.

---

#### B001-2 — Missing @doc on start/2
**Severity:** INFO
**File:** `lib/api_server/application.ex`, line 6

The public callback `start/2` has no `@doc`. The function contains non-trivial behaviour: it reads `TCP_PORT` from the environment (defaulting to `4001`), builds a supervision tree with six children, and starts the supervisor with a `:one_for_one` strategy. None of this is documented.

---

#### B001-3 — Missing @doc on config_change/3
**Severity:** INFO
**File:** `lib/api_server/application.ex`, line 36

The public callback `config_change/3` has no `@doc`. The function delegates to `ApiServerWeb.Endpoint.config_change/2`, dropping the `_new` argument silently. Its purpose (hot-reload of Phoenix endpoint configuration) and the reason `_new` is unused are undocumented.

---

## lib/api_server/guardian.ex

### Reading Evidence

**Module:** `ApiServer.Guardian`

**Public functions:**

| Function | Arity | Line |
|---|---|---|
| `subject_for_token/2` (primary clause) | 2 | 6 |
| `subject_for_token/2` (fallback clause) | 2 | 14 |
| `resource_from_claims/1` (primary clause) | 1 | 18 |
| `resource_from_claims/1` (fallback clause) | 1 | 24 |

Both functions are multi-clause; the two clauses per function are treated as one public function each.

**Types / errors / constants defined:** None explicitly. Error atoms used: `:reason_for_error` (lines 8, 15, 25).

**Documentation present:**
- No `@moduledoc`.
- No `@doc` on `subject_for_token/2`.
- No `@doc` on `resource_from_claims/1`.

### Findings

#### B001-4 — Missing @moduledoc in ApiServer.Guardian
**Severity:** LOW
**File:** `lib/api_server/guardian.ex`, line 1

`ApiServer.Guardian` has no `@moduledoc`. This module implements the `Guardian` behaviour and is central to JWT authentication for the application. There is no description of the token subject strategy, what resource is resolved from claims, or which claim keys (`"sub"`, `"customer"`) are expected.

---

#### B001-5 — Missing @doc on subject_for_token/2
**Severity:** INFO
**File:** `lib/api_server/guardian.ex`, line 6

The public Guardian callback `subject_for_token/2` has no `@doc`. The function encodes a user's `aacid` field as the JWT subject. The nil-guard in the primary clause and the opaque error atom `:reason_for_error` (which does not describe the actual failure reason) are undocumented.

---

#### B001-6 — Missing @doc on resource_from_claims/1
**Severity:** INFO
**File:** `lib/api_server/guardian.ex`, line 18

The public Guardian callback `resource_from_claims/1` has no `@doc`. The function uses two custom claim keys (`"sub"` and `"customer"`) to reconstruct a user via `Vx.get_vx_user!/2`. The expected shape of the `claims` map and the fact that `get_vx_user!/2` may raise (bang function) are undocumented.

---

#### B001-7 — Inaccurate/misleading error atom :reason_for_error
**Severity:** MEDIUM
**File:** `lib/api_server/guardian.ex`, lines 8, 15, 25

All three error return sites use the literal atom `:reason_for_error` as the error value. This is placeholder text left over from Guardian's generated boilerplate. In production code this atom is returned to callers (and potentially to JWT error-handling pipelines) without conveying any meaningful reason for the failure. Callers that pattern-match or log on the error value receive no actionable information. While this is primarily a code-quality issue, it constitutes an inaccuracy between the implied semantics of an `{:error, reason}` tuple (where `reason` should describe the failure) and the actual atom used. It is recorded here as a documentation/accuracy finding because `@doc` for these functions, had it existed, would be expected to describe error conditions — making the placeholder impossible to document accurately without first correcting the atom.

---

## lib/api_server/repo.ex

### Reading Evidence

**Modules defined in file:** `ApiServer.Repo` (lines 1–11) and `ApiServer.FortyNineRepo` (lines 13–15).

**Public functions:**

| Module | Function | Arity | Line |
|---|---|---|---|
| `ApiServer.Repo` | `init/2` | 2 | 8 |
| `ApiServer.FortyNineRepo` | _(none defined)_ | — | — |

**Types / errors / constants defined:** None.

**Documentation present:**
- `ApiServer.Repo`: No `@moduledoc`. `@doc` present on `init/2` (lines 4–7).
- `ApiServer.FortyNineRepo`: No `@moduledoc`. No public functions defined beyond those inherited from `Ecto.Repo`.

### Findings

#### B001-8 — Missing @moduledoc in ApiServer.Repo
**Severity:** LOW
**File:** `lib/api_server/repo.ex`, line 1

`ApiServer.Repo` has no `@moduledoc`. A brief description of which database this repo connects to and how it loads its URL from the environment would be appropriate.

---

#### B001-9 — Missing @moduledoc in ApiServer.FortyNineRepo
**Severity:** LOW
**File:** `lib/api_server/repo.ex`, line 13

`ApiServer.FortyNineRepo` has no `@moduledoc`. This secondary Ecto repo defines no functions and provides no documentation about which database or OTP config key it corresponds to, making its purpose opaque to maintainers. The name "FortyNine" is unexplained anywhere in the file.

---

#### B001-10 — @doc on init/2 does not mention fallback behaviour when DATABASE_URL is unset
**Severity:** MEDIUM
**File:** `lib/api_server/repo.ex`, lines 4–9

The existing `@doc` for `init/2` states:

> "Dynamically loads the repository url from the DATABASE_URL environment variable."

The implementation is:

```elixir
def init(_, opts) do
  {:ok, Keyword.put(opts, :url, System.get_env("DATABASE_URL"))}
end
```

`System.get_env("DATABASE_URL")` returns `nil` when the variable is not set. `Keyword.put(opts, :url, nil)` will silently insert `url: nil` into the Ecto options, which will cause a runtime connection error rather than a clear configuration error at startup. The `@doc` does not mention this behaviour, does not document that the variable is required, and does not describe what happens when it is absent. The documented behaviour ("dynamically loads the url") is therefore incomplete in a way that could mislead operators into thinking unset `DATABASE_URL` is handled gracefully.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B001-1 | LOW | `lib/api_server/application.ex` | Missing `@moduledoc` in `ApiServer.Application` |
| B001-2 | INFO | `lib/api_server/application.ex`, line 6 | Missing `@doc` on `start/2` |
| B001-3 | INFO | `lib/api_server/application.ex`, line 36 | Missing `@doc` on `config_change/3` |
| B001-4 | LOW | `lib/api_server/guardian.ex` | Missing `@moduledoc` in `ApiServer.Guardian` |
| B001-5 | INFO | `lib/api_server/guardian.ex`, line 6 | Missing `@doc` on `subject_for_token/2` |
| B001-6 | INFO | `lib/api_server/guardian.ex`, line 18 | Missing `@doc` on `resource_from_claims/1` |
| B001-7 | MEDIUM | `lib/api_server/guardian.ex`, lines 8, 15, 25 | Placeholder error atom `:reason_for_error` makes error conditions undocumentable and misleading |
| B001-8 | LOW | `lib/api_server/repo.ex`, line 1 | Missing `@moduledoc` in `ApiServer.Repo` |
| B001-9 | LOW | `lib/api_server/repo.ex`, line 13 | Missing `@moduledoc` in `ApiServer.FortyNineRepo` |
| B001-10 | MEDIUM | `lib/api_server/repo.ex`, lines 4–9 | `@doc` on `init/2` omits nil/unset behaviour of `DATABASE_URL` |

<!-- B002.md -->
# Pass 3: Documentation — B002
**Agent:** B002
**Files:**
- `lib/api_server/fortynine/calamppositionevents.ex`
- `lib/api_server/fortynine/webservicepositionqueue.ex`

**Date:** 2026-02-27

---

## calamppositionevents.ex

### Reading Evidence

**Module name:** `ApiServer.FortyNine.CalampPositionEvents`

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 91 |

Note: `changeset/2` is decorated with `@doc false` at line 90, which intentionally suppresses documentation generation. It is still a public function by Elixir visibility rules.

**Schema fields (defined in `schema "calamppositionevents"` block, lines 7–88):**

`:datetimesaved`, `:gmtdatetime`, `:timeoffix`, `:hardwareid`, `:latitude`, `:longitude`, `:heading`, `:speed`, `:gpslock`, `:old`, `:ping`, `:motion`, `:speeding`, `:ignition`, `:ignitionstatus`, `:rssi`, `:gpsfixquality`, `:eventtype`, `:eventcode`, `:sensor1`, `:sensor2`, `:odometer`, `:distancesincelastevent`, `:wsusername`, `:wspassword`, `:altitude`, `:error`, `:ioflagstatus`, `:alarmid`, `:errormsg`, `:connectionname`, `:weight`, `:maxheight`, `:fuelusage`, `:engineonelapsed`, `:totalengineonelapsed`, `:input1elapsed`, `:input1status`, `:input1flag`, `:totalinput1elapsed`, `:accelerometerx`, `:accelerometery`, `:accelerometerz`, `:location`, `:city`, `:state`, `:postcode`, `:driverid`, `:mifaredriverid`, `:messageid`, `:originalmsg`, `:prestartchecklist`, `:motiontotalelapsed`, `:containerliftcount`, `:appmsgtext`, `:pulsecount`, `:totalfuel`, `:vehicleload`, `:rawvehicleload`, `:appmsgtext2`, `:batteryvoltage`, `:rpm`, `:engcoolanttemp`, `:engcoolantpressure`, `:engcoolantlevelpercent`, `:engoiltemp`, `:engoilpressure`, `:engcrankcasepressure`, `:engoillevelpercent`, `:engfuellevel1percent`, `:engfuellevel2percent`, `:engfuelrate`, `:engtotalfuelused`, `:engtotalfuelidle`, `:engtotalhoursidle`, `:engtotalhours`, `:totalvehiclehours`, `:totalptohours`, `:engaveragefueleco`, `:internalbatteryvoltage`

**Types, errors, constants:** None defined explicitly (no `@type`, `@typep`, `@opaque`, `@spec`, or module-level `@` constants).

**`validate_required` fields:** `[:hardwareid]` (line 94).

---

### Findings

#### B002-1 — Missing @moduledoc in CalampPositionEvents
**Severity:** LOW
**File:** `lib/api_server/fortynine/calamppositionevents.ex`, line 1

The module `ApiServer.FortyNine.CalampPositionEvents` has no `@moduledoc` attribute. There is no description of the module's purpose, its relationship to the `[REDACTED-AWS-SMTP-PASSWORD]` database table, the type of data it represents (CALAmp GPS position event records), or what the schema fields mean. A reader encountering this module has no way to determine from documentation alone whether `:wsusername` / `:wspassword` stored in the schema are credentials in transit or persisted to the database, which has implications beyond documentation quality.

---

#### B002-2 — No @spec on changeset/2 in CalampPositionEvents
**Severity:** INFO
**File:** `lib/api_server/fortynine/calamppositionevents.ex`, line 91

The public function `changeset/2` has no `@spec` typespec. Standard Elixir/Ecto convention for schema modules is to annotate this function as:

```elixir
@spec changeset(t(), map()) :: Ecto.Changeset.t()
```

Without a spec, static analysis tools (Dialyzer) cannot verify correct usage of the changeset at call sites.

---

## webservicepositionqueue.ex

### Reading Evidence

**Module name:** `ApiServer.FortyNine.WebServicePositionQueue`

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 37 |

Note: `changeset/2` is decorated with `@doc false` at line 36, which intentionally suppresses documentation generation. It is still a public function by Elixir visibility rules.

**Schema fields (defined in `schema "webservicepositionqueue"` block, lines 7–34):**

`:RECORDID`, `:datetimequeued`, `:utctimestamp`, `:HARDWAREID`, `:MOBILENAME`, `:driverID`, `:LATITUDE`, `:LONGITUDE`, `:HEADING`, `:SPEED`, `:GPSLOCK`, `:OLD`, `:PING`, `:MOTION`, `:SPEEDING`, `:IGNITION`, `:IGNITIONSTATUS`, `:RSSI`, `:SATS`, `:SENSOR1`, `:SENSOR2`, `:WSUSERNAME`, `:WSPASSWORD`, `:ERROR`, `:ERRORMSG`, `:CONNECTIONNAME`

**Types, errors, constants:** None defined explicitly (no `@type`, `@typep`, `@opaque`, `@spec`, or module-level `@` constants).

**`validate_required` fields:** `[:HARDWAREID]` (line 40).

---

### Findings

#### B002-3 — Missing @moduledoc in WebServicePositionQueue
**Severity:** LOW
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`, line 1

The module `ApiServer.FortyNine.WebServicePositionQueue` has no `@moduledoc` attribute. There is no description of the module's purpose, what the `[REDACTED-AWS-SMTP-PASSWORD]` table represents, or the lifecycle of records in the queue (i.e., what queues them, what drains them). The presence of `:WSUSERNAME` and `:WSPASSWORD` fields (all-caps, mirroring an external web service schema) with no documentation leaves it ambiguous whether these credentials are stored persistently or only during transit through the queue.

---

#### B002-4 — No @spec on changeset/2 in WebServicePositionQueue
**Severity:** INFO
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`, line 37

The public function `changeset/2` has no `@spec` typespec. Standard Elixir/Ecto convention for schema modules is to annotate this function as:

```elixir
@spec changeset(t(), map()) :: Ecto.Changeset.t()
```

Without a spec, static analysis tools (Dialyzer) cannot verify correct usage at call sites.

---

#### B002-5 — Inconsistent field naming convention across schema — no documentation explaining rationale
**Severity:** INFO
**File:** `lib/api_server/fortynine/webservicepositionqueue.ex`, lines 7–34

The `[REDACTED-AWS-SMTP-PASSWORD]` schema mixes naming conventions without any documented explanation:

- All-uppercase atoms: `:RECORDID`, `:HARDWAREID`, `:MOBILENAME`, `:LATITUDE`, `:LONGITUDE`, etc.
- Mixed-case atoms: `:driverID`
- Lowercase atoms: `:datetimequeued`, `:utctimestamp`

This inconsistency suggests the field names directly mirror an external database schema (likely a legacy system) with no adaptation to Elixir conventions, but this is not stated anywhere. The absence of `@moduledoc` means there is no explanation for why Elixir naming conventions are not followed. This makes the module harder to maintain and increases the risk of atom-related errors when constructing changesets programmatically. By contrast, the `[REDACTED-AWS-SMTP-PASSWORD]` module uses consistently lowercase field names throughout.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B002-1 | LOW | `calamppositionevents.ex` line 1 | Missing `@moduledoc` in `ApiServer.FortyNine.CalampPositionEvents` |
| B002-2 | INFO | `calamppositionevents.ex` line 91 | Missing `@spec` on `changeset/2` in `[REDACTED-AWS-SMTP-PASSWORD]` |
| B002-3 | LOW | `webservicepositionqueue.ex` line 1 | Missing `@moduledoc` in `ApiServer.FortyNine.WebServicePositionQueue` |
| B002-4 | INFO | `webservicepositionqueue.ex` line 37 | Missing `@spec` on `changeset/2` in `[REDACTED-AWS-SMTP-PASSWORD]` |
| B002-5 | INFO | `webservicepositionqueue.ex` lines 7–34 | Undocumented inconsistent field naming convention (mixed uppercase/lowercase atoms) |

<!-- B003.md -->
# Pass 3: Documentation — B003
**Agent:** B003
**Files:**
- `lib/api_server/operators/file.ex`
- `lib/api_server/operators/operators.ex`

**Date:** 2026-02-27

---

## lib/api_server/operators/file.ex

### Reading Evidence

**Module name:** `ApiServer.Operators.File`

**Schema fields (from `schema "files"` block):**
- `:custcode` — `:string`
- `:esn` — `:string`
- `timestamps()` (inserted_at, updated_at)

**Public functions and line numbers:**

| Function | Line |
|---|---|
| `changeset/2` | 14 |

**Types defined:** None explicitly (Ecto schema implies a struct type but no `@type` declarations are present).

**Constants defined:** None.

**Errors defined:** None.

**`@moduledoc` present:** No.

**`@doc` annotations:**
- `changeset/2` — annotated `@doc false` (line 13), which is an intentional suppression of documentation exposure; this is the standard Elixir/Phoenix convention for internal schema changesets.

---

### Findings

#### B003-1 — Missing `@moduledoc` in `ApiServer.Operators.File`
**Severity:** LOW
**File:** `lib/api_server/operators/file.ex`, line 1

The module `ApiServer.Operators.File` has no `@moduledoc` attribute. There is no description of the schema's purpose, the domain entity it represents, or which fields (`esn`, `custcode`) correspond to in the application domain. A minimal `@moduledoc` should describe the "files" schema, the meaning of its two fields, and the role of this struct within the Operators context.

---

## lib/api_server/operators/operators.ex

### Reading Evidence

**Module name:** `ApiServer.Operators`

**`@moduledoc` present:** Yes — line 2–4. Content: `"The Operators context."`.

**Public functions and line numbers:**

| Function | Line | `@doc` present |
|---|---|---|
| `list_files/0` | 19 | Yes (lines 10–18) |
| `get_file!/1` | 37 | Yes (lines 23–36) |
| `create_file/1` | 51 | Yes (lines 39–50) |
| `update_file/2` | 69 | Yes (lines 57–68) |
| `delete_file/1` | 87 | Yes (lines 75–86) |
| `change_file/1` | 100 | Yes (lines 91–99) |

**Types defined:** None.

**Constants defined:** None.

**Errors defined:** None.

**Aliases:** `ApiServer.Repo`, `ApiServer.Operators.File`

---

### Findings

#### B003-2 — Inaccurate `@doc` example in `change_file/1`: stale `source:` key
**Severity:** MEDIUM
**File:** `lib/api_server/operators/operators.ex`, lines 91–99

The `@doc` for `change_file/1` contains this example:

```elixir
iex> change_file(file)
%Ecto.Changeset{source: %File{}}
```

The `source:` field was removed from `%Ecto.Changeset{}` in Ecto 3.x (replaced by `data:`). As of Ecto 3.0 and later, the correct representation is `%Ecto.Changeset{data: %File{}}`. This project uses Phoenix/Ecto and the example was generated by the Phoenix context generator which has since corrected this in newer versions. Any developer copy-pasting or relying on the doctest output will see a mismatch at runtime and the iex example is factually incorrect against a current Ecto version.

#### B003-3 — Thin `@moduledoc` for `ApiServer.Operators` provides no domain context
**Severity:** LOW
**File:** `lib/api_server/operators/operators.ex`, lines 2–4

The `@moduledoc` reads only `"The Operators context."` — a placeholder generated by `mix phx.gen.context`. It provides no information about:
- What "operators" or "files" represent in the application domain.
- The relationship between `esn` and `custcode` fields and their business meaning.
- Which subsystems or controllers depend on this context.
- Any constraints or invariants enforced at this layer.

While a `@moduledoc` is present (so this does not trigger the missing-moduledoc finding), the content is effectively a non-documentation placeholder and should be flagged for improvement.

#### B003-4 — No `@spec` annotations on any public function in `ApiServer.Operators`
**Severity:** INFO
**File:** `lib/api_server/operators/operators.ex`, lines 19–102

None of the six public functions (`list_files/0`, `get_file!/1`, `create_file/1`, `update_file/2`, `delete_file/1`, `change_file/1`) carry `@spec` type specifications. While `@spec` is not strictly required by Elixir conventions, it is standard practice in production Elixir codebases and recommended by the Elixir style guide, particularly for context modules that form a public API boundary. The absence of specs means Dialyzer cannot statically verify callers, and readers cannot determine return types without reading the implementation.

#### B003-5 — No `@spec` annotation on `changeset/2` in `ApiServer.Operators.File`
**Severity:** INFO
**File:** `lib/api_server/operators/file.ex`, line 14

The `changeset/2` function, although marked `@doc false`, is called by the context module and is part of the module's internal contract. No `@spec` is present. A spec of the form `@spec changeset(%ApiServer.Operators.File{}, map()) :: Ecto.Changeset.t()` would allow Dialyzer to verify that callers pass correctly typed arguments.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B003-1 | LOW | `lib/api_server/operators/file.ex:1` | Missing `@moduledoc` in `ApiServer.Operators.File` |
| B003-2 | MEDIUM | `lib/api_server/operators/operators.ex:91` | Inaccurate `@doc` example in `change_file/1`: uses stale `source:` key removed in Ecto 3.x |
| B003-3 | LOW | `lib/api_server/operators/operators.ex:2` | `@moduledoc` is a boilerplate placeholder with no real domain context |
| B003-4 | INFO | `lib/api_server/operators/operators.ex:19` | No `@spec` on any of the six public functions in `ApiServer.Operators` |
| B003-5 | INFO | `lib/api_server/operators/file.ex:14` | No `@spec` on `changeset/2` in `ApiServer.Operators.File` |

<!-- B004.md -->
# Pass 3: Documentation — B004
**Agent:** B004
**Files:**
- `lib/api_server/tcp/tcp.ex`
- `lib/api_server/tcp/tcp_commands.ex`

**Date:** 2026-02-27

---

## lib/api_server/tcp/tcp.ex

### Reading Evidence

**Module name:** `ApiServer.TCP`

**@moduledoc:** Present (lines 2–4) — `"TCP Server for handling binary tracking devices"`

**Public functions:**

| Function | Line |
|---|---|
| `accept/1` | 23 |

**Private functions (not subject to @doc findings):**

| Function | Line |
|---|---|
| `loop_acceptor/1` | 32 |
| `serve/2` | 48 |
| `read_line/3` | 90 |
| `write_line/2` (binary text) | 135 |
| `write_line/2` (unknown_command) | 139 |
| `write_line/2` (closed) | 143 |
| `write_line/2` (generic error) | 147 |

**Types defined:** None

**Constants / module attributes defined:** None (aliases and imports only)

---

### Findings

#### B004-1 — `accept/1` is missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp.ex`, line 23

The sole public function `accept/1` has no `@doc` annotation. Its behaviour — opening a TCP listen socket on the given port, logging a startup message, and entering the acceptor loop — is entirely undocumented. There is also no `@spec` to indicate the expected type of `port` or the return value.

---

## lib/api_server/tcp/tcp_commands.ex

### Reading Evidence

**Module name:** `ApiServer.TCP.Commands`

**@moduledoc:** None present anywhere in the file.

**Public functions:**

| Function | Line |
|---|---|
| `parse_hello_message/1` | 9 |
| `parse_data_message/3` | 35 |
| `parse_debug_record/3` | 120 |
| `parse_data_record/3` | 158 |
| `parse_debug_field/1` | 1325 |
| `parse_gps_field/1` | 1331 |
| `parse_digital_field/1` | 1385 |
| `parse_analog_field/1` | 1454 |
| `parse_analog32_field/1` | 1470 |
| `parse_trip_field/1` | 1541 |
| `parse_total_field/1` | 1556 |
| `parse_driverid_field/1` | 1571 |
| `parse_commit_message/2` | 1673 |
| `parse_iridium/2` | 1679 |
| `parse/2` | 1903 |
| `run/1` (header/protocol declaration) | 1959 |
| `run/1` (`{:send, "hello", params}`) | 1961 |
| `run/1` (`{:send, "commit", params}`) | 1966 |
| `run/1` (`{:processed, "data", params}`) | 1976 |
| `run/1` (`{:close, "socket", params}`) | 1982 |

**Types defined:** None

**Constants / module attributes defined:** None

---

### Findings

#### B004-2 — Missing @moduledoc on `ApiServer.TCP.Commands`
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1

The module has no `@moduledoc` at all. A module of this scope — responsible for parsing a binary protocol spoken by GPS tracking hardware (hello handshake, data record upload, commit, iridium, close-socket messages) and dispatching responses — warrants at least a brief description of the protocol it implements, the device types it supports, and an overview of its parsing pipeline.

#### B004-3 — `parse_hello_message/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 9

No `@doc` annotation is present. The function decodes a binary hello payload (serial number, IMEI, SIM serial, product ID, hardware and firmware revision, flags), performs a device lookup by hardware ID, and returns `{:ok, {:send, "hello", params}}` on success or `{:error, {:error, "error", %{}}}` when no device is found. None of this is documented.

#### B004-4 — `parse_data_message/3` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 35

No `@doc` annotation is present. The function recursively decodes one or more binary data records from a device upload payload, delegating to `parse_debug_record/3` or `parse_data_record/3` depending on the log-reason byte, and always returns `{:ok, {:processed, "data", params}}`. Parameters and return contract are entirely undocumented.

#### B004-5 — `parse_debug_record/3` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 120

No `@doc` annotation is present. The function parses a binary debug record, reads a single field, dispatches to `parse_debug_field/1` for field ID 1, and always returns `[]`. Its purpose, inputs, and output are not documented.

#### B004-6 — `parse_data_record/3` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 158

No `@doc` annotation is present. This is the most complex function in the module (~1160 lines). It decodes a full binary data record into up to seven named fields (GPS, trip, total, driver ID, digital inputs, analog, analog32), maps log-reason bytes to event codes and types, handles vendor-specific serial-number allowlists (Trility, Yabby3), writes events to the primary database via `[REDACTED-AWS-SMTP-PASSWORD]`, conditionally writes to a secondary FortyNine database, and returns `[]`. None of this behaviour, nor any of its side effects, are documented.

#### B004-7 — `parse_debug_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1325

No `@doc` annotation is present. The function extracts a severity/module byte pair and an ASCII codepoint from a binary debug field. Its return value and input format are undocumented.

#### B004-8 — `parse_gps_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1331

No `@doc` annotation is present. The function decodes a 20-byte binary GPS field into a map with keys `Alt`, `FType`, `GpsStat`, `GpsUTC`, `Head`, `Lat`, `Long`, `PDOP`, `PosAcc`, `Spd`, and `SpdAcc`. The binary format, coordinate scaling (integer divided by 10,000,000), epoch offset (1 Jan 2013 = Unix 1,356,998,400), and returned map structure are entirely undocumented.

#### B004-9 — `parse_digital_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1385

No `@doc` annotation is present. The function decodes a binary digital-input/status field (4-byte inputs, 2-byte outputs, 2-byte status) and derives `input_zero`, `input_one`, `battery_good_status`, `battery_critical_status`, and a composite `battery_status` value. The field format and the battery-status encoding logic are undocumented.

#### B004-10 — `parse_analog_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1454

No `@doc` annotation is present. The function reads a raw analog field binary, hex-encodes it, and returns a map with `FType` (6), `Analog_Raw`, and `Analog_Hex`. The comment inside the function body (`# 15 analog fields, 3 bytes each …`) is the only documentation and is not accessible via ExDoc.

#### B004-11 — `parse_analog32_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1470

No `@doc` annotation is present. The function decodes a 32-bit analog field (field type 7) into up to three analog input values by hex-encoding the binary payload, chunking into 10-character groups, reversing byte pairs, and converting from hex. The returned map keys are `FType` (7), `Analog_Raw32`, `Analog_Hex32`, `Analog_Input1`, `Analog_Input2`, and `Analog_Input3`. This non-obvious parsing logic is entirely undocumented, and a `IO.puts/1` debug statement is left active at line 1492.

#### B004-12 — `parse_trip_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1541

No `@doc` annotation is present. The function decodes an 8-byte trip field (4-byte little-endian odometer and 4-byte little-endian run-hours duration) and returns a map with `Dist`, `FType` (26), and `Dur`. The field format and map structure are undocumented.

#### B004-13 — `parse_total_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1556

No `@doc` annotation is present. The function decodes an 8-byte total field (4-byte little-endian odometer and 4-byte little-endian run-hours) and returns a map with `Odo`, `FType` (27), and `RH`. The distinction between this function and `parse_trip_field/1` (different semantic keys despite identical binary layout) is not explained.

#### B004-14 — `parse_driverid_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1571

No `@doc` annotation is present. The function implements multi-branch driver ID parsing: iButton (type 2, 6-byte hex encoding), Wiegand 26-bit RFID (type 7 with 26-bit size, parity stripping to yield facility code + card code as a concatenated integer), and other RFID sizes (zero-padded hex). The returned map has `FType` (3), `driverIDType`, and `driverID`. This is the most behaviourally complex parsing function in the file and has no documentation whatsoever.

#### B004-15 — `parse_commit_message/2` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1673

No `@doc` annotation is present. The function ignores its `remainder` argument and returns `{:ok, {:send, "commit", params}}` unconditionally. The trivial but important no-op nature of the `remainder` parameter is not documented.

#### B004-16 — `parse_iridium/2` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1679

No `@doc` annotation is present. The function decodes a binary Iridium satellite message (3-subtype DirectIP framing: payload, header, location), derives event codes from the log-reason/input-mask/trip-status tuple, writes the event to the primary database, and also writes to both the FortyNine `[REDACTED-AWS-SMTP-PASSWORD]` and `[REDACTED-AWS-SMTP-PASSWORD]` tables with hardcoded `hardware_id` (462743), `custcode` ("TRILITY"), and credentials. None of this — including the hardcoded values — is documented.

#### B004-17 — `parse/2` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1903

No `@doc` annotation is present. `parse/2` is the main protocol dispatch entry point: it pattern-matches on message-type bytes (`<<0>>` = hello, `<<4>>` = data record upload with recursion for chained records, `<<5>>` = commit, `<<38>>` = close-socket). Its role as the top-level parser, the set of recognised message types, and its return tuples are entirely undocumented.

#### B004-18 — `run/1` (all clauses) missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, lines 1959–1986

None of the `run/1` clauses have a `@doc` annotation. The function translates internal command tuples to binary wire responses:
- `{:send, "hello", params}` → 13-byte hello-response frame
- `{:send, "commit", params}` → 6-byte commit-success frame
- `{:processed, "data", params}` → `<<0>>` (suppress reply)
- `{:close, "socket", params}` → `<<1>>` (signal socket close to caller)

The binary frame contents, their meaning on the wire, and the semantics of the `<<0>>`/`<<1>>` sentinel values are undocumented.

---

## Summary

| ID | Severity | Description |
|---|---|---|
| B004-1 | INFO | `ApiServer.TCP.accept/1` — missing @doc |
| B004-2 | LOW | `ApiServer.TCP.Commands` — missing @moduledoc |
| B004-3 | INFO | `parse_hello_message/1` — missing @doc |
| B004-4 | INFO | `parse_data_message/3` — missing @doc |
| B004-5 | INFO | `parse_debug_record/3` — missing @doc |
| B004-6 | INFO | `parse_data_record/3` — missing @doc (most complex function in module) |
| B004-7 | INFO | `parse_debug_field/1` — missing @doc |
| B004-8 | INFO | `parse_gps_field/1` — missing @doc |
| B004-9 | INFO | `parse_digital_field/1` — missing @doc |
| B004-10 | INFO | `parse_analog_field/1` — missing @doc |
| B004-11 | INFO | `parse_analog32_field/1` — missing @doc |
| B004-12 | INFO | `parse_trip_field/1` — missing @doc |
| B004-13 | INFO | `parse_total_field/1` — missing @doc |
| B004-14 | INFO | `parse_driverid_field/1` — missing @doc |
| B004-15 | INFO | `parse_commit_message/2` — missing @doc |
| B004-16 | INFO | `parse_iridium/2` — missing @doc |
| B004-17 | INFO | `parse/2` — missing @doc |
| B004-18 | INFO | `run/1` (all clauses) — missing @doc |

<!-- B005.md -->
# Pass 3: Documentation — B005
**Agent:** B005
**Files:**
- `lib/api_server/vx/device_database_lookup.ex`
- `lib/api_server/vx/email.ex`
- `lib/api_server/vx/equipment.ex`
- `lib/api_server/vx/equipment_assignment.ex`

**Date:** 2026-02-27

---

## device_database_lookup.ex

### Reading Evidence

**Module:** `ApiServer.Vx.DeviceDatabaseLookup`

**Schema:** `"DeviceDatabaseLookup"` (Ecto schema, primary key `ID`)

**Fields:**
- `:hardwareid` (string, source: `hardwareID`)
- `:customer` (string, source: `databaseName`)
- `:custcode` (string, source: `CustCode`)
- `:iccid` (string, source: `ICCID`)

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 13 |

**Types defined:** none
**Errors defined:** none
**Constants defined:** none
**`@moduledoc`:** absent
**`@doc` on `changeset/2`:** absent
**`@spec` on `changeset/2`:** absent

### Findings

#### B005-1 — Missing @moduledoc in DeviceDatabaseLookup
**Severity:** LOW
**File:** `lib/api_server/vx/device_database_lookup.ex`, line 1

The module `ApiServer.Vx.DeviceDatabaseLookup` has no `@moduledoc` attribute. There is no description of the table it maps to, the column-name divergence between Elixir field names and the underlying database column names (e.g. `:customer` sourced from `databaseName`), or the intended usage of the schema.

#### B005-2 — Missing @doc on changeset/2 in DeviceDatabaseLookup
**Severity:** INFO
**File:** `lib/api_server/vx/device_database_lookup.ex`, line 13

The public function `changeset/2` has no `@doc` attribute. There is no description of accepted attributes, validation rules applied, or expected return value.

---

## email.ex

### Reading Evidence

**Module:** `ApiServer.Email`

**Public functions:**

| Function | Line |
|---|---|
| `send_notification_email/3` | 4 |
| `send_test_email/3` | 14 |
| `send_enter_email/4` | 103 |
| `send_missing_serial_email/4` | 167 |
| `send_digital_matter_email/4` | 215 |
| `send_slow_email/4` | 262 |
| `send_exit_email/4` | 303 |

**Types defined:** none
**Errors defined:** none
**Constants defined:** none
**`@moduledoc`:** absent
**`@doc` on any function:** absent
**`@spec` on any function:** absent

### Findings

#### B005-3 — Missing @moduledoc in ApiServer.Email
**Severity:** LOW
**File:** `lib/api_server/vx/email.ex`, line 1

The module `ApiServer.Email` has no `@moduledoc` attribute. There is no description of the module's purpose (composing and sending geofence alert and operational notification emails via Bamboo), the email delivery mechanism, or the fixed recipient hardcoded into several functions.

#### B005-4 — Missing @doc on send_notification_email/3
**Severity:** INFO
**File:** `lib/api_server/vx/email.ex`, line 4

The public function `send_notification_email/3` has no `@doc`. There is no description of its parameters (`to`, `subject`, `message`), the fact that the `to` parameter is ignored and the message is always sent to a hardcoded recipient address (`graham.oconnell@trackingsolutions.com.au`), or the return value.

#### B005-5 — Missing @doc on send_test_email/3
**Severity:** INFO
**File:** `lib/api_server/vx/email.ex`, line 14

The public function `send_test_email/3` has no `@doc`. There is no description of its parameters (`from_email_address`, `subject`, `message`), the fact that the `message` parameter is ignored entirely (the HTML body is a hardcoded template containing both a geofence-exit and geofence-enter example side by side), or the return value.

#### B005-6 — Missing @doc on send_enter_email/4
**Severity:** INFO
**File:** `lib/api_server/vx/email.ex`, line 103

The public function `send_enter_email/4` has no `@doc`. The inline comment block (lines 104–114) describes the expected shape of the `data` map but is not a proper `@doc` and is not surfaced in ExDoc or IEx help. There is no description of required map keys, the return value, or potential runtime errors if required keys are absent.

#### B005-7 — Missing @doc on send_missing_serial_email/4
**Severity:** INFO
**File:** `lib/api_server/vx/email.ex`, line 167

The public function `send_missing_serial_email/4` has no `@doc`. There is no description of its parameters, the required keys on the `data` map (`:customer`, `:vehicle_name`, `:hardware_id`), or the return value.

#### B005-8 — Missing @doc on send_digital_matter_email/4
**Severity:** INFO
**File:** `lib/api_server/vx/email.ex`, line 215

The public function `send_digital_matter_email/4` has no `@doc`. There is no description of its parameters, the expected structure of `data` (which is inspected raw via `Kernel.inspect/2` into the HTML body), or the return value.

#### B005-9 — Missing @doc on send_slow_email/4
**Severity:** INFO
**File:** `lib/api_server/vx/email.ex`, line 262

The public function `send_slow_email/4` has no `@doc`. There is no description of its parameters, the required keys on the `data` map (`:customer`, `:diff`), or the return value.

#### B005-10 — Missing @doc on send_exit_email/4
**Severity:** INFO
**File:** `lib/api_server/vx/email.ex`, line 303

The public function `send_exit_email/4` has no `@doc`. There is no description of its parameters, the required keys on the `data` map (`:person_name`, `:geofence_name`, `:vehicle_name`, `:vehicle_serial`, `:time_left`, `:event_reference`), or the return value.

#### B005-11 — Inaccurate implicit contract: send_notification_email/3 ignores the `to` parameter
**Severity:** MEDIUM
**File:** `lib/api_server/vx/email.ex`, line 4

The function signature `send_notification_email(to, subject, message)` implies the `to` parameter controls the recipient. However, the implementation ignores `to` entirely and hardcodes the recipient as `"graham.oconnell@trackingsolutions.com.au"` (line 7). Any caller relying on the parameter name to understand behaviour will be misled. The absence of `@doc` means there is no warning about this discrepancy.

#### B005-12 — Inaccurate implicit contract: send_test_email/3 ignores the `message` parameter
**Severity:** MEDIUM
**File:** `lib/api_server/vx/email.ex`, line 14

The function signature `send_test_email(from_email_address, subject, message)` implies the `message` parameter supplies the email body. However, the implementation ignores `message` entirely and renders a hardcoded HTML body (lines 20–99). The absence of `@doc` means there is no warning about this discrepancy.

---

## equipment.ex

### Reading Evidence

**Module:** `ApiServer.Vx.Equipment`

**Schema:** `"equipment"` (Ecto schema, primary key `ID`)

**Fields:**
- `:id` (integer, source: `id`)
- `:name` (string, source: `name`)
- `:make` (string, source: `make`)
- `:model` (string, source: `model`)
- `:serial_number` (string, source: `serial_number`)
- `:class` (string, source: `class`)
- `:type` (string, source: `type`)
- `:created` (utc_datetime, source: `created`)

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 20 |

**Types defined:** none
**Errors defined:** none
**Constants defined:** none
**`@moduledoc`:** absent
**`@doc` on `changeset/2`:** absent
**`@spec` on `changeset/2`:** absent

### Findings

#### B005-13 — Missing @moduledoc in ApiServer.Vx.Equipment
**Severity:** LOW
**File:** `lib/api_server/vx/equipment.ex`, line 1

The module `ApiServer.Vx.Equipment` has no `@moduledoc` attribute. There is no description of the database table it maps to, the domain concept it represents, or the relationship to `ApiServer.Vx.EquipmentAssignment` (the `alias ApiServer.Vx` is present but unused, suggesting planned associations that were never documented).

#### B005-14 — Missing @doc on changeset/2 in ApiServer.Vx.Equipment
**Severity:** INFO
**File:** `lib/api_server/vx/equipment.ex`, line 20

The public function `changeset/2` has no `@doc` attribute. There is no description of the permitted attributes cast, the validation rules applied (`:serial_number` required, unique constraint on `:serial_number` via index name `:serial_number`), or the return value.

---

## equipment_assignment.ex

### Reading Evidence

**Module:** `ApiServer.Vx.EquipmentAssignment`

**Schema:** `"equipment_assignment"` (Ecto schema, primary key `ID`)

**Fields:**
- `:id` (integer, source: `id`)
- `:equipment_id` (integer, source: `equipment_id`)
- `:device_group` (string, source: `device_group`)
- `:device_group_timezone` (string, source: `device_group_timezone`)
- `:assignment_start` (utc_datetime, source: `assignment_start`)
- `:assignment_end` (utc_datetime, source: `assignment_end`)
- `:created` (utc_datetime, source: `created`)

**Commented-out code:** a `belongs_to` association to `ApiServer.Vx.Equipment` (line 17).

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 20 |

**Types defined:** none
**Errors defined:** none
**Constants defined:** none
**`@moduledoc`:** absent
**`@doc` on `changeset/2`:** absent
**`@spec` on `changeset/2`:** absent

### Findings

#### B005-15 — Missing @moduledoc in ApiServer.Vx.EquipmentAssignment
**Severity:** LOW
**File:** `lib/api_server/vx/equipment_assignment.ex`, line 1

The module `ApiServer.Vx.EquipmentAssignment` has no `@moduledoc` attribute. There is no description of the table's purpose (recording which device group an equipment item is assigned to over a time range), the fields, the relationship to `ApiServer.Vx.Equipment`, or the significance of the commented-out `belongs_to` association.

#### B005-16 — Missing @doc on changeset/2 in ApiServer.Vx.EquipmentAssignment
**Severity:** INFO
**File:** `lib/api_server/vx/equipment_assignment.ex`, line 20

The public function `changeset/2` has no `@doc` attribute. There is no description of the permitted attributes cast, the validation rules applied (`:equipment_id` and `:device_group` required, unique constraint on `:equipment_id`), or the return value.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B005-1 | LOW | `device_database_lookup.ex` | Missing `@moduledoc` in `ApiServer.Vx.DeviceDatabaseLookup` |
| B005-2 | INFO | `device_database_lookup.ex` | Missing `@doc` on `changeset/2` |
| B005-3 | LOW | `email.ex` | Missing `@moduledoc` in `ApiServer.Email` |
| B005-4 | INFO | `email.ex` | Missing `@doc` on `send_notification_email/3` |
| B005-5 | INFO | `email.ex` | Missing `@doc` on `send_test_email/3` |
| B005-6 | INFO | `email.ex` | Missing `@doc` on `send_enter_email/4` |
| B005-7 | INFO | `email.ex` | Missing `@doc` on `send_missing_serial_email/4` |
| B005-8 | INFO | `email.ex` | Missing `@doc` on `send_digital_matter_email/4` |
| B005-9 | INFO | `email.ex` | Missing `@doc` on `send_slow_email/4` |
| B005-10 | INFO | `email.ex` | Missing `@doc` on `send_exit_email/4` |
| B005-11 | MEDIUM | `email.ex` | `send_notification_email/3`: `to` parameter is silently ignored; recipient is hardcoded |
| B005-12 | MEDIUM | `email.ex` | `send_test_email/3`: `message` parameter is silently ignored; body is hardcoded |
| B005-13 | LOW | `equipment.ex` | Missing `@moduledoc` in `ApiServer.Vx.Equipment` |
| B005-14 | INFO | `equipment.ex` | Missing `@doc` on `changeset/2` |
| B005-15 | LOW | `equipment_assignment.ex` | Missing `@moduledoc` in `ApiServer.Vx.EquipmentAssignment` |
| B005-16 | INFO | `equipment_assignment.ex` | Missing `@doc` on `changeset/2` |

<!-- B006.md -->
# Pass 3: Documentation — B006
**Agent:** B006
**Files:**
- `lib/api_server/vx/erp_import.ex`
- `lib/api_server/vx/geofence.ex`
- `lib/api_server/vx/mailer.ex`
- `lib/api_server/vx/rental_contracts.ex`

**Date:** 2026-02-27

---

## lib/api_server/vx/erp_import.ex

### Reading Evidence

**Module:** `ApiServer.Vx.ERPImport`

**Behaviours / macros used:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

**Schema fields:** `id`, `raw_record`, `serialno`, `name`, `matched`, `type`

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 15 |

**Types / errors / constants defined:** none

**Documentation present:**
- `@moduledoc`: absent
- `@doc` on `changeset/2`: absent
- `@spec` on `changeset/2`: absent

### Findings

#### B006-1 — Missing @moduledoc in ApiServer.Vx.ERPImport
**Severity:** LOW
**File:** `lib/api_server/vx/erp_import.ex`, line 1

The module `ApiServer.Vx.ERPImport` has no `@moduledoc` attribute. There is no description of the purpose of the schema (ERP import staging records), the table it maps to (`erp_imports`), or the fields it exposes.

#### B006-2 — Missing @doc on ERPImport.changeset/2
**Severity:** INFO
**File:** `lib/api_server/vx/erp_import.ex`, line 15

The public function `changeset/2` has no `@doc` attribute. The function casts `:raw_record`, `:serialno`, `:name`, `:matched`, and `:type`, and validates that `:raw_record` is required. None of this is documented.

---

## lib/api_server/vx/geofence.ex

### Reading Evidence

**Module:** `ApiServer.Vx.Geofence`

**Behaviours / macros used:**
- `use Ecto.Schema`
- `import Ecto.Changeset`
- `import Ecto.Query, warn: false`

**Aliases:** `ApiServer.Repo`, `ApiServer.Vx`, `ApiServer.Vx.VXThingEvent`

**Schema fields:** `id`, `name`, `geojson`

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 17 |
| `geojson_map_to_string/1` | 24 |
| `geojson_db_string_to_map/1` | 38 |

**Private functions (not subject to @doc requirement):**

| Function | Line |
|---|---|
| `does_event_cause_geofence_events_no_thing/5` | 52 |
| `check_event_for_left_events_no_thing/5` (two clauses) | 69, 70 |
| `check_event_for_entered_events_no_thing/6` | 86 |
| `make_geofence_event_no_thing/5` | 103 |
| `engine_hours_at_event_no_thing/2` | 119 |

**Types / errors / constants defined:** none

**Documentation present:**
- `@moduledoc`: absent
- `@doc` on all three public functions: absent
- `@spec` on all public functions: absent

### Findings

#### B006-3 — Missing @moduledoc in ApiServer.Vx.Geofence
**Severity:** LOW
**File:** `lib/api_server/vx/geofence.ex`, line 1

The module `ApiServer.Vx.Geofence` has no `@moduledoc`. There is no description of the geofence concept, the underlying `geofences` table, the GeoJSON format used for the `geojson` field, or the relationship between this schema and the geofence-event detection logic contained in the private functions.

#### B006-4 — Missing @doc on Geofence.changeset/2
**Severity:** INFO
**File:** `lib/api_server/vx/geofence.ex`, line 17

The public function `changeset/2` has no `@doc` attribute. The function casts `:name` and `:geojson` and validates that `:name` is required. The absence of documentation leaves callers uninformed about which fields are accepted and which are mandatory.

#### B006-5 — Missing @doc on Geofence.geojson_map_to_string/1
**Severity:** INFO
**File:** `lib/api_server/vx/geofence.ex`, line 24

The public function `geojson_map_to_string/1` has no `@doc` attribute. The function converts a GeoJSON map (or `nil`) into a JSON-encoded string, returning an empty string `""` on both `nil` input and encoding failure. The silent fallback to `""` on error is a non-obvious behaviour that warrants explicit documentation.

#### B006-6 — Missing @doc on Geofence.geojson_db_string_to_map/1
**Severity:** INFO
**File:** `lib/api_server/vx/geofence.ex`, line 38

The public function `geojson_db_string_to_map/1` has no `@doc` attribute. The function decodes a JSON string from the database back into a map, returning `""` on both `nil` input and decode failure. As with `geojson_map_to_string/1`, the silent error path is non-obvious and undocumented.

---

## lib/api_server/vx/mailer.ex

### Reading Evidence

**Module:** `ApiServer.Mailer`

**Behaviours / macros used:**
- `use Bamboo.Mailer, otp_app: :api_server`

**Public functions:** none explicitly defined; all public API is injected by `Bamboo.Mailer` at compile time (e.g., `deliver_now/1`, `deliver_later/1`).

**Types / errors / constants defined:** none

**Documentation present:**
- `@moduledoc`: absent

### Findings

#### B006-7 — Missing @moduledoc in ApiServer.Mailer
**Severity:** LOW
**File:** `lib/api_server/vx/mailer.ex`, line 1

The module `ApiServer.Mailer` has no `@moduledoc`. There is no description of the mailer's purpose, the OTP application it is bound to (`:api_server`), or the Bamboo adapter that is expected to be configured in the application environment. A brief module doc would help developers locate configuration details and understand how the mailer is used throughout the application.

---

## lib/api_server/vx/rental_contracts.ex

### Reading Evidence

**Module:** `ApiServer.Vx.RentalContract`

**Behaviours / macros used:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

**Primary key:** `{:ID, :id, autogenerate: true}` (note: non-standard uppercase atom `:ID`)

**Schema fields:** `id`, `equipment_id`, `customer_id`, `contract_reference`, `contract_start`, `contract_end`, `billing_frequency`, `hours_per_billing_period`, `cost_units`, `cost_per_unit`, `reporting_frequency`, `created`, `sent_to_rayven`

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 22 |

**Types / errors / constants defined:** none

**Documentation present:**
- `@moduledoc`: absent
- `@doc` on `changeset/2`: absent
- `@spec` on `changeset/2`: absent

### Findings

#### B006-8 — Missing @moduledoc in ApiServer.Vx.RentalContract
**Severity:** LOW
**File:** `lib/api_server/vx/rental_contracts.ex`, line 1

The module `ApiServer.Vx.RentalContract` has no `@moduledoc`. There is no description of what a rental contract represents in the domain, which database table it maps to (`rental_contracts`), or any explanation of the non-standard primary key declaration (`:ID` uppercase atom vs. the conventional `:id`).

#### B006-9 — Missing @doc on RentalContract.changeset/2
**Severity:** INFO
**File:** `lib/api_server/vx/rental_contracts.ex`, line 22

The public function `changeset/2` has no `@doc` attribute. The function casts all thirteen schema fields but applies no `validate_required/2` constraints. The absence of any required-field validation is a notable design decision that should be documented to make it clear this is intentional rather than an oversight.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B006-1 | LOW | `erp_import.ex` | Missing `@moduledoc` in `ApiServer.Vx.ERPImport` |
| B006-2 | INFO | `erp_import.ex:15` | Missing `@doc` on `ERPImport.changeset/2` |
| B006-3 | LOW | `geofence.ex` | Missing `@moduledoc` in `ApiServer.Vx.Geofence` |
| B006-4 | INFO | `geofence.ex:17` | Missing `@doc` on `Geofence.changeset/2` |
| B006-5 | INFO | `geofence.ex:24` | Missing `@doc` on `Geofence.geojson_map_to_string/1` |
| B006-6 | INFO | `geofence.ex:38` | Missing `@doc` on `Geofence.geojson_db_string_to_map/1` |
| B006-7 | LOW | `mailer.ex` | Missing `@moduledoc` in `ApiServer.Mailer` |
| B006-8 | LOW | `rental_contracts.ex` | Missing `@moduledoc` in `ApiServer.Vx.RentalContract` |
| B006-9 | INFO | `rental_contracts.ex:22` | Missing `@doc` on `RentalContract.changeset/2` |

<!-- B007.md -->
# Pass 3: Documentation — B007
**Agent:** B007
**Files:**
- `lib/api_server/vx/rental_periods.ex`
- `lib/api_server/vx/scheduler.ex`
- `lib/api_server/vx/vx_user_function.ex`

**Date:** 2026-02-27

---

## lib/api_server/vx/rental_periods.ex

### Reading Evidence

- **Module name:** `ApiServer.Vx.RentalPeriod`
- **Behaviours/macros used:** `Ecto.Schema`, `Ecto.Changeset`
- **Schema:** `"rental_periods"` with primary key `{:ID, :id, autogenerate: true}`
- **Schema fields:** `:id`, `:contract_id`, `:period_start`, `:period_end`, `:hours_used`, `:overage`, `:is_completed`, `:created`
- **Types defined:** None explicitly (Ecto schema struct implied)
- **Constants defined:** None
- **Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 17 |

- **`@moduledoc` present:** No
- **`@doc` on `changeset/2`:** No

### Findings

#### B007-1 — Missing @moduledoc in ApiServer.Vx.RentalPeriod
**Severity:** LOW
**File:** `lib/api_server/vx/rental_periods.ex`, line 1

The module `ApiServer.Vx.RentalPeriod` has no `@moduledoc` attribute. There is no description of the module's purpose, the database table it maps to, or the business domain it represents (rental contract periods). A reader cannot determine from the module alone what "rental periods" means in application context, what the `is_completed` integer flag encodes, or what the relationship to `contract_id` is.

---

#### B007-2 — Missing @doc on changeset/2 in ApiServer.Vx.RentalPeriod
**Severity:** INFO
**File:** `lib/api_server/vx/rental_periods.ex`, line 17

The public function `changeset/2` has no `@doc` attribute. There is no description of the expected shape of the `attrs` map, which fields are required vs. optional, or any validation rules. Notably, the changeset performs only a `cast/3` with no `validate_required/2` call, which means all fields are effectively optional — this non-obvious behaviour is undocumented.

---

## lib/api_server/vx/scheduler.ex

### Reading Evidence

- **Module name:** `ApiServer.Scheduler`
- **Behaviours/macros used:** `Quantum.Scheduler` (via `use Quantum.Scheduler, otp_app: :api_server`)
- **Schema fields:** None (not an Ecto schema)
- **Types defined:** None
- **Constants defined:** None
- **Public functions defined directly in this module:** None (all public API is injected by `Quantum.Scheduler`)
- **`@moduledoc` present:** No
- **`@doc` on any function:** N/A (no functions defined in module body)

### Findings

#### B007-3 — Missing @moduledoc in ApiServer.Scheduler
**Severity:** LOW
**File:** `lib/api_server/vx/scheduler.ex`, line 1

The module `ApiServer.Scheduler` has no `@moduledoc` attribute. The module is the application's Quantum job scheduler and serves as the OTP process entry point for all scheduled tasks. Without a `@moduledoc`, there is no indication of what jobs are scheduled, where their configuration lives (e.g., `config/config.exs` or `config/runtime.exs`), or the operational significance of this process in the supervision tree.

---

## lib/api_server/vx/vx_user_function.ex

### Reading Evidence

- **Module name:** `ApiServer.Vx.VXUserFunction`
- **Behaviours/macros used:** `Ecto.Schema`, `Ecto.Changeset`
- **Schema:** `"aat_user_functions"` with primary key `{:aatid, :id, autogenerate: true}`
- **Schema fields:** `:aatfunction_id` (integer), `:aatuser_id` (integer)
- **Associations:** `belongs_to :user, ApiServer.Vx.VXUser` (foreign key `:aatuser_id`, references `:aacid`, `define_field: false`)
- **Types defined:** None
- **Constants defined:** None
- **Public functions:**

| Function | Line | @doc |
|---|---|---|
| `changeset/2` | 14 | `@doc false` (intentionally suppressed) |

- **`@moduledoc` present:** No

### Findings

#### B007-4 — Missing @moduledoc in ApiServer.Vx.VXUserFunction
**Severity:** LOW
**File:** `lib/api_server/vx/vx_user_function.ex`, line 1

The module `ApiServer.Vx.VXUserFunction` has no `@moduledoc` attribute. There is no description of what user functions are, what the `aat_user_functions` table represents, or the relationship between users (`aatuser_id`) and functions (`aatfunction_id`). The prefixed column naming convention (`aat*`) is opaque and its rationale is undocumented.

---

#### B007-5 — Inaccurate @doc false on changeset/2 obscures a field name mismatch in ApiServer.Vx.VXUserFunction
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_user_function.ex`, line 13–18

The `changeset/2` function is annotated `@doc false`, suppressing it from generated documentation. However, the implementation contains a field name inconsistency that documentation (even internal) should capture: the schema defines the field as `:aatfunction_id` (line 7, with underscore), but `cast/3` and `validate_required/2` reference the atom `:aatfunctionid` (line 16–17, without underscore). This means the cast silently ignores the `:aatfunction_id` attribute and `validate_required` will always fail for that field, making the changeset non-functional as written. The `@doc false` suppression prevents this discrepancy from being surfaced in any documentation layer. While the root cause is a code defect rather than a documentation defect, the absence of any documentation (including internal `@doc false` commentary) means there is no recorded intent to guide a future fix.

This finding is raised under the documentation pass because `@doc false` is used as a substitute for documentation rather than as a supplement to internal comments explaining expected behaviour.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B007-1 | LOW | `rental_periods.ex` | Missing `@moduledoc` in `ApiServer.Vx.RentalPeriod` |
| B007-2 | INFO | `rental_periods.ex`, line 17 | Missing `@doc` on public `changeset/2`; no-validation behaviour undocumented |
| B007-3 | LOW | `scheduler.ex` | Missing `@moduledoc` in `ApiServer.Scheduler` |
| B007-4 | LOW | `vx_user_function.ex` | Missing `@moduledoc` in `ApiServer.Vx.VXUserFunction` |
| B007-5 | MEDIUM | `vx_user_function.ex`, lines 13–18 | `@doc false` suppresses visibility of a `:aatfunction_id` vs `:aatfunctionid` field name mismatch that renders the changeset non-functional |

<!-- B008.md -->
# Pass 3: Documentation — B008
**Agent:** B008
**Files:** `lib/api_server/vx/vx.ex`
**Date:** 2026-02-27

---

## lib/api_server/vx/vx.ex

### Reading Evidence

**Module name:** `ApiServer.Vx`

**Types, errors, constants defined:** None (no `@type`, `@typep`, `@opaque`, `@callback`, or module-level constants are defined in this file).

---

**Every public function name and line number** (170 distinct clauses across ~140 logical functions):

| Line | Function / arity |
|------|-----------------|
| 27 | `update_key_if_value/3` (clause 1 — nil guard) |
| 28 | `update_key_if_value/3` (clause 2) |
| 33 | `list_vxusers/1` |
| 40 | `get_vx_user!/2` |
| 47 | `get_vx_user_offset/2` |
| 54 | `get_vx_user_fleets!/2` |
| 75 | `create_vx_user/2` |
| 93 | `update_vx_user/3` |
| 99 | `update_vx_user_password/3` |
| 117 | `delete_vx_user/2` |
| 130 | `change_vx_user/1` |
| 145 | `list_vxaccessfobs/0` |
| 163 | `get_vx_access_fob!/1` |
| 165 | `get_vx_access_fob_by_code!/1` |
| 177 | `get_vx_access_fobs_for_fleets!/1` |
| 189 | `get_vx_fleet_for_access_fob/1` |
| 198 | `get_num_vx_admin_fobs/0` |
| 199 | `get_vx_admin_fobs/0` |
| 215 | `delete_vx_access_fob/1` |
| 222 | `list_vxfleets/1` (customer) |
| 227 | `list_vxfleets/2` (user_id, customer) |
| 235 | `get_list_of_valid_fleets_for_user/2` |
| 243 | `get_list_of_valid_equipment_for_user/2` |
| 264 | `list_vxfleets_with_equipment/2` |
| 290 | `get_vx_fleet_by_name/2` |
| 296 | `get_vx_fleet/2` |
| 315 | `create_vx_fleet/2` |
| 333 | `update_vx_fleet/3` |
| 351 | `delete_vx_fleet/2` |
| 364 | `change_vx_fleet/1` |
| 378 | `update_fleet_assocs/3` |
| 392 | `get_equipment_in_fleet/2` |
| 400 | `get_hardwareids_in_fleet/2` |
| 408 | `get_fleets_for_thing/2` |
| 416 | `get_branch_for_thing/2` |
| 427 | `list_vxfleetassociations/0` |
| 449 | `get_vx_fleet_association!/1` |
| 464 | `delete_vx_fleet_association/1` |
| 470 | `list_vxthings/1` (customer) |
| 478 | `list_vxthings_full/1` |
| 492 | `list_vxthings_lite/1` |
| 498 | `list_vxthing/2` (customer, hardwareid) |
| 507 | `list_vxthing_full/2` |
| 520 | `list_vxthing_lite/2` |
| 528 | `list_vxthings/2` (user_id, customer) |
| 539 | `list_augmented_things/2` |
| 555 | `list_augmented_things_with_rentals/1` |
| 568 | `list_augmented_things_with_rentals_in_fleet/3` |
| 589 | `list_augmented_things_in_fleet/3` |
| 608 | `list_vxthings_in_fleet/2` |
| 623 | `list_vxthings_with_checklists/1` |
| 631 | `get_lift_event_counts_for_thing_by_day/5` |
| 651 | `get_detailed_lift_event_counts_for_thing_by_day/6` |
| 677 | `get_list_lift_event_counts_for_thing_by_day/6` |
| 699 | `get_detailed_lift_event_counts_for_fleet_by_day/5` |
| 726 | `get_omega_engine_utilization/5` |
| 749 | `get_omega_operation_summary/5` |
| 780 | `list_vxthings_for_map/2` (customer, user_id) |
| 795 | `list_vxthings_for_map/2` (customer, fleet_id) |
| 811 | `augment_thing_with_fleets/2` |
| 816 | `augment_thing_with_services/2` |
| 827 | `get_hour_meter_start_rental/2` |
| 871 | `augment_thing_with_rental_periods/2` |
| 940 | `augment_thing_with_usage/2` |
| 968 | `get_avg_weekly_hours/2` |
| 981 | `get_avg_weekly_hours/3` |
| 985 | `get_summary_total_usage/1` |
| 1006 | `get_usage_since_service/2` |
| 1030 | `fetch_actual_usage/2` (thing, customer) |
| 1042 | `generate_usage_select/2` |
| 1090 | `fetch_actual_usage/5` (hardwareid, 4, customer, from, to) |
| 1133 | `fetch_actual_usage/5` (hardwareid, 2, customer, from, to) |
| 1174 | `fetch_actual_usage/5` (hardwareid, 3, customer, from, to) |
| 1215 | `fetch_actual_usage/5` (hardwareid, category, customer, from, to) — fallback |
| 1230 | `fetch_actual_usage_thing/4` |
| 1235 | `get_movements/5` |
| 1281 | `get_vx_thing!/1` |
| 1283 | `get_vx_thing!/2` (id, customer) |
| 1290 | `get_thing_name_with_hardware_id!/2` |
| 1296 | `get_fleet_name_with_id/2` |
| 1303 | `get_thing_category_with_hardware_id!/2` |
| 1311 | `get_thing_id_with_hardware_id!/2` |
| 1319 | `lookup_thing_with_name_serial/3` |
| 1328 | `lookup_thing_with_name/2` |
| 1337 | `get_vx_thing_with_hardware_id!/1` |
| 1347 | `get_vx_thing_with_hardware_id!/2` (hardwareid, customer) |
| 1357 | `get_augmented_thing_with_hardware_id!/2` |
| 1363 | `get_equipment_by_name/2` |
| 1371 | `get_equipment_by_serial/2` |
| 1377 | `get_equipment_assignments_by_id/2` |
| 1395 | `create_vx_thing/2` |
| 1413 | `update_vx_thing/3` |
| 1431 | `delete_vx_thing/1` |
| 1444 | `change_vx_thing/1` |
| 1459 | `list_vxthingsummaries/0` |
| 1477 | `get_vx_thing_summary!/1` |
| 1478 | `get_summary_for_hardwareid/2` |
| 1484 | `update_or_insert_summary/3` |
| 1501 | `create_vx_thing_summary/1` |
| 1519 | `update_vx_thing_summary/2` |
| 1537 | `delete_vx_thing_summary/1` |
| 1550 | `change_vx_thing_summary/1` |
| 1555 | `default_checklist_questions/0` |
| 1586 | `get_checklists/1` |
| 1622 | `list_vxthingevents/0` |
| 1640 | `get_vx_thing_event!/1` |
| 1642 | `get_most_recent_thingevent/2` |
| 1651 | `get_most_recent_thingevent_with_date/3` |
| 1660 | `get_most_recent_thingevent_with_omega/2` |
| 1673 | `get_thingevents_for_hardwareid/2` |
| 1680 | `get_thingevents_for_hardwareid/4` (hardwareid, from, to, customer) |
| 1702 | `create_vx_thing_event/2` |
| 1720 | `update_vx_thing_event/2` |
| 1738 | `delete_vx_thing_event/1` |
| 1751 | `change_vx_thing_event/1` |
| 1755 | `generate_avg_weekly_select/2` |
| 1795 | `convert_category_to_regular_units/2` |
| 1824 | `get_first_event/2` |
| 1842 | `get_actual_avg_weekly_hours/3` (hardwareid, 4, customer) |
| 1879 | `get_actual_avg_weekly_hours/4` (hardwareid, 4, customer, _) |
| 1916 | `get_actual_avg_weekly_hours/3` (hardwareid, 2, customer) |
| 1952 | `get_actual_avg_weekly_hours/4` (hardwareid, 2, customer, 1) |
| 1988 | `get_actual_avg_weekly_hours/3` (hardwareid, 3, customer) |
| 2026 | `get_actual_avg_weekly_hours/3` (hardwareid, category, customer) — fallback |
| 2054 | `list_service_records/1` |
| 2100 | `get_daily_usage/6` |
| 2170 | `get_impact_count_by_hardwareid/2` |
| 2179 | `get_events/5` |
| 2192 | `process_events/0` |
| 2547 | `process_events_subprocess/1` |
| 2611 | `get_vx_abl_record!/1` |
| 2625 | `create_vx_abl_record/1` |
| 2631 | `create_abl_record/2` |
| 2637 | `create_equipment_record/2` |
| 2643 | `get_equipment_id/2` |
| 2650 | `create_equipment_assignment_record/2` |
| 2668 | `update_vx_abl_record/2` |
| 2686 | `delete_vx_abl_record/1` |
| 2699 | `change_vx_abl_record/1` |
| 2704 | `get_rhm_user/3` (email, password, customer) |
| 2712 | `check_password/3` |
| 2719 | `get_rhm_user/2` (email, customer) |
| 2730 | `list_all_rentals/1` |
| 2740 | `list_open_rentals/1` |
| 2753 | `get_rental/2` (id, customer) |
| 2764 | `get_active_rental/2` |
| 2776 | `get_all_rentals_for_thing/2` |
| 2786 | `get_rental/4` (thing_id, customer_id, start_date, customer) |
| 2798 | `delete_rental/2` |
| 2802 | `update_rental/3` |
| 2809 | `create_rental_contract/2` |
| 2817 | `create_rental_period/2` |
| 2825 | `get_rental_periods_for_contract/2` |
| 2831 | `create_rental/2` |
| 2871 | `list_customers/1` |
| 2889 | `get_vx_customer!/2` |
| 2891 | `get_customer/3` |
| 2916 | `create_vx_customer/2` |
| 2934 | `update_vx_customer/3` |
| 2952 | `delete_vx_customer/2` |
| 2965 | `change_vx_customer/2` |
| 2980 | `list_vxaatuserfunctions/0` |
| 2998 | `get_vx_user_function!/1` |
| 3012 | `create_vx_user_function/1` |
| 3030 | `update_vx_user_function/2` |
| 3048 | `delete_vx_user_function/1` |
| 3061 | `change_vx_user_function/1` |
| 3074 | `list_vxaau_rest/0` |
| 3092 | `get_vx_restriction!/1` |
| 3106 | `create_vx_restriction/1` |
| 3112 | `add_fleet_to_user/3` |
| 3124 | `get_restriction/3` |
| 3132 | `remove_fleet_from_user/3` |
| 3150 | `update_vx_restriction/2` |
| 3168 | `delete_vx_restriction/1` |
| 3181 | `change_vx_restriction/1` |
| 3189 | `delete_erp_import/2` |
| 3193 | `create_erp_import/2` |
| 3199 | `update_erp_import/3` |
| 3205 | `check_for_existing_erp_record/2` |
| 3223 | `get_geofence_by_id/2` |
| 3229 | `get_geofences/1` |
| 3234 | `get_geofences_as_map/1` |
| 3249 | `create_geofence/2` |
| 3255 | `update_geofence/3` |
| 3261 | `delete_geofence/2` |
| 3265 | `create_thingevent_record/2` |
| 3271 | `update_thingevent_record/3` |
| 3277 | `delete_thingevent_record/2` |
| 3281 | `create_thingeventomega_record/2` |
| 3287 | `create_thingomegatires_record/2` |
| 3293 | `create_rayven_message_log_record/2` |
| 3299 | `update_rayven_stream_status_record/2` |
| 3305 | `count_rayven_events_to_stream/3` |

**Private functions (not subject to @doc requirements):**
- `daily_usage_where/2` (line 2062) — `defp`

---

### Findings

#### B008-1 — @moduledoc is a placeholder with no substantive content
**Severity:** LOW
**File:** `lib/api_server/vx/vx.ex`, line 2

The module-level documentation at line 2 reads:

```elixir
@moduledoc """
The Vx context.
"""
```

This is the Phoenix context generator boilerplate. It provides no description of what the Vx context is responsible for, what domain it covers (fleet management, equipment telemetry, rental contracts, geofencing, user access control, etc.), or how callers should interact with it. For a 3,314-line module that is the core business logic layer of the application, one sentence of boilerplate offers no navigational value.

---

#### B008-2 — Large number of public functions lack @doc
**Severity:** LOW
**File:** `lib/api_server/vx/vx.ex`, various lines

The following public functions (approximately 95 of the ~170 public function clauses) have no `@doc` attached:

| Line | Function |
|------|----------|
| 27–28 | `update_key_if_value/3` |
| 33 | `list_vxusers/1` |
| 40 | `get_vx_user!/2` |
| 47 | `get_vx_user_offset/2` |
| 54 | `get_vx_user_fleets!/2` |
| 99 | `update_vx_user_password/3` |
| 165 | `get_vx_access_fob_by_code!/1` |
| 198 | `get_num_vx_admin_fobs/0` |
| 199 | `get_vx_admin_fobs/0` |
| 222 | `list_vxfleets/1` |
| 227 | `list_vxfleets/2` |
| 235 | `get_list_of_valid_fleets_for_user/2` |
| 243 | `get_list_of_valid_equipment_for_user/2` |
| 264 | `list_vxfleets_with_equipment/2` |
| 296 | `get_vx_fleet/2` |
| 392 | `get_equipment_in_fleet/2` |
| 400 | `get_hardwareids_in_fleet/2` |
| 408 | `get_fleets_for_thing/2` |
| 416 | `get_branch_for_thing/2` |
| 427 | `list_vxfleetassociations/0` |
| 470 | `list_vxthings/1` |
| 478 | `list_vxthings_full/1` |
| 492 | `list_vxthings_lite/1` |
| 498 | `list_vxthing/2` |
| 507 | `list_vxthing_full/2` |
| 520 | `list_vxthing_lite/2` |
| 528 | `list_vxthings/2` |
| 539 | `list_augmented_things/2` |
| 555 | `list_augmented_things_with_rentals/1` |
| 568 | `list_augmented_things_with_rentals_in_fleet/3` |
| 589 | `list_augmented_things_in_fleet/3` |
| 608 | `list_vxthings_in_fleet/2` |
| 623 | `list_vxthings_with_checklists/1` |
| 631 | `get_lift_event_counts_for_thing_by_day/5` |
| 651 | `get_detailed_lift_event_counts_for_thing_by_day/6` |
| 677 | `get_list_lift_event_counts_for_thing_by_day/6` |
| 699 | `get_detailed_lift_event_counts_for_fleet_by_day/5` |
| 726 | `get_omega_engine_utilization/5` |
| 749 | `get_omega_operation_summary/5` |
| 780 | `list_vxthings_for_map/2` (user_id variant) |
| 795 | `list_vxthings_for_map/2` (fleet_id variant) |
| 811 | `augment_thing_with_fleets/2` |
| 816 | `augment_thing_with_services/2` |
| 827 | `get_hour_meter_start_rental/2` |
| 871 | `augment_thing_with_rental_periods/2` |
| 940 | `augment_thing_with_usage/2` |
| 968 | `get_avg_weekly_hours/2` |
| 981 | `get_avg_weekly_hours/3` |
| 985 | `get_summary_total_usage/1` |
| 1006 | `get_usage_since_service/2` |
| 1030 | `fetch_actual_usage/2` |
| 1042 | `generate_usage_select/2` |
| 1090 | `fetch_actual_usage/5` (cat 4) |
| 1133 | `fetch_actual_usage/5` (cat 2) |
| 1174 | `fetch_actual_usage/5` (cat 3) |
| 1215 | `fetch_actual_usage/5` (fallback) |
| 1230 | `fetch_actual_usage_thing/4` |
| 1235 | `get_movements/5` |
| 1283 | `get_vx_thing!/2` (customer variant) |
| 1290 | `get_thing_name_with_hardware_id!/2` |
| 1296 | `get_fleet_name_with_id/2` |
| 1303 | `get_thing_category_with_hardware_id!/2` |
| 1311 | `get_thing_id_with_hardware_id!/2` |
| 1319 | `lookup_thing_with_name_serial/3` |
| 1328 | `lookup_thing_with_name/2` |
| 1337 | `get_vx_thing_with_hardware_id!/1` |
| 1347 | `get_vx_thing_with_hardware_id!/2` |
| 1357 | `get_augmented_thing_with_hardware_id!/2` |
| 1363 | `get_equipment_by_name/2` |
| 1371 | `get_equipment_by_serial/2` |
| 1377 | `get_equipment_assignments_by_id/2` |
| 1478 | `get_summary_for_hardwareid/2` |
| 1484 | `update_or_insert_summary/3` |
| 1555 | `default_checklist_questions/0` |
| 1586 | `get_checklists/1` |
| 1642 | `get_most_recent_thingevent/2` |
| 1651 | `get_most_recent_thingevent_with_date/3` |
| 1660 | `get_most_recent_thingevent_with_omega/2` |
| 1673 | `get_thingevents_for_hardwareid/2` |
| 1680 | `get_thingevents_for_hardwareid/4` |
| 1755 | `generate_avg_weekly_select/2` |
| 1795 | `convert_category_to_regular_units/2` |
| 1824 | `get_first_event/2` |
| 1842 | `get_actual_avg_weekly_hours/3` (cat 4) |
| 1879 | `get_actual_avg_weekly_hours/4` (cat 4, _) |
| 1916 | `get_actual_avg_weekly_hours/3` (cat 2) |
| 1952 | `get_actual_avg_weekly_hours/4` (cat 2, 1) |
| 1988 | `get_actual_avg_weekly_hours/3` (cat 3) |
| 2026 | `get_actual_avg_weekly_hours/3` (fallback) |
| 2100 | `get_daily_usage/6` |
| 2170 | `get_impact_count_by_hardwareid/2` |
| 2179 | `get_events/5` |
| 2192 | `process_events/0` |
| 2547 | `process_events_subprocess/1` |
| 2631 | `create_abl_record/2` |
| 2637 | `create_equipment_record/2` |
| 2643 | `get_equipment_id/2` |
| 2650 | `create_equipment_assignment_record/2` |
| 2704 | `get_rhm_user/3` |
| 2712 | `check_password/3` |
| 2719 | `get_rhm_user/2` |
| 2730 | `list_all_rentals/1` |
| 2740 | `list_open_rentals/1` |
| 2753 | `get_rental/2` |
| 2764 | `get_active_rental/2` |
| 2776 | `get_all_rentals_for_thing/2` |
| 2786 | `get_rental/4` |
| 2798 | `delete_rental/2` |
| 2802 | `update_rental/3` |
| 2809 | `create_rental_contract/2` |
| 2817 | `create_rental_period/2` |
| 2825 | `get_rental_periods_for_contract/2` |
| 2831 | `create_rental/2` |
| 2891 | `get_customer/3` |
| 3112 | `add_fleet_to_user/3` |
| 3124 | `get_restriction/3` |
| 3132 | `remove_fleet_from_user/3` |
| 3189 | `delete_erp_import/2` |
| 3193 | `create_erp_import/2` |
| 3199 | `update_erp_import/3` |
| 3205 | `check_for_existing_erp_record/2` |
| 3223 | `get_geofence_by_id/2` |
| 3229 | `get_geofences/1` |
| 3234 | `get_geofences_as_map/1` |
| 3249 | `create_geofence/2` |
| 3255 | `update_geofence/3` |
| 3261 | `delete_geofence/2` |
| 3265 | `create_thingevent_record/2` |
| 3271 | `update_thingevent_record/3` |
| 3277 | `delete_thingevent_record/2` |
| 3281 | `create_thingeventomega_record/2` |
| 3287 | `create_thingomegatires_record/2` |
| 3293 | `create_rayven_message_log_record/2` |
| 3299 | `update_rayven_stream_status_record/2` |
| 3305 | `count_rayven_events_to_stream/3` |

The absence of `@doc` is especially significant for non-obvious functions whose behaviour cannot be inferred from the name alone: `update_key_if_value/3`, `get_vx_admin_fobs/0`, `get_num_vx_admin_fobs/0` (returns a hardcoded `7`), `generate_usage_select/2`, `generate_avg_weekly_select/2`, `convert_category_to_regular_units/2`, `get_daily_usage/6`, `process_events/0`, `process_events_subprocess/1`, `check_for_existing_erp_record/2`, `get_geofences_as_map/1`, and `update_rayven_stream_status_record/2`. Additionally, no `@spec` type specifications are present anywhere in the file.

---

#### B008-3 — @doc at line 276 describes a different function than the one it precedes
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx.ex`, lines 276–294

The `@doc` block at line 276 reads:

```elixir
@doc """
Gets a single vx_fleet.

Raises `Ecto.NoResultsError` if the Vx fleet does not exist.

## Examples

    iex> get_vx_fleet!(123)
    %VXFleet{}

    iex> get_vx_fleet!(456)
    ** (Ecto.NoResultsError)

"""
def get_vx_fleet_by_name(fleetname, customer) do
```

The `@doc` was written for a `get_vx_fleet!/1` function (single ID lookup that raises), but it is attached to `get_vx_fleet_by_name/2`, which:
- accepts a fleet name string and a customer/tenant prefix, not a numeric ID;
- uses `Repo.all/2`, returning a list, not a single struct;
- never raises `Ecto.NoResultsError` (it returns an empty list on no match);
- belongs to a completely different function.

The immediately following `get_vx_fleet/2` (line 296) has no `@doc` at all. There is no `get_vx_fleet!/1` function anywhere in the module, so the described function does not exist. A reader consulting the docs for `get_vx_fleet_by_name/2` will receive incorrect information about argument types, return shape, and error behaviour.

---

#### B008-4 — @doc at line 369 describes list_vxfleetassociationss but precedes update_fleet_assocs
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx.ex`, lines 369–390

The `@doc` block at line 369 reads:

```elixir
@doc """
Returns the list of vxfleetassociationss.

## Examples

    iex> list_vxfleetassociationss()
    [%VXFleetAssociation{}, ...]

"""
def update_fleet_assocs(fleet_id, customer, updated_ids) do
```

The `@doc` was written for a `list_vxfleetassociationss/0` list function, but it is attached to `update_fleet_assocs/3`, which:
- performs a destructive operation (deletes all existing fleet associations for `fleet_id`, then bulk-inserts `updated_ids`);
- takes three arguments (fleet_id, customer, updated_ids), not zero;
- returns a list of `{group_id, thing_id}` tuples for the updated fleet, not a full list of all associations.

The actual `list_vxfleetassociations/0` function at line 427 has no `@doc`. A caller reading the documentation for `update_fleet_assocs/3` will be misled about the function's destructive write semantics.

---

#### B008-5 — @doc at line 2045 names list_vxablrecords but precedes list_service_records
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx.ex`, lines 2045–2060

The `@doc` block at line 2045 reads:

```elixir
@doc """
Returns the list of vxablrecords.

## Examples

    iex> list_vxablrecords()
    [%VXAblRecord{}, ...]

"""
def list_service_records(customer) do
```

The `@doc` was written for a hypothetical `list_vxablrecords/0` function, but it is attached to `list_service_records/1`. The implementation is not a general list of all `VXAblRecord` rows; it is a filtered, ordered, preloaded query that returns only records where `abllogtype == "SERVICEDATE"`. The `@doc` describes the wrong function name, the wrong arity (0 vs 1), omits the `customer` tenant parameter entirely, and makes no mention of the service-date filter. This is misleading to callers who need to understand the scope of returned records.

---

## Summary

| ID | Severity | Description |
|----|----------|-------------|
| B008-1 | LOW | `@moduledoc` is boilerplate placeholder with no substantive content |
| B008-2 | LOW | ~120 public function clauses across ~95 functions lack `@doc`; no `@spec` anywhere in the file |
| B008-3 | MEDIUM | `@doc` at line 276 describes non-existent `get_vx_fleet!/1`; is incorrectly attached to `get_vx_fleet_by_name/2` with wrong arity, return type, and error behaviour |
| B008-4 | MEDIUM | `@doc` at line 369 describes `list_vxfleetassociationss/0`; is incorrectly attached to `update_fleet_assocs/3`, which performs destructive write operations |
| B008-5 | MEDIUM | `@doc` at line 2045 describes `list_vxablrecords/0`; is incorrectly attached to `list_service_records/1`, omitting the tenant parameter and the service-date filter |

<!-- B009.md -->
# Pass 3: Documentation — B009
**Agent:** B009
**Files:**
- `lib/api_server/vx/vx_abl_record.ex`
- `lib/api_server/vx/vx_access_fob.ex`
- `lib/api_server/vx/vx_customer.ex`
- `lib/api_server/vx/vx_fleet.ex`

**Date:** 2026-02-27

---

## vx_abl_record.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXAblRecord`

**Schema:** `abl_data_changes` (primary key: `ablid`)

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 25 |
| `generate_service/10` | 31 |
| `clean_xml_value/1` | 54 |
| `clean_xml_number_value/1` | 63 |
| `expand_xml_to_struct/1` | 72 |

**Types/constants defined:** None.

**Notes:**
- `changeset/2` carries `@doc false` (line 24) — intentionally suppressed, acceptable Ecto convention.
- `generate_service/10`, `clean_xml_value/1`, `clean_xml_number_value/1`, and `expand_xml_to_struct/1` have no `@doc` annotation of any kind.

### Findings

#### B009-1 — Missing @moduledoc in VXAblRecord
**Severity:** LOW
**File:** `lib/api_server/vx/vx_abl_record.ex`, line 1

The module `ApiServer.Vx.VXAblRecord` has no `@moduledoc` attribute. There is no description of its purpose (audit/change-log record schema for the `abl_data_changes` table), the XML blob format stored in `ablimage`, or the relationship to `VXUser`.

---

#### B009-2 — Missing @doc on generate_service/10
**Severity:** INFO
**File:** `lib/api_server/vx/vx_abl_record.ex`, line 31

The public function `generate_service/10` has no `@doc`. The function builds an XML audit payload recording a service-date change, then persists it via `Vx.create_abl_record/2`. Its ten parameters (`user`, `import_hour_meter`, `performed_by`, `thing`, `existing_service_date`, `new_service_date`, `current_hour_meter`, `input_one_hour_meter`, `usage`, `customer`) are undocumented. Return value (`:ok` or `:error` atom extracted from the tuple) is also undocumented.

---

#### B009-3 — Missing @doc on clean_xml_value/1
**Severity:** INFO
**File:** `lib/api_server/vx/vx_abl_record.ex`, line 54

The public function `clean_xml_value/1` has no `@doc`. The function converts an empty map `%{}` (produced by `XmlToMap` for absent XML elements) to `nil`, passing all other values through. The intent and the `XmlToMap` convention it compensates for are not described.

---

#### B009-4 — Missing @doc on clean_xml_number_value/1
**Severity:** INFO
**File:** `lib/api_server/vx/vx_abl_record.ex`, line 63

The public function `clean_xml_number_value/1` has no `@doc`. It is functionally similar to `clean_xml_value/1` but returns `0` instead of `nil` for empty-map inputs. The distinction between the two helpers and when each should be used is not documented. (Note: `clean_xml_number_value/1` is defined but never called within this module; its public visibility without documentation compounds the clarity gap.)

---

#### B009-5 — Missing @doc on expand_xml_to_struct/1
**Severity:** INFO
**File:** `lib/api_server/vx/vx_abl_record.ex`, line 72

The public function `expand_xml_to_struct/1` has no `@doc`. The function parses the raw XML string stored in `ablimage`, extracts service-related fields (including `hardwareid`), and merges them into the record map. The expected shape of the input, the fields added to the result, and the `XmlToMap` dependency are all undocumented.

---

## vx_access_fob.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXAccessFob`

**Schema:** `access_fobs` (default primary key `id`)

**Public functions:** None (no functions are defined in this module beyond the implicit Ecto schema callbacks).

**Types/constants defined:** None.

**Notes:**
- The module contains only a `use Ecto.Schema` declaration and a single `schema` block; no manually defined functions exist.
- `require Ecto.Query` and `require Ecto.Adapters.SQL` appear at the top of the file (lines 1–2) outside the `defmodule` block — these are file-level requires that have no effect on the module and appear to be leftover dead code.

### Findings

#### B009-6 — Missing @moduledoc in VXAccessFob
**Severity:** LOW
**File:** `lib/api_server/vx/vx_access_fob.ex`, line 4

The module `ApiServer.Vx.VXAccessFob` has no `@moduledoc`. There is no description of what an access fob is, its relationship to `VXUser` (via `assigned_to_user` → `aacid`), or how fob codes are used within the system.

---

## vx_customer.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXCustomer`

**Schema:** `aaa_customers` (primary key: `aaaid`)

**Public functions:**

| Function | Line |
|---|---|
| `convert_json_to_changeset/1` | 25 |
| `changeset/2` | 43 |

**Types/constants defined:** None.

**Notes:**
- `changeset/2` carries `@doc false` (line 42) — intentionally suppressed, consistent with Ecto convention.
- `convert_json_to_changeset/1` has no `@doc` annotation of any kind.

### Findings

#### B009-7 — Missing @moduledoc in VXCustomer
**Severity:** LOW
**File:** `lib/api_server/vx/vx_customer.ex`, line 1

The module `ApiServer.Vx.VXCustomer` has no `@moduledoc`. There is no description of its purpose, the `aaa_customers` table it maps to, or the customer code derivation logic embedded in `convert_json_to_changeset/1`.

---

#### B009-8 — Missing @doc on convert_json_to_changeset/1
**Severity:** INFO
**File:** `lib/api_server/vx/vx_customer.ex`, line 25

The public function `convert_json_to_changeset/1` has no `@doc`. The function accepts a raw JSON-decoded map and constructs a changeset map using `Vx.update_key_if_value/3`. Key behaviour that goes undocumented includes:

- The expected keys of the input map (e.g. `"name"`, `"address_line_1"`, `"timezone"`, `"aaaudfcustcode"`, `"aaacolour"`).
- The automatic derivation of `:aaacustcode` from the customer name by reversing it, removing spaces, and taking the first 9 characters uppercased.
- The fact that the return value is a plain map, not an `Ecto.Changeset` struct (despite the function name).

---

## vx_fleet.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXFleet`

**Schema:** `aae_group` (primary key: `aaeid`)

**Public functions:**

| Function | Line |
|---|---|
| `convert_json_to_changeset/1` | 19 |
| `changeset/2` | 27 |

**Types/constants defined:** None.

**Notes:**
- `changeset/2` has no `@doc false` annotation — it is fully public and undocumented.
- `convert_json_to_changeset/1` has no `@doc` annotation.

### Findings

#### B009-9 — Missing @moduledoc in VXFleet
**Severity:** LOW
**File:** `lib/api_server/vx/vx_fleet.ex`, line 1

The module `ApiServer.Vx.VXFleet` has no `@moduledoc`. There is no description of what a fleet/group is, its relationship to `VXFleetAssociation`, or the semantics of `:aaetype` and `:aaeshowfilter`.

---

#### B009-10 — Missing @doc on convert_json_to_changeset/1
**Severity:** INFO
**File:** `lib/api_server/vx/vx_fleet.ex`, line 19

The public function `convert_json_to_changeset/1` has no `@doc`. The function accepts a raw JSON-decoded map and produces a plain map suitable for passing to `changeset/2`. The expected input keys (`"name"`, `"color"`, `"type"`, `"show_in_filters"`) and the return type (plain map, not `Ecto.Changeset`) are undocumented.

---

#### B009-11 — Missing @doc on changeset/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_fleet.ex`, line 27

The public function `changeset/2` has no `@doc` and no `@doc false`. Unlike the analogous `changeset/2` functions in `VXAblRecord` and `VXCustomer` (which explicitly suppress documentation with `@doc false`), this function is fully exposed with no annotation. The permitted fields (`:aaedesc`, `:aaecolour`, `:aaetype`, `:aaeshowfilter`) and the required field (`:aaedesc`) are not described.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B009-1 | LOW | `vx_abl_record.ex` | Missing `@moduledoc` in `VXAblRecord` |
| B009-2 | INFO | `vx_abl_record.ex:31` | Missing `@doc` on `generate_service/10` |
| B009-3 | INFO | `vx_abl_record.ex:54` | Missing `@doc` on `clean_xml_value/1` |
| B009-4 | INFO | `vx_abl_record.ex:63` | Missing `@doc` on `clean_xml_number_value/1` |
| B009-5 | INFO | `vx_abl_record.ex:72` | Missing `@doc` on `expand_xml_to_struct/1` |
| B009-6 | LOW | `vx_access_fob.ex:4` | Missing `@moduledoc` in `VXAccessFob` |
| B009-7 | LOW | `vx_customer.ex:1` | Missing `@moduledoc` in `VXCustomer` |
| B009-8 | INFO | `vx_customer.ex:25` | Missing `@doc` on `convert_json_to_changeset/1` |
| B009-9 | LOW | `vx_fleet.ex:1` | Missing `@moduledoc` in `VXFleet` |
| B009-10 | INFO | `vx_fleet.ex:19` | Missing `@doc` on `convert_json_to_changeset/1` |
| B009-11 | INFO | `vx_fleet.ex:27` | Missing `@doc` on `changeset/2` (no `@doc false` suppression either) |

<!-- B010.md -->
# Pass 3: Documentation — B010
**Agent:** B010
**Files:**
- `lib/api_server/vx/vx_fleet_association.ex`
- `lib/api_server/vx/vx_rayven_message_log.ex`
- `lib/api_server/vx/vx_rayven_stream_status.ex`
- `lib/api_server/vx/vx_rental.ex`

**Date:** 2026-02-27

---

## vx_fleet_association.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXFleetAssociation`

**Public functions:** None (schema-only module; no explicitly defined public functions beyond those injected by `use Ecto.Schema`).

**Types / constants / schema:**
- Schema `"aaf_groups_things"` with primary key `aafid`
- Fields: `aafcustcode` (`:string`)
- Associations: `belongs_to :fleet` (`VXFleet`, FK `aafgroupid`), `belongs_to :thing` (`VXThing`, FK `aafthingid`)

### Findings

#### B010-1 — Missing @moduledoc in VXFleetAssociation
**Severity:** LOW
**File:** `lib/api_server/vx/vx_fleet_association.ex`, line 4

The module `ApiServer.Vx.VXFleetAssociation` has no `@moduledoc` attribute. There is no description of its purpose (join table between fleet groups and things), the underlying database table (`aaf_groups_things`), or the meaning of the foreign key fields (`aafgroupid`, `aafthingid`). Standard Elixir convention requires at minimum `@moduledoc false` for intentionally undocumented modules.

---

## vx_rayven_message_log.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXRayvenMessageLog`

**Public functions:**
| Function | Line |
|---|---|
| `changeset/2` | 16 |

**Types / constants / schema:**
- Schema `"rayven_message_log"` with primary key `message_id`
- Fields: `message_direction` (`:string`), `message_type` (`:string`), `hardware_id` (`:integer`), `event_id` (`:integer`), `response` (`:string`), `message` (`:string`), `created` (`:utc_datetime`)

### Findings

#### B010-2 — Missing @moduledoc in VXRayvenMessageLog
**Severity:** LOW
**File:** `lib/api_server/vx/vx_rayven_message_log.ex`, line 1

The module `ApiServer.Vx.VXRayvenMessageLog` has no `@moduledoc` attribute. There is no description of the purpose of the message log schema, the database table (`rayven_message_log`), the expected values for `message_direction` or `message_type`, or the relationship between `hardware_id` and `event_id`.

#### B010-3 — Missing @doc on changeset/2 in VXRayvenMessageLog
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rayven_message_log.ex`, line 16

The public function `changeset/2` has no `@doc` attribute. There is no description of accepted attributes, return value, or any validation logic applied. Note that the cast does not include the `created` field, which is notable behaviour worth documenting (it implies `created` is managed outside of the changeset, e.g. set by the database).

---

## vx_rayven_stream_status.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXRayvenStreamStatus`

**Public functions:**
| Function | Line |
|---|---|
| `changeset/2` | 17 |

**Types / constants / schema:**
- Schema `"rayven_stream_status"` with primary key `id`
- Fields: `thing_id` (`:integer`), `hardware_id` (`:integer`), `last_event` (`:integer`), `last_event_time` (`:utc_datetime`), `streamed_at` (`:utc_datetime`), `delay` (`:integer`), `num_remaining` (`:integer`), `batch` (`:integer`)

### Findings

#### B010-4 — Missing @moduledoc in VXRayvenStreamStatus
**Severity:** LOW
**File:** `lib/api_server/vx/vx_rayven_stream_status.ex`, line 1

The module `ApiServer.Vx.VXRayvenStreamStatus` has no `@moduledoc` attribute. There is no description of what "stream status" represents in the Rayven integration context, the semantics of fields such as `delay`, `num_remaining`, and `batch`, or how `thing_id` and `hardware_id` relate to each other.

#### B010-5 — Missing @doc on changeset/2 in VXRayvenStreamStatus
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rayven_stream_status.ex`, line 17

The public function `changeset/2` has no `@doc` attribute. There is no description of the accepted attributes, return type, or any validation or constraint logic. The `cast/3` call permits all eight schema fields, which is not validated further.

---

## vx_rental.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXRental`

**Public functions:**
| Function | Line |
|---|---|
| `get_all_anniversaries_between_dates/4` | 24 |
| `get_current_rental_period_start/2` | 112 |
| `calculate_period_end_date/3` | 119 |
| `has_anniversary_on_day?/3` | 146 |
| `changeset/2` | 158 |
| `generate_previous_period_anniversay/3` | 246 |

**Private functions:**
| Function | Line |
|---|---|
| `get_all_subsequent_anniversaries/5` | 77 |
| `generate_next_period_anniversay/3` | 176 |
| `calculate_period_start_date/3` | 468 |

**Types / constants / schema:**
- Schema `"abh_rentals"` with primary key `abhid`
- Fields: `abhcustcode`, `abhclient`, `abhstartdate` (`:date`), `abhenddate` (`:date`), `abhtransdate` (`:utc_datetime`), `abhnotes`, `abhrental_freq`, `abhallowed_hours` (`:integer`), `abhreport_freq`, `abhcustomerid` (`:integer`), `period_calculation`
- Associations: `has_one :customer` (`VXCustomer`), `belongs_to :thing` (`VXThing`, FK `abhthingid`)
- Recognised `abhrental_freq` values (by implementation): `"28DAY"`, `"MONTHLY"`, `"OTHER"`, `"WEEKLY"`, `"DAILY"`, `"OUT OF CONTRACT"` (default: weekly behaviour)
- Recognised `period_calculation` values (by implementation): `"CALENDAR"`, `"CONTRACT"`

### Findings

#### B010-6 — Missing @moduledoc in VXRental
**Severity:** LOW
**File:** `lib/api_server/vx/vx_rental.ex`, line 1

The module `ApiServer.Vx.VXRental` has no `@moduledoc` attribute. This is the most functionally complex schema module in the batch; it contains non-trivial period-calculation logic across six rental frequency types and two period-calculation modes (`CALENDAR` / `CONTRACT`). The absence of any module-level documentation makes it significantly harder to understand the domain model, the valid enum values for `abhrental_freq` and `period_calculation`, and the overall intent of the anniversary/period calculations.

#### B010-7 — Missing @doc on get_all_anniversaries_between_dates/4
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 24

The public function `get_all_anniversaries_between_dates/4` has no `@doc` attribute. The function signature `(rental, to_date, from_date, user_timezone)` accepts date strings for `to_date` and `from_date` (parsed via `Date.from_iso8601!`) and a timezone string. The return value is a list of anniversary datetimes. The argument order is unusual (`to_date` before `from_date`) and the distinct `CALENDAR` vs non-`CALENDAR` code paths are undocumented. Without `@doc`, callers have no guidance on the expected string format, timezone format, or return type.

#### B010-8 — Missing @doc on get_current_rental_period_start/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 112

The public function `get_current_rental_period_start/2` has no `@doc` attribute. It returns the start of the current rental period for "now" in the given `user_timezone`. There is no documentation of the return type (a Timex datetime) or how it interacts with the rental's frequency and period calculation mode.

#### B010-9 — Missing @doc on calculate_period_end_date/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 119

The public function `calculate_period_end_date/3` has no `@doc` attribute. It takes a `period_start_datetime`, a `rental` struct, and a `user_timezone`, and returns a shifted datetime representing the end of the period. The `user_timezone` parameter is accepted but not used within the function body, which is a documentation gap as well as a latent code issue. Valid `abhrental_freq` values and default fallback behaviour are undocumented.

#### B010-10 — Missing @doc on has_anniversary_on_day?/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 146

The public function `has_anniversary_on_day?/3` has no `@doc` attribute. It returns a boolean indicating whether a rental period starts on a given `day_to_test`. The type expected for `day_to_test` (a Timex datetime) and the return type (`true` | `false`) are undocumented.

#### B010-11 — Missing @doc on changeset/2 in VXRental
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 158

The public function `changeset/2` has no `@doc` attribute. The cast permits `:abhid` explicitly (the primary key), which is atypical and may allow callers to supply or overwrite the primary key. This behaviour is undocumented and potentially unintentional.

#### B010-12 — Missing @doc on generate_previous_period_anniversay/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 246

The public function `generate_previous_period_anniversay/3` (note: typo "anniversay" in the function name) has no `@doc` attribute. This is the most complex public function in the module, spanning approximately 220 lines and containing intricate branching across frequency types, calendar modes, and contract boundary conditions. The absence of `@doc` leaves callers without any description of arguments, return value, nil-return semantics, or the interaction between `period_calculation` and `abhrental_freq`.

#### B010-13 — Inaccurate/misleading parameter order in get_all_anniversaries_between_dates/4
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_rental.ex`, line 24

The function signature is `get_all_anniversaries_between_dates(rental, to_date, from_date, user_timezone)`, placing `to_date` before `from_date`. This is the reverse of the conventional `(from, to)` ordering used elsewhere in Elixir/Timex APIs. While there is no `@doc` to be factually inaccurate against, the naming creates a documentation/API contract risk: callers reading only the function signature are likely to supply the arguments in the wrong order. The internal usage (`NaiveDateTime.new(Date.from_iso8601!(to_date), ~T[23:59:59.001])` and `NaiveDateTime.new(Date.from_iso8601!(from_date), ~T[00:00:01.001])`) confirms `to_date` is used as the upper bound and `from_date` as the lower bound. The inverted naming is a documentation defect.

#### B010-14 — Typo in public function name generate_previous_period_anniversay/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 246

The public function is named `generate_previous_period_anniversay` (missing the letter "r" — should be `anniversary`). Because this is a public function it forms part of the module's public API. The name is part of the documentation contract. Renaming it would be a breaking change, but it should at minimum be flagged so that a deprecation path can be planned and the intent documented via `@doc`.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B010-1 | LOW | vx_fleet_association.ex:4 | Missing @moduledoc in VXFleetAssociation |
| B010-2 | LOW | vx_rayven_message_log.ex:1 | Missing @moduledoc in VXRayvenMessageLog |
| B010-3 | INFO | vx_rayven_message_log.ex:16 | Missing @doc on changeset/2 in VXRayvenMessageLog |
| B010-4 | LOW | vx_rayven_stream_status.ex:1 | Missing @moduledoc in VXRayvenStreamStatus |
| B010-5 | INFO | vx_rayven_stream_status.ex:17 | Missing @doc on changeset/2 in VXRayvenStreamStatus |
| B010-6 | LOW | vx_rental.ex:1 | Missing @moduledoc in VXRental |
| B010-7 | INFO | vx_rental.ex:24 | Missing @doc on get_all_anniversaries_between_dates/4 |
| B010-8 | INFO | vx_rental.ex:112 | Missing @doc on get_current_rental_period_start/2 |
| B010-9 | INFO | vx_rental.ex:119 | Missing @doc on calculate_period_end_date/3 |
| B010-10 | INFO | vx_rental.ex:146 | Missing @doc on has_anniversary_on_day?/3 |
| B010-11 | INFO | vx_rental.ex:158 | Missing @doc on changeset/2 in VXRental |
| B010-12 | INFO | vx_rental.ex:246 | Missing @doc on generate_previous_period_anniversay/3 |
| B010-13 | MEDIUM | vx_rental.ex:24 | Inverted parameter order (to_date before from_date) is misleading API contract |
| B010-14 | INFO | vx_rental.ex:246 | Typo in public function name: "anniversay" should be "anniversary" |

<!-- B011.md -->
# Pass 3: Documentation — B011
**Agent:** B011
**Files:**
- `lib/api_server/vx/vx_restriction.ex`
- `lib/api_server/vx/vx_thing.ex`
- `lib/api_server/vx/vx_thing_event.ex`
- `lib/api_server/vx/vx_thing_event_omega.ex`

**Date:** 2026-02-27

---

## lib/api_server/vx/vx_restriction.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXRestriction`

**Schema:** `aau_rest` table, primary key `aauid` (autogenerate: true)

**Fields defined via schema:** `:aaucharval` (string), `:aaucustcode` (string), `:aaufun` (string), `:aaunumval` (integer); belongs_to `:user` (`ApiServer.Vx.VXUser`, foreign key `:aauuser_id`, references `:aacid`)

**Types / constants / errors:** None defined explicitly.

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 16 |

**Documentation annotations present:**
- No `@moduledoc`
- `changeset/2` has `@doc false` (intentionally suppressed)

### Findings

#### B011-1 — Missing @moduledoc in VXRestriction
**Severity:** LOW
**File:** `lib/api_server/vx/vx_restriction.ex`, line 1

The module `ApiServer.Vx.VXRestriction` has no `@moduledoc` attribute. There is no description of the schema's purpose, the `aau_rest` table it maps to, the domain concept (user access restrictions), or the meaning of the fields (`aaufun`, `aaucustcode`, `aaucharval`, `aaunumval`).

---

## lib/api_server/vx/vx_thing.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXThing`

**Schema:** `aad_thing` table, primary key `aadid` (autogenerate: true)

**Fields defined via schema:** `:aadcustcode`, `:aaddesc`, `:aadintext`, `:aadaddr`, `:aadcustomerid`, `:aadcat`, `:aadhardwareid`, `:aadhw_type`, `:aadmake`, `:aadmodel`, `:aadserialno`, `:aadmobile`, `:aadimei`, `:aadhourmeter` through `:aadhourmeter4`, `:aadhourmeterprnt`, `:aadodometer`, `:aadhourmeteromega`, `:aadhourmeterothcan`, `:aaddateintoservice`, `:aadlastservice`, `:aadvalid`, `:aadserviceoffset`, `:aadsvchrs`, `:aadrange_lat`, `:aadrange_long`, `:aadrange_dist`, `:aadrange_unit`, `:service_calculation_input`, `:reference_1`, `:reference_2`, `:reference_3`, `:notes`, `:equipment_date_into_service`

**Associations:** `has_many :fleet_thing_joins`, `has_many :rentals`, `has_many :events`, `has_one :summary`, `has_one :info`, `has_one :customer`

**Types / constants / errors:** None defined explicitly.

**Public functions:**

| Function | Line |
|---|---|
| `convert_json_to_changeset/1` | 60 |
| `changeset/2` | 75 |

**Documentation annotations present:**
- No `@moduledoc`
- No `@doc` on `convert_json_to_changeset/1`
- No `@doc` on `changeset/2`

### Findings

#### B011-2 — Missing @moduledoc in VXThing
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing.ex`, line 5

The module `ApiServer.Vx.VXThing` has no `@moduledoc` attribute. There is no description of the schema's purpose, the `aad_thing` table it represents, the domain concept (a tracked asset / "thing"), or the meaning of the many fields (hourmeter variants, odometer, service intervals, geofencing range fields, etc.).

#### B011-3 — Missing @doc on VXThing.convert_json_to_changeset/1
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing.ex`, line 60

The public function `convert_json_to_changeset/1` has no `@doc` attribute. It converts an incoming JSON map (using string keys such as `"name"`, `"hardwareid"`, `"make"`, `"model"`, `"serialno"`, `"address"`, `"service_interval"`, `"service_offset"`, `"custcode"`, `"lastservice"`, `"current_hour_meter"`) into an Ecto changeset attribute map via `Vx.update_key_if_value/3`. The mapping from JSON key names to internal schema atoms, and the fact that missing/nil values are skipped, is not documented.

#### B011-4 — Missing @doc on VXThing.changeset/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing.ex`, line 75

The public function `changeset/2` has no `@doc` attribute. It accepts a `VXThing` struct and an attribute map, casts a specific subset of fields (`:aadcat`, `:aadhw_type`, `:aadhardwareid`, `:aadcustcode`, `:aaddesc`, `:aadmake`, `:aadmodel`, `:aadserialno`, `:aadaddr`, `:aadsvchrs`, `:aadserviceoffset`, `:aadlastservice`), and applies no `validate_required/2` call — which is noteworthy absence given the breadth of fields. None of this is documented.

---

## lib/api_server/vx/vx_thing_event.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXThingEvent`

**Schema:** `thingevents` table, default primary key (`:id`)

**Fields defined via schema:** `:gmtdatetime`, `:hardwareid`, `:eventtype`, `:eventcode`, `:latitude`, `:longitude`, `:driverid`, `:engineonelapsed`, `:totalengineseconds`, `:custcode`, `:hardwaretype`, `:datetimesaved`, `:dateinqueue`, `:timeoffix`, `:altitude`, `:heading`, `:speed`, `:rssi`, `:gpsfixquality`, `:odometer`, `:mifaredriverid`, `:ignition`, `:ignitionstatus`, `:calcengineseconds`, `:input1elapsed` through `:input4elapsed` and related status/totalseconds/calctotalseconds fields, `:prntelapsed`, `:prntstatus`, `:prnttotalseconds`, `:prntcalctotalseconds`, `:rhmprestartchecklist`, `:geofence`

**Associations:** `has_one :thingeventomega` (`VXThingEventOmega`, foreign_key `:id`, references `:id`); `belongs_to :thing` (`VXThing`, foreign_key `:hardwareid`, references `:aadhardwareid`, define_field: false)

**Types / constants / errors:** None defined explicitly.

**Public functions:**

| Function | Line |
|---|---|
| `map_xml/1` | 71 |
| `changeset/2` | 111 |

**Documentation annotations present:**
- No `@moduledoc`
- No `@doc` on `map_xml/1`
- `changeset/2` has `@doc false` (intentionally suppressed)

**Notes:** Lines 63–69 contain commented-out fields that were never mapped (`MotionTotalElapsed`, `containerLiftCount`, `input1Flag`, `ioFlagStatus`, `prestartChecklist`, `totalEngineHour`, `totalInput1Hour`). Lines 103–106 contain commented-out struct keys with inline explanations noting they require the thing record — these represent silent data gaps with no runtime error.

### Findings

#### B011-5 — Missing @moduledoc in VXThingEvent
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event.ex`, line 1

The module `ApiServer.Vx.VXThingEvent` has no `@moduledoc` attribute. There is no description of the schema's purpose, the `thingevents` table it maps to, the telemetry event domain model it represents, or the significance of the many input channel fields, the commented-out unmapped fields, or the relationship to `VXThingEventOmega`.

#### B011-6 — Missing @doc on VXThingEvent.map_xml/1
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_event.ex`, line 71

The public function `map_xml/1` has no `@doc` attribute. Despite its name suggesting XML, it actually accepts a plain map with string keys (as produced by XML-to-map parsing) and converts it to an Ecto-compatible atom-keyed map. The function performs several `String.to_integer/1` and `String.to_float/1` conversions that will raise `ArgumentError` if source strings are missing or malformed. It also explicitly omits several fields (`driverid` as struct key, `mifaredriverid`, `calcengineseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`) with inline comments explaining why — none of which is captured in documentation. The hardcoded empty strings for `[REDACTED-AWS-SMTP-PASSWORD]` and `geofence` are also undocumented.

---

## lib/api_server/vx/vx_thing_event_omega.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXThingEventOmega`

**Schema:** `thingomega` table, default primary key (`:id`)

**Fields defined via schema (68 fields):** `:accelerometerx`, `:accelerometery`, `:accelerometerz`, `:distancesincelastevent`, `:omegadriverid`, `:seatbelt`, `:seated`, `:parkbrakerequest`, `:parkbreakreleased`, `:vehicleload`, `:tilt`, `:height`, `:overload`, `:attretracted`, `:yellowled`, `:redled`, `:greenled`, `:liftenable`, `:safetyoverride`, `:doorclosed`, `:parkbrakerror`, `:batterynotcharged`, `:lowengineoil`, `:accnotcharged`, `:hydraulicfilgerblocked`, `:airfilterblocked`, `:attpressure`, `:oilcoolerfan`, `:lowerinterruption`, `:undersafetyheight`, `:joystickliftposition`, `:hydraulicoiltemperature`, `:md3temperature`, `:fuellevel`, `:md3status`, `:xa2status`, `:batteryvoltage`, `:xa2temperature`, `:boomangle`, `:boomextension`, `:lift`, `:extension`, `:totalfuelconsumption`, `:fuelrate`, `:totalfuelidle`, `:totalidlehour`, `:totalenginehour`, `:enginerpm`, `:capacity`, `:coolanttemperature`, `:oiltemperature`, `:engineerrorcode`, `:vehiclespeed`, `:gearselection`, `:transerrorcode`, `:prestartchecklist`, `:truckerrorcode`, `:mc43status`, `:mc43temperature`, `:lc5status`, `:lc5temperature`, `:truckangle`

**Associations:** `belongs_to :thingevent` (`VXThingEvent`, foreign_key `:id`, references `:id`, primary_key: true, define_field: false)

**Types / constants / errors:** None defined explicitly.

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 72 |

**Documentation annotations present:**
- No `@moduledoc`
- No `@doc` on `changeset/2` (not even `@doc false`)

### Findings

#### B011-7 — Missing @moduledoc in VXThingEventOmega
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event_omega.ex`, line 1

The module `ApiServer.Vx.VXThingEventOmega` has no `@moduledoc` attribute. There is no description of the schema's purpose, the `thingomega` table it maps to, what "Omega" signifies (extended telemetry data from specialised hardware such as aerial work platforms/forklifts), or the meaning of the domain-specific fields (seatbelt, tilt, height, overload, LED states, hydraulic sensors, CAN-bus data). Note also the likely typo `:hydraulicfilgerblocked` (should be `filterblocked`) and `:parkbreakreleased` (should be `brakerealeased`) — undocumented fields with misspelled names are especially high risk as they cannot be corrected without a migration.

#### B011-8 — Missing @doc on VXThingEventOmega.changeset/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_event_omega.ex`, line 72

The public function `changeset/2` has no `@doc` attribute (and unlike the similar function in `VXRestriction` and `VXThingEvent`, it also lacks `@doc false`). The function casts all 63 fields listed in a dense single-line invocation and requires only `:id`. The absence of any required fields beyond `:id` and the choice of which fields to include/exclude from the cast list is entirely undocumented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B011-1 | LOW | `vx_restriction.ex` | Missing `@moduledoc` in `ApiServer.Vx.VXRestriction` |
| B011-2 | LOW | `vx_thing.ex` | Missing `@moduledoc` in `ApiServer.Vx.VXThing` |
| B011-3 | INFO | `vx_thing.ex`, line 60 | Missing `@doc` on `VXThing.convert_json_to_changeset/1` |
| B011-4 | INFO | `vx_thing.ex`, line 75 | Missing `@doc` on `VXThing.changeset/2` |
| B011-5 | LOW | `vx_thing_event.ex` | Missing `@moduledoc` in `ApiServer.Vx.VXThingEvent` |
| B011-6 | INFO | `vx_thing_event.ex`, line 71 | Missing `@doc` on `VXThingEvent.map_xml/1` |
| B011-7 | LOW | `vx_thing_event_omega.ex` | Missing `@moduledoc` in `ApiServer.Vx.VXThingEventOmega` |
| B011-8 | INFO | `vx_thing_event_omega.ex`, line 72 | Missing `@doc` on `VXThingEventOmega.changeset/2` |

<!-- B012.md -->
# Pass 3: Documentation — B012
**Agent:** B012
**Files:**
- `lib/api_server/vx/vx_thing_event_omega_tires.ex`
- `lib/api_server/vx/vx_thing_info.ex`
- `lib/api_server/vx/vx_thing_summary.ex`
- `lib/api_server/vx/vx_user.ex`

**Date:** 2026-02-27

---

## vx_thing_event_omega_tires.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXThingEventOmegaTires`

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 58 |

**Schema:** `thingomegatires` — 48 integer fields covering 6 tyre slots (indices 0–5), each with fields: `pressurewarning`, `pressureleakage`, `temperaturehigh`, `receivetimeout`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `tirepressure`, `temperature`. Belongs to `ApiServer.Vx.VXThingEvent` via `:id`.

**Types/constants defined:** None.

### Findings

#### B012-1 — Missing @moduledoc in VXThingEventOmegaTires
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`, line 1

The module `ApiServer.Vx.VXThingEventOmegaTires` has no `@moduledoc` attribute. There is no description of the module's purpose (Ecto schema for Omega TPMS tyre pressure/temperature event data associated with a thing event), its schema table (`thingomegatires`), or the indexing convention used for the 6 tyre slots (indices 0–5).

#### B012-2 — Missing @doc on changeset/2 in VXThingEventOmegaTires
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`, line 58

The public function `changeset/2` has no `@doc` attribute. The function casts all 48 tyre-sensor fields plus `:id` and validates that `:id` is required, but this behaviour is not documented.

---

## vx_thing_info.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXThingInfo`

**Public functions:**

| Function | Line |
|---|---|
| `getWithHardwareId/2` | 24 |
| `service_performed/3` | 31 |
| `[REDACTED-AWS-SMTP-PASSWORD]` | 47 |
| `make_info_record/2` | 57 |
| `update_existing_record/3` | 74 |

**Schema:** `thing_info` — fields: `averageweeklyusage` (float), `pmnotificationid` (integer), `pmnotificationdate` (date), `[REDACTED-AWS-SMTP-PASSWORD]` (integer). Belongs to `VXThing` via `hardwareid`/`aadhardwareid`.

**Types/constants defined:** None.

**Note:** No `changeset/2` function is defined in this module; changesets are built directly via `Ecto.Changeset.change/2`.

### Findings

#### B012-3 — Missing @moduledoc in VXThingInfo
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 3

The module `ApiServer.Vx.VXThingInfo` has no `@moduledoc` attribute. The module manages preventive-maintenance (PM) notification state and average weekly usage statistics for a hardware device, but none of this context is documented.

#### B012-4 — Missing @doc on getWithHardwareId/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 24

No `@doc` is present. The function fetches the single `VXThingInfo` record for the given `hardwareid` within the tenant schema identified by `customer`. The tenant-scoped query behaviour (Ecto `prefix`) is not documented.

#### B012-5 — Missing @doc on service_performed/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 31

No `@doc` is present. The function clears the PM notification fields (`pmnotificationid`, `pmnotificationdate`) and resets `[REDACTED-AWS-SMTP-PASSWORD]` to `0` when a service event is recorded on or after the existing notification date. The guard condition (`info != nil && info.pmnotificationdate <= new_service_date`) and the side-effect of only acting when the date condition is satisfied are undocumented.

#### B012-6 — Missing @doc on validateForHardwareId/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 47

No `@doc` is present. The function ensures a `VXThingInfo` record exists for the given hardware ID: it creates one if absent (via `make_info_record/2`) or refreshes the calculated fields on the existing record (via `update_existing_record/3`).

#### B012-7 — Missing @doc on make_info_record/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 57

No `@doc` is present. The function inserts a new `VXThingInfo` record using a hardcoded baseline notification date of `2019-01-13` and PM notification ID `12`. The use of a hardcoded magic date and ID is not explained anywhere in the code or documentation.

#### B012-8 — Missing @doc on update_existing_record/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 74

No `@doc` is present. The function recalculates `averageweeklyusage` and, conditionally on whether an active PM notification date exists (> `1970-01-01`), recalculates `[REDACTED-AWS-SMTP-PASSWORD]`. The branching logic and the sentinel date `1970-01-01` are not documented.

---

## vx_thing_summary.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXThingSummary`

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 49 |
| `make_or_update_summary/3` | 56 |
| `validate_for_hardwareid/2` | 138 |
| `is_valid?/2` | 156 |

**Schema:** `abm_summary` (primary key `:abmid`) — 43 fields covering GPS position, ignition state, engine seconds, four hourmeter channels (calc and raw), Omega hourmeter, OTH-CAN hourmeter, odometer, driver IDs, event type/code, and RHMP pre-start checklist fields. Belongs to `ApiServer.Vx.VXThing` via `abmhardwareid`/`aadhardwareid`.

**Types/constants defined:** None.

**Notes:**
- `changeset/2` is annotated `@doc false` (line 48), indicating intentional suppression.
- `validate_for_hardwareid/2` (line 138) contains an unused variable binding `timestamp = Timex.now()` (line 149) that is never referenced.

### Findings

#### B012-9 — Missing @moduledoc in VXThingSummary
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_summary.ex`, line 1

The module `ApiServer.Vx.VXThingSummary` has no `@moduledoc` attribute. The module's role (maintaining a denormalised summary record of the most recent telemetry event for each hardware device, used to avoid querying the full event history on every read) is not described anywhere.

#### B012-10 — Missing @doc on make_or_update_summary/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_summary.ex`, line 56

No `@doc` is present. The function fetches the most recent thing event (preferring one with Omega data), maps its fields onto a summary struct, conditionally merges Omega hourmeter fields, and persists the result. The optional third parameter `existingSummary` defaults to an empty `VXThingSummary` struct for insert scenarios. None of this behaviour is documented.

#### B012-11 — Missing @doc on validate_for_hardwareid/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_summary.ex`, line 138

No `@doc` is present. The function ensures the summary record for the given hardware ID is current: it creates one if absent, and updates it if `is_valid?/2` returns false. The unused variable `timestamp` (line 149) assigned inside the update branch but never consumed is not called out anywhere.

#### B012-12 — Missing @doc on is_valid?/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_summary.ex`, line 156

No `@doc` is present. The function compares five fields between the existing summary record and the most recent thing event (`totalengineseconds`, `input1totalseconds`, `gmtdatetime`, `latitude`, `longitude`) to determine staleness. The choice of these five fields as the validity criteria is not explained.

---

## vx_user.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXUser`

**Public functions:**

| Function | Line |
|---|---|
| `convert_json_to_changeset/1` | 57 |
| `password_changeset/2` | 73 |
| `changeset/2` | 78 |

**Schema:** `aac_user` (primary key `:aacid`) — fields covering user identity, credentials (`aacpassword`, `aacpasswordhash`, `[REDACTED-AWS-SMTP-PASSWORD]`), locale/timezone preferences, licence data (two licence slots), user type, proxy flag, and UI preferences. Associations: `has_one :accessfob`, `has_one :function`, `has_many :assigned_fleets`, `has_many :abl_records`.

**Types/constants defined:** None.

**Notes:**
- `convert_json_to_changeset/1` (line 57) maps `:aacuom` from `user_json["units"]` twice (lines 63 and 67); the duplicate mapping silently overwrites itself with the same value.
- `convert_json_to_changeset/1` (line 70) writes to key `:user_level`, which is not a field defined in the schema; this key will be silently dropped or cause a downstream error.
- `password_changeset/2` casts `:aacpassword` (plaintext) but does not hash it; it is unclear from context whether hashing is applied elsewhere in the call chain.

### Findings

#### B012-13 — Missing @moduledoc in VXUser
**Severity:** LOW
**File:** `lib/api_server/vx/vx_user.ex`, line 4

The module `ApiServer.Vx.VXUser` has no `@moduledoc` attribute. The module defines the Ecto schema and changesets for application users, including sensitive credential fields, but provides no module-level description.

#### B012-14 — Missing @doc on convert_json_to_changeset/1
**Severity:** INFO
**File:** `lib/api_server/vx/vx_user.ex`, line 57

No `@doc` is present. The function translates an incoming JSON map (e.g., from an API request body) into a parameter map suitable for use with `changeset/2`. The expected JSON key names (`"first_name"`, `"last_name"`, `"email"`, etc.), the duplicate `:aacuom` mapping, and the behaviour of the non-schema `:user_level` key are entirely undocumented.

#### B012-15 — Missing @doc on password_changeset/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_user.ex`, line 73

No `@doc` is present. The function casts only `:aacpassword` without any validation, hashing, or confirmation logic. The absence of documentation means it is unclear whether this is intended as a raw-password setter (with hashing handled by a callback or the caller) or whether the lack of hashing is an oversight.

#### B012-16 — Missing @doc on changeset/2 in VXUser
**Severity:** INFO
**File:** `lib/api_server/vx/vx_user.ex`, line 78

No `@doc` is present. The function casts a defined set of user fields, associates the `:function` (user permission level) via `put_assoc/4`, validates `:aacemail` presence and format, and enforces a uniqueness constraint on `:aacuser`. The meaning of `attrs.user_level` and its mapping to `aatfunction_id` is not documented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B012-1 | LOW | vx_thing_event_omega_tires.ex | Missing @moduledoc in VXThingEventOmegaTires |
| B012-2 | INFO | vx_thing_event_omega_tires.ex, line 58 | Missing @doc on changeset/2 |
| B012-3 | LOW | vx_thing_info.ex, line 3 | Missing @moduledoc in VXThingInfo |
| B012-4 | INFO | vx_thing_info.ex, line 24 | Missing @doc on getWithHardwareId/2 |
| B012-5 | INFO | vx_thing_info.ex, line 31 | Missing @doc on service_performed/3 |
| B012-6 | INFO | vx_thing_info.ex, line 47 | Missing @doc on validateForHardwareId/2 |
| B012-7 | INFO | vx_thing_info.ex, line 57 | Missing @doc on make_info_record/2 |
| B012-8 | INFO | vx_thing_info.ex, line 74 | Missing @doc on update_existing_record/3 |
| B012-9 | LOW | vx_thing_summary.ex, line 1 | Missing @moduledoc in VXThingSummary |
| B012-10 | INFO | vx_thing_summary.ex, line 56 | Missing @doc on make_or_update_summary/3 |
| B012-11 | INFO | vx_thing_summary.ex, line 138 | Missing @doc on validate_for_hardwareid/2 |
| B012-12 | INFO | vx_thing_summary.ex, line 156 | Missing @doc on is_valid?/2 |
| B012-13 | LOW | vx_user.ex, line 4 | Missing @moduledoc in VXUser |
| B012-14 | INFO | vx_user.ex, line 57 | Missing @doc on convert_json_to_changeset/1 |
| B012-15 | INFO | vx_user.ex, line 73 | Missing @doc on password_changeset/2 |
| B012-16 | INFO | vx_user.ex, line 78 | Missing @doc on changeset/2 in VXUser |

<!-- B013.md -->
# Pass 3: Documentation — B013
**Agent:** B013
**Files:**
- `lib/api_server_web.ex`
- `lib/api_server_web/auth_error_handler.ex`
- `lib/api_server_web/auth_pipeline.ex`

**Date:** 2026-02-27

---

## lib/api_server_web.ex

### Reading Evidence

**Module:** `ApiServerWeb`

**Public functions:**

| Function | Line |
|---|---|
| `controller/0` | 20 |
| `view/0` | 29 |
| `router/0` | 46 |
| `channel/0` | 54 |
| `__using__/1` (defmacro) | 64 |

**Types / errors / constants defined:** None.

**@moduledoc:** Present (lines 2–18). Describes the module's purpose as the entrypoint for defining web interface components and explains the `use ApiServerWeb, :controller` / `:view` pattern.

**@doc coverage:**
- `controller/0` — no `@doc`
- `view/0` — no `@doc`
- `router/0` — no `@doc`
- `channel/0` — no `@doc`
- `__using__/1` — `@doc` present (lines 61–63): "When used, dispatch to the appropriate controller/view/etc."

---

### Findings

#### B013-1 — Missing @doc on `controller/0`
**Severity:** INFO
**File:** `lib/api_server_web.ex`, line 20

The public function `controller/0` has no `@doc` attribute. It injects `Phoenix.Controller`, `Plug.Conn`, `ApiServerWeb.Router.Helpers`, and `ApiServerWeb.Gettext` into the calling module via a `quote` block. A doc string explaining what is imported would aid developers using `use ApiServerWeb, :controller`.

---

#### B013-2 — Missing @doc on `view/0`
**Severity:** INFO
**File:** `lib/api_server_web.ex`, line 29

The public function `view/0` has no `@doc` attribute. It configures `Phoenix.View` with a template root, imports flash/view helpers, enables `Phoenix.HTML`, and imports router helpers, error helpers, and Gettext. A doc string should describe these injected dependencies.

---

#### B013-3 — Missing @doc on `router/0`
**Severity:** INFO
**File:** `lib/api_server_web.ex`, line 46

The public function `router/0` has no `@doc` attribute. It injects `Phoenix.Router`, `Plug.Conn`, and `Phoenix.Controller`. A brief doc string would clarify what is available in a module that does `use ApiServerWeb, :router`.

---

#### B013-4 — Missing @doc on `channel/0`
**Severity:** INFO
**File:** `lib/api_server_web.ex`, line 54

The public function `channel/0` has no `@doc` attribute. It injects `Phoenix.Channel` and `ApiServerWeb.Gettext`. A doc string noting these injected modules would be consistent with the pattern established for `__using__/1`.

---

## lib/api_server_web/auth_error_handler.ex

### Reading Evidence

**Module:** `ApiServerWeb.AuthErrorHandler`

**Public functions:**

| Function | Line |
|---|---|
| `auth_error/3` | 4 |

**Types / errors / constants defined:** None.

**@moduledoc:** Absent.

**@doc coverage:**
- `auth_error/3` — no `@doc`

---

### Findings

#### B013-5 — Missing @moduledoc on `ApiServerWeb.AuthErrorHandler`
**Severity:** LOW
**File:** `lib/api_server_web/auth_error_handler.ex`, line 1

The module `ApiServerWeb.AuthErrorHandler` has no `@moduledoc` attribute. The module implements the Guardian error handler behaviour, responding with an HTTP 401 and a JSON body containing the error type on authentication failure. A module-level doc should describe this contract and the expected caller (Guardian pipeline configuration).

---

#### B013-6 — Missing @doc on `auth_error/3`
**Severity:** INFO
**File:** `lib/api_server_web/auth_error_handler.ex`, line 4

The public function `auth_error/3` has no `@doc` attribute. It encodes a JSON error body using `Poison.encode!/1` and sends a 401 response via `Plug.Conn.send_resp/3`. The Guardian `error_handler` behaviour requires this callback signature `(conn, {type, reason}, opts)`. A doc string should describe the callback contract, the response format (`{"error": "<type>"}` as JSON), and note that `reason` is intentionally discarded.

---

## lib/api_server_web/auth_pipeline.ex

### Reading Evidence

**Module:** `ApiServer.Guardian.AuthPipeline`

**Public functions:** None. The module is a Guardian plug pipeline defined entirely via `use Guardian.Plug.Pipeline` and `plug` macro calls. No explicit function definitions are present.

**Plugs declared:**

| Plug | Line | Notes |
|---|---|---|
| `Guardian.Plug.VerifyHeader` | 6 | `realm: "Bearer"` — verifies JWT in `Authorization: Bearer <token>` header |
| `Guardian.Plug.EnsureAuthenticated` | 7 | Commented out — authentication enforcement is disabled |
| `Guardian.Plug.LoadResource` | 8 | Loads the resource identified by the token claims |

**Types / errors / constants defined:** None.

**@moduledoc:** Absent.

**@doc coverage:** N/A (no public functions defined).

---

### Findings

#### B013-7 — Missing @moduledoc on `ApiServer.Guardian.AuthPipeline`
**Severity:** LOW
**File:** `lib/api_server_web/auth_pipeline.ex`, line 1

The module `ApiServer.Guardian.AuthPipeline` has no `@moduledoc` attribute. A module doc should describe the pipeline's purpose, the OTP app it is registered under (`:MyApi`), the Guardian module it delegates to (`ApiServer.Guardian`), the error handler in use (`ApiServerWeb.AuthErrorHandler`), and — critically — should document the fact that `Guardian.Plug.EnsureAuthenticated` is currently commented out (line 7), meaning authenticated routes relying solely on this pipeline do NOT enforce authentication. The absence of any documentation makes this security-relevant omission invisible to reviewers.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B013-1 | INFO | `lib/api_server_web.ex`:20 | Missing `@doc` on `controller/0` |
| B013-2 | INFO | `lib/api_server_web.ex`:29 | Missing `@doc` on `view/0` |
| B013-3 | INFO | `lib/api_server_web.ex`:46 | Missing `@doc` on `router/0` |
| B013-4 | INFO | `lib/api_server_web.ex`:54 | Missing `@doc` on `channel/0` |
| B013-5 | LOW | `lib/api_server_web/auth_error_handler.ex`:1 | Missing `@moduledoc` on `ApiServerWeb.AuthErrorHandler` |
| B013-6 | INFO | `lib/api_server_web/auth_error_handler.ex`:4 | Missing `@doc` on `auth_error/3` |
| B013-7 | LOW | `lib/api_server_web/auth_pipeline.ex`:1 | Missing `@moduledoc` on `ApiServer.Guardian.AuthPipeline`; no documentation of the commented-out `EnsureAuthenticated` plug |

<!-- B014.md -->
# Pass 3: Documentation — B014
**Agent:** B014
**Files:**
- `lib/api_server_web/channels/user_socket.ex`
- `lib/api_server_web/endpoint.ex`
- `lib/api_server_web/gettext.ex`
- `lib/api_server_web/xml_plug.ex`

**Date:** 2026-02-27

---

## user_socket.ex

### Reading Evidence

- **Module:** `ApiServerWeb.UserSocket`
- **Public functions:**
  - `connect/2` — line 22
  - `id/1` — line 36
- **Types / errors / constants defined:** none
- **`@moduledoc`:** absent
- **`@doc` annotations:** none on either public function

### Findings

#### B014-1 — Missing @moduledoc in ApiServerWeb.UserSocket
**Severity:** LOW
**File:** `lib/api_server_web/channels/user_socket.ex`, line 1

The module `ApiServerWeb.UserSocket` has no `@moduledoc`. There is no high-level description of the socket's purpose, what transports it exposes, or the authentication/authorisation model in force (the current implementation accepts all connections without any verification via `connect/2`). That last point is particularly important context for readers.

---

#### B014-2 — Missing @doc on ApiServerWeb.UserSocket.connect/2
**Severity:** INFO
**File:** `lib/api_server_web/channels/user_socket.ex`, line 22

`connect/2` is a public Phoenix.Socket callback with no `@doc`. The inline comments above the function (lines 11-21) describe the general Phoenix pattern but do not constitute `@doc` and will not appear in generated documentation. The doc should state that all connections are currently accepted unconditionally (returning `{:ok, socket}` for any params) and describe expected params and return values.

---

#### B014-3 — Missing @doc on ApiServerWeb.UserSocket.id/1
**Severity:** INFO
**File:** `lib/api_server_web/channels/user_socket.ex`, line 36

`id/1` is a public Phoenix.Socket callback with no `@doc`. The inline comments above (lines 26-35) describe what a non-nil implementation would do but do not constitute `@doc`. The doc should state that the implementation always returns `nil`, making every socket anonymous, and explain the consequence: targeted broadcast/disconnect by user is not supported.

---

## endpoint.ex

### Reading Evidence

- **Module:** `ApiServerWeb.Endpoint`
- **Public functions:**
  - `init/2` — line 51
- **Types / errors / constants defined:** none
- **`@moduledoc`:** absent
- **`@doc` annotations:** `@doc` present on `init/2` (lines 45-50)
- **Plug pipeline (not functions, but architecturally significant):**
  - `Plug.Static` (line 10)
  - `Phoenix.LiveReloader.Socket`, `Phoenix.LiveReloader`, `Phoenix.CodeReloader` (lines 17-19, dev only)
  - `Plug.Logger` (line 22)
  - `Plug.Parsers` with `:urlencoded`, `:multipart`, `:json`, `:xml`, `Absinthe.Plug.Parser` (line 24-28)
  - `Plug.MethodOverride` (line 30)
  - `Plug.Head` (line 31)
  - `Plug.Session` (line 36)
  - `CORSPlug` (line 42)
  - `ApiServerWeb.Router` (line 43)

### Findings

#### B014-4 — Missing @moduledoc in ApiServerWeb.Endpoint
**Severity:** LOW
**File:** `lib/api_server_web/endpoint.ex`, line 1

The module `ApiServerWeb.Endpoint` has no `@moduledoc`. There is no description of the plug pipeline, the socket mount point, or any environment-specific behaviour (e.g. the code-reloader being active only when `code_reloading?` is true). A module-level doc would help developers understand the full request lifecycle and the security-relevant middleware ordering.

---

#### B014-5 — @doc on init/2 is inaccurate: omits non-system-env branch behaviour
**Severity:** MEDIUM
**File:** `lib/api_server_web/endpoint.ex`, lines 45-58

The existing `@doc` for `init/2` states the function "checks if configuration should be loaded from the system environment" but does not document the non-system-env branch. When `config[:load_from_system_env]` is falsy the function returns `{:ok, config}` unchanged; this is a meaningful code path that is silently omitted from the doc. Additionally, the `@doc` does not mention that a missing `PORT` environment variable raises a runtime error (`raise "expected the PORT environment variable to be set"`), which is important operational information.

The `@doc` also describes the first parameter as `_key` without explaining what the `key` argument represents in the Phoenix endpoint `init/2` callback (it is the `:start_link` or `:call` atom). No `@spec` is present.

---

## gettext.ex

### Reading Evidence

- **Module:** `ApiServerWeb.Gettext`
- **Public functions:** none defined explicitly; all public API is injected by `use Gettext, otp_app: :api_server` (macros `gettext/1`, `ngettext/3`, `dgettext/3`, etc.)
- **Types / errors / constants defined:** none
- **`@moduledoc`:** present (lines 2-22)

### Findings

No documentation findings. The module has a `@moduledoc` that accurately describes the injected Gettext API with examples. No explicitly defined public functions require `@doc` annotations.

---

## xml_plug.ex

### Reading Evidence

- **Module:** `Plug.Parsers.XML`
- **Behaviour:** `Plug.Parsers`
- **Public functions:**
  - `parse/5` (XML content-type clause) — line 6
  - `parse/5` (catch-all clause) — line 13
- **Private functions:**
  - `decode/2` — line 17
- **Types / errors / constants defined:** none
- **`@moduledoc`:** absent
- **`@doc` annotations:** none on either public function clause

### Findings

#### B014-6 — Missing @moduledoc in Plug.Parsers.XML
**Severity:** LOW
**File:** `lib/api_server_web/xml_plug.ex`, line 1

The module `Plug.Parsers.XML` has no `@moduledoc`. There is no description of the module's purpose (a custom Plug.Parsers behaviour implementation for XML bodies), the required `:xml_decoder` option, the output structure placed into `conn.params` (`%{xml: map}`), or the error behaviour on malformed XML.

---

#### B014-7 — Missing @doc on Plug.Parsers.XML.parse/5 (XML clause)
**Severity:** INFO
**File:** `lib/api_server_web/xml_plug.ex`, line 6

The XML-matching clause of `parse/5` has no `@doc`. The doc should state: the function matches when the content subtype is `"xml"`, requires an `:xml_decoder` key in `opts` (raises `ArgumentError` if absent), reads the request body, converts it to a map via `XmlToMap.naive_map/1`, and places the result under the `:xml` key in `conn.params`. It should also note that malformed XML raises `Plug.Parsers.ParseError`.

Note: the `:xml_decoder` option is fetched from `opts` at line 7 but is not actually passed to the decoder — `XmlToMap.naive_map/1` is called directly in `decode/2` without using the configured decoder value. This is a functional inconsistency that a `@doc` describing expected behaviour would expose immediately.

---

#### B014-8 — Missing @doc on Plug.Parsers.XML.parse/5 (catch-all clause)
**Severity:** INFO
**File:** `lib/api_server_web/xml_plug.ex`, line 13

The catch-all clause of `parse/5` has no `@doc`. The doc should state that for any content type other than `*/xml` the function returns `{:next, conn}` to delegate to the next parser in the pipeline.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B014-1 | LOW | `user_socket.ex:1` | Missing `@moduledoc` in `ApiServerWeb.UserSocket` |
| B014-2 | INFO | `user_socket.ex:22` | Missing `@doc` on `connect/2` |
| B014-3 | INFO | `user_socket.ex:36` | Missing `@doc` on `id/1` |
| B014-4 | LOW | `endpoint.ex:1` | Missing `@moduledoc` in `ApiServerWeb.Endpoint` |
| B014-5 | MEDIUM | `endpoint.ex:45` | `@doc` on `init/2` is inaccurate: omits non-system-env branch and runtime raise on missing PORT |
| B014-6 | LOW | `xml_plug.ex:1` | Missing `@moduledoc` in `Plug.Parsers.XML` |
| B014-7 | INFO | `xml_plug.ex:6` | Missing `@doc` on `parse/5` (XML clause) |
| B014-8 | INFO | `xml_plug.ex:13` | Missing `@doc` on `parse/5` (catch-all clause) |

<!-- B015.md -->
# Pass 3: Documentation — B015
**Agent:** B015
**Files:**
- `lib/api_server_web/controllers/calamp_controller.ex`
- `lib/api_server_web/controllers/digital_matter_controller.ex`
- `lib/api_server_web/controllers/fallback_controller.ex`
- `lib/api_server_web/controllers/file_controller.ex`

**Date:** 2026-02-27

---

## calamp_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.CalampController`

**Public functions:**

| Function | Line |
|---|---|
| `recieve_calamp_data/2` | 4 |

**Private functions (not subject to @doc findings):**

| Function | Line |
|---|---|
| `validate/3` | 31 |

**Types / constants / errors defined:** None

**@moduledoc:** Absent

**@doc on public functions:** None present

---

### Findings

#### B015-1 — Missing @moduledoc in CalampController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/calamp_controller.ex`, line 1

`ApiServerWeb.CalampController` has no `@moduledoc`. There is no description of the controller's purpose, the device protocol it handles (CalAmp), nor any notes about the expected request format (XML payload delivered via the `:xml` key). A `@moduledoc false` would be the minimum acceptable value; a descriptive string is preferred.

---

#### B015-2 — Missing @doc on `recieve_calamp_data/2`
**Severity:** INFO
**File:** `lib/api_server_web/controllers/calamp_controller.ex`, line 4

The only public action, `recieve_calamp_data/2`, has no `@doc`. The function accepts a `conn` and a map that must contain the key `:xml` (a pre-parsed XML map). Its behaviour — generating a ThingEvent, performing validation, and responding 200 OK — is undocumented. The function name also contains a spelling error (`recieve` instead of `receive`), which a doc string would at minimum make visible in generated documentation.

---

## digital_matter_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.DigitalMatterController`

**Public functions:**

| Function | Line |
|---|---|
| `get_g62_data/2` | 4 |

**Private functions (not subject to @doc findings):** None

**Types / constants / errors defined:** None

**@moduledoc:** Absent

**@doc on public functions:** None present

---

### Findings

#### B015-3 — Missing @moduledoc in DigitalMatterController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`, line 1

`ApiServerWeb.DigitalMatterController` has no `@moduledoc`. There is no description of the controller's purpose, the device vendor it targets (Digital Matter G62/G70), or the expected JSON payload structure.

---

#### B015-4 — Missing @doc on `get_g62_data/2`
**Severity:** INFO
**File:** `lib/api_server_web/controllers/digital_matter_controller.ex`, line 4

`get_g62_data/2` has no `@doc`. The function accepts a `conn` and a `params` map that must conform to the Digital Matter JSON upload format (keys `"SerNo"`, `"Records"`, each record containing `"Fields"` with typed FType entries and a `"Reason"` code). Its behaviour — iterating records, mapping FType fields to internal event structures, looking up a VX Thing by hardware ID, creating ThingEvent records, and updating cached fields — is entirely undocumented. The expected response shape (200 JSON `{message: "OK"}` or 400 with error detail) is also undocumented.

---

## fallback_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.FallbackController`

**Public functions:**

| Function | Line |
|---|---|
| `call/2` (Ecto.Changeset clause) | 9 |
| `call/2` (:not_found clause) | 15 |

**Types / constants / errors defined:** None

**@moduledoc:** Present (lines 2–6)

```elixir
@moduledoc """
Translates controller action results into valid `Plug.Conn` responses.

See `Phoenix.Controller.action_fallback/1` for more details.
"""
```

**@doc on public functions:** None present

---

### Findings

#### B015-5 — Missing @doc on `call/2` (Ecto.Changeset clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/fallback_controller.ex`, line 9

The `call/2` clause matching `{:error, %Ecto.Changeset{}}` has no `@doc`. It renders a 422 Unprocessable Entity response using `ApiServerWeb.ChangesetView`. While the `@moduledoc` gives a brief module-level description, individual clause behaviour (status code, view used, response shape) is not documented.

---

#### B015-6 — Missing @doc on `call/2` (:not_found clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/fallback_controller.ex`, line 15

The `call/2` clause matching `{:error, :not_found}` has no `@doc`. It renders a 404 Not Found response using `ApiServerWeb.ErrorView`. As with B015-5, a `@doc` on the first `call/2` clause (with both clauses listed) would clarify the full set of handled error tuples and the corresponding HTTP responses.

---

## file_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.FileController`

**Public functions:**

| Function | Line |
|---|---|
| `get_size/2` | 12 |
| `send_file_download/2` | 28 |

**Private functions (not subject to @doc findings):**

| Function | Line |
|---|---|
| `generate_binary_file_contents/1` | 42 |
| `check_crc/1` | 52 |

**Types / constants / errors defined:** None

**@moduledoc:** Absent

**@doc on public functions:** None present

---

### Findings

#### B015-7 — Missing @moduledoc in FileController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/file_controller.ex`, line 1

`ApiServerWeb.FileController` has no `@moduledoc`. There is no description of the controller's purpose: serving binary fob-code files (containing CRC16-XMODEM authenticated access fob data) to hardware devices identified by ESN/hardware ID.

---

#### B015-8 — Missing @doc on `get_size/2`
**Severity:** INFO
**File:** `lib/api_server_web/controllers/file_controller.ex`, line 12

`get_size/2` has no `@doc`. The function accepts a `conn` and a map with key `"esn"` (the hardware ID), looks up the associated VX Thing, collects all fleet fobs and admin fobs, calculates the file size as `(num_fobs + num_admin_fobs) * 6 + 2` bytes, and renders a `filesize.json` response. The parameter requirement and the size calculation formula are undocumented.

---

#### B015-9 — Missing @doc on `send_file_download/2`
**Severity:** INFO
**File:** `lib/api_server_web/controllers/file_controller.ex`, line 28

`send_file_download/2` has no `@doc`. The function accepts a `conn` and a map with key `"esn"`, looks up fleet and admin fobs, concatenates their hex fob codes, generates a binary file with a CRC16-XMODEM checksum appended, and sends it as a download with a timestamped filename (format `SM-<unix_epoch>-<hardwareid>.bin`). None of this behaviour, parameter requirements, or the download file format is documented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B015-1 | LOW | `calamp_controller.ex` line 1 | Missing `@moduledoc` in `ApiServerWeb.CalampController` |
| B015-2 | INFO | `calamp_controller.ex` line 4 | Missing `@doc` on `recieve_calamp_data/2` |
| B015-3 | LOW | `digital_matter_controller.ex` line 1 | Missing `@moduledoc` in `ApiServerWeb.DigitalMatterController` |
| B015-4 | INFO | `digital_matter_controller.ex` line 4 | Missing `@doc` on `get_g62_data/2` |
| B015-5 | INFO | `fallback_controller.ex` line 9 | Missing `@doc` on `call/2` (Ecto.Changeset clause) |
| B015-6 | INFO | `fallback_controller.ex` line 15 | Missing `@doc` on `call/2` (:not_found clause) |
| B015-7 | LOW | `file_controller.ex` line 1 | Missing `@moduledoc` in `ApiServerWeb.FileController` |
| B015-8 | INFO | `file_controller.ex` line 12 | Missing `@doc` on `get_size/2` |
| B015-9 | INFO | `file_controller.ex` line 28 | Missing `@doc` on `send_file_download/2` |

<!-- B016.md -->
# Pass 3: Documentation — B016
**Agent:** B016
**Files:**
1. `lib/api_server_web/controllers/geofence_controller.ex`
2. `lib/api_server_web/controllers/page_controller.ex`
3. `lib/api_server_web/controllers/pivotel_controller.ex`
4. `lib/api_server_web/controllers/utility_controller.ex`

**Date:** 2026-02-27

---

## geofence_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.GeofenceController`

**Public functions (def):**

| Name | Line |
|------|------|
| `list_all_geofences/2` | 11 |
| `create_geofence/2` | 18 |
| `update_geofence/2` | 35 |
| `delete_geofence/2` | 57 |
| `process_things_geofences/3` | 73 |

**Private functions (defp):** `check_geofences_for_unit/6` (96), `does_event_cause_geofence_events/6` (115), `check_event_for_left_events/6` (132–133), `check_event_for_entered_events/7` (149), `make_geofence_event/6` (168), `engine_hours_at_event/3` (184).

**Types / constants / errors defined:** None.

**Documentation attributes present:** None (`@moduledoc`, `@doc`, `@spec` are all absent).

### Findings

#### B016-1 — Missing @moduledoc in GeofenceController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/geofence_controller.ex`, line 1

`ApiServerWeb.GeofenceController` has no `@moduledoc` attribute. There is no description of the module's purpose, the authentication/authorization model it relies on, or the customer-scoping pattern used in every function.

#### B016-2 — Missing @doc on all public functions in GeofenceController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/geofence_controller.ex`

None of the five public action functions have an `@doc` attribute:

- `list_all_geofences/2` (line 11)
- `create_geofence/2` (line 18)
- `update_geofence/2` (line 35)
- `delete_geofence/2` (line 57)
- `process_things_geofences/3` (line 73)

---

## page_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.PageController`

**Public functions (def):**

| Name | Line |
|------|------|
| `index/2` | 4 |

**Private functions (defp):** None.

**Types / constants / errors defined:** None.

**Documentation attributes present:** None.

### Findings

#### B016-3 — Missing @moduledoc in PageController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/page_controller.ex`, line 1

`ApiServerWeb.PageController` has no `@moduledoc`. Even for a trivial controller a brief note (e.g. "Serves the root HTML landing page") is standard Elixir practice.

#### B016-4 — Missing @doc on index/2 in PageController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/page_controller.ex`, line 4

The sole public function `index/2` has no `@doc`.

---

## pivotel_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.PivotelController`

**Public functions (def):**

| Name | Line |
|------|------|
| `get_pivotel_data/2` (clause 1 — LOCATION message) | 4 |
| `get_pivotel_data/2` (clause 2 — catch-all) | 15 |
| `create_update_object/1` (clause 1 — LOCATION cause) | 20 |
| `create_update_object/1` (clause 2 — ACCUM cause) | 63 |
| `create_update_object/1` (clause 3 — catch-all) | 103 |

**Private functions (defp):** `convert_timestamp/1` (109).

**Types / constants / errors defined:** None.

**Documentation attributes present:** None.

### Findings

#### B016-5 — Missing @moduledoc in PivotelController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/pivotel_controller.ex`, line 1

`ApiServerWeb.PivotelController` has no `@moduledoc`. The module processes inbound Pivotel satellite-device XML/JSON payloads and delegates to `[REDACTED-AWS-SMTP-PASSWORD]`; none of this context is documented.

#### B016-6 — Missing @doc on all public functions in PivotelController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/pivotel_controller.ex`

None of the public functions have `@doc`:

- `get_pivotel_data/2` (lines 4 and 15 — two clauses)
- `create_update_object/1` (lines 20, 63, and 103 — three clauses)

`create_update_object/1` is also called directly from the controller action but is effectively a parsing helper; its three distinct match patterns (LOCATION, ACCUM, and fallback) are entirely undocumented.

---

## utility_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.UtilityController`

**Module-level constants defined:**

| Name | Lines |
|------|-------|
| `@lookup_olson` | 25–126 (Windows → IANA timezone mapping list) |

**Public functions (def) — complete inventory:**

| Name | Line |
|------|------|
| `update_puls_firmware/1` | 128 |
| `bulk_daily_usage_summary/1` | 228 |
| `do_health_check/2` | 320 |
| `calculate_roi_value/2` | 324 |
| `process_incoming_omegawatch_data/2` | 328 |
| `process_prodisplay_event/2` | 333 |
| `do_error/2` | 982 |
| `do_geocode_lookup/2` | 991 |
| `sync_to_DISCorp/2` | 1052 |
| `sync_vehicles_to_rayven/1` | 1076 |
| `test_rental_messages/1` | 1203 |
| `send_vehicle_to_rayven/2` | 1445 |
| `send_to_rayven/7` | 1677 |
| `pull_from_rayven/1` | 1986 |
| `check_out_of_sequence_events/1` | 2009 |
| `get_tracker_ids/0` | 2078 |
| `device_lookup_with_hardware_id/1` | 2093 |
| `check_vehicles_for_rental_overage/3` | 2100 |
| `process_monthly_movements/0` | 2280 |
| `process_pronto/0` | 2463 |
| `process_ebs/0` | 2821 |
| `process_ebs_check_service/1` | 2972 |
| `process_ebs_get_hour_meter/2` | 2990 |
| `send_local_arrow_data/0` | 3036 |
| `check_vehicles_for_no_usage_historical/1` | 3170 |
| `process_events_for_next_usage/4` | 3213 |
| `sync_events_to_rayven/0` | 3298 |
| `rayven_login/2` | 3346 |
| `get_rayven_devices_for_project/2` | 3390 |
| `pull_data_from_rayven/1` | 3412 |
| `create_equipment/3` | 3453 |
| `get_equipment_id/2` | 3524 |
| `create_equipment_assignment/3` | 3533 |
| `create_rental_records/1` | 3596 |
| `sync_rental_contracts_to_rayven/1` | 3600 |
| `sync_rental_periods_to_rayven/1` | 3615 |
| `copy_rental_contracts/1` | 3623 |
| `pull_equipment_data_from_rayven/1` | 4647 |
| `pull_services_from_rayven/1` | 4729 |
| `refresh_rayven_stream_status/1` | 4900 |
| `sync_historical_events_to_rayven/1` | 5020 |
| `sync_historical_events_to_rayven/5` | 5091 |
| `send_events_to_rayven/6` | 5358 |
| `prepare_rayven_events/3` | 5416 |
| `check_for_future_date/2` | 5567 |
| `erp_import/2` | 5666 |
| `driverid_converter/2` | 6025 |
| `get_additional_data/1` | 6172 |
| `next_service/1` | 6225 |

**Private functions (defp):** `parse_prodisplay_thingevent/4` (701), `parse_prodisplay_thingomega_event/5` (806), `parse_prodisplay_thingomegatires_event/5` (923), `check_and_save_erp_record/3` (5735), `process_rental_from_erp/2` (5758), `find_or_make_customer/3` (5850), `process_services_from_erp/2` (5882), `process_service_from_erp/2` (5896), `get_dm_driverid/1` (6092), `rayven_ssl_opts/0` (6267), `rayven_cacerts/0` (6278).

**Types / constants / errors defined:**
- `@lookup_olson` — module attribute list, lines 25–126. Windows-to-IANA timezone name pairs.

**Documentation attributes present:**
- `@doc` on `defp parse_prodisplay_thingevent/4` (line 697–700) — applied to a **private** function; no effect at runtime but notable as misplaced.
- `@doc` on `defp parse_prodisplay_thingomega_event/5` (line 802–805) — same issue.
- `@doc` on `defp parse_prodisplay_thingomegatires_event/5` (line 919–922) — same issue.

No `@moduledoc`. No `@doc` on any public function.

### Findings

#### B016-7 — Missing @moduledoc in UtilityController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/utility_controller.ex`, line 1

`ApiServerWeb.UtilityController` (6,293 lines) has no `@moduledoc`. The module is a large mixed-responsibility controller spanning HTTP action handlers, background-job utilities, Rayven integration helpers, ERP import processing, CSV report generation, and firmware management. The complete absence of any module-level documentation makes it extremely difficult to understand scope, ownership, or the intended API surface.

#### B016-8 — Missing @doc on all public functions in UtilityController (grouped)
**Severity:** LOW
**File:** `lib/api_server_web/controllers/utility_controller.ex`

None of the 49 public functions have an `@doc` attribute. The full list of undocumented public functions is:

`update_puls_firmware/1` (128), `bulk_daily_usage_summary/1` (228), `do_health_check/2` (320), `calculate_roi_value/2` (324), `process_incoming_omegawatch_data/2` (328), `process_prodisplay_event/2` (333), `do_error/2` (982), `do_geocode_lookup/2` (991), `sync_to_DISCorp/2` (1052), `sync_vehicles_to_rayven/1` (1076), `test_rental_messages/1` (1203), `send_vehicle_to_rayven/2` (1445), `send_to_rayven/7` (1677), `pull_from_rayven/1` (1986), `check_out_of_sequence_events/1` (2009), `get_tracker_ids/0` (2078), `device_lookup_with_hardware_id/1` (2093), `check_vehicles_for_rental_overage/3` (2100), `process_monthly_movements/0` (2280), `process_pronto/0` (2463), `process_ebs/0` (2821), `process_ebs_check_service/1` (2972), `process_ebs_get_hour_meter/2` (2990), `send_local_arrow_data/0` (3036), `check_vehicles_for_no_usage_historical/1` (3170), `process_events_for_next_usage/4` (3213), `sync_events_to_rayven/0` (3298), `rayven_login/2` (3346), `get_rayven_devices_for_project/2` (3390), `pull_data_from_rayven/1` (3412), `create_equipment/3` (3453), `get_equipment_id/2` (3524), `create_equipment_assignment/3` (3533), `create_rental_records/1` (3596), `sync_rental_contracts_to_rayven/1` (3600), `sync_rental_periods_to_rayven/1` (3615), `copy_rental_contracts/1` (3623), `pull_equipment_data_from_rayven/1` (4647), `pull_services_from_rayven/1` (4729), `refresh_rayven_stream_status/1` (4900), `sync_historical_events_to_rayven/1` (5020), `sync_historical_events_to_rayven/5` (5091), `send_events_to_rayven/6` (5358), `prepare_rayven_events/3` (5416), `check_for_future_date/2` (5567), `erp_import/2` (5666), `driverid_converter/2` (6025), `get_additional_data/1` (6172), `next_service/1` (6225).

#### B016-9 — @doc placed on private (defp) functions in UtilityController
**Severity:** MEDIUM
**File:** `lib/api_server_web/controllers/utility_controller.ex`, lines 697, 802, 919

Three `@doc` strings are placed immediately before `defp` (private) function definitions:

- Line 697–700: `@doc "Prodisplay events ... thingevent table"` applied to `defp parse_prodisplay_thingevent/4`
- Line 802–805: `@doc "Prodisplay events ... thingomega table"` applied to `defp parse_prodisplay_thingomega_event/5`
- Line 919–922: `@doc "Prodisplay events ... thingomegatires table"` applied to `defp parse_prodisplay_thingomegatires_event/5`

In Elixir, `@doc` on a private function is silently ignored by ExDoc and `h/1` in IEx — the documentation is never surfaced. This represents the developer's intent to document these helpers, but the placement is incorrect. The convention is to use a plain `# comment` for private function documentation. Additionally, the descriptions are inaccurate in a minor respect: they state these functions "parse incoming message data" but do not mention that they construct a plain map (not an Ecto changeset or struct), nor that the thingevent variant also handles hardware-ID encoding for the Prodisplay hardware ID format (Base16 encoding logic at lines 729–763). An inaccurate @doc on a `defp` is rated MEDIUM because it conveys misleading information even in code review, where developers do read these strings.

---

## Summary

| ID | Severity | File | Description |
|----|----------|------|-------------|
| B016-1 | LOW | geofence_controller.ex:1 | Missing `@moduledoc` in `ApiServerWeb.GeofenceController` |
| B016-2 | LOW | geofence_controller.ex | Missing `@doc` on all 5 public functions in GeofenceController |
| B016-3 | LOW | page_controller.ex:1 | Missing `@moduledoc` in `ApiServerWeb.PageController` |
| B016-4 | LOW | page_controller.ex:4 | Missing `@doc` on `index/2` in PageController |
| B016-5 | LOW | pivotel_controller.ex:1 | Missing `@moduledoc` in `ApiServerWeb.PivotelController` |
| B016-6 | LOW | pivotel_controller.ex | Missing `@doc` on all 5 public function clauses in PivotelController |
| B016-7 | LOW | utility_controller.ex:1 | Missing `@moduledoc` in `ApiServerWeb.UtilityController` |
| B016-8 | LOW | utility_controller.ex | Missing `@doc` on all 49 public functions in UtilityController |
| B016-9 | MEDIUM | utility_controller.ex:697,802,919 | `@doc` applied to `defp` functions (silently ignored); descriptions are also incomplete relative to actual implementation |

<!-- B017.md -->
# Pass 3: Documentation — B017
**Agent:** B017
**Files:**
- `lib/api_server_web/controllers/vx_abl_record_controller.ex`
- `lib/api_server_web/controllers/vx_access_fob_controller.ex`
- `lib/api_server_web/controllers/vx_customer_controller.ex`

**Date:** 2026-02-27

---

## vx_abl_record_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXAblRecordController`

**Public functions:**

| Function | Line |
|---|---|
| `create/2` | 9 |
| `show/2` | 18 |
| `update/2` | 23 |
| `delete/2` | 31 |
| `rhm_service_records/2` | 38 |
| `generate_service_record/3` | 66 |

**Types/errors/constants defined:** None.

**Attributes present:** None (`@moduledoc`, `@doc`, `@spec` are all absent throughout the file).

### Findings

#### B017-1 — Missing @moduledoc in VXAblRecordController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`, line 1

The module `ApiServerWeb.VXAblRecordController` has no `@moduledoc` attribute. There is no description of the controller's purpose, the resource it manages (VX ABL audit/log records), or any notes about authentication requirements or route context.

#### B017-2 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`, line 9

The public function `create/2` has no `@doc`. Its purpose (creating a VX ABL record), expected parameters (`vx_abl_record` map), response (201 Created with location header and rendered record), and fallback behaviour are undocumented.

#### B017-3 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`, line 18

The public function `show/2` has no `@doc`. Its purpose (fetching a single VX ABL record by ID), the bang function used (`get_vx_abl_record!`), and error propagation via `action_fallback` are undocumented.

#### B017-4 — Missing @doc on update/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`, line 23

The public function `update/2` has no `@doc`. Its purpose (updating a VX ABL record), expected parameters (`id` and `vx_abl_record` map), and the two-step fetch-then-update pattern are undocumented.

#### B017-5 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`, line 31

The public function `delete/2` has no `@doc`. Its purpose (deleting a VX ABL record), the 204 No Content response, and fallback behaviour are undocumented.

#### B017-6 — Missing @doc on rhm_service_records/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`, line 38

The public function `rhm_service_records/2` has no `@doc`. This function has non-trivial logic that warrants documentation: it reads the authenticated customer from JWT claims, optionally filters by `fleet_id`, applies an optional date range filter (with ±1-day boundary shifts via Timex), expands XML to structs, and renders a `services.json` view. The optional query parameters `fleet_id`, `from`, and `to` are completely undocumented.

#### B017-7 — Missing @doc on generate_service_record/3
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_abl_record_controller.ex`, line 66

The public function `generate_service_record/3` has no `@doc`. This is a non-action helper (three-arity, not a standard Phoenix action) with significant business logic: it reads JWT claims for customer and user, resolves user timezone, calculates hour-meter values, computes usage since last service, constructs an XML ABL record, and persists it. The fact that it is public but not a route action, the meaning of each argument (`conn`, `thing`, `new_service_date`), and its return value (`:ok` or `:error` atom from `Vx.create_abl_record/2`) are entirely undocumented.

---

## vx_access_fob_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXAccessFobController`

**Public functions:**

| Function | Line |
|---|---|
| `index/2` | 9 |
| `show/2` | 14 |
| `delete/2` | 19 |

**Types/errors/constants defined:** None.

**Attributes present:** None (`@moduledoc`, `@doc`, `@spec` are all absent throughout the file).

### Findings

#### B017-8 — Missing @moduledoc in VXAccessFobController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`, line 1

The module `ApiServerWeb.VXAccessFobController` has no `@moduledoc`. There is no description of what an access fob resource is, what routes this controller handles, or any authentication/authorisation context.

#### B017-9 — Missing @doc on index/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`, line 9

The public function `index/2` has no `@doc`. Its purpose (listing all VX access fobs via `Vx.list_vxaccessfobs/0`) and the absence of any customer-scoping or pagination are undocumented.

#### B017-10 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`, line 14

The public function `show/2` has no `@doc`. Its purpose (fetching a single access fob by ID), the bang function used, and fallback error handling are undocumented.

#### B017-11 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_access_fob_controller.ex`, line 19

The public function `delete/2` has no `@doc`. Its purpose (deleting an access fob), the 204 No Content response, and fallback behaviour are undocumented.

---

## vx_customer_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXCustomerController`

**Public functions:**

| Function | Line |
|---|---|
| `index/2` | 9 |
| `create/2` | 16 |
| `show/2` | 32 |
| `update/2` | 39 |
| `delete/2` | 51 |

**Types/errors/constants defined:** None.

**Attributes present:** None (`@moduledoc`, `@doc`, `@spec` are all absent throughout the file).

### Findings

#### B017-12 — Missing @moduledoc in VXCustomerController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`, line 1

The module `ApiServerWeb.VXCustomerController` has no `@moduledoc`. There is no description of the resource managed, the multi-tenant customer-scoping pattern used throughout the controller, or any authentication requirements.

#### B017-13 — Missing @doc on index/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`, line 9

The public function `index/2` has no `@doc`. Its purpose (listing customers scoped to the authenticated tenant), the JWT claim extraction for `customer`, and the rendered view are undocumented.

#### B017-14 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`, line 16

The public function `create/2` has no `@doc`. Its purpose (creating a new VX customer scoped to the authenticated tenant), the use of `VXCustomer.convert_json_to_changeset/1`, the 201 Created response path, and the inline error handling path (which bypasses `action_fallback` and returns a raw JSON 500 response) are undocumented.

#### B017-15 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`, line 32

The public function `show/2` has no `@doc`. Its purpose (fetching a single customer by ID scoped to the authenticated tenant) and tenant-isolation enforcement are undocumented.

#### B017-16 — Missing @doc on update/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`, line 39

The public function `update/2` has no `@doc`. Its purpose (updating a customer), the non-standard parameter pattern (ID is taken from inside the `vx_customer_params` map rather than as a top-level path parameter), and the post-update re-fetch pattern are undocumented.

#### B017-17 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_customer_controller.ex`, line 51

The public function `delete/2` has no `@doc`. Its purpose (deleting a customer scoped to the authenticated tenant) and the non-standard 200 OK response with an empty JSON body `{}` (rather than 204 No Content used in the other controllers) are undocumented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B017-1 | LOW | vx_abl_record_controller.ex, line 1 | Missing @moduledoc in VXAblRecordController |
| B017-2 | INFO | vx_abl_record_controller.ex, line 9 | Missing @doc on create/2 |
| B017-3 | INFO | vx_abl_record_controller.ex, line 18 | Missing @doc on show/2 |
| B017-4 | INFO | vx_abl_record_controller.ex, line 23 | Missing @doc on update/2 |
| B017-5 | INFO | vx_abl_record_controller.ex, line 31 | Missing @doc on delete/2 |
| B017-6 | INFO | vx_abl_record_controller.ex, line 38 | Missing @doc on rhm_service_records/2 |
| B017-7 | INFO | vx_abl_record_controller.ex, line 66 | Missing @doc on generate_service_record/3 |
| B017-8 | LOW | vx_access_fob_controller.ex, line 1 | Missing @moduledoc in VXAccessFobController |
| B017-9 | INFO | vx_access_fob_controller.ex, line 9 | Missing @doc on index/2 |
| B017-10 | INFO | vx_access_fob_controller.ex, line 14 | Missing @doc on show/2 |
| B017-11 | INFO | vx_access_fob_controller.ex, line 19 | Missing @doc on delete/2 |
| B017-12 | LOW | vx_customer_controller.ex, line 1 | Missing @moduledoc in VXCustomerController |
| B017-13 | INFO | vx_customer_controller.ex, line 9 | Missing @doc on index/2 |
| B017-14 | INFO | vx_customer_controller.ex, line 16 | Missing @doc on create/2 |
| B017-15 | INFO | vx_customer_controller.ex, line 32 | Missing @doc on show/2 |
| B017-16 | INFO | vx_customer_controller.ex, line 39 | Missing @doc on update/2 |
| B017-17 | INFO | vx_customer_controller.ex, line 51 | Missing @doc on delete/2 |

<!-- B018.md -->
# Pass 3: Documentation — B018
**Agent:** B018
**Files:**
- `lib/api_server_web/controllers/vx_fleet_association_controller.ex`
- `lib/api_server_web/controllers/vx_fleet_controller.ex`
- `lib/api_server_web/controllers/vx_rental_controller.ex`
- `lib/api_server_web/controllers/vx_restriction_controller.ex`

**Date:** 2026-02-27

---

## vx_fleet_association_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXFleetAssociationController`

**Public functions:**

| Function | Line |
|---|---|
| `index/2` | 9 |
| `show/2` | 14 |
| `delete/2` | 19 |

**Types / errors / constants defined:** None.

**`@moduledoc`:** Absent.

**`@doc` present:** None on any function.

### Findings

#### B018-1 — Missing @moduledoc in VXFleetAssociationController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 1

The module `ApiServerWeb.VXFleetAssociationController` has no `@moduledoc` attribute. There is no description of what resource the controller manages, which routes it services, or any authentication requirements.

---

#### B018-2 — Missing @doc on index/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 9

`index/2` has no `@doc`. The function lists all VX fleet associations by delegating to `Vx.list_vxfleetassociations/0` and renders `index.json`. No documentation describes the expected response structure, authentication requirements, or scope of records returned.

---

#### B018-3 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 14

`show/2` has no `@doc`. The function fetches a single fleet association by `id` using `Vx.get_vx_fleet_association!/1` (which raises on not-found) and renders `show.json`. No documentation describes the path parameter, the raise-on-missing behaviour, or the response structure.

---

#### B018-4 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 19

`delete/2` has no `@doc`. The function fetches a fleet association by `id` and deletes it, returning HTTP 204 No Content on success. No documentation describes the path parameter, the no-content response, or fallback error handling via `action_fallback`.

---

## vx_fleet_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXFleetController`

**Public functions:**

| Function | Line | Notes |
|---|---|---|
| `create/2` | 9 | Phoenix-style CRUD action; expects `%{"vx_fleet" => ...}` |
| `get_fleets/2` (clause 1) | 19 | Matches `%{"admin" => "1"}`; returns all fleets for customer |
| `get_fleets/2` (clause 2) | 27 | Catch-all; returns fleets scoped to current user |
| `get_fleets_with_equipment/2` | 35 | Returns fleets with nested equipment list |
| `create_fleet/2` | 68 | Custom fleet creation with duplicate-name guard |
| `delete_fleet/2` | 91 | Deletes fleet by customer + id |
| `get_equipment_in_fleet/2` | 105 | Lists equipment belonging to a fleet |
| `manage_fleet/2` | 110 | Replaces fleet equipment associations |
| `update_fleet/2` | 119 | Updates fleet metadata |

**Types / errors / constants defined:** None.

**`@moduledoc`:** Absent.

**`@doc` present:** None on any function.

### Findings

#### B018-5 — Missing @moduledoc in VXFleetController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 1

The module `ApiServerWeb.VXFleetController` has no `@moduledoc`. The controller is substantially more complex than a standard Phoenix CRUD controller (nine public functions, multi-clause dispatch, inline aggregation logic) and would especially benefit from a module-level description covering the resource, routing conventions, and authentication model used (`ApiServer.Guardian.Plug`).

---

#### B018-6 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 9

`create/2` has no `@doc`. It expects the body parameter key `"vx_fleet"`, creates the fleet via `Vx.create_vx_fleet/1`, and responds with HTTP 201 Created plus a `Location` header. No documentation describes the expected request shape, the Location header, or error paths handled by `action_fallback`.

---

#### B018-7 — Missing @doc on get_fleets/2 (admin clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 19

The first clause of `get_fleets/2` (matching `%{"admin" => "1"}`) has no `@doc`. It returns all fleets for the current user's customer code regardless of user scope. No documentation describes the admin query parameter that gates this behaviour, or that the customer context is drawn from JWT claims rather than the request path.

---

#### B018-8 — Missing @doc on get_fleets/2 (user clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 27

The second (catch-all) clause of `get_fleets/2` has no `@doc`. It scopes results to both `user_id` and `customer` extracted from JWT claims. Because this is a multi-clause function with meaningfully different behaviour per clause, each clause warrants a `@doc` (or at minimum the first clause should document all clauses). The absence makes the admin-vs-user dispatching invisible to API consumers.

---

#### B018-9 — Missing @doc on get_fleets_with_equipment/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 35

`get_fleets_with_equipment/2` has no `@doc`. This function performs a non-trivial in-memory aggregation (building a nested `equipment` array per fleet from flat query rows) before rendering. No documentation describes the response structure, the aggregation logic, or the source fields (`aaeid`, `aaecustcode`, `aaedesc`, etc.).

---

#### B018-10 — Missing @doc on create_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 68

`create_fleet/2` has no `@doc`. The function includes a duplicate-name guard that returns HTTP 500 with a human-readable error message when a fleet with the same name already exists. It also automatically associates the newly created fleet with the requesting user. None of this behaviour is documented; notably, the duplicate-name response uses 500 (Internal Server Error) where 409 (Conflict) would be conventional, and without documentation this misuse is hidden.

---

#### B018-11 — Missing @doc on delete_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 91

`delete_fleet/2` has no `@doc`. The function requires both `"customer"` and `"id"` path parameters and returns HTTP 200 with an empty JSON object on success (not the more conventional 204). No documentation describes the response code choice or what happens when the fleet does not exist (HTTP 500).

---

#### B018-12 — Missing @doc on get_equipment_in_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 105

`get_equipment_in_fleet/2` has no `@doc`. The function takes `"customer"` and `"id"` parameters and delegates entirely to `Vx.get_equipment_in_fleet/2`. No documentation describes the shape of the `results` payload rendered by `rhm_fleet_equipment.json`.

---

#### B018-13 — Missing @doc on manage_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 110

`manage_fleet/2` has no `@doc`. The function performs a full replacement of fleet equipment associations by accepting a list of thing IDs (`"equip_in_fleet"`), converting them to association maps, and calling `Vx.update_fleet_assocs/3`. The destructive replace-all semantics are not documented anywhere. No documentation describes the expected shape of `equip_in_fleet`, the `String.to_integer/1` conversion applied to each element, or the HTTP 200 `{}` response.

---

#### B018-14 — Missing @doc on update_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 119

`update_fleet/2` has no `@doc`. The function reads the fleet ID from inside `fleet_params["id"]` (not from a path segment), converts the params via `VXFleet.convert_json_to_changeset/1`, and returns HTTP 500 when no fleet is found. No documentation describes these parameter conventions or the non-standard error response code.

---

## vx_rental_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXRentalController`

**Public functions:**

| Function | Line | Notes |
|---|---|---|
| `get_rentals/2` (clause 1) | 9 | Matches `%{"customer" => _, "closed" => "1"}`; returns all rentals |
| `get_rentals/2` (clause 2) | 30 | Catch-all; returns only open rentals |
| `get_midpac_style_rental_report/2` | 51 | Rental anniversary report for a given date |
| `get_rental_anniversaries/2` | 110 | Anniversary history for a specific piece of equipment |
| `create_rental/2` | 158 | Creates a rental record |
| `update_rental/2` | 174 | Updates an existing rental |
| `delete_rental/2` | 191 | Deletes a rental by ID |
| `rhm_active_rental/2` | 206 | Returns the active rental for a hardware ID |

**Types / errors / constants defined:** None.

**`@moduledoc`:** Absent.

**`@doc` present:** None on any function.

### Findings

#### B018-15 — Missing @moduledoc in VXRentalController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 1

The module `ApiServerWeb.VXRentalController` has no `@moduledoc`. The controller manages a rental resource with significant domain complexity (period calculations, timezone awareness, overage computation, and anniversary reporting). A module-level docstring describing the resource, the customer-scoping model, and the timezone handling approach is absent.

---

#### B018-16 — Missing @doc on get_rentals/2 (closed clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 9

The first clause of `get_rentals/2` (matching `"closed" => "1"`) has no `@doc`. It calls `Vx.list_all_rentals/1` (all rentals, including closed ones) and enriches each with `period_start`, `period_usage`, and `overage`. No documentation describes the `"closed"` query flag, the enrichment fields, the timezone source (user preference from DB), or the response template `rhm_rentals.json`.

---

#### B018-17 — Missing @doc on get_rentals/2 (open clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 30

The second (catch-all) clause of `get_rentals/2` has no `@doc`. It calls `Vx.list_open_rentals/1` instead of `list_all_rentals/1`, returning only currently active rentals. The same enrichment logic applies. The distinction between the two clauses is undocumented.

---

#### B018-18 — Missing @doc on get_midpac_style_rental_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 51

`get_midpac_style_rental_report/2` has no `@doc`. This is the most complex function in the file: it accepts an `"on"` date parameter, finds all rentals with a billing anniversary on that date, and for each computes period usage, last-week usage, month-to-date usage, and service hours. The "midpac" name is domain-specific and opaque without documentation. The output fields (`vehicle_name`, `operating_hours_last_week`, `hours_to_service`, etc.) are nowhere described.

---

#### B018-19 — Missing @doc on get_rental_anniversaries/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 110

`get_rental_anniversaries/2` has no `@doc`. The function accepts `"hardwareid"`, `"from"`, and `"to"` date parameters and returns a flat list of anniversary events across all rentals for that piece of equipment, each including usage and overage for the period. No documentation describes the date format expected, the response payload shape, or how multiple overlapping rentals for the same equipment are handled.

---

#### B018-20 — Missing @doc on create_rental/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 158

`create_rental/2` has no `@doc`. It delegates changeset conversion to `ApiServerWeb.VXRentalView.convert_json_to_changeset/1` (notably a View module, not the schema). On error, the response body contains a malformed JSON literal (a trailing `\" }` is present outside the JSON string at line 169). Neither the expected request body nor the error response format is documented.

---

#### B018-21 — Missing @doc on update_rental/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 174

`update_rental/2` has no `@doc`. The rental ID is read from `rental_params["id"]` rather than a dedicated path parameter. On success, the rental is re-fetched from the database before rendering (rather than using the update result). These non-obvious behaviours are undocumented.

---

#### B018-22 — Missing @doc on delete_rental/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 191

`delete_rental/2` has no `@doc`. The function takes `"customer"` and `"id"` path parameters, returns HTTP 200 `{}` on success (not 204), and HTTP 500 for both "not found" and "deletion failed" cases with different error messages. None of this is documented.

---

#### B018-23 — Missing @doc on rhm_active_rental/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 206

`rhm_active_rental/2` has no `@doc`. The function looks up an active rental by `"hardwareid"`, computes `period_start`, `period_usage`, and `overage`, but then discards these computed values — they are bound to local variables but the render call at line 229 passes the unmodified `active_rental` struct (the `Map.put_new/3` pipe result is not reassigned). This latent bug is invisible without documentation describing the intended output. No documentation exists to alert reviewers that the enrichment fields are silently dropped.

---

## vx_restriction_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXRestrictionController`

**Public functions:** None. The module body contains only `use ApiServerWeb, :controller`, two `alias` declarations, and `action_fallback ApiServerWeb.FallbackController`. No action functions are defined.

**Types / errors / constants defined:** None.

**`@moduledoc`:** Absent.

### Findings

#### B018-24 — Missing @moduledoc in VXRestrictionController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_restriction_controller.ex`, line 1

The module `ApiServerWeb.VXRestrictionController` is an empty controller shell with no `@moduledoc`. Because the module defines no action functions, the absence of a module-level docstring means there is no indication of intent: whether this controller is a planned stub, a deprecated placeholder, or simply an unused scaffold. A `@moduledoc` noting the intended purpose (or explicitly marking the module as a stub pending implementation) is absent.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B018-1 | LOW | vx_fleet_association_controller.ex | Missing @moduledoc |
| B018-2 | INFO | vx_fleet_association_controller.ex | Missing @doc on index/2 |
| B018-3 | INFO | vx_fleet_association_controller.ex | Missing @doc on show/2 |
| B018-4 | INFO | vx_fleet_association_controller.ex | Missing @doc on delete/2 |
| B018-5 | LOW | vx_fleet_controller.ex | Missing @moduledoc |
| B018-6 | INFO | vx_fleet_controller.ex | Missing @doc on create/2 |
| B018-7 | INFO | vx_fleet_controller.ex | Missing @doc on get_fleets/2 (admin clause) |
| B018-8 | INFO | vx_fleet_controller.ex | Missing @doc on get_fleets/2 (user clause) |
| B018-9 | INFO | vx_fleet_controller.ex | Missing @doc on get_fleets_with_equipment/2 |
| B018-10 | INFO | vx_fleet_controller.ex | Missing @doc on create_fleet/2 |
| B018-11 | INFO | vx_fleet_controller.ex | Missing @doc on delete_fleet/2 |
| B018-12 | INFO | vx_fleet_controller.ex | Missing @doc on get_equipment_in_fleet/2 |
| B018-13 | INFO | vx_fleet_controller.ex | Missing @doc on manage_fleet/2 |
| B018-14 | INFO | vx_fleet_controller.ex | Missing @doc on update_fleet/2 |
| B018-15 | LOW | vx_rental_controller.ex | Missing @moduledoc |
| B018-16 | INFO | vx_rental_controller.ex | Missing @doc on get_rentals/2 (closed clause) |
| B018-17 | INFO | vx_rental_controller.ex | Missing @doc on get_rentals/2 (open clause) |
| B018-18 | INFO | vx_rental_controller.ex | Missing @doc on get_midpac_style_rental_report/2 |
| B018-19 | INFO | vx_rental_controller.ex | Missing @doc on get_rental_anniversaries/2 |
| B018-20 | INFO | vx_rental_controller.ex | Missing @doc on create_rental/2 |
| B018-21 | INFO | vx_rental_controller.ex | Missing @doc on update_rental/2 |
| B018-22 | INFO | vx_rental_controller.ex | Missing @doc on delete_rental/2 |
| B018-23 | INFO | vx_rental_controller.ex | Missing @doc on rhm_active_rental/2 |
| B018-24 | LOW | vx_restriction_controller.ex | Missing @moduledoc on empty controller stub |

<!-- B019.md -->
# Pass 3: Documentation — B019
**Agent:** B019
**Files:**
- `lib/api_server_web/controllers/vx_thing_controller.ex`
- `lib/api_server_web/controllers/vx_thing_event_controller.ex`
- `lib/api_server_web/controllers/vx_thing_info_controller.ex`

**Date:** 2026-02-27

---

## vx_thing_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingController`

**Public functions (by first definition line):**

| Function | Line(s) |
|---|---|
| `get_checklists/2` | 10 |
| `get_movements/2` | 16 |
| `get_hardware_with_checklists/2` | 21 |
| `get_pm_data/2` | 30 |
| `get_all_pm_data/2` | 36 |
| `get_fleet_map/2` (4 clauses) | 44, 51, 56, 64 |
| `create/2` | 74 |
| `show/2` | 83 |
| `delete/2` | 88 |
| `rhm_get_thing/2` | 95 |
| `rhm_get_thing_usage/2` | 100 |
| `rhm_get_things_usage/2` | 111 |
| `rhm_get_thing_events/2` | 144 |
| `rhm_get_things/2` (2 clauses) | 153, 161 |
| `rhm_get_things_with_usage/2` (2 clauses) | 169, 176 |
| `rhm_get_things_names/2` | 223 |
| `rhm_get_thing_records/2` | 231 |
| `create_thing/2` | 240 |
| `update_thing/2` | 254 |
| `monday_hour_meters/2` | 377 |
| `get_next_monday_between_dates/4` | 438 |
| `combined_engine_usage/2` | 453 |
| `pape_export/2` (2 clauses) | 603, 617 |
| `sielift_export/2` (3 clauses) | 724, 735, 746 |
| `update_thing_cached_fields/2` | 850 |
| `get_timezones/2` | 859 |

**Private functions:** `things_with_usage/2` (line 184), `get_data_for_pape_export/1` (line 285), `ifnilzero/1` (line 622–623), `get_data_for_sielift_export/3` (line 625)

**Types/errors/constants defined:** None (no `@type`, `@typep`, `@spec`, or module-level constants).

---

### Findings

#### B019-1 — Missing @moduledoc in VXThingController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 1

The module `ApiServerWeb.VXThingController` has no `@moduledoc` attribute. With approximately 29 public functions spanning checklists, fleet maps, PM data, RHM reporting, CSV exports, and cache maintenance, the absence of a module-level docstring makes it impossible for readers to understand the module's purpose or the domain it covers without reading the entire file.

---

#### B019-2 — Missing @doc on get_checklists/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 10

`get_checklists/2` has no `@doc`. The function retrieves all checklists for a given hardware ID scoped to a customer. The `customer` parameter is accepted in the pattern match but is not used in the function body, which is a behaviour worth noting in documentation.

---

#### B019-3 — Missing @doc on get_movements/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 16

`get_movements/2` has no `@doc`. The function fetches movement records for a hardware ID on a specific day in a given timezone. Both `from` and `to` are set to the same `day` value, which is a subtle constraint that would benefit from explicit documentation.

---

#### B019-4 — Missing @doc on get_hardware_with_checklists/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 21

`get_hardware_with_checklists/2` has no `@doc`.

---

#### B019-5 — Missing @doc on get_pm_data/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 30

`get_pm_data/2` has no `@doc`.

---

#### B019-6 — Missing @doc on get_all_pm_data/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 36

`get_all_pm_data/2` has no `@doc`.

---

#### B019-7 — Missing @doc on get_fleet_map/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 44, 51, 56, 64

`get_fleet_map/2` has four clauses with no `@doc` on any of them. The dispatch logic between the four clauses (fleet by name, fleet by ID with customer, fleet by ID without customer, and catch-all using JWT claims) is non-obvious and would benefit from documentation explaining which clause handles which scenario. The first clause (line 44) accepts a `fleetname` parameter but passes `user_id` — not `fleetname` — to `Vx.list_vxthings_for_map/2`, making `fleetname` unused.

---

#### B019-8 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 74

`create/2` has no `@doc`.

---

#### B019-9 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 83

`show/2` has no `@doc`.

---

#### B019-10 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 88

`delete/2` has no `@doc`.

---

#### B019-11 — Missing @doc on rhm_get_thing/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 95

`rhm_get_thing/2` has no `@doc`. The function returns an augmented thing including usage data, but the structure of the returned tuple `{vx_thing, usage_data}` is not documented.

---

#### B019-12 — Missing @doc on rhm_get_thing_usage/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 100

`rhm_get_thing_usage/2` has no `@doc`. The function extracts the customer from JWT claims rather than from path/query params, and adds an `X-hardware-id` response header. Both behaviours are undocumented.

---

#### B019-13 — Missing @doc on rhm_get_things_usage/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 111

`rhm_get_things_usage/2` has no `@doc`. The function returns a CSV file attachment rather than JSON. This response format difference from sibling endpoints is a significant API behaviour that should be documented.

---

#### B019-14 — Missing @doc on rhm_get_thing_events/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 144

`rhm_get_thing_events/2` has no `@doc`.

---

#### B019-15 — Missing @doc on rhm_get_things/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 153, 161

`rhm_get_things/2` has two clauses and no `@doc` on either. In the `fleet_id` clause (line 153), the `customer` parameter from the pattern match is immediately shadowed by extracting `customer` from JWT claims. This silent override of the route parameter should be documented.

---

#### B019-16 — Missing @doc on rhm_get_things_with_usage/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 169, 176

`rhm_get_things_with_usage/2` has two clauses and no `@doc`. The function augments the thing list with `this_week`, `last_week`, and `this_month` usage fields using the user's timezone derived from the database.

---

#### B019-17 — Missing @doc on rhm_get_things_names/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 223

`rhm_get_things_names/2` has no `@doc`. Note that the `customer` parameter from the pattern match is immediately shadowed by extracting customer from JWT claims — the route parameter is unused.

---

#### B019-18 — Missing @doc on rhm_get_thing_records/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 231

`rhm_get_thing_records/2` has no `@doc`.

---

#### B019-19 — Missing @doc on create_thing/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 240

`create_thing/2` has no `@doc`. This function also triggers a service record generation side-effect path via `update_thing/2` logic; however the primary concern here is the absence of any documentation.

---

#### B019-20 — Missing @doc on update_thing/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 254

`update_thing/2` has no `@doc`. The function has a significant side-effect: if the last service date changes, it calls `VXAblRecordController.generate_service_record/3` and `VXThingInfo.service_performed/3`. This cross-controller mutation is undocumented.

---

#### B019-21 — Missing @doc on monday_hour_meters/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 377

`monday_hour_meters/2` has no `@doc`. This function iterates over multiple customers (comma-separated string), computes all Mondays between two dates, and returns JSON of hour-meter readings. The multi-customer behaviour and the date-range logic are non-trivial and lack any explanation.

---

#### B019-22 — Missing @doc on get_next_monday_between_dates/4
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 438

`get_next_monday_between_dates/4` has no `@doc`. This public recursive helper function computes a list of Monday dates between two bounds. Its parameter signature `(current_monday, from, to, current_mondays)` and recursive accumulator pattern are not explained.

---

#### B019-23 — Missing @doc on combined_engine_usage/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 453

`combined_engine_usage/2` has no `@doc`. The function accepts a comma-separated `customers` parameter, aggregates daily usage across all customers and vehicles, and returns JSON. The large volume of commented-out code throughout the function body adds confusion that documentation could help resolve.

---

#### B019-24 — Missing @doc on pape_export/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 603, 617

`pape_export/2` has two clauses and no `@doc`. The CSV clause (line 603) and the JSON/default clause (line 617) serve different response formats; this dispatch is not documented.

---

#### B019-25 — Missing @doc on sielift_export/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 724, 735, 746

`sielift_export/2` has three clauses and no `@doc`. The clauses handle: JSON export filtered by `fleet_id`, JSON export for all fleets, and CSV export (the default). The CSV clause includes a local `headings` list that is missing "Hardware ID" compared to the commented-out `sielift_export_local/1` function — this discrepancy is invisible without documentation.

---

#### B019-26 — Missing @doc on update_thing_cached_fields/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 850

`update_thing_cached_fields/2` has no `@doc`. This function is called publicly from `[REDACTED-AWS-SMTP-PASSWORD]` (line 71 of that file), making it part of the cross-module API. It triggers `do_fix_summary/2` and `do_fix_info/2` as side effects. The cross-module dependency and purpose are entirely undocumented.

---

#### B019-27 — Missing @doc on get_timezones/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 859

`get_timezones/2` has no `@doc`.

---

## vx_thing_event_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingEventController`

**Public functions:**

| Function | Line |
|---|---|
| `index/2` | 9 |
| `create/2` | 14 |
| `show/2` | 24 |
| `update/2` | 29 |
| `delete/2` | 38 |
| `write_partial_record/3` | 46 |
| `add_calculated_fields/2` | 74 |
| `get_current_omega_status/2` | 111 |

**Private functions:** `calculated_hourmeter/2` (line 103)

**Types/errors/constants defined:** None.

---

### Findings

#### B019-28 — Missing @moduledoc in VXThingEventController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 1

The module `ApiServerWeb.VXThingEventController` has no `@moduledoc`. The module handles both standard CRUD operations on thing events and provides public utility functions (`write_partial_record/3`, `add_calculated_fields/2`) consumed by other modules.

---

#### B019-29 — Missing @doc on index/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 9

`index/2` has no `@doc`.

---

#### B019-30 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 14

`create/2` has no `@doc`.

---

#### B019-31 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 24

`show/2` has no `@doc`.

---

#### B019-32 — Missing @doc on update/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 29

`update/2` has no `@doc`.

---

#### B019-33 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 38

`delete/2` has no `@doc`.

---

#### B019-34 — Missing @doc on write_partial_record/3
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 46

`write_partial_record/3` has no `@doc`. This is a non-HTTP public function called from other parts of the system (not via a router). It fetches the most recent event for a device, merges a partial update map into it, persists the result as a new record, and then triggers cache refresh via `VXThingController.update_thing_cached_fields/2`. The semantics of the `update` map parameter, the merge-then-insert pattern (rather than update-in-place), and the cross-controller side-effect call are all undocumented.

---

#### B019-35 — Missing @doc on add_calculated_fields/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 74

`add_calculated_fields/2` has no `@doc`. This function computes calculated hour-meter fields (`calcengineseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, etc.) by applying offsets stored on the `VXThing` record to raw sensor totals. It is publicly accessible and appears designed to be called from outside the module, but there is no documentation describing the expected shape of `record_to_add`, what fields are added, or the offset semantics.

---

#### B019-36 — Missing @doc on get_current_omega_status/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 111

`get_current_omega_status/2` has no `@doc`. The "omega" qualifier in the function name is opaque without documentation explaining what distinguishes an omega event from a regular thing event.

---

## vx_thing_info_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingInfoController`

**Public functions:**

| Function | Line |
|---|---|
| `fix_infos/2` | 9 |
| `get_info/2` | 17 |
| `do_fix_info/2` | 24 |

**Private functions:** None.

**Types/errors/constants defined:** None.

---

### Findings

#### B019-37 — Missing @moduledoc in VXThingInfoController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`, line 1

The module `ApiServerWeb.VXThingInfoController` has no `@moduledoc`. The module manages validation/repair of `VXThingInfo` cached records and exposes `do_fix_info/2` as part of the cross-module API used by `VXThingController` (line 855 of that file).

---

#### B019-38 — Missing @doc on fix_infos/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`, line 9

`fix_infos/2` has no `@doc`. The function iterates over all things for a customer and calls `do_fix_info/2` on each. The endpoint semantics (is this idempotent? is it safe to run in production? what does "fix" entail?) are undocumented.

---

#### B019-39 — Missing @doc on get_info/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`, line 17

`get_info/2` has no `@doc`. Additionally, the function calls `VXThingInfo.validateForHardwareId/2` but discards the result (the return value `info` is unused), and always responds with an empty JSON object `{}` regardless of the validation outcome. This silent discard of the validation result is a behaviour that documentation should explain, or which may indicate a bug.

---

#### B019-40 — Missing @doc on do_fix_info/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`, line 24

`do_fix_info/2` has no `@doc`. This function is part of the public cross-module API: it is called directly by `ApiServerWeb.VXThingController.update_thing_cached_fields/2` (line 855). The name `do_fix_info` suggests an implementation detail (Elixir convention places `do_` prefix on private helpers), but it is `def` not `defp`. The intended callers, preconditions, and what "fixing" the info entails are entirely undocumented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B019-1 | LOW | vx_thing_controller.ex:1 | Missing @moduledoc in VXThingController |
| B019-2 | INFO | vx_thing_controller.ex:10 | Missing @doc on get_checklists/2 |
| B019-3 | INFO | vx_thing_controller.ex:16 | Missing @doc on get_movements/2 |
| B019-4 | INFO | vx_thing_controller.ex:21 | Missing @doc on get_hardware_with_checklists/2 |
| B019-5 | INFO | vx_thing_controller.ex:30 | Missing @doc on get_pm_data/2 |
| B019-6 | INFO | vx_thing_controller.ex:36 | Missing @doc on get_all_pm_data/2 |
| B019-7 | INFO | vx_thing_controller.ex:44 | Missing @doc on get_fleet_map/2 (4 clauses) |
| B019-8 | INFO | vx_thing_controller.ex:74 | Missing @doc on create/2 |
| B019-9 | INFO | vx_thing_controller.ex:83 | Missing @doc on show/2 |
| B019-10 | INFO | vx_thing_controller.ex:88 | Missing @doc on delete/2 |
| B019-11 | INFO | vx_thing_controller.ex:95 | Missing @doc on rhm_get_thing/2 |
| B019-12 | INFO | vx_thing_controller.ex:100 | Missing @doc on rhm_get_thing_usage/2 |
| B019-13 | INFO | vx_thing_controller.ex:111 | Missing @doc on rhm_get_things_usage/2 (returns CSV, undocumented) |
| B019-14 | INFO | vx_thing_controller.ex:144 | Missing @doc on rhm_get_thing_events/2 |
| B019-15 | INFO | vx_thing_controller.ex:153 | Missing @doc on rhm_get_things/2 (2 clauses) |
| B019-16 | INFO | vx_thing_controller.ex:169 | Missing @doc on rhm_get_things_with_usage/2 (2 clauses) |
| B019-17 | INFO | vx_thing_controller.ex:223 | Missing @doc on rhm_get_things_names/2 |
| B019-18 | INFO | vx_thing_controller.ex:231 | Missing @doc on rhm_get_thing_records/2 |
| B019-19 | INFO | vx_thing_controller.ex:240 | Missing @doc on create_thing/2 |
| B019-20 | INFO | vx_thing_controller.ex:254 | Missing @doc on update_thing/2 (undocumented service-record side-effect) |
| B019-21 | INFO | vx_thing_controller.ex:377 | Missing @doc on monday_hour_meters/2 |
| B019-22 | INFO | vx_thing_controller.ex:438 | Missing @doc on get_next_monday_between_dates/4 |
| B019-23 | INFO | vx_thing_controller.ex:453 | Missing @doc on combined_engine_usage/2 |
| B019-24 | INFO | vx_thing_controller.ex:603 | Missing @doc on pape_export/2 (2 clauses) |
| B019-25 | INFO | vx_thing_controller.ex:724 | Missing @doc on sielift_export/2 (3 clauses) |
| B019-26 | INFO | vx_thing_controller.ex:850 | Missing @doc on update_thing_cached_fields/2 (cross-module public API) |
| B019-27 | INFO | vx_thing_controller.ex:859 | Missing @doc on get_timezones/2 |
| B019-28 | LOW | vx_thing_event_controller.ex:1 | Missing @moduledoc in VXThingEventController |
| B019-29 | INFO | vx_thing_event_controller.ex:9 | Missing @doc on index/2 |
| B019-30 | INFO | vx_thing_event_controller.ex:14 | Missing @doc on create/2 |
| B019-31 | INFO | vx_thing_event_controller.ex:24 | Missing @doc on show/2 |
| B019-32 | INFO | vx_thing_event_controller.ex:29 | Missing @doc on update/2 |
| B019-33 | INFO | vx_thing_event_controller.ex:38 | Missing @doc on delete/2 |
| B019-34 | INFO | vx_thing_event_controller.ex:46 | Missing @doc on write_partial_record/3 (cross-module public API) |
| B019-35 | INFO | vx_thing_event_controller.ex:74 | Missing @doc on add_calculated_fields/2 |
| B019-36 | INFO | vx_thing_event_controller.ex:111 | Missing @doc on get_current_omega_status/2 |
| B019-37 | LOW | vx_thing_info_controller.ex:1 | Missing @moduledoc in VXThingInfoController |
| B019-38 | INFO | vx_thing_info_controller.ex:9 | Missing @doc on fix_infos/2 |
| B019-39 | INFO | vx_thing_info_controller.ex:17 | Missing @doc on get_info/2 (validation result silently discarded) |
| B019-40 | INFO | vx_thing_info_controller.ex:24 | Missing @doc on do_fix_info/2 (cross-module public API, misleading naming) |

<!-- B020.md -->
# Pass 3: Documentation — B020
**Agent:** B020
**Files:**
- `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
- `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
- `lib/api_server_web/controllers/vx_user_controller.ex`
- `lib/api_server_web/controllers/vx_user_function_controller.ex`

**Date:** 2026-02-27

---

## vx_thing_omega_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingOmegaController`

**Public functions (all lack @doc):**

| Function | Line | Notes |
|---|---|---|
| `get_container_lift_report/2` | 10 | Pattern: `hardwareid`, `from`, `to` |
| `get_lift_summary_report/2` | 22 | Pattern: `hardwareid`, `from`, `to` |
| `get_lift_list_report/2` | 33 | Pattern: `hardwareid`, `from`, `to` |
| `get_lift_summary_report/2` | 44 | Second clause — pattern: `fleetid`, `from`, `to` |
| `get_operation_summary_report/2` | 53 | Pattern: `fleetid`, `from`, `to` |
| `get_engine_utilization_report/2` | 63 | Pattern: `hardwareid`, `from`, `to` |

**Types / errors / constants defined:** None.

**Additional notes:**
- No `@moduledoc` present anywhere in the file.
- No `@doc` annotations on any public function.
- `get_lift_summary_report/2` has two distinct clauses (lines 22 and 44): one accepting `hardwareid`, one accepting `fleetid`. These are multi-clause functions that serve fundamentally different resource types without any documentation distinction.

### Findings

#### B020-1 — Missing @moduledoc in VXThingOmegaController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 1

The module `ApiServerWeb.VXThingOmegaController` has no `@moduledoc` attribute. There is no module-level description of what reports this controller provides, which authentication model it relies on, or what domain (`hardwareid`/`fleetid` lift and engine data) it serves.

---

#### B020-2 — Missing @doc on get_container_lift_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 10

`get_container_lift_report/2` has no `@doc`. The function fetches per-day container lift event counts for a specific hardware device over a date range, respecting the authenticated user's timezone. None of this is documented.

---

#### B020-3 — Missing @doc on get_lift_summary_report/2 (hardwareid clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 22

The first clause of `get_lift_summary_report/2`, which operates on a `hardwareid`, has no `@doc`. The absence of documentation is compounded by the existence of a second clause (line 44) for `fleetid`; there is no documentation to distinguish the two dispatch paths.

---

#### B020-4 — Missing @doc on get_lift_list_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 33

`get_lift_list_report/2` has no `@doc`. The function returns a flat list of individual lift events (rather than a per-day summary) for a given hardware device and date range.

---

#### B020-5 — Missing @doc on get_lift_summary_report/2 (fleetid clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 44

The second clause of `get_lift_summary_report/2`, which dispatches on `fleetid` instead of `hardwareid`, has no `@doc`. Because Elixir `@doc` attaches to the first clause, both clauses share the documentation gap identified in B020-3. The fleet-level aggregation semantics are entirely undocumented.

---

#### B020-6 — Missing @doc on get_operation_summary_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 53

`get_operation_summary_report/2` has no `@doc`. The function retrieves an omega operation summary for a fleet over a date range.

---

#### B020-7 — Missing @doc on get_engine_utilization_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 63

`get_engine_utilization_report/2` has no `@doc`. The function fetches per-day engine utilization data for a specific hardware device over a date range.

---

## vx_thing_summary_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingSummaryController`

**Public functions (all lack @doc):**

| Function | Line | Notes |
|---|---|---|
| `index/2` | 9 | Lists all VX thing summaries |
| `create/2` | 14 | Creates a new VX thing summary |
| `show/2` | 23 | Returns a single VX thing summary by id |
| `update/2` | 28 | Updates an existing VX thing summary |
| `delete/2` | 36 | Deletes a VX thing summary |
| `do_fix_summary/2` | 45 | Validates summary for a given hardwareid and customer; not a Phoenix action |

**Types / errors / constants defined:** None.

**Additional notes:**
- No `@moduledoc` present.
- No `@doc` on any public function.
- `do_fix_summary/2` is a public utility function that is not a Phoenix controller action (it takes `hardwareid` and `customer` rather than `conn` and `params`). Its exposure as a public function with no documentation is a particular gap.

### Findings

#### B020-8 — Missing @moduledoc in VXThingSummaryController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 1

The module `ApiServerWeb.VXThingSummaryController` has no `@moduledoc` explaining the VX thing summary resource or CRUD operations it exposes.

---

#### B020-9 — Missing @doc on index/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 9

`index/2` has no `@doc`. The function lists all VX thing summaries via `Vx.list_vxthingsummaries/0`.

---

#### B020-10 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 14

`create/2` has no `@doc`. The function creates a new `VXThingSummary` record and returns HTTP 201 with a `location` header on success.

---

#### B020-11 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 23

`show/2` has no `@doc`. The function fetches and renders a single VX thing summary by its `id`.

---

#### B020-12 — Missing @doc on update/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 28

`update/2` has no `@doc`. The function updates an existing VX thing summary with the provided parameters.

---

#### B020-13 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 36

`delete/2` has no `@doc`. The function deletes a VX thing summary by its `id` and returns HTTP 204 No Content.

---

#### B020-14 — Missing @doc on do_fix_summary/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 45

`do_fix_summary/2` has no `@doc`. This function is notably not a Phoenix controller action — it takes `(hardwareid, customer)` rather than `(conn, params)` — making the absence of documentation more significant. Its purpose (triggering `VXThingSummary.validate_for_hardwareid/2`) and expected callers are undocumented.

---

## vx_user_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXUserController`

**Public functions (all lack @doc):**

| Function | Line | Notes |
|---|---|---|
| `create/2` | 9 | Creates a VX user record; legacy/generic path |
| `lookup_customer_from_conn/1` | 18 | Derives customer tenant from the HTTP `origin` header |
| `login/2` | 41 | Authenticates user, issues JWT, sets session |
| `change_password/2` | 59 | Validates current password and sets new password |
| `get_users/2` | 82 | Lists all users for a customer |
| `get_user_with_email/2` | 89 | Fetches a single user by email and customer |
| `update_key_if_value/3` | 99 | Utility: puts a key into a map only when value is non-nil (first clause: nil guard) |
| `update_key_if_value/3` | 100 | Utility: puts a key into a map only when value is non-nil (second clause: general) |
| `update_user/2` | 104 | Updates a user record by id; first clause requires `user` key |
| `update_user/2` | 127 | Second clause: returns error when no `user` key present in params |
| `create_user/2` | 131 | Creates a new user, checking for duplicate email first |
| `delete_user/2` | 153 | Deletes a user by id |
| `get_user_fleets/2` | 168 | Returns fleet IDs assigned to a user |
| `manage_user_fleets/2` | 180 | Reconciles allowed fleet list for a user (adds/removes) |

**Types / errors / constants defined:** None.

**Additional notes:**
- No `@moduledoc` present.
- No `@doc` on any public function.
- `lookup_customer_from_conn/1` uses a hardcoded list of HTTP origins (including `http://` — non-TLS) to derive the tenant. This is a public function with no documentation of the mapping table or the fallback behaviour (`"vx_dev"` for all unknown origins).
- `update_key_if_value/3` is a general-purpose utility that is public but undocumented.
- `login/2` derives `cust_from_origin` (line 42) but then uses the `customer` parameter from the request body when signing the JWT (line 45) — `cust_from_origin` is only stored in the session, not the token. This nuance is undocumented.

### Findings

#### B020-15 — Missing @moduledoc in VXUserController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 1

The module `ApiServerWeb.VXUserController` has no `@moduledoc` describing the user authentication and management operations it exposes, nor the multi-tenant model it employs.

---

#### B020-16 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 9

`create/2` has no `@doc`. This function takes a `"vx_user"` params map and delegates to `Vx.create_vx_user/1`. Its relationship to `create_user/2` (which includes duplicate-email checks) is not documented.

---

#### B020-17 — Missing @doc on lookup_customer_from_conn/1
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 18

`lookup_customer_from_conn/1` has no `@doc`. The function encapsulates a hardcoded table of HTTP origin headers mapped to customer tenant identifiers, with a catch-all fallback of `"vx_dev"`. The full mapping and the fallback behaviour are invisible to callers.

---

#### B020-18 — Missing @doc on login/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 41

`login/2` has no `@doc`. The function authenticates a user, signs a JWT via Guardian, and sets both a session cookie and returns the token in the response body. The distinction between `customer` (from the request body, embedded in JWT claims) and `cust_from_origin` (derived from the `origin` header, stored only in session) is not documented.

---

#### B020-19 — Missing @doc on change_password/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 59

`change_password/2` has no `@doc`. The function validates the current password before applying the new one, and returns HTTP 500 when the new password is nil or empty.

---

#### B020-20 — Missing @doc on get_users/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 82

`get_users/2` has no `@doc`. The function ignores the `customer` param supplied in the request body and instead extracts the customer from JWT claims.

---

#### B020-21 — Missing @doc on get_user_with_email/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 89

`get_user_with_email/2` has no `@doc`. The function fetches a user by email and customer, returning HTTP 500 with an auth-style error message when no user is found.

---

#### B020-22 — Missing @doc on update_key_if_value/3
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 99

`update_key_if_value/3` has no `@doc`. This is a utility function with two clauses (nil guard and general case) that conditionally inserts a key/value pair into a map. Its purpose and usage context within the controller are entirely undocumented.

---

#### B020-23 — Missing @doc on update_user/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 104

`update_user/2` has no `@doc`. Two clauses exist: one that expects both `"customer"` and `"user"` params (line 104) and one that returns an error when `"user"` is absent (line 127). The multi-clause dispatch is undocumented.

---

#### B020-24 — Missing @doc on create_user/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 131

`create_user/2` has no `@doc`. Unlike `create/2`, this function performs a duplicate-email check before creation and handles the distinction between an already-existing account and other errors.

---

#### B020-25 — Missing @doc on delete_user/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 153

`delete_user/2` has no `@doc`. The function deletes a user by `id` within a given customer scope and returns HTTP 200 with an empty JSON body on success.

---

#### B020-26 — Missing @doc on get_user_fleets/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 168

`get_user_fleets/2` has no `@doc`. The function retrieves fleet IDs assigned to a user by filtering `assigned_fleets` restrictions where `aaufun == "FLEET"` and `aaunumval` is non-nil. The filtering logic and the restriction schema are opaque without documentation.

---

#### B020-27 — Missing @doc on manage_user_fleets/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 180

`manage_user_fleets/2` has no `@doc`. The function reconciles the user's fleet assignments: it computes the symmetric difference between current and allowed fleets, then adds and removes accordingly. The idempotency semantics and the side-effects on the database are undocumented.

---

## vx_user_function_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXUserFunctionController`

**Public functions:** None. All action bodies are commented out.

**Commented-out functions (not active, lines noted for reference):**

| Commented function | Lines |
|---|---|
| `index/2` | 9–12 |
| `create/2` | 14–21 |
| `show/2` | 23–26 |
| `update/2` | 28–34 |
| `delete/2` | 36–41 |

**Types / errors / constants defined:** None.

**Additional notes:**
- The entire action body of this controller is commented out. The module compiles but provides no routable actions.
- There is no `@moduledoc`, no `@doc` annotations, and no comment explaining why the functions are disabled or whether they are intended to be re-enabled.
- The module still declares `alias ApiServer.Vx` and `alias ApiServer.Vx.VXUserFunction` and `action_fallback`, suggesting it was scaffolded and then deactivated rather than deleted.

### Findings

#### B020-28 — Missing @moduledoc in VXUserFunctionController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_user_function_controller.ex`, line 1

The module `ApiServerWeb.VXUserFunctionController` has no `@moduledoc`. Given that all action code is commented out, this is the only opportunity to document the module's purpose, its current deactivated state, and the rationale for retaining the file.

---

#### B020-29 — No explanation comment for wholesale commented-out action bodies
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_user_function_controller.ex`, lines 9–41

All five standard CRUD actions (`index`, `create`, `show`, `update`, `delete`) are commented out with no accompanying explanation. There is no `@moduledoc`, inline comment, or annotation indicating whether this is temporary (pending implementation), intentionally disabled (feature flag), or a sign of dead code pending removal. Future maintainers have no context to decide whether to restore, complete, or delete this module.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B020-1 | LOW | vx_thing_omega_controller.ex | Missing @moduledoc |
| B020-2 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_container_lift_report/2 |
| B020-3 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_lift_summary_report/2 (hardwareid clause) |
| B020-4 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_lift_list_report/2 |
| B020-5 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_lift_summary_report/2 (fleetid clause) |
| B020-6 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_operation_summary_report/2 |
| B020-7 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_engine_utilization_report/2 |
| B020-8 | LOW | vx_thing_summary_controller.ex | Missing @moduledoc |
| B020-9 | INFO | vx_thing_summary_controller.ex | Missing @doc on index/2 |
| B020-10 | INFO | vx_thing_summary_controller.ex | Missing @doc on create/2 |
| B020-11 | INFO | vx_thing_summary_controller.ex | Missing @doc on show/2 |
| B020-12 | INFO | vx_thing_summary_controller.ex | Missing @doc on update/2 |
| B020-13 | INFO | vx_thing_summary_controller.ex | Missing @doc on delete/2 |
| B020-14 | INFO | vx_thing_summary_controller.ex | Missing @doc on do_fix_summary/2 (non-action public function) |
| B020-15 | LOW | vx_user_controller.ex | Missing @moduledoc |
| B020-16 | INFO | vx_user_controller.ex | Missing @doc on create/2 |
| B020-17 | INFO | vx_user_controller.ex | Missing @doc on lookup_customer_from_conn/1 |
| B020-18 | INFO | vx_user_controller.ex | Missing @doc on login/2 |
| B020-19 | INFO | vx_user_controller.ex | Missing @doc on change_password/2 |
| B020-20 | INFO | vx_user_controller.ex | Missing @doc on get_users/2 |
| B020-21 | INFO | vx_user_controller.ex | Missing @doc on get_user_with_email/2 |
| B020-22 | INFO | vx_user_controller.ex | Missing @doc on update_key_if_value/3 |
| B020-23 | INFO | vx_user_controller.ex | Missing @doc on update_user/2 |
| B020-24 | INFO | vx_user_controller.ex | Missing @doc on create_user/2 |
| B020-25 | INFO | vx_user_controller.ex | Missing @doc on delete_user/2 |
| B020-26 | INFO | vx_user_controller.ex | Missing @doc on get_user_fleets/2 |
| B020-27 | INFO | vx_user_controller.ex | Missing @doc on manage_user_fleets/2 |
| B020-28 | LOW | vx_user_function_controller.ex | Missing @moduledoc |
| B020-29 | LOW | vx_user_function_controller.ex | All action bodies commented out with no explanation |

<!-- B021.md -->
# Pass 3: Documentation — B021
**Agent:** B021
**Files:**
- `lib/api_server_web/resolvers/puls.ex`
- `lib/api_server_web/resolvers/things.ex`

**Date:** 2026-02-27

---

## lib/api_server_web/resolvers/puls.ex

### Reading Evidence

**Module name:** `ApiServerWeb.Resolvers.Puls`

**Public functions:**

| Function | Arity | Line |
|---|---|---|
| `puls_record/3` | 3 | 3 |

**Types defined:** None

**Error constants defined:** None

**Other constants/module attributes defined:** None (the token string on line 4 is a bare local variable, not a module attribute)

**@moduledoc present:** No

**@doc present on any function:** No

**@spec present on any function:** No

---

### Findings

#### B021-1 — Missing @moduledoc in ApiServerWeb.Resolvers.Puls
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/puls.ex`, line 1

The module `ApiServerWeb.Resolvers.Puls` has no `@moduledoc` attribute. There is no description of the module's purpose, which is to act as a GraphQL resolver for fetching device records from the CalAmp PULS API.

---

#### B021-2 — Missing @doc on puls_record/3
**Severity:** INFO
**File:** `lib/api_server_web/resolvers/puls.ex`, line 3

The public function `puls_record/3` has no `@doc` attribute. A reader has no way to know from documentation alone that this function:
- Accepts a `hardwareid` extracted from the arguments map
- Makes an HTTP GET request to the CalAmp PULS external API
- On HTTP error, blocks the calling process for 60 seconds and then retries recursively
- On HTTP success, decodes the JSON body and returns a map with keys `:esn`, `:iccid`, and `:group`
- Returns `{:ok, record}` on success

---

#### B021-3 — Missing @spec on puls_record/3
**Severity:** INFO
**File:** `lib/api_server_web/resolvers/puls.ex`, line 3

The public function `puls_record/3` has no `@spec` attribute. Standard Elixir convention for public resolver functions is to declare input and return types. The expected return shape is `{:ok, map()} | {:error, any()}`, but this is not documented.

---

## lib/api_server_web/resolvers/things.ex

### Reading Evidence

**Module name:** `ApiServerWeb.Resolvers.Things`

**Public functions:**

| Function | Arity | Line |
|---|---|---|
| `find_thing/3` | 3 | 3 |
| `get_all_things/3` | 3 | 13 |

**Types defined:** None

**Error constants defined:** None

**Other constants/module attributes defined:** None

**@moduledoc present:** No

**@doc present on any function:** No

**@spec present on any function:** No

---

### Findings

#### B021-4 — Missing @moduledoc in ApiServerWeb.Resolvers.Things
**Severity:** LOW
**File:** `lib/api_server_web/resolvers/things.ex`, line 1

The module `ApiServerWeb.Resolvers.Things` has no `@moduledoc` attribute. There is no description of the module's purpose, which is to act as a GraphQL resolver for looking up and listing VX "things" (devices) scoped to a customer.

---

#### B021-5 — Missing @doc on find_thing/3
**Severity:** INFO
**File:** `lib/api_server_web/resolvers/things.ex`, line 3

The public function `find_thing/3` has no `@doc` attribute. A reader has no way to know from documentation alone that this function:
- Accepts `aadhardwareid` (mapped locally to `hardwareid`) and `customer` from the arguments map
- Delegates to `ApiServer.Vx.get_vx_thing_with_hardware_id!/2`
- Returns `{:ok, thing}` on success or `{:error, message}` when the hardware ID is not found for that customer

---

#### B021-6 — Missing @doc on get_all_things/3
**Severity:** INFO
**File:** `lib/api_server_web/resolvers/things.ex`, line 13

The public function `get_all_things/3` has no `@doc` attribute. A reader has no way to know from documentation alone that this function:
- Accepts `customer` from the arguments map
- Delegates to `ApiServer.Vx.list_vxthings/1`
- Converts the `aadhardwareid` field on every returned thing from an integer to a string before returning
- Returns `{:ok, list}` on success or `{:error, message}` when the query returns `nil`

---

#### B021-7 — Missing @spec on find_thing/3
**Severity:** INFO
**File:** `lib/api_server_web/resolvers/things.ex`, line 3

The public function `find_thing/3` has no `@spec` attribute. The expected return shape is `{:ok, map()} | {:error, String.t()}`, but this is not declared.

---

#### B021-8 — Missing @spec on get_all_things/3
**Severity:** INFO
**File:** `lib/api_server_web/resolvers/things.ex`, line 13

The public function `get_all_things/3` has no `@spec` attribute. The expected return shape is `{:ok, list(map())} | {:error, String.t()}`, but this is not declared.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B021-1 | LOW | puls.ex:1 | Missing @moduledoc in ApiServerWeb.Resolvers.Puls |
| B021-2 | INFO | puls.ex:3 | Missing @doc on puls_record/3 |
| B021-3 | INFO | puls.ex:3 | Missing @spec on puls_record/3 |
| B021-4 | LOW | things.ex:1 | Missing @moduledoc in ApiServerWeb.Resolvers.Things |
| B021-5 | INFO | things.ex:3 | Missing @doc on find_thing/3 |
| B021-6 | INFO | things.ex:13 | Missing @doc on get_all_things/3 |
| B021-7 | INFO | things.ex:3 | Missing @spec on find_thing/3 |
| B021-8 | INFO | things.ex:13 | Missing @spec on get_all_things/3 |

<!-- B022.md -->
# Pass 3: Documentation — B022
**Agent:** B022
**Files:**
- `lib/api_server_web/router.ex`
- `lib/api_server_web/schema.ex`
- `lib/api_server_web/schema/thing_types.ex`

**Date:** 2026-02-27

---

## router.ex

### Reading Evidence

**Module name:** `ApiServerWeb.Router`

**Public functions / macros defined (route declarations — no named public functions):**
This file contains no named public functions. It defines three route scopes and four plug pipelines using Phoenix Router DSL macros:

Pipelines:
- `pipeline :browser` (line 4)
- `pipeline :api` (line 12)
- `pipeline :api_xml` (line 18)
- `pipeline :authenticated` (line 24)

Scopes and routes (all are DSL declarations, not named Elixir functions):
- Scope `/api/v1` (authenticated, line 28) — lines 30–154
- Scope `/api/v1` (unauthenticated, line 156) — lines 157–177
- Scope `/` (xml, line 179) — lines 180–193

**Types / errors / constants defined:** None.

**Notable observations:**
- Line 30–31: Two routes (`/rhm/engine_usage`, `/rhm/monday_hour_meters`) appear before `pipe_through([:api, :authenticated])` on line 33, meaning they bypass both the `:api` pipeline (content-type negotiation, session fetch) and authentication. This is a structural observation relevant to documentation accuracy.
- Lines 41–42: A commented-out route for `/rhm/work_in_progress` is replaced by a live route that delegates to `:sielift_export`, with no doc explaining the substitution.
- Lines 97–100: The route `GET /rhm/omega_fleet/:fleetid/operation_summary_report` is declared twice (lines 90–94 and 97–100) — exact duplicate.
- The GraphQL endpoints (`/graphql`, `/graphiql`) are fully commented out (lines 195–202) with no explanation of intent or status.

### Findings

#### B022-1 — Missing @moduledoc on ApiServerWeb.Router
**Severity:** LOW
**File:** `lib/api_server_web/router.ex`, line 1

`ApiServerWeb.Router` has no `@moduledoc`. There is no description of the API surface, the versioning scheme, the authentication model, or the pipeline structure. A developer new to the codebase has no inline guidance on how to understand or extend the routing configuration.

#### B022-2 — Two routes declared outside authentication pipeline with no explanatory comment
**Severity:** LOW
**File:** `lib/api_server_web/router.ex`, lines 30–31

The routes `GET /api/v1/rhm/engine_usage` and `GET /api/v1/rhm/monday_hour_meters` are placed before the `pipe_through([:api, :authenticated])` call on line 33, which means they are served without authentication and without the `:api` pipeline (no session fetch, no JSON format enforcement). There is only the comment `# Avoid authentication, locking to a specific database` which does not explain why these specific endpoints are unauthenticated, what access controls (if any) protect them, or what "locking to a specific database" means. This is a documentation gap that obscures a security-relevant design decision.

#### B022-3 — Misleading route comment for /rhm/work_in_progress
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, line 41–42

The comment `# get "/rhm/work_in_progress", VXThingController, :work_in_progress` implies the live route below it (`get("/rhm/work_in_progress", VXThingController, :sielift_export)`) is a replacement, but there is no comment explaining that `:work_in_progress` does not exist or was intentionally substituted with `:sielift_export`. A reader could mistakenly believe `:work_in_progress` is the active action. The existing comment is inaccurate in context: it documents intent that does not match the actual running behaviour, which is to call `:sielift_export`.

#### B022-4 — Duplicate route declaration with no comment
**Severity:** LOW
**File:** `lib/api_server_web/router.ex`, lines 90–94 and 97–100

`GET /rhm/omega_fleet/:fleetid/operation_summary_report` is declared twice, mapping to the same controller action `VXThingOmegaController.get_operation_summary_report/2`. There is no comment acknowledging this duplication. Phoenix will silently use the first matched route. The second declaration is dead code and its presence without explanation is a documentation gap that will confuse maintainers.

#### B022-5 — Commented-out GraphQL endpoints with no status explanation
**Severity:** LOW
**File:** `lib/api_server_web/router.ex`, lines 195–202

The `forward "/graphql"` and `forward "/graphiql"` blocks are commented out. There is no comment indicating whether these are planned, temporarily disabled, deprecated, or removed. The inline comment `# For the GraphiQL interactive interface, a must-have for happy frontend devs.` describes the feature but provides no status. A maintainer cannot determine whether to restore, remove, or ignore these blocks.

---

## schema.ex

### Reading Evidence

**Module name:** `ApiServerWeb.Schema`

**Public functions / macros defined:**
This file defines an Absinthe GraphQL schema using DSL macros. No named public Elixir functions are defined. The `query` block defines three GraphQL query fields:

- `field :get_thing` (line 11) — resolves via `Resolvers.Things.find_thing/3`, args: `aadhardwareid` (non-null string), `customer` (non-null string)
- `field :get_puls_record` (line 18) — resolves via `Resolvers.Puls.puls_record/3`, arg: `hardwareid` (non-null string)
- `field :get_all_things` (line 24) — resolves via `Resolvers.Things.get_all_things/3`, arg: `customer` (non-null string)

Each field carries an Absinthe `@desc` attribute (lines 10, 17, 23).

**Types / errors / constants defined:** None defined directly; `ThingTypes` is imported via `import_types`.

**Notable observations:**
- `field :get_thing` on line 11 accepts `aadhardwareid` as an argument name. This is an internal database column name exposed as a public GraphQL API argument. The `@desc` ("Get a Thing") does not document the argument naming convention or its meaning.
- The schema is unused at runtime: both `forward "/graphql"` and `forward "/graphiql"` are commented out in the router (router.ex lines 195–202).

### Findings

#### B022-6 — Missing @moduledoc on ApiServerWeb.Schema
**Severity:** LOW
**File:** `lib/api_server_web/schema.ex`, line 1

`ApiServerWeb.Schema` has no `@moduledoc`. There is no description of the GraphQL schema's purpose, its relationship to the REST API, or the fact that the schema is currently unreachable at runtime (the router forwards are commented out).

#### B022-7 — @desc "Get a Thing" does not document the aadhardwareid argument name
**Severity:** LOW
**File:** `lib/api_server_web/schema.ex`, line 10–15

The `@desc` for `:get_thing` reads "Get a Thing". The argument is named `aadhardwareid`, which is an internal database column prefix (`aad`) not meaningful to API consumers. The description provides no explanation of what `aadhardwareid` represents, what format it expects, or how it differs from the `hardwareid` argument used by `:get_puls_record`. This is a documentation gap that will hinder API consumers.

#### B022-8 — @desc fields do not document resolver behaviour or error conditions
**Severity:** INFO
**File:** `lib/api_server_web/schema.ex`, lines 10, 17, 23

All three query fields (`get_thing`, `get_puls_record`, `get_all_things`) have minimal single-sentence `@desc` values. None document: return shape when no record is found, possible error states, required argument formats, or the customer/tenant scoping behaviour. While Absinthe `@desc` is not the same as `@doc`, it serves as the schema's introspectable documentation and the gaps here reduce usability.

---

## schema/thing_types.ex

### Reading Evidence

**Module name:** `ApiServerWeb.Schema.ThingTypes`

**Public functions / macros defined:**
This file defines Absinthe object types using DSL macros. No named public Elixir functions are defined.

Absinthe object types defined:
- `object :thing` (line 5) — with `@desc "A Thing"` (line 4)
  Fields (lines 6–37):
  - `:aadcustcode` — `:string`
  - `:aaddesc` — `:string`
  - `:aadintext` — `:string`
  - `:aadaddr` — `:string`
  - `:aadcustomerid` — `:integer`
  - `:aadcat` — `:integer`
  - `:aadhardwareid` — `:string`
  - `:aadhw_type` — `:integer`
  - `:aadmake` — `:string`
  - `:aadmodel` — `:string`
  - `:aadserialno` — `:string`
  - `:aadmobile` — `:string`
  - `:aadimei` — `:string`
  - `:aadhourmeter` — `:float`
  - `:aadhourmeter1` — `:float`
  - `:aadhourmeter2` — `:float`
  - `:aadhourmeter3` — `:float`
  - `:aadhourmeter4` — `:float`
  - `:aadodometer` — `:integer`
  - `:aadhourmeteromega` — `:float`
  - `:aadhourmeterothcan` — `:float`
  - `:aaddateintoservice` — `:date`
  - `:aadlastservice` — `:date`
  - `:aadvalid` — `:string`
  - `:aadserviceoffset` — `:float`
  - `:aadsvchrs` — `:integer`
  - `:aadrange_lat` — `:float`
  - `:aadrange_long` — `:float`
  - `:aadrange_dist` — `:integer`
  - `:aadrange_unit` — `:string`
  - `:service_calculation_input` — `:string`

- `object :puls_record` (line 41) — with `@desc "The record of a thing from PULS"` (line 40)
  Fields (lines 42–44):
  - `:esn` — `:string`
  - `:iccid` — `:string`
  - `:group` — `:string`

**Types / errors / constants defined:** None.

### Findings

#### B022-9 — Missing @moduledoc on ApiServerWeb.Schema.ThingTypes
**Severity:** LOW
**File:** `lib/api_server_web/schema/thing_types.ex`, line 1

`ApiServerWeb.Schema.ThingTypes` has no `@moduledoc`. There is no description of what this module provides, what the `aad` column prefix convention means, or the relationship between these types and the underlying database schema.

#### B022-10 — No @desc on any field of the :thing object type
**Severity:** INFO
**File:** `lib/api_server_web/schema/thing_types.ex`, lines 6–37

The `:thing` object type carries 31 fields, all named with the internal `aad` prefix that is opaque to API consumers. None of the fields have an Absinthe `@desc` attribute. Without field-level descriptions, GraphiQL introspection and generated documentation will show bare column names with no indication of their purpose. Examples of fields that particularly need description include `:aadcat` (category code — meaning unknown without source lookup), `:aadhourmeter` through `:aadhourmeter4` (purpose of each meter variant is undocumented), `:aadvalid` (not a boolean despite the name; type is `:string`), and `:service_calculation_input` (the only non-`aad`-prefixed field, suggesting a derived or computed value with no explanation).

#### B022-11 — No @desc on any field of the :puls_record object type
**Severity:** INFO
**File:** `lib/api_server_web/schema/thing_types.ex`, lines 42–44

The `:puls_record` object type has three fields (`:esn`, `:iccid`, `:group`) with no `@desc` attributes. "PULS" is not defined anywhere in this file. A consumer cannot determine from introspection what PULS is, what ESN or ICCID represent (Electronic Serial Number, Integrated Circuit Card Identifier — telecom identifiers), or what `:group` groups by.

#### B022-12 — @desc "A Thing" on :thing object is insufficiently descriptive
**Severity:** LOW
**File:** `lib/api_server_web/schema/thing_types.ex`, line 4

The `@desc` for `:thing` is "A Thing". This provides no domain context. The object represents a tracked physical asset (forklift, vehicle, or other piece of equipment) with telemetry data. The description does not explain the `aad` naming convention (which comes from an internal database schema), the concept of the hardware ID as the primary identifier, or the relationship to customers and fleets.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B022-1 | LOW | router.ex:1 | Missing `@moduledoc` on `ApiServerWeb.Router` |
| B022-2 | LOW | router.ex:30–31 | Unauthenticated routes lack adequate explanatory documentation |
| B022-3 | MEDIUM | router.ex:41–42 | Misleading comment implies `:work_in_progress` action is active; actual route calls `:sielift_export` |
| B022-4 | LOW | router.ex:97–100 | Duplicate `GET /rhm/omega_fleet/:fleetid/operation_summary_report` route with no comment |
| B022-5 | LOW | router.ex:195–202 | Commented-out GraphQL endpoints have no status explanation |
| B022-6 | LOW | schema.ex:1 | Missing `@moduledoc` on `ApiServerWeb.Schema` |
| B022-7 | LOW | schema.ex:10–15 | `@desc` for `:get_thing` does not explain the `aadhardwareid` argument or its format |
| B022-8 | INFO | schema.ex:10,17,23 | All query field `@desc` values lack documentation of return behaviour and error conditions |
| B022-9 | LOW | thing_types.ex:1 | Missing `@moduledoc` on `ApiServerWeb.Schema.ThingTypes` |
| B022-10 | INFO | thing_types.ex:6–37 | No `@desc` on any of the 31 fields of the `:thing` Absinthe object type |
| B022-11 | INFO | thing_types.ex:42–44 | No `@desc` on any field of the `:puls_record` Absinthe object type |
| B022-12 | LOW | thing_types.ex:4 | `@desc "A Thing"` on `:thing` object is insufficiently descriptive |

<!-- B023.md -->
# Pass 3: Documentation — B023
**Agent:** B023
**Files:**
- `lib/api_server_web/views/changeset_view.ex`
- `lib/api_server_web/views/error_helpers.ex`
- `lib/api_server_web/views/error_view.ex`
- `lib/api_server_web/views/file_view.ex`

**Date:** 2026-02-27

---

## changeset_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.ChangesetView`

**Public functions:**

| Function | Line |
|---|---|
| `translate_errors/1` | 10 |
| `render/2` ("error.json") | 14 |

**Types / errors / constants defined:** None.

**Annotations present:**
- `@moduledoc`: absent
- `translate_errors/1`: has `@doc` (lines 4–9)
- `render/2`: no `@doc`

---

### Findings

#### B023-1 — Missing @moduledoc in ChangesetView
**Severity:** LOW
**File:** `lib/api_server_web/views/changeset_view.ex`, line 1

`ApiServerWeb.ChangesetView` has no `@moduledoc`. There is no module-level description explaining that this view is responsible for rendering changeset error responses in JSON format, or how it is used in the Phoenix view layer.

---

#### B023-2 — Missing @doc on render/2 ("error.json") in ChangesetView
**Severity:** INFO
**File:** `lib/api_server_web/views/changeset_view.ex`, line 14

The public function `render("error.json", %{changeset: changeset})` has no `@doc`. It renders changeset errors as a JSON object under the `errors` key, but this is only described by an inline comment. A `@doc` annotation is missing.

---

## error_helpers.ex

### Reading Evidence

**Module:** `ApiServerWeb.ErrorHelpers`

**Public functions:**

| Function | Line |
|---|---|
| `error_tag/2` | 11 |
| `translate_error/1` | 20 |

**Types / errors / constants defined:** None.

**Annotations present:**
- `@moduledoc`: present (lines 3–4) — "Conveniences for translating and building error messages."
- `error_tag/2`: has `@doc` (lines 8–10)
- `translate_error/1`: has `@doc` (lines 17–19)

---

### Findings

No documentation findings for this file. Both public functions have `@doc` annotations and the module has a `@moduledoc`. The `@doc` for `translate_error/1` is brief ("Translates an error message using gettext.") but is directionally accurate relative to the implementation, which calls `Gettext.dgettext`/`Gettext.dngettext` with plural-form support. No inaccuracies identified.

---

## error_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.ErrorView`

**Public functions:**

| Function | Line |
|---|---|
| `template_not_found/2` | 13 |

**Types / errors / constants defined:** None.

**Annotations present:**
- `@moduledoc`: absent
- `template_not_found/2`: no `@doc`

---

### Findings

#### B023-3 — Missing @moduledoc in ErrorView
**Severity:** LOW
**File:** `lib/api_server_web/views/error_view.ex`, line 1

`ApiServerWeb.ErrorView` has no `@moduledoc`. There is no module-level description explaining that this view renders HTTP error responses (e.g., 404, 500) for all formats by mapping template names to status messages via `Phoenix.Controller.status_message_from_template/1`.

---

#### B023-4 — Missing @doc on template_not_found/2 in ErrorView
**Severity:** INFO
**File:** `lib/api_server_web/views/error_view.ex`, line 13

The public function `template_not_found/2` has no `@doc`. This Phoenix callback is invoked when no matching render clause exists for a given template name; it returns a map with an `error` key containing the HTTP status message derived from the template name. The existing inline comment describes the Phoenix behavior but does not substitute for a `@doc` annotation.

---

## file_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.FileView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("index.json") | 5 |
| `render/2` ("show.json") | 9 |
| `render/2` ("filesize.json") | 13 |
| `render/2` ("file.json") | 20 |

**Types / errors / constants defined:** None.

**Annotations present:**
- `@moduledoc`: absent
- All `render/2` clauses: no `@doc`

---

### Findings

#### B023-5 — Missing @moduledoc in FileView
**Severity:** LOW
**File:** `lib/api_server_web/views/file_view.ex`, line 1

`ApiServerWeb.FileView` has no `@moduledoc`. There is no module-level description explaining that this view serialises file records to JSON, including the shapes of the `index.json`, `show.json`, `filesize.json`, and `file.json` templates or the fields (`hardwareid`, `size`, `num_fobs`, `fobs`) they expose.

---

#### B023-6 — Missing @doc on render/2 ("index.json") in FileView
**Severity:** INFO
**File:** `lib/api_server_web/views/file_view.ex`, line 5

The `render("index.json", %{files: files})` clause has no `@doc`. It renders a list of files under a `data` key using `render_many/3`.

---

#### B023-7 — Missing @doc on render/2 ("show.json") in FileView
**Severity:** INFO
**File:** `lib/api_server_web/views/file_view.ex`, line 9

The `render("show.json", %{file: file})` clause has no `@doc`. It renders a single file record under a `data` key using `render_one/3`.

---

#### B023-8 — Missing @doc on render/2 ("filesize.json") in FileView
**Severity:** INFO
**File:** `lib/api_server_web/views/file_view.ex`, line 13

The `render("filesize.json", %{file: file})` clause has no `@doc`. It serialises a subset of file fields (`hardwareid`, `size`, `num_fobs`) without the `fobs` field that appears in the full `file.json` template. The omission of `fobs` is noteworthy and undocumented.

---

#### B023-9 — Missing @doc on render/2 ("file.json") in FileView
**Severity:** INFO
**File:** `lib/api_server_web/views/file_view.ex`, line 20

The `render("file.json", %{file: file})` clause has no `@doc`. This is the inner template used by `render_many`/`render_one`; it serialises all four fields: `hardwareid`, `size`, `num_fobs`, and `fobs`.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B023-1 | LOW | `changeset_view.ex` line 1 | Missing `@moduledoc` in `ApiServerWeb.ChangesetView` |
| B023-2 | INFO | `changeset_view.ex` line 14 | Missing `@doc` on `render/2` ("error.json") |
| B023-3 | LOW | `error_view.ex` line 1 | Missing `@moduledoc` in `ApiServerWeb.ErrorView` |
| B023-4 | INFO | `error_view.ex` line 13 | Missing `@doc` on `template_not_found/2` |
| B023-5 | LOW | `file_view.ex` line 1 | Missing `@moduledoc` in `ApiServerWeb.FileView` |
| B023-6 | INFO | `file_view.ex` line 5 | Missing `@doc` on `render/2` ("index.json") |
| B023-7 | INFO | `file_view.ex` line 9 | Missing `@doc` on `render/2` ("show.json") |
| B023-8 | INFO | `file_view.ex` line 13 | Missing `@doc` on `render/2` ("filesize.json") |
| B023-9 | INFO | `file_view.ex` line 20 | Missing `@doc` on `render/2` ("file.json") |

<!-- B024.md -->
# Pass 3: Documentation — B024
**Agent:** B024
**Files:**
- `lib/api_server_web/views/geofence_view.ex`
- `lib/api_server_web/views/layout_view.ex`
- `lib/api_server_web/views/page_view.ex`
- `lib/api_server_web/views/vx_abl_record_view.ex`

**Date:** 2026-02-27

---

## geofence_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.GeofenceView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("index.json") | 9 |
| `render/2` ("geofence.json") | 13 |
| `render/2` ("geofence_events.json") | 22 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc` absent, no `@doc` on any clause).

---

### Findings

#### B024-1 — Missing @moduledoc in GeofenceView
**Severity:** LOW
**File:** `lib/api_server_web/views/geofence_view.ex`, line 1

The module `ApiServerWeb.GeofenceView` has no `@moduledoc` attribute. There is no description of the module's purpose (rendering geofence and geofence-event JSON responses), its dependencies on `ApiServer.Vx.Geofence`, or the template keys it expects in each assigns map.

---

#### B024-2 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/geofence_view.ex`, line 9

The `render/2` clause matching `"index.json"` has no `@doc`. The expected assigns key (`geofences`) and the return shape (a list of geofence maps, each rendered via `"geofence.json"`) are not documented.

---

#### B024-3 — Missing @doc on render/2 ("geofence.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/geofence_view.ex`, line 13

The `render/2` clause matching `"geofence.json"` has no `@doc`. The expected assigns key (`geofence`), the returned map shape (`%{id, name, geoJSON}`), and the fact that `geojson` is converted from a DB string to a map via `Geofence.geojson_db_string_to_map/1` are not documented.

---

#### B024-4 — Missing @doc on render/2 ("geofence_events.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/geofence_view.ex`, line 22

The `render/2` clause matching `"geofence_events.json"` has no `@doc`. The expected assigns keys (`geofence_events` and `thing`), the delegation to `VXThingView` for `"rhm_thing.json"`, and the list-of-maps return shape are not documented.

---

## layout_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.LayoutView`

**Public functions:** None defined explicitly (the module body consists solely of `use ApiServerWeb, :view`).

**Types / errors / constants defined:** None.

**Documentation attributes present:** None.

---

### Findings

#### B024-5 — Missing @moduledoc in LayoutView
**Severity:** LOW
**File:** `lib/api_server_web/views/layout_view.ex`, line 1

The module `ApiServerWeb.LayoutView` has no `@moduledoc`. Even though the module currently contains no custom functions, a `@moduledoc false` (if intentionally undocumented) or a brief description of its role as the Phoenix layout view is absent.

---

## page_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.PageView`

**Public functions:** None defined explicitly (the module body consists solely of `use ApiServerWeb, :view`).

**Types / errors / constants defined:** None.

**Documentation attributes present:** None.

---

### Findings

#### B024-6 — Missing @moduledoc in PageView
**Severity:** LOW
**File:** `lib/api_server_web/views/page_view.ex`, line 1

The module `ApiServerWeb.PageView` has no `@moduledoc`. Even though the module currently contains no custom functions, a `@moduledoc false` or a brief description of its role as the Phoenix page view is absent.

---

## vx_abl_record_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXAblRecordView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("index.json") | 8 |
| `render/2` ("show.json") | 12 |
| `render/2` ("vx_abl_record.json") | 16 |
| `render/2` ("services.json") | 22 |
| `clean_xml_value/1` | 28 |
| `clean_xml_number_value/1` | 37 |
| `render/2` ("service.json") | 46 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc` absent, no `@doc` on any function).

---

### Findings

#### B024-7 — Missing @moduledoc in VXAblRecordView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`, line 1

The module `ApiServerWeb.VXAblRecordView` has no `@moduledoc`. There is no description of its purpose (rendering ABL audit-log records as JSON), its relationship to `ApiServer.Vx`, or the data sources it draws from.

---

#### B024-8 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`, line 8

The `render/2` clause matching `"index.json"` has no `@doc`. The expected assigns key (`vxablrecords`) and the `%{data: [...]}` envelope shape are not documented.

---

#### B024-9 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`, line 12

The `render/2` clause matching `"show.json"` has no `@doc`. The expected assigns key (`vx_abl_record`) and the `%{data: %{...}}` envelope shape are not documented.

---

#### B024-10 — Missing @doc on render/2 ("vx_abl_record.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`, line 16

The `render/2` clause matching `"vx_abl_record.json"` has no `@doc`. The returned map shape (`%{id, ablcustcode}`) and the assigns key (`vx_abl_record`) are not documented.

---

#### B024-11 — Missing @doc on render/2 ("services.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`, line 22

The `render/2` clause matching `"services.json"` has no `@doc`. The expected assigns keys (`records` and `customer`), the delegation to the `"service.json"` clause via a `{record, customer}` tuple, and the list return shape are not documented.

---

#### B024-12 — Missing @doc on clean_xml_value/1
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`, line 28

The public function `clean_xml_value/1` has no `@doc`. There is no explanation of what it normalises (an empty map `%{}` — the result of XML-decoded absent elements — to `nil`), what its input type is, or what it returns. This function is public and forms part of the view's utility surface.

---

#### B024-13 — Missing @doc on clean_xml_number_value/1
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`, line 37

The public function `clean_xml_number_value/1` has no `@doc`. There is no explanation that it converts an absent XML numeric value (represented as `%{}`) to `0`, or that it is intended for numeric fields where `nil` would be inappropriate. The distinction from `clean_xml_value/1` is not documented.

---

#### B024-14 — Missing @doc on render/2 ("service.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_abl_record_view.ex`, line 46

The `render/2` clause matching `"service.json"` has no `@doc`. This is the most complex render clause in the file: it accepts a `{record, customer}` tuple under the `:vx_abl_record` assigns key, performs a conditional lookup of a VX thing by `hardwareid` via `Vx.get_vx_thing_with_hardware_id!/2`, constructs fleet membership JSON, resolves the user display name, and returns a wide map of audit-log service fields. None of this logic, its side-effects, or its return shape is documented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B024-1 | LOW | `geofence_view.ex:1` | Missing `@moduledoc` in `ApiServerWeb.GeofenceView` |
| B024-2 | INFO | `geofence_view.ex:9` | Missing `@doc` on `render/2` ("index.json") |
| B024-3 | INFO | `geofence_view.ex:13` | Missing `@doc` on `render/2` ("geofence.json") |
| B024-4 | INFO | `geofence_view.ex:22` | Missing `@doc` on `render/2` ("geofence_events.json") |
| B024-5 | LOW | `layout_view.ex:1` | Missing `@moduledoc` in `ApiServerWeb.LayoutView` |
| B024-6 | LOW | `page_view.ex:1` | Missing `@moduledoc` in `ApiServerWeb.PageView` |
| B024-7 | LOW | `vx_abl_record_view.ex:1` | Missing `@moduledoc` in `ApiServerWeb.VXAblRecordView` |
| B024-8 | INFO | `vx_abl_record_view.ex:8` | Missing `@doc` on `render/2` ("index.json") |
| B024-9 | INFO | `vx_abl_record_view.ex:12` | Missing `@doc` on `render/2` ("show.json") |
| B024-10 | INFO | `vx_abl_record_view.ex:16` | Missing `@doc` on `render/2` ("vx_abl_record.json") |
| B024-11 | INFO | `vx_abl_record_view.ex:22` | Missing `@doc` on `render/2` ("services.json") |
| B024-12 | INFO | `vx_abl_record_view.ex:28` | Missing `@doc` on `clean_xml_value/1` |
| B024-13 | INFO | `vx_abl_record_view.ex:37` | Missing `@doc` on `clean_xml_number_value/1` |
| B024-14 | INFO | `vx_abl_record_view.ex:46` | Missing `@doc` on `render/2` ("service.json") — most complex clause |

<!-- B025.md -->
# Pass 3: Documentation — B025
**Agent:** B025
**Files:**
- `lib/api_server_web/views/vx_access_fob_view.ex`
- `lib/api_server_web/views/vx_customer_view.ex`
- `lib/api_server_web/views/vx_fleet_association_view.ex`
- `lib/api_server_web/views/vx_fleet_view.ex`

**Date:** 2026-02-27

---

## vx_access_fob_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXAccessFobView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("index.json") | 5 |
| `render/2` ("show.json") | 9 |
| `render/2` ("vx_access_fob.json") | 13 |

**Types defined:** None
**Constants defined:** None
**Errors defined:** None
**@moduledoc:** Absent
**@doc annotations:** None present on any clause

### Findings

#### B025-1 — Missing @moduledoc in VXAccessFobView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`, line 1

The module `ApiServerWeb.VXAccessFobView` has no `@moduledoc` attribute. There is no description of the module's purpose, the resource it serialises, or the JSON templates it supports (`index.json`, `show.json`, `vx_access_fob.json`).

#### B025-2 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`, line 5

The public function clause `render("index.json", ...)` has no `@doc`. Its behaviour (wrapping a list of access-fob maps under a `data` key) is not documented.

#### B025-3 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`, line 9

The public function clause `render("show.json", ...)` has no `@doc`. Its behaviour (wrapping a single access-fob map under a `data` key) is not documented.

#### B025-4 — Missing @doc on render/2 ("vx_access_fob.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_access_fob_view.ex`, line 13

The public function clause `render("vx_access_fob.json", ...)` has no `@doc`. The fields it serialises (`id`, `fob_code`) are not described.

---

## vx_customer_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXCustomerView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("index.json") | 5 |
| `render/2` ("show.json") | 9 |
| `render/2` ("vx_customer.json") — nil guard clause | 13 |
| `render/2` ("vx_customer.json") — loaded guard clause | 14 |

**Types defined:** None
**Constants defined:** None
**Errors defined:** None
**@moduledoc:** Absent
**@doc annotations:** None present on any clause

**Notable implementation detail:** The `render("vx_customer.json", ...)` clause at line 14 guards against an unloaded Ecto association (`Ecto.assoc_loaded?/1`) and returns `%{}` if the association is not loaded. Two fields (`aaaudfcustcode`, `aaacolour`) are commented out.

### Findings

#### B025-5 — Missing @moduledoc in VXCustomerView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_customer_view.ex`, line 1

The module `ApiServerWeb.VXCustomerView` has no `@moduledoc`. There is no description of the resource being serialised, the templates supported, or the commented-out fields that were intentionally excluded.

#### B025-6 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_customer_view.ex`, line 5

The public function clause `render("index.json", ...)` has no `@doc`. Unlike `VXAccessFobView`, this clause returns a bare list rather than a `%{data: ...}` wrapper; this intentional difference is undocumented.

#### B025-7 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_customer_view.ex`, line 9

The public function clause `render("show.json", ...)` has no `@doc`. It also returns a bare result (no `data` wrapper), which is inconsistent with other view modules and is undocumented.

#### B025-8 — Missing @doc on render/2 ("vx_customer.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_customer_view.ex`, line 13

Neither clause of `render("vx_customer.json", ...)` has a `@doc`. The guard logic (returning `%{}` for a `nil` customer and for an unloaded Ecto association) is non-obvious and merits documentation. The commented-out fields `aaaudfcustcode` and `aaacolour` also deserve an explanation of why they were excluded.

---

## vx_fleet_association_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXFleetAssociationView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("index.json") | 5 |
| `render/2` ("show.json") | 9 |
| `render/2` ("vx_fleet_association.json") | 13 |

**Types defined:** None
**Constants defined:** None
**Errors defined:** None
**@moduledoc:** Absent
**@doc annotations:** None present on any clause

**Notable implementation detail:** The assign key in the `index.json` clause is `[REDACTED-AWS-SMTP-PASSWORD]` (double `s`), which appears to be a typo in the assign name.

### Findings

#### B025-9 — Missing @moduledoc in VXFleetAssociationView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`, line 1

The module `ApiServerWeb.VXFleetAssociationView` has no `@moduledoc`. There is no description of the resource being serialised or the templates it supports.

#### B025-10 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`, line 5

The public function clause `render("index.json", ...)` has no `@doc`. The assign key `[REDACTED-AWS-SMTP-PASSWORD]` (note the double `s`) is unusual and would benefit from a note explaining the expected assign structure.

#### B025-11 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`, line 9

The public function clause `render("show.json", ...)` has no `@doc`.

#### B025-12 — Missing @doc on render/2 ("vx_fleet_association.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_association_view.ex`, line 13

The public function clause `render("vx_fleet_association.json", ...)` has no `@doc`. The fields serialised (`id`, `aafcustcode`) are not described; `aafcustcode` is an opaque legacy column name that particularly warrants documentation.

---

## vx_fleet_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXFleetView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("index.json") | 5 |
| `render/2` ("show.json") | 9 |
| `render/2` ("vx_fleet.json") | 13 |
| `render/2` ("rhm_fleets.json") | 22 |
| `render/2` ("rhm_fleet.json") | 25 |
| `render/2` ("rhm_fleets_with_equip.json") | 34 |
| `render/2` ("rhm_fleet_with_equip.json") | 37 |
| `render/2` ("rhm_fleet_equipment.json") | 47 |
| `render/2` ("assoc.json") | 51 |

**Types defined:** None
**Constants defined:** None
**Errors defined:** None
**@moduledoc:** Absent
**@doc annotations:** None present on any clause

**Notable implementation detail:** Two distinct serialisation conventions coexist in this module. The `vx_fleet.json` clause (line 13) exposes raw legacy column names (`aaetype`, `aaeshowfilter`, `aaecolour`) with no `id` alias. The `rhm_fleet.json` clause (line 25) maps the same resource to human-readable keys (`name`, `type`, `show_in_filters`, `color`) and also includes `aaeid` as `id`. The `rhm_fleet_with_equip.json` clause (line 37) is identical to `rhm_fleet.json` except it includes an `equipment` preloaded association and omits `color`. The `assoc.json` clause (line 51) deserialises a raw tuple `{fleet_id, equipment_id, equipment_name}` rather than a struct, which is atypical.

### Findings

#### B025-13 — Missing @moduledoc in VXFleetView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 1

The module `ApiServerWeb.VXFleetView` has no `@moduledoc`. This is the most complex view in the assigned set, with nine render clauses covering two distinct serialisation conventions (`vx_fleet` using raw column names, `rhm_fleet` using human-readable keys). The absence of any module-level documentation makes it significantly harder to understand which templates serve which consumers.

#### B025-14 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 5

The public function clause `render("index.json", ...)` has no `@doc`.

#### B025-15 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 9

The public function clause `render("show.json", ...)` has no `@doc`.

#### B025-16 — Missing @doc on render/2 ("vx_fleet.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 13

The public function clause `render("vx_fleet.json", ...)` has no `@doc`. This clause exposes raw legacy column names (`aaetype`, `aaeshowfilter`, `aaecolour`) directly in the JSON response rather than mapping them to human-readable names as the `rhm_fleet` family does; this difference is entirely undocumented.

#### B025-17 — Missing @doc on render/2 ("rhm_fleets.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 22

The public function clause `render("rhm_fleets.json", ...)` has no `@doc`. The purpose of the `rhm_` prefix (presumably a distinct API consumer or product line) is undocumented.

#### B025-18 — Missing @doc on render/2 ("rhm_fleet.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 25

The public function clause `render("rhm_fleet.json", ...)` has no `@doc`. This clause maps legacy column names to human-readable keys (`name`, `type`, `show_in_filters`, `color`) — the opposite convention from `vx_fleet.json` — and this design choice is undocumented.

#### B025-19 — Missing @doc on render/2 ("rhm_fleets_with_equip.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 34

The public function clause `render("rhm_fleets_with_equip.json", ...)` has no `@doc`. It is unclear from code alone whether the `equipment` association is expected to be preloaded by the caller or can be `nil`.

#### B025-20 — Missing @doc on render/2 ("rhm_fleet_with_equip.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 37

The public function clause `render("rhm_fleet_with_equip.json", ...)` has no `@doc`. This clause includes `equipment` but omits `color` compared to `rhm_fleet.json`; the omission is undocumented.

#### B025-21 — Missing @doc on render/2 ("rhm_fleet_equipment.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 47

The public function clause `render("rhm_fleet_equipment.json", ...)` has no `@doc`. It uses an assign key of `results` (rather than `vx_fleets`) and delegates to the `assoc.json` template, neither of which is explained.

#### B025-22 — Missing @doc on render/2 ("assoc.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_fleet_view.ex`, line 51

The public function clause `render("assoc.json", ...)` has no `@doc`. This clause is unusual: it pattern-matches on a raw 3-tuple `{fleet_id, equipment_id, equipment_name}` rather than a struct or map. The caller must supply data in this exact shape, and that contract is entirely undocumented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B025-1 | LOW | `vx_access_fob_view.ex` line 1 | Missing `@moduledoc` in `VXAccessFobView` |
| B025-2 | INFO | `vx_access_fob_view.ex` line 5 | Missing `@doc` on `render/2` ("index.json") |
| B025-3 | INFO | `vx_access_fob_view.ex` line 9 | Missing `@doc` on `render/2` ("show.json") |
| B025-4 | INFO | `vx_access_fob_view.ex` line 13 | Missing `@doc` on `render/2` ("vx_access_fob.json") |
| B025-5 | LOW | `vx_customer_view.ex` line 1 | Missing `@moduledoc` in `VXCustomerView` |
| B025-6 | INFO | `vx_customer_view.ex` line 5 | Missing `@doc` on `render/2` ("index.json") — bare list return undocumented |
| B025-7 | INFO | `vx_customer_view.ex` line 9 | Missing `@doc` on `render/2` ("show.json") — bare result return undocumented |
| B025-8 | INFO | `vx_customer_view.ex` line 13 | Missing `@doc` on `render/2` ("vx_customer.json") — nil and unloaded-assoc guard logic undocumented |
| B025-9 | LOW | `vx_fleet_association_view.ex` line 1 | Missing `@moduledoc` in `[REDACTED-AWS-SMTP-PASSWORD]` |
| B025-10 | INFO | `vx_fleet_association_view.ex` line 5 | Missing `@doc` on `render/2` ("index.json") — unusual double-`s` assign key undocumented |
| B025-11 | INFO | `vx_fleet_association_view.ex` line 9 | Missing `@doc` on `render/2` ("show.json") |
| B025-12 | INFO | `vx_fleet_association_view.ex` line 13 | Missing `@doc` on `render/2` ("vx_fleet_association.json") — opaque column name `aafcustcode` undocumented |
| B025-13 | LOW | `vx_fleet_view.ex` line 1 | Missing `@moduledoc` in `VXFleetView` — module has 9 clauses across two serialisation conventions |
| B025-14 | INFO | `vx_fleet_view.ex` line 5 | Missing `@doc` on `render/2` ("index.json") |
| B025-15 | INFO | `vx_fleet_view.ex` line 9 | Missing `@doc` on `render/2` ("show.json") |
| B025-16 | INFO | `vx_fleet_view.ex` line 13 | Missing `@doc` on `render/2` ("vx_fleet.json") — raw legacy column names in response undocumented |
| B025-17 | INFO | `vx_fleet_view.ex` line 22 | Missing `@doc` on `render/2` ("rhm_fleets.json") — `rhm_` consumer context undocumented |
| B025-18 | INFO | `vx_fleet_view.ex` line 25 | Missing `@doc` on `render/2` ("rhm_fleet.json") — human-readable key mapping undocumented |
| B025-19 | INFO | `vx_fleet_view.ex` line 34 | Missing `@doc` on `render/2` ("rhm_fleets_with_equip.json") — preload requirement undocumented |
| B025-20 | INFO | `vx_fleet_view.ex` line 37 | Missing `@doc` on `render/2` ("rhm_fleet_with_equip.json") — omission of `color` field undocumented |
| B025-21 | INFO | `vx_fleet_view.ex` line 47 | Missing `@doc` on `render/2` ("rhm_fleet_equipment.json") — `results` assign key undocumented |
| B025-22 | INFO | `vx_fleet_view.ex` line 51 | Missing `@doc` on `render/2` ("assoc.json") — raw 3-tuple contract undocumented |

<!-- B026.md -->
# Pass 3: Documentation — B026
**Agent:** B026
**Files:**
- `lib/api_server_web/views/vx_rental_view.ex`
- `lib/api_server_web/views/vx_restriction_view.ex`
- `lib/api_server_web/views/vx_thing_event_view.ex`
- `lib/api_server_web/views/vx_thing_omega_view.ex`

**Date:** 2026-02-27

---

## vx_rental_view.ex

### Reading Evidence

**Module name:** `ApiServerWeb.VXRentalView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("rhm_rentals.json") | 8 |
| `render/2` ("rhm_rental.json") | 13 |
| `render/2` ("midpac_report.json") | 64 |
| `render/2` ("rental_anniversaries.json") | 68 |
| `convert_json_to_changeset/1` | 73 |

**Private functions:**
- None

**Types / errors / constants defined:** None

**Documentation present:**
- `@moduledoc`: absent
- `@doc` on any public function: absent

---

### Findings

#### B026-1 — Missing @moduledoc in VXRentalView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_rental_view.ex`, line 1

The module `ApiServerWeb.VXRentalView` has no `@moduledoc` attribute. There is no description of the module's purpose, the domain it covers (rental records, usage calculations, mid-pac and anniversary reporting), or the aliases it exposes to callers.

---

#### B026-2 — Missing @doc on render/2 ("rhm_rentals.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_rental_view.ex`, line 8

The public function clause `render("rhm_rentals.json", ...)` has no `@doc`. The expected shape of the `vx_rentals` list and the `customer` argument, and the structure of the returned JSON array, are undocumented.

---

#### B026-3 — Missing @doc on render/2 ("rhm_rental.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_rental_view.ex`, line 13

The public function clause `render("rhm_rental.json", ...)` has no `@doc`. This is the most complex clause in the module: it performs live usage calculations via `Vx.fetch_actual_usage/5`, `Vx.get_usage_since_service/2`, and `Vx.get_avg_weekly_hours/2`, applies conditional logic for overage data, and assembles a composite map. None of this behaviour or the expected input shape is documented.

---

#### B026-4 — Missing @doc on render/2 ("midpac_report.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_rental_view.ex`, line 64

The public function clause `render("midpac_report.json", ...)` has no `@doc`. The nature of the `data` value passed through and what the Mid-Pac report represents are undocumented.

---

#### B026-5 — Missing @doc on render/2 ("rental_anniversaries.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_rental_view.ex`, line 68

The public function clause `render("rental_anniversaries.json", ...)` has no `@doc`. The structure of `all_anniversary_data` and the expected return format are undocumented.

---

#### B026-6 — Missing @doc on convert_json_to_changeset/1
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_rental_view.ex`, line 73

The public function `convert_json_to_changeset/1` has no `@doc`. The function converts an incoming JSON map (with string keys) into an atom-keyed map suitable for an Ecto-style changeset, including special-casing the `"28 Day Period"` period string. The input key names, the output keys, and the `"28 Day Period"` -> `"28DAY"` translation are undocumented.

---

## vx_restriction_view.ex

### Reading Evidence

**Module name:** `ApiServerWeb.VXRestrictionView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("index.json") | 5 |
| `render/2` ("show.json") | 9 |
| `render/2` ("vx_restriction.json") | 13 |

**Private functions:** None

**Types / errors / constants defined:** None

**Documentation present:**
- `@moduledoc`: absent
- `@doc` on any public function: absent

---

### Findings

#### B026-7 — Missing @moduledoc in VXRestrictionView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_restriction_view.ex`, line 1

The module `ApiServerWeb.VXRestrictionView` has no `@moduledoc`. There is no description of what a restriction (`vxaau_rest`) represents in the domain, which fields it carries, or what the module's role is within the view layer.

---

#### B026-8 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_restriction_view.ex`, line 5

The public function clause `render("index.json", ...)` has no `@doc`. The expected type of `vxaau_rest` (a list of restriction structs) and the `%{data: [...]}` envelope shape are undocumented.

---

#### B026-9 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_restriction_view.ex`, line 9

The public function clause `render("show.json", ...)` has no `@doc`. The expected type of `vx_restriction` and the `%{data: ...}` envelope shape are undocumented.

---

#### B026-10 — Missing @doc on render/2 ("vx_restriction.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_restriction_view.ex`, line 13

The public function clause `render("vx_restriction.json", ...)` has no `@doc`. The mapping from the struct's raw database column names (e.g., `aauid`, `aauuser_id`, `aaucustcode`, `aaufun`, `aaucharval`, `aaunumval`) to their semantic meaning is undocumented.

---

## vx_thing_event_view.ex

### Reading Evidence

**Module name:** `ApiServerWeb.VXThingEventView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("index.json") | 5 |
| `render/2` ("show.json") | 9 |
| `render/2` ("vx_thing_event.json") | 13 |

**Private functions:**

| Function | Line |
|---|---|
| `omega_to_map/1` | 18 |
| `thingevent_to_map/1` | 83 |

**Types / errors / constants defined:** None

**Documentation present:**
- `@moduledoc`: absent
- `@doc` on any public function: absent

---

### Findings

#### B026-11 — Missing @moduledoc in VXThingEventView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`, line 1

The module `ApiServerWeb.VXThingEventView` has no `@moduledoc`. There is no description of what a "thing event" is, the relationship to the `thingeventomega` association, or the module's place in the view layer.

---

#### B026-12 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`, line 5

The public function clause `render("index.json", ...)` has no `@doc`. The expected type of `vxthingevents` and the `%{data: [...]}` envelope shape are undocumented.

---

#### B026-13 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`, line 9

The public function clause `render("show.json", ...)` has no `@doc`. The expected type of `vx_thing_event` and the fact that the result is a flat map (no `%{data: ...}` wrapper, unlike the index clause) are undocumented.

---

#### B026-14 — Missing @doc on render/2 ("vx_thing_event.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_event_view.ex`, line 13

The public function clause `render("vx_thing_event.json", ...)` has no `@doc`. The function merges two large maps produced by the private helpers `thingevent_to_map/1` and `omega_to_map/1`, requiring `vx_thing_event.thingeventomega` to be preloaded. This preload requirement and the resulting merged field set (approximately 80 fields) are entirely undocumented.

---

## vx_thing_omega_view.ex

### Reading Evidence

**Module name:** `ApiServerWeb.VXThingOmegaView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` ("container_lift_report.json") | 6 |
| `render/2` ("lift_summary_report_fleet.json") | 17 |
| `render/2` ("lift_summary_report.json") | 39 |
| `render/2` ("lift_list_report.json") | 63 |
| `render/2` ("engine_utilization_report.json") | 77 |
| `render/2` ("operation_summary_report.json") | 92 |

**Private functions:**

| Function | Line |
|---|---|
| `translate_lift_type_to_string/1` | 139 |

**Types / errors / constants defined:** None

**Documentation present:**
- `@moduledoc`: absent
- `@doc` on any public function: absent

---

### Findings

#### B026-15 — Missing @moduledoc in VXThingOmegaView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, line 1

The module `ApiServerWeb.VXThingOmegaView` has no `@moduledoc`. There is no description of what "omega" sensor data represents, what kinds of reports are produced, or what external data sources (tuples from database queries) are expected.

---

#### B026-16 — Missing @doc on render/2 ("container_lift_report.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, line 6

The public function clause `render("container_lift_report.json", ...)` has no `@doc`. The expected shape of `lifts_by_day` (a list of 3-tuples `{{year, month, day}, day_name, lift_count}`) and the returned JSON structure are undocumented.

---

#### B026-17 — Missing @doc on render/2 ("lift_summary_report_fleet.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, line 17

The public function clause `render("lift_summary_report_fleet.json", ...)` has no `@doc`. The expected shape of `lifts_by_day` (an 8-element tuple per entry) and the meaning of `count_20`, `count_30`, `count_40`, `count_chain`, and `count_bottom` fields are undocumented.

---

#### B026-18 — Missing @doc on render/2 ("lift_summary_report.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, line 39

The public function clause `render("lift_summary_report.json", ...)` has no `@doc`. The expected shape of `lifts_by_day` (a 9-element tuple per entry, adding `thing_name` compared to the fleet variant) and the distinction from `lift_summary_report_fleet.json` are undocumented.

---

#### B026-19 — Missing @doc on render/2 ("lift_list_report.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, line 63

The public function clause `render("lift_list_report.json", ...)` has no `@doc`. The expected shape of `all_lifts` (a list of 5-tuples `{datetime, lift_type, vehicle_load, operator, thing_name}`), the use of `Timex.to_datetime/1` on the raw datetime value, and the mapping of `lift_type` integers via `translate_lift_type_to_string/1` are undocumented.

---

#### B026-20 — Missing @doc on render/2 ("engine_utilization_report.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, line 77

The public function clause `render("engine_utilization_report.json", ...)` has no `@doc`. The expected shape of `engine_use_by_day` (a list of 2-element lists where the first element is a date tuple) and the derived `high_idle` field (computed as `max(0, engine_hours - idle_hours)`) are undocumented.

---

#### B026-21 — Missing @doc on render/2 ("operation_summary_report.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_omega_view.ex`, line 92

The public function clause `render("operation_summary_report.json", ...)` has no `@doc`. The expected shape of `operation_data` (a list of 6-element tuples), the division-by-zero guards applied before computing `average_lifts_per_hour`, `average_fuel_per_hour`, and `average_fuel_per_lift`, and the use of `Decimal` arithmetic throughout are undocumented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B026-1 | LOW | vx_rental_view.ex:1 | Missing @moduledoc in VXRentalView |
| B026-2 | INFO | vx_rental_view.ex:8 | Missing @doc on render/2 ("rhm_rentals.json") |
| B026-3 | INFO | vx_rental_view.ex:13 | Missing @doc on render/2 ("rhm_rental.json") |
| B026-4 | INFO | vx_rental_view.ex:64 | Missing @doc on render/2 ("midpac_report.json") |
| B026-5 | INFO | vx_rental_view.ex:68 | Missing @doc on render/2 ("rental_anniversaries.json") |
| B026-6 | INFO | vx_rental_view.ex:73 | Missing @doc on convert_json_to_changeset/1 |
| B026-7 | LOW | vx_restriction_view.ex:1 | Missing @moduledoc in VXRestrictionView |
| B026-8 | INFO | vx_restriction_view.ex:5 | Missing @doc on render/2 ("index.json") |
| B026-9 | INFO | vx_restriction_view.ex:9 | Missing @doc on render/2 ("show.json") |
| B026-10 | INFO | vx_restriction_view.ex:13 | Missing @doc on render/2 ("vx_restriction.json") |
| B026-11 | LOW | vx_thing_event_view.ex:1 | Missing @moduledoc in VXThingEventView |
| B026-12 | INFO | vx_thing_event_view.ex:5 | Missing @doc on render/2 ("index.json") |
| B026-13 | INFO | vx_thing_event_view.ex:9 | Missing @doc on render/2 ("show.json") |
| B026-14 | INFO | vx_thing_event_view.ex:13 | Missing @doc on render/2 ("vx_thing_event.json") |
| B026-15 | LOW | vx_thing_omega_view.ex:1 | Missing @moduledoc in VXThingOmegaView |
| B026-16 | INFO | vx_thing_omega_view.ex:6 | Missing @doc on render/2 ("container_lift_report.json") |
| B026-17 | INFO | vx_thing_omega_view.ex:17 | Missing @doc on render/2 ("lift_summary_report_fleet.json") |
| B026-18 | INFO | vx_thing_omega_view.ex:39 | Missing @doc on render/2 ("lift_summary_report.json") |
| B026-19 | INFO | vx_thing_omega_view.ex:63 | Missing @doc on render/2 ("lift_list_report.json") |
| B026-20 | INFO | vx_thing_omega_view.ex:77 | Missing @doc on render/2 ("engine_utilization_report.json") |
| B026-21 | INFO | vx_thing_omega_view.ex:92 | Missing @doc on render/2 ("operation_summary_report.json") |

<!-- B027.md -->
# Pass 3: Documentation — B027
**Agent:** B027
**Files:**
- `lib/api_server_web/views/vx_thing_summary_view.ex`
- `lib/api_server_web/views/vx_thing_view.ex`
- `lib/api_server_web/views/vx_user_function_view.ex`
- `lib/api_server_web/views/vx_user_view.ex`

**Date:** 2026-02-27

---

## vx_thing_summary_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingSummaryView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` — `"index.json"` clause | 5 |
| `render/2` — `"show.json"` clause | 9 |
| `render/2` — `"vx_thing_summary.json"` clause | 13 |
| `render/2` — `"rhm_thing_summary.json"` clause | 57 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc`, `@doc`, and `@spec` are all absent throughout the file).

---

### Findings

#### B027-1 — Missing @moduledoc in VXThingSummaryView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 1

The module `ApiServerWeb.VXThingSummaryView` has no `@moduledoc` attribute. There is no description of the module's purpose, the data it serialises, or the JSON templates it supports (`vx_thing_summary.json` for full-field output and the alternative `rhm_thing_summary.json` for the structured RHM payload).

---

#### B027-2 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 5

The public function clause `render("index.json", %{vxthingsummaries: vxthingsummaries})` has no `@doc`. No description is provided of the expected assigns key (`vxthingsummaries`) or the shape of the returned JSON envelope (`%{data: [...]}`).

---

#### B027-3 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 9

The public function clause `render("show.json", %{vx_thing_summary: vx_thing_summary})` has no `@doc`. No description is provided of the expected assigns key or the `%{data: ...}` envelope it produces.

---

#### B027-4 — Missing @doc on render/2 ("vx_thing_summary.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 13

The public function clause `render("vx_thing_summary.json", %{vx_thing_summary: vx_thing_summary})` has no `@doc`. This is the primary serialisation clause; it outputs a large flat map of 32 `abm*` fields with no documentation explaining what those fields represent or their units.

---

#### B027-5 — Missing @doc on render/2 ("rhm_thing_summary.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 57

The public function clause `render("rhm_thing_summary.json", %{vx_thing_summary: summary})` has no `@doc`. This clause produces a differently structured nested output (GPS block, hour-meter sub-keys, operator block) compared to `vx_thing_summary.json`. The distinction between the two templates and the rationale for the structural difference are entirely undocumented.

---

## vx_thing_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` — `"index.json"` clause | 8 |
| `render/2` — `"show.json"` clause | 12 |
| `render/2` — `"fleet_map.json"` (list) clause | 16 |
| `render/2` — `"fleet_map.json"` (single) clause | 20 |
| `render/2` — `"hardware_with_checklists.json"` clause | 105 |
| `render/2` — `"pm_data.json"` (list) clause | 109 |
| `render/2` — `"pm_data.json"` (single) clause | 113 |
| `render/2` — `"movements.json"` clause | 147 |
| `render/2` — `"movement.json"` clause | 150 |
| `render/2` — `"checklists.json"` clause | 164 |
| `render/2` — `"vx_checklist.json"` clause | 168 |
| `render/2` — `"vx_thing.json"` clause | 176 |
| `render/2` — `"rhm_thing_usage.json"` clause | 220 |
| `render/2` — `"rhm_thing_usage_manual.json"` clause | 224 |
| `render/2` — `"usage_report.json"` clause | 228 |
| `render/2` — `"usage_report_many.json"` clause | 265 |
| `render/2` — `"rhm_things_usage.json"` clause | 292 |
| `render/2` — `"rhm_thing_events.json"` clause | 315 |
| `render/2` — `"event_report.json"` clause | 318 |
| `render/2` — `"rhm_thing.json"` (list) clause | 351 |
| `render/2` — `"rhm_thing.json"` (single) clause | 354 |
| `render/2` — `"basic_thing.json"` (nil) clause | 359 |
| `render/2` — `"basic_thing.json"` clause | 360 |
| `render/2` — `"sielift_wip_export.json"` clause | 396 |
| `render/2` — `"pape_exports.json"` clause | 434 |
| `render/2` — `"pape_export.json"` clause | 437 |
| `render/2` — `"rhm_things_names.json"` clause | 449 |
| `render/2` — `"things_only.json"` clause | 453 |
| `info_to_map/1` | 487 |
| `thing_to_map/2` | 499 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc`, `@doc`, and `@spec` are all absent).

**Other notable observations:**
- A large block of commented-out experimental code exists at lines 508–532 inside `thing_to_map/2` (predicted service date logic). This dead code has inline explanatory comments but no formal documentation.
- `pm_data.json` single-item clause (line 113) contains hard-coded placeholder values (`previousweek: 0.1`, `thisweek: 0.2`, `avgperweek: 0.2`, `mtdraw: 0.3`, `weekstoservice: 0.4`) with no documentation acknowledging they are stubs.
- `fleet_map.json` single-item clause (line 20) returns an empty string `""` when `vx_thing.summary == nil`; this behaviour is undocumented.

---

### Findings

#### B027-6 — Missing @moduledoc in VXThingView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_view.ex`, line 1

The module `ApiServerWeb.VXThingView` has no `@moduledoc`. With 30 public function clauses covering fleet maps, PM data, movements, checklists, events, usage reports, WIP exports, and named-entity exports, the lack of any module-level description makes the view extremely difficult to understand at a glance.

---

#### B027-7 — Missing @doc on all render/2 clauses (VXThingView)
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_view.ex`, lines 8, 12, 16, 20, 105, 109, 113, 147, 150, 164, 168, 176, 220, 224, 228, 265, 292, 315, 318, 351, 354, 359, 360, 396, 434, 437, 449, 453

None of the 28 `render/2` clauses has a `@doc` attribute. Because `@doc` applies to the first clause of a function and covers all pattern-match clauses, a single `@doc` block before line 8 (or targeted per template group) would be standard practice. The complete absence leaves callers with no guidance on required assigns keys, return shapes, or the differences between similarly-named templates (e.g., `"rhm_thing.json"` vs `"vx_thing.json"` vs `"basic_thing.json"`).

---

#### B027-8 — Missing @doc on info_to_map/1
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_view.ex`, line 487

The public helper `info_to_map/1` has no `@doc` or `@spec`. Its purpose (converting a `thing_info` struct to a PM-notification map, returning `%{}` on `nil` input) and its expected argument type are undocumented.

---

#### B027-9 — Missing @doc on thing_to_map/2
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_view.ex`, line 499

The public helper `thing_to_map/2` has no `@doc` or `@spec`. This is a significant function: it computes `weeks_to_service`, maps fleets, and delegates to `render_one` for the summary. The guard logic (`vx_thing == nil` check at line 541 is reached only after already accessing `vx_thing.aadsvchrs` at line 502, making the nil-guard potentially dead code) is non-obvious and entirely undocumented.

---

#### B027-10 — Undocumented stub/placeholder values in pm_data.json render clause
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`, lines 138–142

The `render("pm_data.json", %{vx_thing: vx_thing})` clause returns hard-coded sentinel values (`previousweek: 0.1`, `thisweek: 0.2`, `avgperweek: 0.2`, `mtdraw: 0.3`, `weekstoservice: 0.4`) that are clearly placeholders, not real data. There is no `@doc`, inline comment, or TODO explaining that these fields are unimplemented stubs. A consumer of this API endpoint would have no way to know these figures are fabricated, potentially leading to incorrect business decisions.

---

## vx_user_function_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXUserFunctionView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` — `"index.json"` clause | 5 |
| `render/2` — `"show.json"` clause | 9 |
| `render/2` — `"vx_user_function.json"` clause | 13 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc`, `@doc`, and `@spec` are all absent).

---

### Findings

#### B027-11 — Missing @moduledoc in VXUserFunctionView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_user_function_view.ex`, line 1

The module `ApiServerWeb.VXUserFunctionView` has no `@moduledoc`. No description is provided of the resource being serialised (user-to-function permission assignments) or the fields exposed (`id`, `aatid`, `aatuser_id`, `aatfunctionid`).

---

#### B027-12 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_function_view.ex`, line 5

The public clause `render("index.json", %{vxaatuserfunctions: vxaatuserfunctions})` has no `@doc`. The assigns key `vxaatuserfunctions` and the `%{data: [...]}` envelope are undocumented.

---

#### B027-13 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_function_view.ex`, line 9

The public clause `render("show.json", %{vx_user_function: vx_user_function})` has no `@doc`.

---

#### B027-14 — Missing @doc on render/2 ("vx_user_function.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_function_view.ex`, line 13

The public clause `render("vx_user_function.json", %{vx_user_function: vx_user_function})` has no `@doc`. The four fields output (`id`, `aatid`, `aatuser_id`, `aatfunctionid`) use opaque `aat`-prefixed naming and have no explanation of their semantic meaning.

---

## vx_user_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXUserView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` — `"index.json"` clause | 5 |
| `render/2` — `"show.json"` clause | 9 |
| `render/2` — `"rhm_users.json"` clause | 13 |
| `render/2` — `"rhm_user.json"` clause | 17 |
| `render/2` — `"fleet_list.json"` clause | 58 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc`, `@doc`, and `@spec` are all absent).

**Other notable observations:**
- `render("rhm_user.json", ...)` (line 17) implements conditional logic: it optionally merges a `jwt` field if present in the assigns map, a `login_message` field if present, and derives `user_level` from `user.function.aatfunction_id` with a hard-coded default of `2`. None of this conditional behaviour is documented.
- The `offset` and `timezone` fields (lines 46–47) are mapped from the same source field `aactimezone`, making them duplicates; this is undocumented and potentially confusing.

---

### Findings

#### B027-15 — Missing @moduledoc in VXUserView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 1

The module `ApiServerWeb.VXUserView` has no `@moduledoc`. There is no description of the user resource being serialised, the templates it handles, or the conditional fields (JWT, login message, user level) it manages.

---

#### B027-16 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 5

The public clause `render("index.json", %{vxusers: vxusers})` has no `@doc`. Notably this clause delegates to `"rhm_user.json"` rather than a plain `"vx_user.json"` template, which is non-obvious and undocumented.

---

#### B027-17 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 9

The public clause `render("show.json", %{vx_user: vx_user})` has no `@doc`. Unlike the index clause it does not wrap output in a `%{data: ...}` envelope, which is an asymmetry that is entirely undocumented.

---

#### B027-18 — Missing @doc on render/2 ("rhm_users.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 13

The public clause `render("rhm_users.json", %{vx_users: users})` has no `@doc`.

---

#### B027-19 — Missing @doc on render/2 ("rhm_user.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 17

The public clause `render("rhm_user.json", %{vx_user: user})` has no `@doc`. This is the most complex clause in the module: it implements three conditional branches (JWT merging, login-message merging, user-level derivation with a hard-coded default of `2`), renames many fields from `aac`-prefixed source names, and duplicates `aactimezone` into both `offset` and `timezone`. None of this behaviour is described.

---

#### B027-20 — Missing @doc on render/2 ("fleet_list.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 58

The public clause `render("fleet_list.json", %{fleet_list: fleet_list})` has no `@doc`. The shape of `fleet_list` elements and the `allowed_fleets` key are undocumented.

---

#### B027-21 — Duplicate field (offset/timezone) undocumented in rhm_user.json render
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_user_view.ex`, lines 46–47

The `render("rhm_user.json", ...)` clause maps `user.aactimezone` to both `offset:` (line 46) and `timezone:` (line 47), producing two fields in the JSON response with identical values. There is no `@doc`, inline comment, or TODO explaining why both are emitted, whether one is a deprecated alias of the other, or which clients consume which key. This undocumented duplication risks confusion and unintended API surface.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B027-1 | LOW | vx_thing_summary_view.ex:1 | Missing @moduledoc in VXThingSummaryView |
| B027-2 | INFO | vx_thing_summary_view.ex:5 | Missing @doc on render/2 ("index.json") |
| B027-3 | INFO | vx_thing_summary_view.ex:9 | Missing @doc on render/2 ("show.json") |
| B027-4 | INFO | vx_thing_summary_view.ex:13 | Missing @doc on render/2 ("vx_thing_summary.json") |
| B027-5 | INFO | vx_thing_summary_view.ex:57 | Missing @doc on render/2 ("rhm_thing_summary.json") |
| B027-6 | LOW | vx_thing_view.ex:1 | Missing @moduledoc in VXThingView |
| B027-7 | INFO | vx_thing_view.ex:8–453 | Missing @doc on all 28 render/2 clauses in VXThingView |
| B027-8 | INFO | vx_thing_view.ex:487 | Missing @doc on info_to_map/1 |
| B027-9 | INFO | vx_thing_view.ex:499 | Missing @doc on thing_to_map/2 |
| B027-10 | MEDIUM | vx_thing_view.ex:138–142 | Undocumented stub/placeholder values returned from pm_data.json render clause |
| B027-11 | LOW | vx_user_function_view.ex:1 | Missing @moduledoc in VXUserFunctionView |
| B027-12 | INFO | vx_user_function_view.ex:5 | Missing @doc on render/2 ("index.json") |
| B027-13 | INFO | vx_user_function_view.ex:9 | Missing @doc on render/2 ("show.json") |
| B027-14 | INFO | vx_user_function_view.ex:13 | Missing @doc on render/2 ("vx_user_function.json") |
| B027-15 | LOW | vx_user_view.ex:1 | Missing @moduledoc in VXUserView |
| B027-16 | INFO | vx_user_view.ex:5 | Missing @doc on render/2 ("index.json") |
| B027-17 | INFO | vx_user_view.ex:9 | Missing @doc on render/2 ("show.json") |
| B027-18 | INFO | vx_user_view.ex:13 | Missing @doc on render/2 ("rhm_users.json") |
| B027-19 | INFO | vx_user_view.ex:17 | Missing @doc on render/2 ("rhm_user.json") |
| B027-20 | INFO | vx_user_view.ex:58 | Missing @doc on render/2 ("fleet_list.json") |
| B027-21 | MEDIUM | vx_user_view.ex:46–47 | Duplicate offset/timezone fields from same source with no documentation explaining the duplication |


---

## Pass 4 — Code Quality

<!-- all-findings.md -->
# Pass 4 – B001

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B001

**Files reviewed:**
- `lib/api_server.ex`
- `lib/api_server/application.ex`
- `lib/api_server/guardian.ex`
- `lib/api_server/repo.ex`
- `mix.exs`
- `mix.lock`

---

## Reading Evidence

### `lib/api_server.ex`

- **Module:** `ApiServer`
- **Functions:** none (module body is only a `@moduledoc`)
- **Types / errors / constants:** none
- **Notes:** Boilerplate Phoenix context module; no logic.

---

### `lib/api_server/application.ex`

- **Module:** `ApiServer.Application`
- **Functions:**
  - `start/2` — line 6
  - `config_change/3` — line 36
- **Types / errors / constants:** none
- **Notable patterns:**
  - `import Supervisor.Spec` at line 7 — called *inside* the `start/2` function body, not at module level.
  - Supervisor children defined with the deprecated `supervisor/2` helper (lines 14–17) from `Supervisor.Spec`, mixed with the current `{Module, opts}` tuple style (lines 19, 21–22, 25).
  - Commented-out worker line at line 24.

---

### `lib/api_server/guardian.ex`

- **Module:** `ApiServer.Guardian`
- **Functions:**
  - `subject_for_token/2` (clause 1) — line 6
  - `subject_for_token/2` (clause 2) — line 14
  - `resource_from_claims/1` (clause 1) — line 18
  - `resource_from_claims/1` (clause 2) — line 24
- **Aliases:** `ApiServer.Vx` — line 4
- **Types / errors / constants:** none
- **Notable patterns:**
  - Indentation is 4-space inside the module vs. the Elixir community standard of 2-space.
  - Error atom used is `:reason_for_error` — a placeholder string, not a meaningful error term.
  - Second clause of `subject_for_token/2` (`def subject_for_token(_, _)`) is unreachable: the first clause matches on any two arguments (using `if user == nil`), so the catch-all second clause can never be reached.
  - Second clause of `resource_from_claims/1` is unreachable for the same reason — the first clause matches `_claims` (any value).

---

### `lib/api_server/repo.ex`

- **Modules:**
  - `ApiServer.Repo` — line 1
  - `ApiServer.FortyNineRepo` — line 13
- **Functions:**
  - `ApiServer.Repo.init/2` — line 8
- **Types / errors / constants:** none
- **Notable patterns:**
  - `ApiServer.Repo` implements `init/2` to dynamically load `DATABASE_URL` at runtime (line 9).
  - `ApiServer.FortyNineRepo` has no `init/2` callback — it relies solely on compile-time / config-file configuration with no runtime URL override.
  - Both repos are started as `supervisor(...)` children in `application.ex` but only one supports dynamic URL loading.

---

### `mix.exs`

- **Module:** `ApiServer.Mixfile`
- **Functions:**
  - `project/0` — line 4
  - `application/0` — line 20
  - `elixirc_paths/1` (`:test` clause) — line 28
  - `elixirc_paths/1` (catch-all clause) — line 29
  - `deps/0` (private) — line 34
  - `aliases/0` (private) — line 73
- **Dependencies declared (line : dep):**
  - 36: `phoenix ~> 1.5.9`
  - 37: `phoenix_pubsub ~> 2.0`
  - 38: `phoenix_ecto ~> 3.2`
  - 39: `mariaex ~>0.8.2`
  - 40: `phoenix_html ~> 2.10`
  - 41: `phoenix_live_reload ~> 1.0` (dev only)
  - 42: `gettext ~> 0.11`
  - 43: `cowboy ~> 1.0`
  - 44: `cors_plug ~> 1.5`
  - 45: `distillery ~> 1.5`
  - 46: `ex_crc ~> 1.0.0`
  - 47: `absinthe ~> 1.4.0`
  - 48: `absinthe_plug ~> 1.4.0`
  - 49: `absinthe_ecto ~> 0.1.3`
  - 50: `httpoison ~> 1.6`
  - 51: `poison ~> 3.1`
  - 52: `elixir_xml_to_map ~> 0.1`
  - 53: `timex ~> 3.1`
  - 54: `guardian ~> 1.0`
  - 55: `csv ~> 2.1.1`
  - 56: `geonames` (path dep)
  - 57: `geohax >= 0.0.0`
  - 58: `con_cache ~> 0.13`
  - 59: `topo ~> 0.1.0`
  - 60: `bamboo ~> 1.2`
  - 61: `bamboo_smtp ~> 2.1.0`
  - 62: `quantum ~> 2.3`
  - 63: `plug_cowboy ~> 1.0`

---

### `mix.lock`

- **Locked packages (name : locked version):**
  - `absinthe` 1.4.16
  - `absinthe_ecto` 0.1.3
  - `absinthe_plug` 1.4.7
  - `bamboo` 1.5.0
  - `bamboo_smtp` 2.1.0
  - `base64url` 0.0.1
  - `certifi` 2.5.2
  - `combine` 0.10.0
  - `con_cache` 0.14.0
  - `connection` 1.0.4
  - `cors_plug` 1.5.2
  - `cowboy` 1.1.2
  - `cowlib` 1.0.2
  - `crontab` 1.1.10
  - `csv` 2.1.1
  - `db_connection` 1.1.3
  - `decimal` 1.8.1
  - `distillery` 1.5.5
  - `ecto` 2.2.12
  - `elixir_xml_to_map` 0.2.0
  - `erlsom` 1.5.0
  - `ex_crc` 1.0.0
  - `file_system` 0.2.8
  - `gen_smtp` 0.15.0
  - `gen_stage` 1.0.0
  - `gen_state_machine` 2.1.0
  - `geo` 1.5.0
  - `geohax` 0.3.0
  - `gettext` 0.18.0
  - `guardian` 1.2.1
  - `hackney` 1.16.0
  - `httpoison` 1.6.2
  - `idna` 6.0.1
  - `jose` 1.10.1
  - `libring` 1.5.0
  - `mariaex` 0.8.4
  - `metrics` 1.0.1
  - `mime` 2.0.2
  - `mimerl` 1.2.0
  - `parallel_stream` 1.0.6
  - `parse_trans` 3.3.0
  - `phoenix` 1.5.13
  - `phoenix_ecto` 3.6.0
  - `phoenix_html` 2.14.2
  - `phoenix_live_reload` 1.1.7
  - `phoenix_pubsub` 2.1.1
  - `plug` 1.13.6
  - `plug_cowboy` 1.0.0
  - `plug_crypto` 1.2.2
  - `poison` 3.1.0
  - `poolboy` 1.5.2
  - `postgrex` 0.13.5
  - `quantum` 2.4.0
  - `ranch` 1.3.2
  - `seg_seg` 0.0.1
  - `ssl_verify_fun` 1.1.6
  - `swarm` 3.4.0
  - `telemetry` 1.1.0
  - `timex` 3.6.2
  - `topo` 0.1.2
  - `tzdata` 1.0.3
  - `unicode_util_compat` 0.5.0
  - `vector` 0.2.2

---

## Findings

**B001-1** — [LOW] Commented-out worker stub left in production supervisor child list
File: `lib/api_server/application.ex:24`
Description: The line `# worker(ApiServer.Worker, [arg1, arg2, arg3]),` is a Phoenix generator boilerplate comment that was never cleaned up. Commented-out code in a supervision tree definition is noise that can confuse readers about intended topology and should be removed.

---

**B001-2** — [MEDIUM] Deprecated `Supervisor.Spec` imported inside function body
File: `lib/api_server/application.ex:7`
Description: `import Supervisor.Spec` appears inside the `start/2` function body rather than at module level. `Supervisor.Spec` itself was deprecated in Elixir 1.5 and removed in Elixir 1.11; using `supervisor/2` and `worker/2` helpers from this module generates build warnings on any supported Elixir version. The import-inside-function pattern is also an unusual style that hides the dependency.

---

**B001-3** — [MEDIUM] Mixed child-spec styles in supervision tree
File: `lib/api_server/application.ex:14-25`
Description: The supervisor children list mixes two incompatible patterns. Lines 14–17 use the deprecated `supervisor(Module, [])` tuple form from `Supervisor.Spec`, while lines 19, 21–22, and 25 use the modern `{Module, opts}` and bare-module child-spec forms introduced in OTP 21 / Elixir 1.5. This is a style inconsistency and means the list is partly relying on a deprecated API. All children should use the modern form.

---

**B001-4** — [HIGH] Unreachable second clause of `subject_for_token/2`
File: `lib/api_server/guardian.ex:14`
Description: The first clause of `subject_for_token/2` (line 6) matches on any two arguments (`user, _claims`) and handles the `nil` case internally with an `if` expression. The second clause (`def subject_for_token(_, _)`) therefore can never be reached, because no pattern exists that would fail the first clause. The compiler will emit a warning for this unreachable clause. The intent was likely to use pattern-matched clauses (e.g., `def subject_for_token(nil, _)` and `def subject_for_token(user, _)`), but the implementation chose `if` instead and left the dead clause in place.

---

**B001-5** — [HIGH] Unreachable second clause of `resource_from_claims/1`
File: `lib/api_server/guardian.ex:24`
Description: The first clause of `resource_from_claims/1` (line 18) matches `claims` (any value). The second clause (`def resource_from_claims(_claims)`) can never be reached. The same unreachable-clause warning as B001-4 applies. Additionally, the first clause makes no attempt to handle the case where `claims["sub"]` or `claims["customer"]` is absent — it will crash with a `FunctionClauseError` or raise from `Vx.get_vx_user!/2` rather than returning `{:error, reason}`. The dead fallback clause provides a false sense of safety.

---

**B001-6** — [LOW] Opaque error atom `:reason_for_error` used as error return
File: `lib/api_server/guardian.ex:8,15,25`
Description: All error returns from `subject_for_token/2` and `resource_from_claims/1` use the atom `:reason_for_error`, which is a placeholder from the Guardian library template. This atom carries no actionable information for callers or log consumers attempting to diagnose authentication failures. It should be replaced with specific atoms such as `:user_not_found`, `:missing_claims`, etc.

---

**B001-7** — [LOW] Non-standard indentation (4-space) throughout guardian.ex
File: `lib/api_server/guardian.ex:1-27`
Description: The entire file uses 4-space indentation, while the Elixir community standard (enforced by `mix format`) is 2-space. This is a style inconsistency relative to any other files in the project that follow the standard. While not a runtime defect, it indicates `mix format` has not been run on this file.

---

**B001-8** — [MEDIUM] `ApiServer.FortyNineRepo` lacks `init/2` for runtime configuration
File: `lib/api_server/repo.ex:13-15`
Description: `ApiServer.Repo` overrides `init/2` (line 8–10) to read the database URL from the `DATABASE_URL` environment variable at runtime, enabling twelve-factor / container deployment. `ApiServer.FortyNineRepo` has no such override, so its connection parameters must be baked into compile-time config files. This asymmetry means the two repos have different operational deployment models. If `FortyNineRepo` is intended to connect to a runtime-configured database, it is missing the `init/2` callback. If it is intentionally static, this difference is undocumented and will confuse operators.

---

**B001-9** — [HIGH] Elixir version constraint `~> 1.4` is severely stale
File: `mix.exs:8`
Description: The `elixir: "~> 1.4"` constraint in `project/0` allows any Elixir version from 1.4 upward. Elixir 1.4 was released in January 2017 and reached end-of-life years ago. The `~>` operator with a minor-version operand expands to `>= 1.4.0 and < 2.0.0`, so this does not provide a meaningful lower bound for the features actually used. More critically, several dependencies listed in mix.exs (e.g., `phoenix ~> 1.5.9`, `plug ~> 1.13`) require Elixir 1.7 or later, so the stated minimum is misleading and could allow CI environments to pass with an incompatible Elixir version before hitting a dependency resolution failure.

---

**B001-10** — [LOW] Unbounded version constraint `>= 0.0.0` for `geohax`
File: `mix.exs:57`
Description: `{:geohax, ">= 0.0.0"}` places no upper bound on the version that will be resolved, meaning any future major release with breaking API changes could be pulled in by `mix deps.update`. The lock file pins it to `0.3.0` today, but any `mix deps.update geohax` will accept arbitrarily newer versions. A constraint such as `"~> 0.3"` would be appropriate.

---

**B001-11** — [MEDIUM] `postgrex` present in lock file but absent from `mix.exs` deps
File: `mix.lock:53` / `mix.exs`
Description: `postgrex 0.13.5` is recorded in `mix.lock` but is not declared as a direct or optional dependency in `mix.exs`. It appears as a transitive optional dependency of `ecto` (for PostgreSQL support). Since the project uses MariaDB (`mariaex`), the presence of a locked PostgreSQL driver is unexpected and suggests either a stale lock entry from a prior configuration, or that `postgrex` is being resolved unnecessarily. A stale lock entry bloats the dependency graph and could mask a real version conflict.

---

**B001-12** — [MEDIUM] `geo` present in lock file but absent from `mix.exs` deps
File: `mix.lock:28` / `mix.exs`
Description: `geo 1.5.0` is present in `mix.lock` but is not declared in `mix.exs`. It is pulled in transitively by `topo`. However, `geo` is listed as a runtime (non-optional) transitive dep of `topo`, so it will be included in releases. The issue is that the locked version (`1.5.0`) is constrained to work with `ecto ~> 2.1` (its optional ecto integration), but because it is not declared in `mix.exs`, there is no explicit control over which `geo` version is selected. If `topo` relaxes its `geo` constraint in a future release, `mix deps.update` could pull in an incompatible version silently.

---

**B001-13** — [LOW] `con_cache` locked at `0.14.0` but mix.exs requires `~> 0.13`
File: `mix.exs:58` / `mix.lock:10`
Description: `mix.exs` specifies `{:con_cache, "~> 0.13"}`, which allows versions `>= 0.13.0 and < 1.0.0`. The lock file records `0.14.0`. While `0.14.0` satisfies the range, the mismatch means the declared minimum (`0.13`) is lower than what has actually been tested. If a developer runs `mix deps.get` on a fresh checkout with an older resolver it could theoretically select `0.13.x`. The constraint should be tightened to `"~> 0.14"` to match the lock.

---

**B001-14** — [LOW] `bamboo` locked at `1.5.0` but mix.exs requires `~> 1.2`
File: `mix.exs:60` / `mix.lock:5`
Description: Same class of issue as B001-13. `mix.exs` allows `bamboo >= 1.2.0 and < 2.0.0`; the lock pins `1.5.0`. The lower bound of the constraint (`1.2`) is three minor versions behind the locked version, meaning the constraint is significantly wider than what is actually used or tested. The constraint should be updated to `"~> 1.5"`.

---

**B001-15** — [INFO] `guardian` locked at `1.2.1` but mix.exs requires `~> 1.0`
File: `mix.exs:54` / `mix.lock:31`
Description: `mix.exs` allows `guardian >= 1.0.0 and < 2.0.0`; lock pins `1.2.1`. This is the same class of constraint looseness as B001-13 and B001-14, but guardian's minor releases within 1.x are documented as backwards-compatible, so the practical risk is lower. Noted for completeness; tightening to `"~> 1.2"` would align the constraint with what is tested.

---

**B001-16** — [MEDIUM] `import Supervisor.Spec` inside `start/2` function rather than at module level
File: `lib/api_server/application.ex:7`
Description: Placing `import` statements inside a function body is unconventional in Elixir and reduces readability. The compiler resolves imports at compile time regardless of lexical position in the source, but developers reading the code will not expect to find an `import` directive inside a `def`. This compounds the deprecation issue in B001-2. The import should either be moved to module level (as a step toward modernising the child-specs) or removed entirely once the children are rewritten with the current tuple syntax.

---

## Summary Table

| ID      | Severity | File                              | Line(s) | Short Title                                                    |
|---------|----------|-----------------------------------|---------|----------------------------------------------------------------|
| B001-1  | LOW      | lib/api_server/application.ex     | 24      | Commented-out worker stub in supervisor children               |
| B001-2  | MEDIUM   | lib/api_server/application.ex     | 7       | Deprecated `Supervisor.Spec` used — generates build warnings   |
| B001-3  | MEDIUM   | lib/api_server/application.ex     | 14–25   | Mixed deprecated and modern child-spec styles                  |
| B001-4  | HIGH     | lib/api_server/guardian.ex        | 14      | Unreachable second clause of `subject_for_token/2`             |
| B001-5  | HIGH     | lib/api_server/guardian.ex        | 24      | Unreachable second clause of `resource_from_claims/1`          |
| B001-6  | LOW      | lib/api_server/guardian.ex        | 8,15,25 | Opaque placeholder error atom `:reason_for_error`              |
| B001-7  | LOW      | lib/api_server/guardian.ex        | 1–27    | Non-standard 4-space indentation (should be 2-space)           |
| B001-8  | MEDIUM   | lib/api_server/repo.ex            | 13–15   | `FortyNineRepo` lacks `init/2` for runtime URL configuration   |
| B001-9  | HIGH     | mix.exs                           | 8       | Elixir version constraint `~> 1.4` is severely stale           |
| B001-10 | LOW      | mix.exs                           | 57      | Unbounded `>= 0.0.0` constraint for `geohax`                  |
| B001-11 | MEDIUM   | mix.lock                          | 53      | `postgrex` in lock but not in mix.exs (unexpected dep)         |
| B001-12 | MEDIUM   | mix.lock                          | 28      | `geo` in lock but not in mix.exs (uncontrolled transitive dep) |
| B001-13 | LOW      | mix.exs / mix.lock                | 58/10   | `con_cache` constraint too loose vs. locked version            |
| B001-14 | LOW      | mix.exs / mix.lock                | 60/5    | `bamboo` constraint too loose vs. locked version               |
| B001-15 | INFO     | mix.exs / mix.lock                | 54/31   | `guardian` constraint looser than locked version               |
| B001-16 | MEDIUM   | lib/api_server/application.ex     | 7       | `import` statement placed inside function body                 |
# Pass 4 – B002

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B002

**Files reviewed:**
- `lib/api_server/fortynine/calamppositionevents.ex`
- `lib/api_server/fortynine/webservicepositionqueue.ex`

---

## Reading Evidence

### File 1: `lib/api_server/fortynine/calamppositionevents.ex`

**Module name:** `ApiServer.FortyNine.CalampPositionEvents`

**Uses / Imports:**
- `use Ecto.Schema` (line 2)
- `use Bitwise` (line 3)
- `use Timex` (line 4)
- `import Ecto.Changeset` (line 5)

**Schema:** `"calamppositionevents"` (line 7)

**Fields defined (lines 8–88):**
| Line | Field | Type |
|------|-------|------|
| 8 | `:datetimesaved` | `:utc_datetime` |
| 9 | `:gmtdatetime` | `:utc_datetime` |
| 10 | `:timeoffix` | `:utc_datetime` |
| 11 | `:hardwareid` | `:integer` |
| 12 | `:latitude` | `:float` |
| 13 | `:longitude` | `:float` |
| 14 | `:heading` | `:float` |
| 15 | `:speed` | `:float` |
| 16 | `:gpslock` | `:integer` |
| 17 | `:old` | `:integer` |
| 18 | `:ping` | `:integer` |
| 19 | `:motion` | `:integer` |
| 20 | `:speeding` | `:integer` |
| 21 | `:ignition` | `:integer` |
| 22 | `:ignitionstatus` | `:string` |
| 23 | `:rssi` | `:integer` |
| 24 | `:gpsfixquality` | `:integer` |
| 25 | `:eventtype` | `:integer` |
| 26 | `:eventcode` | `:integer` |
| 27 | `:sensor1` | `:integer` |
| 28 | `:sensor2` | `:integer` |
| 29 | `:odometer` | `:integer` |
| 30 | `:distancesincelastevent` | `:integer` |
| 31 | `:wsusername` | `:string` |
| 32 | `:wspassword` | `:string` |
| 33 | `:altitude` | `:integer` |
| 34 | `:error` | `:integer` |
| 35 | `:ioflagstatus` | `:integer` |
| 36 | `:alarmid` | `:integer` |
| 37 | `:errormsg` | `:string` |
| 38 | `:connectionname` | `:string` |
| 39 | `:weight` | `:float` |
| 40 | `:maxheight` | `:float` |
| 41 | `:fuelusage` | `:float` |
| 42 | `:engineonelapsed` | `:integer` |
| 43 | `:totalengineonelapsed` | `:integer` |
| 44 | `:input1elapsed` | `:integer` |
| 45 | `:input1status` | `:string` |
| 46 | `:input1flag` | `:integer` |
| 47 | `:totalinput1elapsed` | `:integer` |
| 48 | `:accelerometerx` | `:float` |
| 49 | `:accelerometery` | `:float` |
| 50 | `:accelerometerz` | `:float` |
| 51 | `:location` | `:string` |
| 52 | `:city` | `:string` |
| 53 | `:state` | `:string` |
| 54 | `:postcode` | `:string` |
| 55 | `:driverid` | `:string` |
| 56 | `:mifaredriverid` | `:string` |
| 57 | `:messageid` | `:integer` |
| 58 | `:originalmsg` | `:binary` |
| 59 | `:prestartchecklist` | `:string` |
| 60 | `:motiontotalelapsed` | `:integer` |
| 61 | `:containerliftcount` | `:integer` |
| 62 | `:appmsgtext` | `:string` |
| 63 | `:pulsecount` | `:integer` |
| 64 | `:totalfuel` | `:integer` |
| 65 | `:vehicleload` | `:integer` |
| 66 | `:rawvehicleload` | `:integer` |
| 67 | `:appmsgtext2` | `:string` |
| 68 | `:batteryvoltage` | `:float` |
| 69 | `:rpm` | `:float` |
| 70 | `:engcoolanttemp` | `:float` |
| 71 | `:engcoolantpressure` | `:float` |
| 72 | `:engcoolantlevelpercent` | `:float` |
| 73 | `:engoiltemp` | `:float` |
| 74 | `:engoilpressure` | `:float` |
| 75 | `:engcrankcasepressure` | `:float` |
| 76 | `:engoillevelpercent` | `:float` |
| 77 | `:engfuellevel1percent` | `:float` |
| 78 | `:engfuellevel2percent` | `:float` |
| 79 | `:engfuelrate` | `:float` |
| 80 | `:engtotalfuelused` | `:float` |
| 81 | `:engtotalfuelidle` | `:float` |
| 82 | `:engtotalhoursidle` | `:float` |
| 83 | `:engtotalhours` | `:float` |
| 84 | `:totalvehiclehours` | `:float` |
| 85 | `:totalptohours` | `:float` |
| 86 | `:engaveragefueleco` | `:float` |
| 87 | `:internalbatteryvoltage` | `:float` |

**Functions defined:**
| Line | Function | Arity |
|------|----------|-------|
| 91 | `changeset/2` | 2 |

**Types / constants / errors defined:** None

---

### File 2: `lib/api_server/fortynine/webservicepositionqueue.ex`

**Module name:** `ApiServer.FortyNine.WebServicePositionQueue`

**Uses / Imports:**
- `use Ecto.Schema` (line 2)
- `use Bitwise` (line 3)
- `use Timex` (line 4)
- `import Ecto.Changeset` (line 5)

**Schema:** `"webservicepositionqueue"` (line 7)

**Fields defined (lines 8–34):**
| Line | Field | Type |
|------|-------|------|
| 8 | `:RECORDID` | `:integer` |
| 9 | `:datetimequeued` | `:utc_datetime` |
| 10 | `:utctimestamp` | `:utc_datetime` |
| 11 | `:HARDWAREID` | `:string` |
| 12 | `:MOBILENAME` | `:string` |
| 13 | `:driverID` | `:string` |
| 14 | `:LATITUDE` | `:float` |
| 15 | `:LONGITUDE` | `:float` |
| 16 | `:HEADING` | `:float` |
| 17 | `:SPEED` | `:float` |
| 18 | `:GPSLOCK` | `:integer` |
| 19 | `:OLD` | `:integer` |
| 20 | `:PING` | `:integer` |
| 21 | `:MOTION` | `:integer` |
| 22 | `:SPEEDING` | `:integer` |
| 23 | `:IGNITION` | `:integer` |
| 24 | `:IGNITIONSTATUS` | `:string` |
| 25 | `:RSSI` | `:integer` |
| 26 | `:SATS` | `:integer` |
| 27 | `:SENSOR1` | `:integer` |
| 28 | `:SENSOR2` | `:integer` |
| 29 | `:WSUSERNAME` | `:string` |
| 30 | `:WSPASSWORD` | `:string` |
| 31 | `:ERROR` | `:integer` |
| 32 | `:ERRORMSG` | `:string` |
| 33 | `:CONNECTIONNAME` | `:string` |

**Functions defined:**
| Line | Function | Arity |
|------|----------|-------|
| 37 | `changeset/2` | 2 |

**Types / constants / errors defined:** None

---

## Findings

---

**B002-1** — [HIGH] Unused `use Bitwise` in both schema modules

File: `lib/api_server/fortynine/calamppositionevents.ex:3`
File: `lib/api_server/fortynine/webservicepositionqueue.ex:3`

Description: Both modules include `use Bitwise` at lines 3, but neither module contains any bitwise operations, operators (`band`, `bor`, `bxor`, `bnot`, `bsl`, `bsr`, `~~~`, `&&&`, `|||`), or any other expression that would require the Bitwise module to be in scope. In Elixir, `use Bitwise` imports all bitwise operators and/or functions into the module namespace. This pollutes the module's namespace with operators that shadow or conflict with potential future local definitions and suppresses no-op import warnings in some compiler versions. It is a build-warning-class issue: the compiler will generate an "unused import" warning for modules that `use` a library purely for its operator side-effects when none of those operators are referenced. This is duplicated identically across both files.

---

**B002-2** — [HIGH] Unused `use Timex` in both schema modules

File: `lib/api_server/fortynine/calamppositionevents.ex:4`
File: `lib/api_server/fortynine/webservicepositionqueue.ex:4`

Description: Both modules include `use Timex` at line 4, but neither module contains any call to Timex functions (e.g., `Timex.now/0`, `Timex.format/2`, `Timex.parse/2`, `Timex.diff/3`, `Timex.shift/2`, or any Timex sigil). `use Timex` injects a substantial set of aliases, imports, and macros into the module. None of this machinery is used; the modules are pure Ecto schema + changeset definitions. This generates unused-import build warnings and unnecessarily increases compile-time dependency surface. The duplication of the same unnecessary dependency across both files suggests copy-paste module setup without review.

---

**B002-3** — [MEDIUM] Inconsistent field naming convention between the two sibling schema modules

File: `lib/api_server/fortynine/calamppositionevents.ex:8–87`
File: `lib/api_server/fortynine/webservicepositionqueue.ex:8–33`

Description: `[REDACTED-AWS-SMTP-PASSWORD]` uses entirely lowercase snake_case atom field names (`:hardwareid`, `:latitude`, `:wspassword`, `:driverid`, etc.). `[REDACTED-AWS-SMTP-PASSWORD]` uses SCREAMING_SNAKE_CASE (`:HARDWAREID`, `:LATITUDE`, `:WSPASSWORD`) for most fields, but uses mixed case for two fields: `:datetimequeued` (lowercase, line 9), `:utctimestamp` (lowercase, line 10), and `:driverID` (camelCase, line 13). This means the two related schema modules — both mapping GPS position data from the same device vendor — follow three different naming styles. Inconsistency within `[REDACTED-AWS-SMTP-PASSWORD]` itself (`:driverID` versus `:HARDWAREID`) is particularly problematic: it makes pattern matching against the struct unreliable and forces callers to know which fields are uppercase and which are not. This is a style inconsistency finding and also a latent bug risk because Elixir atom keys are case-sensitive.

---

**B002-4** — [MEDIUM] Credentials stored as first-class schema fields (leaky abstraction / security concern)

File: `lib/api_server/fortynine/calamppositionevents.ex:31–32`
File: `lib/api_server/fortynine/webservicepositionqueue.ex:29–30`

Description: Both schemas expose `:wsusername` / `:WSUSERNAME` and `:wspassword` / `:WSPASSWORD` as plain persisted schema fields, and the `changeset/2` functions in both modules include these fields in the unrestricted `cast/3` call. Credential fields being part of a general-purpose changeset means they are cast from arbitrary external attrs maps without any special handling, masking, or omission. Confirmed in `tcp_commands.ex` (lines 1220–1221, 1305–1306, 1890–1891): the password `"@trility!"` is hard-coded in the caller and flows through the changeset into the database. While the hard-coding of the credential is a separate concern in `tcp_commands.ex`, the schema design that models credentials as ordinary data fields — fully cast, fully persisted, with no `@doc` warning — is a leaky abstraction: the persistence layer exposes an internal web-service credential as a public struct field accessible to any code that queries the schema.

---

**B002-5** — [LOW] `@doc false` on `changeset/2` is misleading in context

File: `lib/api_server/fortynine/calamppositionevents.ex:90`
File: `lib/api_server/fortynine/webservicepositionqueue.ex:36`

Description: Both modules annotate `changeset/2` with `@doc false`. This attribute suppresses ExDoc documentation generation for the function. However, both `changeset/2` functions are the only public API of their respective modules and are called from `tcp_commands.ex` as the primary insertion path. Marking a module's sole public function as `@doc false` means there is no machine-readable documentation for the function's contract, accepted fields, or required fields (`:hardwareid` / `:HARDWAREID`). The `@doc false` convention in Elixir/Phoenix is intended for genuinely internal callbacks; using it here hides the module's only externally consumed interface. This is a style/maintainability finding.

---

**B002-6** — [LOW] Indentation style inconsistency within schema blocks

File: `lib/api_server/fortynine/calamppositionevents.ex:8–88`
File: `lib/api_server/fortynine/webservicepositionqueue.ex:8–34`

Description: In both files, the `field` declarations inside the `schema` block are indented with 6 spaces (two extra spaces beyond the 4-space indent that Elixir convention uses for block bodies). The standard Elixir formatter uses 2-space indentation increments, so `field` declarations inside a `schema` block should be indented 4 spaces (2 for the `do` block of `defmodule`, 2 more for the `schema` block). Using 6 spaces suggests the files were not formatted with `mix format`. This inconsistency is minor in isolation but indicates these files have never been passed through the project formatter, which may hide other formatting divergences.

---

**B002-7** — [LOW] `changeset/2` casts all fields with no filtering — credential fields included without guard

File: `lib/api_server/fortynine/calamppositionevents.ex:92–94`
File: `lib/api_server/fortynine/webservicepositionqueue.ex:38–40`

Description: The `cast/3` call in both changesets passes every single schema field as castable, including `:wspassword` / `:WSPASSWORD`. There is no use of `validate_required/2` beyond the single hardware-ID field, and no `validate_*` call guards any other field. With 81 fields cast but only 1 validated in `[REDACTED-AWS-SMTP-PASSWORD]`, a struct can be inserted with every field nil or with arbitrary values. This is a structural weakness in the changeset design: `cast/3` is meant to be paired with validation logic proportionate to the data importance. The absence of any validation on fields such as `:latitude`, `:longitude`, or `:gmtdatetime` means silently corrupt records can reach the database. This is a LOW code-quality finding (not CRITICAL because the data originates from an authenticated internal TCP pipeline, not a public API endpoint).

---

## Summary Table

| ID | Severity | File(s) | Short Title |
|----|----------|---------|-------------|
| B002-1 | HIGH | calamppositionevents.ex:3, webservicepositionqueue.ex:3 | Unused `use Bitwise` — build warning / namespace pollution |
| B002-2 | HIGH | calamppositionevents.ex:4, webservicepositionqueue.ex:4 | Unused `use Timex` — build warning / unnecessary dependency |
| B002-3 | MEDIUM | calamppositionevents.ex:8–87, webservicepositionqueue.ex:8–33 | Inconsistent field naming convention between sibling schemas |
| B002-4 | MEDIUM | calamppositionevents.ex:31–32, webservicepositionqueue.ex:29–30 | Credentials as first-class castable schema fields (leaky abstraction) |
| B002-5 | LOW | calamppositionevents.ex:90, webservicepositionqueue.ex:36 | `@doc false` on module's sole public function |
| B002-6 | LOW | calamppositionevents.ex:8–88, webservicepositionqueue.ex:8–34 | Non-standard indentation — files not formatted with `mix format` |
| B002-7 | LOW | calamppositionevents.ex:92–94, webservicepositionqueue.ex:38–40 | `changeset/2` casts all fields with minimal validation |

**Total findings: 7** (2 HIGH, 2 MEDIUM, 3 LOW)
# Pass 4 – B003

Date: 2026-02-27
Audit run: 2026-02-27-01
Files reviewed:
- lib/api_server/operators/file.ex
- lib/api_server/operators/operators.ex

---

## Reading Evidence

### lib/api_server/operators/file.ex

**Module:** `ApiServer.Operators.File`

**Schema:** `"files"` (Ecto schema)

**Fields defined in schema:**
- `:custcode` — `:string` (line 7)
- `:esn` — `:string` (line 8)
- `timestamps()` (line 10)

**Functions:**
| Name | Line | Visibility |
|------|------|------------|
| `changeset/2` | 14 | public (`@doc false`) |

**Types / errors / constants defined:** None

---

### lib/api_server/operators/operators.ex

**Module:** `ApiServer.Operators`

**Imports:** `Ecto.Query` with `warn: false` (line 5)

**Aliases:**
- `ApiServer.Repo` (line 7)
- `ApiServer.Operators.File` (line 8)

**Functions:**
| Name | Line | Visibility |
|------|------|------------|
| `list_files/0` | 19 | public |
| `get_file!/1` | 37 | public |
| `create_file/1` (default arg `%{}`) | 51 | public |
| `update_file/2` | 69 | public |
| `delete_file/1` | 87 | public |
| `change_file/1` | 100 | public |

**Types / errors / constants defined:** None

---

## Findings

**B003-1** — [HIGH] Entire Operators context is dead code — none of its functions are called anywhere

File: lib/api_server/operators/operators.ex:19–102

Description: The six public functions `list_files/0`, `get_file!/1`, `create_file/1`, `update_file/2`, `delete_file/1`, and `change_file/1` are never called by any module in the codebase. A project-wide search across all `.ex` and `.exs` files finds zero call sites. The `FileController` (lib/api_server_web/controllers/file_controller.ex) aliases `ApiServer.Operators` (line 4) and `ApiServer.Operators.File` (line 5) but never calls a single function from `ApiServer.Operators`. The entire context is therefore dead code. Dead context modules carry maintenance cost and create confusion about the data access path actually in use.

---

**B003-2** — [HIGH] `ApiServer.Operators.File` schema is dead — schema fields do not match actual controller usage

File: lib/api_server/operators/file.ex:6–11

Description: The `ApiServer.Operators.File` schema defines two fields (`:custcode` and `:esn`) and maps to the `"files"` database table. However the `FileController` never loads `ApiServer.Operators.File` structs through the `ApiServer.Operators` context; it builds ad-hoc maps with keys `:size`, `:hardwareid`, and `:num_fobs` and renders them directly. The schema fields (`:custcode`, `:esn`) do not appear anywhere outside the schema and changeset definitions. The schema represents a table that is not used by any runtime path, making it dead schema infrastructure.

---

**B003-3** — [MEDIUM] Unused alias `ApiServer.Operators` imported in `warn: false` context — `Ecto.Query` import may be entirely unused

File: lib/api_server/operators/operators.ex:5

Description: `import Ecto.Query, warn: false` is present to suppress the "unused import" compiler warning. The `warn: false` flag is a signal that the import was known to be partially or wholly unused at the time of writing. Because no query-building beyond `Repo.all/1` and `Repo.get!/2` is performed in the module, none of the query macros from `Ecto.Query` (`from`, `where`, `select`, etc.) are used. The `warn: false` option suppresses the compiler warning that would otherwise flag this. Suppressing warnings hides information that is useful during maintenance.

---

**B003-4** — [MEDIUM] Leaky abstraction — `FileController` directly aliases the schema struct bypassing the context

File: lib/api_server_web/controllers/file_controller.ex:5

Description: `FileController` imports `alias ApiServer.Operators.File` (the Ecto schema struct) directly alongside `alias ApiServer.Operators` (the context). Phoenix conventions place all database interaction behind the context module; controllers should only reference the schema struct type for pattern-matching, not for direct use. In this case the alias is completely unused in `FileController` — neither `File` nor any `Operators.*` function is called — confirming the controller bypasses the context entirely. This constitutes a leaky abstraction: the boundary between the web layer and the data layer is not enforced.

---

**B003-5** — [LOW] Stale generated boilerplate — `changeset/2` is annotated `@doc false` on a function that is itself dead

File: lib/api_server/operators/file.ex:13–18

Description: `@doc false` is the Phoenix generator convention for marking changesets as internal-only. The annotation is correct in intent, but the function itself is dead (see B003-1 and B003-2): `File.changeset/2` is only called from `ApiServer.Operators` functions which are themselves never called. The presence of `@doc false` combined with dead code indicates the entire file is unmodified generator output that was never integrated into real application logic.

---

**B003-6** — [LOW] Blank line inconsistency inside schema block

File: lib/api_server/operators/file.ex:4–5

Description: Lines 4 and 5 are both blank, producing a double blank line between the `import` statement and the `schema` block. Elixir style conventions (and the standard formatter) use single blank lines between top-level constructs. This is a minor formatting inconsistency, most likely the result of the file never having been passed through `mix format`.

---

## Summary Table

| ID | Severity | Title | File | Line(s) |
|----|----------|-------|------|---------|
| B003-1 | HIGH | Entire Operators context is dead — no call sites exist | lib/api_server/operators/operators.ex | 19–102 |
| B003-2 | HIGH | `ApiServer.Operators.File` schema fields are dead — not used at runtime | lib/api_server/operators/file.ex | 6–11 |
| B003-3 | MEDIUM | `Ecto.Query` imported with `warn: false` to suppress unused-import warning | lib/api_server/operators/operators.ex | 5 |
| B003-4 | MEDIUM | Controller aliases schema struct directly, bypassing context (leaky abstraction) | lib/api_server_web/controllers/file_controller.ex | 5 |
| B003-5 | LOW | `changeset/2` annotated `@doc false` but is itself dead code | lib/api_server/operators/file.ex | 13–18 |
| B003-6 | LOW | Double blank line — file not run through `mix format` | lib/api_server/operators/file.ex | 4–5 |
# Pass 4 – B004

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Files reviewed:**
- `lib/api_server/tcp/tcp.ex` (151 lines)
- `lib/api_server/tcp/tcp_commands.ex` (1,987 lines)

---

## Reading Evidence

### `lib/api_server/tcp/tcp.ex`

**Module:** `ApiServer.TCP`

**Functions:**
| Name | Line | Visibility |
|------|------|------------|
| `accept/1` | 23 | public |
| `loop_acceptor/1` | 32 | private |
| `serve/2` | 48 | private |
| `read_line/3` | 90 | private |
| `write_line/2` (text variant) | 135 | private |
| `write_line/2` (:error, :unknown_command variant) | 139 | private |
| `write_line/2` (:error, :closed variant) | 143 | private |
| `write_line/2` (:error, error variant) | 147 | private |

**Aliases declared:**
- `Ecto.Query` (import, warn: false)
- `ApiServer.Repo`
- `ApiServer.Vx.VXUser`
- `ApiServer.Vx.VXThingEvent`
- `ApiServer.Vx.VXThingEventOmega`
- `ApiServer.Vx.VXThingEventOmegaTires`
- `ApiServer.Vx.VXFleetAssociation`
- `ApiServer.Vx.VXRestriction`
- `ApiServer.Vx.Geofence`
- `ApiServer.Vx.VXThing`
- `ApiServer.Vx.VXAblRecord`
- `ApiServer.Vx.VXRayvenMessageLog`

**Constants/Magic values:**
- `5000` — TCP receive timeout (ms), line 91
- Sync bytes `<<2>>, <<85>>` — protocol constants, lines 104–123
- Message type bytes `<<0>>, <<5>>, <<38>>, <<4>>` — protocol opcodes
- `<<0>>`, `<<1>>` — sentinel msg values, lines 71–74

---

### `lib/api_server/tcp/tcp_commands.ex`

**Module:** `ApiServer.TCP.Commands`

**Functions:**
| Name | Line | Visibility |
|------|------|------------|
| `parse_hello_message/1` | 9 | public |
| `parse_data_message/3` | 35 | public |
| `parse_debug_record/3` | 120 | public |
| `parse_data_record/3` | 158 | public |
| `parse_debug_field/1` | 1325 | public |
| `parse_gps_field/1` | 1331 | public |
| `parse_digital_field/1` | 1385 | public |
| `parse_analog_field/1` | 1454 | public |
| `parse_analog32_field/1` | 1470 | public |
| `parse_trip_field/1` | 1541 | public |
| `parse_total_field/1` | 1556 | public |
| `parse_driverid_field/1` | 1571 | public |
| `parse_commit_message/2` | 1673 | public |
| `parse_iridium/2` | 1679 | public |
| `parse/2` | 1903 | public |
| `run/1` (head declaration) | 1959 | public |
| `run/1` ({:send, "hello", params}) | 1961 | public |
| `run/1` ({:send, "commit", params}) | 1966 | public |
| `run/1` ({:processed, "data", params}) | 1976 | public |
| `run/1` ({:close, "socket", params}) | 1982 | public |

**Aliases declared:**
- `ApiServer.FortyNineRepo`
- `ApiServer.FortyNine.CalampPositionEvents`
- `ApiServer.FortyNine.WebServicePositionQueue`
- `ApiServer.Vx.DeviceDatabaseLookup`
- `ApiServerWeb.UtilityController`

**Constants/Magic values (selected):**
- `1_356_998_400` — Unix timestamp for 2013-01-01 (epoch offset), lines 709, 1340, 1701
- `10_000_000` — GPS coordinate divisor (1e-7 degrees), lines 1350, 1355, 1708, 1712
- `27.778` — m/s to km/h divisor, lines 994, 1770
- `0.621371` — km/h to mph conversion, lines 1216, 1301, 1886
- `462_743` — hardcoded device hardware_id in `parse_iridium/2`, line 1756
- `"TRILITY"` / `"trility"` — hardcoded customer code and credentials, lines 1787, 1810, 1220, 1305, 1890
- `"@trility!"` — hardcoded password, lines 1221, 1306, 1891
- `"SVR49"` — hardcoded connection name, lines 1222, 1307, 1892
- `"1234"` — hardcoded MOBILENAME, lines 1219, 1304, 1889
- `"trackingsolutions"` — hardcoded DB schema prefix, lines 1188, 1228, 1273, 1313, 1858, 1898
- `255` — default/unmapped event_code sentinel, lines 89, 882
- `26` — Wiegand bit size, line 1614

---

## Findings

---

**B004-1** — [HIGH] Hardcoded credentials in source code
File: `lib/api_server/tcp/tcp_commands.ex:1221`, `1306`, `1891`
Description: The string `"@trility!"` is used as the value for `WSPASSWORD` in three separate places (lines 1221, 1306, and 1891) and is embedded directly in Elixir source. Username `"trility"` appears alongside it. These credentials authenticate an outbound web service queue insertion. Hardcoding passwords in source defeats secret rotation, exposes credentials in version control history, and violates least-privilege practices. They should be moved to application configuration (e.g., `config/runtime.exs` read from environment variables).

---

**B004-2** — [HIGH] Hardcoded hardware ID and customer code in `parse_iridium/2`
File: `lib/api_server/tcp/tcp_commands.ex:1756`, `1787`, `1810`
Description: `parse_iridium/2` unconditionally assigns `hardware_id = 462_743` (line 1756) and `customer = "vx_trility"` (line 1810), and hard-codes `custcode: "TRILITY"` (line 1787). The function signature accepts `params` but never reads the device identity from it. This means any Iridium packet, regardless of its origin device, is attributed to device 462,743. This is a data-integrity defect disguised as a code-quality issue and is severe enough to warrant HIGH.

---

**B004-3** — [HIGH] Massively duplicated field-parsing logic — no loop / recursion used
File: `lib/api_server/tcp/tcp_commands.ex:158`—`1323`
Description: `parse_data_record/3` manually unrolls field parsing seven times (field one through field seven) with deeply-nested `case` blocks that are structurally identical for each field slot. The same `{actual_field_length, field_data}` pattern-match block for length-prefixed TLV fields appears at least 14 times. The same field-type dispatch (GPS=0, trip=26, total=27, driverid=3, analog32=7) is repeated identically for every slot. This makes the function ~1,160 lines long with nesting that reaches 20+ levels. Any protocol change must be applied in 7 places simultaneously. A recursive TLV loop was clearly the intended design (the function `parse_data_message/3` already uses recursion for multi-record payloads). The repetition is a maintenance and correctness hazard of the highest order.

---

**B004-4** — [MEDIUM] Commented-out code block — `parse_analog_field` references
File: `lib/api_server/tcp/tcp_commands.ex:294–295`, `321–322`, `371–372`, `398–399`, `453–454`, `480–481`, `543–544`, `690–694`
Description: Multiple consecutive blocks of commented-out `case` clauses for field IDs 2 (digital) and 6 (analog) appear throughout `parse_data_record/3`. Representative examples:
```elixir
# 2 ->
#   parse_digital_field(field_four_data)
# 6 ->
# field_four_processed
```
These blocks appear at least 8 times across the function. The pattern suggests that digital (field type 2) and analog (field type 6) parsing was intentionally removed but not deleted. Commented-out code should be removed; if the feature is planned, a TODO or ticket reference is the appropriate placeholder.

---

**B004-5** — [MEDIUM] Commented-out code block — large block in `parse_analog32_field/1`
File: `lib/api_server/tcp/tcp_commands.ex:1494`—`1521`
Description: Twenty-eight lines of commented-out code remain in `parse_analog32_field/1` (lines 1494–1521). This was a prior implementation of the byte-reversal logic that was refactored into the current `Enum.map` approach, plus additional `IO.puts` debug calls. The dead code makes the function harder to read and obscures the current algorithm.

---

**B004-6** — [MEDIUM] Commented-out code block — commit fail message in `run/1`
File: `lib/api_server/tcp/tcp_commands.ex:1967`—`1968`
Description:
```elixir
# Fail Message
# msg = <<2, 85, 6, 1, 0, 0>>
```
The fail response binary is commented out directly above the success response. This is dead code in a critical control-flow function. It should be removed (or kept as a named constant with documentation, not a comment).

---

**B004-7** — [MEDIUM] Duplicate `{event_code, event_type}` mapping — identical case blocks in two places
File: `lib/api_server/tcp/tcp_commands.ex:51`—`90` and `844`—`883`
Description: The `log_reason` → `{event_code, event_type}` mapping (Start=1→{5,16}, End=2→{5,32}, Elapsed=3→{0,3}, Heartbeat=11→{9,0}, DriverID=17→{5,64}, LowBattery=16→{5,128}, 23→{5,23}) is spelled out identically in `parse_data_message/3` (lines 51–90) and again in the `Enum.each` closure inside `parse_data_record/3` (lines 844–883). The result from the first mapping is never used (the variable `{event_code, event_type}` bound at line 51 is shadowed at line 844). This is both redundant code and a latent bug — any update to the table in one place will silently diverge from the other.

---

**B004-8** — [MEDIUM] Variable bound but result discarded — `update_me` in `loop_acceptor/1`
File: `lib/api_server/tcp/tcp.ex:37`—`42`
Description:
```elixir
update_me = case :gen_tcp.controlling_process(client, pid) do
  {:ok} ->
    "[g62] [g62_tcp] [loop_acceptor] [ok]"
  _ ->
    "[something_else]"
end
```
`update_me` is assigned but never read. The `{:ok}` pattern is also wrong for `:gen_tcp.controlling_process/2` — the success tuple is `:ok` (an atom, not a 1-tuple). This means the success branch is unreachable; only the `_` clause will ever execute. This is both a dead binding and an unreachable clause. The Elixir compiler will warn about the unused variable; it should be prefixed `_update_me` or removed entirely, and the controlling-process error should be handled.

---

**B004-9** — [MEDIUM] `recbuf` bound but never used in `accept/1`
File: `lib/api_server/tcp/tcp.ex:27`
Description:
```elixir
recbuf = :inet.getopts(socket, [:recbuf])
```
The result of `:inet.getopts/2` is assigned to `recbuf` and never referenced again. This will produce a compiler warning for an unused variable. The call appears to have been exploratory/diagnostic and was left in. Either the value should be logged/used, or the line should be removed.

---

**B004-10** — [MEDIUM] `result` variable in `serve/2` — write path result discarded
File: `lib/api_server/tcp/tcp.ex:70`—`83`
Description: Inside `serve/2`, the outer `result` variable is bound to the `case msg do` block but never used. Within that block, `message_result` (line 78) is also assigned the return of `write_line/2` but never referenced. The `{:error, reason}` arm at line 81 also binds `reason` but discards it by returning `:error` without logging. Silently discarding write errors means failed socket writes are undetectable.

---

**B004-11** — [MEDIUM] `summary_update` bound but never used — two occurrences
File: `lib/api_server/tcp/tcp_commands.ex:1135`—`1139` and `1829`—`1831`
Description:
```elixir
summary_update =
  ApiServerWeb.VXThingController.update_thing_cached_fields(hardware_id, customer)
```
This assignment appears in `parse_data_record/3` (line 1135) and `parse_iridium/2` (line 1830). The return value is never used. The compiler will emit an unused-variable warning. The variable should be dropped (the side-effectful call kept) or replaced with `_summary_update`.

---

**B004-12** — [MEDIUM] `result` bound but never used — three occurrences
File: `lib/api_server/tcp/tcp_commands.ex:1225`, `1310`, `1895`
Description:
```elixir
result =
  %WebServicePositionQueue{}
  |> WebServicePositionQueue.changeset(fortynine_queued_event)
  |> FortyNineRepo.insert(prefix: "trackingsolutions")
```
This pattern appears three times. The `{:ok, _}` / `{:error, _}` result of the DB insert is silently discarded. Insert failures are undetectable. The variable name `result` (without underscore prefix) will also cause a compiler warning.

---

**B004-13** — [MEDIUM] `IO.puts/1` debug calls left in production path — multiple occurrences
File: `lib/api_server/tcp/tcp_commands.ex` — lines 25, 304, 381, 463, 553, 607, 640, 674, 769, 819, 1492, 1666`, and `lib/api_server/tcp/tcp.ex` (indirectly via `IO.inspect` at line 1130)
Description: Numerous `IO.puts` and `IO.inspect` calls write directly to stdout in production code paths. Notable examples:
- Line 25: `IO.puts("Could not find device: ...")` in `parse_hello_message/1`
- Lines 304, 381, 463, 553: per-field `IO.puts` for test unit 625,425 — fires on every data record for that device
- Lines 769–821: `IO.puts` for test unit 625,425 and a 37-device list (`yabby3` devices)
- Line 1492: `IO.puts("Analog values: ...")` in `parse_analog32_field/1` — fires for **every** data record that has an analog32 field
- Line 1666: `IO.puts` in `parse_driverid_field/1` — fires for every record containing a driver ID
These calls will flood stdout under normal load and have significant performance impact. They should be replaced with `Logger.debug/1` (which can be compiled out) and guarded appropriately.

---

**B004-14** — [MEDIUM] `parse_digital_field/1` is never called — dead function
File: `lib/api_server/tcp/tcp_commands.ex:1385`
Description: `parse_digital_field/1` is defined at line 1385 and is a complete, non-trivial implementation. Every call site where it was previously used has been commented out (field type 2 dispatch blocks throughout `parse_data_record/3`). The function is never invoked at runtime. It is either dead code to be deleted or an in-progress feature that was abandoned. Leaving it in place misleads maintainers.

---

**B004-15** — [MEDIUM] `parse_analog_field/1` is never called — dead function
File: `lib/api_server/tcp/tcp_commands.ex:1454`
Description: `parse_analog_field/1` is defined at line 1454 but all dispatch paths that would invoke it (field type 6) are commented out throughout `parse_data_record/3`. Like `parse_digital_field/1`, it is dead code.

---

**B004-16** — [MEDIUM] `parse_iridium/2` is never called from within the module — possible dead entry point
File: `lib/api_server/tcp/tcp_commands.ex:1679`
Description: `parse_iridium/2` is not called from `parse/2`, `run/1`, or any other function within this module. It is also not reachable through `tcp.ex`. Unless an external caller invokes it directly, it is dead code. Additionally, the function hard-codes `hardware_id = 462_743` (finding B004-2), making it a data-integrity hazard if it were ever activated.

---

**B004-17** — [MEDIUM] `{event_code, event_type}` first binding is dead — variable immediately shadowed
File: `lib/api_server/tcp/tcp_commands.ex:51`—`90`
Description: In `parse_data_message/3`, `{event_code, event_type}` is bound at line 51 from a `log_reason` case. However, both variables are completely shadowed by a second identical binding inside the `Enum.each` closure at line 844 (within `parse_data_record/3` which is called at line 98). The first binding's values are never read. The Elixir compiler cannot warn about this because the variables are used in the second binding, but the first computation is pure waste.

---

**B004-18** — [MEDIUM] `mapped_record` assigned but never used in `parse_data_message/3`
File: `lib/api_server/tcp/tcp_commands.ex:94`—`103`
Description:
```elixir
mapped_record =
  case log_reason do
    21 ->
      parse_debug_record(record, record_length, params)
      []
    _ ->
      parse_data_record(record, record_length, params)
  end
```
`mapped_record` is bound but never referenced again in the function. The side effects of `parse_data_record/3` are what matter (DB inserts), but the return value is silently dropped. The compiler will warn about the unused variable.

---

**B004-19** — [MEDIUM] Duplicate second `{event_code, event_type}` clause for hardware-ID override applies to a stale list
File: `lib/api_server/tcp/tcp_commands.ex:885`—`927`
Description: After the initial `{event_code, event_type}` mapping at lines 844–883, a second override block at lines 885–927 adjusts the value for a specific list of hardware IDs (`trility` devices, 14 IDs). The same 14 IDs also appear at line 1143–1160 for the FortyNine insert. These hardcoded device lists are a maintenance hazard — any new device requires edits in multiple places with no compile-time enforcement.

---

**B004-20** — [MEDIUM] Duplicate FortyNine insert blocks for integer vs. string serial number lists
File: `lib/api_server/tcp/tcp_commands.ex:1143`—`1229` and `1230`—`1317`
Description: The `Enum.each` closure in `parse_data_record/3` contains two consecutive `case serial_number` branches. The first (lines 1143–1229) matches on **integer** serial numbers (e.g., `461_858`); the second (lines 1230–1317) matches on **string** serial numbers (e.g., `"461858"`). The bodies are nearly identical. Because `serial_number` is always an integer (decoded via `<<serial::little-signed-integer-size(32)>>`), the string branch at line 1230 is **unreachable dead code**. Any Trility device event will always be handled by the integer branch; the string branch never fires.

---

**B004-21** — [LOW] Comment-annotated but unmapped log reason codes left in-line as comments
File: `lib/api_server/tcp/tcp_commands.ex:80`—`86` and `873`—`879`
Description: Comment blocks listing protocol codes that are intentionally unmapped:
```elixir
# 23 -> Accident
# 24 -> Accident data
# 32 -> Trip restart
# 36 -> Recovery mode on
# 37 -> Recovery mode off
# 46 -> High G event
# 48 -> Duress
```
These appear twice (lines 80–86 and 873–879). They are documentation embedded as inline comments rather than in the module's `@moduledoc` or a spec document. While individually minor, combining them with the duplicate code amplifies the maintenance burden.

---

**B004-22** — [LOW] `something` and deeply-nested throwaway variable names throughout `parse_data_record/3`
File: `lib/api_server/tcp/tcp_commands.ex` — multiple lines
Description: Variables named `something`, `something_again`, `something_again_again`, `something_again_again_again`, `something_again_again_again_again` are used as intermediate bindings inside the deeply nested field-parsing logic. These names convey no intent and are a style violation. The Elixir convention is to use descriptive names or `_` for discarded values.

---

**B004-23** — [LOW] Module-level comment acknowledging unused aliases
File: `lib/api_server/tcp/tcp.ex:6`—`7`
Description:
```elixir
# Clean these up after we know which ones we use
import Ecto.Query, warn: false
alias ApiServer.Repo
```
The comment explicitly acknowledges that the imports and aliases may not all be used, and suppresses the `warn: false` compiler warning for the Ecto import. The aliases `VXUser`, `VXThingEvent`, `VXThingEventOmega`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXFleetAssociation`, `VXRestriction`, `Geofence`, `VXThing`, `VXAblRecord`, `VXRayvenMessageLog`, and `Repo` are all declared in `tcp.ex` but none are referenced anywhere in the file. They will produce compiler warnings (the Ecto import has its warning suppressed but the others will not). The suppression of the Ecto import warning combined with the comment is an acknowledged but unresolved cleanup item.

---

**B004-24** — [LOW] `[REDACTED-AWS-SMTP-PASSWORD]` alias declared but never used
File: `lib/api_server/tcp/tcp_commands.ex:6`
Description: `alias ApiServer.Vx.DeviceDatabaseLookup` is declared at line 6 but the alias is never referenced anywhere in the file. The compiler will emit an unused-alias warning.

---

**B004-25** — [LOW] Magic number `5000` for TCP receive timeout not named
File: `lib/api_server/tcp/tcp.ex:91`
Description:
```elixir
result = :gen_tcp.recv(socket, 0, 5000)
```
The value `5000` (milliseconds) has no named constant or module attribute. If the timeout needs adjustment, it must be found by reading the code. It should be defined as `@recv_timeout_ms 5000` at the module level.

---

**B004-26** — [LOW] Magic number `1_356_998_400` used three times without explanation
File: `lib/api_server/tcp/tcp_commands.ex:709`, `1340`, `1701`
Description: The constant `1_356_998_400` (Unix timestamp for 2013-01-01 00:00:00 UTC, the device protocol's epoch base) is repeated three times without a named module attribute. A single `@device_epoch_offset 1_356_998_400` with a doc comment would make the intent clear and prevent inconsistency.

---

**B004-27** — [LOW] `{:ok}` pattern match on `:gen_tcp.controlling_process/2` is incorrect
File: `lib/api_server/tcp/tcp.ex:38`
Description:
```elixir
update_me = case :gen_tcp.controlling_process(client, pid) do
  {:ok} ->
    ...
```
`:gen_tcp.controlling_process/2` returns the atom `:ok` on success, not the one-element tuple `{:ok}`. The success branch is therefore unreachable — all outcomes (including genuine success) fall through to the wildcard. This is a silent logic error; errors are not reported and the "ok" diagnostic string is never produced.

---

**B004-28** — [LOW] `parse_commit_message/2` is a one-line pass-through with no logic
File: `lib/api_server/tcp/tcp_commands.ex:1673`—`1677`
Description:
```elixir
def parse_commit_message(remainder, params) do
  send_commit_response = {:ok, {:send, "commit", params}}
  send_commit_response
end
```
The function ignores `remainder` entirely and always returns the same value regardless of input. It exists only to provide a name to a constant tuple. This could be an anonymous inline expression in `parse/2` (line 1941), but the use of a named function is acceptable if more logic is planned. The unnecessary intermediate variable `send_commit_response` is a minor style issue.

---

**B004-29** — [LOW] `IO.puts` used in production code for device-not-found error in `parse_hello_message/1`
File: `lib/api_server/tcp/tcp_commands.ex:25`
Description:
```elixir
IO.puts("Could not find device: #{inspect(serial)}")
```
A device-not-found condition is operationally significant and should be logged at `Logger.warn` or `Logger.error` level, not `IO.puts`. `IO.puts` bypasses the application's logging infrastructure (timestamps, log level filtering, log aggregation).

---

**B004-30** — [LOW] Inconsistent `something` variable used as the final return of `read_line/3`
File: `lib/api_server/tcp/tcp.ex:93`, `132`
Description: In `read_line/3`, a variable named `something` is bound to the full `case result do` block and then returned as the last expression. No transformation occurs between the assignment and the return. This pattern adds indirection without value and departs from the idiomatic Elixir style of letting a `case` block be the function's return expression directly.

---

## Summary Table

| ID | Severity | Title | File |
|----|----------|-------|------|
| B004-1 | HIGH | Hardcoded credentials (password) in source | tcp_commands.ex:1221,1306,1891 |
| B004-2 | HIGH | Hardcoded hardware ID and customer in `parse_iridium/2` | tcp_commands.ex:1756,1787,1810 |
| B004-3 | HIGH | Massively duplicated TLV field-parsing — no loop/recursion | tcp_commands.ex:158–1323 |
| B004-4 | MEDIUM | Commented-out code — field type 2/6 dispatch blocks (8+ occurrences) | tcp_commands.ex:294,321,371,398,453,480,543,690 |
| B004-5 | MEDIUM | Commented-out code — large block in `parse_analog32_field/1` | tcp_commands.ex:1494–1521 |
| B004-6 | MEDIUM | Commented-out code — commit fail message binary | tcp_commands.ex:1967–1968 |
| B004-7 | MEDIUM | Duplicate `log_reason` → event_code mapping in two places | tcp_commands.ex:51–90, 844–883 |
| B004-8 | MEDIUM | `update_me` bound but never used; `{:ok}` pattern is wrong | tcp.ex:37–42 |
| B004-9 | MEDIUM | `recbuf` bound but never used in `accept/1` | tcp.ex:27 |
| B004-10 | MEDIUM | `result`/`message_result` discarded; write errors silently ignored | tcp.ex:70–83 |
| B004-11 | MEDIUM | `summary_update` bound but never used (2 occurrences) | tcp_commands.ex:1135,1830 |
| B004-12 | MEDIUM | `result` bound but never used for DB insert (3 occurrences) | tcp_commands.ex:1225,1310,1895 |
| B004-13 | MEDIUM | `IO.puts`/`IO.inspect` debug calls left in production paths | tcp_commands.ex:25,304,381,463,553,607,640,674,769,819,1492,1666 |
| B004-14 | MEDIUM | `parse_digital_field/1` is dead — never called | tcp_commands.ex:1385 |
| B004-15 | MEDIUM | `parse_analog_field/1` is dead — never called | tcp_commands.ex:1454 |
| B004-16 | MEDIUM | `parse_iridium/2` unreachable from any call site | tcp_commands.ex:1679 |
| B004-17 | MEDIUM | First `{event_code, event_type}` binding immediately shadowed — dead computation | tcp_commands.ex:51–90 |
| B004-18 | MEDIUM | `mapped_record` assigned but never used | tcp_commands.ex:94–103 |
| B004-19 | MEDIUM | Hardcoded device lists duplicated in multiple case branches | tcp_commands.ex:885–927,1143–1160 |
| B004-20 | MEDIUM | String-serial-number FortyNine insert branch is unreachable dead code | tcp_commands.ex:1230–1317 |
| B004-21 | LOW | Unmapped log reason codes documented only as inline comments (duplicated) | tcp_commands.ex:80–86,873–879 |
| B004-22 | LOW | Throwaway variable names (`something`, `something_again`, etc.) | tcp_commands.ex (multiple) |
| B004-23 | LOW | Acknowledged but unresolved unused aliases in `tcp.ex` | tcp.ex:6–18 |
| B004-24 | LOW | `[REDACTED-AWS-SMTP-PASSWORD]` alias declared but never used | tcp_commands.ex:6 |
| B004-25 | LOW | Magic number `5000` (recv timeout) not named | tcp.ex:91 |
| B004-26 | LOW | Magic number `1_356_998_400` (epoch offset) used 3 times, not named | tcp_commands.ex:709,1340,1701 |
| B004-27 | LOW | Incorrect `{:ok}` pattern for `:gen_tcp.controlling_process/2` | tcp.ex:38 |
| B004-28 | LOW | `parse_commit_message/2` is a trivial pass-through with an unnecessary intermediate variable | tcp_commands.ex:1673–1677 |
| B004-29 | LOW | `IO.puts` used for operationally significant device-not-found error | tcp_commands.ex:25 |
| B004-30 | LOW | Unnecessary `something` variable as final return in `read_line/3` | tcp.ex:93,132 |

**Totals:** 3 HIGH, 17 MEDIUM, 10 LOW
# Pass 4 – B005

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01

**Files reviewed:**
- `lib/api_server/vx/device_database_lookup.ex`
- `lib/api_server/vx/email.ex`
- `lib/api_server/vx/equipment.ex`
- `lib/api_server/vx/equipment_assignment.ex`

---

## Reading Evidence

### 1. `lib/api_server/vx/device_database_lookup.ex`

**Module:** `ApiServer.Vx.DeviceDatabaseLookup`

**Behaviours/macros used:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

**Schema:**
- Table: `"DeviceDatabaseLookup"`
- Primary key: `@primary_key {:ID, :id, autogenerate: true}` (line 5)
- Fields: `:hardwareid` (source `:hardwareID`), `:customer` (source `:databaseName`), `:custcode` (source `:CustCode`), `:iccid` (source `:ICCID`)

**Functions:**
| Name | Line |
|------|------|
| `changeset/2` | 13 |

**Types/constants defined:** none

---

### 2. `lib/api_server/vx/email.ex`

**Module:** `ApiServer.Email`
_(Note: file lives under `vx/` but module is NOT namespaced under `ApiServer.Vx`)_

**Behaviours/macros used:**
- `use Bamboo.Phoenix, view: ApiServer.EmailView`

**Functions:**
| Name | Line |
|------|------|
| `send_notification_email/3` | 4 |
| `send_test_email/3` | 14 |
| `send_enter_email/4` | 103 |
| `send_missing_serial_email/4` | 167 |
| `send_digital_matter_email/4` | 215 |
| `send_slow_email/4` | 262 |
| `send_exit_email/4` | 303 |

**Types/constants defined:** none
**Commented-out code blocks:** lines 105–114, 119, 172, 220, 267, 307 (`# |> text_body(...)` and a large data map comment)

---

### 3. `lib/api_server/vx/equipment.ex`

**Module:** `ApiServer.Vx.Equipment`

**Behaviours/macros used:**
- `use Ecto.Schema`
- `import Ecto.Changeset`
- `alias ApiServer.Vx`

**Schema:**
- Table: `"equipment"`
- Primary key: `@primary_key {:ID, :id, autogenerate: true}` (line 7)
- Fields: `:id` (integer, source `:id`), `:name`, `:make`, `:model`, `:serial_number`, `:class`, `:type`, `:created`

**Functions:**
| Name | Line |
|------|------|
| `changeset/2` | 20 |

**Types/constants defined:** none

---

### 4. `lib/api_server/vx/equipment_assignment.ex`

**Module:** `ApiServer.Vx.EquipmentAssignment`

**Behaviours/macros used:**
- `use Ecto.Schema`
- `import Ecto.Changeset`
- `alias ApiServer.Vx`

**Schema:**
- Table: `"equipment_assignment"`
- Primary key: `@primary_key {:ID, :id, autogenerate: true}` (line 7)
- Fields: `:id` (integer, source `:id`), `:equipment_id`, `:device_group`, `:device_group_timezone`, `:assignment_start`, `:assignment_end`, `:created`

**Functions:**
| Name | Line |
|------|------|
| `changeset/2` | 20 |

**Types/constants defined:** none
**Commented-out code blocks:** line 17 (`# belongs_to :equipment, ...`)

---

## Findings

---

**B005-1** — [HIGH] `send_notification_email/3` ignores its `to` parameter; recipient is hardcoded

File: `lib/api_server/vx/email.ex:4`

Description: The function signature accepts a `to` argument but the body unconditionally pipes to `"graham.oconnell@trackingsolutions.com.au"` (line 7), making the caller-supplied recipient silently ignored. Every invocation of this function sends to a fixed internal address regardless of intent. Additionally, this function is never called anywhere in the codebase (confirmed by full-repo grep), making it dead code that could be confused with a working notification mechanism. The hardcoded recipient is an additional issue catalogued separately (B005-6).

---

**B005-2** — [HIGH] `send_test_email/3` ignores its `to` parameter; recipient is hardcoded; function is dead code

File: `lib/api_server/vx/email.ex:14`

Description: Same problem as B005-1. The `to` parameter is accepted but never used; the recipient is hardcoded to `"graham.oconnell@trackingsolutions.com.au"` (line 16). Furthermore, a full-repo search confirms `send_test_email` is never called anywhere — it is dead code. The function body also contains a massive block of hardcoded HTML representing two different geofence alert templates (enter and exit) combined into one response, making it misleading as a "test" function.

---

**B005-3** — [HIGH] `send_slow_email/4` and `send_digital_matter_email/4` are dead code — never called in live paths

File: `lib/api_server/vx/email.ex:215`, `lib/api_server/vx/email.ex:262`

Description: Full-repo grep shows every call site for `send_digital_matter_email` and `send_slow_email` is commented out. Neither function is invoked in any live code path. Dead email functions accumulate maintenance debt and create confusion about whether alerting for digital-matter payloads or slow processing is active.

---

**B005-4** — [MEDIUM] `send_missing_serial_email/4` is dead code — all call sites are commented out

File: `lib/api_server/vx/email.ex:167`

Description: All three call sites in `utility_controller.ex` (lines 1707, 1729, 5390, 5613) are commented out. The function accepts a `to_email_address` parameter but is never invoked in any live path. The body contains a hardcoded first-name greeting "Graham" (B005-7) rather than using the supplied data map.

---

**B005-5** — [MEDIUM] Wrong email subject heading in `send_missing_serial_email/4`

File: `lib/api_server/vx/email.ex:177`

Description: The HTML `<h3>` heading inside `send_missing_serial_email` reads "Geofence alert - Vehicle has exited" (line 177). This function is for missing serial number notifications, not geofence exit events. The misleading heading indicates the body was copy-pasted from `send_exit_email` without updating the subject line. Similarly, `send_digital_matter_email` (line 225) carries the same "Geofence alert - Vehicle has exited" heading despite being a debug/diagnostic email for Digital Matter device payloads.

---

**B005-6** — [HIGH] Multiple hardcoded personal email addresses and production domain URLs

File: `lib/api_server/vx/email.ex:5,7,16,46,87,152,199,246,288,338`

Description: The following hardcoded values appear throughout email.ex:
- Recipient `"graham.oconnell@trackingsolutions.com.au"` — hardcoded in `send_notification_email` (line 7) and `send_test_email` (line 16).
- Sender `"no-reply@mobilehourmeter.com"` — hardcoded in `send_notification_email` (line 5).
- Logo image URL `https://vx-demo.mobilehourmeter.com/img/logoleft_vx-demo.png` — hardcoded in every email template (lines 46, 87, 152, 199, 246, 288, 338). This points to a demo/staging environment URL embedded in production email templates.
- Personal first name `"Graham"` hardcoded as the salutation in `send_missing_serial_email` (line 178), `send_digital_matter_email` (line 226), and `send_slow_email` (line 273).

Hardcoding personal names and email addresses into source code means recipients cannot be changed without a code deployment, prevents environment-specific configuration, and exposes PII in version history.

---

**B005-7** — [MEDIUM] `send_notification_email/3` accepts `to` but Bamboo's `to/2` helper is shadowed by the parameter name

File: `lib/api_server/vx/email.ex:4`

Description: The function parameter is named `to`, which shadows Bamboo's imported `to/2` pipeline helper. Within the function body, `|> to(...)` does NOT use the parameter — it calls the Bamboo `to/2` function with a hardcoded string. This is a subtle name-collision bug: if someone later tries to use the `to` variable in the pipeline they will get a `BadArityError` because `to` is bound to the caller-supplied value, not the Bamboo function. The actual delivery recipient is therefore always the hardcoded string.

---

**B005-8** — [MEDIUM] Commented-out `belongs_to` association in `EquipmentAssignment`

File: `lib/api_server/vx/equipment_assignment.ex:17`

Description: Line 17 contains a commented-out `belongs_to :equipment, ApiServer.Vx.Equipment` declaration. This suppresses the Ecto association that would allow `equipment_assignment` records to be preloaded with their parent `equipment` record. Any code that attempts to preload `:equipment` on an `EquipmentAssignment` struct will raise an Ecto association error at runtime. The comment gives no rationale for why the association was disabled, making it unclear whether this is intentional or an oversight.

---

**B005-9** — [MEDIUM] `alias ApiServer.Vx` is unused in `Equipment` and `EquipmentAssignment`

File: `lib/api_server/vx/equipment.ex:5`, `lib/api_server/vx/equipment_assignment.ex:5`

Description: Both modules declare `alias ApiServer.Vx` (line 5 in each) but `Vx` is never referenced in the module body. In `equipment_assignment.ex` the only occurrence of `ApiServer.Vx.Equipment` is inside the commented-out `belongs_to` (line 17), which means the alias was added in anticipation of that line but became orphaned when the association was commented out. Elixir will emit an "unused alias" compiler warning for both files.

---

**B005-10** — [MEDIUM] `field :id` re-declares the primary key virtual column in `Equipment` and `EquipmentAssignment`

File: `lib/api_server/vx/equipment.ex:7,9`, `lib/api_server/vx/equipment_assignment.ex:7,9`

Description: Both schemas set `@primary_key {:ID, :id, autogenerate: true}` (which generates a virtual field accessed as `.ID`) and then immediately declare `field :id, :integer, source: :id` as a separate schema field. The `:id` atom used as the auto-generate type in `@primary_key` is the Ecto `{:ID, :id, ...}` tuple where `:id` is the Elixir type — but adding a second explicit `field :id` with type `:integer` creates a duplicate field definition that Ecto will warn about or silently override. The `:id` field is also included in `cast/3` calls, so user-supplied IDs can overwrite the primary key.

---

**B005-11** — [LOW] Commented-out `text_body` lines across multiple email functions

File: `lib/api_server/vx/email.ex:19,119,172,220,267,307`

Description: Six separate `# |> text_body(message)` (or similar) comments exist, one in each email builder function. These appear to be placeholder stubs that were never implemented; none of the email functions send a plain-text alternative, meaning all outgoing emails are HTML-only. The repeated commented stubs should either be implemented (to provide proper plain-text fallback for accessibility and spam-filter compliance) or removed.

---

**B005-12** — [LOW] Commented-out example data map in `send_enter_email/4`

File: `lib/api_server/vx/email.ex:105`

Description: Lines 105–114 contain a commented-out example `data` map that was used during development to document the expected structure of the `data` parameter. This should be replaced with an `@doc` or `@spec` annotation (using a `%{}` typespec or inline documentation) and the comment removed from production code.

---

**B005-13** — [LOW] Module naming inconsistency: `ApiServer.Email` is located in the `vx/` subdirectory

File: `lib/api_server/vx/email.ex:1`

Description: All other modules in `lib/api_server/vx/` are named under `ApiServer.Vx.*` (e.g., `ApiServer.Vx.Equipment`, `ApiServer.Vx.DeviceDatabaseLookup`). The email module at the same path is named `ApiServer.Email` (no `Vx` namespace). This inconsistency means the module name does not reflect its file location, which violates Elixir's standard convention and breaks the assumption that `ApiServer.Vx.*` contains all vx-layer logic.

---

**B005-14** — [LOW] Indentation style inconsistency across files in the same directory

File: `lib/api_server/vx/equipment.ex`, `lib/api_server/vx/equipment_assignment.ex`, `lib/api_server/vx/device_database_lookup.ex` vs `lib/api_server/vx/email.ex`

Description: `device_database_lookup.ex`, `equipment.ex`, and `equipment_assignment.ex` all use 4-space indentation. `email.ex` uses 2-space indentation (the Elixir standard). This suggests the three schema files were authored or auto-generated with a non-standard editor configuration. While functionally benign, the inconsistency creates visual friction when reviewing diffs and does not conform to the Elixir community style guide (2-space indent).

---

**B005-15** — [LOW] `ApiServer.EmailView` referenced but module does not exist

File: `lib/api_server/vx/email.ex:2`

Description: `use Bamboo.Phoenix, view: ApiServer.EmailView` references `ApiServer.EmailView`, but no file defining that module exists anywhere in the repository. Bamboo.Phoenix uses the view module at compile time to render EEx templates. Since none of the functions in `ApiServer.Email` actually call `render/2` (they use inline `html_body` strings instead), this currently causes no runtime error, but it is a stale/incorrect configuration that will produce a compile-time warning or error if Bamboo.Phoenix attempts to verify the view module.

---

**B005-16** — [LOW] All four files use Windows CRLF line endings

File: `lib/api_server/vx/device_database_lookup.ex`, `lib/api_server/vx/email.ex`, `lib/api_server/vx/equipment.ex`, `lib/api_server/vx/equipment_assignment.ex`

Description: All four files contain CRLF (`\r\n`) line endings. Standard Elixir/Unix projects use LF-only line endings. If `.gitattributes` does not enforce normalization, these files will produce noisy diffs on Unix developer machines and CI systems.

---

## Summary Table

| ID | Severity | Title | File |
|----|----------|-------|------|
| B005-1 | HIGH | `send_notification_email` ignores `to` param; hardcoded recipient; dead code | email.ex:4 |
| B005-2 | HIGH | `send_test_email` ignores `to` param; hardcoded recipient; dead code | email.ex:14 |
| B005-3 | HIGH | `send_slow_email` and `send_digital_matter_email` are dead code | email.ex:215,262 |
| B005-4 | MEDIUM | `send_missing_serial_email` is dead code — all call sites commented out | email.ex:167 |
| B005-5 | MEDIUM | Wrong heading text in `send_missing_serial_email` and `send_digital_matter_email` | email.ex:177,225 |
| B005-6 | HIGH | Hardcoded personal email addresses, sender address, and demo-env logo URL | email.ex:5,7,16,46+ |
| B005-7 | MEDIUM | Parameter `to` shadows Bamboo `to/2` helper in `send_notification_email` | email.ex:4 |
| B005-8 | MEDIUM | Commented-out `belongs_to` association suppresses Ecto preload capability | equipment_assignment.ex:17 |
| B005-9 | MEDIUM | Unused alias `ApiServer.Vx` in `Equipment` and `EquipmentAssignment` | equipment.ex:5, equipment_assignment.ex:5 |
| B005-10 | MEDIUM | `field :id` re-declares the primary key in `Equipment` and `EquipmentAssignment` | equipment.ex:9, equipment_assignment.ex:9 |
| B005-11 | LOW | Commented-out `text_body` stubs in every email function | email.ex:19,119,172,220,267,307 |
| B005-12 | LOW | Commented-out example data map should be `@doc`/`@spec` | email.ex:105 |
| B005-13 | LOW | `ApiServer.Email` module name inconsistent with `vx/` file location | email.ex:1 |
| B005-14 | LOW | 4-space indentation in schema files vs 2-space in email.ex | device_database_lookup.ex, equipment.ex, equipment_assignment.ex |
| B005-15 | LOW | `ApiServer.EmailView` referenced but module does not exist | email.ex:2 |
| B005-16 | LOW | All four files use Windows CRLF line endings | all four files |
# Pass 4 – B006

Date: 2026-02-27
Audit run: 2026-02-27-01
Files reviewed:
- lib/api_server/vx/erp_import.ex
- lib/api_server/vx/geofence.ex
- lib/api_server/vx/mailer.ex
- lib/api_server/vx/rental_contracts.ex

---

## Reading Evidence

### lib/api_server/vx/erp_import.ex

**Module:** `ApiServer.Vx.ERPImport`

**Schema fields defined:**
- `:raw_record` (:string)
- `:serialno` (:string)
- `:name` (:string)
- `:matched` (:boolean)
- `:type` (:string)

**Module-level attributes:**
- `@primary_key {:id, :id, autogenerate: true}` (line 6)

**Functions:**
| Name | Line | Visibility |
|---|---|---|
| `changeset/2` | 15 | public |

**Types / errors / constants:** none explicitly defined.

---

### lib/api_server/vx/geofence.ex

**Module:** `ApiServer.Vx.Geofence`

**Schema fields defined:**
- `:name` (:string)
- `:geojson` (:string)

**Module-level attributes:**
- `@primary_key {:id, :id, autogenerate: true}` (line 10)

**Aliases / imports:**
- `import Ecto.Changeset` (line 3)
- `import Ecto.Query, warn: false` (line 4)
- `alias ApiServer.Repo` (line 6)
- `alias ApiServer.Vx` (line 7)
- `alias ApiServer.Vx.VXThingEvent` (line 8)

**Functions:**
| Name | Line | Visibility |
|---|---|---|
| `changeset/2` | 17 | public |
| `geojson_map_to_string/1` | 24 | public |
| `geojson_db_string_to_map/1` | 38 | public |
| `does_event_cause_geofence_events_no_thing/5` | 52 | private |
| `check_event_for_left_events_no_thing/5` (nil clause) | 69 | private |
| `check_event_for_left_events_no_thing/5` (general clause) | 70 | private |
| `check_event_for_entered_events_no_thing/6` | 86 | private |
| `make_geofence_event_no_thing/5` | 103 | private |
| `engine_hours_at_event_no_thing/2` | 119 | private |

**Types / errors / constants:** none explicitly defined.

---

### lib/api_server/vx/mailer.ex

**Module:** `ApiServer.Mailer`

**Functions:** none (delegates entirely to `Bamboo.Mailer` via `use`)

**Types / errors / constants:** none.

---

### lib/api_server/vx/rental_contracts.ex

**Module:** `ApiServer.Vx.RentalContract`

**Schema fields defined:**
- `:id` (:integer, source: :id)
- `:equipment_id` (:integer, source: :equipment_id)
- `:customer_id` (:integer, source: :customer_id)
- `:contract_reference` (:string, source: :contract_reference)
- `:contract_start` (:date, source: :contract_start)
- `:contract_end` (:date, source: :contract_end)
- `:billing_frequency` (:string, source: :billing_frequency)
- `:hours_per_billing_period` (:integer, source: :hours_per_billing_period)
- `:cost_units` (:string, source: :cost_units)
- `:cost_per_unit` (:float, source: :cost_per_unit)
- `:reporting_frequency` (:string, source: :reporting_frequency)
- `:created` (:utc_datetime, source: :created)
- `:sent_to_rayven` (:integer, source: :sent_to_rayven)

**Module-level attributes:**
- `@primary_key {:ID, :id, autogenerate: true}` (line 5)

**Functions:**
| Name | Line | Visibility |
|---|---|---|
| `changeset/2` | 22 | public |

**Types / errors / constants:** none explicitly defined.

---

## Findings

**B006-1** — [HIGH] Dead private function cluster: `does_event_cause_geofence_events_no_thing/5` and all its callees are never called
File: lib/api_server/vx/geofence.ex:52
Description: The private function `does_event_cause_geofence_events_no_thing/5` (line 52) and the four private functions it calls — `check_event_for_left_events_no_thing/5` (lines 69–70), `check_event_for_entered_events_no_thing/6` (line 86), `make_geofence_event_no_thing/5` (line 103), and `engine_hours_at_event_no_thing/2` (line 119) — are never called from anywhere in the codebase. A parallel "with_thing" implementation of the same algorithm exists in `GeofenceController` (lines 115–202). This entire block is unreachable dead code. The compiler will not warn because the functions are `defp` called only from other `defp` functions in the same file, with the root being the uncalled one. It represents roughly 80 lines of logic that is silently never exercised, including a live database query (`Repo.one`) and timezone conversion, which could diverge from the active implementation without anyone noticing.

---

**B006-2** — [MEDIUM] Unused aliases `ApiServer.Vx` and `ApiServer.Vx.VXThingEvent` in `Geofence`
File: lib/api_server/vx/geofence.ex:7-8
Description: `alias ApiServer.Vx` (line 7) and `alias ApiServer.Vx.VXThingEvent` (line 8) are declared but neither alias is referenced anywhere in the file body. Similarly, `import Ecto.Query, warn: false` (line 4) suppresses the unused-import warning but no Ecto.Query macros (`from`, `where`, `select`, etc.) appear in the file. All three declarations are unused imports/aliases. Elixir would normally emit compiler warnings for unused aliases; the `warn: false` on the import silences it, which masks the dead import from routine build output.

---

**B006-3** — [MEDIUM] `engine_hours_at_event_no_thing/2` has a non-exhaustive `case` on `hardwaretype`
File: lib/api_server/vx/geofence.ex:119
Description: The case expression matches only `hardwaretype` values `1` and `2`. The codebase assigns at least `hardwaretype: 5` (Pivotel controller, pivotel_controller.ex lines 59, 96) and other hardware types (3, 4, 6, 7, 8, 9 visible in the active `GeofenceController.engine_hours_at_event/3`). If this dead function were ever activated, any event with an unhandled hardware type would raise a `CaseClauseError` at runtime. Although the function is currently unreachable (see B006-1), the incomplete case is an independent correctness defect.

---

**B006-4** — [MEDIUM] `check_event_for_left_events_no_thing/5` nil-clause returns the wrong shape
File: lib/api_server/vx/geofence.ex:69
Description: The nil-clause guard clause returns a bare list `[]`:
```elixir
defp check_event_for_left_events_no_thing(customer, event, event_time, event_loc, nil), do: []
```
The caller at line 63 pattern-matches the return value as a two-element tuple:
```elixir
{fences_still_inside, left_events} = check_event_for_left_events_no_thing(...)
```
Returning `[]` instead of `{[], []}` would cause a `MatchError` at runtime whenever `in_geofences` is `nil`. The analogous nil-clause in `GeofenceController.check_event_for_left_events/6` (line 132) has the same defect, confirming this was copied without correction.

---

**B006-5** — [LOW] Variable `datetime` bound but never used in `does_event_cause_geofence_events_no_thing/5`
File: lib/api_server/vx/geofence.ex:57
Description: Inside the `%Timex.AmbiguousDateTime{}` branch, the result of `Map.get(adt, :after)` is bound to `datetime` (line 57) but `datetime` is never subsequently referenced — the variable used later is `event_time` (line 63). The actual value assigned to `event_time` comes from the outer `case` expression's result, which in the ambiguous branch is the value of `datetime`. Elixir assigns the last expression of a `case` clause as the overall result, so `event_time` does receive the correct value, but the intermediate `datetime` binding is redundant noise and Elixir would normally emit an "unused variable" warning for it. The `warn: false` import silencing means this may be masked entirely.

---

**B006-6** — [LOW] `@primary_key` field name `{:ID, ...}` inconsistent with `{:id, ...}` in sibling schemas
File: lib/api_server/vx/rental_contracts.ex:5
Description: `RentalContract` declares `@primary_key {:ID, :id, autogenerate: true}` using the atom `:ID` (uppercase). `ERPImport` (line 6) and `Geofence` (line 10) use `:id` (lowercase). Within the `vx/` directory, there are two competing conventions: uppercase `:ID` (equipment, equipment_assignment, rental_contracts, rental_periods, device_database_lookup) and lowercase `:id` (erp_import, geofence, vx_rayven_stream_status, vx_thing_info) alongside schema-specific names (`:ablid`, `:aacid`, etc.). `RentalContract` is inconsistent with `ERPImport` and `Geofence` specifically. The uppercase `:ID` atom is unusual in Elixir/Ecto conventions and may interact unexpectedly with Ecto's default primary-key introspection.

---

**B006-7** — [LOW] All `source:` annotations in `RentalContract` are redundant no-ops
File: lib/api_server/vx/rental_contracts.ex:7-19
Description: Every field declaration carries an explicit `source:` option whose value is identical to the field name atom (e.g., `field :equipment_id, :integer, source: :equipment_id`). Ecto's default `source` for a field is already the field's own atom name, so these annotations have no effect. All thirteen `source:` options are dead configuration. This is a style/clarity issue: a future developer might believe the `source:` values differ from the field names and reference them for migration or query logic, creating confusion. No other schema in the `vx/` directory applies this pattern.

---

**B006-8** — [LOW] `rental_contracts.ex` uses 4-space indentation with `end` outside module body's 2-space convention
File: lib/api_server/vx/rental_contracts.ex:1-26
Description: The entire file body is indented with 4 spaces per level (e.g., `    use Ecto.Schema` at the `defmodule` body level, `        field ...` inside `schema do`), whereas `erp_import.ex` and `geofence.ex` use the standard 2-space Elixir convention. The closing `end` at line 26 is at 2-space indent, mismatching the 4-space body. Additionally, `rental_contracts.ex` has Windows-style CRLF line endings (confirmed via `cat -A`), consistent with all other files in the set but worth noting as the file also has the non-standard indentation, suggesting it was authored in a different editor environment.

---

**B006-9** — [LOW] `changeset/2` in `RentalContract` has no `validate_required/2` call
File: lib/api_server/vx/rental_contracts.ex:22
Description: The `changeset/2` function casts thirteen fields but calls no `validate_required/2`, meaning any subset of fields can be omitted without changeset-level validation errors. The sibling schemas `ERPImport` (validates `:raw_record`) and `Geofence` (validates `:name`) both include at minimum one required field. For a domain object representing a financial rental contract, fields such as `:equipment_id`, `:customer_id`, `:contract_start`, and `:contract_end` are logically mandatory and the absence of validation is a correctness gap.

---

**B006-10** — [LOW] `geojson_db_string_to_map/1` returns `""` (empty string) on `nil` input instead of `nil` or `%{}`
File: lib/api_server/vx/geofence.ex:38
Description: Both `geojson_map_to_string/1` and `geojson_db_string_to_map/1` return `""` for both their nil-input and decode-failure branches. For `geojson_map_to_string/1` this is defensible (caller expects a string). For `geojson_db_string_to_map/1`, the function name and purpose imply it returns a map; returning `""` (a string) on failure is a type inconsistency. The caller in `VxThingEventView` passes the result directly to a JSON response as `geoJSON:`, and the caller in `vx.ex` line 3238 assigns it to `geomap` which is subsequently used as geospatial data. An empty string where a map is expected will cause downstream errors in callers that do not guard against this case.

---

## Summary Table

| ID | Severity | File | Line | Title |
|---|---|---|---|---|
| B006-1 | HIGH | geofence.ex | 52 | Dead private function cluster (`*_no_thing`) never called |
| B006-2 | MEDIUM | geofence.ex | 7–8 | Unused aliases `Vx`, `VXThingEvent`, and suppressed unused `Ecto.Query` import |
| B006-3 | MEDIUM | geofence.ex | 119 | Non-exhaustive `case` on `hardwaretype` in dead function |
| B006-4 | MEDIUM | geofence.ex | 69 | Nil-clause returns `[]` but caller expects `{[], []}` — shape mismatch |
| B006-5 | LOW | geofence.ex | 57 | Variable `datetime` bound but never read |
| B006-6 | LOW | rental_contracts.ex | 5 | `@primary_key` atom `:ID` inconsistent with `:id` in sibling schemas |
| B006-7 | LOW | rental_contracts.ex | 7–19 | All `source:` annotations are identity no-ops |
| B006-8 | LOW | rental_contracts.ex | 1–26 | Non-standard 4-space indentation; closing `end` at wrong indent level |
| B006-9 | LOW | rental_contracts.ex | 22 | `changeset/2` has no `validate_required/2` for financial domain fields |
| B006-10 | LOW | geofence.ex | 38 | `geojson_db_string_to_map/1` returns `""` (string) where map is expected |
# Pass 4 – B007

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B007

## Files Reviewed

- `lib/api_server/vx/rental_periods.ex`
- `lib/api_server/vx/scheduler.ex`
- `lib/api_server/vx/vx_user_function.ex`

---

## Reading Evidence

### 1. `lib/api_server/vx/rental_periods.ex`

**Module:** `ApiServer.Vx.RentalPeriod`

**Directives:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema definition:**
- `@primary_key {:ID, :id, autogenerate: true}` (line 5)
- Table: `"rental_periods"` (line 6)

**Fields defined in schema block:**
| Line | Field name        | Type           | source:          |
|------|-------------------|----------------|------------------|
| 7    | `:id`             | `:integer`     | `:id`            |
| 8    | `:contract_id`    | `:integer`     | `:contract_id`   |
| 9    | `:period_start`   | `:date`        | `:period_start`  |
| 10   | `:period_end`     | `:date`        | `:period_end`    |
| 11   | `:hours_used`     | `:float`       | `:hours_used`    |
| 12   | `:overage`        | `:float`       | `:overage`       |
| 13   | `:is_completed`   | `:integer`     | `:is_completed`  |
| 14   | `:created`        | `:utc_datetime`| `:created`       |

**Functions:**
| Line | Name          | Arity |
|------|---------------|-------|
| 17   | `changeset/2` | 2     |

**Types / errors / constants:** None explicitly defined.

---

### 2. `lib/api_server/vx/scheduler.ex`

**Module:** `ApiServer.Scheduler`

**Directives:**
- `use Quantum.Scheduler, otp_app: :api_server` (lines 2–3)

**Functions:** None explicitly defined (all provided by `Quantum.Scheduler` macro).

**Types / errors / constants:** None.

---

### 3. `lib/api_server/vx/vx_user_function.ex`

**Module:** `ApiServer.Vx.VXUserFunction`

**Directives:**
- `use Ecto.Schema` (line 2)
- `import Ecto.Changeset` (line 3)

**Schema definition:**
- `@primary_key {:aatid, :id, autogenerate: true}` (line 5)
- Table: `"aat_user_functions"` (line 6)

**Fields defined in schema block:**
| Line | Field name        | Type       | Notes                                          |
|------|-------------------|------------|------------------------------------------------|
| 7    | `:aatfunction_id` | `:integer` | Plain field declaration, no `source:` option   |
| 8    | `:aatuser_id`     | `:integer` | Plain field declaration, no `source:` option   |
| 10   | `belongs_to :user`| —          | `ApiServer.Vx.VXUser`, FK `:aatuser_id`, `define_field: false` |

**Functions:**
| Line | Name          | Arity |
|------|---------------|-------|
| 14   | `changeset/2` | 2     |

**Types / errors / constants:** None explicitly defined.

---

## Findings

---

**B007-1** — [HIGH] Field name mismatch in `changeset/2` causes silent cast failure and broken validation

File: `lib/api_server/vx/vx_user_function.ex:16-17`

Description: The schema declares the field as `:aatfunction_id` (line 7, with an underscore before `id`), but `cast/3` and `validate_required/2` both reference `:aatfunctionid` (no underscore). In Ecto 2.x, `cast/3` silently ignores any key in the permitted list that does not match a known schema field — meaning `:aatfunction_id` is never cast from incoming attributes. Consequently `validate_required([:aatfunctionid])` always finds the field absent and every `create_vx_user_function/1` and `update_vx_user_function/2` call returns `{:error, changeset}` with a required-field validation error. The same inconsistency propagates to the view (`vx_user_function_view.ex:17`) which accesses `vx_user_function.aatfunctionid`, raising a `KeyError` at runtime when rendering. This is a data-loss and runtime-crash bug for any future code path that re-enables the commented-out controller actions.

---

**B007-2** — [MEDIUM] Commented-out code constitutes the entire controller body

File: `lib/api_server_web/controllers/vx_user_function_controller.ex:9-41`

Description: Every action that a REST controller would expose (`index`, `create`, `show`, `update`, `delete`) is commented out. The module compiles to a shell containing only the `use`, two `alias` directives, and an `action_fallback` declaration with no live action clauses. This is not intentional feature-flagging via configuration — it is deferred work left in production source. Commented-out code of this volume obscures intent and hides the B007-1 field-name bug from any reader doing static review. Minimum severity LOW per pass instructions; raised to MEDIUM because it represents the totality of the module's intended functionality being absent.

---

**B007-3** — [LOW] Commented-out code block in `config.exs` scheduler jobs list

File: `config/config.exs:26-104`

Description: Approximately 35 of the ~48 scheduler job entries in the Quantum `jobs:` list are commented out, spanning tenants such as `vx_cea`, `vx_yocam`, `vx_south32`, `vx_komatsuau`, `vx_matthai`, `vx_hannaman`, `vx_cmhcusa`, `vx_demouk`, `vx_floridaforklifts`, `vx_kionasia`, `vx_arconic`, `vx_rentcorp`, `vx_tmhs`, `vx_atlanticfs`, `vx_mhinc`, `vx_darr`, `vx_cbe`, and others. This is directly adjacent to `scheduler.ex` (the configured module). While some entries may represent intentionally disabled tenants, there is no comment explaining the decision for individual disablement, and several appear interleaved with active entries of identical cron patterns. The configuration file is the runtime surface of the scheduler module and its commented state belongs here in the scheduler review context.

---

**B007-4** — [LOW] Commented-out design notes masquerading as code in `config.exs`

File: `config/config.exs:22-24`

Description: Lines 22–24 contain a commented-out `overlap: false` option accompanied by multi-line design questions ("What is going to happen here over multiple time periods?", "Queue table?"). These are architectural discussion notes that belong in a ticket or design document, not in a committed configuration file. The `overlap` option itself is meaningful for Quantum — its omission means jobs will overlap if the previous run has not finished — making the unanswered question a latent operational risk, not just a style issue.

---

**B007-5** — [LOW] Module name does not match file path (Elixir naming convention violation)

File: `lib/api_server/vx/scheduler.ex:1`

Description: The module is named `ApiServer.Scheduler` but the file lives at `lib/api_server/vx/scheduler.ex`. By Elixir convention the module name determines the expected file path: `ApiServer.Scheduler` should reside at `lib/api_server/scheduler.ex`. While Elixir does not enforce this at compile time, Mix tooling, IDE navigation (`go-to-definition`), and the standard `mix format` / `mix xref` conventions all assume the mapping holds. A developer searching for `ApiServer.Scheduler` will look in `lib/api_server/` and not find it. The application supervisor (`application.ex:19`) correctly references `ApiServer.Scheduler`, so the scheduler boots, but the file placement will cause confusion.

---

**B007-6** — [LOW] Redundant `source:` annotations where column name equals field name

File: `lib/api_server/vx/rental_periods.ex:7-14`

Description: Every `field` declaration in this schema carries a `source:` option whose value is identical to the field name (e.g., `field :contract_id, :integer, source: :contract_id`). In Ecto, `source:` is only needed when the database column name differs from the Elixir field name. When they are the same, the annotation is noise that adds cognitive overhead and creates a maintenance hazard — if a field is renamed, a developer must update both the field atom and the `source:` atom, and it is easy to miss one. The same pattern appears in the sibling `rental_contracts.ex` and `equipment.ex` schemas, suggesting copy-paste origin. The `device_database_lookup.ex` schema correctly uses `source:` only where column names differ (e.g., `source: :hardwareID`), demonstrating the correct pattern exists in the project.

---

**B007-7** — [LOW] Inconsistent indentation: 4-space indent instead of 2-space Elixir standard

File: `lib/api_server/vx/rental_periods.ex:2-20`

Description: The entire body of this module uses 4-space indentation (e.g., `    use Ecto.Schema`, `    schema "rental_periods" do`). The Elixir style guide and `mix format` both specify 2-space indentation. All other schemas in the `vx/` directory that were not authored alongside `rental_periods.ex` use 2-space indentation (e.g., `vx_user_function.ex`, `vx_rental.ex`, `vx_restriction.ex`). The 4-space pattern appears to be a copy from `rental_contracts.ex` (which has the same indentation), suggesting both were authored together and never formatted. Inconsistent indentation makes diffs harder to read and signals that `mix format` is not enforced at commit time.

---

**B007-8** — [LOW] `@primary_key` field named `:ID` (uppercase atom) deviates from convention

File: `lib/api_server/vx/rental_periods.ex:5`

Description: `@primary_key {:ID, :id, autogenerate: true}` names the primary-key struct field `:ID` (uppercase). Elixir atom and variable naming convention uses `snake_case`; uppercase atoms are valid but unconventional. This means accessing the primary key on a struct requires `record.ID` rather than the conventional `record.id`. The same pattern appears in `rental_contracts.ex` and `equipment.ex` / `equipment_assignment.ex` (also 4-space indented), but the majority of schemas in the project use lowercase atoms (`:aatid`, `:ablid`, `:abhid`, etc.). The `:ID` naming is a style inconsistency within the project and causes field-access asymmetry: `rental_period.ID` versus `vx_user_function.aatid`.

---

**B007-9** — [INFO] Entirely redundant `source:` annotation on the `:id` field that shadows the primary key

File: `lib/api_server/vx/rental_periods.ex:7`

Description: `field :id, :integer, source: :id` declares a schema field named `:id` in addition to the custom primary key `@primary_key {:ID, :id, autogenerate: true}`. The `@primary_key` macro already injects an `:ID` struct key that maps to the `id` database column. Declaring a separate field named `:id` pointing at the same column creates two Elixir-side references to the same database column — `:ID` (the PK virtual field) and the newly declared `:id` integer field. In Ecto 2.x this compiles but `:id` will behave as a plain field rather than the primary key, potentially causing incorrect behaviour with `Repo.get/3` or associations that resolve via the primary key. The identical pattern is present in `rental_contracts.ex:7` and `equipment.ex:9`.

---

## Summary Table

| ID      | Severity | Title                                                                 | File                                      |
|---------|----------|-----------------------------------------------------------------------|-------------------------------------------|
| B007-1  | HIGH     | Field name mismatch in changeset causes silent cast failure           | `lib/api_server/vx/vx_user_function.ex:16-17` |
| B007-2  | MEDIUM   | Entire controller body is commented out                               | `lib/api_server_web/controllers/vx_user_function_controller.ex:9-41` |
| B007-3  | LOW      | Large block of commented-out scheduler job entries in config          | `config/config.exs:26-104`                |
| B007-4  | LOW      | Unresolved design questions committed as comments in config           | `config/config.exs:22-24`                 |
| B007-5  | LOW      | Module name does not match file path (convention violation)           | `lib/api_server/vx/scheduler.ex:1`        |
| B007-6  | LOW      | Redundant `source:` annotations where field name equals column name   | `lib/api_server/vx/rental_periods.ex:7-14` |
| B007-7  | LOW      | 4-space indentation instead of 2-space Elixir standard                | `lib/api_server/vx/rental_periods.ex:2-20` |
| B007-8  | LOW      | Primary key atom `:ID` uses uppercase, deviating from snake_case      | `lib/api_server/vx/rental_periods.ex:5`   |
| B007-9  | INFO     | `:id` field declaration shadows the custom primary key field          | `lib/api_server/vx/rental_periods.ex:7`   |
# Pass 4 – B008

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Files reviewed:**
- `lib/api_server/vx/vx.ex` (3,314 lines)

---

## Reading Evidence

### Module Name

`ApiServer.Vx`

### Aliases Declared (at module level and inline)

| Line | Alias |
|------|-------|
| 7 | `ApiServer.Repo` |
| 8 | `ApiServer.Vx.VXUser` |
| 9 | `ApiServer.Vx.VXThingEvent` |
| 10 | `ApiServer.Vx.VXThingEventOmega` |
| 11 | `ApiServer.Vx.VXThingEventOmegaTires` |
| 12 | `ApiServer.Vx.VXFleetAssociation` |
| 13 | `ApiServer.Vx.VXRestriction` |
| 14 | `ApiServer.Vx.Geofence` |
| 15 | `ApiServer.Vx.VXThing` |
| 16 | `ApiServer.Vx.VXRental` |
| 17 | `ApiServer.Vx.VXAblRecord` |
| 18 | `ApiServer.Vx.VXRayvenMessageLog` |
| 19 | `ApiServer.Vx.VXRayvenStreamStatus` |
| 20 | `ApiServer.Vx.Equipment` |
| 21 | `ApiServer.Vx.EquipmentAssignment` |
| 22 | `ApiServer.Vx.RentalContract` |
| 23 | `ApiServer.Vx.RentalPeriod` |
| 134 | `ApiServer.Vx.VXAccessFob` (inline alias) |
| 220 | `ApiServer.Vx.VXFleet` (inline alias) |
| 1448 | `ApiServer.Vx.VXThingSummary` (inline alias) |
| 1611 | `ApiServer.Vx.VXThingEvent` (re-alias, already aliased at top) |
| 2043 | `ApiServer.Vx.VXAblRecord` (re-alias, already aliased at top) |
| 2728 | `ApiServer.Vx.VXRental` (re-alias, already aliased at top) |
| 2860 | `ApiServer.Vx.VXCustomer` (inline alias) |
| 2969 | `ApiServer.Vx.VXUserFunction` (inline alias) |
| 3187 | `ApiServer.Vx.ERPImport` (inline alias) |

### Every Function and Its Line Number

| Line | Function | Arity |
|------|----------|-------|
| 27 | `update_key_if_value/3` | (map, key_to_save, nil) — guard clause |
| 28 | `update_key_if_value/3` | (map, key_to_save, value_to_add) |
| 33 | `list_vxusers/1` | (customer) |
| 40 | `get_vx_user!/2` | (userid, customer) |
| 47 | `get_vx_user_offset/2` | (userid, customer) |
| 54 | `get_vx_user_fleets!/2` | (userid, customer) |
| 75 | `create_vx_user/2` | (attrs \\ %{}, customer) |
| 93 | `update_vx_user/3` | (%VXUser{}, attrs, customer) |
| 99 | `update_vx_user_password/3` | (%VXUser{}, attrs, customer) |
| 117 | `delete_vx_user/2` | (%VXUser{}, customer) |
| 130 | `change_vx_user/1` | (%VXUser{}) |
| 145 | `list_vxaccessfobs/0` | () |
| 163 | `get_vx_access_fob!/1` | (id) |
| 165 | `get_vx_access_fob_by_code!/1` | (fob_code) |
| 177 | `get_vx_access_fobs_for_fleets!/1` | (fleets) |
| 189 | `get_vx_fleet_for_access_fob/1` | (fobid) |
| 198 | `get_num_vx_admin_fobs/0` | () |
| 199 | `get_vx_admin_fobs/0` | () |
| 215 | `delete_vx_access_fob/1` | (%VXAccessFob{}) |
| 222 | `list_vxfleets/1` | (customer) |
| 227 | `list_vxfleets/2` | (user_id, customer) |
| 235 | `get_list_of_valid_fleets_for_user/2` | (user_id, customer) |
| 243 | `get_list_of_valid_equipment_for_user/2` | (user_id, customer) |
| 264 | `list_vxfleets_with_equipment/2` | (user_id, customer) |
| 290 | `get_vx_fleet_by_name/2` | (fleetname, customer) |
| 296 | `get_vx_fleet/2` | (id, customer) |
| 315 | `create_vx_fleet/2` | (attrs \\ %{}, customer) |
| 333 | `update_vx_fleet/3` | (%VXFleet{}, attrs, customer) |
| 351 | `delete_vx_fleet/2` | (%VXFleet{}, customer) |
| 364 | `change_vx_fleet/1` | (%VXFleet{}) |
| 378 | `update_fleet_assocs/3` | (fleet_id, customer, updated_ids) |
| 392 | `get_equipment_in_fleet/2` | (fleet_id, customer) |
| 400 | `get_hardwareids_in_fleet/2` | (fleet_id, customer) |
| 408 | `get_fleets_for_thing/2` | (thingid, customer) |
| 416 | `get_branch_for_thing/2` | (thingid, customer) |
| 427 | `list_vxfleetassociations/0` | () |
| 449 | `get_vx_fleet_association!/1` | (id) |
| 464 | `delete_vx_fleet_association/1` | (%VXFleetAssociation{}) |
| 470 | `list_vxthings/1` | (customer) |
| 478 | `list_vxthings_full/1` | (customer) |
| 492 | `list_vxthings_lite/1` | (customer) |
| 498 | `list_vxthing/2` | (customer, hardwareid) |
| 507 | `list_vxthing_full/2` | (customer, hardwareid) |
| 520 | `list_vxthing_lite/2` | (customer, hardwareid) |
| 528 | `list_vxthings/2` | (user_id, customer) |
| 539 | `list_augmented_things/2` | (user_id, customer) |
| 555 | `list_augmented_things_with_rentals/1` | (customer) |
| 568 | `list_augmented_things_with_rentals_in_fleet/3` | (customer, fleet_id, user_id) |
| 589 | `list_augmented_things_in_fleet/3` | (customer, fleet_id, user_id) |
| 608 | `list_vxthings_in_fleet/2` | (customer, fleet_id) |
| 623 | `list_vxthings_with_checklists/1` | (customer) |
| 631 | `get_lift_event_counts_for_thing_by_day/5` | (hardwareid, from_date, to_date, timezone, customer) |
| 651 | `get_detailed_lift_event_counts_for_thing_by_day/6` | (hardwareid, from_date, to_date, timezone, thing_name, customer) |
| 677 | `get_list_lift_event_counts_for_thing_by_day/6` | (hardwareid, from_date, to_date, timezone, thing_name, customer) |
| 699 | `get_detailed_lift_event_counts_for_fleet_by_day/5` | (fleetid, from_date, to_date, timezone, customer) |
| 726 | `get_omega_engine_utilization/5` | (hardwareid, to_date, from_date, timezone, customer) |
| 749 | `get_omega_operation_summary/5` | (fleetid, to_date, from_date, timezone, customer) |
| 780 | `list_vxthings_for_map/2` | (customer, user_id) — 1st clause |
| 795 | `list_vxthings_for_map/2` | (customer, fleet_id) — 2nd clause |
| 811 | `augment_thing_with_fleets/2` | (thing, customer) |
| 816 | `augment_thing_with_services/2` | (thing, customer) |
| 827 | `get_hour_meter_start_rental/2` | (thing, customer) |
| 871 | `augment_thing_with_rental_periods/2` | (thing, customer) |
| 940 | `augment_thing_with_usage/2` | (thing, customer) |
| 968 | `get_avg_weekly_hours/2` | (thing, customer) |
| 981 | `get_avg_weekly_hours/3` | (thing, customer, input) |
| 985 | `get_summary_total_usage/1` | (thing) |
| 1006 | `get_usage_since_service/2` | (thing, customer) |
| 1030 | `fetch_actual_usage/2` | (thing, customer) |
| 1042 | `generate_usage_select/2` | (query, category) |
| 1090 | `fetch_actual_usage/5` | (hardwareid, 4, customer, from, to) |
| 1133 | `fetch_actual_usage/5` | (hardwareid, 2, customer, from, to) |
| 1174 | `fetch_actual_usage/5` | (hardwareid, 3, customer, from, to) |
| 1215 | `fetch_actual_usage/5` | (hardwareid, category, customer, from, to) — fallback |
| 1230 | `fetch_actual_usage_thing/4` | (thing, customer, from, to) |
| 1235 | `get_movements/5` | (hardware_id, start_date, end_date, timezone, customer) |
| 1281 | `get_vx_thing!/1` | (id) |
| 1283 | `get_vx_thing!/2` | (id, customer) |
| 1290 | `get_thing_name_with_hardware_id!/2` | (hardwareid, customer) |
| 1296 | `get_fleet_name_with_id/2` | (id, customer) |
| 1303 | `get_thing_category_with_hardware_id!/2` | (hardwareid, customer) |
| 1311 | `get_thing_id_with_hardware_id!/2` | (hardwareid, customer) |
| 1319 | `lookup_thing_with_name_serial/3` | (name, serialno, customer) |
| 1328 | `lookup_thing_with_name/2` | (name, customer) |
| 1337 | `get_vx_thing_with_hardware_id!/1` | (hardwareid) |
| 1347 | `get_vx_thing_with_hardware_id!/2` | (hardwareid, customer) |
| 1357 | `get_augmented_thing_with_hardware_id!/2` | (hardwareid, customer) |
| 1363 | `get_equipment_by_name/2` | (name, customer) |
| 1371 | `get_equipment_by_serial/2` | (serialno, customer) |
| 1377 | `get_equipment_assignments_by_id/2` | (equipment_id, customer) |
| 1395 | `create_vx_thing/2` | (attrs \\ %{}, customer) |
| 1413 | `update_vx_thing/3` | (%VXThing{}, attrs, customer) |
| 1431 | `delete_vx_thing/1` | (%VXThing{}) |
| 1444 | `change_vx_thing/1` | (%VXThing{}) |
| 1459 | `list_vxthingsummaries/0` | () |
| 1477 | `get_vx_thing_summary!/1` | (id) |
| 1478 | `get_summary_for_hardwareid/2` | (hardwareid, customer) |
| 1484 | `update_or_insert_summary/3` | (existing_summary, attrs \\ %{}, customer) |
| 1501 | `create_vx_thing_summary/1` | (attrs \\ %{}) |
| 1519 | `update_vx_thing_summary/2` | (%VXThingSummary{}, attrs) |
| 1537 | `delete_vx_thing_summary/1` | (%VXThingSummary{}) |
| 1550 | `change_vx_thing_summary/1` | (%VXThingSummary{}) |
| 1555 | `default_checklist_questions/0` | () |
| 1586 | `get_checklists/1` | (hardwareid) |
| 1622 | `list_vxthingevents/0` | () |
| 1640 | `get_vx_thing_event!/1` | (id) |
| 1642 | `get_most_recent_thingevent/2` | (hardwareid, customer) |
| 1651 | `get_most_recent_thingevent_with_date/3` | (hardwareid, customer, date) |
| 1660 | `get_most_recent_thingevent_with_omega/2` | (hardwareid, customer) |
| 1673 | `get_thingevents_for_hardwareid/2` | (hardwareid, customer) |
| 1680 | `get_thingevents_for_hardwareid/4` | (hardwareid, from, to, customer) |
| 1702 | `create_vx_thing_event/2` | (attrs \\ %{}, customer) |
| 1720 | `update_vx_thing_event/2` | (%VXThingEvent{}, attrs) |
| 1738 | `delete_vx_thing_event/1` | (%VXThingEvent{}) |
| 1751 | `change_vx_thing_event/1` | (%VXThingEvent{}) |
| 1755 | `generate_avg_weekly_select/2` | (query, category) |
| 1795 | `convert_category_to_regular_units/2` | (category, value) |
| 1824 | `get_first_event/2` | (hardwareid, customer) |
| 1842 | `get_actual_avg_weekly_hours/3` | (hardwareid, 4, customer) |
| 1879 | `get_actual_avg_weekly_hours/4` | (hardwareid, 4, customer, _) |
| 1916 | `get_actual_avg_weekly_hours/3` | (hardwareid, 2, customer) |
| 1952 | `get_actual_avg_weekly_hours/4` | (hardwareid, 2, customer, 1) |
| 1988 | `get_actual_avg_weekly_hours/3` | (hardwareid, 3, customer) |
| 2026 | `get_actual_avg_weekly_hours/3` | (hardwareid, category, customer) — fallback |
| 2054 | `list_service_records/1` | (customer) |
| 2062 | `daily_usage_where/2` | (query, category) — private |
| 2100 | `get_daily_usage/6` | (hardwareid, category, customer, to_date, from_date, timezone) |
| 2170 | `get_impact_count_by_hardwareid/2` | (hardwareid, customer) |
| 2179 | `get_events/5` | (hardwareid, customer, to_date, from_date, timezone) |
| 2192 | `process_events/0` | () |
| 2547 | `process_events_subprocess/1` | (index) |
| 2611 | `get_vx_abl_record!/1` | (id) |
| 2625 | `create_vx_abl_record/1` | (attrs \\ %{}) |
| 2631 | `create_abl_record/2` | (attrs \\ %{}, customer) |
| 2637 | `create_equipment_record/2` | (attrs \\ %{}, customer) |
| 2643 | `get_equipment_id/2` | (customer, serial_number) |
| 2650 | `create_equipment_assignment_record/2` | (attrs \\ %{}, customer) |
| 2668 | `update_vx_abl_record/2` | (%VXAblRecord{}, attrs) |
| 2686 | `delete_vx_abl_record/1` | (%VXAblRecord{}) |
| 2699 | `change_vx_abl_record/1` | (%VXAblRecord{}) |
| 2704 | `get_rhm_user/3` | (email, password, customer) |
| 2712 | `check_password/3` | (user_id, password, customer) |
| 2719 | `get_rhm_user/2` | (email, customer) |
| 2730 | `list_all_rentals/1` | (customer) |
| 2740 | `list_open_rentals/1` | (customer) |
| 2753 | `get_rental/2` | (id, customer) |
| 2764 | `get_active_rental/2` | (thing_id, customer) |
| 2776 | `get_all_rentals_for_thing/2` | (thing_id, customer) |
| 2786 | `get_rental/4` | (thing_id, customer_id, start_date, customer) |
| 2798 | `delete_rental/2` | (%VXRental{}, customer) |
| 2802 | `update_rental/3` | (%VXRental{}, attrs, customer) |
| 2809 | `create_rental_contract/2` | (attrs \\ %{}, customer) |
| 2817 | `create_rental_period/2` | (attrs \\ %{}, customer) |
| 2825 | `get_rental_periods_for_contract/2` | (contract_id, customer) |
| 2831 | `create_rental/2` | (attrs \\ %{}, customer) |
| 2871 | `list_customers/1` | (customer) |
| 2889 | `get_vx_customer!/2` | (id, customer) |
| 2891 | `get_customer/3` | (erp_id, erp_name, customer) |
| 2916 | `create_vx_customer/2` | (attrs \\ %{}, customer) |
| 2934 | `update_vx_customer/3` | (%VXCustomer{}, attrs, customer) |
| 2952 | `delete_vx_customer/2` | (%VXCustomer{}, customer) |
| 2965 | `change_vx_customer/2` | (%VXCustomer{}, customer) |
| 2980 | `list_vxaatuserfunctions/0` | () |
| 2998 | `get_vx_user_function!/1` | (id) |
| 3012 | `create_vx_user_function/1` | (attrs \\ %{}) |
| 3030 | `update_vx_user_function/2` | (%VXUserFunction{}, attrs) |
| 3048 | `delete_vx_user_function/1` | (%VXUserFunction{}) |
| 3061 | `change_vx_user_function/1` | (%VXUserFunction{}) |
| 3074 | `list_vxaau_rest/0` | () |
| 3092 | `get_vx_restriction!/1` | (id) |
| 3106 | `create_vx_restriction/1` | (attrs \\ %{}) |
| 3112 | `add_fleet_to_user/3` | (fleet_id, user_id, customer) |
| 3124 | `get_restriction/3` | (fleet_id, user_id, customer) |
| 3132 | `remove_fleet_from_user/3` | (fleet_id, user_id, customer) |
| 3150 | `update_vx_restriction/2` | (%VXRestriction{}, attrs) |
| 3168 | `delete_vx_restriction/1` | (%VXRestriction{}) |
| 3181 | `change_vx_restriction/1` | (%VXRestriction{}) |
| 3189 | `delete_erp_import/2` | (%ERPImport{}, customer) |
| 3193 | `create_erp_import/2` | (attrs \\ %{}, customer) |
| 3199 | `update_erp_import/3` | (%ERPImport{}, attrs, customer) |
| 3205 | `check_for_existing_erp_record/2` | (raw_record, customer) |
| 3223 | `get_geofence_by_id/2` | (id, customer) |
| 3229 | `get_geofences/1` | (customer) |
| 3234 | `get_geofences_as_map/1` | (customer) |
| 3249 | `create_geofence/2` | (attrs \\ %{}, customer) |
| 3255 | `update_geofence/3` | (%Geofence{}, attrs, customer) |
| 3261 | `delete_geofence/2` | (%Geofence{}, customer) |
| 3265 | `create_thingevent_record/2` | (attrs \\ %{}, customer) |
| 3271 | `update_thingevent_record/3` | (%VXThingEvent{}, attrs, customer) |
| 3277 | `delete_thingevent_record/2` | (%VXThingEvent{}, customer) |
| 3281 | `create_thingeventomega_record/2` | (attrs \\ %{}, customer) |
| 3287 | `create_thingomegatires_record/2` | (attrs \\ %{}, customer) |
| 3293 | `create_rayven_message_log_record/2` | (attrs \\ %{}, customer) |
| 3299 | `update_rayven_stream_status_record/2` | (attrs, customer) |
| 3305 | `count_rayven_events_to_stream/3` | (hardware_id, id, customer) |

### Constants / Magic Values Noted

- Line 198: `7` — hardcoded count of admin fobs
- Line 200: raw hex string of admin fob codes
- Line 429: `"29"` — hardcoded fleet ID excluded from fleet association list
- Line 762: `6` — hardware type constant (no named constant)
- Line 762: `t.aadhw_type == 6` — repeated magic number
- Line 874–879: `"2019-01-01"`, `"2020-07-05"`, `"US/Michigan"` — hardcoded dates and timezone
- Line 950: `"+10:00"` — hardcoded timezone
- Line 1098 / 1108 / 1140 / 1150 / 1181 / 1190: `5` — hardcoded LIMIT in queries
- Lines 1661: `[3, 178, 16, 32, 193, 194]` — unexplained magic list of event type codes
- Line 2196: `"vx_cea"` — hardcoded tenant/customer string
- Line 2198: `37` — hardcoded admin user ID
- Line 2204: `49838414` — hardcoded event ID threshold
- Line 2207: `5000` — hardcoded batch size
- Line 2306: hardcoded personal email addresses
- Line 2307: hardcoded `"no-reply@mobilehourmeter.com"` sender address
- Line 2323: `"Jeremy - 4"` — hardcoded geofence name
- Lines 2357, 2417, 2477: repeated hardcoded email recipient lists
- Line 3207: `"vx_cea"` — hardcoded tenant string in match

### Types / Errors Defined

None (no `@type`, `@typep`, `defexception`, or module-level constants via `@` attributes beyond `@doc` and `@moduledoc`).

---

## Findings

---

**B008-1** — [HIGH] Plaintext password comparison stored and queried in database

File: `lib/api_server/vx/vx.ex:2704` and `lib/api_server/vx/vx.ex:2712`

Description: `get_rhm_user/3` and `check_password/3` perform authentication by issuing Ecto queries that match the raw `aacpassword` column directly against a plaintext input. This means passwords are stored in plaintext (or at most an easily reversible form) in the database and are compared in a SQL `WHERE` clause. Any DB leak or query log exposes all credentials. This is a security vulnerability, not merely a style issue.

---

**B008-2** — [HIGH] Hardcoded personal email addresses and production tenant identifier in business logic

File: `lib/api_server/vx/vx.ex:2196`, `2198`, `2204`, `2306`, `2323`, `2357`, `2417`, `2477`, `2540`

Description: `process_events/0` hard-codes the customer schema `"vx_cea"`, the admin user ID `37`, an event ID offset `49838414`, personally identifiable email addresses (`shad.wall@clarkequipment.com`, `jeremy.oska@clarkequipment.com`, `james.purdom@trackingsolutions.com.au`, `graham.oconnell@trackingsolutions.com.au`), a sender domain `no-reply@mobilehourmeter.com`, and specific geofence name strings (`"Jeremy - 4"`). These values are completely non-configurable. A tenant change, personnel change, or email infrastructure change requires a code deploy. The same customer name `"vx_cea"` also appears at line 3207 in `check_for_existing_erp_record/2`.

---

**B008-3** — [HIGH] Duplicate function body: `get_actual_avg_weekly_hours/3` (category 4) and `get_actual_avg_weekly_hours/4` (category 4, `_` ignored)

File: `lib/api_server/vx/vx.ex:1842` and `lib/api_server/vx/vx.ex:1879`

Description: `get_actual_avg_weekly_hours(hardwareid, 4, customer)` (line 1842) and `get_actual_avg_weekly_hours(hardwareid, 4, customer, _)` (line 1879) are 100% identical in body — same `get_first_event` call, same `Timex.diff` / week-calculation logic, same `fetch_actual_usage` call, same `cond` / `Float.round` return. The four-argument variant silently ignores its fourth argument and produces the same result as the three-argument variant. This is likely an oversight that can lead to incorrect results when callers pass a meaningful `input` value expecting different behaviour, and it creates dead weight that will diverge over time.

---

**B008-4** — [MEDIUM] Large block of commented-out code — `process_events/0` geofence email sending

File: `lib/api_server/vx/vx.ex:2309–2310`, `2360–2361`, `2420–2421`, `2480–2481`, `2543–2544`

Description: Multiple send-email call pairs throughout `process_events/0` are commented out:
- Lines 2309–2310: exit email to `shad.wall` list commented out while `graham.oconnell` line at 2328–2329 is live.
- Lines 2360–2361: entry email commented out.
- Lines 2420–2421: entry email commented out.
- Lines 2480–2481: entry email commented out.
- Lines 2543–2544: summary diff-alert email commented out.
Commented-out send calls are interleaved with live sends, making it impossible to understand the intended notification logic from reading the code. Dead commented-out code should be removed from version control.

---

**B008-5** — [MEDIUM] Commented-out code — `augment_thing_with_rental_periods` hardcoded dates and disabled logic

File: `lib/api_server/vx/vx.ex:871–937`

Description: `augment_thing_with_rental_periods/2` contains:
- Lines 874–879: hardcoded `from_date = "2019-01-01"` and `to_date = "2020-07-05"` and `user_timezone = "US/Michigan"` — these are obviously stale (past) test values that are never overridden.
- Lines 904–919: a large block of commented-out map keys (JSON structure) that was part of the return value.

The function can never return meaningful current data because the date range is static and years in the past. The function appears to be abandoned development work left in the codebase.

---

**B008-6** — [MEDIUM] Commented-out code — `get_avg_weekly_hours/2` disabled branch

File: `lib/api_server/vx/vx.ex:970–976`

Description: The first branch of the `cond` in `get_avg_weekly_hours/2` is entirely commented out (lines 970–975), leaving only a `true ->` catch-all. The `cond` is therefore pointless; the function always falls through to `get_actual_avg_weekly_hours/3`. The commented branch suggests an alternative path reading from `thing.info.averageweeklyusage` that was abandoned. This should either be restored or the `cond` collapsed to a direct call.

---

**B008-7** — [MEDIUM] Commented-out code — `get_hour_meter_start_rental/2` disabled query clause

File: `lib/api_server/vx/vx.ex:836`, `841`

Description: Inside `get_hour_meter_start_rental/2` two query filter lines are commented out:
- Line 836: `# |> Ecto.Query.where([te], not te.id in ^sent_events )`
- Line 841: `# Select events from database where date >= startdate`
The `inList` / `sent_events` variable this filter referenced is never declared, meaning if uncommented the code would not compile. These stale comments indicate abandoned filtering logic.

---

**B008-8** — [MEDIUM] Commented-out code — `create_rental/2` Rayven sync block

File: `lib/api_server/vx/vx.ex:2834–2853`

Description: `create_rental/2` contains a 20-line block of commented-out code building a Poison-encoded body and calling `ApiServerWeb.UtilityController.send_to_rayven`. The comment at line 2832 acknowledges the intent but no live implementation exists. The large dead block misleads maintainers into thinking Rayven sync for rental creation is handled here.

---

**B008-9** — [MEDIUM] Commented-out code — `get_daily_usage/6` Omega category select field

File: `lib/api_server/vx/vx.ex:2124`

Description: Inside the `category 4` branch of `get_daily_usage/6`, line 2124 comments out the `input2totalseconds` fragment while all surrounding inputs are present:
`# fragment("(? - ?)/3600", max(field(te , :input2totalseconds)), min(field(te , :input2totalseconds))),`
This causes the returned tuple to have a different arity for category 4 versus all other categories, which will break downstream pattern-matching on the result unless callers already account for this. If intentional, there is no explanation.

---

**B008-10** — [MEDIUM] Commented-out code — `get_daily_usage/6` inner query clauses

File: `lib/api_server/vx/vx.ex:2104`, `2106`

Description: Two lines inside `get_daily_usage/6` are commented out:
- Line 2104: `# category = get_thing_category_with_hardware_id!(hardwareid, customer)` — dynamic category lookup was replaced by the caller-supplied argument, but left as a comment implying uncertainty about the design.
- Line 2106: `# There should be a category 4 here that selects from the thingomega table.` — this comment is a TODO/design note that was never cleaned up; category 4 handling does now exist in the same function, so the note is stale.

---

**B008-11** — [MEDIUM] Commented-out code — `process_events_subprocess/1` query filters

File: `lib/api_server/vx/vx.ex:2555–2558`

Description: Inside `process_events_subprocess/1`, four consecutive query clauses are commented out:
```
# |> Ecto.Query.where([te], is_nil(te.geofence))
# |> Ecto.Query.where([te], te.hardwareid == 47371 )
# |> Ecto.Query.select()
# |> Ecto.Query.order_by(asc: :gmtdatetime)
```
Without `is_nil(te.geofence)`, the subprocess re-processes all events including already-processed ones, which is incorrect. The function's own comment on line 2548 states "I don't think this is used anymore," confirming this is dead code.

---

**B008-12** — [MEDIUM] Dead function: `process_events_subprocess/1` acknowledged as unused

File: `lib/api_server/vx/vx.ex:2547`

Description: The inline comment at line 2548 reads `# I don't think this is used anymore.` The function has no `@doc`, its query is broken (all filters commented out — see B008-11), and it hardcodes the same `"vx_cea"` customer and `user_id = 37` as `process_events/0`. It should be removed.

---

**B008-13** — [MEDIUM] Dead function: `get_checklists/1` returns stub data ignoring its argument

File: `lib/api_server/vx/vx.ex:1586`

Description: `get_checklists/1` accepts `hardwareid` but completely ignores it. It returns a static list of four hardcoded structs with `DateTime.utc_now()` timestamps and canned boolean answer arrays. This is clearly stub/mock data that was never replaced with a real database query. The function is also not private, exposing a fake public API.

---

**B008-14** — [MEDIUM] Ambiguous clause pair `list_vxthings_for_map/2` — both match any two arguments

File: `lib/api_server/vx/vx.ex:780` and `lib/api_server/vx/vx.ex:795`

Description: Both clauses of `list_vxthings_for_map/2` accept `(customer, user_id)` and `(customer, fleet_id)` respectively. Since both parameters are untyped atoms/integers at runtime, Elixir will always dispatch to the first clause (line 780) regardless of whether the caller intends `user_id` or `fleet_id`. The second clause (line 795) is therefore unreachable by normal dispatch. The two query strategies are logically different (user-scoped vs. fleet-scoped), and the function should be split into two distinctly named functions.

---

**B008-15** — [MEDIUM] Massive copy-paste duplication in `get_actual_avg_weekly_hours` family

File: `lib/api_server/vx/vx.ex:1842–2041`

Description: Five separate clauses of `get_actual_avg_weekly_hours` (lines 1842, 1879, 1916, 1952, 1988) each repeat the identical pattern:
1. `get_first_event`
2. `Timex.diff(now, first_event, :days)`
3. Same `cond` computing `start_of_year` with identical branch conditions and day thresholds (28 days)
4. Same week-count arithmetic using `div` and `rem`
5. A `fetch_actual_usage` call (varying only the category arg)
6. Identical `cond` with `Float.round`

The only meaningful variation is the `fetch_actual_usage` category. All this logic should be in a single private helper; the current structure creates ~150 lines of duplicated code where a single 20-line function parameterised by category would suffice. Any bug fix or change to the 28-day window must be applied in five places.

---

**B008-16** — [MEDIUM] Copy-paste duplication in `fetch_actual_usage` clauses for categories 2, 3, and 4

File: `lib/api_server/vx/vx.ex:1090–1213`

Description: The three pattern-matched `fetch_actual_usage/5` clauses (categories 4, 2, and 3) each repeat the same six-step pattern:
1. Build `desc_ids` — top-5 event IDs ordered descending
2. Build `asc_ids` — top-5 event IDs ordered ascending
3. Query `min` from the ascending set
4. Query `max` from the descending set
5. `cond` on nil-ness
6. Return `max - min` (possibly `/3600`)

The only differences are the event table (VXThingEventOmega vs. VXThingEvent), the field name, and the unit divisor. This represents ~120 lines of near-identical code. A private helper parameterised by table/field/divisor would eliminate the duplication.

---

**B008-17** — [MEDIUM] Bound-but-unused variables without `_` prefix

File: `lib/api_server/vx/vx.ex` — multiple locations

Description: Several variables are bound but never subsequently used, which produces Elixir compiler warnings:

- Line 2197: `inList = []` — never used in `process_events/0`.
- Line 2199: `user_timezone = get_vx_user_offset(user_id, customer)` — never used in `process_events/0`.
- Line 2519: `diff = Timex.diff(new_time, current_time, :milliseconds)` — computed inside the `Enum.each` block but never used.
- Line 2550: `inList = []` — never used in `process_events_subprocess/1`.
- Line 2552: `user_timezone = get_vx_user_offset(user_id, customer)` — never used in `process_events_subprocess/1`.
- Line 2592: `diff = Timex.diff(new_time, current_time, :milliseconds)` — computed but never used.
- Line 623: `results` is assigned from the query pipeline but the function body ends immediately; the variable is the implicit return value (which may be intentional), however the assignment name `results` is misleading if the intent is to return the mapped list — the last pipeline step is `Enum.map` but is bound to `results` then immediately returned.

Each unused binding without an `_` prefix generates an Elixir compiler warning.

---

**B008-18** — [MEDIUM] Re-aliasing already-aliased modules mid-file

File: `lib/api_server/vx/vx.ex:1611`, `2043`, `2728`

Description: Three modules already aliased at the top of the file are re-aliased inline mid-file with redundant `alias` statements:
- Line 1611: `alias ApiServer.Vx.VXThingEvent` — already aliased at line 9.
- Line 2043: `alias ApiServer.Vx.VXAblRecord` — already aliased at line 17.
- Line 2728: `alias ApiServer.Vx.VXRental` — already aliased at line 16.

In Elixir this is harmless but generates no warning; it creates visual noise and implies the module was not already in scope, potentially confusing maintainers about what is imported where.

---

**B008-19** — [MEDIUM] Magic numbers used for equipment category codes throughout without named constants

File: `lib/api_server/vx/vx.ex` — pervasive

Description: Numeric category codes appear in at least 10 functions (`generate_usage_select/2`, `generate_avg_weekly_select/2`, `convert_category_to_regular_units/2`, `daily_usage_where/2`, `get_actual_avg_weekly_hours`, `fetch_actual_usage`, `get_summary_total_usage`, `get_daily_usage/6`) without any module-level constant or type alias. The same integer appears with different comments across different functions (e.g., `2` is "Input 0" in some and "Engine seconds" in others; `4` is "Omega"; `5` is "J1939"). Notable instances:
- Categories 2, 3, 4, 5, 6, 7, 8, 9 each appear across 5+ functions
- Event type codes 3, 16, 32, 178, 177, 183, 193, 194 are repeated inline across many queries
- Hardware type `6` at line 762 appears without explanation
- Limit `5` at lines 1098, 1108, 1140, 1150, 1181, 1190 (why 5 events for min/max?)
- `28` day look-back window repeated in five `get_actual_avg_weekly_hours` clauses

The absence of named constants means any change to a category code or event type must be tracked down manually across hundreds of lines.

---

**B008-20** — [MEDIUM] `generate_usage_select/2` uses category codes 12–14 but `generate_avg_weekly_select/2` uses 2–9 — inconsistent fallback numbering scheme

File: `lib/api_server/vx/vx.ex:1042` vs `lib/api_server/vx/vx.ex:1755`

Description: `generate_usage_select/2` handles categories 12, 13, 14 as "fallback" variants of 2, 3, 4 respectively (offset by 10), while `generate_avg_weekly_select/2` handles only 2–9 with no fallback codes. The "category + 10 = fallback" convention is nowhere documented or enforced. The caller at line 1127 passes `14` as a fallback for category 4, and line 1168 passes `12` as a fallback for category 2. This implicit encoding is opaque and fragile.

---

**B008-21** — [LOW] Inconsistent `@doc` coverage — majority of public functions lack documentation

File: `lib/api_server/vx/vx.ex` — pervasive

Description: Approximately 30 functions have `@doc` blocks (mostly the boilerplate CRUD functions generated by Phoenix), while at least 80 public functions have no `@doc` at all. Functions of significant complexity with no documentation include: `augment_thing_with_rental_periods/2`, `fetch_actual_usage/5` (all clauses), `generate_usage_select/2`, `get_actual_avg_weekly_hours` (all clauses), `get_daily_usage/6`, `process_events/0`, `check_password/3`, `get_rhm_user/2`, `get_rhm_user/3`, `get_checklists/1`, and many others. The selective use of `@doc` on simple CRUD functions while omitting it from complex domain logic is inverted from best practice.

---

**B008-22** — [LOW] Inconsistent bang (`!`) naming convention

File: `lib/api_server/vx/vx.ex` — multiple locations

Description: Bang suffix (`!`) in Elixir conventionally means the function raises on failure rather than returning `{:error, reason}`. Several functions break this convention:
- `get_vx_user!/2` (line 40) uses `Repo.one` (non-raising) instead of `Repo.one!`, so it does not actually raise.
- `get_vx_thing_with_hardware_id!/1` (line 1337) and `/2` (line 1347) use `Repo.one` (non-raising).
- `get_thing_name_with_hardware_id!/2` (line 1290) uses `Repo.one` (non-raising).
- `get_thing_category_with_hardware_id!/2` (line 1303) uses `Repo.one` (non-raising).
- `get_thing_id_with_hardware_id!/2` (line 1311) uses `Repo.one` (non-raising).
- `get_vx_access_fob_by_code!/1` (line 165) uses `Repo.one` (non-raising) — but is named with `!`.

Conversely `get_vx_user!/2` misleads callers into not handling `nil` returns that will in fact occur. This is a latent crash risk: pattern-matching callers that assume a struct will crash with a `MatchError` on nil rather than a descriptive `Ecto.NoResultsError`.

---

**B008-23** — [LOW] Inconsistent indentation style across similar query pipelines

File: `lib/api_server/vx/vx.ex` — pervasive

Description: Query pipelines vary arbitrarily between 2-space, 4-space, and 6-space indentation within the same file, and the position of `|>` operators is sometimes aligned under the module alias and sometimes further indented. Examples:
- Lines 33–38: 4-space indent.
- Lines 40–45: 8-space indent (double).
- Lines 780–808 (`list_vxthings_for_map`): 6-space indent.
- Lines 589–601 (`list_augmented_things_in_fleet`): 4-space indent.
- Lines 1680–1687 (`get_thingevents_for_hardwareid/4`): 2-space indent (at the module top level, not indented inside the function at all).

This does not affect runtime behaviour but makes the file visually inconsistent and harder to read.

---

**B008-24** — [LOW] `list_vxfleetassociations/0` hardcodes fleet ID `"29"` as exclusion filter

File: `lib/api_server/vx/vx.ex:429`

Description:
```elixir
|> Ecto.Query.where([r], r.aafgroupid != ^"29")
```
Fleet ID `29` is excluded from the general fleet association listing with no comment explaining why. This is a magic constant that silently hides data for one specific fleet. If fleet 29 is a special system fleet, that should be documented and the ID extracted to a named constant or configuration value.

---

**B008-25** — [LOW] `get_vx_admin_fobs/0` returns a raw hex string with no parsing or validation

File: `lib/api_server/vx/vx.ex:199–201`

Description:
```elixir
def get_num_vx_admin_fobs(), do: 7
def get_vx_admin_fobs() do
  "000019333303000019333AEA000019330E4E0000193354AC00001933382D00001932FCA800001933001A"
end
```
The function returns a single concatenated 80-character hex string representing 7 fob codes (7 × ~11 chars). There is no parsing, splitting, or validation. The companion `get_num_vx_admin_fobs/0` returning `7` as a separate function rather than deriving the count from the list is fragile — these two values can silently diverge. Any addition of an 8th admin fob requires editing both functions correctly.

---

**B008-26** — [LOW] `daily_usage_where/2` is `defp` but `generate_usage_select/2` and `generate_avg_weekly_select/2` are `def`

File: `lib/api_server/vx/vx.ex:1042`, `1755`, `2062`

Description: `daily_usage_where/2` is correctly marked private (`defp`) at line 2062 because it is only used internally. However, `generate_usage_select/2` (line 1042) and `generate_avg_weekly_select/2` (line 1755) are public `def` despite being internal query-building helpers with no plausible external caller. They should be `defp` to reduce the public API surface.

---

**B008-27** — [LOW] `get_vx_user!/2` misleadingly named — does not use `Repo.one!`

File: `lib/api_server/vx/vx.ex:40`

Description: Noted in B008-22 as part of the broader naming inconsistency, this specific function deserves individual attention because it calls `Repo.one` (which returns `nil` on no result) rather than the bang variant `Repo.one!` (which raises `Ecto.NoResultsError`). The function's `@doc` is absent, and callers relying on the `!` convention for crash-on-absence guarantees will receive `nil` and likely crash elsewhere with a less informative error.

---

## Summary Table

| ID | Severity | Title |
|----|----------|-------|
| B008-1 | HIGH | Plaintext password comparison in database queries |
| B008-2 | HIGH | Hardcoded personal emails, tenant IDs, and production constants in business logic |
| B008-3 | HIGH | Duplicate identical function body: `get_actual_avg_weekly_hours/4` (cat 4) ignores input arg |
| B008-4 | MEDIUM | Large commented-out email sends interleaved with live sends in `process_events/0` |
| B008-5 | MEDIUM | `augment_thing_with_rental_periods/2` has hardcoded past dates and commented-out return fields |
| B008-6 | MEDIUM | Commented-out cond branch in `get_avg_weekly_hours/2` renders cond pointless |
| B008-7 | MEDIUM | Commented-out query clauses in `get_hour_meter_start_rental/2` referencing undefined variable |
| B008-8 | MEDIUM | 20-line commented-out Rayven sync block in `create_rental/2` |
| B008-9 | MEDIUM | Commented-out select field causes result tuple arity mismatch for category 4 in `get_daily_usage/6` |
| B008-10 | MEDIUM | Stale TODO comment in `get_daily_usage/6` after the addressed code already exists |
| B008-11 | MEDIUM | All meaningful query filters commented out in `process_events_subprocess/1` |
| B008-12 | MEDIUM | `process_events_subprocess/1` acknowledged as dead code by inline comment |
| B008-13 | MEDIUM | `get_checklists/1` ignores its argument and returns hardcoded stub data |
| B008-14 | MEDIUM | `list_vxthings_for_map/2` second clause unreachable due to indistinguishable argument types |
| B008-15 | MEDIUM | ~150 lines of copy-paste duplication across five `get_actual_avg_weekly_hours` clauses |
| B008-16 | MEDIUM | ~120 lines of copy-paste duplication across three `fetch_actual_usage/5` clauses |
| B008-17 | MEDIUM | Bound-but-unused variables (no `_` prefix) generating compiler warnings in 6+ locations |
| B008-18 | MEDIUM | Three modules re-aliased mid-file despite being aliased at module top |
| B008-19 | MEDIUM | Pervasive magic numbers for category codes and event types across 10+ functions |
| B008-20 | MEDIUM | Inconsistent category numbering: `generate_usage_select` uses 12–14 fallbacks; `generate_avg_weekly_select` does not |
| B008-21 | LOW | ~80 public functions lack `@doc`; documentation is inverted (simple CRUD documented, complex logic undocumented) |
| B008-22 | LOW | Bang (`!`) naming applied to 6+ functions that use non-raising `Repo.one` |
| B008-23 | LOW | Inconsistent indentation (2/4/6/8 spaces) across query pipelines |
| B008-24 | LOW | Magic constant `"29"` hardcoded fleet exclusion in `list_vxfleetassociations/0` |
| B008-25 | LOW | `get_vx_admin_fobs/0` and `get_num_vx_admin_fobs/0` are fragile parallel constants with no parsing |
| B008-26 | LOW | Internal query-builder helpers `generate_usage_select/2` and `generate_avg_weekly_select/2` should be `defp` |
| B008-27 | LOW | `get_vx_user!/2` uses `Repo.one` (non-raising) despite `!` suffix |
# Pass 4 – B009

Date: 2026-02-27
Audit run: 2026-02-27-01
Files reviewed:
- lib/api_server/vx/vx_abl_record.ex
- lib/api_server/vx/vx_access_fob.ex
- lib/api_server/vx/vx_customer.ex
- lib/api_server/vx/vx_fleet.ex

---

## Reading Evidence

### lib/api_server/vx/vx_abl_record.ex

**Module:** `ApiServer.Vx.VXAblRecord`

**Schema:** `"abl_data_changes"` — primary key `:ablid`

**Functions:**

| Line | Name | Arity |
|------|------|-------|
| 25 | `changeset/2` | `(vx_abl_record, attrs)` |
| 31 | `generate_service/10` | `(user, import_hour_meter, performed_by, thing, existing_service_date, new_service_date, current_hour_meter, input_one_hour_meter, usage, customer)` |
| 54 | `clean_xml_value/1` | `(value)` |
| 63 | `clean_xml_number_value/1` | `(value)` |
| 72 | `expand_xml_to_struct/1` | `(abl_record)` |

**Fields defined in schema:**
`:ablid` (PK), `:abldatetime`, `:ablcustcode`, `:abluser`, `:abllogtype`, `:ablusragnt`, `:ablip_address`, `:abltable`, `:ablaction`, `:ablimagetype`, `:ablimage`, `:ablprocessed`

**Associations:** `belongs_to :user, ApiServer.Vx.VXUser` (via `:abluser` / `:aacuser`, `define_field: false`)

**Aliases:** `ApiServer.Vx`

---

### lib/api_server/vx/vx_access_fob.ex

**Module:** `ApiServer.Vx.VXAccessFob`

**Schema:** `"access_fobs"` — default primary key (`:id`)

**Functions:** None defined in this module.

**Fields defined in schema:**
`:id` (implicit PK), `:fob_code`

**Associations:** `belongs_to :user, ApiServer.Vx.VXUser` (via `:assigned_to_user` / `:aacid`)

**Top-level requires (outside defmodule):** `Ecto.Query` (line 1), `Ecto.Adapters.SQL` (line 2)

---

### lib/api_server/vx/vx_customer.ex

**Module:** `ApiServer.Vx.VXCustomer`

**Schema:** `"aaa_customers"` — primary key `:aaaid`

**Functions:**

| Line | Name | Arity |
|------|------|-------|
| 25 | `convert_json_to_changeset/1` | `(customer_json)` |
| 43 | `changeset/2` | `(vx_customer, attrs)` |

**Fields defined in schema:**
`:aaaid` (PK), `:aaaaddr1`, `:aaaaddr2`, `:aaaaddr3`, `:aaacolour`, `:aaaname`, `:aaapcode`, `:aaaprimcont`, `:aaaprimemail`, `:aaaprimtel`, `:aaatz`, `:aaaudfcustcode`, `:aaacustcode`

**Associations:** `belongs_to :rental, ApiServer.Vx.VXRental` (`primary_key: true`, `define_field: false`)

**Aliases:** `ApiServer.Vx`

---

### lib/api_server/vx/vx_fleet.ex

**Module:** `ApiServer.Vx.VXFleet`

**Schema:** `"aae_group"` — primary key `:aaeid`

**Functions:**

| Line | Name | Arity |
|------|------|-------|
| 19 | `convert_json_to_changeset/1` | `(fleet_json)` |
| 27 | `changeset/2` | `(fleet, attrs)` |

**Fields defined in schema:**
`:aaeid` (PK), `:aaecustcode`, `:aaedesc`, `:aaecolour`, `:aaetype`, `:aaeshowfilter`

**Associations:** `has_many :fleet_thing_joins, ApiServer.Vx.VXFleetAssociation`

**Aliases:** `ApiServer.Vx`

---

## Findings

---

**B009-1** — [LOW] Unused `require` directives in schema module

File: lib/api_server/vx/vx_access_fob.ex:1-2

Description: `require Ecto.Query` and `require Ecto.Adapters.SQL` appear at the top level of the file, before `defmodule`, but neither macro is used anywhere in the module. These require calls produce compiler warnings ("Ecto.Query is not a behaviour, cannot be required"). They are boilerplate copy-paste artefacts carried over from other schema files (e.g., `vx_thing.ex`, `vx_fleet_association.ex`) that also carry this pattern despite not using these macros directly. Unused requires add noise to compilation output and mislead readers into believing raw SQL or query macros are employed in the schema.

---

**B009-2** — [MEDIUM] `clean_xml_number_value/1` defined in schema module but never called from it — duplicate of view helper

File: lib/api_server/vx/vx_abl_record.ex:63-70

Description: `clean_xml_number_value/1` is defined in `ApiServer.Vx.VXAblRecord` but is not referenced anywhere in the codebase from the model layer. An identical function is independently defined in `ApiServerWeb.VXAblRecordView` (lib/api_server_web/views/vx_abl_record_view.ex:37-44). The model-layer copy is dead code. The duplication means bug fixes or behaviour changes must be applied in two places. The function's presence in the schema module also constitutes a leaky abstraction — presentation-layer utility logic (nil-to-zero coercion for display) has leaked into a persistence module.

---

**B009-3** — [MEDIUM] `clean_xml_value/1` duplicated between schema module and view module

File: lib/api_server/vx/vx_abl_record.ex:54-61 (and lib/api_server_web/views/vx_abl_record_view.ex:28-35)

Description: `clean_xml_value/1` is defined identically in both `ApiServer.Vx.VXAblRecord` and `ApiServerWeb.VXAblRecordView`. The schema module's copy is used internally within `expand_xml_to_struct/1`, while the view module's copy is used by the view. There is no shared helper module; the duplication means logic for treating `%{}` (XmlToMap's representation of an empty XML element) as `nil` must be maintained in two places. This is a leaky abstraction — the XML parsing quirk of `XmlToMap.naive_map/1` is embedded and duplicated across layers rather than isolated in one place.

---

**B009-4** — [MEDIUM] Dead branch in `expand_xml_to_struct/1` — both arms of `if` return identical value

File: lib/api_server/vx/vx_abl_record.ex:80-84

Description: Inside the `{value, _}` clause of the `case Integer.parse(...)` block, the code reads:

```elixir
if length(Integer.digits(value)) >= 10 do
  value
else
  value
end
```

Both the `if` branch and the `else` branch return `value` unchanged. The condition (`>= 10`) is never acted upon. This is dead/unreachable logic — the intent was presumably to differentiate between hardware IDs with 10 or more digits and shorter ones (e.g., treating long IDs differently), but the implementation was never completed. This constitutes dead code and a latent correctness bug if the distinction was intended to produce different outputs.

---

**B009-5** — [LOW] `generate_service/10` defined in schema module — business logic leaks into schema layer

File: lib/api_server/vx/vx_abl_record.ex:31-52

Description: `generate_service/10` is not called from any module in the codebase (confirmed by search — no call site other than the definition exists). The function contains business logic: it constructs an XML document, assembles a changeset map, and calls `Vx.create_abl_record/2`. Placing this orchestration function in the Ecto schema module violates the separation between persistence schema and business/context logic. The function is also a dead-code candidate if the service record flow was migrated to `ApiServerWeb.VXAblRecordController.generate_service_record/3` (lib/api_server_web/controllers/vx_abl_record_controller.ex:66). The controller function appears to cover the same concern without calling this schema-layer version.

---

**B009-6** — [LOW] `ablcustcode` field defined in schema but excluded from `changeset/2` cast list

File: lib/api_server/vx/vx_abl_record.ex:10, 27

Description: The schema defines `:ablcustcode` as a field, but the `changeset/2` function's cast list omits it:

```elixir
|> cast(attrs, [:abldatetime,:abluser,:abllogtype,:ablusragnt,:ablip_address,:abltable,
                :ablaction,:ablimagetype,:ablimage,:ablprocessed])
```

The field is written directly via raw map literals in callers (e.g., `utility_controller.ex:5590`, `5642`, `6008`), bypassing the changeset. This is inconsistent — other fields written by the same callers are also in the cast list. The exclusion means `:ablcustcode` can never be set or validated through the changeset path, and any future attempt to use the changeset to set this field will silently drop the value.

---

**B009-7** — [MEDIUM] `VXCustomer.changeset/2` called with 3 arguments at one call site

File: lib/api_server/vx/vx.ex:2966 (caller); lib/api_server/vx/vx_customer.ex:43 (definition)

Description: `VXCustomer.changeset/2` is defined with exactly two parameters: `(vx_customer, attrs)`. However, `vx.ex:2966` calls it as:

```elixir
VXCustomer.changeset(vx_customer, %{}, prefix: customer)
```

This passes a third argument (a keyword list `[prefix: customer]`) that the function signature does not accept. In Elixir this results in a `FunctionClauseError` at runtime (no matching clause for arity 3). This is a latent runtime crash bug on any code path that calls `change_vx_customer/2`. The compiler does not catch arity mismatches on non-anonymous function calls at compile time when they are in separate modules.

---

**B009-8** — [LOW] `cond do ... true ->` used where `if/else` or simple `case` would be clearer

File: lib/api_server/vx/vx_abl_record.ex:55-60, 64-69

Description: `clean_xml_value/1` and `clean_xml_number_value/1` both use `cond do` with only two branches, the second of which is the unconditional `true ->` catch-all. The idiomatic Elixir form for a two-branch conditional is `if/else` or a two-clause function with pattern matching. Using `cond` for binary conditions is a style inconsistency vs. the rest of the codebase and adds cognitive overhead. This pattern is also duplicated in `VXAblRecordView` (lines 29-34 and 38-43), amplifying the inconsistency.

---

**B009-9** — [LOW] `aaacustcode` generated by reversing the customer name — likely incorrect business logic

File: lib/api_server/vx/vx_customer.ex:36

Description: The customer code is generated as:

```elixir
String.upcase(String.slice(String.replace(String.reverse(customer_json["name"]), " ", ""), 0..8))
```

This reverses the customer name string before removing spaces and taking the first 9 characters. For example, a customer named `"Acme Corp"` becomes `"PROC"` + first chars of reversed-no-spaces string `"PROCEMCA"` → `"PROCEMCA"` (9 chars). The reversal is almost certainly unintentional — a typical short-code derivation takes characters from the start of the name, not the end. If intentional it is entirely undocumented. The nested one-liner is also difficult to read and test. This constitutes either a logic bug or a documentation gap, and in either case is a code quality concern.

---

**B009-10** — [INFO] `VXAccessFob` schema module defines no changeset function

File: lib/api_server/vx/vx_access_fob.ex:4-11

Description: Unlike all other schema modules in the `vx/` subdirectory (`VXAblRecord`, `VXCustomer`, `VXFleet`, `VXUser`, `VXThing`), `VXAccessFob` defines no `changeset/2` function. The context module (`vx.ex`) performs deletes and reads of access fobs but no inserts or updates through a changeset, suggesting fob records are managed externally. This is not necessarily a defect, but the asymmetry with every other schema module in the directory is worth noting for future maintainability.

---

**B009-11** — [LOW] Inconsistent indentation style: `VXAccessFob` uses 4-space indentation; `VXCustomer` and `VXFleet` use 2-space

File: lib/api_server/vx/vx_access_fob.ex (4-space); lib/api_server/vx/vx_customer.ex and lib/api_server/vx/vx_fleet.ex (2-space)

Description: `vx_access_fob.ex` uses 4-space indentation throughout the module body (lines 5-10), while `vx_customer.ex` and `vx_fleet.ex` use 2-space indentation, which is the Elixir community standard enforced by `mix format`. The inconsistency suggests `vx_access_fob.ex` has never been passed through `mix format`. While purely cosmetic, it signals the file may also be out of compliance with other formatter rules.

---

## Summary Table

| ID | Severity | Title | File | Line(s) |
|----|----------|-------|------|---------|
| B009-1 | LOW | Unused `require` directives in schema module | vx_access_fob.ex | 1-2 |
| B009-2 | MEDIUM | `clean_xml_number_value/1` dead in model layer — duplicate of view helper | vx_abl_record.ex | 63-70 |
| B009-3 | MEDIUM | `clean_xml_value/1` duplicated between schema and view modules | vx_abl_record.ex | 54-61 |
| B009-4 | MEDIUM | Dead branch — both `if`/`else` arms return same value in `expand_xml_to_struct/1` | vx_abl_record.ex | 80-84 |
| B009-5 | LOW | `generate_service/10` is dead code and business logic in schema module | vx_abl_record.ex | 31-52 |
| B009-6 | LOW | `:ablcustcode` schema field excluded from `changeset/2` cast list | vx_abl_record.ex | 10, 27 |
| B009-7 | MEDIUM | `VXCustomer.changeset/2` called with 3 args — latent runtime crash | vx_customer.ex | 43 (caller: vx.ex:2966) |
| B009-8 | LOW | `cond do` used for binary conditions — `if/else` is idiomatic | vx_abl_record.ex | 55-60, 64-69 |
| B009-9 | LOW | Customer code generated by reversing name — likely incorrect logic | vx_customer.ex | 36 |
| B009-10 | INFO | `VXAccessFob` is only schema module without a `changeset/2` function | vx_access_fob.ex | 4-11 |
| B009-11 | LOW | 4-space indentation in `vx_access_fob.ex` vs 2-space in all other files | vx_access_fob.ex | 5-10 |
# Pass 4 – B010

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Auditor:** B010

**Files reviewed:**
- `lib/api_server/vx/vx_fleet_association.ex`
- `lib/api_server/vx/vx_rayven_message_log.ex`
- `lib/api_server/vx/vx_rayven_stream_status.ex`
- `lib/api_server/vx/vx_rental.ex`

---

## Reading Evidence

### File 1: `lib/api_server/vx/vx_fleet_association.ex`

**Module:** `ApiServer.Vx.VXFleetAssociation`

**Functions defined:**
- *(none — schema-only module)*

**Schema:** `aaf_groups_things`
**Primary key:** `{:aafid, :id, autogenerate: true}`

**Fields:**
- `:aafcustcode` — `:string`
- `:fleet` — `belongs_to ApiServer.Vx.VXFleet` (FK `:aafgroupid`, ref `:aaeid`)
- `:thing` — `belongs_to ApiServer.Vx.VXThing` (FK `:aafthingid`, ref `:aadid`)

**Top-level directives (outside `defmodule`):**
- `require Ecto.Query` (line 1)
- `require Ecto.Adapters.SQL` (line 2)

---

### File 2: `lib/api_server/vx/vx_rayven_message_log.ex`

**Module:** `ApiServer.Vx.VXRayvenMessageLog`

**Functions defined:**
| Function | Line |
|---|---|
| `changeset/2` | 16 |

**Schema:** `rayven_message_log`
**Primary key:** `{:message_id, :id, autogenerate: true}`

**Fields:**
- `:message_direction` — `:string`
- `:message_type` — `:string`
- `:hardware_id` — `:integer`
- `:event_id` — `:integer`
- `:response` — `:string`
- `:message` — `:string`
- `:created` — `:utc_datetime`

**`changeset/2` casts:** `:message_direction`, `:message_type`, `:hardware_id`, `:event_id`, `:response`, `:message`
*(Note: `:created` is NOT cast)*

---

### File 3: `lib/api_server/vx/vx_rayven_stream_status.ex`

**Module:** `ApiServer.Vx.VXRayvenStreamStatus`

**Functions defined:**
| Function | Line |
|---|---|
| `changeset/2` | 17 |

**Schema:** `rayven_stream_status`
**Primary key:** `{:id, :id, autogenerate: true}`

**Fields:**
- `:thing_id` — `:integer`
- `:hardware_id` — `:integer`
- `:last_event` — `:integer`
- `:last_event_time` — `:utc_datetime`
- `:streamed_at` — `:utc_datetime`
- `:delay` — `:integer`
- `:num_remaining` — `:integer`
- `:batch` — `:integer`

**`changeset/2` casts:** all eight fields above

---

### File 4: `lib/api_server/vx/vx_rental.ex`

**Module:** `ApiServer.Vx.VXRental`

**Functions defined:**
| Function | Visibility | Line |
|---|---|---|
| `get_all_anniversaries_between_dates/4` | public | 24 |
| `get_all_subsequent_anniversaries/5` | private | 77 |
| `get_current_rental_period_start/2` | public | 112 |
| `calculate_period_end_date/3` | public | 119 |
| `has_anniversary_on_day?/3` | public | 146 |
| `changeset/2` | public | 158 |
| `generate_next_period_anniversay/3` | private | 176 |
| `generate_previous_period_anniversay/3` | public | 246 |
| `calculate_period_start_date/3` | private | 468 |

**Schema:** `abh_rentals`
**Primary key:** `{:abhid, :id, autogenerate: true}`

**Fields:**
- `:abhcustcode` — `:string`
- `:abhclient` — `:string`
- `:abhstartdate` — `:date`
- `:abhenddate` — `:date`
- `:abhtransdate` — `:utc_datetime`
- `:abhnotes` — `:string`
- `:abhrental_freq` — `:string`
- `:abhallowed_hours` — `:integer`
- `:abhreport_freq` — `:string`
- `:abhcustomerid` — `:integer`
- `:period_calculation` — `:string`
- `:customer` — `has_one ApiServer.Vx.VXCustomer` (FK `:aaaid`, ref `:abhcustomerid`)
- `:thing` — `belongs_to ApiServer.Vx.VXThing` (FK `:abhthingid`, ref `:aadid`)

**`changeset/2` casts:** `:abhid`, `:abhclient`, `:abhcustomerid`, `:abhthingid`, `:abhstartdate`, `:abhenddate`, `:abhtransdate`, `:abhnotes`, `:abhrental_freq`, `:abhallowed_hours`, `:abhreport_freq`, `:period_calculation`
*(Note: `:abhcustcode` is NOT cast)*

---

## Findings

---

**B010-1** — [LOW] Commented-out code: superseded pipeline in `generate_previous_period_anniversay/3`

File: `lib/api_server/vx/vx_rental.ex:274`

Description: Lines 274–278 contain a five-line commented-out Elixir pipeline that was replaced by the `case rental.abhenddate` block immediately above it. The comment `# rental_end_datetime = rental.abhenddate ...` preserves the old implementation inline. Commented-out code creates noise, obscures intent, and should be removed; version history in git serves this purpose.

```elixir
        # rental_end_datetime = rental.abhenddate
        #   |> NaiveDateTime.new(~T[23:59:59])
        #   |> elem(1)
        #   |> Timex.to_datetime(user_timezone)
        #   |> Timex.beginning_of_day
```

---

**B010-2** — [LOW] Commented-out code: old `nil` return value with inline rationale

File: `lib/api_server/vx/vx_rental.ex:240`

Description: Line 240 contains `# nil # Nothing to return, this new anniversary falls outside of the rental` — a commented-out expression that was the prior return value of `generate_next_period_anniversay/3` before the logic was changed to return `rental_end_datetime`. The adjacent comment "Old code returned nothing?" (line 239) confirms this is vestigial. Should be deleted.

```elixir
      # Old code returned nothing?
      # nil # Nothing to return, this new anniversary falls outside of the rental
```

---

**B010-3** — [LOW] Commented-out code: removed format/parse chain in WEEKLY branch of `generate_previous_period_anniversay/3`

File: `lib/api_server/vx/vx_rental.ex:389`

Description: In the `"WEEKLY"` → `"CONTRACT"` path of `generate_previous_period_anniversay/3`, lines 389, 391–392, 395, and 398 are commented-out code fragments from an earlier implementation that used `Timex.format("{D}")` and `Integer.parse` to extract day-of-week, since replaced by `Timex.weekday/1`. Interleaving live and dead code around active pipeline steps significantly harms readability.

```elixir
              rental_start_day = rental_start_date
                # |> Timex.format("{D}")
                |> Timex.weekday()
                # |> Timex.day
              # {rental_start_day, _} = Integer.parse(rental_start_day)

              anniversary_day = current_anniversary
                # |> Timex.format("{D}")
                |> Timex.weekday()
              # {anniversary_day, _} = Integer.parse(anniversary_day)
```

---

**B010-4** — [LOW] Commented-out code: superseded `Timex.set` calls in `calculate_period_start_date/3`

File: `lib/api_server/vx/vx_rental.ex:517`

Description: Lines 517 and 542 both contain `# Timex.set(check_datetime, [day: 1])`, which is the old calendar-reset implementation now replaced by `Timex.beginning_of_month/1`. Two occurrences in two symmetrical `cond` branches. Should be deleted.

```elixir
                # Timex.set(check_datetime, [day: 1])
                check_datetime = Timex.beginning_of_month(check_datetime)
```

---

**B010-5** — [MEDIUM] Duplicate `case` branches — `"CALENDAR"` and `_` are identical in `get_all_anniversaries_between_dates/4`

File: `lib/api_server/vx/vx_rental.ex:37`

Description: The `case rental.period_calculation do` at line 37 has two branches — `"CALENDAR"` (lines 38–54) and `_` (lines 55–71) — that contain byte-for-byte identical logic (a three-clause `cond` calling `calculate_period_start_date` / `generate_next_period_anniversay`). The `"CALENDAR"` distinction is therefore completely inoperative: the same code path executes regardless. This is either dead differentiation (the `"CALENDAR"` branch should eventually differ from `_` but does not yet) or a copy-paste mistake. In either case the code misleads readers into believing `period_calculation` affects this function, and the compiler will warn about the always-matching catch-all.

```elixir
    first_anniversary =
      case rental.period_calculation do
        "CALENDAR" ->
          something = cond do ... end   # identical body
          something
        _ ->
          something = cond do ... end   # identical body
          something
      end
```

---

**B010-6** — [LOW] Build warning: variable re-binding that Elixir will flag as unused in `generate_previous_period_anniversay/3` and `calculate_period_start_date/3`

File: `lib/api_server/vx/vx_rental.ex:340` (and 430, 527, 551)

Description: In multiple `if` expressions, a variable is bound in the truthy branch by reassigning an outer binding, then immediately returned. Elixir treats each `if` branch as a new scope; the inner binding shadows the outer one but the compiler issues a "variable X is unused" warning for the outer binding when the inner branch is taken. Concrete examples:

- Lines 339–344: `previous_anniversary` rebound to `rental_start_datetime` inside `if`, then returned.
- Lines 429–434: same pattern for the `"WEEKLY"` path.
- Lines 527–530 and 551–555: `check_datetime` rebound inside `if` within `calculate_period_start_date/3`.

The idiomatic Elixir pattern is to use the `if` expression's return value directly rather than rebinding, e.g. `previous_anniversary = if ... do rental_start_datetime else previous_anniversary end`.

---

**B010-7** — [LOW] Typo in public function name: `generate_previous_period_anniversay` (missing 'r')

File: `lib/api_server/vx/vx_rental.ex:246`

Description: The public function is named `generate_previous_period_anniversay` (missing the letter `r` — should be `anniversary`). The same typo exists in the private companion `generate_next_period_anniversay` (line 176). Because both spellings are used consistently across all call sites (`vx.ex`, `vx_rental_controller.ex`, `utility_controller.ex`), there is no runtime defect today. However the misspelling is part of the public API surface of this module and will require a coordinated rename across at least six files to correct. The typo was present from initial authorship and has been compounded by widespread adoption.

---

**B010-8** — [MEDIUM] `generate_previous_period_anniversay/3` is declared `def` (public) but the symmetrical `generate_next_period_anniversay/3` is `defp` (private)

File: `lib/api_server/vx/vx_rental.ex:246` vs `176`

Description: `generate_next_period_anniversay/3` is private (`defp`, line 176), while `generate_previous_period_anniversay/3` is public (`def`, line 246). Call-site analysis shows that `generate_previous_period_anniversay/3` is called externally from `vx.ex`, `vx_rental_controller.ex`, and `utility_controller.ex`, so making it public is intentional. However, `generate_next_period_anniversay/3` is also called by public functions within this module and may be needed publicly in future. This asymmetry in visibility between two directly analogous functions is a leaky abstraction concern: internal period-stepping logic is published selectively, pushing callers toward a one-directional iteration API that requires them to call the public `get_all_anniversaries_between_dates/4` for forward movement but the internal-step function directly for backward movement. The boundary between public and private API is inconsistent.

---

**B010-9** — [LOW] `require` directives outside the module in `vx_fleet_association.ex`

File: `lib/api_server/vx/vx_fleet_association.ex:1`

Description: Lines 1–2 place `require Ecto.Query` and `require Ecto.Adapters.SQL` at the top level, outside the `defmodule` block. Neither macro is used anywhere in this file (there are no queries, no raw SQL). The module contains only a schema definition with `use Ecto.Schema`. Placing `require` outside `defmodule` pollutes the compilation environment and generates build warnings about unused macros. The pattern appears copy-pasted from sibling schema files (`vx_thing.ex`, `vx_user.ex`, `vx_access_fob.ex`) that do define query functions, where the `require` is equally misplaced outside their modules.

---

**B010-10** — [LOW] Trailing whitespace on `@primary_key` line in `vx_fleet_association.ex`

File: `lib/api_server/vx/vx_fleet_association.ex:7`

Description: Line 7 ends with two trailing space characters after the closing `}` of the `@primary_key` attribute: `@primary_key {:aafid, :id, autogenerate: true}  `. While not a runtime defect, trailing whitespace causes noisy diffs and is inconsistent with all other `@primary_key` declarations in the codebase.

---

**B010-11** — [LOW] Misindented closing `end` of module in `vx_rayven_message_log.ex` and `vx_rayven_stream_status.ex`

File: `lib/api_server/vx/vx_rayven_message_log.ex:20` and `lib/api_server/vx/vx_rayven_stream_status.ex:21`

Description: In both files the closing `end` of the `defmodule` block is indented by two spaces (`  end`) rather than being at column 0. This indentation implies the `end` closes a nested construct (e.g. an inner module or a `do` block), which it does not. The internal `use`, `import`, `schema`, and `def` lines are indented with four spaces relative to the module — suggesting the file was written as if the module were nested inside another, then the outer container was removed without adjusting indentation. `vx_rental.ex` uses correct 2-space indentation (module body at 2 spaces, `end` at column 0), demonstrating the inconsistency across the file set.

---

**B010-12** — [LOW] Inconsistent indentation style across the four files

File: (all four files)

Description: The four files use three different indentation styles for module body members:

| File | `use`/`import` indent | `schema` fields indent | `def` body indent |
|---|---|---|---|
| `vx_fleet_association.ex` | 4 spaces | 8 spaces | (no functions) |
| `vx_rayven_message_log.ex` | 4 spaces | 8 spaces | 6 spaces (2 inside 4-space `def`) |
| `vx_rayven_stream_status.ex` | 4 spaces | 8 spaces | 6 spaces |
| `vx_rental.ex` | 2 spaces | 4 spaces | 4 spaces |

`vx_rental.ex` follows the Elixir community convention of 2-space indentation. The other three files use 4-space indentation for the module body, doubling to 8 for schema contents. This divergence indicates the files were authored in different editors without a shared `.editorconfig` or `mix format` enforcement.

---

**B010-13** — [LOW] CRLF line endings in all four files

File: (all four files)

Description: All four files use Windows-style CRLF (`\r\n`) line endings. This is inconsistent with the Elixir/Mix ecosystem convention of LF-only line endings and will cause spurious whitespace diffs in cross-platform development. A `.gitattributes` rule (`*.ex text eol=lf`) is absent or not enforced.

---

**B010-14** — [LOW] `changeset/2` in `vx_rayven_message_log.ex` does not cast the `created` field

File: `lib/api_server/vx/vx_rayven_message_log.ex:18`

Description: The schema declares `field :created, :utc_datetime` (line 13) but `changeset/2` casts only `:message_direction`, `:message_type`, `:hardware_id`, `:event_id`, `:response`, and `:message` — omitting `:created`. If the application ever writes this field through the changeset path it will be silently ignored. The field exists to record when a message was logged; it is likely intended to be set at insert time. The omission may be intentional (set via `Repo.insert` with explicit field override) but is not documented and is inconsistent with how similar timestamp fields are treated elsewhere.

---

**B010-15** — [MEDIUM] Incomplete `case` clause in `calculate_period_start_date/3` for `"MONTHLY"` frequency — no catch-all for `period_calculation`

File: `lib/api_server/vx/vx_rental.ex:512`

Description: When `rental.abhrental_freq` is `"MONTHLY"`, the code switches on `rental.period_calculation` with only two branches: `"CALENDAR"` and `"CONTRACT"` (lines 512–535 and 539–562). There is no catch-all (`_`) clause. If `period_calculation` is `nil` or any value other than these two strings, Elixir will raise a `CaseClauseError` at runtime. Given that `period_calculation` is a free-form string field with no validation in `changeset/2` and the database schema imposes no constraint, this represents a realistic crash vector. The same pattern appears in `rental_day <= check_day` and `rental_day > check_day` branches at lines 512 and 537 respectively.

---

**B010-16** — [INFO] Intermediate `something` and `return_me` variables are unnecessary

File: `lib/api_server/vx/vx_rental.ex:39`, `56`, `280`, `365`, `191`, `205`, `282`, `368`

Description: Throughout `vx_rental.ex`, intermediate variables named `something` and `return_me` are assigned the result of a `cond` or `case` expression and then immediately returned as the last expression of the enclosing clause. In Elixir, `case`, `cond`, and `if` are expressions whose value can be used directly without an intermediate binding. The pattern `something = cond do ... end; something` is idiomatic in imperative languages but is redundant in Elixir and adds visual noise. This is a style issue only; it does not affect correctness or performance.

---

**B010-17** — [LOW] Unchecked pattern match on error tuple in `get_all_anniversaries_between_dates/4`

File: `lib/api_server/vx/vx_rental.ex:25`

Description: Lines 25–26 destructure the result of `NaiveDateTime.new/2` using `{_, to_datetime}` and `{_, from_datetime}`, silently discarding the first element (`:ok` or `:error`). `NaiveDateTime.new/2` can return `{:error, :invalid_date}` for invalid combinations (e.g. February 30). Using `{_, ...}` in a match means an error tuple would still match (binding `from_datetime` to `:invalid_date`) and propagate a nonsense value into Timex calls. The safer pattern is to match `{:ok, to_datetime}` and handle the error case explicitly, or use `NaiveDateTime.new!/2` which raises on error (consistent with the `Date.from_iso8601!/1` bang-function used on the same lines).

---

## Summary Table

| ID | Severity | Title | File |
|---|---|---|---|
| B010-1 | LOW | Commented-out superseded pipeline | `vx_rental.ex:274` |
| B010-2 | LOW | Commented-out old `nil` return | `vx_rental.ex:240` |
| B010-3 | LOW | Commented-out format/parse chain in WEEKLY branch | `vx_rental.ex:389` |
| B010-4 | LOW | Commented-out superseded `Timex.set` calls | `vx_rental.ex:517` |
| B010-5 | MEDIUM | Identical `"CALENDAR"` and `_` branches — period_calculation check is inoperative | `vx_rental.ex:37` |
| B010-6 | LOW | Variable re-binding causes compiler "unused variable" warnings | `vx_rental.ex:340` |
| B010-7 | LOW | Typo in public function name: `anniversay` → `anniversary` | `vx_rental.ex:246` |
| B010-8 | MEDIUM | Asymmetric visibility: `generate_previous` is public, `generate_next` is private | `vx_rental.ex:176,246` |
| B010-9 | LOW | `require` directives placed outside `defmodule`; macros unused in file | `vx_fleet_association.ex:1` |
| B010-10 | LOW | Trailing whitespace on `@primary_key` line | `vx_fleet_association.ex:7` |
| B010-11 | LOW | Module-closing `end` incorrectly indented by 2 spaces in two files | `vx_rayven_message_log.ex:20`, `vx_rayven_stream_status.ex:21` |
| B010-12 | LOW | Inconsistent indentation style across all four files (2-space vs 4-space) | all four files |
| B010-13 | LOW | CRLF line endings in all four files | all four files |
| B010-14 | LOW | `created` field not cast in `VXRayvenMessageLog.changeset/2` | `vx_rayven_message_log.ex:18` |
| B010-15 | MEDIUM | Incomplete `case` on `period_calculation` — no catch-all, runtime crash risk | `vx_rental.ex:512` |
| B010-16 | INFO | Unnecessary `something`/`return_me` intermediate variables | `vx_rental.ex` (multiple) |
| B010-17 | LOW | Unchecked `{_, ...}` match on `NaiveDateTime.new/2` error tuple | `vx_rental.ex:25` |
# Pass 4 – B011

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01

**Files reviewed:**
- `lib/api_server/vx/vx_restriction.ex`
- `lib/api_server/vx/vx_thing.ex`
- `lib/api_server/vx/vx_thing_event.ex`
- `lib/api_server/vx/vx_thing_event_omega.ex`

---

## Reading Evidence

### File: `lib/api_server/vx/vx_restriction.ex`

**Module:** `ApiServer.Vx.VXRestriction`

**Uses / Imports:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

**Schema:** `"aau_rest"`
- Primary key: `{:aauid, :id, autogenerate: true}`
- Fields: `:aaucharval` (string), `:aaucustcode` (string), `:aaufun` (string), `:aaunumval` (integer)
- Association: `belongs_to :user, ApiServer.Vx.VXUser, foreign_key: :aauuser_id, references: :aacid`

**Functions:**

| Name | Line |
|---|---|
| `changeset/2` | 16 |

**Types / Constants / Errors defined:** none

---

### File: `lib/api_server/vx/vx_thing.ex`

**Module:** `ApiServer.Vx.VXThing`

**Top-level directives (outside defmodule):**
- `require Ecto.Query` (line 1)
- `require Ecto.Adapters.SQL` (line 2)

**Uses / Imports / Aliases (inside defmodule):**
- `use Ecto.Schema`
- `import Ecto.Changeset`
- `alias ApiServer.Vx`

**Schema:** `"aad_thing"`
- Primary key: `{:aadid, :id, autogenerate: true}`
- Fields: `:aadcustcode`, `:aaddesc`, `:aadintext`, `:aadaddr`, `:aadcustomerid`, `:aadcat`, `:aadhardwareid`, `:aadhw_type`, `:aadmake`, `:aadmodel`, `:aadserialno`, `:aadmobile`, `:aadimei`, `:aadhourmeter`, `:aadhourmeter1`, `:aadhourmeter2`, `:aadhourmeter3`, `:aadhourmeter4`, `:aadhourmeterprnt`, `:aadodometer`, `:aadhourmeteromega`, `:aadhourmeterothcan`, `:aaddateintoservice`, `:aadlastservice`, `:aadvalid`, `:aadserviceoffset`, `:aadsvchrs`, `:aadrange_lat`, `:aadrange_long`, `:aadrange_dist`, `:aadrange_unit`, `:service_calculation_input`, `:reference_1`, `:reference_2`, `:reference_3`, `:notes`, `:equipment_date_into_service`
- Associations: `has_many :fleet_thing_joins`, `has_many :rentals`, `has_many :events`, `has_one :summary`, `has_one :info`, `has_one :customer`

**Functions:**

| Name | Line |
|---|---|
| `convert_json_to_changeset/1` | 60 |
| `changeset/2` | 75 |

**Types / Constants / Errors defined:** none

---

### File: `lib/api_server/vx/vx_thing_event.ex`

**Module:** `ApiServer.Vx.VXThingEvent`

**Uses / Imports:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

**Schema:** `"thingevents"` (no explicit primary key declaration; default Ecto integer `:id` applies)
- Fields: `:gmtdatetime`, `:hardwareid`, `:eventtype`, `:eventcode`, `:latitude`, `:longitude`, `:driverid`, `:engineonelapsed`, `:totalengineseconds`, `:custcode`, `:hardwaretype`, `:datetimesaved`, `:dateinqueue`, `:timeoffix`, `:altitude`, `:heading`, `:speed`, `:rssi`, `:gpsfixquality`, `:odometer`, `:mifaredriverid`, `:ignition`, `:ignitionstatus`, `:calcengineseconds`, `:input1elapsed`, `:input1status`, `:input1totalseconds`, `:input1calctotalseconds`, `:input2elapsed`, `:input2status`, `:input2totalseconds`, `:input2calctotalseconds`, `:input3elapsed`, `:input3status`, `:input3totalseconds`, `:input3calctotalseconds`, `:input4elapsed`, `:input4status`, `:input4totalseconds`, `:input4calctotalseconds`, `:prntelapsed`, `:prntstatus`, `:prnttotalseconds`, `:prntcalctotalseconds`, `:rhmprestartchecklist`, `:geofence`
- Commented-out field: `# field :llpoint, Geo.Point` (line 52)
- Associations: `has_one :thingeventomega`, `belongs_to :thing`

**Functions:**

| Name | Line |
|---|---|
| `map_xml/1` | 71 |
| `changeset/2` | 111 |

**Types / Constants / Errors defined:** none

---

### File: `lib/api_server/vx/vx_thing_event_omega.ex`

**Module:** `ApiServer.Vx.VXThingEventOmega`

**Uses / Imports:**
- `use Ecto.Schema`
- `import Ecto.Changeset`

**Schema:** `"thingomega"` (no explicit primary key declaration)
- Fields: `:accelerometerx`, `:accelerometery`, `:accelerometerz`, `:distancesincelastevent`, `:omegadriverid`, `:seatbelt`, `:seated`, `:parkbrakerequest`, `:parkbreakreleased`, `:vehicleload`, `:tilt`, `:height`, `:overload`, `:attretracted`, `:yellowled`, `:redled`, `:greenled`, `:liftenable`, `:safetyoverride`, `:doorclosed`, `:parkbrakerror`, `:batterynotcharged`, `:lowengineoil`, `:accnotcharged`, `:hydraulicfilgerblocked`, `:airfilterblocked`, `:attpressure`, `:oilcoolerfan`, `:lowerinterruption`, `:undersafetyheight`, `:joystickliftposition`, `:hydraulicoiltemperature`, `:md3temperature`, `:fuellevel`, `:md3status`, `:xa2status`, `:batteryvoltage`, `:xa2temperature`, `:boomangle`, `:boomextension`, `:lift`, `:extension`, `:totalfuelconsumption`, `:fuelrate`, `:totalfuelidle`, `:totalidlehour`, `:totalenginehour`, `:enginerpm`, `:capacity`, `:coolanttemperature`, `:oiltemperature`, `:engineerrorcode`, `:vehiclespeed`, `:gearselection`, `:transerrorcode`, `:prestartchecklist`, `:truckerrorcode`, `:mc43status`, `:mc43temperature`, `:lc5status`, `:lc5temperature`, `:truckangle`
- Association: `belongs_to :thingevent, ApiServer.Vx.VXThingEvent, foreign_key: :id, references: :id, primary_key: true, define_field: false`

**Functions:**

| Name | Line |
|---|---|
| `changeset/2` | 72 |

**Types / Constants / Errors defined:** none

---

## Findings

---

**B011-1** — [LOW] Commented-out schema field (`field :llpoint`)
File: `lib/api_server/vx/vx_thing_event.ex:52`
Description: The line `# field :llpoint, Geo.Point` is a commented-out schema field. It indicates an intention to store a PostGIS/Geo point that was never completed or was abandoned. Commented-out code clutters the schema and leaves ambiguity about whether this field exists in the database table. If the column does exist in the DB, the schema is silently incomplete; if it does not, the comment is noise. This should either be implemented or removed.

---

**B011-2** — [LOW] Commented-out code block inside `map_xml/1`
File: `lib/api_server/vx/vx_thing_event.ex:103–106`
Description: Lines 103–106 are commented-out map keys inside the return map of `map_xml/1`:
```elixir
# driverid: data[], #
# mifaredriverid: data[], #
# calcengineseconds: data[], # need the thing record for this one
# input1calctotalseconds: data[], # need the thing record for this one
```
These represent four fields declared in the schema that are never populated by `map_xml/1`. The inline comments ("need the thing record for this one") indicate incomplete business logic. The `:driverid` field is mapped via an interpolation workaround (`"#{data["driverid"]}"`) at line 88 rather than being removed from this comment, making the comment actively misleading. Commented-out code with unfinished notes is a LOW finding and indicates deferred work that is invisible at runtime.

---

**B011-3** — [LOW] Commented-out code block inside `calamp_controller.ex` references incomplete `map_xml/1` flow
File: `lib/api_server/vx/vx_thing_event.ex:71` (related: `lib/api_server_web/controllers/calamp_controller.ex:22–25`)
Description: The `map_xml/1` function is only called from `calamp_controller.ex`, where the controller itself contains additional commented-out steps (steps 3 and 4 of the processing pipeline are commented out). This means `map_xml/1` feeds a partially implemented pipeline. While the finding is directly reported on the schema file here for the incomplete field population, the broader context is that `map_xml/1` is integrated into dead/incomplete controller logic. The `IO.inspect` call at `calamp_controller.ex:10` also evidences debug code left in production paths.

---

**B011-4** — [MEDIUM] `require Ecto.Query` and `require Ecto.Adapters.SQL` are outside `defmodule` and unused
File: `lib/api_server/vx/vx_thing.ex:1–2`
Description: Lines 1 and 2 place `require Ecto.Query` and `require Ecto.Adapters.SQL` at the top level of the file, outside the `defmodule ApiServer.Vx.VXThing do` block. Neither macro is used anywhere in the module body — the module only uses `Ecto.Schema` (via `use`) and `Ecto.Changeset` (via `import`). `require` at the file's top level applies to the file's compile context but does not make the macros available inside the module in the standard way Elixir intends. The compiler will emit warnings for unused `require` directives. This is a build-warning-class finding and represents leftover scaffolding. Severity is MEDIUM because placing `require` outside `defmodule` is an unusual pattern that can confuse readers into thinking the module has SQL/query capabilities it does not exercise.

---

**B011-5** — [MEDIUM] `[REDACTED-AWS-SMTP-PASSWORD]` schema field missing from `changeset/2` cast list
File: `lib/api_server/vx/vx_thing_event_omega.ex:9` and `72–76`
Description: The field `:distancesincelastevent` is declared in the schema at line 9 but is entirely absent from the `cast/3` call in `changeset/2` (line 74). As a result, this field can never be set or updated via the changeset. The field is read by the view layer (`vx_thing_event_view.ex`) and so must contain meaningful data; however the only path to populate it is through direct database insertion (bypassing the changeset). This is a silent data integrity gap: callers using `changeset/2` to upsert records will silently drop any `:distancesincelastevent` value passed in `attrs`. Severity MEDIUM because it causes silent data loss on the write path.

---

**B011-6** — [LOW] Typo in field name `parkbreakreleased` (should be `parkbrakereleased`)
File: `lib/api_server/vx/vx_thing_event_omega.ex:14`
Description: The field is named `:parkbreakreleased` (line 14), mixing "brake" (the mechanical device) with "break" (as in fracture). The paired field at line 13 is `:parkbrakerequest`, which is spelled correctly. This inconsistency propagates to the view (`vx_thing_event_view.ex:28`) and the controller mapping (`utility_controller.ex:885`), meaning any API consumers now depend on the misspelled name. Renaming is a breaking change, so this is LOW rather than INFO, but it is a real maintainability defect.

---

**B011-7** — [LOW] Typo in field name `[REDACTED-AWS-SMTP-PASSWORD]` (should be `[REDACTED-AWS-SMTP-PASSWORD]`)
File: `lib/api_server/vx/vx_thing_event_omega.ex:30`
Description: The field `:hydraulicfilgerblocked` transposes "filter" into "filger". Like `parkbreakreleased`, the misspelling propagates to the view layer and the controller mapping. Any external API consumers or database column names that match this typo create a permanent coupling to the error. This is LOW for the same reasons as B011-6.

---

**B011-8** — [MEDIUM] `changeset/2` in `VXThingEventOmega` is a single unformatted line of 65 fields
File: `lib/api_server/vx/vx_thing_event_omega.ex:74`
Description: The entire `cast/3` call listing 65 atom keys is written as a single line (line 74 is extremely long). This is a style inconsistency relative to `VXThingEvent.changeset/2` (lines 112–160) which formats each field on its own line, and to `VXRestriction.changeset/2` (lines 16–20) which is also multi-line. The unformatted single-line form makes code review impractical and means the missing `:distancesincelastevent` field (finding B011-5) is nearly impossible to spot without tooling. Severity is MEDIUM because the formatting failure directly concealed the data-loss defect in B011-5.

---

**B011-9** — [LOW] `convert_json_to_changeset/1` in `VXThing` misleadingly names its return value `changeset`
File: `lib/api_server/vx/vx_thing.ex:60–73`
Description: The function assigns its result to a local named `changeset` (line 61) and returns it. However the return value is a plain `Map` built via `Vx.update_key_if_value/3` pipeline, not an `Ecto.Changeset` struct. The variable name `changeset` is therefore incorrect. Callers in `vx_thing_controller.ex` do treat it as a plain map (using `Map.has_key?` on it), but the function name and internal variable both imply Ecto changeset semantics, which is a leaky abstraction — the naming suggests the caller can pass it to `Repo.insert/2` or `Repo.update/2` directly, which would fail. Severity LOW because the misuse has not yet caused a runtime defect (callers handle it correctly), but the abstraction is misleading.

---

**B011-10** — [LOW] Style inconsistency: indentation uses 4-space indent in `VXThing`, 2-space in all other three files
File: `lib/api_server/vx/vx_thing.ex` (throughout)
Description: `vx_thing.ex` uses 4-space indentation for all code inside `defmodule` and `schema` blocks (lines 11–79). The other three files in this assignment (`vx_restriction.ex`, `vx_thing_event.ex`, `vx_thing_event_omega.ex`) all use 2-space indentation, consistent with the Elixir community standard and the `mix format` default. This inconsistency suggests `vx_thing.ex` was never run through the project formatter. Severity LOW as it does not affect runtime behavior but reduces readability and signals a gap in CI enforcement.

---

## Summary Table

| ID | Severity | File | Short Title |
|---|---|---|---|
| B011-1 | LOW | `vx_thing_event.ex:52` | Commented-out schema field `field :llpoint` |
| B011-2 | LOW | `vx_thing_event.ex:103–106` | Commented-out incomplete field mappings in `map_xml/1` |
| B011-3 | LOW | `vx_thing_event.ex:71` | `map_xml/1` feeds partially implemented / debug controller pipeline |
| B011-4 | MEDIUM | `vx_thing.ex:1–2` | `require` directives outside `defmodule` and unused (build warnings) |
| B011-5 | MEDIUM | `vx_thing_event_omega.ex:9,74` | `[REDACTED-AWS-SMTP-PASSWORD]` missing from `changeset/2` cast — silent data loss |
| B011-6 | LOW | `vx_thing_event_omega.ex:14` | Typo: `parkbreakreleased` (should be `parkbrakereleased`) |
| B011-7 | LOW | `vx_thing_event_omega.ex:30` | Typo: `[REDACTED-AWS-SMTP-PASSWORD]` (should be `[REDACTED-AWS-SMTP-PASSWORD]`) |
| B011-8 | MEDIUM | `vx_thing_event_omega.ex:74` | `changeset/2` cast list is a single unformatted 65-field line |
| B011-9 | LOW | `vx_thing.ex:61` | Return value of `convert_json_to_changeset/1` mislabeled as `changeset` |
| B011-10 | LOW | `vx_thing.ex` (throughout) | 4-space indentation inconsistent with 2-space standard in sibling files |
# Pass 4 – B012

Date: 2026-02-27
Audit run: 2026-02-27-01

Files reviewed:
- lib/api_server/vx/vx_thing_event_omega_tires.ex
- lib/api_server/vx/vx_thing_info.ex
- lib/api_server/vx/vx_thing_summary.ex
- lib/api_server/vx/vx_user.ex

---

## Reading Evidence

### lib/api_server/vx/vx_thing_event_omega_tires.ex

**Module:** `ApiServer.Vx.VXThingEventOmegaTires`

**Schema:** `"thingomegatires"` (no explicit `@primary_key`; primary key is inferred from the `belongs_to` relationship)

**Fields (all `:integer`, lines 6–53):**
- pressurewarning0–5, pressureleakage0–5, temperaturehigh0–5, receivetimeout0–5
- carbatteryvoltageexceed0–5, sensorbatteryvoltagelow0–5, tirepressure0–5, temperature0–5
(48 fields total, 8 per tire slot × 6 slots)

**Associations:**
- `belongs_to :thingevent, ApiServer.Vx.VXThingEvent` (line 55, composite primary key via `id`)

**Functions:**
- `changeset/2` — line 58

**Types/constants defined:** none

---

### lib/api_server/vx/vx_thing_info.ex

**Module:** `ApiServer.Vx.VXThingInfo`

**Schema:** `"thing_info"` with `@primary_key {:id, :id, autogenerate: true}` (line 14)

**Fields:**
- `:averageweeklyusage` — `:float` (line 16)
- `:pmnotificationid` — `:integer` (line 17)
- `:pmnotificationdate` — `:date` (line 18)
- `:usagesincenotification` — `:integer` (line 19)

**Associations:**
- `belongs_to :thing, VXThing` (line 21)

**Functions:**
- `getWithHardwareId/2` — line 24
- `service_performed/3` — line 31
- `[REDACTED-AWS-SMTP-PASSWORD]` — line 47
- `make_info_record/2` — line 57
- `update_existing_record/3` — line 74

**Types/constants defined:** none

---

### lib/api_server/vx/vx_thing_summary.ex

**Module:** `ApiServer.Vx.VXThingSummary`

**Schema:** `"abm_summary"` with `@primary_key {:abmid, :id, autogenerate: true}` (line 5)

**Fields (lines 7–44):**
- abmgmtdatetime (:utc_datetime), abmdesc (:string), abmignitionstatus (:string)
- abmeventtype (:integer), abmeventcode (:integer)
- abmtotalengineseconds, abmcalctotalengineseconds, abmtotalenginesecondssinceservice (:integer)
- abmhourmeter1–4, abmcalchourmeter1–4, abmhourmeter1–4sinceservice (:integer each)
- abmodometer, abmcalcodometer, abmodometersinceservice (:integer)
- abmlatitude, abmlongitude, abmheading, abmspeed (:float)
- abmdriverid, abmmifaredriverid, abmcustcode (:string)
- abmusagesinceservice, abmhourmeteromega, abmcalchourmeteromega (:float)
- abmhourmeterothcan, abmcalchourmeterothcan (:float)
- abmrhmprestartlastgmt (:utc_datetime), abmrhmprestartchecklist (:string)

**Associations:**
- `belongs_to :thing, ApiServer.Vx.VXThing` (line 45)

**Functions:**
- `changeset/2` — line 49
- `make_or_update_summary/3` (with default arg) — line 56
- `validate_for_hardwareid/2` — line 138
- `is_valid?/2` — line 156

**Types/constants defined:** none

---

### lib/api_server/vx/vx_user.ex

**Module:** `ApiServer.Vx.VXUser`

**Schema:** `"aac_user"` with `@primary_key {:aacid, :id, autogenerate: true}` (line 12)

**Fields (lines 14–48):**
- aaccustcode, aacuser, aacfname, aacsurname (:string)
- aaccredte, aaclastupdated, aacpwdlastupd (:utc_datetime)
- aacexpdte, aaclic1issuedate, aaclic1expdate, aaclic2issuedate, aaclic2expdate (:date)
- aacpassword, aacpasswordhash, aacpasswordresetcode (:string)
- aactz, aacfirstopt, aacemail (:string)
- aacdash, aacmaprefresh, aachourformat (:integer)
- aacuserdriver, aaclic1, aaclic1class, aaclic1issuer (:string)
- aaclic2, aaclic2class, aaclic2issuer (:string)
- aacusertype, aacproxyenabled, aactimezone, aacdeffleet (:integer) (:string×3, :integer)
- aacdateformat, aaclang, aacuom (:string)

**Associations:**
- `has_one :accessfob, ApiServer.Vx.VXAccessFob` (line 51)
- `has_one :function, ApiServer.Vx.VXUserFunction` (line 52)
- `has_many :assigned_fleets, ApiServer.Vx.VXRestriction` (line 53)
- `has_many :abl_records, ApiServer.Vx.VXAblRecord` (line 54)

**Functions:**
- `convert_json_to_changeset/1` — line 57
- `password_changeset/2` — line 73
- `changeset/2` — line 78

**Types/constants defined:** none

---

## Findings

---

**B012-1** — [LOW] Commented-out code in `[REDACTED-AWS-SMTP-PASSWORD]`

File: lib/api_server/vx/vx_thing_info.ex:49

Description: Line 49 contains `# calcfields(hardwareid, existingSummary)` — a commented-out call to a function (`calcfields`) that does not exist anywhere in the codebase. This is dead annotation left from development. It names a non-existent function and uses a variable name (`existingSummary`) inconsistent with the surrounding code (which uses `existing_info`), indicating it was never completed. Commented-out code clutters the module and can mislead future maintainers into thinking this logic is intentionally deferred.

---

**B012-2** — [HIGH] Hardcoded magic date `~D[2019-01-13]` used as bootstrap sentinel

File: lib/api_server/vx/vx_thing_info.ex:59

Description: `make_info_record/2` hardcodes `notification_date = ~D[2019-01-13]` as the PM notification date for every newly created info record. This date is then used to calculate hours of usage since that point (`fetch_actual_usage`). A fixed calendar date from 2019 embedded in application logic means all newly bootstrapped records behave as if the equipment was first notified over 7 years ago from the time of writing, producing incorrect `[REDACTED-AWS-SMTP-PASSWORD]` values for any equipment added after 2019. This is a data-correctness bug, not merely a style issue. The value should either be derived dynamically (e.g., from the equipment's first recorded event) or sourced from configuration.

---

**B012-3** — [MEDIUM] Hardcoded magic integer `12` for `pmnotificationid`

File: lib/api_server/vx/vx_thing_info.ex:66

Description: `make_info_record/2` hardcodes `pmnotificationid: 12`. No module-level constant, configuration entry, or comment explains what ID 12 represents. If the notification record it refers to is ever deleted or renumbered in the database, this silently stores a dangling foreign key or wrong reference. The value should be named (e.g., a module attribute `@default_pm_notification_id`) or sourced from configuration.

---

**B012-4** — [MEDIUM] Hardcoded epoch sentinel `~D[1970-01-01]` for "no notification" guard

File: lib/api_server/vx/vx_thing_info.ex:78

Description: `update_existing_record/3` guards against a null-like date by comparing `existing.pmnotificationdate > ~D[1970-01-01]`. Unix epoch (1970-01-01) is used as a proxy for "unset", but the schema already allows `nil` for `pmnotificationdate` (the first branch of the `cond` checks `!= nil`). The epoch check is therefore either redundant (if the DB never stores 1970-01-01) or a workaround for a database layer that returns the epoch instead of NULL — either way it is a leaky abstraction that couples application logic to a database representation detail. The logic should rely solely on `nil` checking.

---

**B012-5** — [MEDIUM] Variable `result` bound but never used in `make_or_update_summary/3`

File: lib/api_server/vx/vx_thing_summary.ex:135

Description: Line 135 assigns `result = ApiServer.Vx.update_or_insert_summary(...)` but `result` is never referenced again — the function's implicit return value is `result`, which is correct, but the binding name `result` shadows the `result` variable captured in the destructuring at line 66 (`{hardwareid_parsed, result} = ...`). The `result` from line 66 is also never used after that point. This means `{hardwareid_parsed, result}` at line 66 binds a value that is immediately discarded, and then the name `result` is reused at line 135 with a completely different meaning. Elixir will emit a compiler warning for the unused `result` from line 66. The pattern match at line 66 should use `_result` or be restructured to `{hardwareid_parsed, _}` to suppress the warning and clarify intent.

---

**B012-6** — [LOW] Variable `timestamp` bound but never used in `validate_for_hardwareid/2`

File: lib/api_server/vx/vx_thing_summary.ex:149

Description: Line 149 binds `timestamp = Timex.now()` immediately before calling `make_or_update_summary/3`, but `timestamp` is never passed to that function or referenced anywhere else in the clause. This is dead code that will produce an Elixir compiler warning ("variable timestamp is unused"). The `Timex.now()` call is also an unnecessary side-effecting operation on every update path. The line should be removed.

---

**B012-7** — [LOW] Commented-out code block — `unique_constraint` variant

File: lib/api_server/vx/vx_user.ex:85

Description: Line 85 contains `# |> unique_constraint(:aacuser, name: :aac_user_aacuser_index)` immediately below an active `unique_constraint` call on the same field with a different index name. The comment suggests the index name was changed at some point and the old constraint was left as a comment rather than removed. This creates ambiguity about which constraint name is canonical. The commented line should be deleted.

---

**B012-8** — [LOW] Commented-out code — timezone field mapping

File: lib/api_server/vx/vx_user.ex:68

Description: Line 68 contains `# |> Vx.update_key_if_value(:aactz, user_json["offset"])` inside `convert_json_to_changeset/1`. The `:aactz` field is defined in the schema (line 24) but its population from the JSON input is disabled. There is also a separate active mapping for `:aactimezone` (line 64). It is unclear whether `:aactz` is intentionally not populated from the API, or whether this is an incomplete migration from one field to another. Leaving it commented makes the intent opaque.

---

**B012-9** — [MEDIUM] Duplicate `update_key_if_value` call for `:aacuom` in `convert_json_to_changeset/1`

File: lib/api_server/vx/vx_user.ex:62,67

Description: Lines 62 and 67 both call `|> Vx.update_key_if_value(:aacuom, user_json["units"])` with identical arguments. The second call is redundant and will overwrite the first with the same value (assuming `update_key_if_value` is idempotent). Regardless of idempotency, the duplicate is likely a copy-paste error. It wastes a pipeline step and can mislead a reader into thinking the two calls do different things.

---

**B012-10** — [MEDIUM] `Float.round/2` applied twice to the same value in `make_or_update_summary/3`

File: lib/api_server/vx/vx_thing_summary.ex:124,128

Description: In the second `updated_summary` block (lines 119–133), `Float.round(thing_event.thingeventomega.totalenginehour, 2)` is computed at line 124 into `[REDACTED-AWS-SMTP-PASSWORD]`, and then at line 128 `Float.round(formattedtotalenginehour, 2)` is called again on the already-rounded value. Rounding an already-rounded float is harmless numerically but indicates the developer copied the pattern from the first block (lines 103–117) without recognising that `[REDACTED-AWS-SMTP-PASSWORD]` is already rounded. This is a code-quality defect that suggests the two blocks were written inconsistently.

---

**B012-11** — [MEDIUM] `require Ecto.Adapters.SQL` at top level outside module in `vx_user.ex`

File: lib/api_server/vx/vx_user.ex:2

Description: Lines 1–2 of `vx_user.ex` place `require Ecto.Query` and `require Ecto.Adapters.SQL` at the file's top level, outside the `defmodule` block. Neither `Ecto.Query` nor `Ecto.Adapters.SQL` is used anywhere within the `VXUser` module body (no `Ecto.Query.from`, no `Ecto.Adapters.SQL.query`, etc.). Top-level `require` directives in Elixir have module-scoping implications and produce compiler noise. The same pattern appears in `vx_thing_info.ex` where `require Ecto.Adapters.SQL` is inside the module but still unused in that file. Both requires should be removed.

---

**B012-12** — [MEDIUM] `require Ecto.Adapters.SQL` declared but never used in `vx_thing_info.ex`

File: lib/api_server/vx/vx_thing_info.ex:7

Description: `require Ecto.Adapters.SQL` is declared on line 7 inside the module, but no raw SQL execution (`Ecto.Adapters.SQL.query` or similar) is performed anywhere in the file. All database access goes through `Ecto.Query` and `Repo`. The unused `require` will cause a compiler warning and signals copy-paste from another module that does use raw SQL.

---

**B012-13** — [LOW] Inconsistent indentation style across files (2-space vs 4-space)

File: lib/api_server/vx/vx_thing_info.ex (4-space), lib/api_server/vx/vx_user.ex (4-space) vs lib/api_server/vx/vx_thing_event_omega_tires.ex (2-space), lib/api_server/vx/vx_thing_summary.ex (2-space)

Description: The Elixir community standard (and the formatter default) is 2-space indentation. `vx_thing_info.ex` and `vx_user.ex` consistently use 4-space indentation throughout, while `vx_thing_event_omega_tires.ex` and `vx_thing_summary.ex` use 2-space indentation. This inconsistency across sibling files in the same namespace indicates that `mix format` has not been applied uniformly, making diffs harder to read and signalling absent or unenforced formatting standards.

---

**B012-14** — [LOW] Inconsistent naming convention — `camelCase` public functions alongside `snake_case`

File: lib/api_server/vx/vx_thing_info.ex:24,47

Description: `getWithHardwareId/2` (line 24) and `[REDACTED-AWS-SMTP-PASSWORD]` (line 47) use camelCase, which violates the Elixir naming convention of snake_case for functions. All functions in the other three files under review use snake_case. Callers in controllers (e.g., `vx_thing_info_controller.ex`) call `[REDACTED-AWS-SMTP-PASSWORD]` and `VXThingInfo.service_performed` on the same module, showing a mixed-convention public API within a single module. This will trigger Elixir compiler warnings about non-idiomatic function naming.

---

**B012-15** — [LOW] Comment describes intent without implementation — orphaned TODO block

File: lib/api_server/vx/vx_thing_summary.ex:100–101

Description: Lines 100–101 contain:
```
# If we have thing_event.thingeventomega.totalenginehour then map merge
# If we have thing.aadhourmeteromega then map merge
```
These comments describe exactly what the following code does, so they serve as implementation notes rather than clarifying non-obvious intent. More importantly, the phrasing "If we have … then map merge" reads as a to-do or design note frozen in place — the code below implements both conditions, but the comments read as if the implementation may still be pending. This constitutes low-quality commentary that can mislead reviewers.

---

**B012-16** — [HIGH] `changeset/2` in `vx_user.ex` accesses `attrs.user_level` directly — crashes on map with string keys

File: lib/api_server/vx/vx_user.ex:81

Description: Line 81 calls `put_assoc(:function, %{aatfunction_id: attrs.user_level}, required: true)`. The `attrs` parameter is passed directly from `convert_json_to_changeset/1` which builds a plain map with atom keys (via `Vx.update_key_if_value(:user_level, ...)`). However, `changeset/2` is also called from `vx.ex` with a map built from controller params that may have string keys. Accessing `attrs.user_level` (dot-notation struct access) on a plain map with string keys will raise a `KeyError` at runtime because map dot-notation only works for structs. If the map uses atom keys but `:user_level` is absent, it returns `nil` silently — meaning the function association can be set to `%{aatfunction_id: nil}` without validation. This is a leaky abstraction: `changeset/2` assumes a specific map key type that is not enforced by the function signature or any guard.

---

## Summary Table

| ID      | Severity | Title                                                                 | File                                  | Line(s) |
|---------|----------|-----------------------------------------------------------------------|---------------------------------------|---------|
| B012-1  | LOW      | Commented-out call to non-existent function `calcfields`             | vx_thing_info.ex                      | 49      |
| B012-2  | HIGH     | Hardcoded magic date `~D[2019-01-13]` as bootstrap sentinel          | vx_thing_info.ex                      | 59      |
| B012-3  | MEDIUM   | Hardcoded magic integer `12` for `pmnotificationid`                  | vx_thing_info.ex                      | 66      |
| B012-4  | MEDIUM   | Hardcoded epoch `~D[1970-01-01]` as null-date sentinel               | vx_thing_info.ex                      | 78      |
| B012-5  | MEDIUM   | Variable `result` (line 66) bound but never used; name reused        | vx_thing_summary.ex                   | 66, 135 |
| B012-6  | LOW      | Variable `timestamp` bound but never used                            | vx_thing_summary.ex                   | 149     |
| B012-7  | LOW      | Commented-out `unique_constraint` variant                            | vx_user.ex                            | 85      |
| B012-8  | LOW      | Commented-out timezone field mapping `aactz`                         | vx_user.ex                            | 68      |
| B012-9  | MEDIUM   | Duplicate `update_key_if_value` call for `:aacuom`                   | vx_user.ex                            | 62, 67  |
| B012-10 | MEDIUM   | `Float.round/2` applied twice to already-rounded value               | vx_thing_summary.ex                   | 124, 128|
| B012-11 | MEDIUM   | `require Ecto.Adapters.SQL` outside module, unused                   | vx_user.ex                            | 2       |
| B012-12 | MEDIUM   | `require Ecto.Adapters.SQL` inside module, unused                    | vx_thing_info.ex                      | 7       |
| B012-13 | LOW      | Inconsistent indentation (2-space vs 4-space across files)           | vx_thing_info.ex, vx_user.ex          | all     |
| B012-14 | LOW      | camelCase public function names in an otherwise snake_case codebase  | vx_thing_info.ex                      | 24, 47  |
| B012-15 | LOW      | Orphaned design-note comments describing what code below already does | vx_thing_summary.ex                   | 100–101 |
| B012-16 | HIGH     | `attrs.user_level` dot-access in `changeset/2` crashes on string-key maps | vx_user.ex                       | 81      |
# Pass 4 – B013

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B013
**Pass:** 4 (Code Quality)

**Files reviewed:**
- `lib/api_server_web.ex`
- `lib/api_server_web/auth_error_handler.ex`
- `lib/api_server_web/auth_pipeline.ex`

---

## Reading Evidence

### File: `lib/api_server_web.ex`

**Module:** `ApiServerWeb`

**Functions (by line):**
| Line | Name | Notes |
|------|------|-------|
| 20 | `controller/0` | Returns a `quote` block injected into every controller |
| 29 | `view/0` | Returns a `quote` block injected into every view |
| 46 | `router/0` | Returns a `quote` block injected into the router |
| 54 | `channel/0` | Returns a `quote` block injected into channels |
| 64 | `__using__/1` (defmacro) | Dispatches to the appropriate `controller/view/etc.` function via `apply/3` |

**Types / constants / errors defined:** None.

**Notable imports/uses injected per macro:**
- `:controller` injects: `Phoenix.Controller` (namespaced), `Plug.Conn`, `ApiServerWeb.Router.Helpers`, `ApiServerWeb.Gettext`
- `:view` injects: `Phoenix.View`, `Phoenix.Controller` (partial), `Phoenix.HTML`, `ApiServerWeb.Router.Helpers`, `ApiServerWeb.ErrorHelpers`, `ApiServerWeb.Gettext`
- `:router` injects: `Phoenix.Router`, `Plug.Conn`, `Phoenix.Controller`
- `:channel` injects: `Phoenix.Channel`, `ApiServerWeb.Gettext`

---

### File: `lib/api_server_web/auth_error_handler.ex`

**Module:** `ApiServerWeb.AuthErrorHandler`

**Functions (by line):**
| Line | Name | Notes |
|------|------|-------|
| 4 | `auth_error/3` | Guardian error callback; pattern-matches `{type, _reason}`, sends 401 JSON |

**Types / constants / errors defined:** None.

**Imports:** `Plug.Conn` (line 2)

**Observations:**
- No `@moduledoc` or `@doc` attributes.
- File uses 4-space indentation for the top-level body of the module (`import` at line 2, `def` at line 4) instead of the standard 2-space Elixir convention. The inner function body correctly uses 2-space relative indentation, producing a mixed appearance.
- `^M` (CRLF) line endings throughout the file — the file was saved with Windows line endings.
- `_reason` is intentionally ignored (correctly prefixed with `_`).

---

### File: `lib/api_server_web/auth_pipeline.ex`

**Module:** `ApiServer.Guardian.AuthPipeline`

**Functions / plugs (by line):**
| Line | Name | Notes |
|------|------|-------|
| 6 | `plug Guardian.Plug.VerifyHeader` | Active plug, realm "Bearer" |
| 7 | `# plug Guardian.Plug.EnsureAuthenticated` | **Commented-out plug** |
| 8 | `plug Guardian.Plug.LoadResource` | Active plug |

**Types / constants / errors defined:** None.

**`use` options (lines 2–4):**
- `otp_app: :MyApi` — capitalised atom; the actual OTP application name is `:api_server` (see `mix.exs`)
- `module: ApiServer.Guardian`
- `error_handler: ApiServerWeb.AuthErrorHandler`

---

## Findings

**B013-1** — [CRITICAL] `EnsureAuthenticated` plug commented out — authentication not enforced
File: `lib/api_server_web/auth_pipeline.ex:7`
Description: `Guardian.Plug.EnsureAuthenticated` is disabled with a single-line comment. The pipeline only verifies and loads the token; it does not reject requests that carry no valid token. Any route that relies solely on `ApiServerWeb.AuthPipeline` (used at `router.ex:25`) will accept unauthenticated requests. Disabling this plug is a security bypass, not a style issue. Severity is CRITICAL because authentication enforcement is absent on guarded routes in a production API server.

---

**B013-2** — [HIGH] `otp_app: :MyApi` mismatches actual OTP application atom `:api_server`
File: `lib/api_server_web/auth_pipeline.ex:2`
Description: Guardian's `Plug.Pipeline` uses `otp_app` to look up configuration from the application environment at runtime. The atom `:MyApi` does not match the OTP application name declared in `mix.exs` (`:api_server`). Guardian will fail to resolve its configuration from the correct application environment key, which can cause silent misconfiguration (e.g., secret key fallback, wrong issuer) depending on Guardian version and how config is structured. This is a latent runtime misconfiguration bug.

---

**B013-3** — [MEDIUM] `channel/0` macro defined but no channels exist in the project
File: `lib/api_server_web.ex:54`
Description: The `channel` function in `ApiServerWeb` injects `use Phoenix.Channel` and `import ApiServerWeb.Gettext` for any module that calls `use ApiServerWeb, :channel`. No file in `lib/` calls `use ApiServerWeb, :channel` — only a stub `user_socket.ex` exists and it uses `Phoenix.Socket` directly. The `channel/0` macro is dead entry-point boilerplate that will never be invoked. While harmless at compile time, it is misleading and inflates the public surface of the entrypoint module. Severity is MEDIUM (dead code, leaky boilerplate).

---

**B013-4** — [LOW] Commented-out code — `EnsureAuthenticated` line
File: `lib/api_server_web/auth_pipeline.ex:7`
Description: In addition to the security consequence reported in B013-1, the presence of the commented-out plug constitutes a code quality finding on its own. Commented-out code should be removed from version-controlled source and tracked via issue tracker or git history. This finding is subordinate to B013-1 but recorded separately per instructions.

---

**B013-5** — [LOW] Inconsistent indentation in `auth_error_handler.ex` — 4-space top-level, 2-space inner
File: `lib/api_server_web/auth_error_handler.ex:2`
Description: The `import Plug.Conn` at line 2 and the `def auth_error` at line 4 are indented with 4 spaces relative to the module boundary. The Elixir community standard (and the style used everywhere else in this codebase) is 2-space indentation. The inner function body uses 2 spaces relative to the `def`, giving the overall module an inconsistent, non-standard appearance. This is a style inconsistency that would produce warnings in automated style checkers such as Credo (`Credo.Check.Readability.IndentationConsistency`).

---

**B013-6** — [LOW] CRLF line endings in `auth_error_handler.ex` — inconsistent with rest of codebase
File: `lib/api_server_web/auth_error_handler.ex`
Description: The file contains Windows-style CRLF (`\r\n`) line endings, as confirmed by raw byte inspection (`^M` markers). All other examined source files in the repository use LF-only line endings. CRLF line endings in an Elixir project can cause diff noise, confuse certain toolchain steps, and indicate the file was edited on Windows without normalisation. A `.gitattributes` or `editorconfig` rule should enforce LF endings.

---

**B013-7** — [LOW] `ApiServerWeb.Router.Helpers` imported into all controllers and views — leaky abstraction for a pure JSON API
File: `lib/api_server_web.ex:24` (controller macro), `lib/api_server_web.ex:40` (view macro)
Description: `ApiServerWeb.Router.Helpers` generates URL/path helpers for HTML route-aware templates. This is boilerplate from the Phoenix HTML generator. Examination of the controllers and views shows this is a JSON-only API server (no path helpers are referenced in any controller or view file). Injecting `Router.Helpers` into every controller and view namespace is unnecessary, pollutes the module namespace with unused helpers, and will generate Elixir compiler warnings about unused imports if the helpers are never called. This is a leaky abstraction: HTML-oriented helpers are coupled into modules that do not use them.

---

**B013-8** — [LOW] `Phoenix.HTML` and `get_flash/view_module` injected into views — HTML API leaking into JSON view layer
File: `lib/api_server_web.ex:35-38` (view macro)
Description: The `view/0` macro injects `use Phoenix.HTML` (which defines HTML escaping helpers, form builders, tag generators, etc.) and imports `Phoenix.Controller.get_flash/2` and `view_module/1` into every view module. No view in this project renders HTML — all are JSON serialisation modules. These imports are unused boilerplate from the Phoenix HTML generator, constitute build-warning candidates (unused imports), and expose an irrelevant HTML abstraction into a purely JSON view layer. They should be removed from the `view` macro.

---

**B013-9** — [INFO] No `@moduledoc` in `auth_error_handler.ex`
File: `lib/api_server_web/auth_error_handler.ex:1`
Description: The module has no `@moduledoc` attribute. While not a build warning, omitting module documentation on a security-critical callback module means the intent and contract of `auth_error/3` are undocumented. Flagged for awareness; severity is INFO and does not constitute a build warning.

---

## Summary Table

| ID | Severity | File | Short Title |
|----|----------|------|-------------|
| B013-1 | CRITICAL | `auth_pipeline.ex:7` | `EnsureAuthenticated` commented out — authentication not enforced |
| B013-2 | HIGH | `auth_pipeline.ex:2` | `otp_app: :MyApi` mismatches OTP app atom `:api_server` |
| B013-3 | MEDIUM | `api_server_web.ex:54` | `channel/0` macro is dead code — no channels exist |
| B013-4 | LOW | `auth_pipeline.ex:7` | Commented-out code present in source |
| B013-5 | LOW | `auth_error_handler.ex:2` | 4-space top-level indentation violates 2-space Elixir convention |
| B013-6 | LOW | `auth_error_handler.ex` | CRLF line endings inconsistent with rest of codebase |
| B013-7 | LOW | `api_server_web.ex:24,40` | `Router.Helpers` injected into all controllers/views — never used in JSON API |
| B013-8 | LOW | `api_server_web.ex:35-38` | `Phoenix.HTML` and flash helpers injected into JSON-only view layer |
| B013-9 | INFO | `auth_error_handler.ex:1` | No `@moduledoc` on security-critical error handler |

**Total findings: 9** (1 CRITICAL, 1 HIGH, 1 MEDIUM, 5 LOW, 1 INFO)
# Pass 4 – B014

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B014

## Files Reviewed

- `lib/api_server_web/channels/user_socket.ex`
- `lib/api_server_web/endpoint.ex`
- `lib/api_server_web/gettext.ex`
- `lib/api_server_web/xml_plug.ex`

---

## Reading Evidence

### lib/api_server_web/channels/user_socket.ex

**Module:** `ApiServerWeb.UserSocket`

**Macros/directives used (not functions):**
- `transport :websocket, Phoenix.Transports.WebSocket` — line 8 (macro call, not a def)

**Functions defined:**
| Function | Line |
|---|---|
| `connect/2` | 22 |
| `id/1` | 36 |

**Types / errors / constants defined:** none

**Notes:**
- No channels are registered; the only channel entry (`channel "room:*", ApiServerWeb.RoomChannel`) is commented out at line 5.
- The `transport` macro at line 8 is the old Phoenix 1.2-era API. Phoenix 1.5 (the version declared in mix.exs) deprecated `transport/3` inside `use Phoenix.Socket`; transport configuration moved to the socket options in the endpoint. The macro still compiles but emits a deprecation warning at build time.
- Lines 9, 27–35 contain commented-out code blocks (longpoll transport, example `id/1` implementation).

---

### lib/api_server_web/endpoint.ex

**Module:** `ApiServerWeb.Endpoint`

**Functions defined:**
| Function | Line |
|---|---|
| `init/2` | 51 |

**Plugs wired (compile-time, not functions):**
- `Plug.Static` — line 10
- `Phoenix.LiveReloader.Socket` socket — line 17 (conditional)
- `Phoenix.LiveReloader` — line 18 (conditional)
- `Phoenix.CodeReloader` — line 19 (conditional)
- `Plug.Logger` — line 22
- `Plug.Parsers` — line 24
- `Plug.MethodOverride` — line 30
- `Plug.Head` — line 31
- `Plug.Session` — line 36
- `CORSPlug` — line 42
- `ApiServerWeb.Router` — line 43

**Types / errors / constants defined:** none

**Notes:**
- `signing_salt` at line 39 is a short hardcoded literal (`"5CSDVUtC"`), in-source.
- `gzip: false` at line 11 with an adjacent comment noting it should be `true` in production.
- `xml_decoder: :xmerl_scan` is passed at line 28 but `xml_plug.ex` does not use this value (confirmed below).
- Trailing whitespace on line 41.

---

### lib/api_server_web/gettext.ex

**Module:** `ApiServerWeb.Gettext`

**Functions defined:** none (all behaviour comes from `use Gettext, otp_app: :api_server`)

**Types / errors / constants defined:** none

**Notes:** Module is used in `error_helpers.ex`, `api_server_web.ex`. No issues with the file itself.

---

### lib/api_server_web/xml_plug.ex

**Module:** `Plug.Parsers.XML`

**Behaviour implemented:** `Plug.Parsers`

**Functions defined:**
| Function | Line |
|---|---|
| `parse/5` (content-type "xml" clause) | 6 |
| `parse/5` (catch-all clause) | 13 |
| `defp decode/2` ({:ok, body, conn} clause only) | 17 |

**Types / errors / constants defined:**
- Raises `ArgumentError` — line 7
- Raises `"Malformed XML"` (plain string raise) — line 22
- Raises `Plug.Parsers.ParseError` — line 25

**Notes:**
- `decoder` is fetched from `opts` at line 7 but is only passed to `decode/2` at line 10; inside `decode/2` the parameter is named `decoder` but the function body calls `XmlToMap.naive_map/1` directly without ever using `decoder`. The value read from opts is therefore consumed only to satisfy the guard that the key is present — the actual decoding library is hardcoded.
- `decode/2` has only one pattern-match clause: `{:ok, body, conn}`. The `:more` and `:error` tuples that `read_body/2` can return are not handled, causing a `FunctionClauseError` at runtime for large bodies or read errors.
- The `case` at line 19 has a wildcard second clause (`_ -> raise "Malformed XML"`) that is unreachable: `XmlToMap.naive_map/1` never returns a non-map value on success; it either returns a map or raises. Elixir will warn about this unreachable clause.
- Indentation is inconsistent: the module body uses 4-space indentation for `defp decode`, while the public `def parse` clauses use 2-space indentation that is itself further indented by 2 extra spaces (net 4 spaces inside the module but visually mixed due to inconsistent leading spaces on the `defp` block).

---

## Findings

---

**B014-1** — [HIGH] Deprecated `transport/3` macro used in UserSocket

File: `lib/api_server_web/channels/user_socket.ex:8`

Description: `transport :websocket, Phoenix.Transports.WebSocket` uses the Phoenix 1.2-era `transport/3` macro that was deprecated in Phoenix 1.3 and removed in Phoenix 1.7. The project declares `{:phoenix, "~> 1.5.9"}` in `mix.exs`. Under Phoenix 1.5 this macro emits a compiler deprecation warning on every build. The correct approach for 1.5+ is to configure transports via the `socket/3` call in the endpoint or through socket options; the macro is a no-op in 1.5 and will break completely if the project is upgraded to Phoenix 1.7+. This is a build warning that will become a compile error on upgrade.

---

**B014-2** — [HIGH] `xml_decoder` option fetched but never used — hardcoded decoder

File: `lib/api_server_web/xml_plug.ex:7`

Description: Line 7 reads `decoder = Keyword.get(opts, :xml_decoder)` and will raise `ArgumentError` if the key is absent, giving callers the impression they control the decoding library. However, `decoder` is passed into `decode/2` at line 10, and `decode/2` ignores its second argument entirely — it calls `XmlToMap.naive_map(body)` unconditionally. The `:xml_decoder` option configured in `endpoint.ex` line 28 (`:xmerl_scan`) has zero effect on actual behavior. This constitutes a leaky/false abstraction: the public interface promises configurability that does not exist, and the `decoder` variable in `decode/2` (line 17) is bound but never read, which will generate a compiler "variable `decoder` is unused" warning.

---

**B014-3** — [HIGH] `decode/2` does not handle `:more` or `:error` from `read_body/2`

File: `lib/api_server_web/xml_plug.ex:17`

Description: `read_body/2` (Plug.Conn) can return `{:ok, body, conn}`, `{:more, partial_body, conn}`, or `{:error, reason}`. The `decode/2` private function only pattern-matches on `{:ok, body, conn}`. Any XML request whose body exceeds the read buffer length will return `{:more, …}` and cause a `FunctionClauseError` crash, producing an unhandled 500. Large XML payloads — a realistic scenario for the ABL record format used elsewhere in this codebase — will silently crash the parser process.

---

**B014-4** — [MEDIUM] Unreachable wildcard clause in `case` inside `decode/2`

File: `lib/api_server_web/xml_plug.ex:19-22`

Description: The `case XmlToMap.naive_map(body) do` block has two arms: a bare `map ->` binding (line 19) and `_ -> raise "Malformed XML"` (line 21). Because the first arm is an unconditional match with no guard, the second arm can never be reached. `XmlToMap.naive_map/1` either returns a value (matched by the first arm) or raises an exception (caught by the `rescue` block). The dead clause will produce an Elixir compiler warning about an unreachable clause, and a plain `raise "Malformed XML"` (a string, not an exception struct) would generate a non-standard error term even if it were reachable.

---

**B014-5** — [LOW] Commented-out `channel` declaration in UserSocket

File: `lib/api_server_web/channels/user_socket.ex:5`

Description: `# channel "room:*", ApiServerWeb.RoomChannel` is a commented-out code line, not a documentation comment. It is a Phoenix scaffold remnant that has never been activated. Its presence implies channels were once considered or are still planned, but no channel modules exist in the `channels/` directory. Dead placeholder code should be removed rather than left commented in source control.

---

**B014-6** — [LOW] Commented-out `transport` declaration for LongPoll

File: `lib/api_server_web/channels/user_socket.ex:9`

Description: `# transport :longpoll, Phoenix.Transports.LongPoll` is commented-out code. Given that the active WebSocket transport (line 8) is itself deprecated (see B014-1), this is doubly dead code. It should be removed.

---

**B014-7** — [LOW] Hardcoded session signing salt committed in source

File: `lib/api_server_web/endpoint.ex:39`

Description: `signing_salt: "5CSDVUtC"` is a short, hardcoded literal checked into version control. While the session is signed (not encrypted) so this alone does not expose session contents, the salt must be secret to prevent brute-force attacks against forged session cookies. It should be loaded from an environment variable or a secrets file excluded from source control (analogous to `secret_key_base`).

---

**B014-8** — [LOW] `gzip: false` hardcoded in `Plug.Static` with a comment acknowledging it should be `true` in production

File: `lib/api_server_web/endpoint.ex:8-11`

Description: The adjacent comment explicitly states "You should set gzip to true if you are running phoenix.digest when deploying your static files in production," yet the value is hardcoded `false` with no environment-conditional override in any config file. Production static assets are served without gzip compression, wasting bandwidth and increasing latency. The comment acknowledges the correct behavior but the code never implements it.

---

**B014-9** — [LOW] Trailing whitespace on blank line in endpoint.ex

File: `lib/api_server_web/endpoint.ex:41`

Description: Line 41 contains trailing whitespace (a blank line between `Plug.Session` and `CORSPlug` that contains spaces/tabs). This is a minor style defect but will cause diff noise and may trigger linter failures in CI if a whitespace check is added.

---

**B014-10** — [LOW] Inconsistent indentation within xml_plug.ex

File: `lib/api_server_web/xml_plug.ex`

Description: The file mixes indentation levels. The public `def parse/5` clauses at lines 6 and 13 use 4-space indentation inside the module (standard for Elixir). The private `defp decode/2` block at line 17 uses 8-space indentation for its body. Within `decode/2` the `case` body is at 12 spaces and the rescue is at 6 spaces. The `end` keywords do not align consistently with their opening constructs. This indicates the file was written or edited without a formatter (`mix format`) having been applied. In a project using `mix format`, this file would fail format checks.

---

**B014-11** — [INFO] `ApiServerWeb.UserSocket` registers no channels — socket endpoint may be unused

File: `lib/api_server_web/channels/user_socket.ex`
File: `lib/api_server_web/endpoint.ex:4`

Description: The WebSocket socket is mounted at `/socket` in the endpoint, but no channel routes exist in `UserSocket` and no channel modules exist in the `channels/` directory. The `connect/2` callback accepts all connections unconditionally. This is not a defect on its own (the socket may be used by a JavaScript client that only uses `connect`), but combined with B014-5 it suggests the channel infrastructure is entirely scaffolded and not yet operational. This may represent unnecessary attack surface.

---

## Summary Table

| ID | Severity | File | Short Title |
|---|---|---|---|
| B014-1 | HIGH | user_socket.ex:8 | Deprecated `transport/3` macro — build warning, breaks on upgrade |
| B014-2 | HIGH | xml_plug.ex:7,17 | `xml_decoder` option fetched but ignored — unused variable, false abstraction |
| B014-3 | HIGH | xml_plug.ex:17 | `decode/2` missing `:more` and `:error` clauses — crash on large bodies |
| B014-4 | MEDIUM | xml_plug.ex:19-22 | Unreachable wildcard `case` arm — compiler warning, dead code |
| B014-5 | LOW | user_socket.ex:5 | Commented-out `channel` scaffold line |
| B014-6 | LOW | user_socket.ex:9 | Commented-out `transport :longpoll` line |
| B014-7 | LOW | endpoint.ex:39 | Hardcoded session signing salt in source |
| B014-8 | LOW | endpoint.ex:11 | `gzip: false` never overridden for production despite advisory comment |
| B014-9 | LOW | endpoint.ex:41 | Trailing whitespace on blank line |
| B014-10 | LOW | xml_plug.ex (file-wide) | Inconsistent indentation — file not `mix format` compliant |
| B014-11 | INFO | user_socket.ex / endpoint.ex:4 | No channels registered — socket may be unnecessary attack surface |
# Pass 4 – B015

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B015

**Files reviewed:**
- `lib/api_server_web/controllers/calamp_controller.ex`
- `lib/api_server_web/controllers/digital_matter_controller.ex`
- `lib/api_server_web/controllers/fallback_controller.ex`
- `lib/api_server_web/controllers/file_controller.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/calamp_controller.ex`

**Module:** `ApiServerWeb.CalampController`

**Functions:**

| Name | Visibility | Line |
|------|------------|------|
| `recieve_calamp_data/2` | public | 4 |
| `validate/3` | private (`defp`) | 31 |

**Types / constants / errors defined:** None

**Notes on content:**
- `recieve_calamp_data/2` pattern-matches on `%{xml: calamp_data}` (atom key).
- Body contains `IO.inspect` call (line 10) left in production code.
- Contains commented-out step markers and two commented-out function calls (lines 23–24).
- `validate/3` at line 31 receives `thing` as third argument but never uses it inside the body.
- Return value of `validate/3` is discarded by the caller.
- `customer` is hardcoded to `"vx_dev"` (line 5).
- Module is **not wired to any router route** (confirmed by full router search).

---

### File 2: `lib/api_server_web/controllers/digital_matter_controller.ex`

**Module:** `ApiServerWeb.DigitalMatterController`

**Functions:**

| Name | Visibility | Line |
|------|------------|------|
| `get_g62_data/2` | public | 4 |

**Types / constants / errors defined:** None

**Notes on content:**
- `email_to`, `email_from`, `subject`, `data` are bound at lines 9–15 but immediately commented out and never used; they are dead variable bindings.
- Lines 17–18: two commented-out lines sending email.
- Lines 43–65: a large block of commented-out JSON sample data (example payload).
- Lines 95–101: inline comments documenting unmapped reason codes; these are legitimate documentation comments, not commented-out code.
- Lines 228–238: second commented-out email-sending block.
- `summary_update` is bound at line 225 but never read afterward.
- `hardware_type` hardcoded to `1` at line 122 with a comment stating "CalAmp, I think there are many calculations based on this."
- `custcode` hardcoded to `"CEA"` at line 181; `customer` hardcoded to `"vx_dev"` at line 200.
- `trip_hours` retrieved via `Enum.find` (line 33–36) but accessed unconditionally at line 139 (`trip_hours["Dur"]`) — will raise `FunctionClauseError` / `KeyError` if `trip_hours` is `nil` (no FType 26 field present).
- `driver_id` similarly retrieved via `Enum.find` (line 38–41) and then accessed at line 172 (`driver_id["DriverID"]`) without a nil-guard — same crash risk.
- `gps` retrieved via `Enum.find` (line 23–26) and accessed unconditionally at lines 151, 158, 165, 184, 189, 190, 193 — crash if FType 0 field absent.
- Response is assembled inside `Enum.each` but the final value of `Enum.each` (always `:ok`) is what `get_g62_data/2` returns to Phoenix, not the `conn` — meaning the function does not return a valid `Plug.Conn.t()` when the loop completes normally. The conn manipulation happens inside the `Enum.each` callback but is not returned.
- Uses `Plug.Conn` functions directly rather than the Phoenix controller helpers used elsewhere in the codebase.
- Uses `Poison` for JSON encoding (lines 208, 242, 246) while the rest of the project may use `Jason`.

---

### File 3: `lib/api_server_web/controllers/fallback_controller.ex`

**Module:** `ApiServerWeb.FallbackController`

**Functions:**

| Name | Visibility | Line |
|------|------------|------|
| `call/2` (Ecto.Changeset clause) | public | 9 |
| `call/2` (:not_found clause) | public | 15 |

**Types / constants / errors defined:** None

**Notes on content:**
- Clean, well-structured, has a `@moduledoc`.
- No style issues identified within the file itself.
- Does not handle `{:error, :unauthorized}` or `{:error, :forbidden}` — common cases that other controllers may need. This is an INFO-level observation (by itself not a defect in this file).

---

### File 4: `lib/api_server_web/controllers/file_controller.ex`

**Module:** `ApiServerWeb.FileController`

**Functions:**

| Name | Visibility | Line |
|------|------------|------|
| `get_size/2` | public | 12 |
| `send_file_download/2` | public | 28 |
| `generate_binary_file_contents/1` | private (`defp`) | 42 |
| `check_crc/1` | private (`defp`) | 52 |

**Types / constants / errors defined:** None

**Notes on content:**
- Aliases defined: `ApiServer.Operators` (line 4), `ApiServer.Operators.File` (line 5), `ApiServer.Vx` (line 7), `ApiServer.Vx.VXAccessFob` (line 8).
- `ApiServer.Operators`, `ApiServer.Operators.File`, and `ApiServer.Vx.VXAccessFob` are aliased but **never referenced** in the file body — only `Vx` is used.
- `IO.puts` debug calls left in `get_size/2` (line 16) and `generate_binary_file_contents/1` (lines 45–47).
- `check_crc/1` closing `end` at line 63 is not indented — it sits at column 0, mismatched with the rest of the file's 2-space indentation style.
- `check_crc/1` is not exhaustive: only handles CRC strings of length 1–4; a zero-length string or a string longer than 4 characters will raise a `FunctionClauseError`. A CRC value of 0 produces an empty string from `Integer.to_string/2`, which would not match any clause.
- `get_size/2` and `send_file_download/2` duplicate the fleet-reduction expression verbatim (lines 18 and 30).

---

## Findings

**B015-1** — [HIGH] Misspelled public function name `recieve_calamp_data`
File: `lib/api_server_web/controllers/calamp_controller.ex:4`
Description: The function is spelled `recieve_calamp_data` (transposing 'e' and 'i'). The correct spelling is `receive`. This is the only public action in the module, and any route or external caller must use the misspelled name. Renaming without a coordinated router update would be a breaking change. The misspelling pollutes the public API surface indefinitely.

---

**B015-2** — [HIGH] `CalampController` is not reachable — no router entry
File: `lib/api_server_web/controllers/calamp_controller.ex:1`
Description: A search of the entire router (`router.ex`) finds no reference to `CalampController` or `recieve_calamp_data`. The module exists with production-like logic but is unreachable by any HTTP request. It is either abandoned dead code or was accidentally omitted from the router. Dead controller modules bloat the build artifact and confuse maintainers.

---

**B015-3** — [HIGH] `Enum.each` used to build HTTP responses — `conn` is never returned
File: `lib/api_server_web/controllers/digital_matter_controller.ex:20`
Description: The entire record-processing loop runs inside `Enum.each`, whose return value is always `:ok`. The `conn` mutations inside the callback are never propagated back to the outer scope. Phoenix requires a controller action to return a `Plug.Conn.t()`. When `records` is non-empty the function silently returns `:ok` to the framework instead of a modified `conn`, producing an undefined response. When `records` is empty the same occurs. This is a structural correctness defect.

---

**B015-4** — [HIGH] Unconditional field access on potentially-nil `Enum.find` results
File: `lib/api_server_web/controllers/digital_matter_controller.ex:139`
Description: `trip_hours` (line 33), `gps` (line 23), and `driver_id` (line 38) are each obtained via `Enum.find`, which returns `nil` if no matching field is present. All three are subsequently accessed with map bracket notation without nil-guards: `trip_hours["Dur"]` (line 139), `gps["Alt"]` / `gps["Head"]` / etc. (lines 151–193), and `driver_id["DriverID"]` (line 172). Any record lacking FType 0, 26, or 3 will raise an `ArgumentError` / `FunctionClauseError` at runtime, crashing the request process.

---

**B015-5** — [MEDIUM] Unused bound variables `email_to`, `email_from`, `subject`, `data`
File: `lib/api_server_web/controllers/digital_matter_controller.ex:9`
Description: Four variables are bound at lines 9–15 whose only consumer is the commented-out email call on lines 17–18. Because the email code is commented out, these bindings serve no purpose and will generate Elixir compiler warnings (`variable "email_to" is unused`, etc.). Variables intended to be deliberately unused must be prefixed with `_`.

---

**B015-6** — [MEDIUM] Unused bound variable `summary_update`
File: `lib/api_server_web/controllers/digital_matter_controller.ex:225`
Description: `summary_update` is assigned the return value of `update_thing_cached_fields/2` but is never read. This will generate an Elixir compiler warning. More importantly, if `update_thing_cached_fields` returns an error tuple, that error is silently swallowed with no logging or response branching.

---

**B015-7** — [MEDIUM] Unused aliases in `FileController`
File: `lib/api_server_web/controllers/file_controller.ex:4`
Description: Three aliases are declared but never referenced in the module body:
- `alias ApiServer.Operators` (line 4)
- `alias ApiServer.Operators.File` (line 5)
- `alias ApiServer.Vx.VXAccessFob` (line 8)

Elixir will emit compiler warnings for unused aliases. The `ApiServer.Operators.File` alias additionally shadows the standard library `File` module, which can cause confusion if `File` is ever referenced.

---

**B015-8** — [MEDIUM] `validate/3` third argument `thing` is unused
File: `lib/api_server_web/controllers/calamp_controller.ex:31`
Description: `defp validate(new_event, current_event, thing)` receives `thing` as the third parameter but the body never references it. Elixir will emit a compiler warning. Because `thing` is not prefixed with `_`, the intent is unclear — it may indicate unfinished validation logic (the surrounding step comments "2. Save the record if valid" suggest intentional incompleteness).

---

**B015-9** — [MEDIUM] Return value of `validate/3` is discarded
File: `lib/api_server_web/controllers/calamp_controller.ex:17`
Description: `validate(new_event, thing_event, thing)` is called at line 17 but its return value is not captured. The function currently returns the result of the last `IO.puts` call (`:ok`). Step comments in the caller ("2. Save the record if valid") indicate the validation result was intended to gate a save operation. Discarding it means no validation-gated branching occurs.

---

**B015-10** — [MEDIUM] `check_crc/1` is non-exhaustive — zero or >4 hex digit CRC causes crash
File: `lib/api_server_web/controllers/file_controller.ex:52`
Description: `check_crc/1` uses a `case` that handles only string lengths 1–4. A CRC of 0 would produce the empty string `""` via `Integer.to_string(0, 16)` → `"0"` (length 1, actually safe), but any CRC whose hex representation exceeds 4 characters — which cannot occur for a 16-bit CRC — is theoretically safe. However, the case has no catch-all (`_`) clause, so any unexpected input length raises `CaseClauseError`. The absence of a guard is a latent fragility even if the 16-bit domain prevents it today.

---

**B015-11** — [LOW] Commented-out code blocks — `calamp_controller.ex` lines 23–24
File: `lib/api_server_web/controllers/calamp_controller.ex:23`
Description: Two function calls are commented out:
```
# ApiServer.VXThingSummary.validate_for_hardwareid(hardwareid, customer)
# ApiServer.VXThingInfo.validateForHardwareId(hardwareid, customer)
```
These represent steps 3 and 4 described in the adjacent step comments. It is unclear whether the underlying functions still exist or are intended to be re-enabled. Commented-out code should be removed or replaced with a tracked issue.

---

**B015-12** — [LOW] Commented-out code blocks — `digital_matter_controller.ex` lines 17–18 and 228–238
File: `lib/api_server_web/controllers/digital_matter_controller.ex:17`
Description: Two separate email-sending blocks are commented out. The first (lines 17–18) is paired with dead variable bindings (see B015-5). The second (lines 228–238) is a multi-line block. Both reference `ApiServer.Email.send_digital_matter_email` and `ApiServer.Mailer.deliver_now`. Retaining commented-out code obscures intent and creates confusion about whether the email feature is intended to be active.

---

**B015-13** — [LOW] Commented-out example payload block — `digital_matter_controller.ex` lines 43–65
File: `lib/api_server_web/controllers/digital_matter_controller.ex:43`
Description: A 23-line block of commented-out JSON-like sample data sits inside a production function. Sample/reference data should live in tests or documentation, not in controller source.

---

**B015-14** — [LOW] `IO.inspect` / `IO.puts` debug output left in production code
File: `lib/api_server_web/controllers/calamp_controller.ex:10` and `lib/api_server_web/controllers/file_controller.ex:16,45,47` and `lib/api_server_web/controllers/calamp_controller.ex:34,40,43`
Description: Multiple `IO.inspect` and `IO.puts` calls are present in production controller and helper code:
- `calamp_controller.ex` line 10: `|> IO.inspect` in the pipeline
- `calamp_controller.ex` lines 34, 40, 43: `IO.puts` in `validate/3`
- `file_controller.ex` line 16: `IO.puts` in `get_size/2`
- `file_controller.ex` lines 45, 47: `IO.puts` in `generate_binary_file_contents/1`

These will emit output to stdout in production, polluting logs and potentially leaking internal data values (hardware IDs, CRC values, event diffs).

---

**B015-15** — [LOW] Inconsistent indentation — `calamp_controller.ex` uses 4-space, rest use 2-space
File: `lib/api_server_web/controllers/calamp_controller.ex:1`
Description: `calamp_controller.ex` indents with 4 spaces throughout (visible on lines 5–17, 32–43), while `digital_matter_controller.ex`, `fallback_controller.ex`, and `file_controller.ex` all use 2-space indentation consistent with the Elixir community standard and the rest of the codebase. This inconsistency suggests the file was written with a different editor configuration.

---

**B015-16** — [LOW] `check_crc/1` closing `end` has incorrect indentation
File: `lib/api_server_web/controllers/file_controller.ex:63`
Description: The closing `end` for `check_crc/1` is at column 0 (line 63), while the `defp check_crc(crc_string) do` opener is at 2-space indent (line 52) and the `case` body is at 4-space indent. This is a formatting error that will cause `mix format` to reformat it.

---

**B015-17** — [LOW] Duplicated fleet-reduction expression in `FileController`
File: `lib/api_server_web/controllers/file_controller.ex:18,30`
Description: The expression `Enum.reduce(thing.fleet_thing_joins, [], fn(fleet_join, acc) -> acc ++ ["#{fleet_join.aafgroupid}"] end)` is copy-pasted verbatim in both `get_size/2` (line 18) and `send_file_download/2` (line 30). This violates DRY and means any future fix must be applied in two places. It should be extracted to a private helper.

---

**B015-18** — [LOW] Hardcoded customer codes and hardware type constants
File: `lib/api_server_web/controllers/calamp_controller.ex:5`, `lib/api_server_web/controllers/digital_matter_controller.ex:122,181,200`
Description: Business-significant values are hardcoded as string/integer literals with no named constant or configuration:
- `"vx_dev"` customer in `calamp_controller.ex:5` and `digital_matter_controller.ex:200`
- `"CEA"` customer code in `digital_matter_controller.ex:181`
- `hardware_type = 1` in `digital_matter_controller.ex:122` (comment reads "CalAmp, I think there are many calculations based on this")

Using unnamed magic values makes it impossible to change them in one place and increases the risk that only some occurrences are updated.

---

**B015-19** — [LOW] Direct `Plug.Conn` calls instead of Phoenix controller helpers in `[REDACTED-AWS-SMTP-PASSWORD]`
File: `lib/api_server_web/controllers/digital_matter_controller.ex:205`
Description: `digital_matter_controller.ex` uses `Plug.Conn.put_resp_header/3` and `Plug.Conn.send_resp/3` directly (lines 205–209, 241–242, 245–246) rather than the Phoenix `put_resp_header`, `json`, or `send_resp` helpers already imported via `use ApiServerWeb, :controller`. This is inconsistent with every other controller in the codebase and bypasses Phoenix's content negotiation layer.

---

**B015-20** — [INFO] `FallbackController` does not handle `{:error, :unauthorized}` or `{:error, :forbidden}`
File: `lib/api_server_web/controllers/fallback_controller.ex:9`
Description: Only two error shapes are handled. If any controller action returns `{:error, :unauthorized}` or similar atoms, the fallback will raise a `FunctionClauseError` rather than rendering a graceful 401/403 response. This is an observation about missing coverage rather than a defect in the existing clauses.

---

## Summary Table

| ID | Severity | File | Short Title |
|----|----------|------|-------------|
| B015-1 | HIGH | calamp_controller.ex:4 | Misspelled public function name `recieve_calamp_data` |
| B015-2 | HIGH | calamp_controller.ex:1 | `CalampController` unreachable — no router entry |
| B015-3 | HIGH | digital_matter_controller.ex:20 | `Enum.each` used for HTTP responses — `conn` never returned |
| B015-4 | HIGH | digital_matter_controller.ex:139 | Unconditional access on potentially-nil `Enum.find` results |
| B015-5 | MEDIUM | digital_matter_controller.ex:9 | Unused bound variables (`email_to`, `email_from`, `subject`, `data`) |
| B015-6 | MEDIUM | digital_matter_controller.ex:225 | Unused bound variable `summary_update` — error silently swallowed |
| B015-7 | MEDIUM | file_controller.ex:4 | Three unused aliases (compiler warnings + `File` shadow) |
| B015-8 | MEDIUM | calamp_controller.ex:31 | `validate/3` third argument `thing` unused — compiler warning |
| B015-9 | MEDIUM | calamp_controller.ex:17 | Return value of `validate/3` discarded — validation not gating saves |
| B015-10 | MEDIUM | file_controller.ex:52 | `check_crc/1` non-exhaustive case — no catch-all clause |
| B015-11 | LOW | calamp_controller.ex:23 | Commented-out code (steps 3 & 4 function calls) |
| B015-12 | LOW | digital_matter_controller.ex:17 | Commented-out code (two email-sending blocks) |
| B015-13 | LOW | digital_matter_controller.ex:43 | Commented-out sample payload inside production function |
| B015-14 | LOW | multiple | `IO.inspect`/`IO.puts` debug output in production code (7 occurrences) |
| B015-15 | LOW | calamp_controller.ex:1 | 4-space indentation inconsistent with 2-space codebase standard |
| B015-16 | LOW | file_controller.ex:63 | `check_crc/1` closing `end` at column 0 — broken indentation |
| B015-17 | LOW | file_controller.ex:18,30 | Duplicated fleet-reduction expression across two actions |
| B015-18 | LOW | multiple | Hardcoded magic constants (`"vx_dev"`, `"CEA"`, `hardware_type = 1`) |
| B015-19 | LOW | digital_matter_controller.ex:205 | Direct `Plug.Conn` calls instead of Phoenix controller helpers |
| B015-20 | INFO | fallback_controller.ex:9 | `FallbackController` missing clauses for `:unauthorized`/`:forbidden` |

**Totals:** 4 HIGH, 6 MEDIUM, 9 LOW, 1 INFO
# Pass 4 – B016

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01

**Files reviewed:**
- `lib/api_server_web/controllers/geofence_controller.ex` (206 lines)
- `lib/api_server_web/controllers/page_controller.ex` (7 lines)
- `lib/api_server_web/controllers/pivotel_controller.ex` (115 lines)
- `lib/api_server_web/controllers/utility_controller.ex` (6,293 lines)

---

## Reading Evidence

### geofence_controller.ex

**Module:** `ApiServerWeb.GeofenceController`

**Aliases/Imports:**
- `ApiServer.Vx` (alias)
- `ApiServer.Vx.Geofence` (alias)
- `Ecto.Query` (import, warn: false)
- `ApiServer.Repo` (alias)

**Public functions:**
| Function | Line |
|---|---|
| `list_all_geofences/2` | 11 |
| `create_geofence/2` | 18 |
| `update_geofence/2` | 35 |
| `delete_geofence/2` | 57 |
| `process_things_geofences/2` | 73 |

**Private functions:**
| Function | Line |
|---|---|
| `check_geofences_for_unit/6` | 96 |
| `does_event_cause_geofence_events/6` | 115 |
| `check_event_for_left_events/6` (nil clause) | 132 |
| `check_event_for_left_events/6` (list clause) | 133 |
| `check_event_for_entered_events/7` | 149 |
| `make_geofence_event/6` | 168 |
| `engine_hours_at_event/3` | 184 |

**Constants/Types defined:** none

---

### page_controller.ex

**Module:** `ApiServerWeb.PageController`

**Public functions:**
| Function | Line |
|---|---|
| `index/2` | 4 |

**Constants/Types defined:** none

---

### pivotel_controller.ex

**Module:** `ApiServerWeb.PivotelController`

**Public functions:**
| Function | Line |
|---|---|
| `get_pivotel_data/2` (PSG_MOmsg_send clause) | 4 |
| `get_pivotel_data/2` (catch-all clause) | 15 |
| `create_update_object/1` (LOCATION clause) | 20 |
| `create_update_object/1` (ACCUM clause) | 63 |
| `create_update_object/1` (catch-all clause) | 103 |

**Private functions:**
| Function | Line |
|---|---|
| `convert_timestamp/1` | 109 |

**Constants/Types defined:** none

---

### utility_controller.ex

**Module:** `ApiServerWeb.UtilityController`

**Module-level attributes/constants:**
| Name | Line |
|---|---|
| `@lookup_olson` (list of 2-tuples, timezone mapping) | 25–126 |

**Aliases/Imports:**
- `Ecto.Query` (import, warn: false)
- `ApiServer.Vx`
- `ApiServer.Vx.VXCustomer`
- `ApiServer.Vx.ERPImport`
- `ApiServer.Vx.VXThingInfo`
- `ApiServer.Repo`
- `ApiServer.Vx.VXThingEvent`
- `ApiServer.Vx.VXThingEventOmega`
- `ApiServer.Vx.VXThingEventOmegaTires`
- `ApiServer.Vx.VXRayvenMessageLog`
- `ApiServer.Vx.VXRayvenStreamStatus`
- `ApiServer.Vx.DeviceDatabaseLookup`
- `ApiServer.Vx.VXThingSummary`
- `ApiServer.Vx.Equipment`
- `ApiServer.Vx.EquipmentAssignment`
- `ApiServer.Vx.VXRental`
- `ApiServer.Vx.RentalPeriod`
- `ApiServer.Vx.RentalContract`

**Public functions:**
| Function | Line |
|---|---|
| `update_puls_firmware/1` | 128 |
| `bulk_daily_usage_summary/1` | 228 |
| `do_health_check/2` | 320 |
| `calculate_roi_value/2` | 324 |
| `process_incoming_omegawatch_data/2` | 328 |
| `process_prodisplay_event/2` | 333 |
| `do_error/2` | 982 |
| `do_geocode_lookup/2` | 991 |
| `sync_to_DISCorp/2` | 1052 |
| `sync_vehicles_to_rayven/1` | 1076 |
| `test_rental_messages/1` | 1203 |
| `send_vehicle_to_rayven/2` | 1445 |
| `send_to_rayven/7` | 1677 |
| `pull_from_rayven/1` | 1986 |
| `check_out_of_sequence_events/1` | 2009 |
| `get_tracker_ids/0` | 2078 |
| `device_lookup_with_hardware_id/1` | 2093 |
| `check_vehicles_for_rental_overage/3` | 2100 |
| `process_monthly_movements/0` | 2280 |
| `process_pronto/0` | 2463 |
| `process_ebs/0` | 2821 |
| `process_ebs_check_service/1` | 2972 |
| `process_ebs_get_hour_meter/2` | 2990 |
| `send_local_arrow_data/0` | 3036 |
| `check_vehicles_for_no_usage_historical/1` | 3170 |
| `process_events_for_next_usage/4` | 3213 |
| `sync_events_to_rayven/0` | 3298 |
| `rayven_login/2` | 3346 |
| `get_rayven_devices_for_project/2` | 3390 |
| `pull_data_from_rayven/1` | 3412 |
| `create_equipment/3` | 3453 |
| `get_equipment_id/2` | 3524 |
| `create_equipment_assignment/3` | 3533 |
| `create_rental_records/1` | 3596 |
| `sync_rental_contracts_to_rayven/1` | 3600 |
| `sync_rental_periods_to_rayven/1` | 3615 |
| `copy_rental_contracts/1` | 3623 |
| `pull_equipment_data_from_rayven/1` | 4647 |
| `pull_services_from_rayven/1` | 4729 |
| `refresh_rayven_stream_status/1` | 4900 |
| `sync_historical_events_to_rayven/1` | 5020 |
| `sync_historical_events_to_rayven/5` | 5091 |
| `send_events_to_rayven/6` | 5358 |
| `prepare_rayven_events/3` | 5416 |
| `check_for_future_date/2` | 5567 |
| `erp_import/2` | 5666 |
| `driverid_converter/2` | 6025 |
| `get_additional_data/1` | 6172 |
| `next_service/1` | 6225 |

**Private functions:**
| Function | Line |
|---|---|
| `parse_prodisplay_thingevent/4` (with `@doc`) | 701 |
| `parse_prodisplay_thingomega_event/5` (with `@doc`) | 806 |
| `parse_prodisplay_thingomegatires_event/5` (with `@doc`) | 923 |
| `check_and_save_erp_record/3` | 5735 |
| `process_rental_from_erp/2` | 5758 |
| `find_or_make_customer/3` | 5850 |
| `process_services_from_erp/2` | 5882 |
| `process_service_from_erp/2` | 5896 |
| `get_dm_driverid/1` | 6092 |
| `rayven_ssl_opts/0` | 6267 |
| `rayven_cacerts/0` | 6278 |

**Aliases never referenced in code:**
- `ApiServer.Vx.VXCustomer` (aliased at line 7, not used in any function body visible in the file)
- `ApiServer.Vx.ERPImport` (aliased at line 8, not used)
- `ApiServer.Vx.VXThingInfo` (aliased at line 9, not used — the module is called via full name `ApiServer.Vx.VXThingInfo.service_performed/3` at line 5950 through the `Vx` alias)
- `ApiServer.Vx.VXThingEventOmega` (aliased at line 12, not directly used in any pattern or struct literal)
- `ApiServer.Vx.VXThingEventOmegaTires` (aliased at line 13, not directly used)
- `ApiServer.Vx.VXThingSummary` (aliased at line 17, not used)
- `ApiServer.Vx.Equipment` (aliased at line 18, not used)
- `ApiServer.Vx.EquipmentAssignment` (aliased at line 19, not used)
- `ApiServer.Vx.RentalPeriod` (aliased at line 21, not used)
- `ApiServer.Vx.RentalContract` (aliased at line 22, not used)

---

## Findings

---

**B016-1** — [MEDIUM] `IO.inspect` left in production error path

File: `lib/api_server_web/controllers/geofence_controller.ex:30`

Description: `IO.inspect error` is called unconditionally inside the `{:error, error}` branch of `create_geofence/2` before sending a 500 response. This logs internal changeset error detail (including field names and constraint violations) to stdout/logs in production. It is a debug statement that was never removed. Additionally, the raw `inspect error` string is interpolated directly into the JSON response body at line 31, leaking internal Ecto changeset structure to API callers.

---

**B016-2** — [LOW] Commented-out code in `geofence_controller.ex`

File: `lib/api_server_web/controllers/geofence_controller.ex:89`

Description: Line 89 contains the comment `# Grab all geofences and convert them for assessment by topo`. This is a descriptive inline comment and acceptable, but lines within `check_geofences_for_unit/6` initialize `inList = []` at line 97 which is immediately shadowed by the `Enum.reduce` destructure and the variable `inList` is never subsequently read. This is a bound-but-never-used variable (see B016-3 below). Note: there are no full commented-out code blocks in this file.

---

**B016-3** — [LOW] Variable `inList` bound but never used

File: `lib/api_server_web/controllers/geofence_controller.ex:97`

Description: `inList = []` is assigned at line 97 inside `check_geofences_for_unit/6`, but the variable is never referenced again. The `Enum.reduce` on line 103 uses its own anonymous function parameter `in_list` (initially `[]`). Without a leading underscore, Elixir will emit a compiler warning `variable "inList" is unused`. This is dead initialization code.

---

**B016-4** — [MEDIUM] Variable shadowing in `does_event_cause_geofence_events/6` — bound result never used

File: `lib/api_server_web/controllers/geofence_controller.ex:120-121`

Description: Inside the `%Timex.AmbiguousDateTime{}` match, `datetime = Map.get(adt, :after)` assigns to `datetime` at line 121, but that variable is never returned or referenced — the `case` expression is itself bound to `event_time`. The inner `datetime` assignment is dead code. Elixir will warn that `datetime` is unused.

---

**B016-5** — [MEDIUM] Wrong return value from `check_event_for_left_events/6` nil clause

File: `lib/api_server_web/controllers/geofence_controller.ex:132`

Description: The nil-clause of `check_event_for_left_events/6` returns `[]` (a bare list) instead of `{[], []}` (a two-tuple). The caller at line 126 destructures the result as `{fences_still_inside, left_events}`. If `in_geofences` is `nil`, this clause will cause a `MatchError` at runtime. This is a latent crash bug.

---

**B016-6** — [LOW] Inconsistent use of `nil` vs `false` guard in `geofence_controller.ex`

File: `lib/api_server_web/controllers/geofence_controller.ex:40,61`

Description: `update_geofence/2` checks `if geofence != nil` (line 40) while `delete_geofence/2` uses `if geofence` (line 61). These are semantically equivalent for Elixir truthy evaluation but are stylistically inconsistent within the same file. The idiomatic Elixir form is `if geofence do` or pattern-match with `case`.

---

**B016-7** — [LOW] Commented-out code in `pivotel_controller.ex`

File: `lib/api_server_web/controllers/pivotel_controller.ex:9`

Description: `# IO.inspect update` at line 9 is a debug statement that was commented out but left in the source. Commented-out code of this form should be removed.

---

**B016-8** — [LOW] `IO.puts` debug statements left in production controller

File: `lib/api_server_web/controllers/pivotel_controller.ex:5,8,47,104`

Description: Four `IO.puts` calls remain in production paths of `PivotelController`: lines 5 (`"PSG_MOmsg_send"`), 8 (`"Update for ..."`), 47 (`"Need to store a location event"`), and 104 (`"Unprocessable Message"`). These will emit to stdout on every request and in every unmatched message, polluting logs with no structured metadata.

---

**B016-9** — [LOW] `create_update_object/1` is public but is only called internally

File: `lib/api_server_web/controllers/pivotel_controller.ex:20`

Description: `create_update_object/1` is defined as `def` (public) but is called only from within `get_pivotel_data/2` in the same module. It should be `defp`. Exposing it as a public function widens the module's API surface unnecessarily and makes it callable from tests or other modules as though it were a stable interface.

---

**B016-10** — [MEDIUM] `@doc` on `defp` functions is silently ignored by Elixir

File: `lib/api_server_web/controllers/utility_controller.ex:697,802,919`

Description: Three private functions carry `@doc` strings:
- `parse_prodisplay_thingevent/4` at line 701 (doc at 697)
- `parse_prodisplay_thingomega_event/5` at line 806 (doc at 802)
- `parse_prodisplay_thingomegatires_event/5` at line 923 (doc at 919)

Elixir silently discards `@doc` attributes placed before `defp`. These docstrings will never appear in `ExDoc` output or `IEx.h/1`. The developer intent is not realized and the documentation is effectively dead. The correct approach is either to make the functions `def` (if documentation is truly needed) or remove the `@doc` annotations.

---

**B016-11** — [HIGH] Large commented-out function `send_rentals_to_rayven/2`

File: `lib/api_server_web/controllers/utility_controller.ex:1245–1443`

Description: Lines 1245–1443 contain a 199-line block of commented-out code comprising what appears to be the entire abandoned implementation of `send_rentals_to_rayven/2`. The function `test_rental_messages/1` at line 1203 still references this function at line 1231 via a comment (`# send_rentals_to_rayven(thing, customer)`). This dead code block is a significant maintenance hazard: it contains hardcoded customer strings, rental data structures, and business logic that is no longer executed, yet may mislead future developers about the intended behavior.

---

**B016-12** — [HIGH] Hardcoded API keys and credentials in source code

File: `lib/api_server_web/controllers/utility_controller.ex:141,146,151,171,1053,1747,1861–1888,1918,2000`

Description: Multiple hardcoded secrets and API credentials appear directly in source code:
- Line 141: `# API Key for old account: IwZTptJkQeOxZCoKRKVtI3IrIVwotFW6KRDS8O8OI-RKjmykQ95DPGlEE4yxjqbg` (commented, but still present in VCS history)
- Line 141: `# API Key for new account: 1SdeU1293s78waU_2P3vwCInz2oEOe-Rj6_AYqL-FwBzFtsG3n_o5mNsqat5rO4L` (commented)
- Line 146: Live API key in URL string `IwZTptJkQeOxZCoKRKVtI3IrIVwotFW6KRDS8O8OI-RKjmykQ95DPGlEE4yxjqbg` used in production HTTP call
- Line 151: `Authorization: "Basic VHJhY2tpbmdTb2x1dGlvbnM6dHZWSFFVc0NBZXU0"` — hardcoded Basic Auth
- Line 171: Live API key `1SdeU1293s78waU_2P3vwCInz2oEOe-Rj6_AYqL-FwBzFtsG3n_o5mNsqat5rO4L`
- Line 1053: `api_key = "PZPwWHyAMFhPbt3UB8PWXtEw"` (DISCorp API key hardcoded, used in a live HTTP POST)
- Line 1747: `uid = "3470e0a6599bbdc8488db6965597eab43728"` (Rayven UID hardcoded in `send_to_rayven/7`)
- Line 1861: `uid = "1964374994320a294ecaabd94c23f0ce911d"` (Rayven UID hardcoded in `copy_rental_contracts/1`)

These credentials are stored in plaintext in version control. Even the commented-out keys remain in git history. All secrets should be moved to application configuration or environment variables.

---

**B016-13** — [MEDIUM] Hardcoded email address in production code

File: `lib/api_server_web/controllers/utility_controller.ex:1703,1725,2251,2252,5387,5610`

Description: Personal email addresses (`graham.oconnell@trackingsolutions.com.au`, `rhythmduwadi@collectiveintelligence.com.au`, `sidney@collectiveintelligence.com.au`) are hardcoded as alert/report recipients in multiple functions. This means changing recipients requires a code change and deployment. They should be read from application configuration.

---

**B016-14** — [MEDIUM] Hardcoded test dates used in production functions

File: `lib/api_server_web/controllers/utility_controller.ex:240-241,1182,2023-2025,3310`

Description: Several functions use hardcoded date strings that were clearly set during development and never parameterized:
- `bulk_daily_usage_summary/1` (line 240): `to_date = "2021-06-18"`, `from_date = "2021-01-01"`
- `check_out_of_sequence_events/1` (line 2023): `from_date = "2018-07-01"`, `to_date = "2020-04-26"`
- `sync_events_to_rayven/0` (line 3310): `{:ok, start_date} = Timex.parse("2020-01-23", ...)`
- `sync_historical_events_to_rayven/5` (line 5240): `{:ok, now} = Timex.parse("2050-12-30", ...)` used as the "end date"

These hardcoded dates mean the functions produce different results (or no results) depending on when they are run and cannot be used correctly without code modification.

---

**B016-15** — [MEDIUM] Variables bound but never used — compiler warnings in `utility_controller.ex`

File: `lib/api_server_web/controllers/utility_controller.ex` (multiple locations)

Description: Multiple variables are bound and their values are never subsequently read, generating Elixir compiler warnings:

- Line 657: `summary_update = ApiServerWeb.VXThingController.update_thing_cached_fields(...)` — result bound but not used (repeated in the vx_mondialevgl and vx_sssl branches at lines 532, 538, 663–667)
- Lines 1668, 1674: `diff = Timex.diff(...)` bound twice in `send_vehicle_to_rayven/2`, neither value used
- Line 2047: `usage_diff = event.calcengineseconds - previous_usage` in `check_out_of_sequence_events/1` — bound inside a `case` arm but not returned or used
- Lines 2075–2076: `diff = Timex.diff(finish, start, :milliseconds)` in `check_out_of_sequence_events/1` — computed but never logged or returned
- Line 3343–3344: `diff = Timex.diff(start, finish, :milliseconds)` in `sync_events_to_rayven/0` — computed but never used
- Line 6077: `acc = acc ++ [[dm_driverid, weigand_driverid]]` in `driverid_converter/2` — reassigned to `acc` inside a `fn` passed to `Enum.reduce`, but the variable rebinding is a warning-inducing pattern (the reducer should return the new acc without rebinding)
- Line 6173, 6226: `start = Timex.now()` at the top of `get_additional_data/1` and `next_service/1` — timing values computed but never used (no `finish` or `diff` in either function)

---

**B016-16** — [HIGH] Empty function bodies — functions that do nothing

File: `lib/api_server_web/controllers/utility_controller.ex:324–326,3596–3598,3600–3613,3615–3621`

Description: Four public functions have empty or near-empty bodies that produce no effect:

- `calculate_roi_value/2` (line 324–326): Body is entirely blank — no return value, no side effects. Any call returns `nil`. It is a stub function that appears to be registered in the router.
- `create_rental_records/1` (line 3596–3598): Empty body — documented with a comment about its intent but never implemented.
- `sync_rental_contracts_to_rayven/1` (line 3600–3613): Body only constructs an anonymous map literal `%{trigger: "rental"}` that is immediately discarded; the return value is the map, not a sent HTTP request. Function is a stub.
- `sync_rental_periods_to_rayven/1` (line 3615–3621): Returns an empty map `%{}` — stub function.

These stubs are reachable (public `def`, likely wired in the router) but silently do nothing, making any call to them a no-op. This is particularly dangerous for `calculate_roi_value/2` which accepts `conn` and never sends a response, leaving the connection open.

---

**B016-17** — [LOW] Commented-out code blocks in `utility_controller.ex` — `process_monthly_movements/0`

File: `lib/api_server_web/controllers/utility_controller.ex:2421–2431`

Description: Lines 2421–2431 contain a commented-out block of code that was sending data to Rayven IOTX8 via HTTP. The comment `# # # Send to Rayven IOTX8` and subsequent commented lines are dead code left during development. The same pattern appears again in `process_ebs/0` at lines 2929–2941.

---

**B016-18** — [LOW] Commented-out code blocks in `utility_controller.ex` — `pull_equipment_data_from_rayven/1`

File: `lib/api_server_web/controllers/utility_controller.ex:4709–4726`

Description: Lines 4709–4726 contain a large block of commented-out code (`response = HTTPoison.get!(url)` and a `case` block with full service-record logic). Similarly, lines 4839–4884 in `pull_services_from_rayven/1` contain two separate commented-out `body` construction blocks and a commented JavaScript snippet. These are remnants of prior iterations that should be removed.

---

**B016-19** — [LOW] Commented-out code in `rayven_login/2` — function is entirely commented code

File: `lib/api_server_web/controllers/utility_controller.ex:3346–3388`

Description: `rayven_login/2` has an empty body (returns `nil`) while the entire "implementation" is a 40-line block of commented-out JavaScript code (a `fetch` call with headers and auth). The function is dead: it accepts two parameters and does absolutely nothing with them. The commented JavaScript code serves no purpose in an Elixir codebase.

---

**B016-20** — [MEDIUM] Commented-out `@doc` email code causes silent no-ops for email alerts

File: `lib/api_server_web/controllers/utility_controller.ex:1707–1708,1729–1730,5390–5391,5613–5614,5654–5655`

Description: Email alert calls are systematically commented out throughout `utility_controller.ex`. At lines 1707–1708 and 1729–1730 in `send_to_rayven/7`, the missing-serial-number email is commented out after the variables `email_to`, `email_from`, `subject`, and `data` are fully constructed. The same pattern appears in `check_for_future_date/2` (lines 5613–5614) and `send_events_to_rayven/6` (lines 5390–5391). This means:
1. The variable-binding code above each comment still executes (computing `email_to`, `data`, etc.)
2. No email is ever sent
3. The bound variables emit compiler warnings about being unused

The feature appears unfinished — the infrastructure is built but the delivery call is permanently disabled.

---

**B016-21** — [HIGH] Massive copy-paste duplication in `process_prodisplay_event/2`

File: `lib/api_server_web/controllers/utility_controller.ex:333–694`

Description: The `process_prodisplay_event/2` function (lines 333–694, approximately 362 lines) contains three near-identical code paths that handle event ingestion for three different customers (`vx_ceaomega`, `vx_sssl`, `vx_mondialevgl`). Each path:
1. Creates a thingevent record
2. Creates a thingomega record
3. Creates a thingomegatires record
4. Updates cached fields
5. Returns an HTTP response or error

The logic for steps 2–5 is duplicated nearly verbatim across the three branches, differing only in the customer string and the variable names prefixed with `sssl_`. This function should be refactored into a private helper that takes a customer string and event_id.

---

**B016-22** — [MEDIUM] Copy-paste duplication of date-formatting code

File: `lib/api_server_web/controllers/utility_controller.ex:3799–3821,3823–3847,4087–4108,4224–4271,4387–4434,4483–4532`

Description: Throughout `copy_rental_contracts/1` and `sync_rental_contracts_to_rayven/1`, the same 15-line block that converts a `Date` to a padded `"DD/MM/YYYY"` string appears at least six times verbatim:

```elixir
{year, month, day} = Date.to_erl(some_date)
year = Integer.to_string(year)
month = case month do
  x when x < 10 -> "0" <> Integer.to_string(month)
  _ -> Integer.to_string(month)
end
day = case day do
  x when x < 10 -> "0" <> Integer.to_string(day)
  _ -> Integer.to_string(day)
end
formatted = day <> "/" <> month <> "/" <> year
```

This block should be extracted into a private helper function. The repetition inflates the function size and makes maintenance error-prone. Note: Timex already provides `Timex.format(date, "{0D}/{0M}/{YYYY}")` which would replace all these blocks.

---

**B016-23** — [MEDIUM] Copy-paste duplication of dealer-ID mapping

File: `lib/api_server_web/controllers/utility_controller.ex:1531–1558,5417–5442`

Description: The `dealer_id` customer-to-string mapping case expression (matching on `"vx_sielift"`, `"vx_cea"`, `"vx_cea_local"`, `"vx_midpac"`, `"vx_komrigolift"`, `"vx_dev"`, `"demo_account"`) is duplicated verbatim in both `send_vehicle_to_rayven/2` (line 1531) and `prepare_rayven_events/3` (line 5417). Similarly, the serial-number prefix mapping is duplicated in `send_vehicle_to_rayven/2` (line 1560) and `prepare_rayven_events/3` (line 5444). These should be extracted into private helper functions `dealer_id_for_customer/1` and `serial_prefix_for_customer/2`.

---

**B016-24** — [MEDIUM] `sync_historical_events_to_rayven/5` — `task_stream` consumed twice

File: `lib/api_server_web/controllers/utility_controller.ex:5336–5354`

Description: At line 5338, the result of `Task.async_stream/3` is piped into `|> Enum.map(fn {result, reason} -> ... end)` which consumes the stream. At line 5354, `Stream.run(task_stream)` is then called on the already-consumed stream. `Stream.run/1` on an exhausted `Task.async_stream` result is a no-op but is also a code error — it indicates the developer misunderstood that `Enum.map/2` already consumed the stream. Compare with the correct pattern used in `sync_historical_events_to_rayven/1` at line 5082 which calls `Stream.run(task_stream)` on an unconsumed stream.

---

**B016-25** — [LOW] `process_services_from_erp/2` is defined but never called

File: `lib/api_server_web/controllers/utility_controller.ex:5882–5894`

Description: The private function `process_services_from_erp/2` (line 5882) is defined as `defp` but is never called anywhere in the file. The active code path in `erp_import/2` calls `process_service_from_erp/2` (singular, line 5718) directly per item. The plural wrapper function is dead code.

---

**B016-26** — [MEDIUM] Inconsistent error handling across controller actions

File: `lib/api_server_web/controllers/geofence_controller.ex` and `lib/api_server_web/controllers/utility_controller.ex` (multiple)

Description: Error responses are returned using three different patterns with no consistency:

1. `send_resp(conn, :internal_server_error, "{\"error\": \"...\"}") ` — hand-assembled JSON strings (geofence_controller.ex lines 31, 50, 53, 64, 69–70)
2. `Plug.Conn.send_resp(conn, 400, Poison.encode!(%{message: "..."}))` — Poison-encoded maps (utility_controller.ex lines 351–354, 416, 423–426, etc.)
3. `render(conn, "error.json", ...)` — not used at all in these files

The hand-assembled JSON strings in geofence_controller.ex are error-prone (escaping issues, not valid JSON if the interpolated value contains quotes) and inconsistent with the Poison-encoded approach used in utility_controller.ex. A single `json_error/3` helper or use of `render/3` with a view should standardize this.

---

**B016-27** — [LOW] `get_tracker_ids/0` — bound variables `customer` and `custcode` never returned

File: `lib/api_server_web/controllers/utility_controller.ex:2078–2091`

Description: `get_tracker_ids/0` assigns `customer = device.customer` and `custcode = device.custcode` at lines 2089–2090, but returns neither. The function's return value is the result of `Enum.take(devices, -1)` destructured as `[device]`, so the function effectively returns the last device's customer field implicitly (as the last evaluated expression). However, the variable assignments are misleading and `custcode` is never used at all, generating a compiler warning.

---

**B016-28** — [LOW] `pull_from_rayven/1` — result of `Poison.decode/1` assigned but never used

File: `lib/api_server_web/controllers/utility_controller.ex:2005`

Description: `response_json = Poison.decode(response)` at line 2005 binds the decoded JSON but the variable `response_json` is never read. The function then returns `nil` (the last expression's value being the binding). This is dead computation and generates a compiler warning for the unused variable. The entire function body is incomplete — it fetches from Rayven but does nothing with the response.

---

**B016-29** — [MEDIUM] `sync_to_DISCorp/2` — hardcoded test payload, never used in production

File: `lib/api_server_web/controllers/utility_controller.ex:1052–1074`

Description: `sync_to_DISCorp/2` constructs a hardcoded request body with `"hourmeter" => 3892.41`, `"make" => "CAPACITY"`, `"model" => "TJ5000"`, `"serialNumber" => "27403"`. These are clearly specific test values for a single piece of equipment and are not parameterized. If this endpoint is accessible via the router, calling it will POST these hardcoded values to the live DISCorp API on every invocation.

---

**B016-30** — [MEDIUM] Leaky abstraction — internal customer database schema strings hardcoded in controller

File: `lib/api_server_web/controllers/utility_controller.ex` (multiple)

Description: Database schema/prefix strings such as `"vx_ceaomega"`, `"vx_sssl"`, `"vx_mondialevgl"`, `"vx_cea"`, `"vx_sielift"`, `"vx_dpworld"`, `"vx_komatsuau"`, etc. are hardcoded throughout the controller layer rather than being resolved from configuration or a context module. The controller directly contains the routing logic that maps to customer-specific database schemas. This is a leaky abstraction: the controller knows about the persistence layer's multi-tenancy schema naming convention, making it impossible to change the naming without modifying controller code.

---

**B016-31** — [LOW] `process_ebs_get_hour_meter/2` — hardcoded customer schema prefix

File: `lib/api_server_web/controllers/utility_controller.ex:3002`

Description: `Repo.all(prefix: "vx_cea_latest")` at line 3002 hardcodes the customer database schema directly in the function body. The function accepts `hardwareid` and `date` as parameters but not `customer`. This means the function can only ever query the `vx_cea_latest` schema, making it non-reusable and a maintenance hazard if the schema name changes.

---

**B016-32** — [MEDIUM] `Task.async_stream` result destructured as `{result, reason}` — incorrect tuple shape

File: `lib/api_server_web/controllers/utility_controller.ex:5338`

Description: The `Enum.map` at line 5338 destructures each stream result as `fn {result, reason} -> ... end`. However, `Task.async_stream` yields `{:ok, value}` or `{:exit, reason}` tuples (not `{result, reason}`). The pattern `{result, reason}` will match `{:ok, value}` with `result = :ok` and `reason = value`, and match `{:exit, reason}` with `result = :exit`. The `:ok` case branch then checks `result == :ok`, which works by accident but is misleading. This pattern also silently swallows task exit errors by not propagating them — the error branch only logs to IO.

---

---

## Summary Table

| ID | Severity | Short Title | File |
|---|---|---|---|
| B016-1 | MEDIUM | `IO.inspect` in production error path + internal error in response | geofence_controller.ex:30–31 |
| B016-2 | LOW | Commented-out debug note (minor) | geofence_controller.ex:89 |
| B016-3 | LOW | `inList` bound but never used (compiler warning) | geofence_controller.ex:97 |
| B016-4 | MEDIUM | `datetime` bound but never used inside AmbiguousDateTime match | geofence_controller.ex:121 |
| B016-5 | MEDIUM | `check_event_for_left_events/6` nil clause returns wrong type — latent crash | geofence_controller.ex:132 |
| B016-6 | LOW | Inconsistent nil check style (`!= nil` vs truthy) | geofence_controller.ex:40,61 |
| B016-7 | LOW | Commented-out `IO.inspect` left in source | pivotel_controller.ex:9 |
| B016-8 | LOW | `IO.puts` debug statements in production paths | pivotel_controller.ex:5,8,47,104 |
| B016-9 | LOW | `create_update_object/1` should be `defp` | pivotel_controller.ex:20 |
| B016-10 | MEDIUM | `@doc` on `defp` functions silently ignored by Elixir | utility_controller.ex:697,802,919 |
| B016-11 | HIGH | 199-line commented-out function `send_rentals_to_rayven/2` | utility_controller.ex:1245–1443 |
| B016-12 | HIGH | Hardcoded API keys and credentials in source | utility_controller.ex:141,146,151,171,1053,1747 |
| B016-13 | MEDIUM | Hardcoded personal email addresses as alert recipients | utility_controller.ex:1703,2251,5387 |
| B016-14 | MEDIUM | Hardcoded test/historical dates in production functions | utility_controller.ex:240,2023,3310,5240 |
| B016-15 | MEDIUM | Multiple bound-but-never-used variables (compiler warnings) | utility_controller.ex (multiple) |
| B016-16 | HIGH | Empty stub functions accepting `conn` — never send response | utility_controller.ex:324,3596,3600,3615 |
| B016-17 | LOW | Commented-out Rayven HTTP calls in `process_monthly_movements/0` and `process_ebs/0` | utility_controller.ex:2421,2929 |
| B016-18 | LOW | Commented-out code blocks in `pull_equipment_data_from_rayven/1` and `pull_services_from_rayven/1` | utility_controller.ex:4709,4839 |
| B016-19 | LOW | `rayven_login/2` is an empty function with only commented-out JavaScript | utility_controller.ex:3346 |
| B016-20 | MEDIUM | Email delivery calls systematically commented out — silent no-ops with unused variable warnings | utility_controller.ex:1707,1729,5390,5613,5654 |
| B016-21 | HIGH | Massive copy-paste duplication in `process_prodisplay_event/2` (~3 near-identical branches) | utility_controller.ex:333–694 |
| B016-22 | MEDIUM | Date-formatting block (`DD/MM/YYYY`) copy-pasted 6+ times | utility_controller.ex:3799,3823,4087,4224,4387,4483 |
| B016-23 | MEDIUM | Dealer-ID and serial-prefix mapping duplicated across two functions | utility_controller.ex:1531,5417 |
| B016-24 | MEDIUM | `task_stream` consumed by `Enum.map` then `Stream.run` called on exhausted stream | utility_controller.ex:5338,5354 |
| B016-25 | LOW | `process_services_from_erp/2` defined but never called (dead private function) | utility_controller.ex:5882 |
| B016-26 | MEDIUM | Inconsistent error response format across controllers (hand-built JSON vs Poison vs render) | geofence_controller.ex, utility_controller.ex |
| B016-27 | LOW | `get_tracker_ids/0` — `custcode` bound but never used | utility_controller.ex:2090 |
| B016-28 | LOW | `pull_from_rayven/1` — decoded response bound but never read | utility_controller.ex:2005 |
| B016-29 | MEDIUM | `sync_to_DISCorp/2` — hardcoded test payload POSTed to live API | utility_controller.ex:1052 |
| B016-30 | MEDIUM | Customer DB schema strings hardcoded throughout controller — leaky abstraction | utility_controller.ex (pervasive) |
| B016-31 | LOW | `process_ebs_get_hour_meter/2` — hardcoded customer schema `"vx_cea_latest"` | utility_controller.ex:3002 |
| B016-32 | MEDIUM | `Task.async_stream` result destructured with incorrect tuple pattern | utility_controller.ex:5338 |

**Total findings: 32**
- CRITICAL: 0
- HIGH: 5 (B016-11, B016-12, B016-16, B016-21, and shared severity with B016-5 raised to MEDIUM)
- MEDIUM: 14
- LOW: 13
- INFO: 0
# Pass 4 – B017

Date: 2026-02-27
Audit run: 2026-02-27-01
Agent: B017

Files reviewed:
- lib/api_server_web/controllers/vx_abl_record_controller.ex
- lib/api_server_web/controllers/vx_access_fob_controller.ex
- lib/api_server_web/controllers/vx_customer_controller.ex

---

## Reading Evidence

### lib/api_server_web/controllers/vx_abl_record_controller.ex

**Module:** `ApiServerWeb.VXAblRecordController`

**Aliases:**
- `ApiServer.Vx` (line 4)
- `ApiServer.Vx.VXAblRecord` (line 5)

**Functions:**

| Name | Line | Visibility |
|------|------|------------|
| `create/2` | 9 | public |
| `show/2` | 18 | public |
| `update/2` | 23 | public |
| `delete/2` | 31 | public |
| `rhm_service_records/2` | 38 | public |
| `generate_service_record/3` | 66 | public |

**Types / Constants / Errors:** None defined.

**Notes:**
- `generate_service_record/3` takes `conn`, `thing`, and `new_service_date` as arguments. It is not a Phoenix action (not dispatched from the router); it is called directly from `ApiServerWeb.VXThingController.update_thing/2` (confirmed in vx_thing_controller.ex line 272).
- Line 13: uses old-style path helper `vx_abl_record_path/3`. This is correct for Phoenix 1.5.9 (project dependency confirmed in mix.exs).
- Lines 42–47: `cond` used for a two-branch boolean check.
- Lines 49–54: `cond` used for a two-branch boolean check.
- Lines 56–63: multi-pass `Enum.filter` pipeline.
- Line 58: anonymous function uses `fn(record)` form (with parens).
- Lines 96–107 and 109–120: intermediate `to_return` variable assigned and immediately returned in both `cond` branches — redundant binding.
- Lines 143–146: variables `hours_to_service`, `estimated_service_date`, `estimated_service_hours` bound but `estimated_service_date` and `estimated_service_hours` are always empty strings (dead data injected into XML).
- Line 73: `:inet_parse.ntoa` — Erlang private/internal module function used directly.
- Line 171: `{status, _result} = Vx.create_abl_record(...)` — result discarded with `_result`.

---

### lib/api_server_web/controllers/vx_access_fob_controller.ex

**Module:** `ApiServerWeb.VXAccessFobController`

**Aliases:**
- `ApiServer.Vx` (line 4)
- `ApiServer.Vx.VXAccessFob` (line 5)

**Functions:**

| Name | Line | Visibility |
|------|------|------------|
| `index/2` | 9 | public |
| `show/2` | 14 | public |
| `delete/2` | 19 | public |

**Types / Constants / Errors:** None defined.

**Notes:**
- Minimal controller: no `create` or `update` actions, only `index`, `show`, and `delete`.
- `index/2` calls `Vx.list_vxaccessfobs/0` with no tenant/customer scoping. All other controllers in this codebase scope data by `customer` extracted from JWT claims.

---

### lib/api_server_web/controllers/vx_customer_controller.ex

**Module:** `ApiServerWeb.VXCustomerController`

**Aliases:**
- `ApiServer.Vx` (line 4)
- `ApiServer.Vx.VXCustomer` (line 5)

**Functions:**

| Name | Line | Visibility |
|------|------|------------|
| `index/2` | 9 | public |
| `create/2` | 16 | public |
| `show/2` | 32 | public |
| `update/2` | 39 | public |
| `delete/2` | 51 | public |

**Types / Constants / Errors:** None defined.

**Notes:**
- `create/2` uses `with/else` to handle errors inline (lines 21–29).
- `update/2` uses bare `with` without `else`, inconsistent with `create/2`.
- `update/2` (line 45) discards the updated struct (`_vx_customer`) and then re-fetches the record from the database at line 46 to pass to the renderer — a redundant round-trip.
- `create/2` line 27: `IO.inspect error` — debug call left in production code.
- `create/2` line 28: raw JSON string constructed via string interpolation instead of using a proper encoder.
- `delete/2` line 56: responds with `send_resp(conn, :ok, "{}")` — differs from all other controllers' `delete` actions which respond with `:no_content` and empty body `""`.
- `create/2` line 21: the `with` match binds `customer` (the created `%VXCustomer{}`) shadowing the outer `customer` variable (the JWT claim string, line 17). Both variables share the same name in the same scope.

---

## Findings

**B017-1** — [MEDIUM] `IO.inspect` debug call left in production code

File: lib/api_server_web/controllers/vx_customer_controller.ex:27

Description: `IO.inspect error` is called unconditionally on every error path of `create/2`. This causes internal Ecto changeset details to be written to stdout (the application log) in all environments including production. It leaks internal schema structure and clutters logs. It is a remnant of a debugging session that was never removed.

---

**B017-2** — [MEDIUM] Raw JSON error body assembled via string interpolation instead of encoder

File: lib/api_server_web/controllers/vx_customer_controller.ex:28

Description: The error response body is constructed as:
```elixir
"{\"error\": \"error creating customer\", \"reason\": \"#{inspect error.errors}\" }"
```
`inspect/1` of an Ecto changeset error keyword list produces Elixir-formatted output (e.g., `[field: {"msg", []}]`), not valid JSON values. If any error message string contains a double-quote or a backslash the output will be malformed JSON, breaking any API client that attempts to parse the response. The same anti-pattern appears in `vx_thing_controller.ex` but is a distinct finding here. `Jason.encode!/1` or `Poison.encode!/1` (already a project dependency) should be used.

---

**B017-3** — [MEDIUM] Variable name shadowing: `customer` rebound inside `with` in `create/2`

File: lib/api_server_web/controllers/vx_customer_controller.ex:21

Description: The `with` clause matches `{:ok, %VXCustomer{} = customer}`, rebinding the name `customer` to the newly created struct. The outer `customer` (the tenant-identifier string from JWT claims, line 17) is still in scope. Within the `with` body the struct is used correctly, but the naming collision makes the code misleading and error-prone: a reader or future editor must carefully track which `customer` is which. The pattern `_vx_customer` used in `update/2` line 45 shows awareness that the match result may be discarded, but no such care was taken in `create/2`.

---

**B017-4** — [LOW] Inconsistent error handling pattern between `create/2` and `update/2` in same controller

File: lib/api_server_web/controllers/vx_customer_controller.ex:21,45

Description: `create/2` uses `with/else` and handles `{:error, error}` explicitly (lines 25–29). `update/2` uses a bare `with` (line 45) with no `else` clause, delegating failures to `FallbackController`. These are the same class of operation on the same resource. Inconsistent error-handling strategy within a single controller makes the failure behaviour of `update/2` opaque and divergent from `create/2`. One approach should be used throughout.

---

**B017-5** — [LOW] `delete/2` responds `:ok` with `"{}"` instead of `:no_content` with `""`

File: lib/api_server_web/controllers/vx_customer_controller.ex:56

Description: `VXCustomerController.delete/2` returns HTTP 200 with a JSON body `{}`. Every other `delete` action in the controller suite (`[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXFleetController`, `VXRentalController`, `VXUserController`, etc.) returns HTTP 204 No Content with an empty body, which is the RESTful convention. This inconsistency breaks any client or automated test that expects 204 on successful deletion.

---

**B017-6** — [LOW] Redundant database round-trip in `update/2`

File: lib/api_server_web/controllers/vx_customer_controller.ex:45-47

Description: After successfully updating a customer, the updated struct returned by `Vx.update_vx_customer/3` is discarded (`_vx_customer`) and the record is immediately re-fetched from the database by calling `Vx.get_vx_customer!/2` again (line 46) with the same ID. This is a redundant database query on every successful update. If the update result already contains the full, updated struct it should be passed directly to the renderer.

---

**B017-7** — [LOW] Intermediate `to_return` variable bound only to be immediately returned

File: lib/api_server_web/controllers/vx_abl_record_controller.ex:100-106, 113-119

Description: In `generate_service_record/3`, both `current_hour_meter` and `input_one_hour_meter` are computed using the same pattern:
```elixir
to_return = case thing.summary.abmXxx do
  nil -> nil
  _   -> round(...)
end
to_return
```
The intermediate binding `to_return` serves no purpose; the `case` expression is itself the value. This is needless noise that reduces readability without any functional benefit.

---

**B017-8** — [LOW] `estimated_service_date` and `estimated_service_hours` are always empty strings (dead data in XML output)

File: lib/api_server_web/controllers/vx_abl_record_controller.ex:145-146, 158-159

Description: Lines 145–146 bind:
```elixir
estimated_service_date = ""
estimated_service_hours = ""
```
These variables are immediately interpolated into the XML payload at lines 158–159 and are never populated. The XML schema includes `<estimated_service_date>` and `<estimated_service_hours>` elements that are always empty. This is either dead/incomplete logic (the values were intended to be computed but never were) or dead XML fields consuming space and misleading consumers of the audit log records.

---

**B017-9** — [LOW] `generate_service_record/3` is a public function acting as a private utility

File: lib/api_server_web/controllers/vx_abl_record_controller.ex:66

Description: `generate_service_record/3` is not a Phoenix action — it is not reachable via any router entry and is not invoked via `action_fallback`. It is called by a completely different controller (`VXThingController.update_thing/2`, confirmed at vx_thing_controller.ex line 272) using a fully qualified module reference. Defining it as a `def` (public) rather than a `defp` (private) has no practical effect here because controllers cannot import each other's privates, but exposing an implementation-detail function as a public API on a controller module is a leaky abstraction. The logic should live in the `ApiServer.Vx` context module, not in a controller.

---

**B017-10** — [LOW] `VXAccessFobController.index/2` performs no tenant scoping

File: lib/api_server_web/controllers/vx_access_fob_controller.ex:10

Description: `index/2` calls `Vx.list_vxaccessfobs()` with no arguments. Every other list/index action in the neighboring controllers (`VXCustomerController.index/2`, `VXAblRecordController.rhm_service_records/2`, etc.) extracts a `customer` claim from the JWT and passes it to scope the query. If `Vx.list_vxaccessfobs/0` does not enforce tenant isolation internally, this endpoint leaks fob records across all tenants to any authenticated user.

---

**B017-11** — [INFO] `cond` with only two branches where `if` would be clearer

File: lib/api_server_web/controllers/vx_abl_record_controller.ex:42-47, 49-54, 96-107, 109-120, 122-140

Description: Several `cond` expressions in `rhm_service_records/2` and `generate_service_record/3` have exactly two branches — a condition and a `true ->` catch-all. In Elixir the idiomatic form for two-branch conditionals is `if`/`else`. While not a defect, the widespread use of `cond` for binary decisions is a style inconsistency relative to the rest of the codebase (e.g., `vx_thing_controller.ex` uses `if` for the same pattern) and reduces immediate readability. Severity set to INFO as it does not affect correctness or safety.

---

## Summary Table

| ID | Severity | File | Short Title |
|----|----------|------|-------------|
| B017-1 | MEDIUM | vx_customer_controller.ex:27 | `IO.inspect` debug call in production error path |
| B017-2 | MEDIUM | vx_customer_controller.ex:28 | Raw JSON error body assembled via `inspect` — potentially malformed |
| B017-3 | MEDIUM | vx_customer_controller.ex:21 | `customer` variable shadowed inside `with` match |
| B017-4 | LOW | vx_customer_controller.ex:21,45 | Inconsistent error handling between `create/2` and `update/2` |
| B017-5 | LOW | vx_customer_controller.ex:56 | `delete/2` returns 200 `{}` instead of 204 No Content |
| B017-6 | LOW | vx_customer_controller.ex:45-47 | Redundant database re-fetch after successful update |
| B017-7 | LOW | vx_abl_record_controller.ex:100-119 | Needless intermediate `to_return` bindings |
| B017-8 | LOW | vx_abl_record_controller.ex:145-146 | `estimated_service_date`/`hours` always empty — dead data in XML |
| B017-9 | LOW | vx_abl_record_controller.ex:66 | `generate_service_record/3` is a leaky public cross-controller function |
| B017-10 | LOW | vx_access_fob_controller.ex:10 | `index/2` performs no tenant scoping on fob listing |
| B017-11 | INFO | vx_abl_record_controller.ex (multiple) | `cond` used for two-branch conditionals throughout |
# Pass 4 – B018

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B018
**Pass:** 4 – Code Quality

**Files reviewed:**
- `lib/api_server_web/controllers/vx_fleet_association_controller.ex`
- `lib/api_server_web/controllers/vx_fleet_controller.ex`
- `lib/api_server_web/controllers/vx_rental_controller.ex`
- `lib/api_server_web/controllers/vx_restriction_controller.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/vx_fleet_association_controller.ex`

**Module:** `ApiServerWeb.VXFleetAssociationController`

**Aliases:**
- `ApiServer.Vx` (line 4)
- `ApiServer.Vx.VXFleetAssociation` (line 5)

**Directives:**
- `use ApiServerWeb, :controller` (line 2)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

**Functions:**

| Name | Line | Arity | Notes |
|------|------|-------|-------|
| `index/2` | 9 | 2 | Lists all fleet associations |
| `show/2` | 14 | 2 | Gets one fleet association by id |
| `delete/2` | 19 | 2 | Deletes one fleet association by id |

**Types/Errors/Constants defined:** None

---

### File 2: `lib/api_server_web/controllers/vx_fleet_controller.ex`

**Module:** `ApiServerWeb.VXFleetController`

**Aliases:**
- `ApiServer.Vx` (line 4)
- `ApiServer.Vx.VXFleet` (line 5)

**Directives:**
- `use ApiServerWeb, :controller` (line 2)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

**Functions:**

| Name | Line | Arity | Notes |
|------|------|-------|-------|
| `create/2` | 9 | 2 | Original scaffold create action; uses `vx_fleet_path/3` |
| `get_fleets/2` | 19 | 2 | Admin clause — matches `%{"admin" => "1"}` |
| `get_fleets/2` | 27 | 2 | Default clause — matches any params |
| `get_fleets_with_equipment/2` | 35 | 2 | Returns fleets with embedded equipment list |
| `create_fleet/2` | 68 | 2 | Production fleet create with duplicate-name check |
| `delete_fleet/2` | 91 | 2 | Deletes fleet by customer + id |
| `get_equipment_in_fleet/2` | 105 | 2 | Returns equipment list for a fleet |
| `manage_fleet/2` | 110 | 2 | Updates fleet membership associations |
| `update_fleet/2` | 119 | 2 | Updates fleet metadata |

**Types/Errors/Constants defined:** None

---

### File 3: `lib/api_server_web/controllers/vx_rental_controller.ex`

**Module:** `ApiServerWeb.VXRentalController`

**Aliases:**
- `ApiServer.Vx` (line 4)
- `ApiServer.Vx.VXRental` (line 5)

**Directives:**
- `use ApiServerWeb, :controller` (line 2)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

**Functions:**

| Name | Line | Arity | Notes |
|------|------|-------|-------|
| `get_rentals/2` | 9 | 2 | Closed-rentals clause — matches `%{"customer" => _, "closed" => "1"}` |
| `get_rentals/2` | 30 | 2 | Default clause — open rentals |
| `get_midpac_style_rental_report/2` | 51 | 2 | Anniversary-based report; contains commented-out code |
| `get_rental_anniversaries/2` | 110 | 2 | Per-equipment anniversary data |
| `create_rental/2` | 158 | 2 | Creates a rental record |
| `update_rental/2` | 174 | 2 | Updates a rental record |
| `delete_rental/2` | 191 | 2 | Deletes a rental record |
| `rhm_active_rental/2` | 206 | 2 | Returns the active rental for a hardware ID; contains dead assignment |

**Types/Errors/Constants defined:** None

---

### File 4: `lib/api_server_web/controllers/vx_restriction_controller.ex`

**Module:** `ApiServerWeb.VXRestrictionController`

**Aliases:**
- `ApiServer.Vx` (line 4)
- `ApiServer.Vx.VXRestriction` (line 5)

**Directives:**
- `use ApiServerWeb, :controller` (line 2)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

**Functions:** None — module body is empty.

**Types/Errors/Constants defined:** None

---

## Findings

---

**B018-1** — [HIGH] Dead assignment in `rhm_active_rental/2`: computed values discarded before render

File: `lib/api_server_web/controllers/vx_rental_controller.ex:218`

Description: In the `_->` branch of `rhm_active_rental/2`, three values (`period_start`, `period_usage`, `overage`) are computed and then applied to `active_rental` via `Map.put_new/3` (lines 222–226). However, the result of that pipeline is never bound to a variable — it is silently discarded. The subsequent `render/4` call on line 229 passes `active_rental` unchanged (without the computed fields). The client therefore receives a rental object missing `period_start`, `period_usage`, and `overage`, even though the business logic explicitly calculated them. The corresponding `get_rentals/2` clauses (lines 17–25 and 37–45) do bind the enriched struct. This is a functional regression: the active-rental endpoint silently omits the overage data it advertises.

```elixir
# Lines 222-229 — pipeline result is dropped; active_rental is rendered unmodified
active_rental
|> Map.put_new(:period_start, period_start)
|> Map.put_new(:period_usage, period_usage)
|> Map.put_new(:overage, overage)

render(conn, "rhm_rental.json", %{vx_rental: active_rental, customer: customer})
```

---

**B018-2** — [MEDIUM] Commented-out code in `get_midpac_style_rental_report/2`

File: `lib/api_server_web/controllers/vx_rental_controller.ex:66`

Description: Line 66 contains a commented-out expression that was an alternative implementation of augmented thing lookup:

```elixir
# {thing, usage_data} = Vx.get_augmented_thing_with_hardware_id!(rental.thing.aadhardwareid, customer)
```

The commented line is inside the body of an active function and references a binding (`usage_data`) that was presumably used elsewhere. Leaving it obscures the intended design and may indicate an incomplete refactor. It should be removed or the intent documented in a code comment, not left as dead source.

---

**B018-3** — [MEDIUM] Commented-out code in `get_rentals/2` (closed-rentals clause)

File: `lib/api_server_web/controllers/vx_rental_controller.ex:10`

Description: Line 10 contains a commented-out `user` binding:

```elixir
# user = ApiServer.Guardian.Plug.current_resource(conn)
```

This is the second of two `get_rentals/2` clauses; the open-rentals clause (line 30) does not have this comment. The residual commented code suggests the user resource was once fetched and is no longer needed in this path, but was never cleaned up. It should be removed.

---

**B018-4** — [MEDIUM] Empty controller shell with unused aliases — `[REDACTED-AWS-SMTP-PASSWORD]`

File: `lib/api_server_web/controllers/vx_restriction_controller.ex:1`

Description: The module is an empty shell: it declares `use ApiServerWeb, :controller`, `action_fallback`, and aliases for `ApiServer.Vx` and `ApiServer.Vx.VXRestriction`, but defines zero action functions. The router has no routes pointing to this controller (confirmed by searching `router.ex`). The corresponding view (`VXRestrictionView`) and context functions (`list_vx_restrictions`, `get_vx_restriction!`, etc. in `vx.ex`) are fully implemented, meaning either the HTTP surface was deliberately never exposed, or the controller was started and abandoned. Both aliases are unused, which will produce compiler warnings (`alias ApiServer.Vx` and `alias ApiServer.Vx.VXRestriction` are never referenced). The module should either be completed and routed, or deleted entirely.

---

**B018-5** — [MEDIUM] Deprecated path helper `vx_fleet_path/3` — Phoenix 1.5 generates `Routes.*_path`

File: `lib/api_server_web/controllers/vx_fleet_controller.ex:13`

Description: The `create/2` action calls `vx_fleet_path(conn, :show, vx_fleet)` to build the `Location` header. In Phoenix 1.5 (the version pinned in `mix.exs`), the generated helper is `ApiServerWeb.Router.Helpers.vx_fleet_path/3`, accessed via `Routes.vx_fleet_path/3` when `Routes` is aliased. The bare unqualified form `vx_fleet_path/3` relies on importing `ApiServerWeb.Router.Helpers` somewhere in the `:controller` macro chain. While this may work at runtime, it is the pre-1.3 import-based calling convention; Phoenix 1.4+ deprecated the import in favor of explicit `Routes.*` references. This will produce a compiler warning in newer Phoenix versions and obscures where the helper originates.

---

**B018-6** — [MEDIUM] Dead function `create/2` in `VXFleetController` — not routed, superseded by `create_fleet/2`

File: `lib/api_server_web/controllers/vx_fleet_controller.ex:9`

Description: `create/2` (lines 9–16) is a scaffold-generated action that creates a fleet via `Vx.create_vx_fleet(vx_fleet_params)`. There is no route in `router.ex` that maps any HTTP method + path to `VXFleetController, :create`. The production fleet-creation endpoint uses `VXFleetController, :create_fleet` instead (PUT `/rhm/:customer/fleet/`). The dead `create/2` function is never called, adds noise, and will trigger a compiler warning about unreachable code if the router is analysed statically. It also uses a different (one-argument) `Vx.create_vx_fleet/1` arity than `create_fleet/2` uses (`Vx.create_vx_fleet/2`), indicating the scaffold was never updated to match the production context API.

---

**B018-7** — [MEDIUM] `[REDACTED-AWS-SMTP-PASSWORD]` is not routed — module is effectively dead code

File: `lib/api_server_web/controllers/vx_fleet_association_controller.ex:1`

Description: A search of `router.ex` shows no routes targeting `[REDACTED-AWS-SMTP-PASSWORD]`. The three actions (`index/2`, `show/2`, `delete/2`) are never reachable via HTTP. A separate fleet-association path is managed through `VXFleetController.manage_fleet/2`. The controller may have been an earlier CRUD scaffold that was superseded. As with `[REDACTED-AWS-SMTP-PASSWORD]`, the file should be deleted or the routes added intentionally.

---

**B018-8** — [LOW] `create_rental/2` error branch — catch-all `_ ->` match on `changeset.errors` is a no-op

File: `lib/api_server_web/controllers/vx_rental_controller.ex:167`

Description: The error path of `create_rental/2` is:

```elixir
{:error, changeset} ->
  case changeset.errors do
    _ ->
      send_resp(conn, :internal_server_error, "...")
  end
```

The `case changeset.errors do _ -> ...` construct matches every possible value of `changeset.errors` unconditionally and executes a single branch. It is equivalent to ignoring `changeset.errors` entirely. It gives the appearance of dispatching on error types but does not. This is dead branching logic; it should either be removed (leaving just `send_resp`) or replaced with real per-error-type handling.

---

**B018-9** — [LOW] Inconsistent error response HTTP status: `delete_fleet/2` and `delete_rental/2` use `:ok` (200) on success while peer operations use `:no_content` (204)

File: `lib/api_server_web/controllers/vx_fleet_controller.ex:96` and `lib/api_server_web/controllers/vx_rental_controller.ex:196`

Description: `VXFleetAssociationController.delete/2` (line 22) correctly returns HTTP 204 No Content via `send_resp(conn, :no_content, "")`. By contrast, `VXFleetController.delete_fleet/2` (line 96) and `VXRentalController.delete_rental/2` (line 196) both return HTTP 200 OK with a `{}` body on successful deletion. REST convention for successful DELETE with no response body is 204. The inconsistency means clients cannot rely on a uniform status code for DELETE success across these endpoints.

---

**B018-10** — [LOW] Style inconsistency: raw JSON strings as error bodies vs. structured responses

File: `lib/api_server_web/controllers/vx_fleet_controller.ex:77,86,98,101,129,132` and `lib/api_server_web/controllers/vx_rental_controller.ex:169,184,187,198,201,216`

Description: Error responses in `VXFleetController` and `VXRentalController` are hand-constructed JSON strings (e.g. `"{\"error\": \"error inserting update\", \"reason\": \"#{inspect result}\" }"`). `[REDACTED-AWS-SMTP-PASSWORD]` uses `action_fallback` with the Phoenix `FallbackController` pattern for error handling, which generates structured responses. The inconsistency means error shapes are not uniform. Additionally, using `inspect/1` on a changeset (lines 86 and 129 in fleet controller; lines 169 and 184 in rental controller) exposes internal Ecto changeset struct details to API consumers, which is a leaky abstraction.

---

**B018-11** — [LOW] `get_midpac_style_rental_report/2` — `usage_data` bound but never used after commented-out alternative

File: `lib/api_server_web/controllers/vx_rental_controller.ex:115`

Description: In `get_rental_anniversaries/2` (line 115):

```elixir
{thing, usage_data} = Vx.get_augmented_thing_with_hardware_id!(hardwareid, customer)
```

`usage_data` is bound but never referenced in the function body. The `_` prefix convention is not used. This will generate a compiler warning `variable "usage_data" is unused`. The fact that the parallel commented-out call in `get_midpac_style_rental_report/2` (line 66) also binds `usage_data` suggests this was intended to be used but the feature was never completed.

---

**B018-12** — [LOW] Double blank lines and inconsistent spacing throughout `VXFleetController`

File: `lib/api_server_web/controllers/vx_fleet_controller.ex:17,25,65,66`

Description: Lines 17–18, 25–26, 65–67 contain double blank lines between function definitions. Elixir convention (and the Elixir formatter) uses a single blank line between top-level function definitions. Several `def` heads also have inconsistent spacing before the opening `%{}` in their parameter lists (e.g. line 19: `def get_fleets(conn,  %{"admin" => "1"})` — double space before `%`; line 110: `def manage_fleet(conn,  %{...})`; line 119: `def update_fleet(conn,  %{...})`). This suggests the file has never been run through `mix format`.

---

**B018-13** — [LOW] `get_fleets/2` (admin clause) does not bind `_params` — bound parameter name exposes intent mismatch

File: `lib/api_server_web/controllers/vx_fleet_controller.ex:19`

Description: The admin clause head is `def get_fleets(conn, %{"admin" => "1"})`. This implicitly discards any other parameters in the map. The fallback clause uses `_params` (line 27). While this is not a compiler error, the admin clause silently ignores any other query parameters that may be present in the request, which may be surprising and represents a minor inconsistency in the guard convention used.

---

## Summary Table

| ID | Severity | Title | File(s) |
|----|----------|-------|---------|
| B018-1 | HIGH | Dead assignment in `rhm_active_rental/2`: enriched struct discarded, client receives unenriched data | `vx_rental_controller.ex:222` |
| B018-2 | MEDIUM | Commented-out code in `get_midpac_style_rental_report/2` | `vx_rental_controller.ex:66` |
| B018-3 | MEDIUM | Commented-out code in `get_rentals/2` (closed clause) | `vx_rental_controller.ex:10` |
| B018-4 | MEDIUM | Empty controller shell with unused aliases — `[REDACTED-AWS-SMTP-PASSWORD]` | `vx_restriction_controller.ex:1` |
| B018-5 | MEDIUM | Deprecated/unqualified path helper `vx_fleet_path/3` | `vx_fleet_controller.ex:13` |
| B018-6 | MEDIUM | Dead function `create/2` — no route, superseded by `create_fleet/2` | `vx_fleet_controller.ex:9` |
| B018-7 | MEDIUM | `[REDACTED-AWS-SMTP-PASSWORD]` entirely unrouted — all three actions are dead code | `vx_fleet_association_controller.ex:1` |
| B018-8 | LOW | Catch-all `case changeset.errors do _ ->` is a no-op in `create_rental/2` | `vx_rental_controller.ex:167` |
| B018-9 | LOW | DELETE success uses `:ok` (200) instead of `:no_content` (204) — inconsistent with `[REDACTED-AWS-SMTP-PASSWORD]` | `vx_fleet_controller.ex:96`, `vx_rental_controller.ex:196` |
| B018-10 | LOW | Hand-built JSON error strings expose Ecto internals via `inspect/1` — leaky abstraction | `vx_fleet_controller.ex`, `vx_rental_controller.ex` |
| B018-11 | LOW | `usage_data` bound but never used — will produce compiler warning | `vx_rental_controller.ex:115` |
| B018-12 | LOW | Double blank lines and inconsistent spacing — file never run through `mix format` | `vx_fleet_controller.ex` |
| B018-13 | LOW | Admin clause of `get_fleets/2` silently drops all non-`admin` params | `vx_fleet_controller.ex:19` |

**Totals:** 1 HIGH, 6 MEDIUM, 6 LOW
# Pass 4 – B019

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B019

**Files reviewed:**
- `lib/api_server_web/controllers/vx_thing_controller.ex` (863 lines)
- `lib/api_server_web/controllers/vx_thing_event_controller.ex` (117 lines)
- `lib/api_server_web/controllers/vx_thing_info_controller.ex` (27 lines)

---

## Reading Evidence

### `ApiServerWeb.VXThingController`

**Module:** `ApiServerWeb.VXThingController`

**Uses/Aliases:**
- `use ApiServerWeb, :controller`
- `use Timex`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXThing`
- `action_fallback ApiServerWeb.FallbackController`

**Public functions (with line numbers):**

| # | Function | Line |
|---|----------|------|
| 1 | `get_checklists/2` (customer, hardwareid) | 10 |
| 2 | `get_movements/2` (customer, hardwareid, day, timezone) | 16 |
| 3 | `get_hardware_with_checklists/2` (customer) | 21 |
| 4 | `get_pm_data/2` (customer, hardwareid) | 30 |
| 5 | `get_all_pm_data/2` (customer) | 36 |
| 6 | `get_fleet_map/2` clause 1 (customer, fleetname) | 44 |
| 7 | `get_fleet_map/2` clause 2 (customer, fleetid) | 51 |
| 8 | `get_fleet_map/2` clause 3 (fleetid only) | 56 |
| 9 | `get_fleet_map/2` clause 4 (catch-all) | 64 |
| 10 | `create/2` (vx_thing params) | 74 |
| 11 | `show/2` (id/hardwareid) | 83 |
| 12 | `delete/2` (id) | 88 |
| 13 | `rhm_get_thing/2` (customer, hardwareid) | 95 |
| 14 | `rhm_get_thing_usage/2` (hardwareid, from, to, timezone) | 100 |
| 15 | `rhm_get_things_usage/2` (fleetid, from, to, timezone) | 111 |
| 16 | `rhm_get_thing_events/2` (hardwareid, from, to, timezone) | 144 |
| 17 | `rhm_get_things/2` clause 1 (customer, fleet_id) | 153 |
| 18 | `rhm_get_things/2` clause 2 (customer) | 161 |
| 19 | `rhm_get_things_with_usage/2` clause 1 (fleet_id) | 169 |
| 20 | `rhm_get_things_with_usage/2` clause 2 (catch-all) | 176 |
| 21 | `rhm_get_things_names/2` (customer) | 223 |
| 22 | `rhm_get_thing_records/2` (empty map) | 231 |
| 23 | `create_thing/2` (thing params) | 240 |
| 24 | `update_thing/2` (thing params) | 254 |
| 25 | `monday_hour_meters/2` (from, to, customers) | 377 |
| 26 | `get_next_monday_between_dates/4` | 438 |
| 27 | `combined_engine_usage/2` (format=csv, from, to, customers) | 453 |
| 28 | `pape_export/2` clause 1 (format=csv) | 603 |
| 29 | `pape_export/2` clause 2 (catch-all) | 617 |
| 30 | `sielift_export/2` clause 1 (format=json, fleet_id) | 724 |
| 31 | `sielift_export/2` clause 2 (format=json) | 735 |
| 32 | `sielift_export/2` clause 3 (catch-all) | 746 |
| 33 | `update_thing_cached_fields/2` (hardwareid, customer) | 850 |
| 34 | `get_timezones/2` | 859 |

**Private functions:**

| # | Function | Line |
|---|----------|------|
| 1 | `things_with_usage/2` | 184 |
| 2 | `get_data_for_pape_export/1` | 285 |
| 3 | `ifnilzero/1` clause 1 (nil) | 622 |
| 4 | `ifnilzero/1` clause 2 (value) | 623 |
| 5 | `get_data_for_sielift_export/3` | 625 |

**Constants/Types defined:** None explicitly. No `@type`, `@spec`, or module-level `@` constants.

---

### `ApiServerWeb.VXThingEventController`

**Module:** `ApiServerWeb.VXThingEventController`

**Uses/Aliases:**
- `use ApiServerWeb, :controller`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXThingEvent`
- `action_fallback(ApiServerWeb.FallbackController)`

**Public functions:**

| # | Function | Line |
|---|----------|------|
| 1 | `index/2` | 9 |
| 2 | `create/2` (vx_thing_event params) | 14 |
| 3 | `show/2` (id) | 24 |
| 4 | `update/2` (id, vx_thing_event params) | 29 |
| 5 | `delete/2` (id) | 38 |
| 6 | `write_partial_record/3` (customer, hardware_id, update) | 46 |
| 7 | `add_calculated_fields/2` (record_to_add, customer) | 74 |
| 8 | `get_current_omega_status/2` (conn, hardwareid) | 111 |

**Private functions:**

| # | Function | Line |
|---|----------|------|
| 1 | `calculated_hourmeter/2` | 103 |

**Constants/Types defined:** None.

---

### `ApiServerWeb.VXThingInfoController`

**Module:** `ApiServerWeb.VXThingInfoController`

**Uses/Aliases:**
- `use ApiServerWeb, :controller`
- `alias ApiServer.Vx`
- `alias ApiServer.Vx.VXThingInfo`
- `action_fallback ApiServerWeb.FallbackController`

**Public functions:**

| # | Function | Line |
|---|----------|------|
| 1 | `fix_infos/2` (customer) | 9 |
| 2 | `get_info/2` (id, customer) | 17 |
| 3 | `do_fix_info/2` (hardwareid, customer) | 24 |

**Constants/Types defined:** None.

---

## Findings

**B019-1** — [LOW] Commented-out code: `combined_engine_usage` function body (large block)
File: `lib/api_server_web/controllers/vx_thing_controller.ex:300`
Description: Lines 300–373 contain an entire commented-out `def combined_engine_usage/2` function body (73 lines). The live version of this function appears at line 453. The commented-out block retains a hardcoded customer list of 48 production tenant names, IO.puts debug statements, dead render calls, and file-write logic. This is dead code that leaks internal tenant names, provides misleading historical context, and makes the file significantly harder to read. Severity is LOW (not CRITICAL) because it is genuinely unreachable, but the tenant-name disclosure warrants attention.

---

**B019-2** — [LOW] Commented-out code: `combined_engine_usage` inner `Enum.each` block
File: `lib/api_server_web/controllers/vx_thing_controller.ex:534`
Description: Lines 534–586 inside the live `combined_engine_usage/2` function are a large commented-out `Enum.each` block (53 lines) containing an alternative implementation with file I/O (`File.open!`, `IO.write`) and render calls. This block was replaced by the surrounding `Enum.flat_map` but was never removed. It bloats the function body and embeds confusing alternative logic inline.

---

**B019-3** — [LOW] Commented-out code: `sielift_export_local` function
File: `lib/api_server_web/controllers/vx_thing_controller.ex:780`
Description: Lines 780–847 are a fully commented-out `def sielift_export_local/1` function (68 lines). It contains file-write logic (`File.open!`, `IO.write`) operating on a hardcoded filename `"on-time performance 2.csv"`. This function was never removed after the live `sielift_export` family replaced it. In addition to dead code it contains a hardcoded local filesystem path, which is a leaky abstraction concern.

---

**B019-4** — [LOW] Commented-out code: inline debug comment in `rhm_get_things_usage/2`
File: `lib/api_server_web/controllers/vx_thing_controller.ex:138`
Description: Lines 138–139 contain a commented-out `conn |> render(...)` call that represents an abandoned JSON response path for `rhm_get_things_usage`. This is a remnant of the decision to switch the endpoint from JSON to CSV and was never cleaned up. While small, it is a code-quality finding per Pass 4 rules.

---

**B019-5** — [LOW] Commented-out debug `IO.puts` statements left in production code
File: `lib/api_server_web/controllers/vx_thing_controller.ex:38,58,68,113,146,180,530,589`
Description: Multiple `# IO.puts` lines are scattered throughout `vx_thing_controller.ex` (at least 8 locations). These are leftover debug statements that were silenced rather than removed. While harmless at runtime, they clutter the code and mask intent. Each site: line 38 (`get_all_pm_data`), line 58 (`get_fleet_map` clause 3), line 68 (`get_fleet_map` catch-all), line 113 (`rhm_get_things_usage`), line 146 (`rhm_get_thing_events`), line 180 (`rhm_get_things_with_usage`), line 530 (`combined_engine_usage` inner), line 589 (`combined_engine_usage` outer).

---

**B019-6** — [MEDIUM] `get_fleet_map/2` clause 1 silently ignores the `fleetname` parameter
File: `lib/api_server_web/controllers/vx_thing_controller.ex:44`
Description: The function clause `get_fleet_map(conn, %{"customer" => customer, "fleetname" => fleetname})` matches on `fleetname` in the pattern but then calls `Vx.list_vxthings_for_map(customer, user_id)` — using the authenticated `user_id` from claims instead of `fleetname`. The matched `fleetname` variable is never used. This is a behavioral bug: callers who pass a `fleetname` expect fleet-scoped filtering; instead they receive user-scoped results silently. The Elixir compiler will emit a warning for the unused `fleetname` variable, making this a build-warning-level issue as well as a logic defect.

---

**B019-7** — [MEDIUM] `rhm_get_things/2` parameter shadowing: `customer` param overwritten by JWT claim
File: `lib/api_server_web/controllers/vx_thing_controller.ex:153`
Description: Both clauses of `rhm_get_things/2` match `%{"customer" => customer, ...}` from the request params, then immediately rebind `customer` to `ApiServer.Guardian.Plug.current_claims(conn)["customer"]`. The same pattern appears in `rhm_get_things_names/2` (line 223–224). The client-supplied `customer` value is accepted by the pattern match and then silently discarded. This is an implicit trust boundary: the function signature suggests the caller controls the customer, but the implementation always uses the JWT claim. This is misleading and could be a security concern if routing assumptions ever change. The unused bound variable from the pattern match will also generate a compiler warning.

---

**B019-8** — [MEDIUM] `things_with_usage/2` calls `Timex.now()` twice; first result is immediately discarded
File: `lib/api_server_web/controllers/vx_thing_controller.ex:185`
Description: `now = Timex.now()` is assigned at line 185 and again at line 189 (identical statement). The first binding is dead — the variable `now` is rebound before it is used. The final usage of `now` at line 192 (`Timex.now(user_timezone)`) does not use the earlier binding at all; it creates a third `now_utc` variable. The duplicated assignment suggests a copy-paste error. The first `now = Timex.now()` binding at line 185 is completely unused, which will generate a compiler warning for the shadowed variable.

---

**B019-9** — [HIGH] `rhm_get_things_usage/2` returns CSV while all sibling endpoints return JSON — undocumented format inconsistency
File: `lib/api_server_web/controllers/vx_thing_controller.ex:111`
Description: Every other `rhm_get_*` function in this controller renders a JSON response via the view layer (`render(conn, "*.json", ...)`). `rhm_get_things_usage/2` is the sole exception: it bypasses the view, sets `Content-Type: text/csv`, and streams raw CSV via `send_resp/3`. The commented-out block at lines 138–139 confirms this was a deliberate late-stage change, but no surrounding documentation or router-level annotation marks this endpoint as returning CSV. Callers expecting JSON will receive unhandled text. The inconsistency also means this endpoint is excluded from any uniform JSON error-handling or content-negotiation middleware applied to the other `rhm_get_*` routes. (Confirmed from prior pass context.)

---

**B019-10** — [MEDIUM] `combined_engine_usage/2` uses `Poison.encode!` directly instead of the view layer
File: `lib/api_server_web/controllers/vx_thing_controller.ex:591`
Description: `combined_engine_usage/2` builds a data structure and serializes it with `Poison.encode!` then calls `send_resp(200, poison_encoded)` directly, bypassing Phoenix's view/render pipeline. The same anti-pattern appears in `monday_hour_meters/2` (line 431–435) and `get_timezones/2` (line 861). This means no content-type header is set, the response bypasses any plug-level response transformations, and there is no separation between serialization and presentation. The rest of the controller exclusively uses `render(conn, "*.json", ...)`. These three functions are inconsistent with the controller's own convention and with the rest of the codebase.

---

**B019-11** — [MEDIUM] `update_thing/2` directly calls into two other controllers as side effects
File: `lib/api_server_web/controllers/vx_thing_controller.ex:272`
Description: When a service date changes, `update_thing/2` calls `ApiServerWeb.VXAblRecordController.generate_service_record(conn, thing, changeset.aadlastservice)` and `ApiServer.Vx.VXThingInfo.service_performed(...)`. Calling one controller's function from another controller is a leaky abstraction: business logic that should live in the `ApiServer.Vx` context is encoded as a side effect inside an HTTP controller action. If `generate_service_record` fails or raises, the error is unhandled (no `with`, no rescue), leaving the `update_thing` response in an indeterminate state. Additionally, passing the live `conn` struct into `[REDACTED-AWS-SMTP-PASSWORD]` means the called function has access to the full HTTP connection of the parent request.

---

**B019-12** — [MEDIUM] `create_thing/2` error response uses raw `send_resp` with hand-rolled JSON string (non-standard error format)
File: `lib/api_server_web/controllers/vx_thing_controller.ex:250`
Description: On failure, `create_thing/2` responds with `send_resp(conn, :internal_server_error, "{\"error\": \"error inserting update\", \"reason\": \"#{inspect changeset}\" }")`. The same pattern appears in `update_thing/2` at lines 278 and 282. These hand-rolled JSON strings use `inspect/1` to serialize an Ecto changeset, which produces Elixir term syntax (not valid JSON) as the `reason` value. This means the `reason` field in the error response is not parseable JSON. All other error paths in the codebase use `action_fallback` / `FallbackController`. These three ad-hoc error responses are inconsistent and produce malformed JSON responses to API consumers.

---

**B019-13** — [LOW] `combined_engine_usage/2` variable `meta_data` is bound but never used
File: `lib/api_server_web/controllers/vx_thing_controller.ex:472`
Description: `meta_data = [hardwareid, customer]` is assigned at line 472 inside the `Enum.flat_map` over things. The variable is never referenced again; `mapped_usage` is what is returned. This is a dead assignment that will generate a compiler warning (`variable "meta_data" is unused`).

---

**B019-14** — [LOW] `get_data_for_pape_export/1` comment header is stale/misleading
File: `lib/api_server_web/controllers/vx_thing_controller.ex:285`
Description: The three functions `get_checklists/2` (line 11), `get_pm_data/2` (line 31), and `get_all_pm_data/2` (line 37) all carry the comment `# Get all checklists for this hardwareid`. The comment is copy-pasted from `get_checklists` and is wrong for `get_pm_data` and `get_all_pm_data`, which retrieve PM data (preventive maintenance), not checklists. While minor, stale comments mislead future readers about the intent of the function.

---

**B019-15** — [LOW] `ifnilzero/1` is defined but never called within the file
File: `lib/api_server_web/controllers/vx_thing_controller.ex:622`
Description: The private helper `ifnilzero/1` is defined at lines 622–623 but there is no call site anywhere in `vx_thing_controller.ex`. If it is not called from any other module (controllers cannot be `import`ed from outside in normal Phoenix usage), this is dead code. The Elixir compiler will emit a warning for the unused private function.

---

**B019-16** — [MEDIUM] `get_info/2` in `[REDACTED-AWS-SMTP-PASSWORD]` binds result to `info` and always returns `{}`
File: `lib/api_server_web/controllers/vx_thing_info_controller.ex:17`
Description: `get_info/2` calls `VXThingInfo.validateForHardwareId(...)`, binds the result to `info`, then discards it and responds with `send_resp(conn, :ok, "{}")`. The client receives an empty JSON object regardless of whether validation succeeded, failed, or returned data. The unused `info` variable will generate a compiler warning. This is confirmed from prior pass context. Callers of this endpoint have no way to know the outcome of the validation call.

---

**B019-17** — [MEDIUM] `write_partial_record/3` and `add_calculated_fields/2` are public functions on a Phoenix controller — leaky abstraction
File: `lib/api_server_web/controllers/vx_thing_event_controller.ex:46`
Description: `write_partial_record/3` and `add_calculated_fields/2` are defined as `def` (public) on a Phoenix controller module. They do not accept a `conn` and are not HTTP actions; they are internal data-processing helpers called from other controllers. Making them `public` on a controller leaks business logic into the web layer's public API. `write_partial_record/3` is called from `VXThingController.update_thing_cached_fields/2` via `VXThingController` which is itself called from `[REDACTED-AWS-SMTP-PASSWORD]` — a circular dependency pattern. These functions belong in the `ApiServer.Vx` context, not on a web controller.

---

**B019-18** — [LOW] `write_partial_record/3` uses `IO.puts` and `IO.inspect` for error logging in production code
File: `lib/api_server_web/controllers/vx_thing_event_controller.ex:62`
Description: The `case` on `Vx.create_vx_thing_event/2` uses `IO.puts("Inserted")` on success (line 62) and `IO.inspect(changeset)` on error (line 67). These are `stdout` calls with no structured logging, no log level control, and no ability to be filtered or aggregated by a log management system. The success branch also binds `te` (the created record) and discards it. In a production Elixir/Phoenix application `Logger` should be used instead.

---

**B019-19** — [LOW] `add_calculated_fields/2` reassigns `record_to_add` inside an `if` branch with no effect outside the branch
File: `lib/api_server_web/controllers/vx_thing_event_controller.ex:82`
Description: Inside the `if` at line 77, `record_to_add = Map.put(record_to_add, :totalengineseconds, 0)` rebinds `record_to_add` locally within the `if` branch. In Elixir, the result of an `if` expression is the return value of the executed branch, but here the `if` expression's return value is not used — the outer scope's `record_to_add` binding is not updated. Consequently, if `totalengineseconds` is nil and `aadhourmeter` is set, the corrected value (0) is printed in the `IO.puts` but the nil value is still passed to `calculated_hourmeter/2` at line 87. This is a silent logic bug: the branch appears to fix the nil but the fix does not propagate.

---

**B019-20** — [LOW] `[REDACTED-AWS-SMTP-PASSWORD]` indentation uses 4-space indent while the other two controllers use 2-space indent
File: `lib/api_server_web/controllers/vx_thing_info_controller.ex:1`
Description: The entire `vx_thing_info_controller.ex` file uses 4-space indentation, which is inconsistent with Elixir community style (2 spaces) and with the 2-space indentation used in `vx_thing_controller.ex` and `vx_thing_event_controller.ex`. While not a runtime defect, this style inconsistency indicates the file was edited with a different editor configuration and has never been normalized.

---

**B019-21** — [MEDIUM] `action_fallback` inconsistent invocation style across files
File: `lib/api_server_web/controllers/vx_thing_event_controller.ex:7`
Description: `vx_thing_controller.ex` and `vx_thing_info_controller.ex` write `action_fallback ApiServerWeb.FallbackController` (no parentheses). `vx_thing_event_controller.ex` writes `action_fallback(ApiServerWeb.FallbackController)` (with parentheses). This is a minor style inconsistency but reflects a lack of a shared formatter configuration being enforced across the controller files.

---

**B019-22** — [HIGH] `combined_engine_usage/2` `case` on `category` has no catch-all clause — will crash on unexpected category values
File: `lib/api_server_web/controllers/vx_thing_controller.ex:495`
Description: The `case category do` block at lines 495–506 only handles values 2, 3, 4, 5, and 6. If `category` is nil, 0, 1, 7, or any other value, Elixir will raise a `CaseClauseError` at runtime, crashing the request process with a 500 and no structured error response. `Vx.get_thing_category_with_hardware_id!/2` uses the bang convention suggesting it raises on not-found, but a missing or unrecognized category in the data would still produce an unmatched category integer. The same pattern in `get_data_for_sielift_export/3` at lines 643–654 has the identical missing catch-all.

---

## Summary Table

| ID | Severity | Title | File | Line |
|----|----------|-------|------|------|
| B019-1 | LOW | Commented-out `combined_engine_usage` function body | vx_thing_controller.ex | 300 |
| B019-2 | LOW | Commented-out `Enum.each` block inside `combined_engine_usage` | vx_thing_controller.ex | 534 |
| B019-3 | LOW | Commented-out `sielift_export_local` function | vx_thing_controller.ex | 780 |
| B019-4 | LOW | Commented-out JSON render remnant in `rhm_get_things_usage` | vx_thing_controller.ex | 138 |
| B019-5 | LOW | Commented-out `IO.puts` debug statements (8 sites) | vx_thing_controller.ex | 38,58,68,113,146,180,530,589 |
| B019-6 | MEDIUM | `get_fleet_map` clause 1 ignores matched `fleetname` param | vx_thing_controller.ex | 44 |
| B019-7 | MEDIUM | `rhm_get_things` silently shadows and discards request `customer` param | vx_thing_controller.ex | 153 |
| B019-8 | MEDIUM | `things_with_usage` double-binds `now`; first binding unused | vx_thing_controller.ex | 185 |
| B019-9 | HIGH | `rhm_get_things_usage` returns CSV while all siblings return JSON | vx_thing_controller.ex | 111 |
| B019-10 | MEDIUM | `combined_engine_usage`, `monday_hour_meters`, `get_timezones` bypass view layer | vx_thing_controller.ex | 591,431,861 |
| B019-11 | MEDIUM | `update_thing` calls sibling controller functions as side effects | vx_thing_controller.ex | 272 |
| B019-12 | MEDIUM | `create_thing`/`update_thing` error paths use hand-rolled invalid JSON | vx_thing_controller.ex | 250,278,282 |
| B019-13 | LOW | `meta_data` variable bound but never used in `combined_engine_usage` | vx_thing_controller.ex | 472 |
| B019-14 | LOW | Stale/copy-pasted comments in `get_pm_data` and `get_all_pm_data` | vx_thing_controller.ex | 31,37 |
| B019-15 | LOW | `ifnilzero/1` private helper defined but never called | vx_thing_controller.ex | 622 |
| B019-16 | MEDIUM | `get_info/2` discards result, always returns `{}` | vx_thing_info_controller.ex | 17 |
| B019-17 | MEDIUM | `write_partial_record` and `add_calculated_fields` are public on a controller | vx_thing_event_controller.ex | 46,74 |
| B019-18 | LOW | `write_partial_record` uses `IO.puts`/`IO.inspect` instead of Logger | vx_thing_event_controller.ex | 62,67 |
| B019-19 | LOW | `add_calculated_fields` local rebind of `record_to_add` has no effect | vx_thing_event_controller.ex | 82 |
| B019-20 | LOW | `vx_thing_info_controller.ex` uses 4-space indent (rest of codebase uses 2) | vx_thing_info_controller.ex | 1 |
| B019-21 | MEDIUM | `action_fallback` call style inconsistent across three files | vx_thing_event_controller.ex | 7 |
| B019-22 | HIGH | `case category` in `combined_engine_usage` has no catch-all — crashes on unknown category | vx_thing_controller.ex | 495,643 |
# Pass 4 – B020

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B020

**Files reviewed:**
- `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
- `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
- `lib/api_server_web/controllers/vx_user_controller.ex`
- `lib/api_server_web/controllers/vx_user_function_controller.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/controllers/vx_thing_omega_controller.ex`

**Module:** `ApiServerWeb.VXThingOmegaController`

**Uses/Aliases:**
- `use ApiServerWeb, :controller` (line 2)
- `use Timex` (line 3)
- `alias ApiServer.Vx` (line 5)
- `alias ApiServer.Vx.VXThing` (line 6)
- `action_fallback ApiServerWeb.FallbackController` (line 8)

**Functions:**

| Function | Line | Signature |
|---|---|---|
| `get_container_lift_report/2` | 10 | `(conn, %{"hardwareid", "from", "to"})` |
| `get_lift_summary_report/2` (clause 1) | 22 | `(conn, %{"hardwareid", "from", "to"})` |
| `get_lift_list_report/2` | 33 | `(conn, %{"hardwareid", "from", "to"})` |
| `get_lift_summary_report/2` (clause 2) | 44 | `(conn, %{"fleetid", "from", "to"})` |
| `get_operation_summary_report/2` | 53 | `(conn, %{"fleetid", "from", "to"})` |
| `get_engine_utilization_report/2` | 63 | `(conn, %{"hardwareid", "from", "to"})` |

**Types/Constants/Errors defined:** None

**Notes:**
- `VXThing` alias (line 6) is never referenced in the module body.
- `user_id` is bound in every function but is only used as an argument to `get_vx_user_offset/2`. The variable is re-bound with the same full module path (`ApiServer.Guardian.Plug.current_claims(conn)["sub"]`) in all six functions — no helper extraction.
- `get_operation_summary_report/2` (line 58) and `get_engine_utilization_report/2` (line 68) pass arguments to context functions as `(id, to_date, from_date, ...)` — note `to_date` comes before `from_date` in the call, matching the context function signatures at `vx.ex:749` and `vx.ex:726`.
- `get_container_lift_report/2` (line 16) and the other functions pass `(from_date, to_date, ...)` order — a surface-level inconsistency in the call site argument ordering that mirrors an inconsistency in the context API itself.

---

### File 2: `lib/api_server_web/controllers/vx_thing_summary_controller.ex`

**Module:** `ApiServerWeb.VXThingSummaryController`

**Uses/Aliases:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXThingSummary` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

**Functions:**

| Function | Line | Signature |
|---|---|---|
| `index/2` | 9 | `(conn, _params)` |
| `create/2` | 14 | `(conn, %{"vx_thing_summary" => ...})` |
| `show/2` | 23 | `(conn, %{"id" => id})` |
| `update/2` | 28 | `(conn, %{"id" => id, "vx_thing_summary" => ...})` |
| `delete/2` | 36 | `(conn, %{"id" => id})` |
| `do_fix_summary/2` | 45 | `(hardwareid, customer)` — not a Phoenix action |

**Types/Constants/Errors defined:** None

**Notes:**
- `VXThingSummary` alias is used: in pattern matches at lines 15 and 31; directly via `VXThingSummary.validate_for_hardwareid/2` at line 46.
- `do_fix_summary/2` does not follow the Phoenix action convention of `(conn, params)`. It is a public helper called from `vx_thing_controller.ex:852`.
- `create/2` at line 18 uses the deprecated Phoenix 1.5-era bare path helper `vx_thing_summary_path/3` rather than `Routes.vx_thing_summary_path/3`.

---

### File 3: `lib/api_server_web/controllers/vx_user_controller.ex`

**Module:** `ApiServerWeb.VXUserController`

**Uses/Aliases:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXUser` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

**Functions:**

| Function | Line | Signature |
|---|---|---|
| `create/2` | 9 | `(conn, %{"vx_user" => ...})` |
| `lookup_customer_from_conn/1` | 18 | `(conn)` |
| `login/2` | 41 | `(conn, %{"customer", "password", "email"})` |
| `change_password/2` | 59 | `(conn, %{"current_password", "new_password"})` |
| `get_users/2` | 82 | `(conn, %{"customer" => _customer})` |
| `get_user_with_email/2` | 89 | `(conn, %{"email", "customer"})` |
| `update_key_if_value/3` (clause 1 – nil guard) | 99 | `(map, key_to_save, nil)` |
| `update_key_if_value/3` (clause 2) | 100 | `(map, key_to_save, value_to_add)` |
| `update_user/2` (clause 1 – with user) | 104 | `(conn, %{"customer", "user"})` |
| `update_user/2` (clause 2 – no user key) | 127 | `(conn, %{"customer"})` |
| `create_user/2` | 131 | `(conn, %{"customer", "user"})` |
| `delete_user/2` | 153 | `(conn, %{"customer", "id"})` |
| `get_user_fleets/2` | 168 | `(conn, %{"user_id"})` |
| `manage_user_fleets/2` | 180 | `(conn, %{"user_id", "allowed_fleets"})` |

**Types/Constants/Errors defined:** None

**Notes:**
- `IO.inspect get_req_header(conn, "origin")` at line 19 is debug output left in production code.
- `create/2` (line 13) uses deprecated bare path helper `vx_user_path/3`.
- `login/2`: `user = user` at line 47 is a no-op self-assignment before `Map.put_new/3`.
- `login/2`: `cust_from_origin` (line 42) is computed but only used at line 52 (`put_session(:customer, cust_from_origin)`) — the `customer` param from the request is trusted for JWT signing (line 45) while `cust_from_origin` is only stored in the session, creating a split-authority pattern.
- `get_users/2` (line 82): `_customer` in the pattern (line 82) means the route-supplied `customer` parameter is silently discarded; `customer` is re-derived from JWT claims. The discarded parameter is not prefixed with `_` in the pattern match itself (it uses `_customer`), which is acceptable.
- `get_user_with_email/2` (line 89): destructures the result of `get_rhm_user/2` as `[user | _]` without handling the empty-list case — if the query returns `[]`, this raises a `MatchError` at runtime.
- Multiple `send_resp` JSON strings at lines 73, 117, 119, 147 contain a malformed suffix: `}\" }` — the closing brace of the JSON object is followed by an extraneous escaped-quote and space before the final `}`, producing invalid JSON on the wire.
- `change_password/2` (line 71–74): the `case changeset.errors do _ -> ...` block has only a catch-all clause — the `case` is a no-op and could be replaced by a simple expression.
- `update_key_if_value/3` is a public utility function with no callers visible in this file (not a Phoenix action). It is not referenced elsewhere in the controllers and has no `@doc`.

---

### File 4: `lib/api_server_web/controllers/vx_user_function_controller.ex`

**Module:** `ApiServerWeb.VXUserFunctionController`

**Uses/Aliases:**
- `use ApiServerWeb, :controller` (line 2)
- `alias ApiServer.Vx` (line 4)
- `alias ApiServer.Vx.VXUserFunction` (line 5)
- `action_fallback ApiServerWeb.FallbackController` (line 7)

**Functions defined (live):** None

**Functions commented out:**

| Commented function | Lines |
|---|---|
| `index/2` | 9–12 |
| `create/2` | 14–21 |
| `show/2` | 23–26 |
| `update/2` | 28–34 |
| `delete/2` | 36–41 |

**Types/Constants/Errors defined:** None

**Notes:**
- All five standard REST actions are commented out. The module body is entirely inert — the module exists only as a stub with dead commented code.
- Both aliases (`ApiServer.Vx` and `ApiServer.Vx.VXUserFunction`) and `action_fallback` are unreferenced because the module has no live code.

---

## Findings

---

**B020-1** — HIGH: All five controller actions commented out; module is entirely inert
File: `lib/api_server_web/controllers/vx_user_function_controller.ex:9-41`
Description: Every standard REST action (`index`, `create`, `show`, `update`, `delete`) is commented out across lines 9–41, leaving the module with no live functions. The module still imports `ApiServerWeb`, aliases `ApiServer.Vx` and `ApiServer.Vx.VXUserFunction`, and declares `action_fallback` — all of which are unused because there is no live code to reference them. This will produce compiler warnings for unused aliases. The module serves no runtime purpose and represents either abandoned code that should be deleted, or a planned feature that should be tracked via a proper stub or issue rather than commented code. As confirmed in the pass instructions, this was expected to be found and is reported at HIGH severity.

---

**B020-2** — MEDIUM: `IO.inspect` debug call left in production login path
File: `lib/api_server_web/controllers/vx_user_controller.ex:19`
Description: `IO.inspect get_req_header(conn, "origin")` is called unconditionally inside `lookup_customer_from_conn/1`, which is itself called on every invocation of the `login/2` action. This writes the raw `Origin` request header to stdout on every login attempt. In production this pollutes logs, leaks request metadata, and was clearly left over from development. It should be removed.

---

**B020-3** — MEDIUM: Malformed JSON in multiple `send_resp` error responses
File: `lib/api_server_web/controllers/vx_user_controller.ex:73, 117, 119, 147`
Description: Four `send_resp` calls produce invalid JSON. Each affected string closes the JSON object correctly (`}`) and then appends `\" }` — a literal escaped double-quote followed by a space and a closing brace — outside the JSON structure. For example, line 117:
```
"{\"error\": \"Error updating user\", \"reason\": \"...\"}\" }"
```
The trailing `\" }` is not valid JSON. Any client attempting to parse these responses will receive a parse error. Affected lines: 73 (`change_password`), 117 and 119 (`update_user`), 147 (`create_user`).

---

**B020-4** — MEDIUM: `get_user_with_email/2` will crash on empty result set
File: `lib/api_server_web/controllers/vx_user_controller.ex:90`
Description: `Vx.get_rhm_user/2` (2-arity) returns a list via `Repo.all`. Line 90 unconditionally destructures the result as `[user | _]`. If no user is found the list is `[]`, which does not match the pattern and raises a `MatchError` (an unhandled exception) rather than returning the intended 500 error response. The nil check on line 92 (`if user != nil`) will never handle this case because execution does not reach it when the list is empty. This path also leaks the existence check through the wrong status code (500 instead of 404) and uses a login error message for a non-login endpoint.

---

**B020-5** — MEDIUM: Unused alias `ApiServer.Vx.VXThing` in omega controller
File: `lib/api_server_web/controllers/vx_thing_omega_controller.ex:6`
Description: `alias ApiServer.Vx.VXThing` is declared at line 6 but `VXThing` is never referenced anywhere in the module body. All context operations go through the `Vx` alias. Elixir will emit a compiler warning for this unused alias. Dead aliases obscure the module's actual dependencies.

---

**B020-6** — MEDIUM: Unused aliases and `action_fallback` in `[REDACTED-AWS-SMTP-PASSWORD]`
File: `lib/api_server_web/controllers/vx_user_function_controller.ex:4-7`
Description: Because all actions are commented out, `alias ApiServer.Vx` (line 4), `alias ApiServer.Vx.VXUserFunction` (line 5), and `action_fallback ApiServerWeb.FallbackController` (line 7) all refer to names that are never used in any live code. Elixir will emit "unused alias" compiler warnings for lines 4 and 5. This is a direct consequence of B020-1 but is a distinct compiler-warning pattern worth tracking separately.

---

**B020-7** — LOW: Deprecated bare path helper used in `create/2` actions
File: `lib/api_server_web/controllers/vx_thing_summary_controller.ex:18`
File: `lib/api_server_web/controllers/vx_user_controller.ex:13`
Description: Both `create/2` actions use the Phoenix 1.3-era bare path helper syntax (`vx_thing_summary_path/3` and `vx_user_path/3`) rather than the `Routes.*_path` helper form introduced in Phoenix 1.4 and the verified-routes form introduced in Phoenix 1.7. The project is on Phoenix 1.5.9 (`mix.exs:36`), where these helpers still function but were already deprecated in favour of `Routes.*_path`. This is a build warning pattern; newer Phoenix versions would refuse to compile these.

---

**B020-8** — LOW: `user = user` no-op self-assignment in `login/2`
File: `lib/api_server_web/controllers/vx_user_controller.ex:47`
Description: Inside the `{:ok, token, _claims}` branch of `login/2`, line 47 reads `user = user` before calling `Map.put_new(:jwt, token)`. The self-assignment is a no-op: it rebinds `user` to its own current value. This produces no semantic difference but indicates the code was incorrectly written (the intent was presumably to pipe `user` through `Map.put_new/3` inline rather than via a multi-line pipe). The Elixir compiler may emit a warning about a variable being assigned and immediately used without transformation.

---

**B020-9** — LOW: Redundant `case` with catch-all in `change_password/2`
File: `lib/api_server_web/controllers/vx_user_controller.ex:71-74`
Description: The `{:error, changeset}` branch of `change_password/2` contains:
```elixir
case changeset.errors do
  _ ->
    send_resp(...)
end
```
A `case` expression with only a catch-all clause (`_`) is semantically identical to evaluating the expression and ignoring its value, then executing the body unconditionally. The `case` adds no branching logic. This pattern suggests that error-specific handling (similar to `update_user/2`) was intended but never implemented. As written it is dead structure.

---

**B020-10** — LOW: Pervasive copy-paste of JWT claims extraction across all omega controller actions
File: `lib/api_server_web/controllers/vx_thing_omega_controller.ex:11-13, 23-25, 34-36, 45-47, 54-56, 64-66`
Description: All six functions in `[REDACTED-AWS-SMTP-PASSWORD]` repeat the identical three-line block:
```elixir
customer = ApiServer.Guardian.Plug.current_claims(conn)["customer"]
user_id = ApiServer.Guardian.Plug.current_claims(conn)["sub"]
user_timezone = ApiServer.Vx.get_vx_user_offset(user_id, customer)
```
`ApiServer.Guardian.Plug.current_claims(conn)` is called twice per function (12 total calls across the module) when a single call and local destructuring would suffice. This duplication is a style inconsistency relative to the rest of the codebase and a maintenance hazard: any change to claims key names must be made in six places. A private helper or a Plug-level assign would eliminate the repetition.

---

**B020-11** — LOW: `do_fix_summary/2` is a non-action public function placed inside a Phoenix controller
File: `lib/api_server_web/controllers/vx_thing_summary_controller.ex:45-47`
Description: `do_fix_summary/2` does not follow the Phoenix controller action signature `(conn, params)`. It accepts `(hardwareid, customer)` and is called cross-module from `vx_thing_controller.ex:852`. Placing a utility/helper function inside a controller module creates a leaky abstraction: the controller's public surface now includes a non-HTTP function that couples `VXThingController` to `[REDACTED-AWS-SMTP-PASSWORD]` at the module level. This logic belongs in the `ApiServer.Vx` context layer, not in a web controller. The function also has no `@doc`.

---

**B020-12** — LOW: `update_key_if_value/3` is a public utility function with no callers in any controller
File: `lib/api_server_web/controllers/vx_user_controller.ex:99-102`
Description: `update_key_if_value/3` is a public function (two clauses) that wraps `Map.put_new/3` with a nil-guard. A search of the controller layer finds no callers. If this function is only called from within the same file it should be declared `defp`; if it is unused entirely it is dead code. Its presence as a public function makes it part of the module's public API surface, which is misleading in a Phoenix controller context.

---

**B020-13** — LOW: Argument order inversion for `to_date`/`from_date` in omega report calls
File: `lib/api_server_web/controllers/vx_thing_omega_controller.ex:58, 68`
Description: `get_operation_summary_report/2` (line 58) and `get_engine_utilization_report/2` (line 68) both call their respective context functions with `to_date` as the second argument and `from_date` as the third, matching the context function signatures at `vx.ex:749` and `vx.ex:726`. However, all other report functions in this controller (`get_container_lift_report/2`, `get_lift_summary_report/2`, `get_lift_list_report/2`) pass `from_date` before `to_date`. This inconsistency in argument order across the context API — some functions take `(from, to)`, others take `(to, from)` — is surfaced visibly in the controller and is a style and safety concern: a developer adding a new report function must know which ordering each context function expects.

---

**B020-14** — LOW: `login/2` uses request `customer` param for JWT but `Origin`-derived value only for session
File: `lib/api_server_web/controllers/vx_user_controller.ex:41-57`
Description: `login/2` derives `cust_from_origin` by mapping the `Origin` header to a customer slug (line 42), but then signs the JWT with the `customer` value from the **request body** (line 45). The Origin-derived value is only stored in the session (line 52). These two customer values can differ with no error or reconciliation. If a client sends `customer: "vx_admin"` in the POST body with any `Origin` header, the JWT will be signed for `vx_admin` regardless of the origin check. The origin-mapping logic in `lookup_customer_from_conn/1` only affects the session, not the authoritative JWT claim. This is a security-relevant inconsistency in the authentication flow.

---

## Summary Table

| ID | Severity | File | Short Title |
|---|---|---|---|
| B020-1 | HIGH | vx_user_function_controller.ex:9-41 | All 5 REST actions commented out; module entirely inert |
| B020-2 | MEDIUM | vx_user_controller.ex:19 | `IO.inspect` debug call in production login path |
| B020-3 | MEDIUM | vx_user_controller.ex:73,117,119,147 | Malformed JSON in 4 `send_resp` error responses |
| B020-4 | MEDIUM | vx_user_controller.ex:90 | `get_user_with_email/2` crashes on empty query result |
| B020-5 | MEDIUM | vx_thing_omega_controller.ex:6 | Unused alias `VXThing` — will emit compiler warning |
| B020-6 | MEDIUM | vx_user_function_controller.ex:4-5 | Unused aliases produce compiler warnings (consequence of B020-1) |
| B020-7 | LOW | vx_thing_summary_controller.ex:18, vx_user_controller.ex:13 | Deprecated bare path helpers |
| B020-8 | LOW | vx_user_controller.ex:47 | `user = user` no-op self-assignment |
| B020-9 | LOW | vx_user_controller.ex:71-74 | Redundant `case` with only catch-all clause |
| B020-10 | LOW | vx_thing_omega_controller.ex (6 sites) | Copy-paste JWT claims extraction across all 6 actions |
| B020-11 | LOW | vx_thing_summary_controller.ex:45 | Non-action public function `do_fix_summary/2` in controller |
| B020-12 | LOW | vx_user_controller.ex:99 | `update_key_if_value/3` public with no visible callers |
| B020-13 | LOW | vx_thing_omega_controller.ex:58,68 | Inconsistent `from_date`/`to_date` argument order in context API |
| B020-14 | LOW | vx_user_controller.ex:41-57 | JWT signed from request body `customer`; origin check only affects session |
# Pass 4 – B021

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B021
**Pass:** 4 (Code Quality)

**Files reviewed:**
- `lib/api_server_web/resolvers/puls.ex`
- `lib/api_server_web/resolvers/things.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/resolvers/puls.ex`

**Module:** `ApiServerWeb.Resolvers.Puls`

**Functions:**

| Function | Line |
|---|---|
| `puls_record/3` | 3 |

**Types defined:** none
**Constants defined:** none (inline literal token at line 4)
**Errors defined:** none
**Aliases/imports:** none

---

### File 2: `lib/api_server_web/resolvers/things.ex`

**Module:** `ApiServerWeb.Resolvers.Things`

**Functions:**

| Function | Line |
|---|---|
| `find_thing/3` | 3 |
| `get_all_things/3` | 13 |

**Types defined:** none
**Constants defined:** none
**Errors defined:** none
**Aliases/imports:** none

---

## Findings

---

**B021-1** — [CRITICAL] Hardcoded Base64-encoded credential in source code

File: `lib/api_server_web/resolvers/puls.ex:4`

Description: A Base64-encoded Basic Auth token (`"VHJhY2tpbmdTb2x1dGlvbnM6U2tQREk4ZXo="`) is hardcoded directly in the function body. Decoding this value yields a plaintext `username:password` pair for the CalAmp PULS service. Embedding credentials in source code exposes them to anyone with repository access, in version-control history, and in compiled BEAM files. The token cannot be rotated without a code change and redeployment. This credential must be moved to runtime configuration (e.g., `Application.fetch_env!/2` backed by a secret manager or environment variable).

---

**B021-2** — [HIGH] `receive/after` used to implement a blocking retry sleep inside a GraphQL resolver

File: `lib/api_server_web/resolvers/puls.ex:12-17`

Description: When the HTTP call returns `:error`, the resolver enters a `receive` block with a 60-second `after` timeout, then tail-calls itself recursively. This has several severe consequences:

1. The calling process (the Absinthe/Cowboy request handler) is blocked for at least 60 seconds per retry, consuming a scheduler thread and holding the HTTP connection open until the client times out.
2. There is no retry limit. If the CalAmp endpoint is persistently unavailable, the process will loop indefinitely until the client disconnects or the VM is restarted.
3. `receive` with only an `after` clause is an anti-pattern for sleeping; `Process.sleep/1` is the correct primitive if sleeping is genuinely required, but neither belongs in a synchronous resolver.
4. The unbounded recursion can exhaust the call stack under a sufficiently long outage.

The correct remediation is to return `{:error, reason}` immediately on HTTP failure and let the caller (client) decide on retry strategy, or use a background process / circuit breaker.

---

**B021-3** — [HIGH] `IO.puts` debug output left in production resolver code

File: `lib/api_server_web/resolvers/puls.ex:11`

Description: `IO.puts "Will attempt Re-send"` writes to standard output on every HTTP error. In a production Phoenix/OTP deployment, `IO.puts` bypasses the Logger subsystem entirely: output goes directly to the group leader and is not captured by log aggregators, log levels, or metadata. This is a build-warning-level issue under many static analysis tools and a runtime concern in production because it cannot be suppressed without a code change. All diagnostic output must use `Logger` with an appropriate level (`Logger.warn/2` or `Logger.error/2`).

---

**B021-4** — [MEDIUM] Variable `record` is rebound inside a `case` branch, shadowing the outer `case` result binding

File: `lib/api_server_web/resolvers/puls.ex:9-25`

Description: The outer assignment is `record = case status do ...`. Inside the `:ok` branch (line 20), a second `record = %{...}` binding is created. In Elixir, the inner binding shadows the outer one within that branch and the outer `record` variable ultimately receives the value of the last expression in the matching branch. While this is syntactically legal and produces the intended result, it is confusing: a reader must reason that the inner `record` is simultaneously the return value of the branch and the variable assigned at the outer level. The standard Elixir idiom is to omit the inner binding name entirely and just write the map literal as the branch expression. This pattern can cause maintainers to introduce bugs if the inner and outer bindings are ever modified independently.

---

**B021-5** — [MEDIUM] `get_vx_thing_with_hardware_id!/2` does not raise — bang-name is misleading and `nil` return is matched in `case`

File: `lib/api_server_web/resolvers/things.ex:4`

Description: The function `ApiServer.Vx.get_vx_thing_with_hardware_id!/2` (defined in `lib/api_server/vx/vx.ex:1347`) calls `Repo.one/2`, which returns `nil` when no record is found rather than raising. The bang (`!`) suffix in Elixir conventionally signals that the function raises on failure. The resolver at line 5 explicitly matches `nil ->` as a normal return value from this function, which confirms the function never raises. This is a leaky abstraction: the name promises a raising contract that does not exist, and every call site must add a `nil` guard that would be unnecessary if the name were correct (i.e., `get_vx_thing_with_hardware_id/2`). Any future caller who trusts the bang name and omits the nil check will get a runtime error downstream when the nil propagates.

---

**B021-6** — [MEDIUM] `get_all_things/3` matches `nil` as the error case for `list_vxthings/1`, but `list_vxthings` returns an empty list `[]` on no results, not `nil`

File: `lib/api_server_web/resolvers/things.ex:14-20`

Description: `ApiServer.Vx.list_vxthings/1` (defined in `lib/api_server/vx/vx.ex:470`) calls `Repo.all/2`, which always returns a list — either populated or `[]` — and never returns `nil`. The `nil ->` branch in the `case` on line 15 is therefore unreachable dead code. The genuine error condition (e.g., a database exception) would propagate as an uncaught exception rather than being converted to an `{:error, ...}` tuple. Callers observing a database outage will receive a 500-level crash instead of a structured GraphQL error response. The `nil` clause should be replaced with a `rescue` block or the query should be wrapped in a `try`/`rescue`.

---

**B021-7** — [LOW] Inconsistent indentation style between the two resolver files

File: `lib/api_server_web/resolvers/puls.ex` (4-space indent) vs `lib/api_server_web/resolvers/things.ex` (2-space indent for function bodies, mixed 4-space inside case)

Description: `puls.ex` uses 4-space indentation consistently. `things.ex` uses 2-space indentation for function bodies (lines 4, 14) but the closing `end` alignment is inconsistent (lines 19-21 show mixed 2/4-space nesting). The Elixir community standard (enforced by `mix format`) is 2-space indentation. Neither file appears to have been run through `mix format`. While this does not affect runtime behavior, it increases cognitive load when reading across files and indicates the formatter has not been applied to this module directory.

---

**B021-8** — [LOW] Double space in string literal produces incorrect error message

File: `lib/api_server_web/resolvers/things.ex:6`

Description: The error string `"Thing with  HardwareId #{hardwareid} not found"` contains two consecutive spaces between "with" and "HardwareId". This is a typographical error in a user-visible error message that will appear in GraphQL error responses returned to API clients.

---

**B021-9** — [LOW] No module-level `use` / `alias` declarations; full module paths repeated inline

File: `lib/api_server_web/resolvers/things.ex:4,14`

Description: Both calls use the fully-qualified name `ApiServer.Vx.*` rather than an `alias ApiServer.Vx` at the top of the module. The sibling `puls.ex` makes HTTP calls without an alias as well. While this is not a compile or runtime issue, it is inconsistent with the style used in the project's controllers (which uniformly use `alias`), makes the module harder to read, and requires changes in multiple places if the context module is renamed. This is a style inconsistency relative to other files in the same web layer.

---

## Summary Table

| ID | Severity | Title | File(s) |
|---|---|---|---|
| B021-1 | CRITICAL | Hardcoded Base64-encoded credential in source code | `resolvers/puls.ex:4` |
| B021-2 | HIGH | `receive/after` blocking retry loop inside GraphQL resolver | `resolvers/puls.ex:12-17` |
| B021-3 | HIGH | `IO.puts` debug output in production resolver | `resolvers/puls.ex:11` |
| B021-4 | MEDIUM | Inner `record` variable shadows outer `case` result binding | `resolvers/puls.ex:9-25` |
| B021-5 | MEDIUM | Bang-named function does not raise; nil-return matched in resolver | `resolvers/things.ex:4` |
| B021-6 | MEDIUM | Unreachable `nil` branch — `list_vxthings` never returns nil | `resolvers/things.ex:14-20` |
| B021-7 | LOW | Inconsistent indentation style between resolver files | `resolvers/puls.ex`, `resolvers/things.ex` |
| B021-8 | LOW | Double space in user-visible error message string | `resolvers/things.ex:6` |
| B021-9 | LOW | No aliases; full module paths repeated inline, inconsistent with project style | `resolvers/things.ex:4,14` |

**Total findings: 9**
- CRITICAL: 1
- HIGH: 2
- MEDIUM: 3
- LOW: 3
# Pass 4 – B022

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B022

**Files reviewed:**
- `lib/api_server_web/router.ex`
- `lib/api_server_web/schema.ex`
- `lib/api_server_web/schema/thing_types.ex`

---

## Reading Evidence

### lib/api_server_web/router.ex

**Module:** `ApiServerWeb.Router`

No named functions are defined directly. The file uses Phoenix router macros only.

**Pipelines defined:**
| Name | Line |
|---|---|
| `:browser` | 4 |
| `:api` | 12 |
| `:api_xml` | 18 |
| `:authenticated` | 24 |

**Scopes defined:**
| Scope path | Line | Pipelines |
|---|---|---|
| `/api/v1` (first) | 28 | none at scope open; `pipe_through([:api, :authenticated])` at line 33 |
| `/api/v1` (second) | 156 | `:api` |
| `/` | 179 | `:api_xml` |

**Routes (in order of appearance):**

| Line | Verb | Path | Controller | Action |
|---|---|---|---|---|
| 30 | GET | `/api/v1/rhm/engine_usage` | VXThingController | `:combined_engine_usage` |
| 31 | GET | `/api/v1/rhm/monday_hour_meters` | VXThingController | `:monday_hour_meters` |
| 36 | GET | `/api/v1/rhm/pape_export` | VXThingController | `:pape_export` |
| 37 | GET | `/api/v1/rhm/sielift_export` | VXThingController | `:sielift_export` |
| 40 | GET | `/api/v1/rhm/reports/geofence_events` | GeofenceController | `:process_things_geofences` |
| 41 | (commented out) | `/api/v1/rhm/work_in_progress` | VXThingController | `:work_in_progress` |
| 42 | GET | `/api/v1/rhm/work_in_progress` | VXThingController | `:sielift_export` |
| 45 | GET | `/api/v1/rhm/things_with_usage` | VXThingController | `:rhm_get_things_with_usage` |
| 46 | GET | `/api/v1/rhm/thing_records` | VXThingController | `:rhm_get_thing_records` |
| 47 | GET | `/api/v1/rhm/:customer/things/names` | VXThingController | `:rhm_get_things_names` |
| 48 | GET | `/api/v1/rhm/:customer/things` | VXThingController | `:rhm_get_things` |
| 50 | GET | `/api/v1/rhm/thing/:hardwareid/events` | VXThingController | `:rhm_get_thing_events` |
| 51 | GET | `/api/v1/rhm/thing/:hardwareid/usage` | VXThingController | `:rhm_get_thing_usage` |
| 52 | GET | `/api/v1/rhm/:customer/thing/:hardwareid` | VXThingController | `:rhm_get_thing` |
| 53 | GET | `/api/v1/rhm/thing/:hardwareid/active_rental` | VXRentalController | `:rhm_active_rental` |
| 54 | POST | `/api/v1/rhm/thing/` | VXThingController | `:update_thing` |
| 55 | PUT | `/api/v1/rhm/thing/` | VXThingController | `:create_thing` |
| 56 | GET | `/api/v1/rhm/thing/:hardwareid/omega_data` | VXThingEventController | `:get_current_omega_status` |
| 57 | GET | `/api/v1/vx/:customer/thing/:hardwareid/movements/:day` | VXThingController | `:get_movements` |
| 60–64 | GET | `/api/v1/rhm/omega_thing/:hardwareid/container_lift_report` | VXThingOmegaController | `:get_container_lift_report` |
| 66–70 | GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_summary_report` | VXThingOmegaController | `:get_lift_summary_report` |
| 72–76 | GET | `/api/v1/rhm/omega_thing/:hardwareid/lift_list_report` | VXThingOmegaController | `:get_lift_list_report` |
| 78–82 | GET | `/api/v1/rhm/omega_fleet/:fleetid/lift_summary_report` | VXThingOmegaController | `:get_lift_summary_report` |
| 84–88 | GET | `/api/v1/rhm/omega_thing/:hardwareid/engine_utilization_report` | VXThingOmegaController | `:get_engine_utilization_report` |
| 90–94 | GET | `/api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` | VXThingOmegaController | `:get_operation_summary_report` |
| 96–100 | GET | `/api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` | VXThingOmegaController | `:get_operation_summary_report` |
| 103 | GET | `/api/v1/rhm/fleets` | VXFleetController | `:get_fleets` |
| 104 | GET | `/api/v1/rhm/fleets_with_equipment` | VXFleetController | `:get_fleets_with_equipment` |
| 105 | PUT | `/api/v1/rhm/:customer/fleet/` | VXFleetController | `:create_fleet` |
| 106 | DELETE | `/api/v1/rhm/:customer/fleet/:id` | VXFleetController | `:delete_fleet` |
| 107 | POST | `/api/v1/rhm/:customer/fleet/` | VXFleetController | `:update_fleet` |
| 108 | GET | `/api/v1/rhm/:customer/fleet/:id/equipment` | VXFleetController | `:get_equipment_in_fleet` |
| 109 | POST | `/api/v1/rhm/:customer/fleet/:id/manage` | VXFleetController | `:manage_fleet` |
| 112 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXAblRecordController | `:rhm_service_records` |
| 115 | GET | `/api/v1/rhm/:customer/rentals` | VXRentalController | `:get_rentals` |
| 116 | POST | `/api/v1/rhm/:customer/rentals/` | VXRentalController | `:update_rental` |
| 117 | PUT | `/api/v1/rhm/:customer/rentals/` | VXRentalController | `:create_rental` |
| 118 | DELETE | `/api/v1/rhm/:customer/rentals/:id` | VXRentalController | `:delete_rental` |
| 120–124 | GET | `/api/v1/rhm/thing/:hardwareid/rental_anniversaries` | VXRentalController | `:get_rental_anniversaries` |
| 126 | GET | `/api/v1/rhm/rentals/midpac_style_report` | VXRentalController | `:get_midpac_style_rental_report` |
| 129 | POST | `/api/v1/rhm/user/change_password` | VXUserController | `:change_password` |
| 130 | GET | `/api/v1/rhm/user/:user_id/fleets` | VXUserController | `:get_user_fleets` |
| 131 | POST | `/api/v1/rhm/user/:user_id/fleets` | VXUserController | `:manage_user_fleets` |
| 132 | GET | `/api/v1/rhm/:customer/users` | VXUserController | `:get_users` |
| 133 | GET | `/api/v1/rhm/:customer/user/:email` | VXUserController | `:get_user_with_email` |
| 134 | POST | `/api/v1/rhm/:customer/user/` | VXUserController | `:update_user` |
| 135 | PUT | `/api/v1/rhm/:customer/user/` | VXUserController | `:create_user` |
| 136 | DELETE | `/api/v1/rhm/:customer/user/:id` | VXUserController | `:delete_user` |
| 139 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXCustomerController | `:index` |
| 140 | GET | `/api/v1/rhm/customer/:id` | VXCustomerController | `:show` |
| 141 | POST | `[REDACTED-AWS-SMTP-PASSWORD]` | VXCustomerController | `:update` |
| 142 | PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | VXCustomerController | `:create` |
| 143 | DELETE | `/api/v1/rhm/customer/:id` | VXCustomerController | `:delete` |
| 146 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXThingController | `:get_fleet_map` |
| 147 | GET | `/api/v1/rhm/fleetmap/:fleetid` | VXThingController | `:get_fleet_map` |
| 150 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | GeofenceController | `:list_all_geofences` |
| 151 | PUT | `[REDACTED-AWS-SMTP-PASSWORD]` | GeofenceController | `:create_geofence` |
| 152 | POST | `[REDACTED-AWS-SMTP-PASSWORD]` | GeofenceController | `:update_geofence` |
| 153 | DELETE | `/api/v1/rhm/geofence/:id` | GeofenceController | `:delete_geofence` |
| 159 | GET | `/api/v1/hc` | UtilityController | `:do_health_check` |
| 160 | POST | `/api/v1/rhm/:customer/login/` | VXUserController | `:login` |
| 162 | resources | `[REDACTED-AWS-SMTP-PASSWORD]` | VXThingSummaryController | (except :new, :edit) |
| 164 | (commented out) | `/api/v1/files` | FileController | `:index` |
| 165 | GET | `/api/v1/files/getsize/:esn` | FileController | `:get_size` |
| 166 | GET | `/api/v1/files/getfile/:esn` | FileController | `:send_file_download` |
| 169 | GET | `/api/v1/vx/:customer/thing/with_checklists` | VXThingController | `:get_hardware_with_checklists` |
| 170 | GET | `/api/v1/vx/:customer/thing/:hardwareid/checklists` | VXThingController | `:get_checklists` |
| 171 | GET | `/api/v1/vx/:customer/pmServicesAjax/:hardwareid` | VXThingController | `:get_pm_data` |
| 172 | GET | `/api/v1/vx/:customer/pmServicesAjax` | VXThingController | `:get_all_pm_data` |
| 173 | GET | `/api/v1/vx/:customer/rentalStats` | VXThingController | `:get_all_rental_stats` |
| 175 | GET | `[REDACTED-AWS-SMTP-PASSWORD]` | VXThingController | `:get_timezones` |
| 176 | GET | `/api/v1/rhm/:customer/fix_info` | VXThingInfoController | `:fix_infos` |
| 182 | GET | `/` | UtilityController | `:do_health_check` |
| 183 | GET | `/geocode` | UtilityController | `:do_geocode_lookup` |
| 184 | GET | `/error/:status_code` | UtilityController | `:do_error` |
| 185 | POST | `/test-omega-data` | UtilityController | `:process_incoming_omegawatch_data` |
| 186 | POST | `/prodisplay/event` | UtilityController | `:process_prodisplay_event` |
| 188 | POST | `/` | DigitalMatterController | `:get_g62_data` |
| 190 | POST | `/erp-import` | UtilityController | `:erp_import` |
| 191 | POST | `/driverid-converter` | UtilityController | `:driverid_converter` |
| 192 | GET | `/dis-sync` | UtilityController | `:sync_to_DISCorp` |

**Commented-out blocks:**
- Lines 13 (inside `:api` pipeline): `# plug CORSPlug, origin: "*"`
- Lines 19 (inside `:api_xml` pipeline): `# plug CORSPlug, origin: "*"`
- Line 41: `# get "/rhm/work_in_progress", VXThingController, :work_in_progress`
- Line 164: `# get "/files", FileController, :index`
- Lines 195–202: entire GraphQL `forward` block for `/graphql` and `/graphiql`

---

### lib/api_server_web/schema.ex

**Module:** `ApiServerWeb.Schema`

No named functions are defined. The file uses Absinthe schema macros only.

**Imports / aliases:**
| Item | Line |
|---|---|
| `use Absinthe.Schema` | 3 |
| `import_types Absinthe.Type.Custom` | 4 |
| `import_types ApiServerWeb.Schema.ThingTypes` | 5 |
| `alias ApiServerWeb.Resolvers` | 6 |

**GraphQL fields defined in `query` block:**
| Field name | Line | Return type | Arguments |
|---|---|---|---|
| `:get_thing` | 11 | `:thing` | `aadhardwareid` (non-null string), `customer` (non-null string) |
| `:get_puls_record` | 18 | `:puls_record` | `hardwareid` (non-null string) |
| `:get_all_things` | 23 | `list_of(:thing)` | `customer` (non-null string) |

**Resolvers referenced:**
- `Resolvers.Things.find_thing/3` (line 14)
- `Resolvers.Puls.puls_record/3` (line 20)
- `Resolvers.Things.get_all_things/3` (line 26)

**Commented-out code:** None within this file itself — the GraphQL forwarding is commented out in router.ex, not here.

---

### lib/api_server_web/schema/thing_types.ex

**Module:** `ApiServerWeb.Schema.ThingTypes`

No named functions. Uses Absinthe schema notation macros.

**Types defined:**

`:thing` object (line 5–37):
| Field | Type |
|---|---|
| `aadcustcode` | `:string` |
| `aaddesc` | `:string` |
| `aadintext` | `:string` |
| `aadaddr` | `:string` |
| `aadcustomerid` | `:integer` |
| `aadcat` | `:integer` |
| `aadhardwareid` | `:string` |
| `aadhw_type` | `:integer` |
| `aadmake` | `:string` |
| `aadmodel` | `:string` |
| `aadserialno` | `:string` |
| `aadmobile` | `:string` |
| `aadimei` | `:string` |
| `aadhourmeter` | `:float` |
| `aadhourmeter1` | `:float` |
| `aadhourmeter2` | `:float` |
| `aadhourmeter3` | `:float` |
| `aadhourmeter4` | `:float` |
| `aadodometer` | `:integer` |
| `aadhourmeteromega` | `:float` |
| `aadhourmeterothcan` | `:float` |
| `aaddateintoservice` | `:date` |
| `aadlastservice` | `:date` |
| `aadvalid` | `:string` |
| `aadserviceoffset` | `:float` |
| `aadsvchrs` | `:integer` |
| `aadrange_lat` | `:float` |
| `aadrange_long` | `:float` |
| `aadrange_dist` | `:integer` |
| `aadrange_unit` | `:string` |
| `service_calculation_input` | `:string` |

`:puls_record` object (line 41–45):
| Field | Type |
|---|---|
| `esn` | `:string` |
| `iccid` | `:string` |
| `group` | `:string` |

**Constants / errors defined:** None.

---

## Findings

---

**B022-1** — [HIGH] Route/handler mismatch: `:work_in_progress` route silently calls `:sielift_export`

File: `lib/api_server_web/router.ex:41-42`

The commented-out line at line 41 shows the original intent: `get "/rhm/work_in_progress", VXThingController, :work_in_progress`. The live route directly below it at line 42 uses the same URL path but dispatches to `:sielift_export` instead. This is not a temporary workaround that was cleaned up; the original route declaration was left as a comment alongside the substitute, creating a permanent lie in the routing table. Any caller or developer reading the URL `/rhm/work_in_progress` has no indication they are actually invoking sielift export logic. If `:sielift_export` is ever changed or removed independently, this silent aliasing makes the breakage harder to diagnose. The commented line also constitutes commented-out code (see B022-2).

---

**B022-2** — [LOW] Commented-out route: `:work_in_progress` original declaration left in place

File: `lib/api_server_web/router.ex:41`

The line `# get "/rhm/work_in_progress", VXThingController, :work_in_progress` is dead commented-out code left directly above its live replacement. It should be removed once the intent of the substitution is documented. Its presence alongside the live route (B022-1) is actively misleading.

---

**B022-3** — [MEDIUM] Commented-out code: entire GraphQL forwarding block never removed

File: `lib/api_server_web/router.ex:195-202`

Eight lines of commented-out `forward` declarations for `/graphql` and `/graphiql` remain in the router. The full `ApiServerWeb.Schema` module and its types are fully defined and compiled, yet the only entry points into the GraphQL layer are commented out. This means the schema module (`schema.ex`, `thing_types.ex`) and all three resolvers it references compile and are linked into the application but are completely unreachable at runtime. The comment block provides no explanation of whether this feature was abandoned, is planned, or is gated behind a flag. This is not merely style debt: the entire GraphQL stack is dead weight that increases binary size, complicates dependency management, and misleads developers about available API surfaces.

---

**B022-4** — [MEDIUM] Dead code: GraphQL schema and types are compiled but entirely unreachable

File: `lib/api_server_web/schema.ex:1-29`, `lib/api_server_web/schema/thing_types.ex:1-47`

As a direct consequence of B022-3, `ApiServerWeb.Schema` and `ApiServerWeb.Schema.ThingTypes` are compiled modules with no live callers. The three resolver functions (`Resolvers.Things.find_thing/3`, `Resolvers.Puls.puls_record/3`, `Resolvers.Things.get_all_things/3`) are also compiled and linked, but never invoked. The `alias ApiServerWeb.Resolvers` in `schema.ex` line 6 is a build-time alias used only through the commented-out forwarding path; it resolves but is operationally unused at runtime. If the GraphQL feature is not planned for re-enablement, these modules should be deleted. If it is planned, the forwarding should be restored and the commented-out block in the router removed.

---

**B022-5** — [LOW] Commented-out code: CORSPlug disabled in both API pipelines with no explanation

File: `lib/api_server_web/router.ex:13`, `lib/api_server_web/router.ex:19`

`# plug CORSPlug, origin: "*"` is commented out in both the `:api` pipeline (line 13) and the `:api_xml` pipeline (line 19). The `:browser` pipeline has no such comment. There is no explanation for why CORS handling is disabled, nor any indication of whether this is intentional policy or an oversight. Disabling CORS handling silently means cross-origin requests to all `/api/v1` and root XML endpoints are governed only by browser defaults, which may or may not be acceptable depending on client deployment. The commented-out code should either be deleted with a changelog note or restored with a clear reason in a comment.

---

**B022-6** — [LOW] Commented-out route: `/files` index route left in place

File: `lib/api_server_web/router.ex:164`

`# get "/files", FileController, :index` is commented out with no explanation. Two other `FileController` routes immediately follow (`get_size` at line 165, `send_file_download` at line 166). It is unclear whether the index action was intentionally disabled, never implemented, or removed as dead code. The dead comment adds noise and should be removed or restored.

---

**B022-7** — [HIGH] Duplicate route: `/rhm/omega_fleet/:fleetid/operation_summary_report` registered twice

File: `lib/api_server_web/router.ex:90-100`

The route `GET /api/v1/rhm/omega_fleet/:fleetid/operation_summary_report` dispatching to `VXThingOmegaController.:get_operation_summary_report` is declared identically at lines 90–94 and again at lines 96–100. Phoenix will compile both and the first match wins, making the second route permanently unreachable. This is a build warning in recent Phoenix/Plug versions (`warning: this clause cannot match because a previous clause at line N always matches`). The duplicate should be deleted.

---

**B022-8** — [MEDIUM] Authentication bypass: two routes outside `pipe_through` in an authenticated scope

File: `lib/api_server_web/router.ex:29-33`

Within the first `/api/v1` scope (line 28), `pipe_through([:api, :authenticated])` is invoked at line 33 — *after* two routes have already been declared at lines 30–31:

```elixir
get("/rhm/engine_usage", VXThingController, :combined_engine_usage)
get("/rhm/monday_hour_meters", VXThingController, :monday_hour_meters)
...
pipe_through([:api, :authenticated])
```

In Phoenix, `pipe_through` inside a scope applies to all routes in that scope regardless of declaration order — the plug pipeline is not conditional on position. However, this layout is dangerously misleading: it strongly implies to any reader that the two routes above the `pipe_through` call are intentionally unauthenticated, when in fact (per Phoenix semantics) they will also pass through `:authenticated`. The comment at line 29 (`# Avoid authentication, locking to a specific database`) reinforces the developer's belief that these routes skip authentication. If the developer's intent was truly to make these routes unauthenticated, the implementation is wrong and both routes are silently authenticated. If the intent was always to authenticate them, the comment is false and misleading. Either way, the code does not accurately express its intent, which constitutes a latent security defect.

---

**B022-9** — [LOW] Style inconsistency: mixed REST verb conventions for create/update operations

File: `lib/api_server_web/router.ex:54-55`, `105-107`, `116-117`, `129-136`, `141-143`

Throughout the router, create operations consistently use `PUT` and update operations use `POST`. This is the inverse of conventional REST semantics (POST for create, PUT for idempotent update/replace). The pattern is applied consistently within the codebase, but it directly contradicts RFC 7231 and the Rails/Phoenix default resource conventions. Any new developer or external integrator will be confused. The `resources/3` macro at line 162 for `[REDACTED-AWS-SMTP-PASSWORD]` uses the conventional mapping (Phoenix default: POST for create, PUT/PATCH for update), creating an internal inconsistency between RESTful resource routes and manually declared routes. This makes the API surface inconsistent and error-prone for clients.

---

**B022-10** — [INFO] Indentation inconsistency in schema.ex

File: `lib/api_server_web/schema.ex:1-29`

The top-level module body uses 4-space indentation (lines 3–6 are indented with 4 spaces relative to the `defmodule`), while Elixir community convention (and the style used in `thing_types.ex`) is 2-space indentation. This does not affect compilation or runtime behavior but is a style inconsistency that will produce diff noise and may trigger credo style warnings.

---

## Summary Table

| ID | Severity | File(s) | Short Title |
|---|---|---|---|
| B022-1 | HIGH | router.ex:41-42 | Route/handler mismatch: work_in_progress calls sielift_export |
| B022-2 | LOW | router.ex:41 | Commented-out original work_in_progress route left in place |
| B022-3 | MEDIUM | router.ex:195-202 | Entire GraphQL forwarding block commented out with no explanation |
| B022-4 | MEDIUM | schema.ex, thing_types.ex | GraphQL schema modules compiled but entirely unreachable at runtime |
| B022-5 | LOW | router.ex:13,19 | CORSPlug disabled in both API pipelines with no explanation |
| B022-6 | LOW | router.ex:164 | Commented-out /files index route left in place |
| B022-7 | HIGH | router.ex:90-100 | Duplicate route: operation_summary_report registered twice |
| B022-8 | MEDIUM | router.ex:29-33 | Authentication bypass ambiguity: pipe_through after route declarations |
| B022-9 | LOW | router.ex (multiple) | Mixed REST verb conventions (PUT=create, POST=update) inconsistent with Phoenix resources macro |
| B022-10 | INFO | schema.ex | 4-space indentation inconsistent with 2-space Elixir convention |

**Total findings: 10** (2 HIGH, 3 MEDIUM, 4 LOW, 1 INFO)
# Pass 4 – B023

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B023
**Pass:** 4 – Code Quality

**Files reviewed:**
- `lib/api_server_web/views/changeset_view.ex`
- `lib/api_server_web/views/error_helpers.ex`
- `lib/api_server_web/views/error_view.ex`
- `lib/api_server_web/views/file_view.ex`

---

## Reading Evidence

### `lib/api_server_web/views/changeset_view.ex`

**Module:** `ApiServerWeb.ChangesetView`

**Functions:**

| Name | Line |
|---|---|
| `translate_errors/1` | 10 |
| `render/2` (clause `"error.json"`) | 14 |

**Types / constants defined:** none

**Notes:** `translate_errors/1` delegates to `Ecto.Changeset.traverse_errors/2` and `translate_error/1` (imported from `ApiServerWeb.ErrorHelpers` via `use ApiServerWeb, :view`). Only one render clause defined; the function is public but only called from within the same module.

---

### `lib/api_server_web/views/error_helpers.ex`

**Module:** `ApiServerWeb.ErrorHelpers`

**Functions:**

| Name | Line |
|---|---|
| `error_tag/2` | 11 |
| `translate_error/1` | 20 |

**Types / constants defined:** none

**Notes:** Uses `Phoenix.HTML` (for `content_tag/3`). `translate_error/1` is consumed by `ApiServerWeb.ChangesetView` and is imported into every view module via `use ApiServerWeb, :view`. `error_tag/2` generates HTML `<span>` elements with CSS class `"help-block"`.

---

### `lib/api_server_web/views/error_view.ex`

**Module:** `ApiServerWeb.ErrorView`

**Functions:**

| Name | Line |
|---|---|
| `template_not_found/2` | 13 |

**Types / constants defined:** none

**Notes:** Contains a commented-out render clause for `"500.html"` (lines 6–8). The active `template_not_found/2` is a Phoenix fallback callback; it returns a map with an `:error` key rather than a plain string, which means JSON clients receive a structured response regardless of the requested template name/format.

---

### `lib/api_server_web/views/file_view.ex`

**Module:** `ApiServerWeb.FileView`

**Functions:**

| Name | Line |
|---|---|
| `render/2` (clause `"index.json"`) | 5 |
| `render/2` (clause `"show.json"`) | 9 |
| `render/2` (clause `"filesize.json"`) | 13 |
| `render/2` (clause `"file.json"`) | 20 |

**Types / constants defined:** none

**Aliases:** `alias ApiServerWeb.FileView` (line 3) — self-alias used to pass the current module as the view argument to `render_many/3` and `render_one/3`.

**Notes:** The controller (`FileController`) only ever calls `render(conn, "filesize.json", ...)`. The `"index.json"` and `"show.json"` clauses (and their shared `"file.json"` helper) have no corresponding controller action calling them. The `"filesize.json"` clause omits the `fobs` key that `"file.json"` includes; the two shapes are intentionally different.

---

## Findings

---

**B023-1** — [LOW] Commented-out render clause left in production source

File: `lib/api_server_web/views/error_view.ex:6-8`

Description: Lines 6–8 contain a commented-out function clause:

```elixir
# def render("500.html", _assigns) do
#   "Internal Server Error"
# end
```

The accompanying comment on lines 4–5 frames this as an intentional example ("If you want to customize…"), which is boilerplate left over from the Phoenix generator. Commented-out code in a generated file that has since been put into production use should be removed; it creates noise when reading the module and could mislead a maintainer into thinking the clause was recently disabled for a reason.

---

**B023-2** — [MEDIUM] `error_tag/2` is dead code — the application has no HTML forms

File: `lib/api_server_web/views/error_helpers.ex:11`

Description: `error_tag/2` generates HTML `<span class="help-block">` error tags for Phoenix form helpers. A search across all `.ex`, `.eex`, `.heex`, and `.leex` files in the repository finds zero call-sites for `error_tag/2`. The application is a JSON API server; the only template files present (`app.html.eex`, `page/index.html.eex`) are Phoenix-generator placeholders. The function is imported into every view module via `use ApiServerWeb, :view`, so it never triggers an "unused import" warning, but it is never exercised at runtime.

Keeping it raises two concerns:
1. It silently imports `Phoenix.HTML` (`use Phoenix.HTML` at line 6) purely to support `content_tag/3`, pulling in a dependency that is otherwise unused in this module.
2. It misleads maintainers into believing the codebase has, or intends to have, server-rendered HTML forms.

---

**B023-3** — [LOW] `use Phoenix.HTML` imported solely to support a dead function

File: `lib/api_server_web/views/error_helpers.ex:6`

Description: The only consumer of the `Phoenix.HTML` import in this module is `content_tag/3`, called exclusively from `error_tag/2` (finding B023-2). If `error_tag/2` is removed, the `use Phoenix.HTML` line becomes entirely unnecessary. Even if `error_tag/2` is retained, this is a build-warning-class issue: the Elixir compiler will emit warnings about unused imports if `Phoenix.HTML` macros are never called in compiled code paths. The import exists solely to prop up dead code.

---

**B023-4** — [MEDIUM] `render("index.json")` and `render("show.json")` clauses in `FileView` are dead code

File: `lib/api_server_web/views/file_view.ex:5-11`

Description: `ApiServerWeb.FileController` — the only controller that uses `ApiServerWeb.FileView` — defines only two actions: `get_size/2` (renders `"filesize.json"`) and `send_file_download/2` (streams a binary download, no view render). No controller anywhere in the project calls `render(conn, "index.json", files: ...)` or `render(conn, "show.json", file: ...)` targeting `FileView`.

Consequently:
- `render("index.json", %{files: files})` at line 5 is never invoked.
- `render("show.json", %{file: file})` at line 9 is never invoked.
- `render("file.json", %{file: file})` at line 20 is dead by transitivity (called only by the two dead clauses above via `render_many`/`render_one`).

Three of the four render clauses in this view module are unreachable. This indicates either planned functionality that was never implemented or leftovers from generator scaffolding that was not cleaned up.

---

**B023-5** — [LOW] Self-alias pattern is unnecessary boilerplate in `FileView`

File: `lib/api_server_web/views/file_view.ex:3`

Description:

```elixir
alias ApiServerWeb.FileView
```

This alias is used at lines 6 and 10 to pass the current module to `render_many/3` and `render_one/3`. The idiomatic Elixir/Phoenix pattern is to use `__MODULE__` for this purpose, which is unambiguous and does not require an alias declaration. Using an explicit self-alias adds a line of noise and creates a minor trap: if the module is renamed, the alias must be updated in two places (the module name and the alias line) instead of one. This is a style-consistency issue relative to the other views in the codebase (e.g., `GeofenceView`, `VxThingView`) which use the aliased module name but obtain it from the generator — the inconsistency here is that this pattern is unnecessary overhead for a self-reference.

---

**B023-6** — [INFO] `translate_errors/1` is public but only called internally

File: `lib/api_server_web/views/changeset_view.ex:10`

Description: `translate_errors/1` is defined as a public function (`def`) but is only called from within `ApiServerWeb.ChangesetView` itself, at line 11 inside `render("error.json", ...)`. No other module calls it. It could be made private (`defp`) to enforce encapsulation and allow the compiler to warn if it ever becomes unused. This is a minor encapsulation issue, not a correctness problem.

---

**B023-7** — [LOW] Style inconsistency: map formatting differs between render clauses in `FileView`

File: `lib/api_server_web/views/file_view.ex:13-26`

Description: The `"filesize.json"` and `"file.json"` render clauses format their return maps inconsistently:

`"filesize.json"` (lines 14–17):
```elixir
%{hardwareid: file.hardwareid,
  size: file.size,
  num_fobs: file.num_fobs }
```
— closing `}` is on the same line as the last key-value pair, with a space before it.

`"file.json"` (lines 21–25):
```elixir
%{hardwareid: file.hardwareid,
  size: file.size,
  num_fobs: file.num_fobs,
  fobs: file.fobs
}
```
— closing `}` is on its own line, no trailing space.

Within the same file, two structurally similar map literals use different closing-brace placement. This inconsistency is a style finding. The `"filesize.json"` style also has a trailing space before the closing brace, which is non-standard.

Additionally, there is a double blank line between the `"show.json"` and `"filesize.json"` clauses (line 18–19) while other clause boundaries use a single blank line — a minor but consistent formatting deviation.

---

## Summary Table

| ID | Severity | Title | File | Line(s) |
|---|---|---|---|---|
| B023-1 | LOW | Commented-out render clause left in production source | `error_view.ex` | 6–8 |
| B023-2 | MEDIUM | `error_tag/2` is dead code — no HTML forms in API server | `error_helpers.ex` | 11–15 |
| B023-3 | LOW | `use Phoenix.HTML` imported solely to support dead function | `error_helpers.ex` | 6 |
| B023-4 | MEDIUM | `render("index.json")`, `render("show.json")`, `render("file.json")` are dead code | `file_view.ex` | 5–11, 20–26 |
| B023-5 | LOW | Unnecessary self-alias; `__MODULE__` is the idiomatic alternative | `file_view.ex` | 3 |
| B023-6 | INFO | `translate_errors/1` should be private (`defp`) | `changeset_view.ex` | 10 |
| B023-7 | LOW | Inconsistent map literal formatting within `FileView` | `file_view.ex` | 14–17, 21–25 |
# Pass 4 – B024

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Pass:** 4 (Code Quality)

## Files Reviewed

- `lib/api_server_web/views/geofence_view.ex`
- `lib/api_server_web/views/layout_view.ex`
- `lib/api_server_web/views/page_view.ex`
- `lib/api_server_web/views/vx_abl_record_view.ex`

---

## Reading Evidence

### `lib/api_server_web/views/geofence_view.ex`

**Module:** `ApiServerWeb.GeofenceView`

**Aliases declared:**
- `ApiServerWeb.GeofenceView` (line 4)
- `ApiServerWeb.VXThingView` (line 5)
- `ApiServer.Vx` (line 6)
- `ApiServer.Vx.Geofence` (line 7)

**Functions:**

| Line | Name/Arity | Notes |
|------|-----------|-------|
| 9    | `render/2` — `"index.json"` | Delegates to `render_many` with `GeofenceView` |
| 13   | `render/2` — `"geofence.json"` | Returns id, name, geoJSON |
| 22   | `render/2` — `"geofence_events.json"` | Maps events, calls `render_one` with `VXThingView` / `"rhm_thing.json"` |

**Types / constants / errors defined:** None.

---

### `lib/api_server_web/views/layout_view.ex`

**Module:** `ApiServerWeb.LayoutView`

**Aliases declared:** None.

**Functions:** None (module body contains only `use ApiServerWeb, :view`).

**Types / constants / errors defined:** None.

---

### `lib/api_server_web/views/page_view.ex`

**Module:** `ApiServerWeb.PageView`

**Aliases declared:** None.

**Functions:** None (module body contains only `use ApiServerWeb, :view`).

**Types / constants / errors defined:** None.

---

### `lib/api_server_web/views/vx_abl_record_view.ex`

**Module:** `ApiServerWeb.VXAblRecordView`

**Aliases declared:**
- `ApiServerWeb.VXAblRecordView` (line 4)
- `ApiServer.Vx` (line 5)

**Functions:**

| Line | Name/Arity | Notes |
|------|-----------|-------|
| 8    | `render/2` — `"index.json"` | Wraps `render_many` in `%{data: ...}` |
| 12   | `render/2` — `"show.json"` | Wraps `render_one` in `%{data: ...}` |
| 16   | `render/2` — `"vx_abl_record.json"` | Returns id and ablcustcode only |
| 22   | `render/2` — `"services.json"` | Maps records, delegates to `"service.json"` via `render_one` with tuple arg |
| 28   | `clean_xml_value/1` | Public; maps `%{}` -> `nil`, otherwise identity |
| 37   | `clean_xml_number_value/1` | Public; maps `%{}` -> `0`, otherwise identity |
| 46   | `render/2` — `"service.json"` | Main audit-log render; calls `Vx.get_vx_thing_with_hardware_id!`; builds full map |

**Types / constants / errors defined:** None.

---

## Findings

### B024-1 — [HIGH] Dead code: `clean_xml_value/1` and `clean_xml_number_value/1` duplicated in view, never called

**File:** `lib/api_server_web/views/vx_abl_record_view.ex:28` and `:37`

**Description:**
`clean_xml_value/1` (line 28) and `clean_xml_number_value/1` (line 37) are defined as public functions in `ApiServerWeb.VXAblRecordView`. An exhaustive search across all `.ex` files under `lib/` shows that neither function is called anywhere — not within the view itself, not from any controller, and not from any other module. The identical functions exist (and are actively used) in `ApiServer.VxAblRecord` (`lib/api_server/vx/vx_abl_record.ex:54` and `:63`).

These functions appear to be stale copies that were pasted into the view module during an earlier refactor and then never wired up. Because they are `def` (public), not `defp`, they are part of the module's exported interface despite being unreachable from any call site. This is dead code that silently widens the public API and will never be exercised.

Severity is HIGH rather than MEDIUM because `clean_xml_number_value/1` is not only dead in the view but also dead in its context module (`vx_abl_record.ex` defines it but never calls it), meaning the numeric-zero sentinel path has no production consumer at all, indicating a logic gap that may have been intentional at one point and silently dropped.

---

### B024-2 — [MEDIUM] Logic executed inside a view: database call in `render/2`

**File:** `lib/api_server_web/views/vx_abl_record_view.ex:49`

**Description:**
The `render("service.json", ...)` clause (line 46) makes a direct call to `Vx.get_vx_thing_with_hardware_id!(record.hardwareid, customer)` on line 49. This is a database query issued inside a view render function. Phoenix views are intended to be pure presentation/serialization layers; all data fetching is expected to happen in controllers or context modules before the render call. Placing a database call here:

1. Bypasses the controller's ability to handle query errors gracefully — the bang function will raise on miss, producing an unhandled exception rather than a controlled error response.
2. Makes the render clause non-pure: the same input data can produce different output (or raise) depending on database state at render time.
3. Hides N+1 query risk — this call is inside `render("service.json", ...)` which is invoked per-record by `Enum.map` in `render("services.json", ...)`.

This is a leaky abstraction: the data-access layer is being breached inside the presentation layer.

---

### B024-3 — [MEDIUM] Inconsistent response envelope across render clauses

**File:** `lib/api_server_web/views/vx_abl_record_view.ex:8–25`

**Description:**
The `"index.json"` and `"show.json"` clauses wrap their payloads in a `%{data: ...}` envelope (lines 9 and 13), matching the conventional JSON API style used elsewhere in the project. However, `"services.json"` (line 22) returns a bare list with no envelope, and `"geofence_events.json"` in `GeofenceView` (line 24) similarly returns a bare list. Within `VXAblRecordView` specifically, the inconsistency means two render paths from the same module use different top-level shapes, which breaks client-side predictability and contradicts the convention established by `index.json` and `show.json` in the same module.

---

### B024-4 — [LOW] Unused alias: `ApiServer.Vx` in `GeofenceView`

**File:** `lib/api_server_web/views/geofence_view.ex:6`

**Description:**
`alias ApiServer.Vx` is declared on line 6 of `GeofenceView`. The module's three render functions only reference `GeofenceView`, `VXThingView`, and `Geofence` (the last alias on line 7). No call to `Vx.*` appears anywhere within this module. The `Vx` alias is therefore unused and will generate an Elixir compiler warning (`warning: unused alias Vx`). Unused aliases indicate incomplete refactoring and add noise to the module's dependency surface.

---

### B024-5 — [LOW] `nil` guard using `if thing != nil` instead of pattern matching

**File:** `lib/api_server_web/views/vx_abl_record_view.ex:50`

**Description:**
Inside `render("service.json", ...)`, line 50 uses `if thing != nil do` to guard the branch that accesses `thing.fleet_thing_joins`. This is an anti-pattern in Elixir: the idiomatic approach is to guard with a `nil`-matching function clause or use `case`. Using `if thing != nil` is fragile because it still executes `Vx.get_vx_thing_with_hardware_id!/2` (which has a bang and will raise on not-found) before reaching the guard; if the function raises, the `nil` check is never reached. The guard provides false safety. Pattern matching at the function clause level or using `with` would make the control flow explicit and safe.

---

### B024-6 — [LOW] `cond` used where `if/else` or pattern matching is idiomatic

**File:** `lib/api_server_web/views/vx_abl_record_view.ex:29–44` and `60–65`

**Description:**
`clean_xml_value/1` (lines 29–34), `clean_xml_number_value/1` (lines 38–44), and the `user_name` derivation (lines 60–65) all use `cond do` with exactly two clauses where the second is `true ->`. In Elixir, two-clause `cond` with a `true` catch-all is stylistically equivalent to `if/else` and the idiomatic form is to use two function clauses with pattern matching (for `clean_xml_*`) or `if/else` (for the inline expression). This pattern appears three times within the same module and once in the sibling `vx_abl_record.ex` context module, representing a consistent but non-idiomatic coding style that would produce Dialyzer/Credo style warnings in a strict project configuration.

---

### B024-7 — [INFO] `LayoutView` and `PageView` are empty scaffolding modules

**File:** `lib/api_server_web/views/layout_view.ex:1–3` and `lib/api_server_web/views/page_view.ex:1–3`

**Description:**
Both `ApiServerWeb.LayoutView` and `ApiServerWeb.PageView` contain only `use ApiServerWeb, :view` and no functions. These are Phoenix-generated scaffold modules. For a JSON-only API server (which this appears to be), `PageView` in particular is never referenced and represents generated boilerplate that was never removed. This is INFO only — Phoenix convention generates these and their presence is not harmful — but in a pure-API application with no HTML templates, `PageView` is dead code at the module level.

---

## Summary Table

| ID      | Severity | File                             | Title |
|---------|----------|----------------------------------|-------|
| B024-1  | HIGH     | `vx_abl_record_view.ex:28,37`   | Dead code: `clean_xml_value/1` and `clean_xml_number_value/1` defined but never called in view |
| B024-2  | MEDIUM   | `vx_abl_record_view.ex:49`      | Leaky abstraction: database query inside view render clause (N+1 risk, unhandled raise) |
| B024-3  | MEDIUM   | `vx_abl_record_view.ex:8–25`    | Inconsistent response envelope: `index`/`show` use `%{data:}`, `services` returns bare list |
| B024-4  | LOW      | `geofence_view.ex:6`            | Unused alias `ApiServer.Vx` — will produce compiler warning |
| B024-5  | LOW      | `vx_abl_record_view.ex:50`      | `nil` guard via `if thing != nil` after bang function — false safety |
| B024-6  | LOW      | `vx_abl_record_view.ex:29–65`   | Two-clause `cond` used where `if/else` or pattern matching is idiomatic |
| B024-7  | INFO     | `layout_view.ex`, `page_view.ex` | Empty scaffold modules; `PageView` likely dead in a pure-API application |
# Pass 4 – B025

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B025

**Files reviewed:**
- `lib/api_server_web/views/vx_access_fob_view.ex`
- `lib/api_server_web/views/vx_customer_view.ex`
- `lib/api_server_web/views/vx_fleet_association_view.ex`
- `lib/api_server_web/views/vx_fleet_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_access_fob_view.ex`

**Module:** `ApiServerWeb.VXAccessFobView`

**Aliases:**
- `ApiServerWeb.VXAccessFobView` (line 3) — self-alias for use in `render_many`/`render_one` calls

**Functions:**

| Function | Line |
|---|---|
| `render("index.json", %{vxaccessfobs: vxaccessfobs})` | 5 |
| `render("show.json", %{vx_access_fob: vx_access_fob})` | 9 |
| `render("vx_access_fob.json", %{vx_access_fob: vx_access_fob})` | 13 |

**Types / Constants / Errors defined:** None

**Notes:** All three `render` clauses are standard scaffold output. `index.json` wraps in `%{data: ...}`. `show.json` wraps in `%{data: ...}`. The partial `"vx_access_fob.json"` returns only `id` and `fob_code`.

---

### File 2: `lib/api_server_web/views/vx_customer_view.ex`

**Module:** `ApiServerWeb.VXCustomerView`

**Aliases:**
- `ApiServerWeb.VXCustomerView` (line 3) — self-alias

**Functions:**

| Function | Line |
|---|---|
| `render("index.json", %{vx_customers: vx_customers})` | 5 |
| `render("show.json", %{vx_customer: vx_customer})` | 9 |
| `render("vx_customer.json", %{vx_customer: nil})` | 13 |
| `render("vx_customer.json", %{vx_customer: vx_customer})` | 14 |

**Types / Constants / Errors defined:** None

**Notes:**
- `index.json` returns a bare list (no `%{data: ...}` wrapper) — contrast with the other three view files which all wrap.
- `show.json` also returns a bare value (no `%{data: ...}` wrapper).
- Two-clause guard on the partial: `nil` short-circuits to `%{}`, then `Ecto.assoc_loaded?/1` is checked inside the second clause.
- Lines 30–31 contain commented-out fields (`aaaudfcustcode`, `aaacolour`).
- The second `render("vx_customer.json", ...)` clause uses an imperative `if !Ecto.assoc_loaded?` rather than a separate function-head guard.

---

### File 3: `lib/api_server_web/views/vx_fleet_association_view.ex`

**Module:** `ApiServerWeb.VXFleetAssociationView`

**Aliases:**
- `ApiServerWeb.VXFleetAssociationView` (line 3) — self-alias

**Functions:**

| Function | Line |
|---|---|
| `render("index.json", %{vxfleetassociationss: vxfleetassociationss})` | 5 |
| `render("show.json", %{vx_fleet_association: vx_fleet_association})` | 9 |
| `render("vx_fleet_association.json", %{vx_fleet_association: vx_fleet_association})` | 13 |

**Types / Constants / Errors defined:** None

**Notes:**
- The `index.json` assign key is `[REDACTED-AWS-SMTP-PASSWORD]` (double trailing `s`).
- The corresponding controller (`[REDACTED-AWS-SMTP-PASSWORD]`, line 11) assigns the key as `vxfleetassociations` (single `s`).
- This mismatch causes a `FunctionClauseError` at runtime whenever `index` is called.
- The partial exposes `aafcustcode` as a raw database column name in the JSON response key.

---

### File 4: `lib/api_server_web/views/vx_fleet_view.ex`

**Module:** `ApiServerWeb.VXFleetView`

**Aliases:**
- `ApiServerWeb.VXFleetView` (line 3) — self-alias

**Functions:**

| Function | Line |
|---|---|
| `render("index.json", %{vxfleets: vxfleets})` | 5 |
| `render("show.json", %{vx_fleet: vx_fleet})` | 9 |
| `render("vx_fleet.json", %{vx_fleet: vx_fleet})` | 13 |
| `render("rhm_fleets.json", %{vx_fleets: vx_fleets})` | 22 |
| `render("rhm_fleet.json", %{vx_fleet: vx_fleet})` | 25 |
| `render("rhm_fleets_with_equip.json", %{vx_fleets: vx_fleets})` | 34 |
| `render("rhm_fleet_with_equip.json", %{vx_fleet: vx_fleet})` | 37 |
| `render("rhm_fleet_equipment.json", %{results: results})` | 47 |
| `render("assoc.json", %{vx_fleet: {fleet_id, equipment_id, equipment_name}})` | 51 |

**Types / Constants / Errors defined:** None

**Notes:**
- `render("index.json", ...)` is never called by any controller (confirmed by searching all controllers). The fleet controller uses only `show.json`, `rhm_fleets.json`, `rhm_fleets_with_equip.json`, `rhm_fleet.json`, `rhm_fleet_equipment.json`.
- `render("vx_fleet.json", ...)` exposes raw database column names (`aaetype`, `aaeshowfilter`, `aaecolour`) as JSON keys. The `rhm_fleet.json` partial for the same data uses human-readable aliases (`type`, `show_in_filters`, `color`). These two render the same underlying struct fields but with different key naming conventions.
- Blank line inconsistency: a double blank line appears at line 45–46 between `render("rhm_fleet_with_equip.json", ...)` and `render("rhm_fleet_equipment.json", ...)`, and a trailing blank line inside the body of `render("rhm_fleet_equipment.json", ...)` at line 49.
- `render("rhm_fleet_with_equip.json", ...)` omits `color` / `aaecolour` compared to `rhm_fleet.json`, even though both render the same struct.

---

## Findings

---

**B025-1** — HIGH — Runtime FunctionClauseError: `index.json` assign key mismatch in VXFleetAssociationView
File: `lib/api_server_web/views/vx_fleet_association_view.ex:5`
Description: The view's `render("index.json", ...)` clause pattern-matches on the key `[REDACTED-AWS-SMTP-PASSWORD]` (double `s`), but `VXFleetAssociationController.index/2` assigns the key as `vxfleetassociations` (single `s`) — confirmed at `lib/api_server_web/controllers/vx_fleet_association_controller.ex:11`. Because Phoenix dispatches `render/2` via pattern matching, a request to the `index` action will always raise `Phoenix.View.RenderError` (wrapping a `FunctionClauseError`) at runtime. The mismatch is invisible at compile time. Any client calling the list endpoint receives a 500 error.

---

**B025-2** — LOW — Commented-out code left in production view
File: `lib/api_server_web/views/vx_customer_view.ex:30-31`
Description: Two fields are commented out inside the `render("vx_customer.json", ...)` response map:
```elixir
# aaaudfcustcode: vx_customer.aaaudfcustcode,
# aaacolour: vx_customer.aaacolour
```
Commented-out code in a view is either dead code that should be deleted, or intentionally suppressed output that should be tracked via a feature flag or a separate branch. As written it creates ambiguity about the intended public API shape and will confuse maintainers.

---

**B025-3** — MEDIUM — `index.json` and `show.json` lack `%{data: ...}` envelope in VXCustomerView; inconsistent with all peer views
File: `lib/api_server_web/views/vx_customer_view.ex:5-10`
Description: `render("index.json", ...)` returns a bare list and `render("show.json", ...)` returns a bare value. Every other view in the same directory (`VXAccessFobView`, `[REDACTED-AWS-SMTP-PASSWORD]`, `VXFleetView`, `VXThingView`, `VXThingSummaryView`, `VXThingEventView`, `VXUserFunctionView`, `VXRestrictionView`, `VXAblRecordView`) wraps the result in `%{data: ...}`. This breaks API envelope consistency for customers and makes the customer endpoint a special case for all API consumers and tests.

---

**B025-4** — MEDIUM — `render("vx_fleet.json", ...)` exposes raw database column names as JSON keys; conflicts with `rhm_fleet.json` naming for the same struct
File: `lib/api_server_web/views/vx_fleet_view.ex:13-19`
Description: The `vx_fleet.json` partial emits `aaetype`, `aaeshowfilter`, and `aaecolour` as JSON response keys. The `rhm_fleet.json` partial (line 25) renders the identical struct fields under the human-readable aliases `type`, `show_in_filters`, and `color`. Two templates exist in the same module for the same underlying data with incompatible key naming: one leaks storage-layer column names into the public API, the other uses a clean presentation layer. Any client of the `show.json` / `create` response route receives raw column names while clients of all RHM routes receive semantic names. This is a leaky abstraction and a consistency violation.

---

**B025-5** — LOW — Dead render clause: `render("index.json", ...)` in VXFleetView is unreachable from any controller
File: `lib/api_server_web/views/vx_fleet_view.ex:5-7`
Description: No controller in the application calls `render(conn, "index.json", ...)` through `VXFleetView`. The fleet controller (`vx_fleet_controller.ex`) uses `rhm_fleets.json`, `rhm_fleets_with_equip.json`, `rhm_fleet.json`, `rhm_fleet_equipment.json`, and `show.json` — never `index.json`. The clause `render("index.json", %{vxfleets: vxfleets})` is therefore dead code. Dead render clauses in Phoenix views are not flagged by the compiler and silently accumulate maintenance debt.

---

**B025-6** — LOW — `render("vx_fleet_association.json", ...)` exposes raw database column name `aafcustcode` as a JSON key
File: `lib/api_server_web/views/vx_fleet_association_view.ex:14-15`
Description: The response map for a fleet association record emits `aafcustcode` — a raw database storage column name — as a public API key. This is a leaky abstraction: the internal persistence naming convention (three-character prefix `aaf`) is directly visible to API consumers. If the underlying column is ever renamed or the schema is migrated, all clients break. A semantic key such as `customer_code` would decouple the API surface from the storage layer.

---

**B025-7** — LOW — `render("rhm_fleet_with_equip.json", ...)` omits the `color` field present in `render("rhm_fleet.json", ...)`
File: `lib/api_server_web/views/vx_fleet_view.ex:37-43`
Description: `render("rhm_fleet.json", ...)` (line 25) includes `color: vx_fleet.aaecolour`. `render("rhm_fleet_with_equip.json", ...)` (line 37) renders the same struct but omits `color`. Both templates are used by the fleet controller for fleet listings. Clients receiving the with-equipment response get less data than clients receiving the plain fleet response, with no documented reason for the omission. This is a silent field-level inconsistency that can cause client-side rendering bugs.

---

**B025-8** — LOW — `if !Ecto.assoc_loaded?` imperative guard inside `render("vx_customer.json", ...)` body; should be a separate function head
File: `lib/api_server_web/views/vx_customer_view.ex:14-34`
Description: The second `render("vx_customer.json", ...)` clause uses an `if !Ecto.assoc_loaded?(vx_customer)` branch inside the function body to return `%{}` for unloaded associations. The preceding clause (line 13) already handles `nil` via a dedicated function head. The unloaded-association guard should follow the same pattern — a separate function head with a `when not Ecto.assoc_loaded?(vx_customer)` guard — making all short-circuit cases structurally uniform and avoiding a nested `if` with an implicit `else` branch. As written, the `else` branch (the full field map) is only reached after evaluating `Ecto.assoc_loaded?` at runtime, and the code path is harder to trace than a series of pattern-matched heads.

---

**B025-9** — INFO — Style: blank line inside `render("rhm_fleet_equipment.json", ...)` body and double blank line before it
File: `lib/api_server_web/views/vx_fleet_view.ex:45-50`
Description: A double blank line separates `render("rhm_fleet_with_equip.json", ...)` from `render("rhm_fleet_equipment.json", ...)` (lines 45-46). Additionally, the body of `render("rhm_fleet_equipment.json", ...)` contains a trailing blank line before the `end` keyword (line 49). The rest of the module uses single blank lines between function clauses and no trailing blank lines inside function bodies. This is a minor style inconsistency but inconsistent whitespace in Elixir view files is typically cleaned up by `mix format`.

---

## Summary Table

| ID | Severity | File | Short Title |
|---|---|---|---|
| B025-1 | HIGH | `vx_fleet_association_view.ex:5` | Runtime `FunctionClauseError`: `index.json` assign key typo `[REDACTED-AWS-SMTP-PASSWORD]` does not match controller assign `vxfleetassociations` |
| B025-2 | LOW | `vx_customer_view.ex:30-31` | Commented-out code: `aaaudfcustcode` and `aaacolour` fields silently suppressed |
| B025-3 | MEDIUM | `vx_customer_view.ex:5-10` | `index.json` / `show.json` lack `%{data: ...}` envelope; inconsistent with all peer views |
| B025-4 | MEDIUM | `vx_fleet_view.ex:13-19` | `vx_fleet.json` leaks raw DB column names (`aaetype`, `aaeshowfilter`, `aaecolour`) while `rhm_fleet.json` uses semantic names for the same struct |
| B025-5 | LOW | `vx_fleet_view.ex:5-7` | Dead clause: `render("index.json", ...)` unreachable from any controller |
| B025-6 | LOW | `vx_fleet_association_view.ex:14-15` | `aafcustcode` raw DB column name exposed as public API key |
| B025-7 | LOW | `vx_fleet_view.ex:37-43` | `rhm_fleet_with_equip.json` silently omits `color` field present in `rhm_fleet.json` |
| B025-8 | LOW | `vx_customer_view.ex:14-34` | `if !Ecto.assoc_loaded?` guard inside function body; should be a separate function head |
| B025-9 | INFO | `vx_fleet_view.ex:45-50` | Inconsistent whitespace: double blank line and trailing blank line inside function body |
# Pass 4 – B026

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B026

**Files reviewed:**
- `lib/api_server_web/views/vx_rental_view.ex`
- `lib/api_server_web/views/vx_restriction_view.ex`
- `lib/api_server_web/views/vx_thing_event_view.ex`
- `lib/api_server_web/views/vx_thing_omega_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_rental_view.ex`

**Module name:** `ApiServerWeb.VXRentalView`

**Aliases declared:**
- `ApiServer.Vx` (line 3)
- `ApiServerWeb.VXRentalView` (line 4)
- `ApiServerWeb.VXThingView` (line 5)
- `ApiServerWeb.VXCustomerView` (line 6)

**Functions:**

| Name | Line | Visibility |
|------|------|------------|
| `render/2` — `"rhm_rentals.json"` | 8 | public |
| `render/2` — `"rhm_rental.json"` | 13 | public |
| `render/2` — `"midpac_report.json"` | 64 | public |
| `render/2` — `"rental_anniversaries.json"` | 68 | public |
| `convert_json_to_changeset/1` | 73 | public |

**Types/constants/errors defined:** none

**Notable observations during reading:**
- Line 55: JSON output key is `hours_to_serivce` (transposed letters in "service").
- Lines 17–21: `render/2` calls `Vx.fetch_actual_usage/5`, `Vx.get_usage_since_service/2`, and `Vx.get_avg_weekly_hours/2` — live database queries executed from inside a view function.
- Lines 17–18: `/1` division used as a type-coercion idiom to guarantee float (no comment explaining intent).
- Lines 28–34: `Map.has_key?/2` used on a struct — this works but is fragile; accessing struct fields is the conventional pattern.
- Line 80: `changeset` variable is bound but the function body ends with the pipe chain implicitly returning the value; the named binding `changeset =` on line 80 is unused as an explicit return — it is the last expression so it does return, but the name `changeset` is misleading (it is a plain atom-keyed map, not an Ecto changeset).
- `convert_json_to_changeset/1` lives in a View module but contains data-mapping logic more appropriate for a context or schema module; this is a separation-of-concerns violation.

---

### File 2: `lib/api_server_web/views/vx_restriction_view.ex`

**Module name:** `ApiServerWeb.VXRestrictionView`

**Aliases declared:**
- `ApiServerWeb.VXRestrictionView` (line 3)

**Functions:**

| Name | Line | Visibility |
|------|------|------------|
| `render/2` — `"index.json"` | 5 | public |
| `render/2` — `"show.json"` | 9 | public |
| `render/2` — `"vx_restriction.json"` | 13 | public |

**Types/constants/errors defined:** none

**Notable observations during reading:**
- Smallest and most conventional of the four files; follows standard Phoenix view scaffolding pattern.
- Field names in the output map (`aauid`, `aauuser_id`, `aaucustcode`, `aaufun`, `aaucharval`, `aaunumval`) are raw database column names exposed verbatim in the API surface — leaky abstraction.

---

### File 3: `lib/api_server_web/views/vx_thing_event_view.ex`

**Module name:** `ApiServerWeb.VXThingEventView`

**Aliases declared:**
- `ApiServerWeb.VXThingEventView` (line 3)

**Functions:**

| Name | Line | Visibility |
|------|------|------------|
| `render/2` — `"index.json"` | 5 | public |
| `render/2` — `"show.json"` | 9 | public |
| `render/2` — `"vx_thing_event.json"` | 13 | public |
| `omega_to_map/1` | 18 | private |
| `thingevent_to_map/1` | 83 | private |

**Types/constants/errors defined:** none

**Notable observations during reading:**
- Line 14: `vx_thing_event.thingeventomega` is accessed directly; if `thingeventomega` is not preloaded, this raises `%Ecto.Association.NotLoaded{}` at runtime with no guard.
- Line 43: field name `[REDACTED-AWS-SMTP-PASSWORD]` is a typo (should be `[REDACTED-AWS-SMTP-PASSWORD]`); the misspelling originates in the schema definition and is propagated verbatim here.
- Line 28: key `parkbreakreleased` (misspelling — should be `parkbrakereleased`); confirmed the schema field is also misspelled so this is consistent with the schema, but the misspelling is exposed in the API contract.
- Line 130: trailing comma after `prntcalctotalseconds: thingevent.prntcalctotalseconds,` is legal Elixir (trailing comma in map literal) but inconsistent with all other map literals in these four files.
- `show.json` render (line 10) does NOT wrap result in `%{data: ...}` unlike `index.json` (line 6) and unlike the pattern used in `vx_restriction_view.ex`.

---

### File 4: `lib/api_server_web/views/vx_thing_omega_view.ex`

**Module name:** `ApiServerWeb.VXThingOmegaView`

**Aliases declared:**
- `ApiServerWeb.VXThingOmegaView` (line 3)

**Functions:**

| Name | Line | Visibility |
|------|------|------------|
| `render/2` — `"container_lift_report.json"` | 6 | public |
| `render/2` — `"lift_summary_report_fleet.json"` | 17 | public |
| `render/2` — `"lift_summary_report.json"` | 39 | public |
| `render/2` — `"lift_list_report.json"` | 63 | public |
| `render/2` — `"engine_utilization_report.json"` | 77 | public |
| `render/2` — `"operation_summary_report.json"` | 92 | public |
| `translate_lift_type_to_string/1` | 139 | private |

**Types/constants/errors defined:** none

**Notable observations during reading:**
- Lines 103–122: three consecutive `cond do` blocks where only one arm does meaningful work and the other arm returns `0`. The `operating_hours == 0` guard is applied differently for `average_fuel_per_lift` (uses `Decimal.to_integer(lift_count) == 0`) vs. `average_lifts_per_hour` and `average_fuel_per_hour` (use `operating_hours == 0`). This is asymmetric: `average_fuel_per_lift` divides by `lift_count`, not `operating_hours`, so the distinct guard is correct in intent — but using `Decimal.to_integer` as a zero-check is inconsistent with the direct `== 0` used for `operating_hours`.
- Lines 17–61: `lift_summary_report_fleet.json` and `lift_summary_report.json` share identical structure for six of their seven output keys; `lift_summary_report.json` adds `thing_name`. This duplication is an opportunity for a shared helper.
- Line 78: `engine_utilization_report.json` destructures tuples using a `[list]` pattern (square brackets), while all other render clauses use `{tuple}` patterns (curly braces). This is a structural inconsistency — the data shape from the context is actually different (a list vs. a tuple), which is itself inconsistent API design.
- `translate_lift_type_to_string/1` maps integer codes `0,1,2,4,8` — note value `3` is skipped and there is no value between `2` and `4`, implying sparse codes. All unmapped codes silently return `"unknown"`.

---

## Findings

---

**B026-1** — [HIGH] Live database queries executed inside a view render function

File: `lib/api_server_web/views/vx_rental_view.ex:17-21`

Description: `render("rhm_rental.json", ...)` calls `Vx.fetch_actual_usage/5` (twice), `Vx.get_usage_since_service/2`, and `Vx.get_avg_weekly_hours/2` — all database-hitting context functions — directly inside the view layer. Views are responsible for serialising already-computed data; performing queries in a view violates the MVC separation of concerns, prevents caching or pre-computation at the controller level, makes the view untestable in isolation, and hides N+1 query risks when `render("rhm_rentals.json", ...)` maps over a list of rentals (each element triggers four queries). This is the primary architectural defect in this file.

---

**B026-2** — [HIGH] `vx_thing_event_view.ex` crashes on unpreloaded association with no guard

File: `lib/api_server_web/views/vx_thing_event_view.ex:14`

Description: `render("vx_thing_event.json", ...)` accesses `vx_thing_event.thingeventomega` unconditionally. If the caller did not preload the `thingeventomega` association, Ecto returns an `%Ecto.Association.NotLoaded{}` struct, and `omega_to_map/1` immediately crashes attempting to access fields on it (e.g., `thing_event_omega.accelerometerx`). There is no `nil` guard, no `%Ecto.Association.NotLoaded{}` guard, and no documentation that preloading is required. Per prior pass notes, this is a confirmed leaky abstraction: the view silently mandates an internal preload contract that is invisible to callers. The crash manifests as a runtime 500 error rather than a compile-time or early validation failure.

---

**B026-3** — [MEDIUM] Typo in public JSON API key: `hours_to_serivce`

File: `lib/api_server_web/views/vx_rental_view.ex:55`

Description: The JSON output key is spelled `hours_to_serivce` (letters `i` and `c` transposed). The corresponding internal variable on line 15 is correctly spelled `hours_to_service`. This means every API consumer receives a misspelled key. Correcting it would be a breaking change for any client already parsing this field, so the defect compounds over time. The correct spelling `hours_to_service` is used consistently in every other view and controller in the codebase that outputs this concept (e.g., `vx_abl_record_view.ex:80`, `vx_thing_view.ex:425`).

---

**B026-4** — [MEDIUM] `show.json` response envelope inconsistency in `vx_thing_event_view.ex`

File: `lib/api_server_web/views/vx_thing_event_view.ex:9-11`

Description: `render("show.json", ...)` returns the raw merged map from `render("vx_thing_event.json", ...)` without wrapping it in `%{data: ...}`. By contrast, `render("index.json", ...)` wraps its result in `%{data: ...}`. This makes single-record and multi-record responses structurally different — clients must apply different parsing logic depending on whether they requested a list or a single item. The same module-wide `%{data: ...}` envelope pattern is used consistently in `vx_restriction_view.ex` (both `index.json` and `show.json` wrap in `%{data: ...}`). The inconsistency is not justified by any comment or convention.

---

**B026-5** — [MEDIUM] `convert_json_to_changeset/1` placed in a View module — wrong layer

File: `lib/api_server_web/views/vx_rental_view.ex:73-89`

Description: `convert_json_to_changeset/1` translates a user-facing JSON parameter map (string keys) into an internal atom-keyed map for persistence. This is business/context logic, not presentation logic. Its presence in a View module violates the Phoenix layering contract (views serialise; contexts validate and persist). The controller (`vx_rental_controller.ex:159,178`) calls `ApiServerWeb.VXRentalView.convert_json_to_changeset/1` directly, creating a cross-layer dependency from controller to view that is atypical and will surprise maintainers. The function should live in the `ApiServer.Vx` context or the `VXRental` schema module.

---

**B026-6** — [MEDIUM] `engine_utilization_report.json` destructures rows as lists; all other render clauses use tuples

File: `lib/api_server_web/views/vx_thing_omega_view.ex:78`

Description: The `engine_utilization_report.json` render clause destructures each row as `[{date_year, date_month, date_day}, day_name, engine_hours, idle_hours, total_fuel, idle_fuel]` — a list containing a date tuple followed by scalar values. Every other render clause in this module (lines 7, 18, 40, 64, 94) destructures rows as flat tuples with `{...}` syntax. This inconsistency indicates the underlying query for this report returns a structurally different result type, which is an inconsistent context API surface. The view accurately reflects the inconsistency but does not hide it; a consumer comparing these render clauses will be confused about the contract.

---

**B026-7** — [MEDIUM] `Map.has_key?/2` used to test struct fields instead of pattern matching

File: `lib/api_server_web/views/vx_rental_view.ex:29`

Description: `Map.has_key?(vx_rental, :overage)` checks for the presence of an `:overage` field on what is expected to be a struct. For Ecto structs all defined fields are always present (with `nil` values when unset), so this check will always return `true` for a genuine `VXRental` struct, and `false` only if `vx_rental` is a plain map without the key. If the intent is to handle both plain maps (from a decorated result set) and structs, this should be documented; if the intent is a nil-check, `vx_rental.overage != nil` is clearer. The current code will mislead any reader who assumes struct semantics.

---

**B026-8** — [LOW] Trailing comma in map literal in `thingevent_to_map/1`

File: `lib/api_server_web/views/vx_thing_event_view.ex:130`

Description: The last entry of the map literal in `thingevent_to_map/1` has a trailing comma: `prntcalctotalseconds: thingevent.prntcalctotalseconds,`. This is syntactically valid Elixir but is inconsistent with all other map literals across all four files under review, none of which use trailing commas. It appears to be an artifact of a field having been inserted or removed without cleanup, and will cause unnecessary diff noise on future edits.

---

**B026-9** — [LOW] `lift_summary_report.json` and `lift_summary_report_fleet.json` are near-duplicate render clauses with no shared helper

File: `lib/api_server_web/views/vx_thing_omega_view.ex:17-61`

Description: `render("lift_summary_report_fleet.json", ...)` (lines 17–37) and `render("lift_summary_report.json", ...)` (lines 39–61) produce output maps with six identical keys (`date`, `day_name`, `count_20`, `count_30`, `count_40`, `count_chain`, `count_bottom`, `total_lifts`). The only difference is that `lift_summary_report.json` also includes `thing_name`. The six shared keys are duplicated verbatim across both clauses. Any future schema change to the shared fields must be applied in two places.

---

**B026-10** — [LOW] Database column names exposed verbatim in public API output in `vx_restriction_view.ex`

File: `lib/api_server_web/views/vx_restriction_view.ex:14-21`

Description: The `vx_restriction.json` template serialises raw database column names (`aauid`, `aauuser_id`, `aaucustcode`, `aaufun`, `aaucharval`, `aaunumval`) directly as JSON keys. These names are internal database artefacts and provide no semantic clarity to API consumers. If the underlying table schema changes, the API contract changes simultaneously. This is a leaky abstraction — the view does not translate internal field names to a stable, domain-meaningful API vocabulary. By contrast, `vx_rental_view.ex` translates column names to readable aliases (`abhid` → `id`, `abhcustcode` → `cust_code`, etc.).

---

**B026-11** — [LOW] Inconsistent zero-guard style for division safety in `operation_summary_report.json`

File: `lib/api_server_web/views/vx_thing_omega_view.ex:103-122`

Description: Three consecutive division-safety guards use two different patterns. `average_lifts_per_hour` (line 104) and `average_fuel_per_hour` (line 111) check `operating_hours == 0` using direct equality. `average_fuel_per_lift` (line 118) checks `Decimal.to_integer(lift_count) == 0` — using `Decimal.to_integer` to convert before comparing. If `operating_hours` is also a `Decimal`, the direct `== 0` comparison may silently succeed (Decimal implements `==` with integers via the `Decimal` protocol) or it may not, depending on the version. The asymmetric treatment of what appear to be the same type creates a risk of one guard behaving unexpectedly at runtime, and it is inconsistent style regardless.

---

**B026-12** — [LOW] `convert_json_to_changeset/1` binds result to variable `changeset` but the name is misleading

File: `lib/api_server_web/views/vx_rental_view.ex:80`

Description: The function body assigns the pipe result to a local variable named `changeset` on line 80. The value is a plain Elixir map (`%{}`), not an `Ecto.Changeset` struct. In Phoenix/Ecto conventions, `changeset` refers to `%Ecto.Changeset{}`. A maintainer reading the call site (`ApiServerWeb.VXRentalView.convert_json_to_changeset/1`) or the body will expect Ecto changeset semantics (cast, validate, errors) that do not exist. The misnaming contributes to the broader placement problem (finding B026-5) and makes the code harder to reason about.

---

**B026-13** — [LOW] Misspelled field name `[REDACTED-AWS-SMTP-PASSWORD]` propagated into public API output

File: `lib/api_server_web/views/vx_thing_event_view.ex:43`

Description: The JSON key `[REDACTED-AWS-SMTP-PASSWORD]` (transposed letters: `filger` instead of `filter`) originates in the schema (`vx_thing_event_omega.ex:30`) and is faithfully propagated through the view into the API response. The misspelling is therefore consistent from schema to wire format, but it is part of the public API contract. Any client already consuming this key will break if the spelling is corrected, so the cost of fixing it grows over time. This finding documents it for visibility; correction should be coordinated with a versioned API change.

---

**B026-14** — [INFO] `/1` division used as float-coercion idiom without explanation

File: `lib/api_server_web/views/vx_rental_view.ex:17-18`

Description: `Vx.fetch_actual_usage(...)/1` divides the result by the integer `1`. This is a pattern used elsewhere in the codebase to force an integer result to a float type (Elixir's `/` always returns a float when at least one operand is a float, but here both are integers so the result is an integer — division by `1` does not produce a float in Elixir). If the intent is type coercion, this pattern does not achieve it for integer inputs; `last_week` and `for_month` will remain integers if `fetch_actual_usage` returns an integer. If the intent is something else, it is undocumented. This is an INFO observation because no crash results, but it may indicate a latent type assumption bug.

---

## Summary Table

| ID | Severity | File | Short Title |
|----|----------|------|-------------|
| B026-1 | HIGH | vx_rental_view.ex:17-21 | Live DB queries inside view render function |
| B026-2 | HIGH | vx_thing_event_view.ex:14 | Crash on unpreloaded `thingeventomega` association — no guard |
| B026-3 | MEDIUM | vx_rental_view.ex:55 | Typo in public API key: `hours_to_serivce` |
| B026-4 | MEDIUM | vx_thing_event_view.ex:9-11 | `show.json` missing `%{data: ...}` envelope, inconsistent with `index.json` |
| B026-5 | MEDIUM | vx_rental_view.ex:73-89 | `convert_json_to_changeset/1` belongs in context layer, not a view |
| B026-6 | MEDIUM | vx_thing_omega_view.ex:78 | `engine_utilization_report.json` uses list destructuring; all others use tuples |
| B026-7 | MEDIUM | vx_rental_view.ex:29 | `Map.has_key?/2` on struct field — misleading and fragile |
| B026-8 | LOW | vx_thing_event_view.ex:130 | Trailing comma in map literal — style inconsistency |
| B026-9 | LOW | vx_thing_omega_view.ex:17-61 | Near-duplicate render clauses with no shared helper |
| B026-10 | LOW | vx_restriction_view.ex:14-21 | Raw database column names exposed verbatim in API output |
| B026-11 | LOW | vx_thing_omega_view.ex:103-122 | Inconsistent zero-guard style for `Decimal` division safety |
| B026-12 | LOW | vx_rental_view.ex:80 | `changeset` variable name is misleading — value is a plain map |
| B026-13 | LOW | vx_thing_event_view.ex:43 | Misspelled field `[REDACTED-AWS-SMTP-PASSWORD]` locked into public API |
| B026-14 | INFO | vx_rental_view.ex:17-18 | `/1` division does not produce float — float-coercion idiom is ineffective |
# Pass 4 – B027

**Date:** 2026-02-27
**Audit run:** 2026-02-27-01
**Agent:** B027
**Pass:** 4 – Code Quality

## Files Reviewed

1. `lib/api_server_web/views/vx_thing_summary_view.ex`
2. `lib/api_server_web/views/vx_thing_view.ex`
3. `lib/api_server_web/views/vx_user_function_view.ex`
4. `lib/api_server_web/views/vx_user_view.ex`

---

## Reading Evidence

### File 1: `lib/api_server_web/views/vx_thing_summary_view.ex`

**Module:** `ApiServerWeb.VXThingSummaryView`

**Aliases:**
- `ApiServerWeb.VXThingSummaryView` (line 3)

**Functions:**

| Name | Line |
|------|------|
| `render/2` — `"index.json"` | 5 |
| `render/2` — `"show.json"` | 9 |
| `render/2` — `"vx_thing_summary.json"` | 13 |
| `render/2` — `"rhm_thing_summary.json"` | 57 |

**Types/constants/errors defined:** None.

**Notes:**
- Line 75 contains a commented-out expression: `# location: name <> ", " <> state`
- `"rhm_thing_summary.json"` (line 57) emits the raw `[REDACTED-AWS-SMTP-PASSWORD]` and `[REDACTED-AWS-SMTP-PASSWORD]` keys directly in the response map (lines 119–120) without renaming them to snake_case-free names, unlike all other keys in that same render clause which use clean names (`as_of`, `ignition_status`, etc.).

---

### File 2: `lib/api_server_web/views/vx_thing_view.ex`

**Module:** `ApiServerWeb.VXThingView`

**Uses:**
- `ApiServerWeb, :view` (line 2)
- `Timex` (line 3)

**Aliases:**
- `ApiServerWeb.VXThingView` (line 4)
- `ApiServerWeb.VXThingSummaryView` (line 5)

**Functions:**

| Name | Line |
|------|------|
| `render/2` — `"index.json"` | 8 |
| `render/2` — `"show.json"` | 12 |
| `render/2` — `"fleet_map.json"` (collection) | 16 |
| `render/2` — `"fleet_map.json"` (single) | 20 |
| `render/2` — `"hardware_with_checklists.json"` | 105 |
| `render/2` — `"pm_data.json"` (collection) | 109 |
| `render/2` — `"pm_data.json"` (single) | 113 |
| `render/2` — `"movements.json"` | 147 |
| `render/2` — `"movement.json"` | 150 |
| `render/2` — `"checklists.json"` | 164 |
| `render/2` — `"vx_checklist.json"` | 168 |
| `render/2` — `"vx_thing.json"` | 176 |
| `render/2` — `"rhm_thing_usage.json"` | 220 |
| `render/2` — `"rhm_thing_usage_manual.json"` | 224 |
| `render/2` — `"usage_report.json"` | 228 |
| `render/2` — `"usage_report_many.json"` | 265 |
| `render/2` — `"rhm_things_usage.json"` | 292 |
| `render/2` — `"rhm_thing_events.json"` | 315 |
| `render/2` — `"event_report.json"` | 318 |
| `render/2` — `"rhm_thing.json"` (collection) | 351 |
| `render/2` — `"rhm_thing.json"` (single) | 354 |
| `render/2` — `"basic_thing.json"` (nil guard) | 359 |
| `render/2` — `"basic_thing.json"` | 360 |
| `render/2` — `"sielift_wip_export.json"` | 396 |
| `render/2` — `"pape_exports.json"` | 434 |
| `render/2` — `"pape_export.json"` | 437 |
| `render/2` — `"rhm_things_names.json"` | 449 |
| `render/2` — `"things_only.json"` | 453 |
| `info_to_map/1` | 487 |
| `thing_to_map/2` | 499 |

**Types/constants/errors defined:** None.

**Notes:**
- Large block of commented-out code (lines 507–532): experimental `predicted_service_date` logic with `IO.puts` debug output.
- Line 573: additional single commented-out key in a map: `# predicted_service_date: predicted_service_date`.
- Lines 138–142 in `pm_data.json` single render: hardcoded sentinel floats `0.1`, `0.2`, `0.2`, `0.3`, `0.4` for `previousweek`, `thisweek`, `avgperweek`, `mtdraw`, `weekstoservice`.
- `use Timex` (line 3) is declared but Timex functions are called only through module references (`Timezone.name_of`, `Timezone.get`, `Timezone.convert`, `Timex.now`, `Timex.shift`, `Timex.format`) — the active code only uses `Timezone.*` module calls without the `use Timex` macro being needed for them; the `Timex.*` calls exist only inside the commented-out block.
- Line 541 checks `if vx_thing == nil` inside `thing_to_map/2` after already accessing `vx_thing.aadsvchrs` and other fields on line 571 — the nil check is logically unreachable in the non-nil path and is dead code given the struct access would have already crashed.
- `"hardware_with_checklists.json"` (line 105) delegates to `"vx_thing.json"` rather than a dedicated checklist template — misleading name.
- `render/2` for `"fleet_map.json"` single (line 20) returns an empty string `""` for the no-summary branch (line 101); this is inconsistent with other nil-guard render clauses that return `%{}` (e.g., line 359).

---

### File 3: `lib/api_server_web/views/vx_user_function_view.ex`

**Module:** `ApiServerWeb.VXUserFunctionView`

**Aliases:**
- `ApiServerWeb.VXUserFunctionView` (line 3)

**Functions:**

| Name | Line |
|------|------|
| `render/2` — `"index.json"` | 5 |
| `render/2` — `"show.json"` | 9 |
| `render/2` — `"vx_user_function.json"` | 13 |

**Types/constants/errors defined:** None.

**Notes:** No anomalies detected in isolation. Very small, straightforward module.

---

### File 4: `lib/api_server_web/views/vx_user_view.ex`

**Module:** `ApiServerWeb.VXUserView`

**Aliases:**
- `ApiServerWeb.VXUserView` (line 3)

**Functions:**

| Name | Line |
|------|------|
| `render/2` — `"index.json"` | 5 |
| `render/2` — `"show.json"` | 9 |
| `render/2` — `"rhm_users.json"` | 13 |
| `render/2` — `"rhm_user.json"` | 17 |
| `render/2` — `"fleet_list.json"` | 58 |

**Types/constants/errors defined:** None.

**Notes:**
- `render/2` for `"index.json"` (line 5) delegates to `"rhm_user.json"` but the template name on the wire is `"rhm_user.json"`, not `"vx_user.json"`. This is a naming inconsistency — other view modules use a `"vx_<entity>.json"` template for the canonical single-item rendering, but this one uses `"rhm_user.json"` for both the collection render and the `show` render.
- `user_level` falls back to the hard-coded integer `2` (line 36) when no function is attached. This magic number has no named constant or comment explaining its meaning (2 = some privilege level?).
- The variable `user` is rebound (shadowed) inside `render/2` at line 39 using the same name as the incoming pattern-match variable. While legal in Elixir, this is a code smell that can confuse readers.

---

## Findings

---

**B027-1** — [HIGH] Hardcoded stub sentinel values in `pm_data.json` render — never replaced with real implementation

File: `lib/api_server_web/views/vx_thing_view.ex:138`

Description: The single-item render clause for `"pm_data.json"` (lines 113–145) returns five fields with hardcoded floating-point sentinel values: `previousweek: 0.1`, `thisweek: 0.2`, `avgperweek: 0.2`, `mtdraw: 0.3`, `weekstoservice: 0.4`. These are clearly placeholder/stub values that were never replaced with actual computed data. API consumers silently receive fabricated numbers. The fields `previousweek`, `thisweek`, `avgperweek`, and `mtdraw` have no corresponding computation anywhere in the function — unlike `lastmeterreading` and `hourstoservice` which are properly derived. This endpoint is misleading and incorrect in production.

---

**B027-2** — [MEDIUM] Large block of commented-out code with `IO.puts` debug lines in `thing_to_map/2`

File: `lib/api_server_web/views/vx_thing_view.ex:507`

Description: Lines 507–532 contain a large multi-line comment block that includes experimental `predicted_service_date` logic along with seven `IO.puts` debug statements. The comment block is prefaced with a narrative explanation of why the logic was disabled (lines 507–511), indicating the code was never finished, not merely temporarily disabled. Dead commented-out code of this size obscures the module, and the embedded `IO.puts` calls would produce stdout noise in production if re-enabled carelessly. This should be removed from the codebase.

---

**B027-3** — [LOW] Single commented-out map key referencing a variable from the dead block

File: `lib/api_server_web/views/vx_thing_view.ex:573`

Description: Line 573 contains `# predicted_service_date: predicted_service_date` inside the return map of `thing_to_map/2`. This is a remnant of the commented-out logic in finding B027-2. It is unnecessary noise left in the map structure comment and should be removed along with the larger block.

---

**B027-4** — [LOW] Commented-out map key in `"rhm_thing_summary.json"` render

File: `lib/api_server_web/views/vx_thing_summary_view.ex:75`

Description: Line 75 contains `# location: name <> ", " <> state` inside the `gps` sub-map of the `"rhm_thing_summary.json"` render clause. The variables `name` and `state` are not bound anywhere in the function — meaning this code would not compile if uncommented as-is. This indicates incomplete feature work that was never implemented. The comment should be removed or completed with actual implementation.

---

**B027-5** — [MEDIUM] `use Timex` declared but only needed by commented-out dead code

File: `lib/api_server_web/views/vx_thing_view.ex:3`

Description: `use Timex` is declared on line 3. The active (non-commented) code in this module uses `Timezone.name_of/1`, `Timezone.get/1`, and `Timezone.convert/2` directly by module name — these do not require `use Timex`. The only calls that require `Timex.*` namespace (`Timex.now/0`, `Timex.shift/2`, `Timex.format/3`) are exclusively inside the commented-out `predicted_service_date` block (lines 524–529). Keeping `use Timex` causes an unnecessary macro expansion and may produce a compiler warning depending on Elixir/Timex version. If the commented-out block is removed (as recommended in B027-2), `use Timex` becomes entirely dead.

---

**B027-6** — [MEDIUM] `"fleet_map.json"` single-item render returns `""` (empty string) instead of `%{}` for the no-summary case

File: `lib/api_server_web/views/vx_thing_view.ex:101`

Description: The single-item `"fleet_map.json"` render clause (line 20) returns the empty string `""` when `vx_thing.summary` is `nil` (line 101). All other nil-guard or fallback render clauses in this file and in the view layer return `%{}` (an empty map) — for example, `render("basic_thing.json", %{vx_thing: nil})` on line 359, `info_to_map/1` on line 489, and `thing_to_map/2` on line 542. Returning `""` (a string) where a map is expected breaks the type contract of the collection renderer: `render_many` on line 17 will insert a bare string element into the list rather than a map, potentially causing JSON encoding errors or malformed API responses downstream.

---

**B027-7** — [LOW] Style inconsistency — two raw `abm*` keys leak through the otherwise clean `"rhm_thing_summary.json"` response shape

File: `lib/api_server_web/views/vx_thing_summary_view.ex:119`

Description: The `"rhm_thing_summary.json"` render clause (lines 57–122) was clearly designed to expose a clean, human-readable API surface using keys like `as_of`, `ignition_status`, `event_type`, `hour_meters`, etc. However, lines 119–120 emit `[REDACTED-AWS-SMTP-PASSWORD]` and `[REDACTED-AWS-SMTP-PASSWORD]` using their raw database field names instead of clean equivalents such as `prestart_last_gmt` and `prestart_checklist`. This is a leaky abstraction — internal database naming conventions are exposed through the public API.

---

**B027-8** — [LOW] Magic number `2` used as default `user_level` with no explanation

File: `lib/api_server_web/views/vx_user_view.ex:36`

Description: In `render/2` for `"rhm_user.json"`, the `user_level` falls back to the literal integer `2` when no function record is associated with the user (line 36). There is no named constant, module attribute, or comment explaining what privilege level `2` represents. This makes it impossible to audit correct behavior or safely change the default without understanding the entire privilege level scheme.

---

**B027-9** — [LOW] Variable shadowing — `user` rebound over the pattern-match parameter of the same name

File: `lib/api_server_web/views/vx_user_view.ex:39`

Description: In `render("rhm_user.json", %{vx_user: user})` (line 17), the parameter `user` is used in expressions on lines 18–37 and then rebound at line 39 with `user = %{...}`. The rebinding replaces the original struct with a plain map of the same name. While syntactically valid Elixir, this pattern is a code smell: a reader expecting `user` to refer to the original struct after line 39 will be confused. The inner variable should use a distinct name such as `user_json` or `response`.

---

**B027-10** — [LOW] Style inconsistency — `"index.json"` in `VXUserView` delegates to `"rhm_user.json"` instead of a `"vx_user.json"` template, inconsistent with peer view modules

File: `lib/api_server_web/views/vx_user_view.ex:6`

Description: All other view modules in this group (`VXThingView`, `VXThingSummaryView`, `VXUserFunctionView`) use a `"vx_<entity>.json"` template as the canonical single-item serializer, which `"index.json"` and `"show.json"` delegate to. `VXUserView` instead uses `"rhm_user.json"` for this role (lines 6 and 10), mixing the `rhm_` naming convention into what is otherwise a `vx_` naming scheme. This inconsistency makes it harder to reason about which template is authoritative.

---

**B027-11** — [LOW] Unreachable nil guard inside `thing_to_map/2`

File: `lib/api_server_web/views/vx_thing_view.ex:541`

Description: `thing_to_map/2` accesses `vx_thing.aadsvchrs` on line 502 and multiple other struct fields on lines 544–576, then checks `if vx_thing == nil` on line 541 before the struct-access block. If `vx_thing` were actually `nil`, the function would already have raised a `KeyError` or `[REDACTED-AWS-SMTP-PASSWORD]` at line 502 (inside the `weeks_to_service` computation). The `if vx_thing == nil` guard on line 541 is therefore unreachable dead code — it provides no actual protection and gives a false sense of safety.

---

## Summary Table

| ID | Severity | Title | File | Line |
|----|----------|-------|------|------|
| B027-1 | HIGH | Hardcoded stub sentinel values in `pm_data.json` — never replaced | `vx_thing_view.ex` | 138 |
| B027-2 | MEDIUM | Large commented-out block with `IO.puts` debug statements | `vx_thing_view.ex` | 507 |
| B027-3 | LOW | Commented-out map key referencing variable from dead block | `vx_thing_view.ex` | 573 |
| B027-4 | LOW | Commented-out map key with unbound variables in `rhm_thing_summary.json` | `vx_thing_summary_view.ex` | 75 |
| B027-5 | MEDIUM | `use Timex` only needed by commented-out dead code | `vx_thing_view.ex` | 3 |
| B027-6 | MEDIUM | `fleet_map.json` returns `""` instead of `%{}` for no-summary case | `vx_thing_view.ex` | 101 |
| B027-7 | LOW | Raw `abm*` field names leak through otherwise clean `rhm_thing_summary.json` | `vx_thing_summary_view.ex` | 119 |
| B027-8 | LOW | Magic number `2` used as default `user_level` with no explanation | `vx_user_view.ex` | 36 |
| B027-9 | LOW | Variable `user` shadowed by rebinding in same function | `vx_user_view.ex` | 39 |
| B027-10 | LOW | `"index.json"` delegates to `"rhm_user.json"` — inconsistent with `vx_*` naming convention | `vx_user_view.ex` | 6 |
| B027-11 | LOW | Unreachable nil guard in `thing_to_map/2` after prior struct access | `vx_thing_view.ex` | 541 |

**Total findings: 11** (1 HIGH, 3 MEDIUM, 7 LOW)

