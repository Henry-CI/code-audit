# Pass 3: Documentation — B022
**Agent:** B022
**Files:**
- `lib/api_server_web/router.ex`
- `lib/api_server_web/schema.ex`
- `lib/api_server_web/schema/thing_types.ex`

**Date:** 2026-02-27

---

## router.ex

### Reading Evidence

**Module name:** `ApiServerWeb.Router`

**Public functions / macros defined (route declarations — no named public functions):**
This file contains no named public functions. It defines three route scopes and four plug pipelines using Phoenix Router DSL macros:

Pipelines:
- `pipeline :browser` (line 4)
- `pipeline :api` (line 12)
- `pipeline :api_xml` (line 18)
- `pipeline :authenticated` (line 24)

Scopes and routes (all are DSL declarations, not named Elixir functions):
- Scope `/api/v1` (authenticated, line 28) — lines 30–154
- Scope `/api/v1` (unauthenticated, line 156) — lines 157–177
- Scope `/` (xml, line 179) — lines 180–193

**Types / errors / constants defined:** None.

**Notable observations:**
- Line 30–31: Two routes (`/rhm/engine_usage`, `/rhm/monday_hour_meters`) appear before `pipe_through([:api, :authenticated])` on line 33, meaning they bypass both the `:api` pipeline (content-type negotiation, session fetch) and authentication. This is a structural observation relevant to documentation accuracy.
- Lines 41–42: A commented-out route for `/rhm/work_in_progress` is replaced by a live route that delegates to `:sielift_export`, with no doc explaining the substitution.
- Lines 97–100: The route `GET /rhm/omega_fleet/:fleetid/operation_summary_report` is declared twice (lines 90–94 and 97–100) — exact duplicate.
- The GraphQL endpoints (`/graphql`, `/graphiql`) are fully commented out (lines 195–202) with no explanation of intent or status.

### Findings

#### B022-1 — Missing @moduledoc on ApiServerWeb.Router
**Severity:** LOW
**File:** `lib/api_server_web/router.ex`, line 1

`ApiServerWeb.Router` has no `@moduledoc`. There is no description of the API surface, the versioning scheme, the authentication model, or the pipeline structure. A developer new to the codebase has no inline guidance on how to understand or extend the routing configuration.

#### B022-2 — Two routes declared outside authentication pipeline with no explanatory comment
**Severity:** LOW
**File:** `lib/api_server_web/router.ex`, lines 30–31

The routes `GET /api/v1/rhm/engine_usage` and `GET /api/v1/rhm/monday_hour_meters` are placed before the `pipe_through([:api, :authenticated])` call on line 33, which means they are served without authentication and without the `:api` pipeline (no session fetch, no JSON format enforcement). There is only the comment `# Avoid authentication, locking to a specific database` which does not explain why these specific endpoints are unauthenticated, what access controls (if any) protect them, or what "locking to a specific database" means. This is a documentation gap that obscures a security-relevant design decision.

#### B022-3 — Misleading route comment for /rhm/work_in_progress
**Severity:** MEDIUM
**File:** `lib/api_server_web/router.ex`, line 41–42

The comment `# get "/rhm/work_in_progress", VXThingController, :work_in_progress` implies the live route below it (`get("/rhm/work_in_progress", VXThingController, :sielift_export)`) is a replacement, but there is no comment explaining that `:work_in_progress` does not exist or was intentionally substituted with `:sielift_export`. A reader could mistakenly believe `:work_in_progress` is the active action. The existing comment is inaccurate in context: it documents intent that does not match the actual running behaviour, which is to call `:sielift_export`.

#### B022-4 — Duplicate route declaration with no comment
**Severity:** LOW
**File:** `lib/api_server_web/router.ex`, lines 90–94 and 97–100

`GET /rhm/omega_fleet/:fleetid/operation_summary_report` is declared twice, mapping to the same controller action `VXThingOmegaController.get_operation_summary_report/2`. There is no comment acknowledging this duplication. Phoenix will silently use the first matched route. The second declaration is dead code and its presence without explanation is a documentation gap that will confuse maintainers.

#### B022-5 — Commented-out GraphQL endpoints with no status explanation
**Severity:** LOW
**File:** `lib/api_server_web/router.ex`, lines 195–202

The `forward "/graphql"` and `forward "/graphiql"` blocks are commented out. There is no comment indicating whether these are planned, temporarily disabled, deprecated, or removed. The inline comment `# For the GraphiQL interactive interface, a must-have for happy frontend devs.` describes the feature but provides no status. A maintainer cannot determine whether to restore, remove, or ignore these blocks.

---

## schema.ex

### Reading Evidence

**Module name:** `ApiServerWeb.Schema`

**Public functions / macros defined:**
This file defines an Absinthe GraphQL schema using DSL macros. No named public Elixir functions are defined. The `query` block defines three GraphQL query fields:

- `field :get_thing` (line 11) — resolves via `Resolvers.Things.find_thing/3`, args: `aadhardwareid` (non-null string), `customer` (non-null string)
- `field :get_puls_record` (line 18) — resolves via `Resolvers.Puls.puls_record/3`, arg: `hardwareid` (non-null string)
- `field :get_all_things` (line 24) — resolves via `Resolvers.Things.get_all_things/3`, arg: `customer` (non-null string)

Each field carries an Absinthe `@desc` attribute (lines 10, 17, 23).

**Types / errors / constants defined:** None defined directly; `ThingTypes` is imported via `import_types`.

**Notable observations:**
- `field :get_thing` on line 11 accepts `aadhardwareid` as an argument name. This is an internal database column name exposed as a public GraphQL API argument. The `@desc` ("Get a Thing") does not document the argument naming convention or its meaning.
- The schema is unused at runtime: both `forward "/graphql"` and `forward "/graphiql"` are commented out in the router (router.ex lines 195–202).

### Findings

#### B022-6 — Missing @moduledoc on ApiServerWeb.Schema
**Severity:** LOW
**File:** `lib/api_server_web/schema.ex`, line 1

`ApiServerWeb.Schema` has no `@moduledoc`. There is no description of the GraphQL schema's purpose, its relationship to the REST API, or the fact that the schema is currently unreachable at runtime (the router forwards are commented out).

#### B022-7 — @desc "Get a Thing" does not document the aadhardwareid argument name
**Severity:** LOW
**File:** `lib/api_server_web/schema.ex`, line 10–15

The `@desc` for `:get_thing` reads "Get a Thing". The argument is named `aadhardwareid`, which is an internal database column prefix (`aad`) not meaningful to API consumers. The description provides no explanation of what `aadhardwareid` represents, what format it expects, or how it differs from the `hardwareid` argument used by `:get_puls_record`. This is a documentation gap that will hinder API consumers.

#### B022-8 — @desc fields do not document resolver behaviour or error conditions
**Severity:** INFO
**File:** `lib/api_server_web/schema.ex`, lines 10, 17, 23

All three query fields (`get_thing`, `get_puls_record`, `get_all_things`) have minimal single-sentence `@desc` values. None document: return shape when no record is found, possible error states, required argument formats, or the customer/tenant scoping behaviour. While Absinthe `@desc` is not the same as `@doc`, it serves as the schema's introspectable documentation and the gaps here reduce usability.

---

## schema/thing_types.ex

### Reading Evidence

**Module name:** `ApiServerWeb.Schema.ThingTypes`

**Public functions / macros defined:**
This file defines Absinthe object types using DSL macros. No named public Elixir functions are defined.

Absinthe object types defined:
- `object :thing` (line 5) — with `@desc "A Thing"` (line 4)
  Fields (lines 6–37):
  - `:aadcustcode` — `:string`
  - `:aaddesc` — `:string`
  - `:aadintext` — `:string`
  - `:aadaddr` — `:string`
  - `:aadcustomerid` — `:integer`
  - `:aadcat` — `:integer`
  - `:aadhardwareid` — `:string`
  - `:aadhw_type` — `:integer`
  - `:aadmake` — `:string`
  - `:aadmodel` — `:string`
  - `:aadserialno` — `:string`
  - `:aadmobile` — `:string`
  - `:aadimei` — `:string`
  - `:aadhourmeter` — `:float`
  - `:aadhourmeter1` — `:float`
  - `:aadhourmeter2` — `:float`
  - `:aadhourmeter3` — `:float`
  - `:aadhourmeter4` — `:float`
  - `:aadodometer` — `:integer`
  - `:aadhourmeteromega` — `:float`
  - `:aadhourmeterothcan` — `:float`
  - `:aaddateintoservice` — `:date`
  - `:aadlastservice` — `:date`
  - `:aadvalid` — `:string`
  - `:aadserviceoffset` — `:float`
  - `:aadsvchrs` — `:integer`
  - `:aadrange_lat` — `:float`
  - `:aadrange_long` — `:float`
  - `:aadrange_dist` — `:integer`
  - `:aadrange_unit` — `:string`
  - `:service_calculation_input` — `:string`

- `object :puls_record` (line 41) — with `@desc "The record of a thing from PULS"` (line 40)
  Fields (lines 42–44):
  - `:esn` — `:string`
  - `:iccid` — `:string`
  - `:group` — `:string`

**Types / errors / constants defined:** None.

### Findings

#### B022-9 — Missing @moduledoc on ApiServerWeb.Schema.ThingTypes
**Severity:** LOW
**File:** `lib/api_server_web/schema/thing_types.ex`, line 1

`ApiServerWeb.Schema.ThingTypes` has no `@moduledoc`. There is no description of what this module provides, what the `aad` column prefix convention means, or the relationship between these types and the underlying database schema.

#### B022-10 — No @desc on any field of the :thing object type
**Severity:** INFO
**File:** `lib/api_server_web/schema/thing_types.ex`, lines 6–37

The `:thing` object type carries 31 fields, all named with the internal `aad` prefix that is opaque to API consumers. None of the fields have an Absinthe `@desc` attribute. Without field-level descriptions, GraphiQL introspection and generated documentation will show bare column names with no indication of their purpose. Examples of fields that particularly need description include `:aadcat` (category code — meaning unknown without source lookup), `:aadhourmeter` through `:aadhourmeter4` (purpose of each meter variant is undocumented), `:aadvalid` (not a boolean despite the name; type is `:string`), and `:service_calculation_input` (the only non-`aad`-prefixed field, suggesting a derived or computed value with no explanation).

#### B022-11 — No @desc on any field of the :puls_record object type
**Severity:** INFO
**File:** `lib/api_server_web/schema/thing_types.ex`, lines 42–44

The `:puls_record` object type has three fields (`:esn`, `:iccid`, `:group`) with no `@desc` attributes. "PULS" is not defined anywhere in this file. A consumer cannot determine from introspection what PULS is, what ESN or ICCID represent (Electronic Serial Number, Integrated Circuit Card Identifier — telecom identifiers), or what `:group` groups by.

#### B022-12 — @desc "A Thing" on :thing object is insufficiently descriptive
**Severity:** LOW
**File:** `lib/api_server_web/schema/thing_types.ex`, line 4

The `@desc` for `:thing` is "A Thing". This provides no domain context. The object represents a tracked physical asset (forklift, vehicle, or other piece of equipment) with telemetry data. The description does not explain the `aad` naming convention (which comes from an internal database schema), the concept of the hardware ID as the primary identifier, or the relationship to customers and fleets.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B022-1 | LOW | router.ex:1 | Missing `@moduledoc` on `ApiServerWeb.Router` |
| B022-2 | LOW | router.ex:30–31 | Unauthenticated routes lack adequate explanatory documentation |
| B022-3 | MEDIUM | router.ex:41–42 | Misleading comment implies `:work_in_progress` action is active; actual route calls `:sielift_export` |
| B022-4 | LOW | router.ex:97–100 | Duplicate `GET /rhm/omega_fleet/:fleetid/operation_summary_report` route with no comment |
| B022-5 | LOW | router.ex:195–202 | Commented-out GraphQL endpoints have no status explanation |
| B022-6 | LOW | schema.ex:1 | Missing `@moduledoc` on `ApiServerWeb.Schema` |
| B022-7 | LOW | schema.ex:10–15 | `@desc` for `:get_thing` does not explain the `aadhardwareid` argument or its format |
| B022-8 | INFO | schema.ex:10,17,23 | All query field `@desc` values lack documentation of return behaviour and error conditions |
| B022-9 | LOW | thing_types.ex:1 | Missing `@moduledoc` on `ApiServerWeb.Schema.ThingTypes` |
| B022-10 | INFO | thing_types.ex:6–37 | No `@desc` on any of the 31 fields of the `:thing` Absinthe object type |
| B022-11 | INFO | thing_types.ex:42–44 | No `@desc` on any field of the `:puls_record` Absinthe object type |
| B022-12 | LOW | thing_types.ex:4 | `@desc "A Thing"` on `:thing` object is insufficiently descriptive |
