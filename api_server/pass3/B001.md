# Pass 3: Documentation — B001
**Agent:** B001
**Files:**
- `lib/api_server.ex`
- `lib/api_server/application.ex`
- `lib/api_server/guardian.ex`
- `lib/api_server/repo.ex`

**Date:** 2026-02-27

---

## lib/api_server.ex

### Reading Evidence

**Module:** `ApiServer`

**Public functions:** None defined.

**Types / errors / constants defined:** None.

**Documentation present:**
- `@moduledoc` present (lines 2–8): boilerplate Phoenix-generated text describing contexts and business logic.

### Findings

No findings for this file. The module contains no public functions and its `@moduledoc` is present. The doc text is generic boilerplate but is not inaccurate — it makes no claims that contradict the (empty) implementation.

---

## lib/api_server/application.ex

### Reading Evidence

**Module:** `ApiServer.Application`

**Public functions:**

| Function | Line |
|---|---|
| `start/2` | 6 |
| `config_change/3` | 36 |

**Types / errors / constants defined:** None.

**Documentation present:**
- No `@moduledoc`.
- No `@doc` on `start/2`.
- No `@doc` on `config_change/3`.

### Findings

#### B001-1 — Missing @moduledoc in ApiServer.Application
**Severity:** LOW
**File:** `lib/api_server/application.ex`, line 1

`ApiServer.Application` has no `@moduledoc`. The module is the OTP application entry point and starts several non-trivial children (two Ecto repos, a Phoenix endpoint, a Quantum scheduler, a TCP server backed by a `Task.Supervisor`, and a `ConCache` geocode store). The absence of a module-level docstring means there is no description of the supervision tree or the TCP port configuration mechanism.

---

#### B001-2 — Missing @doc on start/2
**Severity:** INFO
**File:** `lib/api_server/application.ex`, line 6

The public callback `start/2` has no `@doc`. The function contains non-trivial behaviour: it reads `TCP_PORT` from the environment (defaulting to `4001`), builds a supervision tree with six children, and starts the supervisor with a `:one_for_one` strategy. None of this is documented.

---

#### B001-3 — Missing @doc on config_change/3
**Severity:** INFO
**File:** `lib/api_server/application.ex`, line 36

The public callback `config_change/3` has no `@doc`. The function delegates to `ApiServerWeb.Endpoint.config_change/2`, dropping the `_new` argument silently. Its purpose (hot-reload of Phoenix endpoint configuration) and the reason `_new` is unused are undocumented.

---

## lib/api_server/guardian.ex

### Reading Evidence

**Module:** `ApiServer.Guardian`

**Public functions:**

| Function | Arity | Line |
|---|---|---|
| `subject_for_token/2` (primary clause) | 2 | 6 |
| `subject_for_token/2` (fallback clause) | 2 | 14 |
| `resource_from_claims/1` (primary clause) | 1 | 18 |
| `resource_from_claims/1` (fallback clause) | 1 | 24 |

Both functions are multi-clause; the two clauses per function are treated as one public function each.

**Types / errors / constants defined:** None explicitly. Error atoms used: `:reason_for_error` (lines 8, 15, 25).

**Documentation present:**
- No `@moduledoc`.
- No `@doc` on `subject_for_token/2`.
- No `@doc` on `resource_from_claims/1`.

### Findings

#### B001-4 — Missing @moduledoc in ApiServer.Guardian
**Severity:** LOW
**File:** `lib/api_server/guardian.ex`, line 1

`ApiServer.Guardian` has no `@moduledoc`. This module implements the `Guardian` behaviour and is central to JWT authentication for the application. There is no description of the token subject strategy, what resource is resolved from claims, or which claim keys (`"sub"`, `"customer"`) are expected.

---

#### B001-5 — Missing @doc on subject_for_token/2
**Severity:** INFO
**File:** `lib/api_server/guardian.ex`, line 6

The public Guardian callback `subject_for_token/2` has no `@doc`. The function encodes a user's `aacid` field as the JWT subject. The nil-guard in the primary clause and the opaque error atom `:reason_for_error` (which does not describe the actual failure reason) are undocumented.

---

#### B001-6 — Missing @doc on resource_from_claims/1
**Severity:** INFO
**File:** `lib/api_server/guardian.ex`, line 18

The public Guardian callback `resource_from_claims/1` has no `@doc`. The function uses two custom claim keys (`"sub"` and `"customer"`) to reconstruct a user via `Vx.get_vx_user!/2`. The expected shape of the `claims` map and the fact that `get_vx_user!/2` may raise (bang function) are undocumented.

---

#### B001-7 — Inaccurate/misleading error atom :reason_for_error
**Severity:** MEDIUM
**File:** `lib/api_server/guardian.ex`, lines 8, 15, 25

All three error return sites use the literal atom `:reason_for_error` as the error value. This is placeholder text left over from Guardian's generated boilerplate. In production code this atom is returned to callers (and potentially to JWT error-handling pipelines) without conveying any meaningful reason for the failure. Callers that pattern-match or log on the error value receive no actionable information. While this is primarily a code-quality issue, it constitutes an inaccuracy between the implied semantics of an `{:error, reason}` tuple (where `reason` should describe the failure) and the actual atom used. It is recorded here as a documentation/accuracy finding because `@doc` for these functions, had it existed, would be expected to describe error conditions — making the placeholder impossible to document accurately without first correcting the atom.

---

## lib/api_server/repo.ex

### Reading Evidence

**Modules defined in file:** `ApiServer.Repo` (lines 1–11) and `ApiServer.FortyNineRepo` (lines 13–15).

**Public functions:**

| Module | Function | Arity | Line |
|---|---|---|---|
| `ApiServer.Repo` | `init/2` | 2 | 8 |
| `ApiServer.FortyNineRepo` | _(none defined)_ | — | — |

**Types / errors / constants defined:** None.

**Documentation present:**
- `ApiServer.Repo`: No `@moduledoc`. `@doc` present on `init/2` (lines 4–7).
- `ApiServer.FortyNineRepo`: No `@moduledoc`. No public functions defined beyond those inherited from `Ecto.Repo`.

### Findings

#### B001-8 — Missing @moduledoc in ApiServer.Repo
**Severity:** LOW
**File:** `lib/api_server/repo.ex`, line 1

`ApiServer.Repo` has no `@moduledoc`. A brief description of which database this repo connects to and how it loads its URL from the environment would be appropriate.

---

#### B001-9 — Missing @moduledoc in ApiServer.FortyNineRepo
**Severity:** LOW
**File:** `lib/api_server/repo.ex`, line 13

`ApiServer.FortyNineRepo` has no `@moduledoc`. This secondary Ecto repo defines no functions and provides no documentation about which database or OTP config key it corresponds to, making its purpose opaque to maintainers. The name "FortyNine" is unexplained anywhere in the file.

---

#### B001-10 — @doc on init/2 does not mention fallback behaviour when DATABASE_URL is unset
**Severity:** MEDIUM
**File:** `lib/api_server/repo.ex`, lines 4–9

The existing `@doc` for `init/2` states:

> "Dynamically loads the repository url from the DATABASE_URL environment variable."

The implementation is:

```elixir
def init(_, opts) do
  {:ok, Keyword.put(opts, :url, System.get_env("DATABASE_URL"))}
end
```

`System.get_env("DATABASE_URL")` returns `nil` when the variable is not set. `Keyword.put(opts, :url, nil)` will silently insert `url: nil` into the Ecto options, which will cause a runtime connection error rather than a clear configuration error at startup. The `@doc` does not mention this behaviour, does not document that the variable is required, and does not describe what happens when it is absent. The documented behaviour ("dynamically loads the url") is therefore incomplete in a way that could mislead operators into thinking unset `DATABASE_URL` is handled gracefully.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B001-1 | LOW | `lib/api_server/application.ex` | Missing `@moduledoc` in `ApiServer.Application` |
| B001-2 | INFO | `lib/api_server/application.ex`, line 6 | Missing `@doc` on `start/2` |
| B001-3 | INFO | `lib/api_server/application.ex`, line 36 | Missing `@doc` on `config_change/3` |
| B001-4 | LOW | `lib/api_server/guardian.ex` | Missing `@moduledoc` in `ApiServer.Guardian` |
| B001-5 | INFO | `lib/api_server/guardian.ex`, line 6 | Missing `@doc` on `subject_for_token/2` |
| B001-6 | INFO | `lib/api_server/guardian.ex`, line 18 | Missing `@doc` on `resource_from_claims/1` |
| B001-7 | MEDIUM | `lib/api_server/guardian.ex`, lines 8, 15, 25 | Placeholder error atom `:reason_for_error` makes error conditions undocumentable and misleading |
| B001-8 | LOW | `lib/api_server/repo.ex`, line 1 | Missing `@moduledoc` in `ApiServer.Repo` |
| B001-9 | LOW | `lib/api_server/repo.ex`, line 13 | Missing `@moduledoc` in `ApiServer.FortyNineRepo` |
| B001-10 | MEDIUM | `lib/api_server/repo.ex`, lines 4–9 | `@doc` on `init/2` omits nil/unset behaviour of `DATABASE_URL` |
