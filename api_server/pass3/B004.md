# Pass 3: Documentation — B004
**Agent:** B004
**Files:**
- `lib/api_server/tcp/tcp.ex`
- `lib/api_server/tcp/tcp_commands.ex`

**Date:** 2026-02-27

---

## lib/api_server/tcp/tcp.ex

### Reading Evidence

**Module name:** `ApiServer.TCP`

**@moduledoc:** Present (lines 2–4) — `"TCP Server for handling binary tracking devices"`

**Public functions:**

| Function | Line |
|---|---|
| `accept/1` | 23 |

**Private functions (not subject to @doc findings):**

| Function | Line |
|---|---|
| `loop_acceptor/1` | 32 |
| `serve/2` | 48 |
| `read_line/3` | 90 |
| `write_line/2` (binary text) | 135 |
| `write_line/2` (unknown_command) | 139 |
| `write_line/2` (closed) | 143 |
| `write_line/2` (generic error) | 147 |

**Types defined:** None

**Constants / module attributes defined:** None (aliases and imports only)

---

### Findings

#### B004-1 — `accept/1` is missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp.ex`, line 23

The sole public function `accept/1` has no `@doc` annotation. Its behaviour — opening a TCP listen socket on the given port, logging a startup message, and entering the acceptor loop — is entirely undocumented. There is also no `@spec` to indicate the expected type of `port` or the return value.

---

## lib/api_server/tcp/tcp_commands.ex

### Reading Evidence

**Module name:** `ApiServer.TCP.Commands`

**@moduledoc:** None present anywhere in the file.

**Public functions:**

| Function | Line |
|---|---|
| `parse_hello_message/1` | 9 |
| `parse_data_message/3` | 35 |
| `parse_debug_record/3` | 120 |
| `parse_data_record/3` | 158 |
| `parse_debug_field/1` | 1325 |
| `parse_gps_field/1` | 1331 |
| `parse_digital_field/1` | 1385 |
| `parse_analog_field/1` | 1454 |
| `parse_analog32_field/1` | 1470 |
| `parse_trip_field/1` | 1541 |
| `parse_total_field/1` | 1556 |
| `parse_driverid_field/1` | 1571 |
| `parse_commit_message/2` | 1673 |
| `parse_iridium/2` | 1679 |
| `parse/2` | 1903 |
| `run/1` (header/protocol declaration) | 1959 |
| `run/1` (`{:send, "hello", params}`) | 1961 |
| `run/1` (`{:send, "commit", params}`) | 1966 |
| `run/1` (`{:processed, "data", params}`) | 1976 |
| `run/1` (`{:close, "socket", params}`) | 1982 |

**Types defined:** None

**Constants / module attributes defined:** None

---

### Findings

#### B004-2 — Missing @moduledoc on `ApiServer.TCP.Commands`
**Severity:** LOW
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1

The module has no `@moduledoc` at all. A module of this scope — responsible for parsing a binary protocol spoken by GPS tracking hardware (hello handshake, data record upload, commit, iridium, close-socket messages) and dispatching responses — warrants at least a brief description of the protocol it implements, the device types it supports, and an overview of its parsing pipeline.

#### B004-3 — `parse_hello_message/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 9

No `@doc` annotation is present. The function decodes a binary hello payload (serial number, IMEI, SIM serial, product ID, hardware and firmware revision, flags), performs a device lookup by hardware ID, and returns `{:ok, {:send, "hello", params}}` on success or `{:error, {:error, "error", %{}}}` when no device is found. None of this is documented.

#### B004-4 — `parse_data_message/3` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 35

No `@doc` annotation is present. The function recursively decodes one or more binary data records from a device upload payload, delegating to `parse_debug_record/3` or `parse_data_record/3` depending on the log-reason byte, and always returns `{:ok, {:processed, "data", params}}`. Parameters and return contract are entirely undocumented.

#### B004-5 — `parse_debug_record/3` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 120

No `@doc` annotation is present. The function parses a binary debug record, reads a single field, dispatches to `parse_debug_field/1` for field ID 1, and always returns `[]`. Its purpose, inputs, and output are not documented.

#### B004-6 — `parse_data_record/3` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 158

No `@doc` annotation is present. This is the most complex function in the module (~1160 lines). It decodes a full binary data record into up to seven named fields (GPS, trip, total, driver ID, digital inputs, analog, analog32), maps log-reason bytes to event codes and types, handles vendor-specific serial-number allowlists (Trility, Yabby3), writes events to the primary database via `[REDACTED-AWS-SMTP-PASSWORD]`, conditionally writes to a secondary FortyNine database, and returns `[]`. None of this behaviour, nor any of its side effects, are documented.

#### B004-7 — `parse_debug_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1325

No `@doc` annotation is present. The function extracts a severity/module byte pair and an ASCII codepoint from a binary debug field. Its return value and input format are undocumented.

#### B004-8 — `parse_gps_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1331

No `@doc` annotation is present. The function decodes a 20-byte binary GPS field into a map with keys `Alt`, `FType`, `GpsStat`, `GpsUTC`, `Head`, `Lat`, `Long`, `PDOP`, `PosAcc`, `Spd`, and `SpdAcc`. The binary format, coordinate scaling (integer divided by 10,000,000), epoch offset (1 Jan 2013 = Unix 1,356,998,400), and returned map structure are entirely undocumented.

#### B004-9 — `parse_digital_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1385

No `@doc` annotation is present. The function decodes a binary digital-input/status field (4-byte inputs, 2-byte outputs, 2-byte status) and derives `input_zero`, `input_one`, `battery_good_status`, `battery_critical_status`, and a composite `battery_status` value. The field format and the battery-status encoding logic are undocumented.

#### B004-10 — `parse_analog_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1454

No `@doc` annotation is present. The function reads a raw analog field binary, hex-encodes it, and returns a map with `FType` (6), `Analog_Raw`, and `Analog_Hex`. The comment inside the function body (`# 15 analog fields, 3 bytes each …`) is the only documentation and is not accessible via ExDoc.

#### B004-11 — `parse_analog32_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1470

No `@doc` annotation is present. The function decodes a 32-bit analog field (field type 7) into up to three analog input values by hex-encoding the binary payload, chunking into 10-character groups, reversing byte pairs, and converting from hex. The returned map keys are `FType` (7), `Analog_Raw32`, `Analog_Hex32`, `Analog_Input1`, `Analog_Input2`, and `Analog_Input3`. This non-obvious parsing logic is entirely undocumented, and a `IO.puts/1` debug statement is left active at line 1492.

#### B004-12 — `parse_trip_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1541

No `@doc` annotation is present. The function decodes an 8-byte trip field (4-byte little-endian odometer and 4-byte little-endian run-hours duration) and returns a map with `Dist`, `FType` (26), and `Dur`. The field format and map structure are undocumented.

#### B004-13 — `parse_total_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1556

No `@doc` annotation is present. The function decodes an 8-byte total field (4-byte little-endian odometer and 4-byte little-endian run-hours) and returns a map with `Odo`, `FType` (27), and `RH`. The distinction between this function and `parse_trip_field/1` (different semantic keys despite identical binary layout) is not explained.

#### B004-14 — `parse_driverid_field/1` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1571

No `@doc` annotation is present. The function implements multi-branch driver ID parsing: iButton (type 2, 6-byte hex encoding), Wiegand 26-bit RFID (type 7 with 26-bit size, parity stripping to yield facility code + card code as a concatenated integer), and other RFID sizes (zero-padded hex). The returned map has `FType` (3), `driverIDType`, and `driverID`. This is the most behaviourally complex parsing function in the file and has no documentation whatsoever.

#### B004-15 — `parse_commit_message/2` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1673

No `@doc` annotation is present. The function ignores its `remainder` argument and returns `{:ok, {:send, "commit", params}}` unconditionally. The trivial but important no-op nature of the `remainder` parameter is not documented.

#### B004-16 — `parse_iridium/2` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1679

No `@doc` annotation is present. The function decodes a binary Iridium satellite message (3-subtype DirectIP framing: payload, header, location), derives event codes from the log-reason/input-mask/trip-status tuple, writes the event to the primary database, and also writes to both the FortyNine `[REDACTED-AWS-SMTP-PASSWORD]` and `[REDACTED-AWS-SMTP-PASSWORD]` tables with hardcoded `hardware_id` (462743), `custcode` ("TRILITY"), and credentials. None of this — including the hardcoded values — is documented.

#### B004-17 — `parse/2` missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, line 1903

No `@doc` annotation is present. `parse/2` is the main protocol dispatch entry point: it pattern-matches on message-type bytes (`<<0>>` = hello, `<<4>>` = data record upload with recursion for chained records, `<<5>>` = commit, `<<38>>` = close-socket). Its role as the top-level parser, the set of recognised message types, and its return tuples are entirely undocumented.

#### B004-18 — `run/1` (all clauses) missing @doc
**Severity:** INFO
**File:** `lib/api_server/tcp/tcp_commands.ex`, lines 1959–1986

None of the `run/1` clauses have a `@doc` annotation. The function translates internal command tuples to binary wire responses:
- `{:send, "hello", params}` → 13-byte hello-response frame
- `{:send, "commit", params}` → 6-byte commit-success frame
- `{:processed, "data", params}` → `<<0>>` (suppress reply)
- `{:close, "socket", params}` → `<<1>>` (signal socket close to caller)

The binary frame contents, their meaning on the wire, and the semantics of the `<<0>>`/`<<1>>` sentinel values are undocumented.

---

## Summary

| ID | Severity | Description |
|---|---|---|
| B004-1 | INFO | `ApiServer.TCP.accept/1` — missing @doc |
| B004-2 | LOW | `ApiServer.TCP.Commands` — missing @moduledoc |
| B004-3 | INFO | `parse_hello_message/1` — missing @doc |
| B004-4 | INFO | `parse_data_message/3` — missing @doc |
| B004-5 | INFO | `parse_debug_record/3` — missing @doc |
| B004-6 | INFO | `parse_data_record/3` — missing @doc (most complex function in module) |
| B004-7 | INFO | `parse_debug_field/1` — missing @doc |
| B004-8 | INFO | `parse_gps_field/1` — missing @doc |
| B004-9 | INFO | `parse_digital_field/1` — missing @doc |
| B004-10 | INFO | `parse_analog_field/1` — missing @doc |
| B004-11 | INFO | `parse_analog32_field/1` — missing @doc |
| B004-12 | INFO | `parse_trip_field/1` — missing @doc |
| B004-13 | INFO | `parse_total_field/1` — missing @doc |
| B004-14 | INFO | `parse_driverid_field/1` — missing @doc |
| B004-15 | INFO | `parse_commit_message/2` — missing @doc |
| B004-16 | INFO | `parse_iridium/2` — missing @doc |
| B004-17 | INFO | `parse/2` — missing @doc |
| B004-18 | INFO | `run/1` (all clauses) — missing @doc |
