# Pass 3: Documentation — B027
**Agent:** B027
**Files:**
- `lib/api_server_web/views/vx_thing_summary_view.ex`
- `lib/api_server_web/views/vx_thing_view.ex`
- `lib/api_server_web/views/vx_user_function_view.ex`
- `lib/api_server_web/views/vx_user_view.ex`

**Date:** 2026-02-27

---

## vx_thing_summary_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingSummaryView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` — `"index.json"` clause | 5 |
| `render/2` — `"show.json"` clause | 9 |
| `render/2` — `"vx_thing_summary.json"` clause | 13 |
| `render/2` — `"rhm_thing_summary.json"` clause | 57 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc`, `@doc`, and `@spec` are all absent throughout the file).

---

### Findings

#### B027-1 — Missing @moduledoc in VXThingSummaryView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 1

The module `ApiServerWeb.VXThingSummaryView` has no `@moduledoc` attribute. There is no description of the module's purpose, the data it serialises, or the JSON templates it supports (`vx_thing_summary.json` for full-field output and the alternative `rhm_thing_summary.json` for the structured RHM payload).

---

#### B027-2 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 5

The public function clause `render("index.json", %{vxthingsummaries: vxthingsummaries})` has no `@doc`. No description is provided of the expected assigns key (`vxthingsummaries`) or the shape of the returned JSON envelope (`%{data: [...]}`).

---

#### B027-3 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 9

The public function clause `render("show.json", %{vx_thing_summary: vx_thing_summary})` has no `@doc`. No description is provided of the expected assigns key or the `%{data: ...}` envelope it produces.

---

#### B027-4 — Missing @doc on render/2 ("vx_thing_summary.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 13

The public function clause `render("vx_thing_summary.json", %{vx_thing_summary: vx_thing_summary})` has no `@doc`. This is the primary serialisation clause; it outputs a large flat map of 32 `abm*` fields with no documentation explaining what those fields represent or their units.

---

#### B027-5 — Missing @doc on render/2 ("rhm_thing_summary.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_summary_view.ex`, line 57

The public function clause `render("rhm_thing_summary.json", %{vx_thing_summary: summary})` has no `@doc`. This clause produces a differently structured nested output (GPS block, hour-meter sub-keys, operator block) compared to `vx_thing_summary.json`. The distinction between the two templates and the rationale for the structural difference are entirely undocumented.

---

## vx_thing_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` — `"index.json"` clause | 8 |
| `render/2` — `"show.json"` clause | 12 |
| `render/2` — `"fleet_map.json"` (list) clause | 16 |
| `render/2` — `"fleet_map.json"` (single) clause | 20 |
| `render/2` — `"hardware_with_checklists.json"` clause | 105 |
| `render/2` — `"pm_data.json"` (list) clause | 109 |
| `render/2` — `"pm_data.json"` (single) clause | 113 |
| `render/2` — `"movements.json"` clause | 147 |
| `render/2` — `"movement.json"` clause | 150 |
| `render/2` — `"checklists.json"` clause | 164 |
| `render/2` — `"vx_checklist.json"` clause | 168 |
| `render/2` — `"vx_thing.json"` clause | 176 |
| `render/2` — `"rhm_thing_usage.json"` clause | 220 |
| `render/2` — `"rhm_thing_usage_manual.json"` clause | 224 |
| `render/2` — `"usage_report.json"` clause | 228 |
| `render/2` — `"usage_report_many.json"` clause | 265 |
| `render/2` — `"rhm_things_usage.json"` clause | 292 |
| `render/2` — `"rhm_thing_events.json"` clause | 315 |
| `render/2` — `"event_report.json"` clause | 318 |
| `render/2` — `"rhm_thing.json"` (list) clause | 351 |
| `render/2` — `"rhm_thing.json"` (single) clause | 354 |
| `render/2` — `"basic_thing.json"` (nil) clause | 359 |
| `render/2` — `"basic_thing.json"` clause | 360 |
| `render/2` — `"sielift_wip_export.json"` clause | 396 |
| `render/2` — `"pape_exports.json"` clause | 434 |
| `render/2` — `"pape_export.json"` clause | 437 |
| `render/2` — `"rhm_things_names.json"` clause | 449 |
| `render/2` — `"things_only.json"` clause | 453 |
| `info_to_map/1` | 487 |
| `thing_to_map/2` | 499 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc`, `@doc`, and `@spec` are all absent).

**Other notable observations:**
- A large block of commented-out experimental code exists at lines 508–532 inside `thing_to_map/2` (predicted service date logic). This dead code has inline explanatory comments but no formal documentation.
- `pm_data.json` single-item clause (line 113) contains hard-coded placeholder values (`previousweek: 0.1`, `thisweek: 0.2`, `avgperweek: 0.2`, `mtdraw: 0.3`, `weekstoservice: 0.4`) with no documentation acknowledging they are stubs.
- `fleet_map.json` single-item clause (line 20) returns an empty string `""` when `vx_thing.summary == nil`; this behaviour is undocumented.

---

### Findings

#### B027-6 — Missing @moduledoc in VXThingView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_thing_view.ex`, line 1

The module `ApiServerWeb.VXThingView` has no `@moduledoc`. With 30 public function clauses covering fleet maps, PM data, movements, checklists, events, usage reports, WIP exports, and named-entity exports, the lack of any module-level description makes the view extremely difficult to understand at a glance.

---

#### B027-7 — Missing @doc on all render/2 clauses (VXThingView)
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_view.ex`, lines 8, 12, 16, 20, 105, 109, 113, 147, 150, 164, 168, 176, 220, 224, 228, 265, 292, 315, 318, 351, 354, 359, 360, 396, 434, 437, 449, 453

None of the 28 `render/2` clauses has a `@doc` attribute. Because `@doc` applies to the first clause of a function and covers all pattern-match clauses, a single `@doc` block before line 8 (or targeted per template group) would be standard practice. The complete absence leaves callers with no guidance on required assigns keys, return shapes, or the differences between similarly-named templates (e.g., `"rhm_thing.json"` vs `"vx_thing.json"` vs `"basic_thing.json"`).

---

#### B027-8 — Missing @doc on info_to_map/1
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_view.ex`, line 487

The public helper `info_to_map/1` has no `@doc` or `@spec`. Its purpose (converting a `thing_info` struct to a PM-notification map, returning `%{}` on `nil` input) and its expected argument type are undocumented.

---

#### B027-9 — Missing @doc on thing_to_map/2
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_thing_view.ex`, line 499

The public helper `thing_to_map/2` has no `@doc` or `@spec`. This is a significant function: it computes `weeks_to_service`, maps fleets, and delegates to `render_one` for the summary. The guard logic (`vx_thing == nil` check at line 541 is reached only after already accessing `vx_thing.aadsvchrs` at line 502, making the nil-guard potentially dead code) is non-obvious and entirely undocumented.

---

#### B027-10 — Undocumented stub/placeholder values in pm_data.json render clause
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_thing_view.ex`, lines 138–142

The `render("pm_data.json", %{vx_thing: vx_thing})` clause returns hard-coded sentinel values (`previousweek: 0.1`, `thisweek: 0.2`, `avgperweek: 0.2`, `mtdraw: 0.3`, `weekstoservice: 0.4`) that are clearly placeholders, not real data. There is no `@doc`, inline comment, or TODO explaining that these fields are unimplemented stubs. A consumer of this API endpoint would have no way to know these figures are fabricated, potentially leading to incorrect business decisions.

---

## vx_user_function_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXUserFunctionView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` — `"index.json"` clause | 5 |
| `render/2` — `"show.json"` clause | 9 |
| `render/2` — `"vx_user_function.json"` clause | 13 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc`, `@doc`, and `@spec` are all absent).

---

### Findings

#### B027-11 — Missing @moduledoc in VXUserFunctionView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_user_function_view.ex`, line 1

The module `ApiServerWeb.VXUserFunctionView` has no `@moduledoc`. No description is provided of the resource being serialised (user-to-function permission assignments) or the fields exposed (`id`, `aatid`, `aatuser_id`, `aatfunctionid`).

---

#### B027-12 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_function_view.ex`, line 5

The public clause `render("index.json", %{vxaatuserfunctions: vxaatuserfunctions})` has no `@doc`. The assigns key `vxaatuserfunctions` and the `%{data: [...]}` envelope are undocumented.

---

#### B027-13 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_function_view.ex`, line 9

The public clause `render("show.json", %{vx_user_function: vx_user_function})` has no `@doc`.

---

#### B027-14 — Missing @doc on render/2 ("vx_user_function.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_function_view.ex`, line 13

The public clause `render("vx_user_function.json", %{vx_user_function: vx_user_function})` has no `@doc`. The four fields output (`id`, `aatid`, `aatuser_id`, `aatfunctionid`) use opaque `aat`-prefixed naming and have no explanation of their semantic meaning.

---

## vx_user_view.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXUserView`

**Public functions:**

| Function | Line |
|---|---|
| `render/2` — `"index.json"` clause | 5 |
| `render/2` — `"show.json"` clause | 9 |
| `render/2` — `"rhm_users.json"` clause | 13 |
| `render/2` — `"rhm_user.json"` clause | 17 |
| `render/2` — `"fleet_list.json"` clause | 58 |

**Types / errors / constants defined:** None.

**Documentation attributes present:** None (`@moduledoc`, `@doc`, and `@spec` are all absent).

**Other notable observations:**
- `render("rhm_user.json", ...)` (line 17) implements conditional logic: it optionally merges a `jwt` field if present in the assigns map, a `login_message` field if present, and derives `user_level` from `user.function.aatfunction_id` with a hard-coded default of `2`. None of this conditional behaviour is documented.
- The `offset` and `timezone` fields (lines 46–47) are mapped from the same source field `aactimezone`, making them duplicates; this is undocumented and potentially confusing.

---

### Findings

#### B027-15 — Missing @moduledoc in VXUserView
**Severity:** LOW
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 1

The module `ApiServerWeb.VXUserView` has no `@moduledoc`. There is no description of the user resource being serialised, the templates it handles, or the conditional fields (JWT, login message, user level) it manages.

---

#### B027-16 — Missing @doc on render/2 ("index.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 5

The public clause `render("index.json", %{vxusers: vxusers})` has no `@doc`. Notably this clause delegates to `"rhm_user.json"` rather than a plain `"vx_user.json"` template, which is non-obvious and undocumented.

---

#### B027-17 — Missing @doc on render/2 ("show.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 9

The public clause `render("show.json", %{vx_user: vx_user})` has no `@doc`. Unlike the index clause it does not wrap output in a `%{data: ...}` envelope, which is an asymmetry that is entirely undocumented.

---

#### B027-18 — Missing @doc on render/2 ("rhm_users.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 13

The public clause `render("rhm_users.json", %{vx_users: users})` has no `@doc`.

---

#### B027-19 — Missing @doc on render/2 ("rhm_user.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 17

The public clause `render("rhm_user.json", %{vx_user: user})` has no `@doc`. This is the most complex clause in the module: it implements three conditional branches (JWT merging, login-message merging, user-level derivation with a hard-coded default of `2`), renames many fields from `aac`-prefixed source names, and duplicates `aactimezone` into both `offset` and `timezone`. None of this behaviour is described.

---

#### B027-20 — Missing @doc on render/2 ("fleet_list.json")
**Severity:** INFO
**File:** `lib/api_server_web/views/vx_user_view.ex`, line 58

The public clause `render("fleet_list.json", %{fleet_list: fleet_list})` has no `@doc`. The shape of `fleet_list` elements and the `allowed_fleets` key are undocumented.

---

#### B027-21 — Duplicate field (offset/timezone) undocumented in rhm_user.json render
**Severity:** MEDIUM
**File:** `lib/api_server_web/views/vx_user_view.ex`, lines 46–47

The `render("rhm_user.json", ...)` clause maps `user.aactimezone` to both `offset:` (line 46) and `timezone:` (line 47), producing two fields in the JSON response with identical values. There is no `@doc`, inline comment, or TODO explaining why both are emitted, whether one is a deprecated alias of the other, or which clients consume which key. This undocumented duplication risks confusion and unintended API surface.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B027-1 | LOW | vx_thing_summary_view.ex:1 | Missing @moduledoc in VXThingSummaryView |
| B027-2 | INFO | vx_thing_summary_view.ex:5 | Missing @doc on render/2 ("index.json") |
| B027-3 | INFO | vx_thing_summary_view.ex:9 | Missing @doc on render/2 ("show.json") |
| B027-4 | INFO | vx_thing_summary_view.ex:13 | Missing @doc on render/2 ("vx_thing_summary.json") |
| B027-5 | INFO | vx_thing_summary_view.ex:57 | Missing @doc on render/2 ("rhm_thing_summary.json") |
| B027-6 | LOW | vx_thing_view.ex:1 | Missing @moduledoc in VXThingView |
| B027-7 | INFO | vx_thing_view.ex:8–453 | Missing @doc on all 28 render/2 clauses in VXThingView |
| B027-8 | INFO | vx_thing_view.ex:487 | Missing @doc on info_to_map/1 |
| B027-9 | INFO | vx_thing_view.ex:499 | Missing @doc on thing_to_map/2 |
| B027-10 | MEDIUM | vx_thing_view.ex:138–142 | Undocumented stub/placeholder values returned from pm_data.json render clause |
| B027-11 | LOW | vx_user_function_view.ex:1 | Missing @moduledoc in VXUserFunctionView |
| B027-12 | INFO | vx_user_function_view.ex:5 | Missing @doc on render/2 ("index.json") |
| B027-13 | INFO | vx_user_function_view.ex:9 | Missing @doc on render/2 ("show.json") |
| B027-14 | INFO | vx_user_function_view.ex:13 | Missing @doc on render/2 ("vx_user_function.json") |
| B027-15 | LOW | vx_user_view.ex:1 | Missing @moduledoc in VXUserView |
| B027-16 | INFO | vx_user_view.ex:5 | Missing @doc on render/2 ("index.json") |
| B027-17 | INFO | vx_user_view.ex:9 | Missing @doc on render/2 ("show.json") |
| B027-18 | INFO | vx_user_view.ex:13 | Missing @doc on render/2 ("rhm_users.json") |
| B027-19 | INFO | vx_user_view.ex:17 | Missing @doc on render/2 ("rhm_user.json") |
| B027-20 | INFO | vx_user_view.ex:58 | Missing @doc on render/2 ("fleet_list.json") |
| B027-21 | MEDIUM | vx_user_view.ex:46–47 | Duplicate offset/timezone fields from same source with no documentation explaining the duplication |
