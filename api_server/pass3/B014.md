# Pass 3: Documentation — B014
**Agent:** B014
**Files:**
- `lib/api_server_web/channels/user_socket.ex`
- `lib/api_server_web/endpoint.ex`
- `lib/api_server_web/gettext.ex`
- `lib/api_server_web/xml_plug.ex`

**Date:** 2026-02-27

---

## user_socket.ex

### Reading Evidence

- **Module:** `ApiServerWeb.UserSocket`
- **Public functions:**
  - `connect/2` — line 22
  - `id/1` — line 36
- **Types / errors / constants defined:** none
- **`@moduledoc`:** absent
- **`@doc` annotations:** none on either public function

### Findings

#### B014-1 — Missing @moduledoc in ApiServerWeb.UserSocket
**Severity:** LOW
**File:** `lib/api_server_web/channels/user_socket.ex`, line 1

The module `ApiServerWeb.UserSocket` has no `@moduledoc`. There is no high-level description of the socket's purpose, what transports it exposes, or the authentication/authorisation model in force (the current implementation accepts all connections without any verification via `connect/2`). That last point is particularly important context for readers.

---

#### B014-2 — Missing @doc on ApiServerWeb.UserSocket.connect/2
**Severity:** INFO
**File:** `lib/api_server_web/channels/user_socket.ex`, line 22

`connect/2` is a public Phoenix.Socket callback with no `@doc`. The inline comments above the function (lines 11-21) describe the general Phoenix pattern but do not constitute `@doc` and will not appear in generated documentation. The doc should state that all connections are currently accepted unconditionally (returning `{:ok, socket}` for any params) and describe expected params and return values.

---

#### B014-3 — Missing @doc on ApiServerWeb.UserSocket.id/1
**Severity:** INFO
**File:** `lib/api_server_web/channels/user_socket.ex`, line 36

`id/1` is a public Phoenix.Socket callback with no `@doc`. The inline comments above (lines 26-35) describe what a non-nil implementation would do but do not constitute `@doc`. The doc should state that the implementation always returns `nil`, making every socket anonymous, and explain the consequence: targeted broadcast/disconnect by user is not supported.

---

## endpoint.ex

### Reading Evidence

- **Module:** `ApiServerWeb.Endpoint`
- **Public functions:**
  - `init/2` — line 51
- **Types / errors / constants defined:** none
- **`@moduledoc`:** absent
- **`@doc` annotations:** `@doc` present on `init/2` (lines 45-50)
- **Plug pipeline (not functions, but architecturally significant):**
  - `Plug.Static` (line 10)
  - `Phoenix.LiveReloader.Socket`, `Phoenix.LiveReloader`, `Phoenix.CodeReloader` (lines 17-19, dev only)
  - `Plug.Logger` (line 22)
  - `Plug.Parsers` with `:urlencoded`, `:multipart`, `:json`, `:xml`, `Absinthe.Plug.Parser` (line 24-28)
  - `Plug.MethodOverride` (line 30)
  - `Plug.Head` (line 31)
  - `Plug.Session` (line 36)
  - `CORSPlug` (line 42)
  - `ApiServerWeb.Router` (line 43)

### Findings

#### B014-4 — Missing @moduledoc in ApiServerWeb.Endpoint
**Severity:** LOW
**File:** `lib/api_server_web/endpoint.ex`, line 1

The module `ApiServerWeb.Endpoint` has no `@moduledoc`. There is no description of the plug pipeline, the socket mount point, or any environment-specific behaviour (e.g. the code-reloader being active only when `code_reloading?` is true). A module-level doc would help developers understand the full request lifecycle and the security-relevant middleware ordering.

---

#### B014-5 — @doc on init/2 is inaccurate: omits non-system-env branch behaviour
**Severity:** MEDIUM
**File:** `lib/api_server_web/endpoint.ex`, lines 45-58

The existing `@doc` for `init/2` states the function "checks if configuration should be loaded from the system environment" but does not document the non-system-env branch. When `config[:load_from_system_env]` is falsy the function returns `{:ok, config}` unchanged; this is a meaningful code path that is silently omitted from the doc. Additionally, the `@doc` does not mention that a missing `PORT` environment variable raises a runtime error (`raise "expected the PORT environment variable to be set"`), which is important operational information.

The `@doc` also describes the first parameter as `_key` without explaining what the `key` argument represents in the Phoenix endpoint `init/2` callback (it is the `:start_link` or `:call` atom). No `@spec` is present.

---

## gettext.ex

### Reading Evidence

- **Module:** `ApiServerWeb.Gettext`
- **Public functions:** none defined explicitly; all public API is injected by `use Gettext, otp_app: :api_server` (macros `gettext/1`, `ngettext/3`, `dgettext/3`, etc.)
- **Types / errors / constants defined:** none
- **`@moduledoc`:** present (lines 2-22)

### Findings

No documentation findings. The module has a `@moduledoc` that accurately describes the injected Gettext API with examples. No explicitly defined public functions require `@doc` annotations.

---

## xml_plug.ex

### Reading Evidence

- **Module:** `Plug.Parsers.XML`
- **Behaviour:** `Plug.Parsers`
- **Public functions:**
  - `parse/5` (XML content-type clause) — line 6
  - `parse/5` (catch-all clause) — line 13
- **Private functions:**
  - `decode/2` — line 17
- **Types / errors / constants defined:** none
- **`@moduledoc`:** absent
- **`@doc` annotations:** none on either public function clause

### Findings

#### B014-6 — Missing @moduledoc in Plug.Parsers.XML
**Severity:** LOW
**File:** `lib/api_server_web/xml_plug.ex`, line 1

The module `Plug.Parsers.XML` has no `@moduledoc`. There is no description of the module's purpose (a custom Plug.Parsers behaviour implementation for XML bodies), the required `:xml_decoder` option, the output structure placed into `conn.params` (`%{xml: map}`), or the error behaviour on malformed XML.

---

#### B014-7 — Missing @doc on Plug.Parsers.XML.parse/5 (XML clause)
**Severity:** INFO
**File:** `lib/api_server_web/xml_plug.ex`, line 6

The XML-matching clause of `parse/5` has no `@doc`. The doc should state: the function matches when the content subtype is `"xml"`, requires an `:xml_decoder` key in `opts` (raises `ArgumentError` if absent), reads the request body, converts it to a map via `XmlToMap.naive_map/1`, and places the result under the `:xml` key in `conn.params`. It should also note that malformed XML raises `Plug.Parsers.ParseError`.

Note: the `:xml_decoder` option is fetched from `opts` at line 7 but is not actually passed to the decoder — `XmlToMap.naive_map/1` is called directly in `decode/2` without using the configured decoder value. This is a functional inconsistency that a `@doc` describing expected behaviour would expose immediately.

---

#### B014-8 — Missing @doc on Plug.Parsers.XML.parse/5 (catch-all clause)
**Severity:** INFO
**File:** `lib/api_server_web/xml_plug.ex`, line 13

The catch-all clause of `parse/5` has no `@doc`. The doc should state that for any content type other than `*/xml` the function returns `{:next, conn}` to delegate to the next parser in the pipeline.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B014-1 | LOW | `user_socket.ex:1` | Missing `@moduledoc` in `ApiServerWeb.UserSocket` |
| B014-2 | INFO | `user_socket.ex:22` | Missing `@doc` on `connect/2` |
| B014-3 | INFO | `user_socket.ex:36` | Missing `@doc` on `id/1` |
| B014-4 | LOW | `endpoint.ex:1` | Missing `@moduledoc` in `ApiServerWeb.Endpoint` |
| B014-5 | MEDIUM | `endpoint.ex:45` | `@doc` on `init/2` is inaccurate: omits non-system-env branch and runtime raise on missing PORT |
| B014-6 | LOW | `xml_plug.ex:1` | Missing `@moduledoc` in `Plug.Parsers.XML` |
| B014-7 | INFO | `xml_plug.ex:6` | Missing `@doc` on `parse/5` (XML clause) |
| B014-8 | INFO | `xml_plug.ex:13` | Missing `@doc` on `parse/5` (catch-all clause) |
