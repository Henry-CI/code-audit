# Pass 3: Documentation — B020
**Agent:** B020
**Files:**
- `lib/api_server_web/controllers/vx_thing_omega_controller.ex`
- `lib/api_server_web/controllers/vx_thing_summary_controller.ex`
- `lib/api_server_web/controllers/vx_user_controller.ex`
- `lib/api_server_web/controllers/vx_user_function_controller.ex`

**Date:** 2026-02-27

---

## vx_thing_omega_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingOmegaController`

**Public functions (all lack @doc):**

| Function | Line | Notes |
|---|---|---|
| `get_container_lift_report/2` | 10 | Pattern: `hardwareid`, `from`, `to` |
| `get_lift_summary_report/2` | 22 | Pattern: `hardwareid`, `from`, `to` |
| `get_lift_list_report/2` | 33 | Pattern: `hardwareid`, `from`, `to` |
| `get_lift_summary_report/2` | 44 | Second clause — pattern: `fleetid`, `from`, `to` |
| `get_operation_summary_report/2` | 53 | Pattern: `fleetid`, `from`, `to` |
| `get_engine_utilization_report/2` | 63 | Pattern: `hardwareid`, `from`, `to` |

**Types / errors / constants defined:** None.

**Additional notes:**
- No `@moduledoc` present anywhere in the file.
- No `@doc` annotations on any public function.
- `get_lift_summary_report/2` has two distinct clauses (lines 22 and 44): one accepting `hardwareid`, one accepting `fleetid`. These are multi-clause functions that serve fundamentally different resource types without any documentation distinction.

### Findings

#### B020-1 — Missing @moduledoc in VXThingOmegaController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 1

The module `ApiServerWeb.VXThingOmegaController` has no `@moduledoc` attribute. There is no module-level description of what reports this controller provides, which authentication model it relies on, or what domain (`hardwareid`/`fleetid` lift and engine data) it serves.

---

#### B020-2 — Missing @doc on get_container_lift_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 10

`get_container_lift_report/2` has no `@doc`. The function fetches per-day container lift event counts for a specific hardware device over a date range, respecting the authenticated user's timezone. None of this is documented.

---

#### B020-3 — Missing @doc on get_lift_summary_report/2 (hardwareid clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 22

The first clause of `get_lift_summary_report/2`, which operates on a `hardwareid`, has no `@doc`. The absence of documentation is compounded by the existence of a second clause (line 44) for `fleetid`; there is no documentation to distinguish the two dispatch paths.

---

#### B020-4 — Missing @doc on get_lift_list_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 33

`get_lift_list_report/2` has no `@doc`. The function returns a flat list of individual lift events (rather than a per-day summary) for a given hardware device and date range.

---

#### B020-5 — Missing @doc on get_lift_summary_report/2 (fleetid clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 44

The second clause of `get_lift_summary_report/2`, which dispatches on `fleetid` instead of `hardwareid`, has no `@doc`. Because Elixir `@doc` attaches to the first clause, both clauses share the documentation gap identified in B020-3. The fleet-level aggregation semantics are entirely undocumented.

---

#### B020-6 — Missing @doc on get_operation_summary_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 53

`get_operation_summary_report/2` has no `@doc`. The function retrieves an omega operation summary for a fleet over a date range.

---

#### B020-7 — Missing @doc on get_engine_utilization_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_omega_controller.ex`, line 63

`get_engine_utilization_report/2` has no `@doc`. The function fetches per-day engine utilization data for a specific hardware device over a date range.

---

## vx_thing_summary_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingSummaryController`

**Public functions (all lack @doc):**

| Function | Line | Notes |
|---|---|---|
| `index/2` | 9 | Lists all VX thing summaries |
| `create/2` | 14 | Creates a new VX thing summary |
| `show/2` | 23 | Returns a single VX thing summary by id |
| `update/2` | 28 | Updates an existing VX thing summary |
| `delete/2` | 36 | Deletes a VX thing summary |
| `do_fix_summary/2` | 45 | Validates summary for a given hardwareid and customer; not a Phoenix action |

**Types / errors / constants defined:** None.

**Additional notes:**
- No `@moduledoc` present.
- No `@doc` on any public function.
- `do_fix_summary/2` is a public utility function that is not a Phoenix controller action (it takes `hardwareid` and `customer` rather than `conn` and `params`). Its exposure as a public function with no documentation is a particular gap.

### Findings

#### B020-8 — Missing @moduledoc in VXThingSummaryController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 1

The module `ApiServerWeb.VXThingSummaryController` has no `@moduledoc` explaining the VX thing summary resource or CRUD operations it exposes.

---

#### B020-9 — Missing @doc on index/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 9

`index/2` has no `@doc`. The function lists all VX thing summaries via `Vx.list_vxthingsummaries/0`.

---

#### B020-10 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 14

`create/2` has no `@doc`. The function creates a new `VXThingSummary` record and returns HTTP 201 with a `location` header on success.

---

#### B020-11 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 23

`show/2` has no `@doc`. The function fetches and renders a single VX thing summary by its `id`.

---

#### B020-12 — Missing @doc on update/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 28

`update/2` has no `@doc`. The function updates an existing VX thing summary with the provided parameters.

---

#### B020-13 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 36

`delete/2` has no `@doc`. The function deletes a VX thing summary by its `id` and returns HTTP 204 No Content.

---

#### B020-14 — Missing @doc on do_fix_summary/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_summary_controller.ex`, line 45

`do_fix_summary/2` has no `@doc`. This function is notably not a Phoenix controller action — it takes `(hardwareid, customer)` rather than `(conn, params)` — making the absence of documentation more significant. Its purpose (triggering `VXThingSummary.validate_for_hardwareid/2`) and expected callers are undocumented.

---

## vx_user_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXUserController`

**Public functions (all lack @doc):**

| Function | Line | Notes |
|---|---|---|
| `create/2` | 9 | Creates a VX user record; legacy/generic path |
| `lookup_customer_from_conn/1` | 18 | Derives customer tenant from the HTTP `origin` header |
| `login/2` | 41 | Authenticates user, issues JWT, sets session |
| `change_password/2` | 59 | Validates current password and sets new password |
| `get_users/2` | 82 | Lists all users for a customer |
| `get_user_with_email/2` | 89 | Fetches a single user by email and customer |
| `update_key_if_value/3` | 99 | Utility: puts a key into a map only when value is non-nil (first clause: nil guard) |
| `update_key_if_value/3` | 100 | Utility: puts a key into a map only when value is non-nil (second clause: general) |
| `update_user/2` | 104 | Updates a user record by id; first clause requires `user` key |
| `update_user/2` | 127 | Second clause: returns error when no `user` key present in params |
| `create_user/2` | 131 | Creates a new user, checking for duplicate email first |
| `delete_user/2` | 153 | Deletes a user by id |
| `get_user_fleets/2` | 168 | Returns fleet IDs assigned to a user |
| `manage_user_fleets/2` | 180 | Reconciles allowed fleet list for a user (adds/removes) |

**Types / errors / constants defined:** None.

**Additional notes:**
- No `@moduledoc` present.
- No `@doc` on any public function.
- `lookup_customer_from_conn/1` uses a hardcoded list of HTTP origins (including `http://` — non-TLS) to derive the tenant. This is a public function with no documentation of the mapping table or the fallback behaviour (`"vx_dev"` for all unknown origins).
- `update_key_if_value/3` is a general-purpose utility that is public but undocumented.
- `login/2` derives `cust_from_origin` (line 42) but then uses the `customer` parameter from the request body when signing the JWT (line 45) — `cust_from_origin` is only stored in the session, not the token. This nuance is undocumented.

### Findings

#### B020-15 — Missing @moduledoc in VXUserController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 1

The module `ApiServerWeb.VXUserController` has no `@moduledoc` describing the user authentication and management operations it exposes, nor the multi-tenant model it employs.

---

#### B020-16 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 9

`create/2` has no `@doc`. This function takes a `"vx_user"` params map and delegates to `Vx.create_vx_user/1`. Its relationship to `create_user/2` (which includes duplicate-email checks) is not documented.

---

#### B020-17 — Missing @doc on lookup_customer_from_conn/1
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 18

`lookup_customer_from_conn/1` has no `@doc`. The function encapsulates a hardcoded table of HTTP origin headers mapped to customer tenant identifiers, with a catch-all fallback of `"vx_dev"`. The full mapping and the fallback behaviour are invisible to callers.

---

#### B020-18 — Missing @doc on login/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 41

`login/2` has no `@doc`. The function authenticates a user, signs a JWT via Guardian, and sets both a session cookie and returns the token in the response body. The distinction between `customer` (from the request body, embedded in JWT claims) and `cust_from_origin` (derived from the `origin` header, stored only in session) is not documented.

---

#### B020-19 — Missing @doc on change_password/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 59

`change_password/2` has no `@doc`. The function validates the current password before applying the new one, and returns HTTP 500 when the new password is nil or empty.

---

#### B020-20 — Missing @doc on get_users/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 82

`get_users/2` has no `@doc`. The function ignores the `customer` param supplied in the request body and instead extracts the customer from JWT claims.

---

#### B020-21 — Missing @doc on get_user_with_email/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 89

`get_user_with_email/2` has no `@doc`. The function fetches a user by email and customer, returning HTTP 500 with an auth-style error message when no user is found.

---

#### B020-22 — Missing @doc on update_key_if_value/3
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 99

`update_key_if_value/3` has no `@doc`. This is a utility function with two clauses (nil guard and general case) that conditionally inserts a key/value pair into a map. Its purpose and usage context within the controller are entirely undocumented.

---

#### B020-23 — Missing @doc on update_user/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 104

`update_user/2` has no `@doc`. Two clauses exist: one that expects both `"customer"` and `"user"` params (line 104) and one that returns an error when `"user"` is absent (line 127). The multi-clause dispatch is undocumented.

---

#### B020-24 — Missing @doc on create_user/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 131

`create_user/2` has no `@doc`. Unlike `create/2`, this function performs a duplicate-email check before creation and handles the distinction between an already-existing account and other errors.

---

#### B020-25 — Missing @doc on delete_user/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 153

`delete_user/2` has no `@doc`. The function deletes a user by `id` within a given customer scope and returns HTTP 200 with an empty JSON body on success.

---

#### B020-26 — Missing @doc on get_user_fleets/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 168

`get_user_fleets/2` has no `@doc`. The function retrieves fleet IDs assigned to a user by filtering `assigned_fleets` restrictions where `aaufun == "FLEET"` and `aaunumval` is non-nil. The filtering logic and the restriction schema are opaque without documentation.

---

#### B020-27 — Missing @doc on manage_user_fleets/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_user_controller.ex`, line 180

`manage_user_fleets/2` has no `@doc`. The function reconciles the user's fleet assignments: it computes the symmetric difference between current and allowed fleets, then adds and removes accordingly. The idempotency semantics and the side-effects on the database are undocumented.

---

## vx_user_function_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXUserFunctionController`

**Public functions:** None. All action bodies are commented out.

**Commented-out functions (not active, lines noted for reference):**

| Commented function | Lines |
|---|---|
| `index/2` | 9–12 |
| `create/2` | 14–21 |
| `show/2` | 23–26 |
| `update/2` | 28–34 |
| `delete/2` | 36–41 |

**Types / errors / constants defined:** None.

**Additional notes:**
- The entire action body of this controller is commented out. The module compiles but provides no routable actions.
- There is no `@moduledoc`, no `@doc` annotations, and no comment explaining why the functions are disabled or whether they are intended to be re-enabled.
- The module still declares `alias ApiServer.Vx` and `alias ApiServer.Vx.VXUserFunction` and `action_fallback`, suggesting it was scaffolded and then deactivated rather than deleted.

### Findings

#### B020-28 — Missing @moduledoc in VXUserFunctionController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_user_function_controller.ex`, line 1

The module `ApiServerWeb.VXUserFunctionController` has no `@moduledoc`. Given that all action code is commented out, this is the only opportunity to document the module's purpose, its current deactivated state, and the rationale for retaining the file.

---

#### B020-29 — No explanation comment for wholesale commented-out action bodies
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_user_function_controller.ex`, lines 9–41

All five standard CRUD actions (`index`, `create`, `show`, `update`, `delete`) are commented out with no accompanying explanation. There is no `@moduledoc`, inline comment, or annotation indicating whether this is temporary (pending implementation), intentionally disabled (feature flag), or a sign of dead code pending removal. Future maintainers have no context to decide whether to restore, complete, or delete this module.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B020-1 | LOW | vx_thing_omega_controller.ex | Missing @moduledoc |
| B020-2 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_container_lift_report/2 |
| B020-3 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_lift_summary_report/2 (hardwareid clause) |
| B020-4 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_lift_list_report/2 |
| B020-5 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_lift_summary_report/2 (fleetid clause) |
| B020-6 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_operation_summary_report/2 |
| B020-7 | INFO | vx_thing_omega_controller.ex | Missing @doc on get_engine_utilization_report/2 |
| B020-8 | LOW | vx_thing_summary_controller.ex | Missing @moduledoc |
| B020-9 | INFO | vx_thing_summary_controller.ex | Missing @doc on index/2 |
| B020-10 | INFO | vx_thing_summary_controller.ex | Missing @doc on create/2 |
| B020-11 | INFO | vx_thing_summary_controller.ex | Missing @doc on show/2 |
| B020-12 | INFO | vx_thing_summary_controller.ex | Missing @doc on update/2 |
| B020-13 | INFO | vx_thing_summary_controller.ex | Missing @doc on delete/2 |
| B020-14 | INFO | vx_thing_summary_controller.ex | Missing @doc on do_fix_summary/2 (non-action public function) |
| B020-15 | LOW | vx_user_controller.ex | Missing @moduledoc |
| B020-16 | INFO | vx_user_controller.ex | Missing @doc on create/2 |
| B020-17 | INFO | vx_user_controller.ex | Missing @doc on lookup_customer_from_conn/1 |
| B020-18 | INFO | vx_user_controller.ex | Missing @doc on login/2 |
| B020-19 | INFO | vx_user_controller.ex | Missing @doc on change_password/2 |
| B020-20 | INFO | vx_user_controller.ex | Missing @doc on get_users/2 |
| B020-21 | INFO | vx_user_controller.ex | Missing @doc on get_user_with_email/2 |
| B020-22 | INFO | vx_user_controller.ex | Missing @doc on update_key_if_value/3 |
| B020-23 | INFO | vx_user_controller.ex | Missing @doc on update_user/2 |
| B020-24 | INFO | vx_user_controller.ex | Missing @doc on create_user/2 |
| B020-25 | INFO | vx_user_controller.ex | Missing @doc on delete_user/2 |
| B020-26 | INFO | vx_user_controller.ex | Missing @doc on get_user_fleets/2 |
| B020-27 | INFO | vx_user_controller.ex | Missing @doc on manage_user_fleets/2 |
| B020-28 | LOW | vx_user_function_controller.ex | Missing @moduledoc |
| B020-29 | LOW | vx_user_function_controller.ex | All action bodies commented out with no explanation |
