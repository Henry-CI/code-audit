# Pass 3: Documentation — B008
**Agent:** B008
**Files:** `lib/api_server/vx/vx.ex`
**Date:** 2026-02-27

---

## lib/api_server/vx/vx.ex

### Reading Evidence

**Module name:** `ApiServer.Vx`

**Types, errors, constants defined:** None (no `@type`, `@typep`, `@opaque`, `@callback`, or module-level constants are defined in this file).

---

**Every public function name and line number** (170 distinct clauses across ~140 logical functions):

| Line | Function / arity |
|------|-----------------|
| 27 | `update_key_if_value/3` (clause 1 — nil guard) |
| 28 | `update_key_if_value/3` (clause 2) |
| 33 | `list_vxusers/1` |
| 40 | `get_vx_user!/2` |
| 47 | `get_vx_user_offset/2` |
| 54 | `get_vx_user_fleets!/2` |
| 75 | `create_vx_user/2` |
| 93 | `update_vx_user/3` |
| 99 | `update_vx_user_password/3` |
| 117 | `delete_vx_user/2` |
| 130 | `change_vx_user/1` |
| 145 | `list_vxaccessfobs/0` |
| 163 | `get_vx_access_fob!/1` |
| 165 | `get_vx_access_fob_by_code!/1` |
| 177 | `get_vx_access_fobs_for_fleets!/1` |
| 189 | `get_vx_fleet_for_access_fob/1` |
| 198 | `get_num_vx_admin_fobs/0` |
| 199 | `get_vx_admin_fobs/0` |
| 215 | `delete_vx_access_fob/1` |
| 222 | `list_vxfleets/1` (customer) |
| 227 | `list_vxfleets/2` (user_id, customer) |
| 235 | `get_list_of_valid_fleets_for_user/2` |
| 243 | `get_list_of_valid_equipment_for_user/2` |
| 264 | `list_vxfleets_with_equipment/2` |
| 290 | `get_vx_fleet_by_name/2` |
| 296 | `get_vx_fleet/2` |
| 315 | `create_vx_fleet/2` |
| 333 | `update_vx_fleet/3` |
| 351 | `delete_vx_fleet/2` |
| 364 | `change_vx_fleet/1` |
| 378 | `update_fleet_assocs/3` |
| 392 | `get_equipment_in_fleet/2` |
| 400 | `get_hardwareids_in_fleet/2` |
| 408 | `get_fleets_for_thing/2` |
| 416 | `get_branch_for_thing/2` |
| 427 | `list_vxfleetassociations/0` |
| 449 | `get_vx_fleet_association!/1` |
| 464 | `delete_vx_fleet_association/1` |
| 470 | `list_vxthings/1` (customer) |
| 478 | `list_vxthings_full/1` |
| 492 | `list_vxthings_lite/1` |
| 498 | `list_vxthing/2` (customer, hardwareid) |
| 507 | `list_vxthing_full/2` |
| 520 | `list_vxthing_lite/2` |
| 528 | `list_vxthings/2` (user_id, customer) |
| 539 | `list_augmented_things/2` |
| 555 | `list_augmented_things_with_rentals/1` |
| 568 | `list_augmented_things_with_rentals_in_fleet/3` |
| 589 | `list_augmented_things_in_fleet/3` |
| 608 | `list_vxthings_in_fleet/2` |
| 623 | `list_vxthings_with_checklists/1` |
| 631 | `get_lift_event_counts_for_thing_by_day/5` |
| 651 | `get_detailed_lift_event_counts_for_thing_by_day/6` |
| 677 | `get_list_lift_event_counts_for_thing_by_day/6` |
| 699 | `get_detailed_lift_event_counts_for_fleet_by_day/5` |
| 726 | `get_omega_engine_utilization/5` |
| 749 | `get_omega_operation_summary/5` |
| 780 | `list_vxthings_for_map/2` (customer, user_id) |
| 795 | `list_vxthings_for_map/2` (customer, fleet_id) |
| 811 | `augment_thing_with_fleets/2` |
| 816 | `augment_thing_with_services/2` |
| 827 | `get_hour_meter_start_rental/2` |
| 871 | `augment_thing_with_rental_periods/2` |
| 940 | `augment_thing_with_usage/2` |
| 968 | `get_avg_weekly_hours/2` |
| 981 | `get_avg_weekly_hours/3` |
| 985 | `get_summary_total_usage/1` |
| 1006 | `get_usage_since_service/2` |
| 1030 | `fetch_actual_usage/2` (thing, customer) |
| 1042 | `generate_usage_select/2` |
| 1090 | `fetch_actual_usage/5` (hardwareid, 4, customer, from, to) |
| 1133 | `fetch_actual_usage/5` (hardwareid, 2, customer, from, to) |
| 1174 | `fetch_actual_usage/5` (hardwareid, 3, customer, from, to) |
| 1215 | `fetch_actual_usage/5` (hardwareid, category, customer, from, to) — fallback |
| 1230 | `fetch_actual_usage_thing/4` |
| 1235 | `get_movements/5` |
| 1281 | `get_vx_thing!/1` |
| 1283 | `get_vx_thing!/2` (id, customer) |
| 1290 | `get_thing_name_with_hardware_id!/2` |
| 1296 | `get_fleet_name_with_id/2` |
| 1303 | `get_thing_category_with_hardware_id!/2` |
| 1311 | `get_thing_id_with_hardware_id!/2` |
| 1319 | `lookup_thing_with_name_serial/3` |
| 1328 | `lookup_thing_with_name/2` |
| 1337 | `get_vx_thing_with_hardware_id!/1` |
| 1347 | `get_vx_thing_with_hardware_id!/2` (hardwareid, customer) |
| 1357 | `get_augmented_thing_with_hardware_id!/2` |
| 1363 | `get_equipment_by_name/2` |
| 1371 | `get_equipment_by_serial/2` |
| 1377 | `get_equipment_assignments_by_id/2` |
| 1395 | `create_vx_thing/2` |
| 1413 | `update_vx_thing/3` |
| 1431 | `delete_vx_thing/1` |
| 1444 | `change_vx_thing/1` |
| 1459 | `list_vxthingsummaries/0` |
| 1477 | `get_vx_thing_summary!/1` |
| 1478 | `get_summary_for_hardwareid/2` |
| 1484 | `update_or_insert_summary/3` |
| 1501 | `create_vx_thing_summary/1` |
| 1519 | `update_vx_thing_summary/2` |
| 1537 | `delete_vx_thing_summary/1` |
| 1550 | `change_vx_thing_summary/1` |
| 1555 | `default_checklist_questions/0` |
| 1586 | `get_checklists/1` |
| 1622 | `list_vxthingevents/0` |
| 1640 | `get_vx_thing_event!/1` |
| 1642 | `get_most_recent_thingevent/2` |
| 1651 | `get_most_recent_thingevent_with_date/3` |
| 1660 | `get_most_recent_thingevent_with_omega/2` |
| 1673 | `get_thingevents_for_hardwareid/2` |
| 1680 | `get_thingevents_for_hardwareid/4` (hardwareid, from, to, customer) |
| 1702 | `create_vx_thing_event/2` |
| 1720 | `update_vx_thing_event/2` |
| 1738 | `delete_vx_thing_event/1` |
| 1751 | `change_vx_thing_event/1` |
| 1755 | `generate_avg_weekly_select/2` |
| 1795 | `convert_category_to_regular_units/2` |
| 1824 | `get_first_event/2` |
| 1842 | `get_actual_avg_weekly_hours/3` (hardwareid, 4, customer) |
| 1879 | `get_actual_avg_weekly_hours/4` (hardwareid, 4, customer, _) |
| 1916 | `get_actual_avg_weekly_hours/3` (hardwareid, 2, customer) |
| 1952 | `get_actual_avg_weekly_hours/4` (hardwareid, 2, customer, 1) |
| 1988 | `get_actual_avg_weekly_hours/3` (hardwareid, 3, customer) |
| 2026 | `get_actual_avg_weekly_hours/3` (hardwareid, category, customer) — fallback |
| 2054 | `list_service_records/1` |
| 2100 | `get_daily_usage/6` |
| 2170 | `get_impact_count_by_hardwareid/2` |
| 2179 | `get_events/5` |
| 2192 | `process_events/0` |
| 2547 | `process_events_subprocess/1` |
| 2611 | `get_vx_abl_record!/1` |
| 2625 | `create_vx_abl_record/1` |
| 2631 | `create_abl_record/2` |
| 2637 | `create_equipment_record/2` |
| 2643 | `get_equipment_id/2` |
| 2650 | `create_equipment_assignment_record/2` |
| 2668 | `update_vx_abl_record/2` |
| 2686 | `delete_vx_abl_record/1` |
| 2699 | `change_vx_abl_record/1` |
| 2704 | `get_rhm_user/3` (email, password, customer) |
| 2712 | `check_password/3` |
| 2719 | `get_rhm_user/2` (email, customer) |
| 2730 | `list_all_rentals/1` |
| 2740 | `list_open_rentals/1` |
| 2753 | `get_rental/2` (id, customer) |
| 2764 | `get_active_rental/2` |
| 2776 | `get_all_rentals_for_thing/2` |
| 2786 | `get_rental/4` (thing_id, customer_id, start_date, customer) |
| 2798 | `delete_rental/2` |
| 2802 | `update_rental/3` |
| 2809 | `create_rental_contract/2` |
| 2817 | `create_rental_period/2` |
| 2825 | `get_rental_periods_for_contract/2` |
| 2831 | `create_rental/2` |
| 2871 | `list_customers/1` |
| 2889 | `get_vx_customer!/2` |
| 2891 | `get_customer/3` |
| 2916 | `create_vx_customer/2` |
| 2934 | `update_vx_customer/3` |
| 2952 | `delete_vx_customer/2` |
| 2965 | `change_vx_customer/2` |
| 2980 | `list_vxaatuserfunctions/0` |
| 2998 | `get_vx_user_function!/1` |
| 3012 | `create_vx_user_function/1` |
| 3030 | `update_vx_user_function/2` |
| 3048 | `delete_vx_user_function/1` |
| 3061 | `change_vx_user_function/1` |
| 3074 | `list_vxaau_rest/0` |
| 3092 | `get_vx_restriction!/1` |
| 3106 | `create_vx_restriction/1` |
| 3112 | `add_fleet_to_user/3` |
| 3124 | `get_restriction/3` |
| 3132 | `remove_fleet_from_user/3` |
| 3150 | `update_vx_restriction/2` |
| 3168 | `delete_vx_restriction/1` |
| 3181 | `change_vx_restriction/1` |
| 3189 | `delete_erp_import/2` |
| 3193 | `create_erp_import/2` |
| 3199 | `update_erp_import/3` |
| 3205 | `check_for_existing_erp_record/2` |
| 3223 | `get_geofence_by_id/2` |
| 3229 | `get_geofences/1` |
| 3234 | `get_geofences_as_map/1` |
| 3249 | `create_geofence/2` |
| 3255 | `update_geofence/3` |
| 3261 | `delete_geofence/2` |
| 3265 | `create_thingevent_record/2` |
| 3271 | `update_thingevent_record/3` |
| 3277 | `delete_thingevent_record/2` |
| 3281 | `create_thingeventomega_record/2` |
| 3287 | `create_thingomegatires_record/2` |
| 3293 | `create_rayven_message_log_record/2` |
| 3299 | `update_rayven_stream_status_record/2` |
| 3305 | `count_rayven_events_to_stream/3` |

**Private functions (not subject to @doc requirements):**
- `daily_usage_where/2` (line 2062) — `defp`

---

### Findings

#### B008-1 — @moduledoc is a placeholder with no substantive content
**Severity:** LOW
**File:** `lib/api_server/vx/vx.ex`, line 2

The module-level documentation at line 2 reads:

```elixir
@moduledoc """
The Vx context.
"""
```

This is the Phoenix context generator boilerplate. It provides no description of what the Vx context is responsible for, what domain it covers (fleet management, equipment telemetry, rental contracts, geofencing, user access control, etc.), or how callers should interact with it. For a 3,314-line module that is the core business logic layer of the application, one sentence of boilerplate offers no navigational value.

---

#### B008-2 — Large number of public functions lack @doc
**Severity:** LOW
**File:** `lib/api_server/vx/vx.ex`, various lines

The following public functions (approximately 95 of the ~170 public function clauses) have no `@doc` attached:

| Line | Function |
|------|----------|
| 27–28 | `update_key_if_value/3` |
| 33 | `list_vxusers/1` |
| 40 | `get_vx_user!/2` |
| 47 | `get_vx_user_offset/2` |
| 54 | `get_vx_user_fleets!/2` |
| 99 | `update_vx_user_password/3` |
| 165 | `get_vx_access_fob_by_code!/1` |
| 198 | `get_num_vx_admin_fobs/0` |
| 199 | `get_vx_admin_fobs/0` |
| 222 | `list_vxfleets/1` |
| 227 | `list_vxfleets/2` |
| 235 | `get_list_of_valid_fleets_for_user/2` |
| 243 | `get_list_of_valid_equipment_for_user/2` |
| 264 | `list_vxfleets_with_equipment/2` |
| 296 | `get_vx_fleet/2` |
| 392 | `get_equipment_in_fleet/2` |
| 400 | `get_hardwareids_in_fleet/2` |
| 408 | `get_fleets_for_thing/2` |
| 416 | `get_branch_for_thing/2` |
| 427 | `list_vxfleetassociations/0` |
| 470 | `list_vxthings/1` |
| 478 | `list_vxthings_full/1` |
| 492 | `list_vxthings_lite/1` |
| 498 | `list_vxthing/2` |
| 507 | `list_vxthing_full/2` |
| 520 | `list_vxthing_lite/2` |
| 528 | `list_vxthings/2` |
| 539 | `list_augmented_things/2` |
| 555 | `list_augmented_things_with_rentals/1` |
| 568 | `list_augmented_things_with_rentals_in_fleet/3` |
| 589 | `list_augmented_things_in_fleet/3` |
| 608 | `list_vxthings_in_fleet/2` |
| 623 | `list_vxthings_with_checklists/1` |
| 631 | `get_lift_event_counts_for_thing_by_day/5` |
| 651 | `get_detailed_lift_event_counts_for_thing_by_day/6` |
| 677 | `get_list_lift_event_counts_for_thing_by_day/6` |
| 699 | `get_detailed_lift_event_counts_for_fleet_by_day/5` |
| 726 | `get_omega_engine_utilization/5` |
| 749 | `get_omega_operation_summary/5` |
| 780 | `list_vxthings_for_map/2` (user_id variant) |
| 795 | `list_vxthings_for_map/2` (fleet_id variant) |
| 811 | `augment_thing_with_fleets/2` |
| 816 | `augment_thing_with_services/2` |
| 827 | `get_hour_meter_start_rental/2` |
| 871 | `augment_thing_with_rental_periods/2` |
| 940 | `augment_thing_with_usage/2` |
| 968 | `get_avg_weekly_hours/2` |
| 981 | `get_avg_weekly_hours/3` |
| 985 | `get_summary_total_usage/1` |
| 1006 | `get_usage_since_service/2` |
| 1030 | `fetch_actual_usage/2` |
| 1042 | `generate_usage_select/2` |
| 1090 | `fetch_actual_usage/5` (cat 4) |
| 1133 | `fetch_actual_usage/5` (cat 2) |
| 1174 | `fetch_actual_usage/5` (cat 3) |
| 1215 | `fetch_actual_usage/5` (fallback) |
| 1230 | `fetch_actual_usage_thing/4` |
| 1235 | `get_movements/5` |
| 1283 | `get_vx_thing!/2` (customer variant) |
| 1290 | `get_thing_name_with_hardware_id!/2` |
| 1296 | `get_fleet_name_with_id/2` |
| 1303 | `get_thing_category_with_hardware_id!/2` |
| 1311 | `get_thing_id_with_hardware_id!/2` |
| 1319 | `lookup_thing_with_name_serial/3` |
| 1328 | `lookup_thing_with_name/2` |
| 1337 | `get_vx_thing_with_hardware_id!/1` |
| 1347 | `get_vx_thing_with_hardware_id!/2` |
| 1357 | `get_augmented_thing_with_hardware_id!/2` |
| 1363 | `get_equipment_by_name/2` |
| 1371 | `get_equipment_by_serial/2` |
| 1377 | `get_equipment_assignments_by_id/2` |
| 1478 | `get_summary_for_hardwareid/2` |
| 1484 | `update_or_insert_summary/3` |
| 1555 | `default_checklist_questions/0` |
| 1586 | `get_checklists/1` |
| 1642 | `get_most_recent_thingevent/2` |
| 1651 | `get_most_recent_thingevent_with_date/3` |
| 1660 | `get_most_recent_thingevent_with_omega/2` |
| 1673 | `get_thingevents_for_hardwareid/2` |
| 1680 | `get_thingevents_for_hardwareid/4` |
| 1755 | `generate_avg_weekly_select/2` |
| 1795 | `convert_category_to_regular_units/2` |
| 1824 | `get_first_event/2` |
| 1842 | `get_actual_avg_weekly_hours/3` (cat 4) |
| 1879 | `get_actual_avg_weekly_hours/4` (cat 4, _) |
| 1916 | `get_actual_avg_weekly_hours/3` (cat 2) |
| 1952 | `get_actual_avg_weekly_hours/4` (cat 2, 1) |
| 1988 | `get_actual_avg_weekly_hours/3` (cat 3) |
| 2026 | `get_actual_avg_weekly_hours/3` (fallback) |
| 2100 | `get_daily_usage/6` |
| 2170 | `get_impact_count_by_hardwareid/2` |
| 2179 | `get_events/5` |
| 2192 | `process_events/0` |
| 2547 | `process_events_subprocess/1` |
| 2631 | `create_abl_record/2` |
| 2637 | `create_equipment_record/2` |
| 2643 | `get_equipment_id/2` |
| 2650 | `create_equipment_assignment_record/2` |
| 2704 | `get_rhm_user/3` |
| 2712 | `check_password/3` |
| 2719 | `get_rhm_user/2` |
| 2730 | `list_all_rentals/1` |
| 2740 | `list_open_rentals/1` |
| 2753 | `get_rental/2` |
| 2764 | `get_active_rental/2` |
| 2776 | `get_all_rentals_for_thing/2` |
| 2786 | `get_rental/4` |
| 2798 | `delete_rental/2` |
| 2802 | `update_rental/3` |
| 2809 | `create_rental_contract/2` |
| 2817 | `create_rental_period/2` |
| 2825 | `get_rental_periods_for_contract/2` |
| 2831 | `create_rental/2` |
| 2891 | `get_customer/3` |
| 3112 | `add_fleet_to_user/3` |
| 3124 | `get_restriction/3` |
| 3132 | `remove_fleet_from_user/3` |
| 3189 | `delete_erp_import/2` |
| 3193 | `create_erp_import/2` |
| 3199 | `update_erp_import/3` |
| 3205 | `check_for_existing_erp_record/2` |
| 3223 | `get_geofence_by_id/2` |
| 3229 | `get_geofences/1` |
| 3234 | `get_geofences_as_map/1` |
| 3249 | `create_geofence/2` |
| 3255 | `update_geofence/3` |
| 3261 | `delete_geofence/2` |
| 3265 | `create_thingevent_record/2` |
| 3271 | `update_thingevent_record/3` |
| 3277 | `delete_thingevent_record/2` |
| 3281 | `create_thingeventomega_record/2` |
| 3287 | `create_thingomegatires_record/2` |
| 3293 | `create_rayven_message_log_record/2` |
| 3299 | `update_rayven_stream_status_record/2` |
| 3305 | `count_rayven_events_to_stream/3` |

The absence of `@doc` is especially significant for non-obvious functions whose behaviour cannot be inferred from the name alone: `update_key_if_value/3`, `get_vx_admin_fobs/0`, `get_num_vx_admin_fobs/0` (returns a hardcoded `7`), `generate_usage_select/2`, `generate_avg_weekly_select/2`, `convert_category_to_regular_units/2`, `get_daily_usage/6`, `process_events/0`, `process_events_subprocess/1`, `check_for_existing_erp_record/2`, `get_geofences_as_map/1`, and `update_rayven_stream_status_record/2`. Additionally, no `@spec` type specifications are present anywhere in the file.

---

#### B008-3 — @doc at line 276 describes a different function than the one it precedes
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx.ex`, lines 276–294

The `@doc` block at line 276 reads:

```elixir
@doc """
Gets a single vx_fleet.

Raises `Ecto.NoResultsError` if the Vx fleet does not exist.

## Examples

    iex> get_vx_fleet!(123)
    %VXFleet{}

    iex> get_vx_fleet!(456)
    ** (Ecto.NoResultsError)

"""
def get_vx_fleet_by_name(fleetname, customer) do
```

The `@doc` was written for a `get_vx_fleet!/1` function (single ID lookup that raises), but it is attached to `get_vx_fleet_by_name/2`, which:
- accepts a fleet name string and a customer/tenant prefix, not a numeric ID;
- uses `Repo.all/2`, returning a list, not a single struct;
- never raises `Ecto.NoResultsError` (it returns an empty list on no match);
- belongs to a completely different function.

The immediately following `get_vx_fleet/2` (line 296) has no `@doc` at all. There is no `get_vx_fleet!/1` function anywhere in the module, so the described function does not exist. A reader consulting the docs for `get_vx_fleet_by_name/2` will receive incorrect information about argument types, return shape, and error behaviour.

---

#### B008-4 — @doc at line 369 describes list_vxfleetassociationss but precedes update_fleet_assocs
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx.ex`, lines 369–390

The `@doc` block at line 369 reads:

```elixir
@doc """
Returns the list of vxfleetassociationss.

## Examples

    iex> list_vxfleetassociationss()
    [%VXFleetAssociation{}, ...]

"""
def update_fleet_assocs(fleet_id, customer, updated_ids) do
```

The `@doc` was written for a `list_vxfleetassociationss/0` list function, but it is attached to `update_fleet_assocs/3`, which:
- performs a destructive operation (deletes all existing fleet associations for `fleet_id`, then bulk-inserts `updated_ids`);
- takes three arguments (fleet_id, customer, updated_ids), not zero;
- returns a list of `{group_id, thing_id}` tuples for the updated fleet, not a full list of all associations.

The actual `list_vxfleetassociations/0` function at line 427 has no `@doc`. A caller reading the documentation for `update_fleet_assocs/3` will be misled about the function's destructive write semantics.

---

#### B008-5 — @doc at line 2045 names list_vxablrecords but precedes list_service_records
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx.ex`, lines 2045–2060

The `@doc` block at line 2045 reads:

```elixir
@doc """
Returns the list of vxablrecords.

## Examples

    iex> list_vxablrecords()
    [%VXAblRecord{}, ...]

"""
def list_service_records(customer) do
```

The `@doc` was written for a hypothetical `list_vxablrecords/0` function, but it is attached to `list_service_records/1`. The implementation is not a general list of all `VXAblRecord` rows; it is a filtered, ordered, preloaded query that returns only records where `abllogtype == "SERVICEDATE"`. The `@doc` describes the wrong function name, the wrong arity (0 vs 1), omits the `customer` tenant parameter entirely, and makes no mention of the service-date filter. This is misleading to callers who need to understand the scope of returned records.

---

## Summary

| ID | Severity | Description |
|----|----------|-------------|
| B008-1 | LOW | `@moduledoc` is boilerplate placeholder with no substantive content |
| B008-2 | LOW | ~120 public function clauses across ~95 functions lack `@doc`; no `@spec` anywhere in the file |
| B008-3 | MEDIUM | `@doc` at line 276 describes non-existent `get_vx_fleet!/1`; is incorrectly attached to `get_vx_fleet_by_name/2` with wrong arity, return type, and error behaviour |
| B008-4 | MEDIUM | `@doc` at line 369 describes `list_vxfleetassociationss/0`; is incorrectly attached to `update_fleet_assocs/3`, which performs destructive write operations |
| B008-5 | MEDIUM | `@doc` at line 2045 describes `list_vxablrecords/0`; is incorrectly attached to `list_service_records/1`, omitting the tenant parameter and the service-date filter |
