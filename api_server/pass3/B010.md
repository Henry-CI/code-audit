# Pass 3: Documentation — B010
**Agent:** B010
**Files:**
- `lib/api_server/vx/vx_fleet_association.ex`
- `lib/api_server/vx/vx_rayven_message_log.ex`
- `lib/api_server/vx/vx_rayven_stream_status.ex`
- `lib/api_server/vx/vx_rental.ex`

**Date:** 2026-02-27

---

## vx_fleet_association.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXFleetAssociation`

**Public functions:** None (schema-only module; no explicitly defined public functions beyond those injected by `use Ecto.Schema`).

**Types / constants / schema:**
- Schema `"aaf_groups_things"` with primary key `aafid`
- Fields: `aafcustcode` (`:string`)
- Associations: `belongs_to :fleet` (`VXFleet`, FK `aafgroupid`), `belongs_to :thing` (`VXThing`, FK `aafthingid`)

### Findings

#### B010-1 — Missing @moduledoc in VXFleetAssociation
**Severity:** LOW
**File:** `lib/api_server/vx/vx_fleet_association.ex`, line 4

The module `ApiServer.Vx.VXFleetAssociation` has no `@moduledoc` attribute. There is no description of its purpose (join table between fleet groups and things), the underlying database table (`aaf_groups_things`), or the meaning of the foreign key fields (`aafgroupid`, `aafthingid`). Standard Elixir convention requires at minimum `@moduledoc false` for intentionally undocumented modules.

---

## vx_rayven_message_log.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXRayvenMessageLog`

**Public functions:**
| Function | Line |
|---|---|
| `changeset/2` | 16 |

**Types / constants / schema:**
- Schema `"rayven_message_log"` with primary key `message_id`
- Fields: `message_direction` (`:string`), `message_type` (`:string`), `hardware_id` (`:integer`), `event_id` (`:integer`), `response` (`:string`), `message` (`:string`), `created` (`:utc_datetime`)

### Findings

#### B010-2 — Missing @moduledoc in VXRayvenMessageLog
**Severity:** LOW
**File:** `lib/api_server/vx/vx_rayven_message_log.ex`, line 1

The module `ApiServer.Vx.VXRayvenMessageLog` has no `@moduledoc` attribute. There is no description of the purpose of the message log schema, the database table (`rayven_message_log`), the expected values for `message_direction` or `message_type`, or the relationship between `hardware_id` and `event_id`.

#### B010-3 — Missing @doc on changeset/2 in VXRayvenMessageLog
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rayven_message_log.ex`, line 16

The public function `changeset/2` has no `@doc` attribute. There is no description of accepted attributes, return value, or any validation logic applied. Note that the cast does not include the `created` field, which is notable behaviour worth documenting (it implies `created` is managed outside of the changeset, e.g. set by the database).

---

## vx_rayven_stream_status.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXRayvenStreamStatus`

**Public functions:**
| Function | Line |
|---|---|
| `changeset/2` | 17 |

**Types / constants / schema:**
- Schema `"rayven_stream_status"` with primary key `id`
- Fields: `thing_id` (`:integer`), `hardware_id` (`:integer`), `last_event` (`:integer`), `last_event_time` (`:utc_datetime`), `streamed_at` (`:utc_datetime`), `delay` (`:integer`), `num_remaining` (`:integer`), `batch` (`:integer`)

### Findings

#### B010-4 — Missing @moduledoc in VXRayvenStreamStatus
**Severity:** LOW
**File:** `lib/api_server/vx/vx_rayven_stream_status.ex`, line 1

The module `ApiServer.Vx.VXRayvenStreamStatus` has no `@moduledoc` attribute. There is no description of what "stream status" represents in the Rayven integration context, the semantics of fields such as `delay`, `num_remaining`, and `batch`, or how `thing_id` and `hardware_id` relate to each other.

#### B010-5 — Missing @doc on changeset/2 in VXRayvenStreamStatus
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rayven_stream_status.ex`, line 17

The public function `changeset/2` has no `@doc` attribute. There is no description of the accepted attributes, return type, or any validation or constraint logic. The `cast/3` call permits all eight schema fields, which is not validated further.

---

## vx_rental.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXRental`

**Public functions:**
| Function | Line |
|---|---|
| `get_all_anniversaries_between_dates/4` | 24 |
| `get_current_rental_period_start/2` | 112 |
| `calculate_period_end_date/3` | 119 |
| `has_anniversary_on_day?/3` | 146 |
| `changeset/2` | 158 |
| `generate_previous_period_anniversay/3` | 246 |

**Private functions:**
| Function | Line |
|---|---|
| `get_all_subsequent_anniversaries/5` | 77 |
| `generate_next_period_anniversay/3` | 176 |
| `calculate_period_start_date/3` | 468 |

**Types / constants / schema:**
- Schema `"abh_rentals"` with primary key `abhid`
- Fields: `abhcustcode`, `abhclient`, `abhstartdate` (`:date`), `abhenddate` (`:date`), `abhtransdate` (`:utc_datetime`), `abhnotes`, `abhrental_freq`, `abhallowed_hours` (`:integer`), `abhreport_freq`, `abhcustomerid` (`:integer`), `period_calculation`
- Associations: `has_one :customer` (`VXCustomer`), `belongs_to :thing` (`VXThing`, FK `abhthingid`)
- Recognised `abhrental_freq` values (by implementation): `"28DAY"`, `"MONTHLY"`, `"OTHER"`, `"WEEKLY"`, `"DAILY"`, `"OUT OF CONTRACT"` (default: weekly behaviour)
- Recognised `period_calculation` values (by implementation): `"CALENDAR"`, `"CONTRACT"`

### Findings

#### B010-6 — Missing @moduledoc in VXRental
**Severity:** LOW
**File:** `lib/api_server/vx/vx_rental.ex`, line 1

The module `ApiServer.Vx.VXRental` has no `@moduledoc` attribute. This is the most functionally complex schema module in the batch; it contains non-trivial period-calculation logic across six rental frequency types and two period-calculation modes (`CALENDAR` / `CONTRACT`). The absence of any module-level documentation makes it significantly harder to understand the domain model, the valid enum values for `abhrental_freq` and `period_calculation`, and the overall intent of the anniversary/period calculations.

#### B010-7 — Missing @doc on get_all_anniversaries_between_dates/4
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 24

The public function `get_all_anniversaries_between_dates/4` has no `@doc` attribute. The function signature `(rental, to_date, from_date, user_timezone)` accepts date strings for `to_date` and `from_date` (parsed via `Date.from_iso8601!`) and a timezone string. The return value is a list of anniversary datetimes. The argument order is unusual (`to_date` before `from_date`) and the distinct `CALENDAR` vs non-`CALENDAR` code paths are undocumented. Without `@doc`, callers have no guidance on the expected string format, timezone format, or return type.

#### B010-8 — Missing @doc on get_current_rental_period_start/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 112

The public function `get_current_rental_period_start/2` has no `@doc` attribute. It returns the start of the current rental period for "now" in the given `user_timezone`. There is no documentation of the return type (a Timex datetime) or how it interacts with the rental's frequency and period calculation mode.

#### B010-9 — Missing @doc on calculate_period_end_date/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 119

The public function `calculate_period_end_date/3` has no `@doc` attribute. It takes a `period_start_datetime`, a `rental` struct, and a `user_timezone`, and returns a shifted datetime representing the end of the period. The `user_timezone` parameter is accepted but not used within the function body, which is a documentation gap as well as a latent code issue. Valid `abhrental_freq` values and default fallback behaviour are undocumented.

#### B010-10 — Missing @doc on has_anniversary_on_day?/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 146

The public function `has_anniversary_on_day?/3` has no `@doc` attribute. It returns a boolean indicating whether a rental period starts on a given `day_to_test`. The type expected for `day_to_test` (a Timex datetime) and the return type (`true` | `false`) are undocumented.

#### B010-11 — Missing @doc on changeset/2 in VXRental
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 158

The public function `changeset/2` has no `@doc` attribute. The cast permits `:abhid` explicitly (the primary key), which is atypical and may allow callers to supply or overwrite the primary key. This behaviour is undocumented and potentially unintentional.

#### B010-12 — Missing @doc on generate_previous_period_anniversay/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 246

The public function `generate_previous_period_anniversay/3` (note: typo "anniversay" in the function name) has no `@doc` attribute. This is the most complex public function in the module, spanning approximately 220 lines and containing intricate branching across frequency types, calendar modes, and contract boundary conditions. The absence of `@doc` leaves callers without any description of arguments, return value, nil-return semantics, or the interaction between `period_calculation` and `abhrental_freq`.

#### B010-13 — Inaccurate/misleading parameter order in get_all_anniversaries_between_dates/4
**Severity:** MEDIUM
**File:** `lib/api_server/vx/vx_rental.ex`, line 24

The function signature is `get_all_anniversaries_between_dates(rental, to_date, from_date, user_timezone)`, placing `to_date` before `from_date`. This is the reverse of the conventional `(from, to)` ordering used elsewhere in Elixir/Timex APIs. While there is no `@doc` to be factually inaccurate against, the naming creates a documentation/API contract risk: callers reading only the function signature are likely to supply the arguments in the wrong order. The internal usage (`NaiveDateTime.new(Date.from_iso8601!(to_date), ~T[23:59:59.001])` and `NaiveDateTime.new(Date.from_iso8601!(from_date), ~T[00:00:01.001])`) confirms `to_date` is used as the upper bound and `from_date` as the lower bound. The inverted naming is a documentation defect.

#### B010-14 — Typo in public function name generate_previous_period_anniversay/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_rental.ex`, line 246

The public function is named `generate_previous_period_anniversay` (missing the letter "r" — should be `anniversary`). Because this is a public function it forms part of the module's public API. The name is part of the documentation contract. Renaming it would be a breaking change, but it should at minimum be flagged so that a deprecation path can be planned and the intent documented via `@doc`.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B010-1 | LOW | vx_fleet_association.ex:4 | Missing @moduledoc in VXFleetAssociation |
| B010-2 | LOW | vx_rayven_message_log.ex:1 | Missing @moduledoc in VXRayvenMessageLog |
| B010-3 | INFO | vx_rayven_message_log.ex:16 | Missing @doc on changeset/2 in VXRayvenMessageLog |
| B010-4 | LOW | vx_rayven_stream_status.ex:1 | Missing @moduledoc in VXRayvenStreamStatus |
| B010-5 | INFO | vx_rayven_stream_status.ex:17 | Missing @doc on changeset/2 in VXRayvenStreamStatus |
| B010-6 | LOW | vx_rental.ex:1 | Missing @moduledoc in VXRental |
| B010-7 | INFO | vx_rental.ex:24 | Missing @doc on get_all_anniversaries_between_dates/4 |
| B010-8 | INFO | vx_rental.ex:112 | Missing @doc on get_current_rental_period_start/2 |
| B010-9 | INFO | vx_rental.ex:119 | Missing @doc on calculate_period_end_date/3 |
| B010-10 | INFO | vx_rental.ex:146 | Missing @doc on has_anniversary_on_day?/3 |
| B010-11 | INFO | vx_rental.ex:158 | Missing @doc on changeset/2 in VXRental |
| B010-12 | INFO | vx_rental.ex:246 | Missing @doc on generate_previous_period_anniversay/3 |
| B010-13 | MEDIUM | vx_rental.ex:24 | Inverted parameter order (to_date before from_date) is misleading API contract |
| B010-14 | INFO | vx_rental.ex:246 | Typo in public function name: "anniversay" should be "anniversary" |
