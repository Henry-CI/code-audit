# Pass 3: Documentation — B018
**Agent:** B018
**Files:**
- `lib/api_server_web/controllers/vx_fleet_association_controller.ex`
- `lib/api_server_web/controllers/vx_fleet_controller.ex`
- `lib/api_server_web/controllers/vx_rental_controller.ex`
- `lib/api_server_web/controllers/vx_restriction_controller.ex`

**Date:** 2026-02-27

---

## vx_fleet_association_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXFleetAssociationController`

**Public functions:**

| Function | Line |
|---|---|
| `index/2` | 9 |
| `show/2` | 14 |
| `delete/2` | 19 |

**Types / errors / constants defined:** None.

**`@moduledoc`:** Absent.

**`@doc` present:** None on any function.

### Findings

#### B018-1 — Missing @moduledoc in VXFleetAssociationController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 1

The module `ApiServerWeb.VXFleetAssociationController` has no `@moduledoc` attribute. There is no description of what resource the controller manages, which routes it services, or any authentication requirements.

---

#### B018-2 — Missing @doc on index/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 9

`index/2` has no `@doc`. The function lists all VX fleet associations by delegating to `Vx.list_vxfleetassociations/0` and renders `index.json`. No documentation describes the expected response structure, authentication requirements, or scope of records returned.

---

#### B018-3 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 14

`show/2` has no `@doc`. The function fetches a single fleet association by `id` using `Vx.get_vx_fleet_association!/1` (which raises on not-found) and renders `show.json`. No documentation describes the path parameter, the raise-on-missing behaviour, or the response structure.

---

#### B018-4 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_association_controller.ex`, line 19

`delete/2` has no `@doc`. The function fetches a fleet association by `id` and deletes it, returning HTTP 204 No Content on success. No documentation describes the path parameter, the no-content response, or fallback error handling via `action_fallback`.

---

## vx_fleet_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXFleetController`

**Public functions:**

| Function | Line | Notes |
|---|---|---|
| `create/2` | 9 | Phoenix-style CRUD action; expects `%{"vx_fleet" => ...}` |
| `get_fleets/2` (clause 1) | 19 | Matches `%{"admin" => "1"}`; returns all fleets for customer |
| `get_fleets/2` (clause 2) | 27 | Catch-all; returns fleets scoped to current user |
| `get_fleets_with_equipment/2` | 35 | Returns fleets with nested equipment list |
| `create_fleet/2` | 68 | Custom fleet creation with duplicate-name guard |
| `delete_fleet/2` | 91 | Deletes fleet by customer + id |
| `get_equipment_in_fleet/2` | 105 | Lists equipment belonging to a fleet |
| `manage_fleet/2` | 110 | Replaces fleet equipment associations |
| `update_fleet/2` | 119 | Updates fleet metadata |

**Types / errors / constants defined:** None.

**`@moduledoc`:** Absent.

**`@doc` present:** None on any function.

### Findings

#### B018-5 — Missing @moduledoc in VXFleetController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 1

The module `ApiServerWeb.VXFleetController` has no `@moduledoc`. The controller is substantially more complex than a standard Phoenix CRUD controller (nine public functions, multi-clause dispatch, inline aggregation logic) and would especially benefit from a module-level description covering the resource, routing conventions, and authentication model used (`ApiServer.Guardian.Plug`).

---

#### B018-6 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 9

`create/2` has no `@doc`. It expects the body parameter key `"vx_fleet"`, creates the fleet via `Vx.create_vx_fleet/1`, and responds with HTTP 201 Created plus a `Location` header. No documentation describes the expected request shape, the Location header, or error paths handled by `action_fallback`.

---

#### B018-7 — Missing @doc on get_fleets/2 (admin clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 19

The first clause of `get_fleets/2` (matching `%{"admin" => "1"}`) has no `@doc`. It returns all fleets for the current user's customer code regardless of user scope. No documentation describes the admin query parameter that gates this behaviour, or that the customer context is drawn from JWT claims rather than the request path.

---

#### B018-8 — Missing @doc on get_fleets/2 (user clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 27

The second (catch-all) clause of `get_fleets/2` has no `@doc`. It scopes results to both `user_id` and `customer` extracted from JWT claims. Because this is a multi-clause function with meaningfully different behaviour per clause, each clause warrants a `@doc` (or at minimum the first clause should document all clauses). The absence makes the admin-vs-user dispatching invisible to API consumers.

---

#### B018-9 — Missing @doc on get_fleets_with_equipment/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 35

`get_fleets_with_equipment/2` has no `@doc`. This function performs a non-trivial in-memory aggregation (building a nested `equipment` array per fleet from flat query rows) before rendering. No documentation describes the response structure, the aggregation logic, or the source fields (`aaeid`, `aaecustcode`, `aaedesc`, etc.).

---

#### B018-10 — Missing @doc on create_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 68

`create_fleet/2` has no `@doc`. The function includes a duplicate-name guard that returns HTTP 500 with a human-readable error message when a fleet with the same name already exists. It also automatically associates the newly created fleet with the requesting user. None of this behaviour is documented; notably, the duplicate-name response uses 500 (Internal Server Error) where 409 (Conflict) would be conventional, and without documentation this misuse is hidden.

---

#### B018-11 — Missing @doc on delete_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 91

`delete_fleet/2` has no `@doc`. The function requires both `"customer"` and `"id"` path parameters and returns HTTP 200 with an empty JSON object on success (not the more conventional 204). No documentation describes the response code choice or what happens when the fleet does not exist (HTTP 500).

---

#### B018-12 — Missing @doc on get_equipment_in_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 105

`get_equipment_in_fleet/2` has no `@doc`. The function takes `"customer"` and `"id"` parameters and delegates entirely to `Vx.get_equipment_in_fleet/2`. No documentation describes the shape of the `results` payload rendered by `rhm_fleet_equipment.json`.

---

#### B018-13 — Missing @doc on manage_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 110

`manage_fleet/2` has no `@doc`. The function performs a full replacement of fleet equipment associations by accepting a list of thing IDs (`"equip_in_fleet"`), converting them to association maps, and calling `Vx.update_fleet_assocs/3`. The destructive replace-all semantics are not documented anywhere. No documentation describes the expected shape of `equip_in_fleet`, the `String.to_integer/1` conversion applied to each element, or the HTTP 200 `{}` response.

---

#### B018-14 — Missing @doc on update_fleet/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_fleet_controller.ex`, line 119

`update_fleet/2` has no `@doc`. The function reads the fleet ID from inside `fleet_params["id"]` (not from a path segment), converts the params via `VXFleet.convert_json_to_changeset/1`, and returns HTTP 500 when no fleet is found. No documentation describes these parameter conventions or the non-standard error response code.

---

## vx_rental_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXRentalController`

**Public functions:**

| Function | Line | Notes |
|---|---|---|
| `get_rentals/2` (clause 1) | 9 | Matches `%{"customer" => _, "closed" => "1"}`; returns all rentals |
| `get_rentals/2` (clause 2) | 30 | Catch-all; returns only open rentals |
| `get_midpac_style_rental_report/2` | 51 | Rental anniversary report for a given date |
| `get_rental_anniversaries/2` | 110 | Anniversary history for a specific piece of equipment |
| `create_rental/2` | 158 | Creates a rental record |
| `update_rental/2` | 174 | Updates an existing rental |
| `delete_rental/2` | 191 | Deletes a rental by ID |
| `rhm_active_rental/2` | 206 | Returns the active rental for a hardware ID |

**Types / errors / constants defined:** None.

**`@moduledoc`:** Absent.

**`@doc` present:** None on any function.

### Findings

#### B018-15 — Missing @moduledoc in VXRentalController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 1

The module `ApiServerWeb.VXRentalController` has no `@moduledoc`. The controller manages a rental resource with significant domain complexity (period calculations, timezone awareness, overage computation, and anniversary reporting). A module-level docstring describing the resource, the customer-scoping model, and the timezone handling approach is absent.

---

#### B018-16 — Missing @doc on get_rentals/2 (closed clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 9

The first clause of `get_rentals/2` (matching `"closed" => "1"`) has no `@doc`. It calls `Vx.list_all_rentals/1` (all rentals, including closed ones) and enriches each with `period_start`, `period_usage`, and `overage`. No documentation describes the `"closed"` query flag, the enrichment fields, the timezone source (user preference from DB), or the response template `rhm_rentals.json`.

---

#### B018-17 — Missing @doc on get_rentals/2 (open clause)
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 30

The second (catch-all) clause of `get_rentals/2` has no `@doc`. It calls `Vx.list_open_rentals/1` instead of `list_all_rentals/1`, returning only currently active rentals. The same enrichment logic applies. The distinction between the two clauses is undocumented.

---

#### B018-18 — Missing @doc on get_midpac_style_rental_report/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 51

`get_midpac_style_rental_report/2` has no `@doc`. This is the most complex function in the file: it accepts an `"on"` date parameter, finds all rentals with a billing anniversary on that date, and for each computes period usage, last-week usage, month-to-date usage, and service hours. The "midpac" name is domain-specific and opaque without documentation. The output fields (`vehicle_name`, `operating_hours_last_week`, `hours_to_service`, etc.) are nowhere described.

---

#### B018-19 — Missing @doc on get_rental_anniversaries/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 110

`get_rental_anniversaries/2` has no `@doc`. The function accepts `"hardwareid"`, `"from"`, and `"to"` date parameters and returns a flat list of anniversary events across all rentals for that piece of equipment, each including usage and overage for the period. No documentation describes the date format expected, the response payload shape, or how multiple overlapping rentals for the same equipment are handled.

---

#### B018-20 — Missing @doc on create_rental/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 158

`create_rental/2` has no `@doc`. It delegates changeset conversion to `ApiServerWeb.VXRentalView.convert_json_to_changeset/1` (notably a View module, not the schema). On error, the response body contains a malformed JSON literal (a trailing `\" }` is present outside the JSON string at line 169). Neither the expected request body nor the error response format is documented.

---

#### B018-21 — Missing @doc on update_rental/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 174

`update_rental/2` has no `@doc`. The rental ID is read from `rental_params["id"]` rather than a dedicated path parameter. On success, the rental is re-fetched from the database before rendering (rather than using the update result). These non-obvious behaviours are undocumented.

---

#### B018-22 — Missing @doc on delete_rental/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 191

`delete_rental/2` has no `@doc`. The function takes `"customer"` and `"id"` path parameters, returns HTTP 200 `{}` on success (not 204), and HTTP 500 for both "not found" and "deletion failed" cases with different error messages. None of this is documented.

---

#### B018-23 — Missing @doc on rhm_active_rental/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_rental_controller.ex`, line 206

`rhm_active_rental/2` has no `@doc`. The function looks up an active rental by `"hardwareid"`, computes `period_start`, `period_usage`, and `overage`, but then discards these computed values — they are bound to local variables but the render call at line 229 passes the unmodified `active_rental` struct (the `Map.put_new/3` pipe result is not reassigned). This latent bug is invisible without documentation describing the intended output. No documentation exists to alert reviewers that the enrichment fields are silently dropped.

---

## vx_restriction_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXRestrictionController`

**Public functions:** None. The module body contains only `use ApiServerWeb, :controller`, two `alias` declarations, and `action_fallback ApiServerWeb.FallbackController`. No action functions are defined.

**Types / errors / constants defined:** None.

**`@moduledoc`:** Absent.

### Findings

#### B018-24 — Missing @moduledoc in VXRestrictionController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_restriction_controller.ex`, line 1

The module `ApiServerWeb.VXRestrictionController` is an empty controller shell with no `@moduledoc`. Because the module defines no action functions, the absence of a module-level docstring means there is no indication of intent: whether this controller is a planned stub, a deprecated placeholder, or simply an unused scaffold. A `@moduledoc` noting the intended purpose (or explicitly marking the module as a stub pending implementation) is absent.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B018-1 | LOW | vx_fleet_association_controller.ex | Missing @moduledoc |
| B018-2 | INFO | vx_fleet_association_controller.ex | Missing @doc on index/2 |
| B018-3 | INFO | vx_fleet_association_controller.ex | Missing @doc on show/2 |
| B018-4 | INFO | vx_fleet_association_controller.ex | Missing @doc on delete/2 |
| B018-5 | LOW | vx_fleet_controller.ex | Missing @moduledoc |
| B018-6 | INFO | vx_fleet_controller.ex | Missing @doc on create/2 |
| B018-7 | INFO | vx_fleet_controller.ex | Missing @doc on get_fleets/2 (admin clause) |
| B018-8 | INFO | vx_fleet_controller.ex | Missing @doc on get_fleets/2 (user clause) |
| B018-9 | INFO | vx_fleet_controller.ex | Missing @doc on get_fleets_with_equipment/2 |
| B018-10 | INFO | vx_fleet_controller.ex | Missing @doc on create_fleet/2 |
| B018-11 | INFO | vx_fleet_controller.ex | Missing @doc on delete_fleet/2 |
| B018-12 | INFO | vx_fleet_controller.ex | Missing @doc on get_equipment_in_fleet/2 |
| B018-13 | INFO | vx_fleet_controller.ex | Missing @doc on manage_fleet/2 |
| B018-14 | INFO | vx_fleet_controller.ex | Missing @doc on update_fleet/2 |
| B018-15 | LOW | vx_rental_controller.ex | Missing @moduledoc |
| B018-16 | INFO | vx_rental_controller.ex | Missing @doc on get_rentals/2 (closed clause) |
| B018-17 | INFO | vx_rental_controller.ex | Missing @doc on get_rentals/2 (open clause) |
| B018-18 | INFO | vx_rental_controller.ex | Missing @doc on get_midpac_style_rental_report/2 |
| B018-19 | INFO | vx_rental_controller.ex | Missing @doc on get_rental_anniversaries/2 |
| B018-20 | INFO | vx_rental_controller.ex | Missing @doc on create_rental/2 |
| B018-21 | INFO | vx_rental_controller.ex | Missing @doc on update_rental/2 |
| B018-22 | INFO | vx_rental_controller.ex | Missing @doc on delete_rental/2 |
| B018-23 | INFO | vx_rental_controller.ex | Missing @doc on rhm_active_rental/2 |
| B018-24 | LOW | vx_restriction_controller.ex | Missing @moduledoc on empty controller stub |
