# Pass 3: Documentation — B012
**Agent:** B012
**Files:**
- `lib/api_server/vx/vx_thing_event_omega_tires.ex`
- `lib/api_server/vx/vx_thing_info.ex`
- `lib/api_server/vx/vx_thing_summary.ex`
- `lib/api_server/vx/vx_user.ex`

**Date:** 2026-02-27

---

## vx_thing_event_omega_tires.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXThingEventOmegaTires`

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 58 |

**Schema:** `thingomegatires` — 48 integer fields covering 6 tyre slots (indices 0–5), each with fields: `pressurewarning`, `pressureleakage`, `temperaturehigh`, `receivetimeout`, `[REDACTED-AWS-SMTP-PASSWORD]`, `[REDACTED-AWS-SMTP-PASSWORD]`, `tirepressure`, `temperature`. Belongs to `ApiServer.Vx.VXThingEvent` via `:id`.

**Types/constants defined:** None.

### Findings

#### B012-1 — Missing @moduledoc in VXThingEventOmegaTires
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`, line 1

The module `ApiServer.Vx.VXThingEventOmegaTires` has no `@moduledoc` attribute. There is no description of the module's purpose (Ecto schema for Omega TPMS tyre pressure/temperature event data associated with a thing event), its schema table (`thingomegatires`), or the indexing convention used for the 6 tyre slots (indices 0–5).

#### B012-2 — Missing @doc on changeset/2 in VXThingEventOmegaTires
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_event_omega_tires.ex`, line 58

The public function `changeset/2` has no `@doc` attribute. The function casts all 48 tyre-sensor fields plus `:id` and validates that `:id` is required, but this behaviour is not documented.

---

## vx_thing_info.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXThingInfo`

**Public functions:**

| Function | Line |
|---|---|
| `getWithHardwareId/2` | 24 |
| `service_performed/3` | 31 |
| `[REDACTED-AWS-SMTP-PASSWORD]` | 47 |
| `make_info_record/2` | 57 |
| `update_existing_record/3` | 74 |

**Schema:** `thing_info` — fields: `averageweeklyusage` (float), `pmnotificationid` (integer), `pmnotificationdate` (date), `[REDACTED-AWS-SMTP-PASSWORD]` (integer). Belongs to `VXThing` via `hardwareid`/`aadhardwareid`.

**Types/constants defined:** None.

**Note:** No `changeset/2` function is defined in this module; changesets are built directly via `Ecto.Changeset.change/2`.

### Findings

#### B012-3 — Missing @moduledoc in VXThingInfo
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 3

The module `ApiServer.Vx.VXThingInfo` has no `@moduledoc` attribute. The module manages preventive-maintenance (PM) notification state and average weekly usage statistics for a hardware device, but none of this context is documented.

#### B012-4 — Missing @doc on getWithHardwareId/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 24

No `@doc` is present. The function fetches the single `VXThingInfo` record for the given `hardwareid` within the tenant schema identified by `customer`. The tenant-scoped query behaviour (Ecto `prefix`) is not documented.

#### B012-5 — Missing @doc on service_performed/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 31

No `@doc` is present. The function clears the PM notification fields (`pmnotificationid`, `pmnotificationdate`) and resets `[REDACTED-AWS-SMTP-PASSWORD]` to `0` when a service event is recorded on or after the existing notification date. The guard condition (`info != nil && info.pmnotificationdate <= new_service_date`) and the side-effect of only acting when the date condition is satisfied are undocumented.

#### B012-6 — Missing @doc on validateForHardwareId/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 47

No `@doc` is present. The function ensures a `VXThingInfo` record exists for the given hardware ID: it creates one if absent (via `make_info_record/2`) or refreshes the calculated fields on the existing record (via `update_existing_record/3`).

#### B012-7 — Missing @doc on make_info_record/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 57

No `@doc` is present. The function inserts a new `VXThingInfo` record using a hardcoded baseline notification date of `2019-01-13` and PM notification ID `12`. The use of a hardcoded magic date and ID is not explained anywhere in the code or documentation.

#### B012-8 — Missing @doc on update_existing_record/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_info.ex`, line 74

No `@doc` is present. The function recalculates `averageweeklyusage` and, conditionally on whether an active PM notification date exists (> `1970-01-01`), recalculates `[REDACTED-AWS-SMTP-PASSWORD]`. The branching logic and the sentinel date `1970-01-01` are not documented.

---

## vx_thing_summary.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXThingSummary`

**Public functions:**

| Function | Line |
|---|---|
| `changeset/2` | 49 |
| `make_or_update_summary/3` | 56 |
| `validate_for_hardwareid/2` | 138 |
| `is_valid?/2` | 156 |

**Schema:** `abm_summary` (primary key `:abmid`) — 43 fields covering GPS position, ignition state, engine seconds, four hourmeter channels (calc and raw), Omega hourmeter, OTH-CAN hourmeter, odometer, driver IDs, event type/code, and RHMP pre-start checklist fields. Belongs to `ApiServer.Vx.VXThing` via `abmhardwareid`/`aadhardwareid`.

**Types/constants defined:** None.

**Notes:**
- `changeset/2` is annotated `@doc false` (line 48), indicating intentional suppression.
- `validate_for_hardwareid/2` (line 138) contains an unused variable binding `timestamp = Timex.now()` (line 149) that is never referenced.

### Findings

#### B012-9 — Missing @moduledoc in VXThingSummary
**Severity:** LOW
**File:** `lib/api_server/vx/vx_thing_summary.ex`, line 1

The module `ApiServer.Vx.VXThingSummary` has no `@moduledoc` attribute. The module's role (maintaining a denormalised summary record of the most recent telemetry event for each hardware device, used to avoid querying the full event history on every read) is not described anywhere.

#### B012-10 — Missing @doc on make_or_update_summary/3
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_summary.ex`, line 56

No `@doc` is present. The function fetches the most recent thing event (preferring one with Omega data), maps its fields onto a summary struct, conditionally merges Omega hourmeter fields, and persists the result. The optional third parameter `existingSummary` defaults to an empty `VXThingSummary` struct for insert scenarios. None of this behaviour is documented.

#### B012-11 — Missing @doc on validate_for_hardwareid/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_summary.ex`, line 138

No `@doc` is present. The function ensures the summary record for the given hardware ID is current: it creates one if absent, and updates it if `is_valid?/2` returns false. The unused variable `timestamp` (line 149) assigned inside the update branch but never consumed is not called out anywhere.

#### B012-12 — Missing @doc on is_valid?/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_thing_summary.ex`, line 156

No `@doc` is present. The function compares five fields between the existing summary record and the most recent thing event (`totalengineseconds`, `input1totalseconds`, `gmtdatetime`, `latitude`, `longitude`) to determine staleness. The choice of these five fields as the validity criteria is not explained.

---

## vx_user.ex

### Reading Evidence

**Module:** `ApiServer.Vx.VXUser`

**Public functions:**

| Function | Line |
|---|---|
| `convert_json_to_changeset/1` | 57 |
| `password_changeset/2` | 73 |
| `changeset/2` | 78 |

**Schema:** `aac_user` (primary key `:aacid`) — fields covering user identity, credentials (`aacpassword`, `aacpasswordhash`, `[REDACTED-AWS-SMTP-PASSWORD]`), locale/timezone preferences, licence data (two licence slots), user type, proxy flag, and UI preferences. Associations: `has_one :accessfob`, `has_one :function`, `has_many :assigned_fleets`, `has_many :abl_records`.

**Types/constants defined:** None.

**Notes:**
- `convert_json_to_changeset/1` (line 57) maps `:aacuom` from `user_json["units"]` twice (lines 63 and 67); the duplicate mapping silently overwrites itself with the same value.
- `convert_json_to_changeset/1` (line 70) writes to key `:user_level`, which is not a field defined in the schema; this key will be silently dropped or cause a downstream error.
- `password_changeset/2` casts `:aacpassword` (plaintext) but does not hash it; it is unclear from context whether hashing is applied elsewhere in the call chain.

### Findings

#### B012-13 — Missing @moduledoc in VXUser
**Severity:** LOW
**File:** `lib/api_server/vx/vx_user.ex`, line 4

The module `ApiServer.Vx.VXUser` has no `@moduledoc` attribute. The module defines the Ecto schema and changesets for application users, including sensitive credential fields, but provides no module-level description.

#### B012-14 — Missing @doc on convert_json_to_changeset/1
**Severity:** INFO
**File:** `lib/api_server/vx/vx_user.ex`, line 57

No `@doc` is present. The function translates an incoming JSON map (e.g., from an API request body) into a parameter map suitable for use with `changeset/2`. The expected JSON key names (`"first_name"`, `"last_name"`, `"email"`, etc.), the duplicate `:aacuom` mapping, and the behaviour of the non-schema `:user_level` key are entirely undocumented.

#### B012-15 — Missing @doc on password_changeset/2
**Severity:** INFO
**File:** `lib/api_server/vx/vx_user.ex`, line 73

No `@doc` is present. The function casts only `:aacpassword` without any validation, hashing, or confirmation logic. The absence of documentation means it is unclear whether this is intended as a raw-password setter (with hashing handled by a callback or the caller) or whether the lack of hashing is an oversight.

#### B012-16 — Missing @doc on changeset/2 in VXUser
**Severity:** INFO
**File:** `lib/api_server/vx/vx_user.ex`, line 78

No `@doc` is present. The function casts a defined set of user fields, associates the `:function` (user permission level) via `put_assoc/4`, validates `:aacemail` presence and format, and enforces a uniqueness constraint on `:aacuser`. The meaning of `attrs.user_level` and its mapping to `aatfunction_id` is not documented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B012-1 | LOW | vx_thing_event_omega_tires.ex | Missing @moduledoc in VXThingEventOmegaTires |
| B012-2 | INFO | vx_thing_event_omega_tires.ex, line 58 | Missing @doc on changeset/2 |
| B012-3 | LOW | vx_thing_info.ex, line 3 | Missing @moduledoc in VXThingInfo |
| B012-4 | INFO | vx_thing_info.ex, line 24 | Missing @doc on getWithHardwareId/2 |
| B012-5 | INFO | vx_thing_info.ex, line 31 | Missing @doc on service_performed/3 |
| B012-6 | INFO | vx_thing_info.ex, line 47 | Missing @doc on validateForHardwareId/2 |
| B012-7 | INFO | vx_thing_info.ex, line 57 | Missing @doc on make_info_record/2 |
| B012-8 | INFO | vx_thing_info.ex, line 74 | Missing @doc on update_existing_record/3 |
| B012-9 | LOW | vx_thing_summary.ex, line 1 | Missing @moduledoc in VXThingSummary |
| B012-10 | INFO | vx_thing_summary.ex, line 56 | Missing @doc on make_or_update_summary/3 |
| B012-11 | INFO | vx_thing_summary.ex, line 138 | Missing @doc on validate_for_hardwareid/2 |
| B012-12 | INFO | vx_thing_summary.ex, line 156 | Missing @doc on is_valid?/2 |
| B012-13 | LOW | vx_user.ex, line 4 | Missing @moduledoc in VXUser |
| B012-14 | INFO | vx_user.ex, line 57 | Missing @doc on convert_json_to_changeset/1 |
| B012-15 | INFO | vx_user.ex, line 73 | Missing @doc on password_changeset/2 |
| B012-16 | INFO | vx_user.ex, line 78 | Missing @doc on changeset/2 in VXUser |
