# Pass 3: Documentation — B019
**Agent:** B019
**Files:**
- `lib/api_server_web/controllers/vx_thing_controller.ex`
- `lib/api_server_web/controllers/vx_thing_event_controller.ex`
- `lib/api_server_web/controllers/vx_thing_info_controller.ex`

**Date:** 2026-02-27

---

## vx_thing_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingController`

**Public functions (by first definition line):**

| Function | Line(s) |
|---|---|
| `get_checklists/2` | 10 |
| `get_movements/2` | 16 |
| `get_hardware_with_checklists/2` | 21 |
| `get_pm_data/2` | 30 |
| `get_all_pm_data/2` | 36 |
| `get_fleet_map/2` (4 clauses) | 44, 51, 56, 64 |
| `create/2` | 74 |
| `show/2` | 83 |
| `delete/2` | 88 |
| `rhm_get_thing/2` | 95 |
| `rhm_get_thing_usage/2` | 100 |
| `rhm_get_things_usage/2` | 111 |
| `rhm_get_thing_events/2` | 144 |
| `rhm_get_things/2` (2 clauses) | 153, 161 |
| `rhm_get_things_with_usage/2` (2 clauses) | 169, 176 |
| `rhm_get_things_names/2` | 223 |
| `rhm_get_thing_records/2` | 231 |
| `create_thing/2` | 240 |
| `update_thing/2` | 254 |
| `monday_hour_meters/2` | 377 |
| `get_next_monday_between_dates/4` | 438 |
| `combined_engine_usage/2` | 453 |
| `pape_export/2` (2 clauses) | 603, 617 |
| `sielift_export/2` (3 clauses) | 724, 735, 746 |
| `update_thing_cached_fields/2` | 850 |
| `get_timezones/2` | 859 |

**Private functions:** `things_with_usage/2` (line 184), `get_data_for_pape_export/1` (line 285), `ifnilzero/1` (line 622–623), `get_data_for_sielift_export/3` (line 625)

**Types/errors/constants defined:** None (no `@type`, `@typep`, `@spec`, or module-level constants).

---

### Findings

#### B019-1 — Missing @moduledoc in VXThingController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 1

The module `ApiServerWeb.VXThingController` has no `@moduledoc` attribute. With approximately 29 public functions spanning checklists, fleet maps, PM data, RHM reporting, CSV exports, and cache maintenance, the absence of a module-level docstring makes it impossible for readers to understand the module's purpose or the domain it covers without reading the entire file.

---

#### B019-2 — Missing @doc on get_checklists/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 10

`get_checklists/2` has no `@doc`. The function retrieves all checklists for a given hardware ID scoped to a customer. The `customer` parameter is accepted in the pattern match but is not used in the function body, which is a behaviour worth noting in documentation.

---

#### B019-3 — Missing @doc on get_movements/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 16

`get_movements/2` has no `@doc`. The function fetches movement records for a hardware ID on a specific day in a given timezone. Both `from` and `to` are set to the same `day` value, which is a subtle constraint that would benefit from explicit documentation.

---

#### B019-4 — Missing @doc on get_hardware_with_checklists/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 21

`get_hardware_with_checklists/2` has no `@doc`.

---

#### B019-5 — Missing @doc on get_pm_data/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 30

`get_pm_data/2` has no `@doc`.

---

#### B019-6 — Missing @doc on get_all_pm_data/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 36

`get_all_pm_data/2` has no `@doc`.

---

#### B019-7 — Missing @doc on get_fleet_map/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 44, 51, 56, 64

`get_fleet_map/2` has four clauses with no `@doc` on any of them. The dispatch logic between the four clauses (fleet by name, fleet by ID with customer, fleet by ID without customer, and catch-all using JWT claims) is non-obvious and would benefit from documentation explaining which clause handles which scenario. The first clause (line 44) accepts a `fleetname` parameter but passes `user_id` — not `fleetname` — to `Vx.list_vxthings_for_map/2`, making `fleetname` unused.

---

#### B019-8 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 74

`create/2` has no `@doc`.

---

#### B019-9 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 83

`show/2` has no `@doc`.

---

#### B019-10 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 88

`delete/2` has no `@doc`.

---

#### B019-11 — Missing @doc on rhm_get_thing/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 95

`rhm_get_thing/2` has no `@doc`. The function returns an augmented thing including usage data, but the structure of the returned tuple `{vx_thing, usage_data}` is not documented.

---

#### B019-12 — Missing @doc on rhm_get_thing_usage/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 100

`rhm_get_thing_usage/2` has no `@doc`. The function extracts the customer from JWT claims rather than from path/query params, and adds an `X-hardware-id` response header. Both behaviours are undocumented.

---

#### B019-13 — Missing @doc on rhm_get_things_usage/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 111

`rhm_get_things_usage/2` has no `@doc`. The function returns a CSV file attachment rather than JSON. This response format difference from sibling endpoints is a significant API behaviour that should be documented.

---

#### B019-14 — Missing @doc on rhm_get_thing_events/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 144

`rhm_get_thing_events/2` has no `@doc`.

---

#### B019-15 — Missing @doc on rhm_get_things/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 153, 161

`rhm_get_things/2` has two clauses and no `@doc` on either. In the `fleet_id` clause (line 153), the `customer` parameter from the pattern match is immediately shadowed by extracting `customer` from JWT claims. This silent override of the route parameter should be documented.

---

#### B019-16 — Missing @doc on rhm_get_things_with_usage/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 169, 176

`rhm_get_things_with_usage/2` has two clauses and no `@doc`. The function augments the thing list with `this_week`, `last_week`, and `this_month` usage fields using the user's timezone derived from the database.

---

#### B019-17 — Missing @doc on rhm_get_things_names/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 223

`rhm_get_things_names/2` has no `@doc`. Note that the `customer` parameter from the pattern match is immediately shadowed by extracting customer from JWT claims — the route parameter is unused.

---

#### B019-18 — Missing @doc on rhm_get_thing_records/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 231

`rhm_get_thing_records/2` has no `@doc`.

---

#### B019-19 — Missing @doc on create_thing/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 240

`create_thing/2` has no `@doc`. This function also triggers a service record generation side-effect path via `update_thing/2` logic; however the primary concern here is the absence of any documentation.

---

#### B019-20 — Missing @doc on update_thing/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 254

`update_thing/2` has no `@doc`. The function has a significant side-effect: if the last service date changes, it calls `VXAblRecordController.generate_service_record/3` and `VXThingInfo.service_performed/3`. This cross-controller mutation is undocumented.

---

#### B019-21 — Missing @doc on monday_hour_meters/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 377

`monday_hour_meters/2` has no `@doc`. This function iterates over multiple customers (comma-separated string), computes all Mondays between two dates, and returns JSON of hour-meter readings. The multi-customer behaviour and the date-range logic are non-trivial and lack any explanation.

---

#### B019-22 — Missing @doc on get_next_monday_between_dates/4
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 438

`get_next_monday_between_dates/4` has no `@doc`. This public recursive helper function computes a list of Monday dates between two bounds. Its parameter signature `(current_monday, from, to, current_mondays)` and recursive accumulator pattern are not explained.

---

#### B019-23 — Missing @doc on combined_engine_usage/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 453

`combined_engine_usage/2` has no `@doc`. The function accepts a comma-separated `customers` parameter, aggregates daily usage across all customers and vehicles, and returns JSON. The large volume of commented-out code throughout the function body adds confusion that documentation could help resolve.

---

#### B019-24 — Missing @doc on pape_export/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 603, 617

`pape_export/2` has two clauses and no `@doc`. The CSV clause (line 603) and the JSON/default clause (line 617) serve different response formats; this dispatch is not documented.

---

#### B019-25 — Missing @doc on sielift_export/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, lines 724, 735, 746

`sielift_export/2` has three clauses and no `@doc`. The clauses handle: JSON export filtered by `fleet_id`, JSON export for all fleets, and CSV export (the default). The CSV clause includes a local `headings` list that is missing "Hardware ID" compared to the commented-out `sielift_export_local/1` function — this discrepancy is invisible without documentation.

---

#### B019-26 — Missing @doc on update_thing_cached_fields/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 850

`update_thing_cached_fields/2` has no `@doc`. This function is called publicly from `[REDACTED-AWS-SMTP-PASSWORD]` (line 71 of that file), making it part of the cross-module API. It triggers `do_fix_summary/2` and `do_fix_info/2` as side effects. The cross-module dependency and purpose are entirely undocumented.

---

#### B019-27 — Missing @doc on get_timezones/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_controller.ex`, line 859

`get_timezones/2` has no `@doc`.

---

## vx_thing_event_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingEventController`

**Public functions:**

| Function | Line |
|---|---|
| `index/2` | 9 |
| `create/2` | 14 |
| `show/2` | 24 |
| `update/2` | 29 |
| `delete/2` | 38 |
| `write_partial_record/3` | 46 |
| `add_calculated_fields/2` | 74 |
| `get_current_omega_status/2` | 111 |

**Private functions:** `calculated_hourmeter/2` (line 103)

**Types/errors/constants defined:** None.

---

### Findings

#### B019-28 — Missing @moduledoc in VXThingEventController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 1

The module `ApiServerWeb.VXThingEventController` has no `@moduledoc`. The module handles both standard CRUD operations on thing events and provides public utility functions (`write_partial_record/3`, `add_calculated_fields/2`) consumed by other modules.

---

#### B019-29 — Missing @doc on index/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 9

`index/2` has no `@doc`.

---

#### B019-30 — Missing @doc on create/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 14

`create/2` has no `@doc`.

---

#### B019-31 — Missing @doc on show/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 24

`show/2` has no `@doc`.

---

#### B019-32 — Missing @doc on update/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 29

`update/2` has no `@doc`.

---

#### B019-33 — Missing @doc on delete/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 38

`delete/2` has no `@doc`.

---

#### B019-34 — Missing @doc on write_partial_record/3
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 46

`write_partial_record/3` has no `@doc`. This is a non-HTTP public function called from other parts of the system (not via a router). It fetches the most recent event for a device, merges a partial update map into it, persists the result as a new record, and then triggers cache refresh via `VXThingController.update_thing_cached_fields/2`. The semantics of the `update` map parameter, the merge-then-insert pattern (rather than update-in-place), and the cross-controller side-effect call are all undocumented.

---

#### B019-35 — Missing @doc on add_calculated_fields/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 74

`add_calculated_fields/2` has no `@doc`. This function computes calculated hour-meter fields (`calcengineseconds`, `[REDACTED-AWS-SMTP-PASSWORD]`, etc.) by applying offsets stored on the `VXThing` record to raw sensor totals. It is publicly accessible and appears designed to be called from outside the module, but there is no documentation describing the expected shape of `record_to_add`, what fields are added, or the offset semantics.

---

#### B019-36 — Missing @doc on get_current_omega_status/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_event_controller.ex`, line 111

`get_current_omega_status/2` has no `@doc`. The "omega" qualifier in the function name is opaque without documentation explaining what distinguishes an omega event from a regular thing event.

---

## vx_thing_info_controller.ex

### Reading Evidence

**Module:** `ApiServerWeb.VXThingInfoController`

**Public functions:**

| Function | Line |
|---|---|
| `fix_infos/2` | 9 |
| `get_info/2` | 17 |
| `do_fix_info/2` | 24 |

**Private functions:** None.

**Types/errors/constants defined:** None.

---

### Findings

#### B019-37 — Missing @moduledoc in VXThingInfoController
**Severity:** LOW
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`, line 1

The module `ApiServerWeb.VXThingInfoController` has no `@moduledoc`. The module manages validation/repair of `VXThingInfo` cached records and exposes `do_fix_info/2` as part of the cross-module API used by `VXThingController` (line 855 of that file).

---

#### B019-38 — Missing @doc on fix_infos/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`, line 9

`fix_infos/2` has no `@doc`. The function iterates over all things for a customer and calls `do_fix_info/2` on each. The endpoint semantics (is this idempotent? is it safe to run in production? what does "fix" entail?) are undocumented.

---

#### B019-39 — Missing @doc on get_info/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`, line 17

`get_info/2` has no `@doc`. Additionally, the function calls `VXThingInfo.validateForHardwareId/2` but discards the result (the return value `info` is unused), and always responds with an empty JSON object `{}` regardless of the validation outcome. This silent discard of the validation result is a behaviour that documentation should explain, or which may indicate a bug.

---

#### B019-40 — Missing @doc on do_fix_info/2
**Severity:** INFO
**File:** `lib/api_server_web/controllers/vx_thing_info_controller.ex`, line 24

`do_fix_info/2` has no `@doc`. This function is part of the public cross-module API: it is called directly by `ApiServerWeb.VXThingController.update_thing_cached_fields/2` (line 855). The name `do_fix_info` suggests an implementation detail (Elixir convention places `do_` prefix on private helpers), but it is `def` not `defp`. The intended callers, preconditions, and what "fixing" the info entails are entirely undocumented.

---

## Summary

| ID | Severity | File | Description |
|---|---|---|---|
| B019-1 | LOW | vx_thing_controller.ex:1 | Missing @moduledoc in VXThingController |
| B019-2 | INFO | vx_thing_controller.ex:10 | Missing @doc on get_checklists/2 |
| B019-3 | INFO | vx_thing_controller.ex:16 | Missing @doc on get_movements/2 |
| B019-4 | INFO | vx_thing_controller.ex:21 | Missing @doc on get_hardware_with_checklists/2 |
| B019-5 | INFO | vx_thing_controller.ex:30 | Missing @doc on get_pm_data/2 |
| B019-6 | INFO | vx_thing_controller.ex:36 | Missing @doc on get_all_pm_data/2 |
| B019-7 | INFO | vx_thing_controller.ex:44 | Missing @doc on get_fleet_map/2 (4 clauses) |
| B019-8 | INFO | vx_thing_controller.ex:74 | Missing @doc on create/2 |
| B019-9 | INFO | vx_thing_controller.ex:83 | Missing @doc on show/2 |
| B019-10 | INFO | vx_thing_controller.ex:88 | Missing @doc on delete/2 |
| B019-11 | INFO | vx_thing_controller.ex:95 | Missing @doc on rhm_get_thing/2 |
| B019-12 | INFO | vx_thing_controller.ex:100 | Missing @doc on rhm_get_thing_usage/2 |
| B019-13 | INFO | vx_thing_controller.ex:111 | Missing @doc on rhm_get_things_usage/2 (returns CSV, undocumented) |
| B019-14 | INFO | vx_thing_controller.ex:144 | Missing @doc on rhm_get_thing_events/2 |
| B019-15 | INFO | vx_thing_controller.ex:153 | Missing @doc on rhm_get_things/2 (2 clauses) |
| B019-16 | INFO | vx_thing_controller.ex:169 | Missing @doc on rhm_get_things_with_usage/2 (2 clauses) |
| B019-17 | INFO | vx_thing_controller.ex:223 | Missing @doc on rhm_get_things_names/2 |
| B019-18 | INFO | vx_thing_controller.ex:231 | Missing @doc on rhm_get_thing_records/2 |
| B019-19 | INFO | vx_thing_controller.ex:240 | Missing @doc on create_thing/2 |
| B019-20 | INFO | vx_thing_controller.ex:254 | Missing @doc on update_thing/2 (undocumented service-record side-effect) |
| B019-21 | INFO | vx_thing_controller.ex:377 | Missing @doc on monday_hour_meters/2 |
| B019-22 | INFO | vx_thing_controller.ex:438 | Missing @doc on get_next_monday_between_dates/4 |
| B019-23 | INFO | vx_thing_controller.ex:453 | Missing @doc on combined_engine_usage/2 |
| B019-24 | INFO | vx_thing_controller.ex:603 | Missing @doc on pape_export/2 (2 clauses) |
| B019-25 | INFO | vx_thing_controller.ex:724 | Missing @doc on sielift_export/2 (3 clauses) |
| B019-26 | INFO | vx_thing_controller.ex:850 | Missing @doc on update_thing_cached_fields/2 (cross-module public API) |
| B019-27 | INFO | vx_thing_controller.ex:859 | Missing @doc on get_timezones/2 |
| B019-28 | LOW | vx_thing_event_controller.ex:1 | Missing @moduledoc in VXThingEventController |
| B019-29 | INFO | vx_thing_event_controller.ex:9 | Missing @doc on index/2 |
| B019-30 | INFO | vx_thing_event_controller.ex:14 | Missing @doc on create/2 |
| B019-31 | INFO | vx_thing_event_controller.ex:24 | Missing @doc on show/2 |
| B019-32 | INFO | vx_thing_event_controller.ex:29 | Missing @doc on update/2 |
| B019-33 | INFO | vx_thing_event_controller.ex:38 | Missing @doc on delete/2 |
| B019-34 | INFO | vx_thing_event_controller.ex:46 | Missing @doc on write_partial_record/3 (cross-module public API) |
| B019-35 | INFO | vx_thing_event_controller.ex:74 | Missing @doc on add_calculated_fields/2 |
| B019-36 | INFO | vx_thing_event_controller.ex:111 | Missing @doc on get_current_omega_status/2 |
| B019-37 | LOW | vx_thing_info_controller.ex:1 | Missing @moduledoc in VXThingInfoController |
| B019-38 | INFO | vx_thing_info_controller.ex:9 | Missing @doc on fix_infos/2 |
| B019-39 | INFO | vx_thing_info_controller.ex:17 | Missing @doc on get_info/2 (validation result silently discarded) |
| B019-40 | INFO | vx_thing_info_controller.ex:24 | Missing @doc on do_fix_info/2 (cross-module public API, misleading naming) |
