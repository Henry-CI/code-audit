# A12 — AdminDealerActionForm.java

**Path:** `src/main/java/com/actionform/AdminDealerActionForm.java`
**Auditor:** A12
**Date:** 2026-02-26
**Branch:** master

---

## Reading Evidence

### Fully Qualified Class Name

`com.actionform.AdminDealerActionForm`

### Inheritance / Interfaces

| Relationship | Type | Line |
|---|---|---|
| extends | `org.apache.struts.action.ActionForm` | 11 |

### Class-Level Annotations

| Annotation | Line |
|---|---|
| `@Getter` (Lombok) | 8 |
| `@Setter` (Lombok) | 9 |
| `@NoArgsConstructor` (Lombok) | 10 |

### Fields

| Modifier | Type | Name | Initial Value | Line |
|---|---|---|---|---|
| private | `String` | `companyId` | `null` | 12 |

### Declared Methods

None declared in source. All accessors are Lombok-generated at compile time:
- `public String getCompanyId()` — generated by `@Getter`
- `public void setCompanyId(String companyId)` — generated by `@Setter`
- No-args constructor — generated by `@NoArgsConstructor`

No `validate()` method is declared or overridden.

### Struts Action Mapping (`struts-config.xml`)

```xml
<form-bean name="adminDealerActionForm" type="com.actionform.AdminDealerActionForm"/>

<action
    path="/dealerconvert"
    name="adminDealerActionForm"
    scope="session"
    validate="true"
    type="com.action.AdminDealerAction"
    input="adminDealerDefinition">
    <forward name="success" path="adminDealerDefinition"/>
    <forward name="failure" path="adminDealerDefinition"/>
</action>
```

Key mapping attributes:
- `scope="session"` — the form bean is bound to the **HTTP session**, not the request
- `validate="true"` — Struts will call `validate()` before dispatching; however no `validate()` is overridden in the form class and no `validation.xml` entry exists for this form (see below)
- `input="adminDealerDefinition"` — destination if validation returns errors

### `validation.xml` Coverage

The `validation.xml` file defines rules for three forms only:
- `loginActionForm`
- `adminRegisterActionForm`
- `AdminDriverEditForm`

**There is no `<form name="adminDealerActionForm">` entry.** `companyId` receives no declarative validation rules.

### Consuming Action — `AdminDealerAction.execute()` (evidence for context)

```java
AdminDealerActionForm adminDealerForm = (AdminDealerActionForm) actionForm;

if (StringUtils.isNotBlank(adminDealerForm.getCompanyId())) {
    CompanyDAO.getInstance().convertCompanyToDealer(adminDealerForm.getCompanyId());
}
```

- `companyId` is passed directly as a `String` argument to `convertCompanyToDealer()` without any parsing, numeric validation, or authorisation check.
- The super-admin guard in `prepareDealerRequest()` checks `session.getAttribute("isSuperAdmin").equals(false)` — it **returns early** (skipping page setup) when the session attribute is `false`, but does **not prevent** the `convertCompanyToDealer()` call that precedes it in `execute()`.

---

## Findings

### FINDING-1 — No `validate()` Override: Form Performs No Server-Side Validation
**Severity: High**

`AdminDealerActionForm` does not override `ActionForm.validate()`. The default Struts 1.x implementation returns an empty `ActionErrors` collection, which is equivalent to "no errors". Combined with the absence of a `validation.xml` entry, `validate="true"` in the action mapping is a no-op: any value (including null, empty string, non-numeric strings, or SQL-injectable content) is accepted for `companyId` and forwarded directly to the action.

### FINDING-2 — No `validation.xml` Entry for `adminDealerActionForm`
**Severity: High**

The `validation.xml` file contains entries for `loginActionForm`, `adminRegisterActionForm`, and `AdminDriverEditForm`. There is no entry for `adminDealerActionForm`. The `companyId` field is entirely unvalidated at the declarative layer.

### FINDING-3 — `companyId` is a Client-Supplied Identity — IDOR Risk
**Severity: High**

`companyId` is the sole input field and acts as a direct object reference. The action `AdminDealerAction.execute()` calls `CompanyDAO.getInstance().convertCompanyToDealer(adminDealerForm.getCompanyId())` using this value without any check that the authenticated user is authorised to promote that specific company to dealer status. An authenticated super-admin who is allowed to reach this endpoint could supply an arbitrary `companyId` to convert any company in the system to dealer status. More critically, if the session-scope super-admin guard is bypassed (see FINDING-5), any authenticated user could do so.

### FINDING-4 — `companyId` String Field Has No Length Constraint
**Severity: Medium**

The `companyId` field is declared as `String` with no `maxlength` annotation, no `validation.xml` `maxlength` rule, and no server-side length check before the value is passed to `convertCompanyToDealer()`. There is no upper bound enforced by the form or action layer.

### FINDING-5 — Authorisation Guard Does Not Protect the Conversion Operation
**Severity: High**

In `AdminDealerAction.execute()`, the super-admin check occurs inside `prepareDealerRequest()` which is called *after* `convertCompanyToDealer()`:

```java
// companyId is used here — no role check yet
if (StringUtils.isNotBlank(adminDealerForm.getCompanyId())) {
    CompanyDAO.getInstance().convertCompanyToDealer(adminDealerForm.getCompanyId());
}
// role check only happens here, for page-data preparation
AdminDealerAction.prepareDealerRequest(request, session);
```

`prepareDealerRequest()` returns early when `isSuperAdmin` is `false`, but this only prevents the request attributes (company lists) from being populated. The `convertCompanyToDealer()` call has already executed. Any authenticated user who can submit a POST to `/dealerconvert.do` can elevate a company to dealer status regardless of their role. The form's `scope="session"` exacerbates this: the form bean persists in the session and a previously populated `companyId` may be re-used across requests.

### FINDING-6 — `companyId` Not Validated as Numeric Before DAO Use
**Severity: Medium**

The `companyId` field name implies a numeric database identifier. It is declared as `String` and forwarded directly to `convertCompanyToDealer(String companyId)` without any attempt to parse or verify it is a valid integer. If the DAO layer builds a SQL query using this value (potential string interpolation — requires DAO-layer audit), a non-numeric value or one containing SQL metacharacters could result in a SQL injection or query error.

### FINDING-7 — Session-Scoped Form Bean Carries State Across Requests
**Severity: Medium**

The action mapping sets `scope="session"`. This means the `adminDealerActionForm` bean (and its `companyId` field) persists in the HTTP session between requests. If a previous form submission populated `companyId` and a subsequent request omits the parameter, the old value will be silently reused. Session-scoped ActionForms are rarely appropriate for write operations and can lead to unintended repeated execution with stale data.

---

## Checklist Coverage

| # | Checklist Item | Applies | Result |
|---|---|---|---|
| 1 | Secrets / hardcoded credentials in source | No | N/A — form bean only |
| 2 | Auth/authorisation: admin-only functionality protected by role check | Yes | **FAIL** — `convertCompanyToDealer` executes before any role check (FINDING-5) |
| 2 | IDOR: client-supplied ID verified against authenticated user's organisation | Yes | **FAIL** — `companyId` accepted from request with no ownership or scope check (FINDING-3) |
| 3 | Input validation: `validate()` overridden and validates all fields | Yes | **FAIL** — `validate()` not overridden; no-op (FINDING-1) |
| 3 | Input validation: `validation.xml` coverage for this form | Yes | **FAIL** — no `<form name="adminDealerActionForm">` entry (FINDING-2) |
| 3 | Input validation: numeric fields validated before use | Yes | **FAIL** — `companyId` not validated as numeric (FINDING-6) |
| 3 | Input validation: string fields length-constrained | Yes | **FAIL** — no `maxlength` rule anywhere (FINDING-4) |
| 4 | Session / CSRF: session-scoped form bean risk | Yes | **FAIL** — `scope="session"` on a write operation; stale `companyId` reuse risk (FINDING-7) |
| 5 | Data exposure: error responses, logging | No | Not assessed in this form class |
| 6 | Dependencies | No | Not assessed at form level |
| 7 | Build / CI | No | Not assessed at form level |
