# Security Audit — Pass 1 (Security Review)
**Agent:** B31
**Repo:** forkliftiqws
**Branch:** master
**Date:** 2026-02-27
**Auditor pass:** Pass 1 — Security Review

---

## Section A: Reading Evidence

---

### File 1: `src/main/java/com/journaldev/spring/jdbc/util/RuntimeConf.java`

**Fully qualified class name:** `com.journaldev.spring.jdbc.util.RuntimeConf`

**Class-level annotations:** None

**Interfaces implemented / classes extended:** None

**Fields:**

| Access     | Type   | Name     | Value (literal)    |
|------------|--------|----------|--------------------|
| public static | String | database | `"jdbc/PreStartDB"` |

**Public methods:** None

**Notes:** This is a minimal configuration holder. It contains a single public static String field. It is distinct from `RuntimeConfig` in the controller package, which is the primary configuration class.

---

### File 2: `src/main/java/com/journaldev/spring/jdbc/util/SMTPAuthenticator.java`

**Fully qualified class name:** `com.journaldev.spring.jdbc.util.SMTPAuthenticator`

**Class-level annotations:** None

**Interfaces implemented / classes extended:** `extends javax.mail.Authenticator`

**Fields:** None declared as class fields (credentials are local variables inside the method body)

**Public methods:**

| Return type              | Method name                 | Parameters | Line |
|--------------------------|-----------------------------|------------|------|
| `PasswordAuthentication` | `getPasswordAuthentication` | (none)     | 7    |

**Method annotations:** None

**Key observation:** The method `getPasswordAuthentication()` defines two local String variables at lines 9–10:
- `username = "AKIA**REDACTED**"` — string literal
- `password = "****REDACTED****"` — string literal

The `AKIA` prefix in the username is the standard prefix for AWS IAM Access Key IDs, indicating these are AWS SES credentials (not a generic SMTP username/password pair).

---

### File 3: `src/main/java/com/journaldev/spring/jdbc/util/SendEmail.java`

**Fully qualified class name:** `com.journaldev.spring.jdbc.util.SendEmail`

**Class-level annotations:** None

**Interfaces implemented / classes extended:** None

**Fields:** None

**Imports of note:**
- `com.journaldev.spring.jdbc.controller.RuntimeConfig` (used for `RuntimeConfig.mailFrom`)
- `javax.mail.*`, `javax.mail.internet.*`, `javax.naming.*`

**Public methods:**

| Return type | Method name | Parameters                               | Line |
|-------------|-------------|------------------------------------------|------|
| `void` (static) | `sendMail` | `String subject, String msg, String mailTo` | 14   |

**Method annotations:** None

**Internal behaviour summary (lines 14–57):**
- Looks up a `javax.mail.Session` via JNDI (`mail/Session`) — lines 18–20.
- Creates a `MimeMessage` using that session.
- Sets the From address from `RuntimeConfig.mailFrom` — line 26.
- Sets recipients via `InternetAddress.parse(mailTo, false)` — line 31. The `false` parameter disables strict RFC 2822 parsing.
- Sets the subject directly from the `subject` parameter without sanitisation — line 37.
- Sets the body content directly from the `msg` parameter without sanitisation — line 38.
- Exception handling uses `System.out.println` (line 33) and `e.printStackTrace()` / `mex.printStackTrace()` / `t.printStackTrace()` (lines 48, 51, 53).

---

### Supporting context: `src/main/java/com/journaldev/spring/jdbc/controller/RuntimeConfig.java`

This file was read to understand fields referenced by `SendEmail` and the broader configuration posture. Key findings reported under Section 1 below.

**Fully qualified class name:** `com.journaldev.spring.jdbc.controller.RuntimeConfig`

**Fields (all `public static String`):**

| Name                | Value (literal)                                                    |
|---------------------|--------------------------------------------------------------------|
| host                | `"localhost"`                                                      |
| port                | `"25"`                                                             |
| sfport              | `"25"`                                                             |
| sfclass             | `"javax.net.ssl.SSLSocketFactory"`                                 |
| mailFrom            | `"info@forkliftiq360.com"`                                         |
| emailContent        | `""`                                                               |
| GCMSERVER           | `"https://gcm-http.googleapis.com/gcm/send"`                       |
| GCMKEY              | `"key=AIzaSyDDuQUYLcXkutyIxRToLAeBPHBQNLfayzs"`                  |
| production_database | `"jdbc/PreStartDB"`                                                |
| LOCATION            | `"https://api.clickatell.com"`                                     |
| USERNAME            | `"ciclickatell"`                                                   |
| PASSWORD            | `"OVLOaICXccaNUS"`                                                 |
| SMSFROM             | `"13234862361"`                                                    |
| API_ID              | `"3629505"`                                                        |
| MSGID_SUCCESS       | `"1"`                                                              |
| MSGID_CODEERRORR    | `"2"`                                                              |
| MSGID_CODEE_DUPLICATE_VEHICLE | `"3"`                                                  |
| ERRORMSG_CODEERRORR | `"Code throws exceptions"`                                         |
| MSGID_LOGICERRORR   | `"3"`                                                              |
| ERRORMSG_LOGICERRORR| `"Result already exists."`                                         |
| APIURL              | `"http://ec2-52-5-205-104.compute-1.amazonaws.com/api/export/pdf/"` |
| file_type           | `".pdf"`                                                           |
| PDF_FOLDER          | `"temp/"`                                                          |

---

## Section B: Findings

---

**B31-1** — CRITICAL
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/util/SMTPAuthenticator.java:9-10`
**Description:** AWS IAM Access Key ID and Secret Access Key are hardcoded as string literals in the `getPasswordAuthentication()` method body. The `AKIA` prefix confirms this is a live AWS access key (used for SES SMTP authentication). These credentials have been committed to the repository since the initial commit (`624cfcf`) and are present across the full git history. Any party with read access to this repository — past or present — has had access to these credentials. The secret access key value (`****REDACTED****`) appears syntactically valid for an AWS SES SMTP password (which is derived from the IAM secret access key). Because git history is permanent, even if the values are replaced in source, they remain recoverable from `git log` unless the history is rewritten and all clones/forks destroyed.
**Evidence:**
```java
String username = "AKIA**REDACTED**";
String password = "****REDACTED****";
```
**Immediate action required:** Rotate these AWS credentials immediately in the AWS IAM console. Replace with environment variable injection or AWS Secrets Manager lookup.

---

**B31-2** — CRITICAL
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/RuntimeConfig.java:19`
**Description:** A plaintext third-party SMS API password (`OVLOaICXccaNUS`) for the Clickatell SMS gateway is hardcoded as a public static field. This credential, together with USERNAME (`ciclickatell`) and API_ID (`3629505`), provides full access to the SMS sending account. These values are used in `SendMessage.java` to authenticate to `https://api.clickatell.com`. Anyone with repository read access can send arbitrary SMS messages at the account's expense or exfiltrate the account.
**Evidence:**
```java
public static String USERNAME = "ciclickatell";
public static String PASSWORD = "OVLOaICXccaNUS";
public static String API_ID = "3629505";
```

---

**B31-3** — HIGH
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/RuntimeConfig.java:14`
**Description:** A Google Cloud Messaging (GCM) / Firebase Cloud Messaging (FCM) server API key is hardcoded as a public static field. GCM/FCM keys grant the ability to send push notifications to all registered devices for the associated project. Exposure of this key allows an attacker to send arbitrary push notifications to all forklift operator devices or to abuse the quota.
**Evidence:**
```java
public static String GCMKEY = "key=AIzaSyDDuQUYLcXkutyIxRToLAeBPHBQNLfayzs";
```

---

**B31-4** — HIGH
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/RuntimeConfig.java:30`
**Description:** An internal AWS EC2 instance hostname is hardcoded and used as a base URL for the PDF export API (`APIURL`). The URL uses plain HTTP (not HTTPS), exposes the internal EC2 instance's public DNS name, and reveals infrastructure topology. Additionally, the scheme `http://` means PDF content is fetched without transport encryption, allowing on-path interception or modification of PDF report content. This is a combined information disclosure and transport security issue.
**Evidence:**
```java
public static String APIURL = "http://ec2-52-5-205-104.compute-1.amazonaws.com/api/export/pdf/";
```

---

**B31-5** — MEDIUM
**Section:** 3. Input Validation and Injection
**File:** `src/main/java/com/journaldev/spring/jdbc/util/SendEmail.java:31` and `src/main/java/com/journaldev/spring/jdbc/util/SendEmail.java:37`
**Description:** Email header injection vulnerability. The `mailTo` parameter is passed directly to `InternetAddress.parse(mailTo, false)` without any prior sanitisation or validation. The `false` argument disables strict RFC 2822 address parsing, meaning malformed or crafted inputs that include newline characters (`\r\n`) could inject additional SMTP headers into the message. Similarly, the `subject` parameter is set directly via `message.setSubject(subject)` with no sanitisation. Several call sites pass values derived from database records or user-supplied data (e.g., driver name in subject lines at `ImpactDAO.java:68`, email address from user records at `CompanyController.java:101`). A malicious value in the database or supplied by a user could inject `Bcc:`, `Cc:`, or other headers, enabling spam relay through the application's mail session.
**Evidence:**
```java
// SendEmail.java:31 — no sanitisation of mailTo before parse
message.setRecipients(Message.RecipientType.TO,
    InternetAddress.parse(mailTo, false));

// SendEmail.java:37 — no sanitisation of subject
message.setSubject(subject);

// ImpactDAO.java:68 — subject built from DB-sourced user data
String subject = "[ALERT] Impact Alert - " + userResponse.getName() + " "
    + userResponse.getLastname() + " - Machine: " + notification.getUnit_name()
    + " - Impact Level: RED";

// CompanyController.java:101 — email body contains unescaped driver name and email
String msg = "Your have a request from driver " + driver + " " + email
    + ". Please click the link to accept the request." + url;
```

---

**B31-6** — MEDIUM
**Section:** 5. Data Exposure
**File:** `src/main/java/com/journaldev/spring/jdbc/util/SendEmail.java:33,48,51,53`
**Description:** All exception handling in `sendMail()` routes to `System.out.println` or `e.printStackTrace()` / `mex.printStackTrace()` / `t.printStackTrace()`. In a Tomcat deployment these write to `catalina.out` (the container's standard output log), which is a production log stream. Stack traces in production logs expose internal class names, method names, line numbers, and potentially JNDI configuration details. The `System.out.println` call at line 33 also logs the raw exception object, which may include the recipient email address. This constitutes PII exposure in logs.
**Evidence:**
```java
// line 33
System.out.println("Message Recipents Exception :" + e);

// line 48
e.printStackTrace();

// line 51
mex.printStackTrace();

// line 53
t.printStackTrace();
```

---

**B31-7** — LOW
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/util/RuntimeConf.java:4`
**Description:** `RuntimeConf.database` is a public mutable static field (`public static String database = "jdbc/PreStartDB"`). Any class in the application can overwrite this value at runtime, potentially redirecting all database operations that use this JNDI name. This is a design defect rather than an immediate vulnerability, but in combination with a future injection flaw, it creates a lateral movement path. The field should be `public static final` to prevent runtime mutation.
**Evidence:**
```java
public static String database = "jdbc/PreStartDB";
```

---

**B31-8** — INFO
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/RuntimeConfig.java:5-8`
**Description:** The email-related fields in `RuntimeConfig` (`host`, `port`, `sfport`, `sfclass`) are commented as "unused" by the developer. However, they remain as public mutable static fields with default values. If any future code path references them, the values (`"localhost"`, port `"25"`) would configure an unauthenticated local MTA, bypassing SES authentication entirely. The dead code adds confusion about the actual mail configuration path. These fields should be removed.
**Evidence:**
```java
//email settings, unused
public static String host = "localhost";
public static String port = "25";
public static String sfport = "25";
public static String sfclass = "javax.net.ssl.SSLSocketFactory";
```

---

**B31-9** — INFO
**Section:** 1. Secrets and Configuration / 2. Authentication and Authorization
**File:** `src/main/java/com/journaldev/spring/jdbc/util/SMTPAuthenticator.java`
**Description:** The `SMTPAuthenticator` class overrides `javax.mail.Authenticator.getPasswordAuthentication()` but the JNDI mail session lookup in `SendEmail.java` (`envCtx.lookup("mail/Session")`) means the actual session is configured at the container level (Tomcat `context.xml` or equivalent). It is not confirmed from the files in scope whether `SMTPAuthenticator` is actually wired into the JNDI session or is dead code. If it is not registered with the session, the hardcoded AWS credentials it contains are never used at runtime — but they remain exposed in the repository and present a secrets-in-source risk regardless of runtime usage. This should be confirmed during infrastructure review.

---

## Section C: Checklist Coverage Summary

| Section | Status |
|---------|--------|
| 1. Secrets and Configuration | **FINDINGS: B31-1 (CRITICAL), B31-2 (CRITICAL), B31-3 (HIGH), B31-4 (HIGH), B31-7 (LOW), B31-8 (INFO), B31-9 (INFO)** |
| 2. Authentication and Authorization | **N/A for these three files** — no auth logic present in RuntimeConf, SMTPAuthenticator, or SendEmail |
| 3. Input Validation and Injection | **FINDING: B31-5 (MEDIUM)** — email header injection via unsanitised `mailTo` and `subject` |
| 4. Session and CSRF | **N/A for these three files** — no session or HTTP handling present |
| 5. Data Exposure | **FINDING: B31-6 (MEDIUM)** — stack traces and PII in production logs |
| 6. Dependencies | **N/A for these three files** — dependency review requires pom.xml, outside file scope |
| 7. Build and CI | **N/A for these three files** — build/CI review requires pipeline config, outside file scope |

---

## Section D: Priority Action List

1. **Immediately rotate** the AWS IAM credentials in `SMTPAuthenticator.java` (Access Key ID `AKIA**REDACTED**`). Even after rotation, the old credentials remain in git history — assess whether a git history rewrite and force-push is feasible, and notify all repository collaborators.
2. **Immediately rotate** the Clickatell API credentials in `RuntimeConfig.java` (`ciclickatell` / `OVLOaICXccaNUS`).
3. **Rotate or restrict** the GCM/FCM server key in `RuntimeConfig.java`.
4. Move all credentials to environment variables, a secrets manager (AWS Secrets Manager, HashiCorp Vault), or container-injected environment — never in committed source.
5. Sanitise `mailTo` and `subject` in `SendEmail.sendMail()` to prevent header injection (strip or reject `\r` and `\n` characters before use).
6. Replace all `e.printStackTrace()` and `System.out.println` exception handling in `SendEmail` with a structured logger at WARN or ERROR level, without printing raw exception or recipient details.
7. Change `RuntimeConf.database` and all equivalent mutable public statics in `RuntimeConfig` to `static final` where they are not intended to be mutated at runtime.
