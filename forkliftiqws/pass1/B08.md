# Pass 1 Security Review — Agent B08
**Date:** 2026-02-27
**Branch:** master
**Auditor:** B08
**Files reviewed:**
- `src/main/java/com/journaldev/spring/jdbc/controller/ImageController.java`
- `src/main/java/com/journaldev/spring/jdbc/controller/ImpactController.java`
- `src/main/java/com/journaldev/spring/jdbc/controller/LocationController.java`

**Supporting files read (for context):**
- `src/main/java/com/journaldev/spring/jdbc/controller/ConfigurationController.java`
- `src/main/java/com/journaldev/spring/jdbc/controller/RestURIConstants.java`
- `src/main/java/com/journaldev/spring/jdbc/controller/RuntimeConfig.java`
- `src/main/java/com/journaldev/spring/jdbc/service/FileStorageService.java` (interface)
- `src/main/java/com/journaldev/spring/jdbc/service/LocalFileStorageService.java`
- `src/main/java/com/journaldev/spring/jdbc/service/AbstractFileStorageService.java`
- `src/main/java/com/journaldev/spring/jdbc/service/AWSFileStorageService.java`
- `src/main/java/com/journaldev/spring/jdbc/DAO/ImpactDAO.java`
- `src/main/java/com/journaldev/spring/jdbc/util/Util.java`
- `src/main/java/com/journaldev/spring/jdbc/util/SendEmail.java`
- `src/main/webapp/WEB-INF/spring/spring-security.xml`
- `src/main/webapp/WEB-INF/spring/appServlet/servlet-context.xml`
- `src/main/webapp/WEB-INF/web.xml`
- `src/main/resources/fleetiq360ws.properties`
- `environment.dev.properties`
- `environment.uat.properties`
- `environment.prod.properties`
- `pom.xml`

---

## Step 3 — Reading Evidence

### ImageController.java

**Fully qualified class name:** `com.journaldev.spring.jdbc.controller.ImageController`

**Extends/Implements:** none (plain class)

**Class-level annotations:**
- `@Controller`
- `@Slf4j`

**Fields:**
- `private FileStorageService fileStorageService` — `@Autowired @Qualifier("localFileStorage")`

**Public methods:**

| Line | Return type | Method signature | Annotations |
|------|-------------|-----------------|-------------|
| 30 | `ResponseEntity<Resource>` | `downloadFile(@PathVariable("fileName") String fileName)` | `@RequestMapping(value="/image/{fileName:.+}", method=RequestMethod.GET)` |

---

### ImpactController.java

**Fully qualified class name:** `com.journaldev.spring.jdbc.controller.ImpactController`

**Extends:** `ConfigurationController` (which injects `DataSource dataSource` and `Configuration configuration`)

**Implements:** none

**Class-level annotations:**
- `@Controller`

**Fields:**
- `private static final Logger logger` (line 44)
- `private FileStorageService awsFileStorageService` — `@Autowired @Qualifier("awsFileStorage")` (line 47)
- `private ImpactDAO impactDAO` — `@Autowired` (line 51)
- `private EquipmentDAO equipmentDAO` — `@Autowired` (line 54)
- `Gson gson` (line 56, package-private)

**Public methods:**

| Line | Return type | Method signature | Annotations |
|------|-------------|-----------------|-------------|
| 59 | `ResponseEntity<Incidents>` | `saveIncident(@RequestBody Incidents incident)` | `@RequestMapping(value=SAVE_INCIDENT="/rest/impact/save", method=POST)`, `@ResponseBody` |
| 83 | `ResponseEntity<Results>` | `saveImpactIMAGE(@PathVariable("impid") int impId, @RequestParam("image") MultipartFile imageFile, @RequestParam("signature") String signatureFile)` | `@RequestMapping(value=SAVE_IMPACTIMAGE="/rest/impactimage/{impid}", method=POST, consumes=multipart/form-data)`, `@ResponseBody` |
| 117 | `ResponseEntity<Results>` | `saveImpactIMAGEAPP(@PathVariable("impid") int impId, @PathVariable("type") String type, @RequestParam("file") MultipartFile imageFile)` | `@RequestMapping(value=SAVE_IMPACTIMAGE_APP="/rest/impactimage/impid/{impid}/type/{type}", method=POST, consumes=multipart/form-data)`, `@ResponseBody` |
| 152 | `ResponseEntity<Results>` | `saveImpactData(@RequestBody ImpactList impactList)` | `@RequestMapping(value=SAVE_IMPACT="/rest/impactdata/save", method=POST)`, `@ResponseBody` |

---

### LocationController.java

**Fully qualified class name:** `com.journaldev.spring.jdbc.controller.LocationController`

**Extends:** `ConfigurationController`

**Implements:** none

**Class-level annotations:**
- `@Controller`

**Note:** Class javadoc comment reads "Not in Use" (line 26), but class is compiled and deployed — all endpoints are live.

**Fields:**
- `private static final Logger logger` (line 30)
- `Gson gson` (line 32, package-private)

**Public methods:**

| Line | Return type | Method signature | Annotations |
|------|-------------|-----------------|-------------|
| 35 | `List<GPS>` | `getGPSLocation(@PathVariable("uid") int uid)` | `@RequestMapping(value=GET_GPS_LOC="/rest/gps/get/{uid}", method=GET)`, `@ResponseBody` |
| 53 | `ResponseEntity<Results>` | `saveGPSLocation(@RequestBody GPS gps)` | `@RequestMapping(value=SAVE_GPS_LOC="/rest/gps/save", method=POST)`, `@ResponseBody` |
| 72 | `ResponseEntity<Results>` | `saveGPSLocations(@RequestBody GPSList gpsList)` | `@RequestMapping(value=SAVE_GPS_LOCS="/rest/gps/save/all", method=POST)`, `@ResponseBody` |

---

## Step 4 — Findings by Checklist Section

---

### Section 1: Secrets and Configuration

**Item: Hardcoded credentials in Java source**

ISSUE — `AWSFileStorageService.java` contains a hardcoded AWS IAM access key ID and secret access key in source code.

ISSUE — `Util.java` contains a second set of hardcoded AWS IAM credentials used as the SMTP authenticator for Amazon SES.

ISSUE — `RuntimeConfig.java` contains hardcoded credentials for Clickatell SMS API (USERNAME, PASSWORD, API_ID) and a hardcoded Google Cloud Messaging (GCM) server API key, all as public static fields.

**Item: Credentials in properties/environment files tracked in git**

ISSUE — `environment.dev.properties`, `environment.uat.properties`, and `environment.prod.properties` are committed to the repository. All three contain `cognitoAPIUsername=ciiadmin` and `cognitoAPIPassword=ciiadmin`. The UAT and prod files contain the production database RDS hostname.

ISSUE — `pom.xml` contains hardcoded database credentials in the `local` and `uat` Maven profiles: `flyway.password=gmtp-postgres`, `flyway.password=fleetiq360`, and `flyway.password=C!1admin` for the UAT RDS instance (`forkliftiq360.cmjwsurtk4tn.us-east-1.rds.amazonaws.com`). These are committed to version control.

**Item: Tomcat deployment credentials in pom.xml**

CLEAR — The `tomcat7-maven-plugin` uses `${tomcat.server}` (a settings.xml server reference) rather than inline `<username>`/`<password>` tags.

**Item: web.xml / context.xml secrets**

CLEAR — No credentials in `web.xml`. DataSource is obtained via JNDI.

---

### Section 2: Authentication and Authorization

**Item: Spring Security filter chain review**

`spring-security.xml` configures Spring Security OAuth2. The `/rest/**` URL space requires one of `ROLE_DRIVER`, `ROLE_COMPANY_GROUP`, `ROLE_SYS_ADMIN`, or `ROLE_CLIENT`. Authentication is enforced by the `resourceServerFilter` placed before `PRE_AUTH_FILTER`. Anonymous access is disabled for the `/rest/**` block.

ISSUE — Two URL patterns are explicitly granted `security="none"` with a comment "Just for testing":
- `/oauth/cache_approvals`
- `/oauth/uncache_approvals`

These appear to be OAuth approval management endpoints left open with no security. Their purpose and actual risk surface requires clarification, but they should not be `security="none"` in a production deployment.

**Item: IDOR — ImpactController**

ISSUE — `saveIncident` (line 59): Accepts a `@RequestBody Incidents` object which contains `driver_id` and `unit_id` fields. The method inserts these directly into the database with no check that `driver_id` or `unit_id` belong to the authenticated user's organisation. An authenticated user with any role could create an incident record attributed to any driver or any unit in the system.

ISSUE — `saveImpactIMAGE` (line 83): Accepts `@PathVariable("impid") int impId` and immediately executes `UPDATE incidents SET image=?, signature=? WHERE id=?` using that ID. There is no check that the incident with `impId` belongs to the authenticated user's organisation. Any authenticated caller can overwrite the image and signature of any incident by guessing or enumerating the integer ID.

ISSUE — `saveImpactIMAGEAPP` (line 117): Same IDOR pattern as `saveImpactIMAGE`. The `impId` path variable is used directly in an UPDATE with no ownership check.

ISSUE — `saveGPSLocation` (line 53, LocationController): Accepts a `@RequestBody GPS gps` containing `unit_id`. Executes UPDATE and INSERT on the GPS table for that unit with no check that the caller owns or has permission over that unit. Any authenticated caller can write arbitrary GPS coordinates for any unit in the system.

ISSUE — `saveGPSLocations` (line 72, LocationController): Same IDOR pattern as `saveGPSLocation`, applied in a batch loop.

ISSUE — `getGPSLocation` (line 35, LocationController): Accepts `@PathVariable("uid") int uid` where `uid` appears to represent a driver/user ID. The SQL uses a `permission` table JOIN to scope results (`p.driver_id = ?`) — this provides some scoping. However, the `uid` value is caller-supplied and there is no check that the authenticated principal's identity matches the supplied `uid`. An authenticated caller can supply any integer and retrieve GPS data for equipment visible to that user ID's permissions.

**Item: Password hashing**

ISSUE — `spring-security.xml` line 74 configures the authentication provider with `<password-encoder hash="md5"/>`. MD5 is a broken, unsalted hash unsuitable for password storage. This is the legacy authentication path (separate from Cognito) — even if not the primary auth path in production, it represents a severe weakness if the UserDetailsService is reachable.

**Item: OAuth2 client secrets hardcoded in spring-security.xml**

ISSUE — `spring-security.xml` lines 113–117 define OAuth2 client credentials in plaintext within the committed XML file:
- Client `987654321` with secret `8752361E593A573E86CA558FFD39E`
- Client `fleetiq360` with secret `rihah8eey4faibuengaixo6leiL1awii`

Client `987654321` has `access-token-validity="0"` which means tokens never expire.

**Item: Token expiry**

ISSUE — Client `987654321` is configured with `access-token-validity="0"` (line 113 in `spring-security.xml`). A value of `0` results in tokens that never expire, meaning a compromised token for this client grants permanent access.

**Item: @PreAuthorize / @Secured annotations**

ISSUE — None of the methods in `ImageController`, `ImpactController`, or `LocationController` carry `@PreAuthorize` or `@Secured` annotations. Role-based access control beyond the coarse `ROLE_DRIVER,ROLE_COMPANY_GROUP,...` grant at the URL level is entirely absent. There is no method-level check distinguishing what a `ROLE_DRIVER` may do versus `ROLE_COMPANY_GROUP`.

---

### Section 3: Input Validation and Injection

**Item: Path traversal — ImageController**

ISSUE — `ImageController.downloadFile` (line 30) accepts a `@PathVariable String fileName` via the URL pattern `/image/{fileName:.+}`. The regex `:.+` means any non-empty string is accepted, including strings containing `..` or `/` sequences. This value is passed directly to `fileStorageService.loadImageAsResource(fileName)`.

In `LocalFileStorageService.loadImageAsResource` (line 19):
```java
Path filePath = imageStorageLocation.resolve(fileName).normalize();
```
`Path.resolve()` followed by `Path.normalize()` does collapse `..` sequences, but does not prevent escape from the base directory if the resolved path remains under the storage location only by coincidence. There is no explicit check that `filePath` starts with `imageStorageLocation`. If `fileName` is an absolute path (e.g., `/etc/passwd`) or a path that resolves outside `imageStorageLocation` after normalization, the `UrlResource` will attempt to serve it. The missing guard is:
```java
if (!filePath.startsWith(imageStorageLocation)) { throw ...; }
```
This is a path traversal vulnerability. A request such as `GET /image/../../../etc/passwd` (URL-encoded) or an absolute path could read arbitrary files on the server filesystem.

**Item: File type restriction on upload**

ISSUE — `ImpactController.saveImpactIMAGEAPP` (line 117) and `saveImpactIMAGE` (line 83) accept `MultipartFile` uploads with no MIME type or file extension validation at the controller layer. In `AbstractFileStorageService.saveImage`, the content type is detected from the stream using `URLConnection.guessContentTypeFromStream`. If detection fails the file is stored with a `.jpg` extension. No allowlist of permitted MIME types is enforced. There is no check that the uploaded file is actually an image. An attacker can upload a JSP, shell script, or any executable file disguised as an image.

**Item: SQL Injection**

CLEAR — All SQL in the three controllers and in `ImpactDAO` uses parameterised `JdbcTemplate.update()` / `JdbcTemplate.query()` with `Object[]` parameter arrays. No string concatenation into SQL queries was observed.

**Item: Input validation (@Valid, constraints)**

ISSUE — No `@Valid` annotation appears on any `@RequestBody` or `@RequestParam` parameter in any of the three controllers. Request body objects (`Incidents`, `ImpactList`, `GPS`, `GPSList`) are deserialised and used directly with no JSR-303 constraint validation. There are no `@NotNull`, `@Size`, or `@Pattern` constraints visible.

**Item: Command injection, SSRF, XXE, Deserialization**

CLEAR — No `Runtime.exec()`, `ProcessBuilder`, XML parsing, or `ObjectInputStream` usage was observed in the reviewed files.

---

### Section 4: Session and CSRF

**Item: CSRF protection**

ISSUE — `spring-security.xml` uses `create-session="never"` and `create-session="stateless"` for the OAuth2 resource server block. Spring Security 3.1 does not automatically apply CSRF protection when sessions are stateless, but there is no explicit confirmation that CSRF is disabled intentionally or that all state-changing endpoints are truly stateless. The `/rest/**` block has no `<csrf disabled="true"/>` element visible, meaning the default behaviour for Spring Security 3.1 applies. Since the application uses OAuth2 bearer tokens (not cookies for the REST API), CSRF is a lower risk for the REST endpoints, but the `/image/**` endpoint is served without any security filter at all (it is outside the `/rest/**` pattern) and has no CSRF protection.

**Item: CORS — @CrossOrigin annotations**

CLEAR — No `@CrossOrigin` annotations are present on any of the three reviewed controllers or their methods.

**Item: Security headers (X-Frame-Options, X-Content-Type-Options, HSTS)**

ISSUE — No security response headers (`X-Frame-Options`, `X-Content-Type-Options`, `Strict-Transport-Security`, `Content-Security-Policy`) are configured in `spring-security.xml`, `servlet-context.xml`, or any of the reviewed controllers. Spring Security 3.1 does not add these headers by default. The image download endpoint (`/image/`) sets `Content-Type` from stream sniffing but does not set `X-Content-Type-Options: nosniff`, leaving content-type sniffing open in browsers.

**Item: Cookie configuration**

N/A — The reviewed REST endpoints use OAuth2 bearer tokens, not cookie-based sessions. The `/image/` endpoint does not set cookies.

---

### Section 5: Data Exposure

**Item: Operator / safety record scoping**

ISSUE — `saveIncident` (line 59, ImpactController): The full incident payload is logged at INFO level before any validation: `logger.info("Start saveIncident." + " : " + gson.toJson(incident))`. This serialises the entire `Incidents` object to JSON into the log, including all fields (`driver_id`, `unit_id`, `description`, `injury`, `injury_type`, `witness`, `location`, etc.). This represents PII and sensitive safety record data emitted to production logs.

ISSUE — `saveImpactData` (line 153, ImpactController): `logger.info("Start saveImpactData." + " : " + gson.toJson(impactList))` logs the full impact list payload at INFO level. This includes `mac_address` and `impact_value` fields — forklift telemetry identifiers logged to production logs.

ISSUE — `saveGPSLocations` (line 73, LocationController): `logger.info("Start saveGPSLocations." + " : " + gson.toJson(gpsList))` logs the full GPS payload at INFO level, including latitude, longitude, and unit IDs. GPS location data for all forklifts is emitted to production logs.

**Item: Error responses leaking internal detail**

ISSUE — `ImpactController.saveImpactIMAGE` (line 108) and `saveImpactIMAGEAPP` (line 142) call `e.printStackTrace()` directly on `IOException`. This writes stack traces to standard error / server logs but does not return them to the HTTP client. The error response body is a `Results` object with `RuntimeConfig.ERRORMSG_CODEERRORR = "Code throws exceptions"` — this is acceptable as a response, but the `e.printStackTrace()` pattern means full stack traces appear in server logs. This is a low-severity concern but should be replaced with structured logging.

ISSUE — `ImpactController.saveImpactData` (line 189): The `IllegalArgumentException` message is returned directly in the HTTP response body via `results.setError(e.getMessage())`. The exception message is constructed from user-controlled input (`impact.getMac_address()`) and internal state, leaking MAC address values and operation context back to the caller in error responses.

**Item: GPS data scoping**

ISSUE — `getGPSLocation` (line 35, LocationController): The `uid` parameter is caller-supplied and is used in a SQL JOIN on the `permission` table to scope results. However, no verification is performed that the authenticated principal is the owner of `uid`. The data returned includes GPS coordinates, unit names, and unit IDs for all equipment visible to whatever `uid` is supplied. An authenticated user can enumerate any integer value for `uid` and retrieve GPS telemetry for equipment that is not theirs.

---

### Section 6: Dependencies

**Item: Known vulnerable dependencies**

ISSUE — `spring-security-web` and `spring-security-config` are pinned to `3.1.1.RELEASE` (pom.xml lines 231, 236). Spring Security 3.1.1 was released in 2012 and is far outside the support lifecycle. It is missing over a decade of security patches including multiple CVEs (e.g., CVE-2014-0054, CVE-2016-9879, CVE-2018-1258, and many others).

ISSUE — `spring-security-oauth2` version `1.0.0.RELEASE` (pom.xml line 242). This is an extremely old version of Spring Security OAuth2 (ca. 2012). It predates critical fixes including CVE-2018-1260 (open redirect in authorization server) and numerous others.

ISSUE — `org.springframework-version` is `3.2.14.RELEASE` (pom.xml line 12). Spring 3.2 reached end-of-life in December 2016. Multiple critical CVEs affect this version including SpEL injection vulnerabilities.

ISSUE — `jackson-databind` version `2.6.7` (pom.xml line 15). Jackson 2.6.7 is affected by numerous high-severity deserialization CVEs (CVE-2017-7525, CVE-2018-5968, CVE-2018-14719, CVE-2019-14379, and many more). This version is no longer maintained.

ISSUE — `commons-fileupload` version `1.3.1` (pom.xml line 200). This version is affected by CVE-2016-3092 (DoS via malicious Content-Type header) and CVE-2014-0050. The current version is 1.5+.

ISSUE — `com.amazonaws:aws-java-sdk` version `1.11.163` (pom.xml line 271). This is a 2017 release, missing years of security patches and deprecated API fixes.

ISSUE — `apache-tika-core` version `1.18` (pom.xml line 209). Tika 1.18 is from 2018. Multiple CVEs affect versions before 2.x including XML entity expansion and ZIP bomb vulnerabilities (CVE-2022-25169).

ISSUE — `org.apache.commons:commons-io` version `1.3.2` (pom.xml line 170). Note: `commons-io` artifact `org.apache.commons:commons-io` with version `1.3.2` is unusual — the standard artifact is `commons-io:commons-io`. This may resolve to an incorrect or third-party artifact. The `groupId`/`artifactId` combination should be verified.

**Item: Repository configuration**

ISSUE — `pom.xml` line 87 declares a dependency repository at `http://splunk.jfrog.io/splunk/ext-releases-local` over plain HTTP (not HTTPS). Dependencies fetched over plain HTTP are vulnerable to man-in-the-middle attacks that could inject malicious artifacts.

**Item: SNAPSHOT dependencies**

CLEAR — No SNAPSHOT dependencies found.

---

### Section 7: Build and CI

**Item: Bitbucket Pipelines**

N/A — No `bitbucket-pipelines.yml` file was found in the repository.

**Item: Test skipping**

N/A — No pipeline configuration found. Cannot evaluate.

**Item: Maven build configuration**

CLEAR — `maven-compiler-plugin` is configured with `-Xlint:all`, `showWarnings=true`, and `showDeprecation=true` (pom.xml lines 307–309). This is a positive practice.

---

## Findings Summary

**B08-1** — CRITICAL
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/service/AWSFileStorageService.java:31`
**Description:** Hardcoded AWS IAM access key ID and secret access key committed to source control. These credentials grant access to the S3 bucket used for impact images. Anyone with repository access has full access to the AWS account's S3 operations.
**Evidence:**
```java
private static AWSCredentials credentials = new BasicAWSCredentials(
        "AKIA**REDACTED**",
        "****REDACTED****"
);
```

---

**B08-2** — CRITICAL
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/util/Util.java:66`
**Description:** Hardcoded AWS IAM credentials (SES SMTP) committed to source control. The key ID `AKIA**REDACTED**` and secret are used for all transactional email. Anyone with read access to this repository can send arbitrary email from the application's AWS SES identity.
**Evidence:**
```java
return new PasswordAuthentication("AKIA**REDACTED**", "****REDACTED****");
```

---

**B08-3** — CRITICAL
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/RuntimeConfig.java:14,18–21`
**Description:** Multiple third-party API credentials hardcoded as public static fields: a Google Cloud Messaging (FCM) server key and Clickatell SMS API credentials (username, password, API ID). These are committed to source control and exposed as public class members accessible from anywhere in the application.
**Evidence:**
```java
public static String GCMKEY = "key=AIzaSyDDuQUYLcXkutyIxRToLAeBPHBQNLfayzs";
public static String USERNAME = "ciclickatell";
public static String PASSWORD = "OVLOaICXccaNUS";
public static String API_ID = "3629505";
```

---

**B08-4** — CRITICAL
**Section:** 2. Authentication and Authorization
**File:** `src/main/webapp/WEB-INF/spring/spring-security.xml:113`
**Description:** OAuth2 client credentials committed to source control in plaintext. Client `987654321` has `access-token-validity="0"` meaning tokens issued to this client never expire. Any party with access to this repository can authenticate as this OAuth2 client and obtain non-expiring access tokens to the entire `/rest/**` API surface.
**Evidence:**
```xml
<oauth:client client-id="987654321" authorized-grant-types="password,authorization_code,implicit"
              secret="8752361E593A573E86CA558FFD39E" authorities="ROLE_CLIENT" scope="read,write" access-token-validity="0"/>
<oauth:client client-id="fleetiq360" authorized-grant-types="password,authorization_code,refresh_token,implicit"
              secret="rihah8eey4faibuengaixo6leiL1awii" authorities="ROLE_DRIVER,ROLE_COMPANY_GROUP,ROLE_SYS_ADMIN" scope="read,write" access-token-validity="300" refresh-token-validity="300"/>
```

---

**B08-5** — HIGH
**Section:** 3. Input Validation and Injection — Path Traversal
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/ImageController.java:30`
**Description:** The `downloadFile` method accepts an arbitrary `fileName` path variable (regex `:.+` allows any non-empty string including `..` sequences and absolute paths). The value is passed to `LocalFileStorageService.loadImageAsResource(fileName)` which calls `imageStorageLocation.resolve(fileName).normalize()` but does not verify the resolved path is still within `imageStorageLocation`. An attacker can traverse outside the image storage directory and read arbitrary server files.
**Evidence:**
```java
// ImageController.java line 29-32:
@RequestMapping(value = "/image/{fileName:.+}", method = RequestMethod.GET)
public ResponseEntity<Resource> downloadFile(@PathVariable("fileName") String fileName) {
    Resource resource = fileStorageService.loadImageAsResource(fileName);

// LocalFileStorageService.java line 19-21:
Path filePath = imageStorageLocation.resolve(fileName).normalize();
Resource resource = new UrlResource(filePath.toUri());
// No check: filePath.startsWith(imageStorageLocation)
```

---

**B08-6** — HIGH
**Section:** 2. Authentication and Authorization — IDOR
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/ImpactController.java:83,117`
**Description:** `saveImpactIMAGE` and `saveImpactIMAGEAPP` accept an `impid` path variable (incident ID) and update the `incidents` table row for that ID with no check that the incident belongs to the authenticated user's organisation. An authenticated attacker can overwrite the image or signature evidence on any incident record by supplying an arbitrary integer ID. This is safety-critical: impact evidence for incidents involving injuries could be tampered with.
**Evidence:**
```java
// saveImpactIMAGE line 98-99:
String query = "update incidents set image = ?,signature = ? where id = ? ";
jdbcTemplate.update(query, new Object[] {impactImageFilename, sigImageFilename, impId});

// saveImpactIMAGEAPP line 129-134:
String query = "update incidents set image = ?  where id = ? ";
jdbcTemplate.update(query, new Object[] {imageFilename, impId});
// ... or:
String query = "update incidents set signature = ? where id = ? ";
jdbcTemplate.update(query, new Object[] {imageFilename, impId});
```

---

**B08-7** — HIGH
**Section:** 2. Authentication and Authorization — IDOR
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/ImpactController.java:59`
**Description:** `saveIncident` accepts `driver_id` and `unit_id` in the request body with no validation that these IDs belong to the authenticated user's organisation. An authenticated attacker can create incident records attributed to any driver or unit in the system.
**Evidence:**
```java
query = "insert into incidents (id,report_time,event_time,injury_type,witness,location,injury,description,near_miss,job_number,incident,driver_id,unit_id) values (?,?,?,?,?,?,?,?,?,?,?,?,?) ";
jdbcTemplate.update(query, new Object[] {id, ..., incident.getDriver_id(), incident.getUnit_id()});
```

---

**B08-8** — HIGH
**Section:** 2. Authentication and Authorization — IDOR
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/LocationController.java:53,72`
**Description:** `saveGPSLocation` and `saveGPSLocations` accept `unit_id` from the request body and write GPS coordinates for that unit with no check that the caller owns or has permission to write GPS data for that unit. An authenticated attacker can inject false GPS positions for any forklift unit in the system.
**Evidence:**
```java
// saveGPSLocation line 59-63:
String query = "update gps set current_location = false where unit_id = ?";
jdbcTemplate.update(query, new Object[]{gps.getUnit_id()});
query = "insert into gps (unit_id,longitude,latitude,gps_time,current_location) values (?,?,?,now(), true)";
jdbcTemplate.update(query, new Object[]{gps.getUnit_id(), gps.getLongitude(), gps.getLatitude()});
```

---

**B08-9** — HIGH
**Section:** 2. Authentication and Authorization — IDOR
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/LocationController.java:35`
**Description:** `getGPSLocation` uses the caller-supplied `uid` path variable as the driver ID in a SQL JOIN but does not verify that the authenticated principal matches `uid`. An authenticated attacker can enumerate integer values to retrieve GPS location data for equipment associated with any user ID.
**Evidence:**
```java
@RequestMapping(value = RestURIConstants.GET_GPS_LOC, method = RequestMethod.GET)
public @ResponseBody List<GPS> getGPSLocation(@PathVariable("uid") int uid) {
    String query = "... left outer join permission as p on u.comp_id = p.comp_id and p.driver_id = ? "
            + " where p.enabled is true and u.active is true and current_location is true";
    List<GPS> gpslst = jdbcTemplate.query(query, new Object[]{uid}, new BeanPropertyRowMapper<GPS>(GPS.class));
```

---

**B08-10** — HIGH
**Section:** 3. Input Validation and Injection — Unrestricted File Upload
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/ImpactController.java:83,117`
**Description:** Both `saveImpactIMAGE` and `saveImpactIMAGEAPP` accept `MultipartFile` uploads with no file type validation at the controller or service layer. `AbstractFileStorageService.saveImage` uses `URLConnection.guessContentTypeFromStream` for content type detection (which is unreliable and can be spoofed) and falls back to `.jpg` on failure. No allowlist of permitted MIME types or extensions is enforced. Any file type including executable scripts can be uploaded and stored on the server filesystem and in the S3 bucket.
**Evidence:**
```java
// saveImpactIMAGEAPP line 123-125:
InputStream imagfis = new BufferedInputStream(imageFile.getInputStream());
String imageFilename = awsFileStorageService.saveImage(imagfis);
// No MIME type check before save
```

---

**B08-11** — HIGH
**Section:** 1. Secrets and Configuration
**File:** `pom.xml:76`
**Description:** Database credentials for the UAT RDS PostgreSQL instance (`forkliftiq360.cmjwsurtk4tn.us-east-1.rds.amazonaws.com`) are committed in plaintext in the `pom.xml` Maven profile. User `dev_admin` with password `C!1admin` gives direct database access to anyone with repository read access.
**Evidence:**
```xml
<flyway.url>jdbc:postgresql://forkliftiq360.cmjwsurtk4tn.us-east-1.rds.amazonaws.com:5432/postgres</flyway.url>
<flyway.user>dev_admin</flyway.user>
<flyway.password>C!1admin</flyway.password>
```

---

**B08-12** — HIGH
**Section:** 6. Dependencies
**File:** `pom.xml:231,236,242`
**Description:** The Spring Security stack is critically out of date. `spring-security-web` and `spring-security-config` are version `3.1.1.RELEASE` (2012), and `spring-security-oauth2` is `1.0.0.RELEASE` (2012). The core Spring Framework is `3.2.14.RELEASE` (EOL Dec 2016). These versions have numerous known critical CVEs including authentication bypass, open redirect, and expression injection vulnerabilities.
**Evidence:**
```xml
<artifactId>spring-security-web</artifactId>
<version>3.1.1.RELEASE</version>
...
<artifactId>spring-security-oauth2</artifactId>
<version>1.0.0.RELEASE</version>
...
<org.springframework-version>3.2.14.RELEASE</org.springframework-version>
```

---

**B08-13** — HIGH
**Section:** 6. Dependencies
**File:** `pom.xml:99`
**Description:** `jackson-databind` version `2.6.7` is affected by numerous critical deserialization CVEs (CVE-2017-7525, CVE-2018-5968, CVE-2018-14719, CVE-2019-14379, CVE-2020-8840, and many others). This version allows polymorphic type handling exploits that can lead to remote code execution if default typing or `@JsonTypeInfo` with `Id.CLASS` is used anywhere in the application.
**Evidence:**
```xml
<artifactId>jackson-databind</artifactId>
<version>2.6.7</version>
```

---

**B08-14** — HIGH
**Section:** 2. Authentication and Authorization
**File:** `src/main/webapp/WEB-INF/spring/spring-security.xml:74`
**Description:** The legacy authentication manager uses MD5 as the password hashing algorithm (`<password-encoder hash="md5"/>`). MD5 is a broken hash with no salting that can be reversed via rainbow tables. If this authentication path is reachable (i.e., the UserDetailsService is used in any code path), user passwords stored in the database are effectively in plaintext.
**Evidence:**
```xml
<authentication-provider user-service-ref="userDetailsService">
    <password-encoder hash="md5"/>
</authentication-provider>
```

---

**B08-15** — MEDIUM
**Section:** 5. Data Exposure — Logging of PII
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/ImpactController.java:60`
**Description:** The full incident request body is serialised to JSON and logged at INFO level before any processing, including sensitive fields: driver ID, injury description, witness names, injury type, and location. This PII and safety record data will appear in all production log aggregators (Splunk is configured).
**Evidence:**
```java
logger.info("Start saveIncident." + " : " + gson.toJson(incident));
```

---

**B08-16** — MEDIUM
**Section:** 5. Data Exposure — Logging of Telemetry
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/LocationController.java:73`
**Description:** Full GPS payload (unit IDs, latitude, longitude, timestamps for all forklifts in the batch) is logged at INFO level on every `saveGPSLocations` call. In production this populates Splunk with the real-time location of every forklift on every GPS update.
**Evidence:**
```java
logger.info("Start saveGPSLocations." + " : " + gson.toJson(gpsList));
```

---

**B08-17** — MEDIUM
**Section:** 5. Data Exposure — Error Response Leaking Internal Details
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/ImpactController.java:189`
**Description:** The `IllegalArgumentException` message constructed from internal logic (including the `mac_address` value from user input) is returned verbatim in the HTTP response body. This leaks internal MAC address values and database operation context to the caller.
**Evidence:**
```java
results.setError(e.getMessage());
// e.getMessage() may be e.g. "Unable to save impact event AA:BB:CC:DD:EE:FF for 2026-02-27T12:00:00"
return new ResponseEntity(results, HttpStatus.BAD_REQUEST);
```

---

**B08-18** — MEDIUM
**Section:** 1. Secrets and Configuration
**File:** `environment.dev.properties:15`, `environment.uat.properties:15`, `environment.prod.properties:15`
**Description:** Cognito API credentials (`cognitoAPIUsername=ciiadmin`, `cognitoAPIPassword=ciiadmin`) are committed to the repository for all environments. All three environment files are tracked in git. Additionally, the production environment file contains the public EC2 hostname (`ec2-54-86-82-22.compute-1.amazonaws.com`) revealing infrastructure topology.
**Evidence:**
```properties
cognitoAPIUsername=ciiadmin
cognitoAPIPassword=ciiadmin
imageURL=https://ec2-54-86-82-22.compute-1.amazonaws.com:8443/fleetiq360ws/image/
```

---

**B08-19** — MEDIUM
**Section:** 4. Session and CSRF — Security Headers
**File:** `src/main/webapp/WEB-INF/spring/spring-security.xml` (entire file)
**Description:** No HTTP security response headers are configured: no `X-Frame-Options`, no `X-Content-Type-Options`, no `Strict-Transport-Security`, and no `Content-Security-Policy`. Spring Security 3.1 does not add these headers by default. The image endpoint additionally sets a content type inferred from the file stream without `X-Content-Type-Options: nosniff`, allowing browser content-type sniffing of served files.
**Evidence:** No `<headers>` block, `http-headers`, or equivalent configuration present in `spring-security.xml` or `servlet-context.xml`.

---

**B08-20** — MEDIUM
**Section:** 2. Authentication and Authorization
**File:** `src/main/webapp/WEB-INF/spring/spring-security.xml:13`
**Description:** Two OAuth endpoints are granted `security="none"` with a comment "Just for testing": `/oauth/cache_approvals` and `/oauth/uncache_approvals`. These are unauthenticated in production. Their actual function and attack surface must be assessed and they should be removed or protected.
**Evidence:**
```xml
<!-- Just for testing... -->
<http pattern="/oauth/cache_approvals" security="none" xmlns="..." />
<http pattern="/oauth/uncache_approvals" security="none" xmlns="..." />
```

---

**B08-21** — MEDIUM
**Section:** 3. Input Validation and Injection
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/ImpactController.java:59,83,117,152`; `src/main/java/com/journaldev/spring/jdbc/controller/LocationController.java:35,53,72`
**Description:** No `@Valid` annotation is present on any `@RequestBody` parameter in any of the reviewed controllers. Request bodies (`Incidents`, `ImpactList`, `GPS`, `GPSList`) are deserialised and used without JSR-303 validation. There are no bean constraint annotations visible on any model class. Unexpected null values, out-of-range numeric fields, and malformed strings will reach database operations unchecked.
**Evidence:**
```java
// ImpactController.java line 59:
public @ResponseBody ResponseEntity<Incidents> saveIncident(@RequestBody Incidents incident)
// No @Valid on parameter

// LocationController.java line 53:
public @ResponseBody ResponseEntity<Results> saveGPSLocation(@RequestBody GPS gps)
// No @Valid on parameter
```

---

**B08-22** — MEDIUM
**Section:** 6. Dependencies
**File:** `pom.xml:200`
**Description:** `commons-fileupload` version `1.3.1` is affected by CVE-2016-3092 (denial of service via malicious Content-Type in multipart request) and CVE-2014-0050. Both `saveImpactIMAGE` and `saveImpactIMAGEAPP` consume `multipart/form-data` and are exposed to this vulnerability.
**Evidence:**
```xml
<artifactId>commons-fileupload</artifactId>
<version>1.3.1</version>
```

---

**B08-23** — LOW
**Section:** 5. Data Exposure — Error Handling
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/ImpactController.java:108,142`
**Description:** `e.printStackTrace()` is called directly in catch blocks for `IOException`. Stack traces are written to standard error rather than to the structured logger, bypassing Splunk log aggregation and making errors difficult to monitor. Additionally, the practice of printing stack traces (even to standard error) should be replaced with `logger.error(...)`.
**Evidence:**
```java
} catch (IOException e) {
    e.printStackTrace();
    results.setMessage_id(RuntimeConfig.MSGID_CODEERRORR);
```

---

**B08-24** — LOW
**Section:** 6. Dependencies
**File:** `pom.xml:87`
**Description:** A third-party Maven repository (`splunk.jfrog.io`) is declared using plain HTTP, not HTTPS. Dependencies fetched over HTTP are vulnerable to man-in-the-middle substitution attacks that could introduce malicious artifacts into the build.
**Evidence:**
```xml
<url>http://splunk.jfrog.io/splunk/ext-releases-local</url>
```

---

**B08-25** — LOW
**Section:** 2. Authentication and Authorization
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/LocationController.java:26`
**Description:** The class javadoc comment states "Not in Use" but the controller is a `@Controller` with active `@RequestMapping` annotations and is included in the component scan. All three endpoints (`getGPSLocation`, `saveGPSLocation`, `saveGPSLocations`) are live and accessible. The misleading comment creates a false sense that this code is inactive and may cause it to be overlooked during security reviews.
**Evidence:**
```java
/**
 * Not in Use
 */
@Controller
public class LocationController extends ConfigurationController {
```

---

**B08-26** — INFO
**Section:** 6. Dependencies
**File:** `pom.xml:209`
**Description:** Apache Tika version `1.18` (2018) is used for MIME type detection during file upload. Tika 1.x has known CVEs related to XML/ZIP processing. While `tika-core` alone (without `tika-parsers`) has limited attack surface, this version should be updated to the current 2.x series.
**Evidence:**
```xml
<artifactId>tika-core</artifactId>
<version>1.18</version>
```

---

*End of B08 Pass 1 report. Total findings: 26 (3 CRITICAL, 7 HIGH, 7 MEDIUM, 3 LOW, 1 INFO).*
