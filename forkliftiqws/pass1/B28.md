# Pass 1 Security Review — Agent B28
**Date:** 2026-02-27
**Branch:** master
**Repo:** forkliftiqws

---

## Files Read

1. `src/main/java/com/journaldev/spring/jdbc/service/EntityNotFoundException.java`
2. `src/main/java/com/journaldev/spring/jdbc/service/FileNotFoundException.java`
3. `src/main/java/com/journaldev/spring/jdbc/service/FileStorageException.java`
4. `src/main/java/com/journaldev/spring/jdbc/service/FileStorageService.java`

Additional files read to support analysis (call sites, implementations, configuration):

5. `src/main/java/com/journaldev/spring/jdbc/service/AbstractFileStorageService.java`
6. `src/main/java/com/journaldev/spring/jdbc/service/LocalFileStorageService.java`
7. `src/main/java/com/journaldev/spring/jdbc/service/AWSFileStorageService.java`
8. `src/main/java/com/journaldev/spring/jdbc/service/APKUpdaterService.java`
9. `src/main/java/com/journaldev/spring/jdbc/controller/ImageController.java`
10. `src/main/java/com/journaldev/spring/jdbc/controller/APKUpdaterController.java`
11. `src/main/java/com/journaldev/spring/jdbc/DAO/DriverDAOImpl.java`
12. `src/main/resources/fleetiq360ws.properties`
13. `environment.dev.properties`
14. `environment.uat.properties`
15. `environment.prod.properties`

---

## Reading Evidence

### 1. `EntityNotFoundException.java`

**Fully qualified class name:** `com.journaldev.spring.jdbc.service.EntityNotFoundException`

**Extends:** `RuntimeException`

**Implements:** (none)

**Annotations on class:**
- `@ResponseStatus(HttpStatus.NOT_FOUND)` (line 6)

**Fields:** (none declared)

**Public methods:**

| Return type | Method | Parameters | Line |
|---|---|---|---|
| (constructor) | `EntityNotFoundException` | `String message` | 9 |

The constructor delegates to `super(message)` — the message is propagated up to `RuntimeException.getMessage()`.

---

### 2. `FileNotFoundException.java`

**Fully qualified class name:** `com.journaldev.spring.jdbc.service.FileNotFoundException`

**Extends:** `FileStorageException`

**Implements:** (none)

**Annotations on class:**
- `@ResponseStatus(HttpStatus.NOT_FOUND)` (line 6)

**Fields:** (none declared)

**Public methods:**

| Return type | Method | Parameters | Line |
|---|---|---|---|
| (constructor) | `FileNotFoundException` | `String message` | 9 |

The constructor delegates to `super(message)` — message flows through `FileStorageException(String)` to `RuntimeException.getMessage()`.

---

### 3. `FileStorageException.java`

**Fully qualified class name:** `com.journaldev.spring.jdbc.service.FileStorageException`

**Extends:** `RuntimeException`

**Implements:** (none)

**Annotations on class:** (none)

**Fields:**

| Modifier | Type | Name | Value |
|---|---|---|---|
| `private static final` | `long` | `serialVersionUID` | `8988464861907090725L` |

**Public methods:**

| Return type | Method | Parameters | Line |
|---|---|---|---|
| (constructor) | `FileStorageException` | `String message` | 7 |
| (constructor) | `FileStorageException` | `String message, Throwable cause` | 11 |

Both constructors delegate to the corresponding `RuntimeException` super constructor. The two-arg constructor also propagates the cause chain, which may include underlying `IOException` detail messages.

---

### 4. `FileStorageService.java`

**Fully qualified class name:** `com.journaldev.spring.jdbc.service.FileStorageService`

**Type:** Interface

**Extends:** (none)

**Annotations on interface:** (none)

**Methods declared:**

| Return type | Method | Parameters | Line |
|---|---|---|---|
| `String` | `saveImage` | `InputStream inputStream` | 8 |
| `Resource` | `loadImageAsResource` | `String fileName` | 10 |

No validation constraints, no input sanitisation, declared at interface level.

---

### Supporting files — key observations recorded for findings below

**`AbstractFileStorageService` (lines of interest):**
- Line 25–26: `@Value("${uploadDir}") protected String uploadDir;`
- Line 27–28: `@Value("${imageDir}") protected String imageDir;`
- Line 32–33: `@Value("${imagePrefix}") private String imagePrefix;`
- Line 65: `this.fileName = this.imagePrefix + Util.generateRadomName() + this.imageExt;` — filename is server-generated, not user-supplied for `saveImage`.
- Line 67: `targetLocation = this.imageStorageLocation.resolve(fileName);` — resolved against `imageStorageLocation`.
- Line 72: `throw new FileStorageException("Could not store file " + fileName + ". Please try again!", ex);` — `fileName` is server-generated, not a path leak risk here.

**`LocalFileStorageService` (lines of interest):**
- Line 19: `Path filePath = imageStorageLocation.resolve(fileName).normalize();` — `fileName` comes from the `@PathVariable` in `ImageController`.
- Line 24: `throw new FileNotFoundException("Unable to find " + fileName + " at location : " + filePath.toString() + " on server");` — full resolved server filesystem path included in the exception message.
- Line 27: `throw new FileStorageException("Invalid filename, unable to build url for " + fileName, ex);` — user-supplied `fileName` echoed back.

**`APKUpdaterService` (lines of interest):**
- Line 56: `Path filePath = Paths.get(packageDir).resolve(String.format("%s-%s.apk", pkgname, version));` — `pkgname` and `version` are user-supplied `@PathVariable`/`@RequestParam`. No sanitisation or canonicalisation.
- Line 62: `throw new FileNotFoundException("Unable to find " + pkgname + ", version " + version + " at location : " + filePath.toString() + " on server");` — full resolved server path in exception message.

**`AWSFileStorageService` (lines of interest):**
- Lines 31–34: `private static AWSCredentials credentials = new BasicAWSCredentials("AKIA**REDACTED**", "****REDACTED****");` — hardcoded AWS access key ID and secret access key.

**`DriverDAOImpl` (lines of interest):**
- Line 112: `throw new EntityNotFoundException("Unable to find driver for userId " + userId);` — internal integer DB primary key echoed in exception message.
- Line 70: `throw new SQLException("Unable to update driver detail for driver " + driver.getId());`
- Line 84: `throw new SQLException("Unable to update last login time for driver " + driver.getId());`
- Line 97: `throw new SQLException("Unable to update driver password for driver " + email);` — user email echoed in exception message.

**`ImageController` (lines of interest):**
- Line 29: `@RequestMapping(value = "/image/{fileName:.+}", method = RequestMethod.GET)` — `fileName` taken directly from URL path.
- Line 32: `fileStorageService.loadImageAsResource(fileName)` — user-supplied `fileName` passed without sanitisation.
- No `@PreAuthorize`, no authentication annotation on the method or class. No Spring Security restriction visible in this file.

**`APKUpdaterController` (lines of interest):**
- Line 36–38: `@RequestMapping(value = "/rest/apk/{pkgname}/update", method = RequestMethod.GET)` — `pkgname` is a `@PathVariable`, `version` is a `@RequestParam`. No input validation.
- Line 55–56: `@RequestMapping(value = "/rest/apk/{pkgname}", method = RequestMethod.GET)` — same unsanitised inputs.
- No `@PreAuthorize`, no authentication annotation visible.

**`environment.prod.properties` / `environment.uat.properties` (lines of interest):**
- `cognitoAPIUsername=ciiadmin`
- `cognitoAPIPassword=ciiadmin`
- `imageURL=https://ec2-54-86-82-22.compute-1.amazonaws.com:8443/fleetiq360ws/image/` — production EC2 hostname/IP committed to source control.

**No `@ControllerAdvice` / global exception handler found.** The `@ResponseStatus` annotations on the exception classes cause Spring to return the HTTP status, but Spring MVC's default behaviour (without a custom `@ControllerAdvice`) is to include the exception `message` in the response body for `@ResponseStatus`-annotated exceptions when the `reason` attribute is not set.

---

## Checklist Review

### Section 1 — Secrets and Configuration

**ISSUE — see B28-1, B28-2, B28-3.**

### Section 2 — Authentication and Authorization

**ISSUE — see B28-7.** `ImageController` serves files at `/image/{fileName:.+}` with no visible authentication or authorisation enforcement. No `@PreAuthorize`, no Spring Security restriction observed in the controller. The APK endpoints are similarly unguarded at the controller level.

### Section 3 — Input Validation and Injection

**ISSUE — see B28-4, B28-5.** Path traversal in `LocalFileStorageService.loadImageAsResource` and `APKUpdaterService.loadPackageAsResource`.

### Section 4 — Session and CSRF

**N/A** for the assigned files directly. No session or CSRF configuration in these files.

### Section 5 — Data Exposure

**ISSUE — see B28-6, B28-8.** Exception messages contain server filesystem paths, internal entity IDs, and user email addresses that may be serialised into HTTP responses.

### Section 6 — Dependencies

**N/A** for these files (no pom.xml assigned to this agent).

### Section 7 — Build and CI

**N/A** for these files.

---

## Findings

---

**B28-1** — CRITICAL
**Section:** 1. Secrets and Configuration
**File:** `src/main/java/com/journaldev/spring/jdbc/service/AWSFileStorageService.java:31-34`
**Description:** AWS IAM access key ID and secret access key are hardcoded as a static field initialiser. These credentials are committed to source control and will be visible to anyone with repository read access. The credentials authenticate against AWS S3 and are used with `AmazonS3ClientBuilder`, meaning an attacker possessing them can read, write, and delete objects in the `forkliftiq360` S3 bucket, and potentially perform any action authorised to that IAM identity.
**Evidence:**
```java
private static AWSCredentials credentials = new BasicAWSCredentials(
        "AKIA**REDACTED**",
        "****REDACTED****"
);
```

---

**B28-2** — HIGH
**Section:** 1. Secrets and Configuration
**File:** `environment.dev.properties:15-16`, `environment.uat.properties:15-16`, `environment.prod.properties:15-16`
**Description:** The `cognitoAPIUsername` and `cognitoAPIPassword` credentials are committed in plaintext across all three environment property files tracked in the repository. The value `ciiadmin` / `ciiadmin` is shared across dev, UAT, and prod environments, indicating the same credential is used everywhere. These files should not be committed; secrets must be injected via Bitbucket pipeline variables or a secrets manager at deploy time.
**Evidence:**
```
cognitoAPIUsername=ciiadmin
cognitoAPIPassword=ciiadmin
```
(identical in all three files)

---

**B28-3** — MEDIUM
**Section:** 1. Secrets and Configuration
**File:** `environment.prod.properties:1-2`, `environment.uat.properties:1-2`
**Description:** The production and UAT environment property files committed to the repository contain a specific AWS EC2 public DNS hostname and IP address (`ec2-54-86-82-22.compute-1.amazonaws.com`, resolving to `54.86.82.22`). This discloses the production server's public IP and cloud provider region. Combined with B28-1, an attacker has both credentials and the target infrastructure endpoint. Even independently, committing production infrastructure hostnames to source control increases the attack surface by exposing server topology.
**Evidence:**
```
imageURL=https://ec2-54-86-82-22.compute-1.amazonaws.com:8443/fleetiq360ws/image/
systemImageURL=https://ec2-54-86-82-22.compute-1.amazonaws.com:8443/fleetiq360ws/image/
```

---

**B28-4** — HIGH
**Section:** 3. Input Validation and Injection (Path Traversal)
**File:** `src/main/java/com/journaldev/spring/jdbc/service/LocalFileStorageService.java:19`
**Description:** The `fileName` parameter passed to `loadImageAsResource` originates from the URL `@PathVariable` in `ImageController` (`/image/{fileName:.+}`) and is used without sanitisation in `Path.resolve(fileName).normalize()`. While `normalize()` removes redundant `.` and `..` segments within the path string, it does not enforce that the resolved path remains within the `imageStorageLocation` directory. A crafted filename such as `../../../etc/passwd` will, after `normalize()`, produce a path outside the storage root. No boundary check (e.g., `startsWith(imageStorageLocation)`) is performed before `UrlResource` is constructed and returned. If `loadImageAsResource` returns the resource successfully, the controller streams the file contents to the client.
**Evidence:**
```java
// ImageController.java:29-32
@RequestMapping(value = "/image/{fileName:.+}", method = RequestMethod.GET)
public ResponseEntity<Resource> downloadFile(@PathVariable("fileName") String fileName) {
    Resource resource = fileStorageService.loadImageAsResource(fileName);
    ...
}

// LocalFileStorageService.java:19-24
Path filePath = imageStorageLocation.resolve(fileName).normalize();
Resource resource = new UrlResource(filePath.toUri());
if (resource.exists()) {
    return resource;
} else {
    throw new FileNotFoundException("Unable to find " + fileName + " at location : " + filePath.toString() + " on server");
}
```

---

**B28-5** — HIGH
**Section:** 3. Input Validation and Injection (Path Traversal)
**File:** `src/main/java/com/journaldev/spring/jdbc/service/APKUpdaterService.java:56`
**Description:** In `loadPackageAsResource`, both `pkgname` (from `@PathVariable`) and `version` (from `@RequestParam`) are user-supplied and are directly interpolated into a path via `String.format("%s-%s.apk", pkgname, version)`. The resulting string is resolved against `packageDir` using `Paths.get(packageDir).resolve(...)` with no sanitisation, no canonicalisation boundary check, and no regex enforcement before path construction. Although `getAvailablePackage` applies a regex `(\w*)-(...)` to filenames it finds on disk during the listing operation, `loadPackageAsResource` does not apply any such validation to the caller-supplied `pkgname` and `version` before constructing the path. A `pkgname` of `../image` and `version` of `../etc/passwd` would traverse outside `packageDir`. Similarly, the `getAvailablePackage` call passes `pkgname` and `version` without validation into the path formatter.
**Evidence:**
```java
// APKUpdaterService.java:56
Path filePath = Paths.get(packageDir).resolve(String.format("%s-%s.apk", pkgname, version));
```
```java
// APKUpdaterController.java:55-61
@RequestMapping(value = "/rest/apk/{pkgname}", method = RequestMethod.GET)
public ResponseEntity<Resource> downloadPackage(@PathVariable("pkgname") String pkgname,
                                                @RequestParam("version") String version) {
    Resource resource = apkUpdaterService.loadPackageAsResource(pkgname, version);
    ...
}
```

---

**B28-6** — HIGH
**Section:** 5. Data Exposure
**File:** `src/main/java/com/journaldev/spring/jdbc/service/LocalFileStorageService.java:24`
**Description:** The `FileNotFoundException` thrown when an image is not found constructs its message by concatenating the user-supplied `fileName` with the full resolved server-side filesystem path (`filePath.toString()`). Because `FileNotFoundException` carries `@ResponseStatus(HttpStatus.NOT_FOUND)` and no global `@ControllerAdvice` exception handler was found in the codebase, Spring MVC's default behaviour serialises the exception `message` (returned by `getMessage()`) into the HTTP 404 response body. This discloses: (1) the absolute server filesystem path of the storage directory, (2) the directory layout (e.g., `/var/local/tomcat8/upload/image/`), and (3) the user-supplied filename echoed back, which in a path traversal scenario would reveal attempted paths. The same pattern exists in `APKUpdaterService.loadPackageAsResource` (line 62).
**Evidence:**
```java
// LocalFileStorageService.java:24
throw new FileNotFoundException("Unable to find " + fileName + " at location : " + filePath.toString() + " on server");

// APKUpdaterService.java:62
throw new FileNotFoundException("Unable to find " + pkgname + ", version " + version + " at location : " + filePath.toString() + " on server");

// AbstractFileStorageService.java:72
throw new FileStorageException("Could not store file " + fileName + ". Please try again!", ex);
```

---

**B28-7** — HIGH
**Section:** 2. Authentication and Authorization
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/ImageController.java:29-32`
**Description:** The `ImageController` endpoint `/image/{fileName:.+}` serves files from the server filesystem with no visible authentication or authorisation check. No `@PreAuthorize`, no `@Secured`, and no Spring Security URL pattern restriction is apparent in this controller. Combined with the path traversal vulnerability in B28-4, an unauthenticated attacker can request arbitrary files from the server. Even absent path traversal, legitimate forklift operator images are served publicly without requiring a valid Cognito JWT. The `/rest/apk/{pkgname}/update` and `/rest/apk/{pkgname}` endpoints in `APKUpdaterController` also lack visible authentication enforcement at the controller level.
**Evidence:**
```java
// ImageController.java:22-33
@Controller
@Slf4j
public class ImageController {

    @Autowired
    @Qualifier("localFileStorage")
    private FileStorageService fileStorageService;

    @RequestMapping(value = "/image/{fileName:.+}", method = RequestMethod.GET)
    public ResponseEntity<Resource> downloadFile(@PathVariable("fileName") String fileName) {
        Resource resource = fileStorageService.loadImageAsResource(fileName);
        ...
    }
}
```
No `@PreAuthorize` or authentication annotation present.

---

**B28-8** — MEDIUM
**Section:** 5. Data Exposure
**File:** `src/main/java/com/journaldev/spring/jdbc/service/EntityNotFoundException.java:7-11` / `src/main/java/com/journaldev/spring/jdbc/DAO/DriverDAOImpl.java:112`
**Description:** `EntityNotFoundException` is annotated `@ResponseStatus(HttpStatus.NOT_FOUND)` and does not set the `reason` attribute of `@ResponseStatus`. Without a `reason`, Spring MVC uses the exception's `getMessage()` return value in the response. The message at the throw site includes the internal integer database primary key of the driver record: `"Unable to find driver for userId " + userId`. This leaks an internal surrogate key to API clients. Additionally, `DriverDAOImpl` throws `SQLException` with messages that include the driver ID (line 70, 84) and driver email address (line 97); if these propagate unhandled they may also surface in responses.
**Evidence:**
```java
// DriverDAOImpl.java:112
throw new EntityNotFoundException("Unable to find driver for userId " + userId);

// EntityNotFoundException.java:6-11
@ResponseStatus(HttpStatus.NOT_FOUND)
public class EntityNotFoundException extends RuntimeException {
    public EntityNotFoundException(String message) {
        super(message);
    }
}

// DriverDAOImpl.java:97
throw new SQLException("Unable to update driver password for driver " + email);
```

---

## Summary Table

| ID | Severity | Section | Short Description |
|---|---|---|---|
| B28-1 | CRITICAL | 1. Secrets | Hardcoded AWS IAM key ID and secret in `AWSFileStorageService.java` |
| B28-2 | HIGH | 1. Secrets | Cognito API plaintext credentials committed in all three environment property files |
| B28-3 | MEDIUM | 1. Secrets | Production EC2 hostname/IP committed to source control |
| B28-4 | HIGH | 3. Injection | Path traversal in `LocalFileStorageService.loadImageAsResource` — no boundary check after `resolve().normalize()` |
| B28-5 | HIGH | 3. Injection | Path traversal in `APKUpdaterService.loadPackageAsResource` — unsanitised `pkgname`/`version` used in path construction |
| B28-6 | HIGH | 5. Data Exposure | Full server filesystem path disclosed in `FileNotFoundException` message, serialised into HTTP responses |
| B28-7 | HIGH | 2. Auth/Authz | `/image/{fileName}` endpoint has no authentication enforcement; APK endpoints similarly unguarded |
| B28-8 | MEDIUM | 5. Data Exposure | `EntityNotFoundException` message includes internal DB primary key; driver email in `SQLException` message |
