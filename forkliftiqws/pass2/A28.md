# Audit Report A28 — Pass 2: Test Coverage
**Date:** 2026-02-27
**Agent:** A28
**Scope:** FileNotFoundException, FileStorageException, FileStorageService (interface)

---

## Reading Evidence

### 1. `FileNotFoundException.java`
**Path:** `src/main/java/com/journaldev/spring/jdbc/service/FileNotFoundException.java`

- **Class:** `FileNotFoundException` (public)
  - Extends: `FileStorageException`
  - Annotation: `@ResponseStatus(HttpStatus.NOT_FOUND)`
- **Methods:**
  - `FileNotFoundException(String message)` — line 9 (single-arg constructor, delegates to `super(message)`)
- **Types / Constants:**
  - `org.springframework.http.HttpStatus.NOT_FOUND` (HTTP 404 mapping via `@ResponseStatus`)
- **Inheritance:** Inherits `getMessage()`, `getCause()`, `printStackTrace()` etc. from `RuntimeException` via `FileStorageException`

---

### 2. `FileStorageException.java`
**Path:** `src/main/java/com/journaldev/spring/jdbc/service/FileStorageException.java`

- **Class:** `FileStorageException` (public)
  - Extends: `RuntimeException`
- **Fields:**
  - `private static final long serialVersionUID = 8988464861907090725L;` — line 5
- **Methods:**
  - `FileStorageException(String message)` — line 7 (single-arg constructor, delegates to `super(message)`)
  - `FileStorageException(String message, Throwable cause)` — line 11 (two-arg constructor, delegates to `super(message, cause)`)
- **Types / Constants:**
  - `serialVersionUID` = `8988464861907090725L`

---

### 3. `FileStorageService.java`
**Path:** `src/main/java/com/journaldev/spring/jdbc/service/FileStorageService.java`

- **Class:** `FileStorageService` (public interface)
- **Methods (contract):**
  - `String saveImage(InputStream inputStream)` — line 8
  - `Resource loadImageAsResource(String fileName)` — line 10
- **Types:**
  - `org.springframework.core.io.Resource`
  - `java.io.InputStream`
- **Implementations found:**
  - `AbstractFileStorageService` (abstract, `src/main/java/.../service/AbstractFileStorageService.java`) — implements `saveImage`; declared `@PostConstruct initialize()`
  - `LocalFileStorageService` (`@Service("localFileStorage")`) — extends `AbstractFileStorageService`, implements `loadImageAsResource`
  - `AWSFileStorageService` (`@Service("awsFileStorage")`) — extends `AbstractFileStorageService`, overrides `saveImage` and `loadImageAsResource` (stub: returns `null`)
- **Consumers (injection sites):**
  - `ImageController` — `@Qualifier("localFileStorage")`, calls `loadImageAsResource`
  - `DriverController` — calls `saveImage` (lines 144, 169)
  - `SessionController` — calls `saveImage` (line 69)
  - `ImpactController` — `@Qualifier("awsFileStorage")`, calls `saveImage` (lines 95, 96, 125)

---

## Test Coverage Analysis

### Test files scanned (exhaustive — only 3 exist)

| Test File | Classes Covered |
|---|---|
| `APKUpdaterServiceTest.java` | `APKUpdaterService` (all `@Test` methods commented out) |
| `PackageEntryTest.java` | `PackageEntry.compareTo()` |
| `DateUtilTest.java` | `DateUtil.parseDateIso`, `DateUtil.parseDateTimeIso` |

**Result:** Zero test files reference `FileNotFoundException`, `FileStorageException`, `FileStorageService`, `saveImage`, or `loadImageAsResource`. No indirect coverage exists anywhere in `src/test/java/`.

---

## Findings

---

### A28-1, Severity: CRITICAL
**No tests exist for `FileStorageService.saveImage(InputStream)` — the primary write path**

`FileStorageService.saveImage(InputStream)` is the core method responsible for persisting uploaded images to disk. It is invoked in at least four separate controller endpoints (`DriverController` lines 144 and 169, `SessionController` line 69, `ImpactController` lines 95, 96, and 125). The concrete implementation in `AbstractFileStorageService` contains two distinct error paths (`MimeTypeException | IOException` at line 60, `IOException` at line 71 throwing `FileStorageException`) and non-trivial logic including MIME-type detection via Apache Tika and filesystem operations via `java.nio.file.Files.copy`. Not a single test covers this method under any condition.

**Untested paths within `saveImage`:**
- Happy path: valid `InputStream` with detectable MIME type, file written successfully, filename returned.
- MIME detection failure (`MimeTypeException` / `IOException` on `guessContentTypeFromStream`): fallback to `.jpg` extension.
- `IOException` during `Files.copy`: `FileStorageException` thrown with message `"Could not store file ... Please try again!"`.
- Null or empty `InputStream` passed as argument.

---

### A28-2, Severity: CRITICAL
**No tests exist for `FileStorageService.loadImageAsResource(String)` — the primary read path**

`LocalFileStorageService.loadImageAsResource(String)` (lines 16–28) is the only non-stub implementation of this interface method. It contains three distinct outcomes: resource found and returned, resource not found (`FileNotFoundException` thrown, line 24), and malformed URL (`FileStorageException` thrown with chained `MalformedURLException`, line 27). `AWSFileStorageService.loadImageAsResource` returns `null` unconditionally (line 46) with no tests guarding this known-broken stub. No test covers any of these branches.

**Untested paths:**
- File exists at resolved path: `Resource` returned successfully.
- File does not exist at resolved path: `FileNotFoundException` thrown.
- `MalformedURLException` during `UrlResource` construction: `FileStorageException` thrown.
- Null filename argument.
- Path traversal / directory-escape attempt via `..` in `fileName`.

---

### A28-3, Severity: CRITICAL
**`AWSFileStorageService.loadImageAsResource` is a silent null-returning stub with no test and no guard**

`AWSFileStorageService.loadImageAsResource(String fileName)` at line 46 unconditionally returns `null`. All callers of `FileStorageService.loadImageAsResource` (`ImageController.downloadFile`, line 32) call `resource.getInputStream()` immediately after, which will throw a `NullPointerException` at runtime if the AWS-qualified bean is ever injected into `ImageController`. There is no test, no `@NotImplemented` marker, no `UnsupportedOperationException`, and no documentation. The contract defined by `FileStorageService` is silently violated.

---

### A28-4, Severity: HIGH
**`FileStorageException(String message, Throwable cause)` constructor is untested**

The two-argument constructor of `FileStorageException` (line 11) is the cause-chaining constructor. It is used in production code at `LocalFileStorageService` line 27 and `AbstractFileStorageService` line 72. No test verifies that the cause is correctly propagated to `RuntimeException.getCause()`. While the body is a trivial `super()` delegation, the absence of any test means regressions (e.g., an accidental future change to constructor signature) will not be caught.

---

### A28-5, Severity: HIGH
**`FileNotFoundException` is never directly tested; `@ResponseStatus` mapping is unverified**

`FileNotFoundException` (line 7) carries a `@ResponseStatus(HttpStatus.NOT_FOUND)` annotation. This annotation drives Spring MVC's automatic HTTP 404 response conversion when the exception propagates out of a controller. No test verifies: (a) that the constructor correctly passes the message to `FileStorageException` and ultimately to `RuntimeException.getMessage()`, (b) that the `@ResponseStatus` annotation is present and maps to `404`, or (c) that Spring's exception resolution machinery correctly converts a thrown `FileNotFoundException` into an HTTP 404 response at the controller layer.

---

### A28-6, Severity: HIGH
**`AbstractFileStorageService.initialize()` (`@PostConstruct`) error path is untested**

The `@PostConstruct` method `initialize()` at line 43 calls `Files.createDirectories(imageStorageLocation)`. If the filesystem operation fails, a `FileStorageException` is thrown (line 48) with the message `"Could not save the directory where the uploaded files will be stored."`. No test exercises startup failure behavior: a corrupt/inaccessible `uploadDir` configuration will cause the Spring context to fail to start with no test safety net.

---

### A28-7, Severity: MEDIUM
**`FileStorageService` interface is not tested via any mock or integration harness**

The `FileStorageService` interface defines the contract for all file storage operations. No test file mocks this interface or verifies that any controller (`DriverController`, `SessionController`, `ImpactController`, `ImageController`) correctly invokes its methods, handles returned values, or propagates exceptions to callers. All four controllers inject this service but none are covered by a `@WebMvcTest` or `@SpringBootTest` integration test.

---

### A28-8, Severity: MEDIUM
**`FileStorageException(String message)` single-arg constructor is untested**

The single-argument constructor of `FileStorageException` (line 7) is used directly by `FileNotFoundException` (via `super(message)`, line 10) and indirectly throughout the codebase. No test verifies the message is correctly stored and retrievable via `getMessage()`. This is especially relevant given that error messages are interpolated with dynamic filenames and paths in production code, making the message content observable by callers and clients.

---

### A28-9, Severity: MEDIUM
**`saveImage` MIME-type detection silent-fallback path creates an observable behavior gap**

In `AbstractFileStorageService.saveImage` (lines 54–62), when MIME-type detection fails (`MimeTypeException` or `IOException`), the code silently falls back to `.jpg` extension and logs a warning. No test verifies this fallback, meaning: a non-image binary payload, a corrupted stream, or an unsupported MIME type will silently produce a `.jpg`-named file regardless of actual content. This fallback behavior is a security and correctness concern that has no test coverage.

---

### A28-10, Severity: MEDIUM
**`serialVersionUID` in `FileStorageException` is inconsistent with its non-serialized runtime use**

`FileStorageException` declares `serialVersionUID = 8988464861907090725L` (line 5) but is used exclusively as a runtime exception — it is never serialized. The `serialVersionUID` value is an explicit literal rather than the JVM-computed default, meaning any future field additions (e.g., adding an error code field) without updating `serialVersionUID` would silently produce an incompatible serial form. No test validates serialization round-trip behavior. While low risk in current usage, it represents a latent defect if the exception is ever serialized (e.g., across RMI or in a distributed context).

---

### A28-11, Severity: LOW
**`FileStorageService` interface lacks a `@NotNull` / `@NonNull` contract on method parameters and return values**

`saveImage(InputStream inputStream)` and `loadImageAsResource(String fileName)` have no null-constraint annotations. `AWSFileStorageService.loadImageAsResource` legally returns `null` under the current interface contract. No tests assert null-safety preconditions, and no defensive null-checks exist at injection sites. A `@NonNull` annotation (JSR-305 or Lombok) on both parameters and return types, backed by tests, would prevent the class of `NullPointerException` already observed in A28-3.

---

### A28-12, Severity: LOW
**`FileNotFoundException` has no `serialVersionUID` field**

`FileNotFoundException` extends `FileStorageException` (which is itself `Serializable` by extension of `RuntimeException`). It does not declare its own `serialVersionUID`, so the JVM will compute one from the class structure. Any change to the class (e.g., adding a field or constructor) will silently change the computed UID, potentially causing `InvalidClassException` in serialization scenarios. The parent class explicitly declares `serialVersionUID` but the child does not follow suit. No test catches this inconsistency.

---

## Summary Table

| ID | Severity | Description |
|---|---|---|
| A28-1 | CRITICAL | `saveImage(InputStream)` — zero tests, all branches uncovered |
| A28-2 | CRITICAL | `loadImageAsResource(String)` — zero tests, all branches uncovered |
| A28-3 | CRITICAL | `AWSFileStorageService.loadImageAsResource` returns `null` unconditionally; no test, no guard |
| A28-4 | HIGH | `FileStorageException(String, Throwable)` cause-chaining constructor untested |
| A28-5 | HIGH | `FileNotFoundException` constructor and `@ResponseStatus(404)` mapping untested |
| A28-6 | HIGH | `@PostConstruct initialize()` failure path (`FileStorageException`) untested |
| A28-7 | MEDIUM | No controller-level integration or mock tests for any `FileStorageService` consumer |
| A28-8 | MEDIUM | `FileStorageException(String)` single-arg constructor untested |
| A28-9 | MEDIUM | MIME-type detection silent fallback to `.jpg` untested |
| A28-10 | MEDIUM | `serialVersionUID` declared but serialization behavior never tested |
| A28-11 | LOW | No null-safety contract on interface methods; `null` return legally permitted |
| A28-12 | LOW | `FileNotFoundException` missing `serialVersionUID` |

**Total findings: 12 (3 CRITICAL, 3 HIGH, 4 MEDIUM, 2 LOW)**
**Test coverage for these three source files: 0%**
