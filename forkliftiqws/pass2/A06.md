# A06 - Pass 2: Test Coverage Audit
**Agent:** A06
**Pass:** 2 (Test Coverage)
**Date:** 2026-02-27
**Scope:** DatabaseCleanupException, DatabaseController, DriverController

---

## 1. Reading Evidence

### 1.1 DatabaseCleanupException
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/DatabaseCleanupException.java`

- **Class:** `DatabaseCleanupException extends RuntimeException`
- **Annotation:** `@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)`
- **Methods:**
  - `DatabaseCleanupException(String message)` — line 8 (constructor, delegates to `super(message)`)
- **Types/Constants imported:** `org.springframework.http.HttpStatus`, `org.springframework.web.bind.annotation.ResponseStatus`
- **Error mappings:** HTTP 500 INTERNAL_SERVER_ERROR mapped via `@ResponseStatus`

---

### 1.2 DatabaseController
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/DatabaseController.java`

- **Class:** `DatabaseController extends ConfigurationController`
- **Annotations:** `@Slf4j`, `@Controller`
- **Methods:**
  - `cleanup()` — line 64; `@RequestMapping(POST /rest/db/cleanup)`, `@ResponseStatus(HttpStatus.OK)`
  - `deleteCompanies(JdbcTemplate, int, List<Long>, List<Long>)` — line 84; private, recursive
- **Constants:**
  - `QUERY_COMPANIES_TO_DELETE` — line 18; large multi-clause SQL string constant (static final)
- **Types imported:** `JdbcTemplate`, `ArrayList`, `List`, `HttpStatus`, `Slf4j`
- **Error paths observed:**
  - Line 71–73: `catch(Exception e)` on JDBC query — logs error, `companies` remains `null`
  - Line 79–81: if `errors` is non-empty after `deleteCompanies`, throws `DatabaseCleanupException`
  - Line 89–91: `catch(Exception e)` on `jdbcTemplate.execute(delete_company(...))` — adds `c` to `errors`
  - Line 94–98: recursive retry up to pass 3; on retry, clears `errors` then passes `errors` (now empty) as the list to re-process
  - Line 99: logs remaining undeleted company IDs on final pass exhaustion
- **Logic defects identified (factual, not fixes):**
  - Line 97: `errors.clear()` is called immediately before `deleteCompanies(... errors, errors)` — the companies list passed for re-processing is the same (now-empty) reference as `errors`, meaning retry passes process zero companies

---

### 1.3 DriverController
**File:** `src/main/java/com/journaldev/spring/jdbc/controller/DriverController.java`

- **Class:** `DriverController extends ConfigurationController`
- **Annotations:** `@Controller`, `@Slf4j`
- **Fields:**
  - `fileStorageService` — `@Autowired @Qualifier("localFileStorage") FileStorageService`
  - `driverService` — `@Autowired DriverService`
  - `driverDAO` — `@Autowired DriverDAO`
  - `gson` — `Gson` (instance field, not injected)
- **Methods:**
  - `getLoginAuth(Driver)` — line 59; `@Deprecated`, POST `/rest/appuser/validate`
  - `registerDrivers(Driver)` — line 77; POST `/rest/appuser/register`
  - `resetPassword(Driver)` — line 91; POST `/rest/appuser/reset`
  - `acceptDrivers(int[])` — line 108; PUT `/rest/users/permission/acceptall/{pids}`
  - `declineDriver(int[])` — line 120; DELETE `/rest/users/permission/deleteall/{pids}`
  - `uploadProfile(int, MultipartFile, String)` — line 132; POST `/rest/appuser/photo/{uid}` (multipart)
  - `uploadProfileAPP(int, MultipartFile)` — line 163; POST `/rest/appuser/photo/app/{uid}` (multipart)
  - `saveEmails(DriverEmails)` — line 187; POST `/rest/appuser/emails`
  - `getEmails(int)` — line 209; GET `/rest/appuser/emails/get/{uid}`
  - `getDriver(int)` — line 228; GET `/rest/appuser/get/{uid}`
  - `saveLicence(Driver)` — line 235; POST `/rest/licence/save`
  - `updateDrivers(Driver)` — line 253; POST `/rest/appuser/update/{uid}`
- **Types imported:** `BufferedInputStream`, `ByteArrayInputStream`, `IOException`, `InputStream`, `Collections`, `Date`, `List`, `Optional`, `ResponseEntity`, `JdbcTemplate`, `BeanPropertyRowMapper`, `Base64`, `MultipartFile`, `Gson`, `DriverDAO`, `Driver`, `DriverEmails`, `Results`, `DriverService`, `DriverServiceException`, `FileStorageService`, `DateUtil`
- **Error paths observed:**
  - `getLoginAuth`: returns `HttpStatus.BAD_GATEWAY` when `optDriver` is not present (line 71)
  - `registerDrivers`: catches `DriverServiceException`, returns `HttpStatus.BAD_GATEWAY` (line 82–84)
  - `resetPassword`: catches `DriverServiceException`, returns `HttpStatus.BAD_GATEWAY` with `MSGID_LOGICERRORR` / `ERRORMSG_LOGICERRORR` (line 96–99)
  - `uploadProfile`: catches `IOException`, returns `HttpStatus.BAD_GATEWAY` with `MSGID_CODEERRORR` / `ERRORMSG_CODEERRORR` (line 153–158); calls `e.printStackTrace()` rather than logging
  - `uploadProfileAPP`: catches `IOException`, returns `HttpStatus.BAD_GATEWAY` (line 178–182); no `e.printStackTrace()` call
  - `saveEmails`: no exception handling — any JDBC error propagates uncaught
  - `getEmails`: no exception handling — any JDBC error propagates uncaught
  - `saveLicence`: no exception handling — any JDBC or `DateUtil.parseDateIso` error propagates uncaught
  - `updateDrivers`: no exception handling — any JDBC or `DateUtil.parseDateIso` error propagates uncaught
  - `acceptDrivers`: no exception handling — any JDBC error propagates uncaught
  - `declineDriver`: no exception handling — any JDBC error propagates uncaught

---

## 2. Test Coverage Search Results

**Test files found under `src/test/java/`:**
- `com/journaldev/spring/jdbc/model/PackageEntryTest.java`
- `com/journaldev/spring/jdbc/service/APKUpdaterServiceTest.java` (all test methods commented out)
- `com/journaldev/spring/jdbc/util/DateUtilTest.java`

**Search result — pattern `DatabaseCleanupException|DatabaseController|DriverController` in test sources:** No matches found.

**Search result — pattern of all controller method names in test sources:** No matches found.

**Conclusion:** Zero test coverage exists for all three audited files. No direct test classes, no indirect references.

---

## 3. Findings

---

### A06-1 — Severity: CRITICAL

**Title:** DatabaseController and DriverController have zero test coverage

**Detail:** No test class exists — directly or indirectly — for `DatabaseController`, `DatabaseCleanupException`, or `DriverController`. The three files collectively contain 14 public/package-accessible methods plus one constructor. None appear in any test source file. The only test files present cover unrelated model and utility classes.

**Affected files:**
- `src/main/java/com/journaldev/spring/jdbc/controller/DatabaseCleanupException.java`
- `src/main/java/com/journaldev/spring/jdbc/controller/DatabaseController.java`
- `src/main/java/com/journaldev/spring/jdbc/controller/DriverController.java`

---

### A06-2 — Severity: CRITICAL

**Title:** `deleteCompanies` retry logic is broken — passes an empty list on every retry

**Detail:** In `DatabaseController.deleteCompanies()` at line 96–97, when `pass < 3` and errors exist, the code calls `errors.clear()` then immediately passes `errors` as both the errors accumulator and the companies list to the recursive call. Since `errors` was just cleared, the retry always processes zero companies. The retry mechanism (`pass < 3`) is therefore dead code — it can never re-attempt deletion of failed companies.

**Affected method:** `deleteCompanies(JdbcTemplate, int, List<Long>, List<Long>)` — lines 94–98

**Untested path:** The retry branch (pass 2 and pass 3) is never exercised by any test and is logically unreachable in practice due to the defect.

---

### A06-3 — Severity: CRITICAL

**Title:** `cleanup()` does not guard against `null` companies list before calling `deleteCompanies`

**Detail:** In `DatabaseController.cleanup()`, if the JDBC query at line 68–70 throws an exception, `companies` remains `null` (line 66). The `catch` block at line 71–73 only logs and does not set `companies` to an empty list or return early. Execution then falls through to line 77: `deleteCompanies(jdbcTemplate, pass, errors, companies)`, which calls `companies.forEach(...)` at line 86 — a guaranteed `NullPointerException` at runtime. No test exercises the JDBC-failure path of `cleanup()`.

**Affected method:** `cleanup()` — lines 66–77

---

### A06-4 — Severity: HIGH

**Title:** `DatabaseCleanupException` constructor is never tested

**Detail:** `DatabaseCleanupException(String message)` is a custom `RuntimeException` decorated with `@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)`. No test verifies that instantiation works, that the message is preserved via `super(message)`, or that the `@ResponseStatus` annotation produces the correct HTTP 500 response in a Spring MVC context.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/controller/DatabaseCleanupException.java` — line 8

---

### A06-5 — Severity: HIGH

**Title:** All `DriverController` error response paths are untested

**Detail:** The following error paths exist in `DriverController` and have no test coverage whatsoever:

| Method | Error Path | HTTP Response |
|---|---|---|
| `getLoginAuth` | `optDriver` is empty | 502 BAD_GATEWAY |
| `registerDrivers` | `DriverServiceException` thrown | 502 BAD_GATEWAY |
| `resetPassword` | `DriverServiceException` thrown | 502 BAD_GATEWAY |
| `uploadProfile` | `IOException` from `file.getInputStream()` or `saveImage` | 502 BAD_GATEWAY |
| `uploadProfile` | `IOException` from `fis.close()` | 502 BAD_GATEWAY |
| `uploadProfileAPP` | `IOException` from `file.getInputStream()` or `saveImage` | 502 BAD_GATEWAY |

None of these paths are covered by any test.

---

### A06-6 — Severity: HIGH

**Title:** Six `DriverController` methods have no exception handling and are entirely untested

**Detail:** The following methods execute JDBC operations with no `try/catch`. Any `DataAccessException` or related runtime exception will propagate to the Spring dispatcher uncaught, producing an uncontrolled HTTP 500 response. No test exists to verify either happy-path or error-path behavior.

- `acceptDrivers(int[])` — lines 108–116; iterates JDBC updates with no error handling
- `declineDriver(int[])` — lines 120–128; iterates JDBC deletes with no error handling
- `saveEmails(DriverEmails)` — lines 187–205; JDBC query + insert/update with no error handling
- `getEmails(int)` — lines 209–224; JDBC query with no error handling
- `saveLicence(Driver)` — lines 235–249; JDBC insert/update, `DateUtil.parseDateIso` call with no error handling
- `updateDrivers(Driver)` — lines 253–265; JDBC update, `DateUtil.parseDateIso` call with no error handling

---

### A06-7 — Severity: HIGH

**Title:** `getLoginAuth` is marked `@Deprecated` and remains in production with no test coverage

**Detail:** `getLoginAuth(Driver)` at line 59 is annotated `@Deprecated` but is still a mapped, active endpoint (`POST /rest/appuser/validate`). No test exists to confirm its behavior or to document expected responses for the deprecated flow, and no test exists to confirm it is safe to remove. Deprecated endpoints without tests create an unverifiable removal risk.

---

### A06-8 — Severity: HIGH

**Title:** `saveLicence` and `updateDrivers` accept user-controlled date strings parsed via `DateUtil.parseDateIso` with no error handling

**Detail:** `saveLicence` (line 238) and `updateDrivers` (line 259) call `DateUtil.parseDateIso(...)` on values sourced directly from the request body. `DateUtilTest` confirms that `parseDateIso` throws `IllegalArgumentException` for invalid date strings. Neither controller method catches this exception; an invalid date in the request body will produce an unhandled exception. No test covers this path.

---

### A06-9 — Severity: MEDIUM

**Title:** `uploadProfile` uses `e.printStackTrace()` instead of the injected logger

**Detail:** In `uploadProfile` at line 154, an `IOException` is handled with `e.printStackTrace()`, bypassing the `@Slf4j`-injected logger (`log`) used consistently elsewhere in the same class. This means the exception will appear on stdout/stderr rather than in the structured application log. `uploadProfileAPP` (the parallel method) correctly omits `printStackTrace`. No test exercises this path to detect or verify the discrepancy.

**Affected method:** `uploadProfile(int, MultipartFile, String)` — line 154

---

### A06-10 — Severity: MEDIUM

**Title:** `uploadProfile` base64 crop-image path is entirely untested

**Detail:** In `uploadProfile` at lines 140–143, when `cropImage` is not blank the code extracts a base64-encoded image, decodes it with `Base64.decode(...)`, and wraps it in a `ByteArrayInputStream`. This branch is the primary functional path for cropped profile images. No test exercises this branch, including: empty `cropImage`, a valid base64 string, a malformed base64 string, or a string with no comma separator (causing `substring` to behave unexpectedly if `indexOf(",")` returns -1).

---

### A06-11 — Severity: MEDIUM

**Title:** `saveEmails` insert/update branch logic is untested for both paths

**Detail:** `saveEmails` at lines 195–201 queries `count(*)` to determine whether to INSERT or UPDATE driver emails. No test covers:
- The insert path (count == 0)
- The update path (count > 0)
- Behavior when `queryForObject` returns null (potential `NullPointerException` on auto-unbox at line 194)
- Behavior when `driver_emails` contains null email address fields

---

### A06-12 — Severity: MEDIUM

**Title:** `getEmails` returns an empty `DriverEmails` object when no record is found — untested

**Detail:** `getEmails` at lines 217–221 constructs a new empty `DriverEmails` object when the query returns no results. No test verifies: the empty-result path, the populated-result path, or the response HTTP status (always 200 even when no record exists, which may mask a not-found condition).

---

### A06-13 — Severity: MEDIUM

**Title:** `QUERY_COMPANIES_TO_DELETE` SQL constant contains duplicate MAC address entry

**Detail:** In `DatabaseController` at lines 45–46, the MAC address `'00:07:80:AD:99:D0'` appears twice in the IN-list. This is a data defect in the hardcoded SQL constant. While not a test-coverage finding per se, no test exists to validate the query structure or its result set, making this defect undetectable through automated means.

---

### A06-14 — Severity: LOW

**Title:** `acceptDrivers` and `declineDriver` always return hard-coded integer `1`

**Detail:** Both `acceptDrivers` (line 115) and `declineDriver` (line 127) return the literal value `1` regardless of how many rows were actually affected by the JDBC update/delete operations. The JDBC `update()` return value (actual rows affected) is discarded. No test exists to expose or document this behavior, and callers cannot distinguish a successful multi-row update from a no-op.

---

### A06-15 — Severity: LOW

**Title:** `RuntimeConfig` contains hardcoded credentials and external API keys exposed in source

**Detail:** `RuntimeConfig.java` (referenced by `DriverController`) contains hardcoded values including `PASSWORD = "OVLOaICXccaNUS"`, `GCMKEY = "key=AIzaSyDDuQUYLcXkutyIxRToLAeBPHBQNLfayzs"`, and `API_ID = "3629505"`. No test verifies that these are environment-sourced at runtime; they are static string literals. This is noted here as the `RuntimeConfig` constants are consumed directly by `DriverController` error responses.

---

## 4. Summary Table

| Finding | Severity | Area |
|---|---|---|
| A06-1 | CRITICAL | Zero test coverage for all three audited files |
| A06-2 | CRITICAL | `deleteCompanies` retry logic always re-processes empty list |
| A06-3 | CRITICAL | `cleanup()` NPE when JDBC query fails — `null` companies list passed to forEach |
| A06-4 | HIGH | `DatabaseCleanupException` constructor and `@ResponseStatus` never tested |
| A06-5 | HIGH | All `DriverController` error (BAD_GATEWAY) paths untested |
| A06-6 | HIGH | Six methods with no exception handling and no tests |
| A06-7 | HIGH | `@Deprecated` endpoint active in production with no test coverage |
| A06-8 | HIGH | `IllegalArgumentException` from invalid dates not caught in two methods |
| A06-9 | MEDIUM | `e.printStackTrace()` used instead of structured logger in `uploadProfile` |
| A06-10 | MEDIUM | Base64 crop-image branch in `uploadProfile` entirely untested |
| A06-11 | MEDIUM | `saveEmails` INSERT/UPDATE branch logic untested; potential NPE on unbox |
| A06-12 | MEDIUM | `getEmails` empty-result and populated-result paths untested |
| A06-13 | MEDIUM | Duplicate MAC address in SQL constant; no query validation tests |
| A06-14 | LOW | `acceptDrivers`/`declineDriver` discard actual rows-affected, always return 1 |
| A06-15 | LOW | Hardcoded credentials in `RuntimeConfig` consumed by controller without tests |
