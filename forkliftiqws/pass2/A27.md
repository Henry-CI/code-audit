# Audit Report A27 - Pass 2: Test Coverage
**Date:** 2026-02-27
**Agent:** A27
**Scope:** DriverService, DriverServiceException, EntityNotFoundException

---

## Reading Evidence

### File 1: DriverService.java
**Path:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`

**Class:** `DriverService` (lines 27-122)
- Annotations: `@Slf4j`, `@Service`, `@Transactional`

**Constants:**
- `PASSWORD_GEN_RULES` (line 29-34): `static final CharacterRule[]` - array of 4 rules (UpperCase min 1, LowerCase min 1, Digit min 1, Special min 1)
- `PASSWORD_LENGTH` (line 37): `static final int = 8`

**Fields (autowired):**
- `userDAO` (line 40): `UserDAO`
- `companyDAO` (line 43): `CompanyDAO`
- `configuration` (line 46): `Configuration`
- `driverDAO` (line 49): `DriverDAO`

**Methods:**

| Method | Line | Visibility | Notes |
|--------|------|------------|-------|
| `authenticate(String email, String password)` | 52-64 | `public` | `@Deprecated` - returns `Optional<Driver>` |
| `registerDriver(Driver driver)` | 66-97 | `public` | returns `Driver` |
| `resetPassword(Driver driver)` | 99-117 | `public` | `throws DriverServiceException` |
| `generateRandomPassword()` | 119-121 | `private` | returns `String` |

**Error/Exception paths in DriverService:**
- Line 59: `throw new DriverServiceException("Unable to update last login time for the driver " + email, e)` - inside `authenticate()` on `SQLException` from `updateLastLoginTime()`
- Line 69: `throw new DriverAlreadyExistException("Driver already exist in database with : " + driver.getEmail())` - inside `registerDriver()` when driver already exists
- Line 74: `orElseThrow(IllegalStateException::new)` - inside `registerDriver()` when `ROLE_COMPANY_GROUP` role not found in `userDAO`
- Line 115: `throw new DriverServiceException("Unable to reset password for given driver email " + driver.getEmail(), e)` - inside `resetPassword()` on `SQLException` from `updatePassword()`

**Types referenced:**
- `DriverDAO`, `CompanyDAO`, `UserDAO`
- `Driver`, `Company`, `Roles`, `Roles.RoleId.ROLE_COMPANY_GROUP`
- `Configuration`, `SendEmail`
- `CharacterRule`, `EnglishCharacterData`, `PasswordGenerator` (passay library)
- `Optional`, `SQLException`
- `DriverServiceException`, `DriverAlreadyExistException`

---

### File 2: DriverServiceException.java
**Path:** `src/main/java/com/journaldev/spring/jdbc/service/DriverServiceException.java`

**Class:** `DriverServiceException extends RuntimeException` (lines 3-12)

**Methods:**

| Method | Line | Visibility | Notes |
|--------|------|------------|-------|
| `DriverServiceException(String message)` | 5-7 | `public` | single-arg constructor |
| `DriverServiceException(String message, Throwable cause)` | 9-11 | `public` | two-arg constructor with cause chaining |

**Types referenced:**
- `RuntimeException`

---

### File 3: EntityNotFoundException.java
**Path:** `src/main/java/com/journaldev/spring/jdbc/service/EntityNotFoundException.java`

**Class:** `EntityNotFoundException extends RuntimeException` (lines 7-12)
- Annotation: `@ResponseStatus(HttpStatus.NOT_FOUND)`

**Methods:**

| Method | Line | Visibility | Notes |
|--------|------|------------|-------|
| `EntityNotFoundException(String message)` | 9-11 | `public` | single-arg constructor |

**Types referenced:**
- `RuntimeException`
- `HttpStatus.NOT_FOUND`
- `@ResponseStatus` (Spring Web)

---

### Related Class (context): DriverAlreadyExistException.java
**Path:** `src/main/java/com/journaldev/spring/jdbc/service/DriverAlreadyExistException.java`

**Class:** `DriverAlreadyExistException extends DriverServiceException` (lines 3-12)

**Methods:**

| Method | Line | Visibility | Notes |
|--------|------|------------|-------|
| `DriverAlreadyExistException(String message)` | 5-7 | `public` | single-arg constructor |
| `DriverAlreadyExistException(String message, Throwable cause)` | 9-11 | `public` | two-arg constructor - never called anywhere |

---

## Test Coverage Search Results

**Test files found under `src/test/java/`:**
1. `PackageEntryTest.java` - covers `PackageEntry.compareTo()`
2. `APKUpdaterServiceTest.java` - all test methods are commented out; effectively empty
3. `DateUtilTest.java` - covers `DateUtil.parseDateIso()` and `parseDateTimeIso()`

**Grep results for DriverService coverage:**
- Pattern `DriverService` in `src/test/`: **No matches**
- Pattern `DriverServiceException` in `src/test/`: **No matches**
- Pattern `EntityNotFoundException` in `src/test/`: **No matches**
- Pattern `authenticate|registerDriver|resetPassword|PASSWORD_LENGTH|PASSWORD_GEN_RULES` in `src/test/`: **No matches**

**Conclusion:** Zero test coverage exists for all three audited source files.

---

## Findings

### A27-1, Severity: CRITICAL
**Title:** No test coverage for `DriverService` - entire class is untested

`DriverService` is a `@Service` bean containing all driver authentication, registration, and password reset business logic. No unit or integration test file references this class. All four methods (`authenticate`, `registerDriver`, `resetPassword`, `generateRandomPassword`) are completely untested.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`

---

### A27-2, Severity: CRITICAL
**Title:** `authenticate()` SQLException error path is untested

`authenticate()` at line 58-60 catches `SQLException` thrown by `driverDAO.updateLastLoginTime()` and re-throws a `DriverServiceException`. This error path is never exercised in any test. A database failure during login timestamp update would produce an unverified exception chain.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, line 58-60

---

### A27-3, Severity: CRITICAL
**Title:** `registerDriver()` - `IllegalStateException` thrown on missing `ROLE_COMPANY_GROUP` is untested

At line 74, when the driver is a contact person, `userDAO.findByAuthority(ROLE_COMPANY_GROUP.getId())` is called with `.orElseThrow(IllegalStateException::new)`. If the role row does not exist in the database, an unchecked `IllegalStateException` propagates uncaught through the `@Transactional` boundary. No test covers this path and no documentation or `throws` declaration describes this failure mode to callers.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, line 74

---

### A27-4, Severity: HIGH
**Title:** `registerDriver()` happy-path for contact person (company creation branch) is untested

The conditional branch at lines 73-80 (driver is a contact person) exercises `companyDAO.save()` and `driver.setComp_id()`. The non-contact-person path and the contact-person path are both untested. Any regression in company creation or role assignment would go undetected.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, lines 73-80

---

### A27-5, Severity: HIGH
**Title:** `registerDriver()` sends email as a side effect with no test verification or mocking

`SendEmail.sendMail()` is called unconditionally at line 86 for every successful registration. No test mocks or stubs this static call. This means any unit test would attempt to send a real email, and the email-sending side effect has never been asserted or verified to use correct subject/body content from `configuration`.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, lines 82-87

---

### A27-6, Severity: HIGH
**Title:** `resetPassword()` error path (SQLException from `updatePassword`) is untested

At line 114-116, a `SQLException` from `driverDAO.updatePassword()` is caught and wrapped in a `DriverServiceException`. This catch block is never exercised. If the password update fails at the database layer, the exception wrapping and message formatting at line 115 are unverified.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, lines 114-116

---

### A27-7, Severity: HIGH
**Title:** `resetPassword()` sends email with generated password in plaintext with no test verification

At lines 111-112, `SendEmail.sendMail()` is called with the new plaintext password embedded in the message body. No test verifies that the correct password is included, that the correct subject line from `configuration.getPassResetSubject()` is used, or that the recipient email address matches the driver's email. A regression in message composition would be undetected.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, lines 108-112

---

### A27-8, Severity: HIGH
**Title:** `authenticate()` is `@Deprecated` but remains in production code with no retirement test or removal plan

The `authenticate()` method (line 51-64) is marked `@Deprecated` and is still called by `DriverController.getLoginAuth()` which is itself `@Deprecated` (controller line 58). No test exists that verifies the deprecated path still functions correctly in its current state, nor is there evidence of a replacement path being tested. Deprecated but untested production code poses a regression risk if it continues to handle real traffic.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, lines 51-64

---

### A27-9, Severity: MEDIUM
**Title:** `generateRandomPassword()` password policy rules are untested

`generateRandomPassword()` (lines 119-121) applies four `CharacterRule` constraints (uppercase, lowercase, digit, special character, minimum one each) and a fixed length of 8 characters. No test verifies that the generated password actually satisfies these rules, that the length is exactly 8, or that the passay library configuration is correct. A misconfiguration would silently produce non-compliant passwords.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, lines 29-37, 119-121

---

### A27-10, Severity: MEDIUM
**Title:** `DriverServiceException` two-arg constructor cause-chaining is untested

`DriverServiceException(String message, Throwable cause)` at lines 9-11 is used in multiple throw sites. No test verifies that the `cause` is correctly chained (i.e., `getCause()` returns the original exception), which is important for diagnostic logging and error handling in callers.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverServiceException.java`, lines 9-11

---

### A27-11, Severity: MEDIUM
**Title:** `EntityNotFoundException` `@ResponseStatus(HttpStatus.NOT_FOUND)` mapping is untested

`EntityNotFoundException` is annotated with `@ResponseStatus(HttpStatus.NOT_FOUND)`. No test verifies that when this exception is thrown (e.g., from `DriverDAOImpl.findByID()` at line 112 of that class), the HTTP response code is actually `404`. The Spring MVC exception mapping could be bypassed if a `@ControllerAdvice` overrides the annotation behavior, and this is never asserted.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/EntityNotFoundException.java`, lines 6-12

---

### A27-12, Severity: MEDIUM
**Title:** `DriverAlreadyExistException` two-arg constructor is dead code

`DriverAlreadyExistException(String message, Throwable cause)` at lines 9-11 is never called anywhere in the codebase. The only usage of this exception class is at `DriverService` line 69 using the single-arg constructor. The two-arg constructor is untested dead code.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverAlreadyExistException.java`, lines 9-11

---

### A27-13, Severity: MEDIUM
**Title:** `registerDriver()` null-driver and null-email edge cases are untested

`registerDriver()` at line 68 calls `driver.getEmail()` without a null guard on either `driver` or `driver.getEmail()`. A null `Driver` argument or a `Driver` with a null email would produce a `NullPointerException` before reaching any validation. No test covers null input to this method.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, line 68

---

### A27-14, Severity: LOW
**Title:** `new Long(compId)` uses deprecated constructor

At line 79, `driver.setComp_id(new Long(compId))` uses the `Long(int)` constructor which was deprecated in Java 9 and removed in Java 17. No test catches this as a compilation or runtime failure if the target JDK is updated. The correct form is `Long.valueOf(compId)`.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, line 79

---

### A27-15, Severity: LOW
**Title:** Commented-out SMS notification code represents an untested, unremoved dead branch

Lines 88-93 contain a commented-out block that previously sent an SMS notification via `SendMessage`. Its removal is partial - the comment and dead code remain without a tracking ticket or explanation. If SMS capability is restored, the code path would be introduced without any test scaffolding in place.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/service/DriverService.java`, lines 88-93

---

## Summary Table

| Finding | Severity | Description |
|---------|----------|-------------|
| A27-1 | CRITICAL | Entire `DriverService` class has zero test coverage |
| A27-2 | CRITICAL | `authenticate()` SQLException path untested |
| A27-3 | CRITICAL | `registerDriver()` missing role throws unhandled `IllegalStateException` |
| A27-4 | HIGH | Contact person / company creation branch untested |
| A27-5 | HIGH | `SendEmail.sendMail()` static side effect not mocked or asserted in any test |
| A27-6 | HIGH | `resetPassword()` SQLException catch block untested |
| A27-7 | HIGH | `resetPassword()` email content and recipient address unverified |
| A27-8 | HIGH | Deprecated `authenticate()` still in production with no coverage |
| A27-9 | MEDIUM | Password generation policy compliance not tested |
| A27-10 | MEDIUM | `DriverServiceException` cause chaining not asserted |
| A27-11 | MEDIUM | `EntityNotFoundException` HTTP 404 mapping not verified by any test |
| A27-12 | MEDIUM | `DriverAlreadyExistException` two-arg constructor is dead untested code |
| A27-13 | MEDIUM | Null driver / null email edge cases not covered |
| A27-14 | LOW | Deprecated `new Long(int)` constructor used, uncaught by tests |
| A27-15 | LOW | Commented-out SMS code is unremoved dead code without test scaffolding |
