# A07 - Pass 2: Test Coverage Audit
**Source Files:**
1. `src/main/java/com/journaldev/spring/jdbc/controller/EquipmentController.java`
2. `src/main/java/com/journaldev/spring/jdbc/controller/ImageController.java`
3. `src/main/java/com/journaldev/spring/jdbc/controller/ImpactController.java`

**Audit Date:** 2026-02-27
**Auditor:** A07

---

## Reading Evidence

### File 1: EquipmentController.java

**Class:** `EquipmentController extends ConfigurationController`
**Package:** `com.journaldev.spring.jdbc.controller`
**Annotations:** `@Controller`

**Methods:**

| Line | Method Signature | HTTP Mapping |
|------|-----------------|--------------|
| 36 | `getEquipmentByUser(@PathVariable("uid") int uid)` | GET `/rest/equipment/get/{uid}` |
| 44 | `addEquipment(@RequestBody Equipment equipment)` | POST `/rest/equip/add` |
| 78 | `getManufactureList(Authentication authentication)` | GET `/rest/manu/get` |
| 86 | `getTypeList(@PathVariable("mid") int mid)` | GET `/rest/type/get/{mid}` |
| 105 | `getFuelTypeList(@PathVariable("mid") int manuId, @PathVariable("tid") int typeID)` | GET `/rest/fuletype/get/manuid/{mid}/typeid/{tid}` |
| 123 | `getService(@PathVariable("uid") int uid)` | GET `/rest/service/get/{uid}` |
| 142 | `SaveService(@RequestBody Services services)` | POST `/rest/service/save` |

**Return Types:** `ResponseEntity<List<DriverEquipment>>`, `ResponseEntity<Results>`, `List<Manufacturer>`, `List<Types>`, `List<FuelType>`, `List<Services>`

**Referenced Constants (RuntimeConfig):**
- `RuntimeConfig.MSGID_SUCCESS` = `"1"`
- `RuntimeConfig.MSGID_LOGICERRORR` = `"3"`
- `RuntimeConfig.ERRORMSG_LOGICERRORR` = `"Result already exists."`

**HTTP Status Codes Used:** `HttpStatus.OK`, `HttpStatus.BAD_REQUEST`, `HttpStatus.BAD_GATEWAY`

**Model Types Referenced:** `Equipment`, `DriverEquipment`, `Manufacturer`, `Types`, `FuelType`, `Services`, `Results`

**DAOs Referenced:** `EquipmentDAO`, `ManufacturerDAO`

**Branch Conditions:**
- `getEquipmentByUser`: `arrEquipment.size() > 0` -> OK vs BAD_REQUEST (line 39)
- `addEquipment`: `equipment.getId() > 0` (update path) vs `id == 0` (insert path) vs duplicate check path (line 49, 63, 68)
- `addEquipment`: `serial != null && !serial.equalsIgnoreCase("")` (line 58)
- `getTypeList`: `mid == 0` vs `mid != 0` (line 92)
- `getFuelTypeList`: `manuId == 0 || typeID == 0` vs both non-zero (line 111)
- `SaveService`: `count > 0` vs `count == 0` (line 150), `service_type.equalsIgnoreCase("setHrs")` in each branch (lines 151, 159)
- `SaveService`: `total == 0` for service history insert (line 171)

---

### File 2: ImageController.java

**Class:** `ImageController`
**Package:** `com.journaldev.spring.jdbc.controller`
**Annotations:** `@Controller`, `@Slf4j`

**Methods:**

| Line | Method Signature | HTTP Mapping |
|------|-----------------|--------------|
| 30 | `downloadFile(@PathVariable("fileName") String fileName)` | GET `/image/{fileName:.+}` |

**Return Types:** `ResponseEntity<Resource>`

**Injected Services:** `FileStorageService` (qualifier: `"localFileStorage"`)

**Exception Handling:**
- `IOException` caught at line 38: sets `contentType = "application/octet-stream"`, logs info, continues

**Branch Conditions:**
- `IOException` from `resource.getInputStream()` (line 38): fallback content type path

**HTTP Status Codes Used:** `HttpStatus.OK` (always)

---

### File 3: ImpactController.java

**Class:** `ImpactController extends ConfigurationController`
**Package:** `com.journaldev.spring.jdbc.controller`
**Annotations:** `@Controller`

**Methods:**

| Line | Method Signature | HTTP Mapping |
|------|-----------------|--------------|
| 59 | `saveIncident(@RequestBody Incidents incident)` | POST `/rest/impact/save` |
| 83 | `saveImpactIMAGE(@PathVariable("impid") int impId, @RequestParam("image") MultipartFile imageFile, @RequestParam("signature") String signatureFile)` | POST `/rest/impactimage/{impid}` (multipart/form-data) |
| 117 | `saveImpactIMAGEAPP(@PathVariable("impid") int impId, @PathVariable("type") String type, @RequestParam("file") MultipartFile imageFile)` | POST `/rest/impactimage/impid/{impid}/type/{type}` (multipart/form-data) |
| 152 | `saveImpactData(@RequestBody ImpactList impactList)` | POST `/rest/impactdata/save` |

**Return Types:** `ResponseEntity<Incidents>`, `ResponseEntity<Results>`

**Injected Services:** `FileStorageService` (qualifier: `"awsFileStorage"`), `ImpactDAO`, `EquipmentDAO`

**Referenced Constants (RuntimeConfig):**
- `RuntimeConfig.MSGID_SUCCESS` = `"1"`
- `RuntimeConfig.MSGID_CODEERRORR` = `"2"`
- `RuntimeConfig.MSGID_CODEE_DUPLICATE_VEHICLE` = `"3"`
- `RuntimeConfig.ERRORMSG_CODEERRORR` = `"Code throws exceptions"`

**HTTP Status Codes Used:** `HttpStatus.OK`, `HttpStatus.BAD_REQUEST`

**Exception Handling:**
- `saveImpactIMAGE`: `IOException` caught at line 107 -> BAD_REQUEST
- `saveImpactIMAGEAPP`: `IOException` caught at line 141 -> BAD_REQUEST
- `saveImpactData`: `IncorrectResultSizeDataAccessException` caught at line 181 -> BAD_REQUEST with MSGID_CODEE_DUPLICATE_VEHICLE
- `saveImpactData`: `IllegalArgumentException` caught at line 187 -> BAD_REQUEST with MSGID_CODEERRORR

**Branch Conditions:**
- `saveImpactData`: `equipment == null` -> throws `IllegalArgumentException` (line 160)
- `saveImpactData`: `!exists` vs already recorded (lines 165, 174)
- `saveImpactData`: `equipment.getImpact_threshold() != 0 && impact.getImpact_value() > equipment.getImpact_threshold()*10` -> notification (line 168)
- `saveImpactIMAGEAPP`: `type.equalsIgnoreCase("image")` vs `type.equalsIgnoreCase("signature")` vs neither (lines 127, 131)

**Noted Issues in Source:**
- Logger at line 44 uses `ConfigurationController.class` as logger name instead of `ImpactController.class`
- `RuntimeConfig.MSGID_LOGICERRORR` and `MSGID_CODEE_DUPLICATE_VEHICLE` are both `"3"` (constant collision in RuntimeConfig)
- `saveImpactData` uses raw `ResponseEntity` (no generic type) at lines 180, 185, 191

---

## Test Coverage Search Results

**Test files found under `src/test/java/`:**
- `PackageEntryTest.java` — tests `PackageEntry.compareTo()`; no controller coverage
- `APKUpdaterServiceTest.java` — all test methods commented out; no active tests
- `DateUtilTest.java` — tests `DateUtil` parsing utilities; no controller coverage

**Grep results for controller method names and class names across all test files:** No matches found.

**Conclusion:** Zero test coverage exists for `EquipmentController`, `ImageController`, and `ImpactController`. No indirect coverage was found.

---

## Findings

### A07-1, Severity: CRITICAL
**Zero test coverage for EquipmentController (all 7 methods)**

No unit tests, integration tests, or MockMvc tests exist for any method in `EquipmentController`. The class contains non-trivial business logic including duplicate detection, conditional insert/update branches, and service history deduplication. The entire controller is untested.

Affected methods:
- `getEquipmentByUser` (line 36)
- `addEquipment` (line 44)
- `getManufactureList` (line 78)
- `getTypeList` (line 86)
- `getFuelTypeList` (line 105)
- `getService` (line 123)
- `SaveService` (line 142)

---

### A07-2, Severity: CRITICAL
**Zero test coverage for ImageController (1 method)**

No tests exist for `downloadFile`. The method contains an `IOException` fallback path and always returns HTTP 200 regardless of content type resolution failure. There is no test for file-not-found behavior (depends on `FileStorageService.loadImageAsResource` throwing) and no test for the `IOException` path.

Affected method:
- `downloadFile` (line 30)

---

### A07-3, Severity: CRITICAL
**Zero test coverage for ImpactController (all 4 methods)**

No tests exist for any method in `ImpactController`. Three of the four methods contain exception-handling branches with distinct HTTP response codes that are entirely untested.

Affected methods:
- `saveIncident` (line 59)
- `saveImpactIMAGE` (line 83)
- `saveImpactIMAGEAPP` (line 117)
- `saveImpactData` (line 152)

---

### A07-4, Severity: HIGH
**Untested error path: `getEquipmentByUser` returns HTTP 400 on empty list**

`getEquipmentByUser` at line 39 returns `HttpStatus.BAD_REQUEST` when the equipment list is empty. This is an unusual use of 400 for a not-found condition and is entirely untested. There is no test verifying what happens when DAO returns an empty list, nor a test that the HTTP status is correctly set.

File: `EquipmentController.java`, line 39

---

### A07-5, Severity: HIGH
**Untested duplicate detection branch in `addEquipment`**

The `addEquipment` method queries for existing units by serial number and name (line 59-60) and returns `HttpStatus.BAD_GATEWAY` with `MSGID_LOGICERRORR` when a duplicate exists (lines 69-72). This entire duplicate-detection branch is untested. `BAD_GATEWAY` (502) is also a semantically incorrect HTTP status for a logical duplicate error; this defect cannot be caught without test coverage.

File: `EquipmentController.java`, lines 59-72

---

### A07-6, Severity: HIGH
**Untested branch: `addEquipment` with null or empty serial number**

When `serial` is `null` or empty string (line 58), the duplicate check query is skipped entirely and `id` remains 0, causing an unconditional insert. This means two units with null serial numbers and the same name can be inserted without conflict detection. This logic path has no test.

File: `EquipmentController.java`, lines 57-65

---

### A07-7, Severity: HIGH
**Untested all four `SaveService` branches**

`SaveService` contains a 2x2 matrix of branches: update-setHrs, update-duration, insert-setHrs, insert-duration (lines 150-165). Additionally, the service history deduplication check (`total == 0` at line 171) is untested. None of these paths have any test coverage.

File: `EquipmentController.java`, lines 150-174

---

### A07-8, Severity: HIGH
**Untested exception paths in `saveImpactIMAGE` and `saveImpactIMAGEAPP`**

Both image upload methods catch `IOException` and return `HttpStatus.BAD_REQUEST` with `MSGID_CODEERRORR`. Neither the happy path nor the `IOException` path is tested. Additionally, `saveImpactIMAGEAPP` at line 127 has an unhandled case where `type` is neither `"image"` nor `"signature"`: in that case the DB is not updated, `imagfis` is closed, and `MSGID_SUCCESS` is still returned — a silent failure with no test to expose it.

File: `ImpactController.java`, lines 107-112 (`saveImpactIMAGE`), lines 127-145 (`saveImpactIMAGEAPP`)

---

### A07-9, Severity: HIGH
**Untested `saveImpactData` exception paths and notification threshold branch**

Three distinct error paths in `saveImpactData` are untested:
1. `equipment == null` -> `IllegalArgumentException` -> HTTP 400 (line 160)
2. `IncorrectResultSizeDataAccessException` -> HTTP 400 with `MSGID_CODEE_DUPLICATE_VEHICLE` (line 181)
3. `SQLException` from `impactDAO.save()` -> wrapped as `IllegalArgumentException` -> HTTP 400 (line 172)

The notification threshold branch (line 168) — `impact_threshold != 0 && impact_value > threshold*10` — is also untested for both triggering and not triggering notification.

File: `ImpactController.java`, lines 160-192

---

### A07-10, Severity: MEDIUM
**Untested `getTypeList` mid==0 vs mid!=0 query selection**

`getTypeList` uses two different SQL queries depending on whether `mid == 0` (line 92). Neither branch is tested. A regression in query construction for either branch would go undetected.

File: `EquipmentController.java`, lines 92-100

---

### A07-11, Severity: MEDIUM
**Untested `getFuelTypeList` zero-parameter vs filtered query selection**

`getFuelTypeList` executes an unfiltered query when `manuId == 0 || typeID == 0` and a filtered query otherwise (line 111). Neither branch is tested.

File: `EquipmentController.java`, lines 111-118

---

### A07-12, Severity: MEDIUM
**Untested `saveImpactData` deduplication path (impact already recorded)**

When `impactDAO.isImpactRecorded(impact)` returns `true` (line 164), the event is silently skipped with a warning log and the response is still `MSGID_SUCCESS`. This behavior — returning success for a no-op — is not tested and could mask data loss.

File: `ImpactController.java`, lines 164-176

---

### A07-13, Severity: MEDIUM
**Untested `saveIncident` with null/unparseable date fields**

`saveIncident` (line 59) calls `DateUtil.parseDateTimeIso()` on both `report_time` and `event_time` from the request body (line 68). `DateUtil.parseDateTimeIso(null)` returns null (verified by `DateUtilTest`), and `parseDateTimeIso("xxx")` throws `IllegalArgumentException`. However, `saveIncident` has no try/catch around these calls and no test verifies what happens when malformed dates are submitted — the uncaught exception would result in an uncontrolled 500 response.

File: `ImpactController.java`, line 68

---

### A07-14, Severity: MEDIUM
**`ImageController.downloadFile` always returns HTTP 200 regardless of missing resource**

`downloadFile` (line 30) returns `HttpStatus.OK` unconditionally. If `fileStorageService.loadImageAsResource(fileName)` returns a resource that does not actually exist on disk (or throws), the behavior is untested. No test verifies that a missing file results in an appropriate error response. The `IOException` fallback at line 38 merely assigns a default content type and does not alter the HTTP 200 status.

File: `ImageController.java`, lines 30-47

---

### A07-15, Severity: LOW
**`APKUpdaterServiceTest` has all test methods commented out**

`APKUpdaterServiceTest.java` contains two relevant test methods (`getAvailablePackage`, `getAvailablePackageWhenAlreadyHaveLatest`) that are entirely commented out (lines 17-44). While unrelated to the three controllers under review, this indicates a pattern of disabled tests across the test suite, suggesting test infrastructure may be broken or ignored.

File: `src/test/java/com/journaldev/spring/jdbc/service/APKUpdaterServiceTest.java`

---

### A07-16, Severity: LOW
**`saveImpactIMAGEAPP` silent no-op for unknown `type` value**

When `type` is not `"image"` and not `"signature"` (line 127), neither database update executes, but the method still returns `MSGID_SUCCESS` and `HttpStatus.OK` (line 138). There is no test that would detect this silent no-op, and no validation or error response is returned for invalid type values.

File: `ImpactController.java`, lines 127-138

---

### A07-17, Severity: INFO
**Wrong logger class reference in ImpactController**

At line 44 of `ImpactController.java`, the logger is initialized using `ConfigurationController.class` instead of `ImpactController.class`:

```java
private static final Logger logger = LoggerFactory.getLogger(ConfigurationController.class);
```

This causes all log output from `ImpactController` to appear under the `ConfigurationController` logger name, making log-based debugging and monitoring misleading. No test covers logging behavior, so this defect is undetected.

File: `ImpactController.java`, line 44

---

## Summary Table

| Finding | Severity | File | Description |
|---------|----------|------|-------------|
| A07-1 | CRITICAL | EquipmentController.java | Zero test coverage — all 7 methods |
| A07-2 | CRITICAL | ImageController.java | Zero test coverage — downloadFile |
| A07-3 | CRITICAL | ImpactController.java | Zero test coverage — all 4 methods |
| A07-4 | HIGH | EquipmentController.java:39 | Untested HTTP 400 on empty equipment list |
| A07-5 | HIGH | EquipmentController.java:59-72 | Untested duplicate detection, wrong HTTP 502 status |
| A07-6 | HIGH | EquipmentController.java:57-65 | Untested null/empty serial skips duplicate check |
| A07-7 | HIGH | EquipmentController.java:150-174 | Untested 4-branch SaveService logic + history dedup |
| A07-8 | HIGH | ImpactController.java:83,117 | Untested IOException paths and silent no-op type fallback |
| A07-9 | HIGH | ImpactController.java:152 | Untested saveImpactData exception paths and notification threshold |
| A07-10 | MEDIUM | EquipmentController.java:92 | Untested getTypeList mid==0 vs mid!=0 query branch |
| A07-11 | MEDIUM | EquipmentController.java:111 | Untested getFuelTypeList zero vs filtered query branch |
| A07-12 | MEDIUM | ImpactController.java:164 | Untested duplicate impact deduplication silent success |
| A07-13 | MEDIUM | ImpactController.java:68 | Untested null/malformed date -> unhandled 500 in saveIncident |
| A07-14 | MEDIUM | ImageController.java:30 | downloadFile always returns 200, untested missing resource |
| A07-15 | LOW | APKUpdaterServiceTest.java | All APK updater tests commented out |
| A07-16 | LOW | ImpactController.java:127 | Silent no-op and success return for invalid type value |
| A07-17 | INFO | ImpactController.java:44 | Logger uses wrong class reference (ConfigurationController) |
