# A29 - Pass 2: Test Coverage Audit
**Date:** 2026-02-27
**Agent:** A29
**Scope:** LocalFileStorageService, SaveFileInfo, UserDetailsServiceImpl

---

## Test Suite Inventory

Three test files exist under `src/test/java/`:

| Test File | Active Tests |
|---|---|
| `com.journaldev.spring.jdbc.model.PackageEntryTest` | 1 (`compareTo`) |
| `com.journaldev.spring.jdbc.service.APKUpdaterServiceTest` | 0 (all methods commented out) |
| `com.journaldev.spring.jdbc.util.DateUtilTest` | 6 (`parseDateIso*`, `parseDateTimeIso*`) |

None of the three audited source files are referenced anywhere in the test suite. A Grep across the entire `src/test/java/` tree for every class name, method name, and exception type from all three source files returned zero matches.

---

## Reading Evidence

### 1. LocalFileStorageService.java
**File:** `src/main/java/com/journaldev/spring/jdbc/service/LocalFileStorageService.java`
**Class:** `LocalFileStorageService extends AbstractFileStorageService implements FileStorageService`
**Annotation:** `@Service("localFileStorage")`, `@Slf4j`
**Inherits from:** `AbstractFileStorageService` (which inherits `saveImage`, `initialize`, and field `imageStorageLocation`)

| Method | Line | Signature |
|---|---|---|
| `loadImageAsResource` | 16 | `public Resource loadImageAsResource(String fileName)` — overrides `FileStorageService` |

**Internal logic of `loadImageAsResource` (lines 17-29):**
- Line 19: `imageStorageLocation.resolve(fileName).normalize()` — path construction
- Line 20: `new UrlResource(filePath.toUri())` — may throw `MalformedURLException`
- Line 21: `resource.exists()` — boolean branch
- Line 24 (else): throws `FileNotFoundException("Unable to find " + fileName + " at location : " + filePath.toString() + " on server")`
- Line 26-28 (catch): catches `MalformedURLException`, throws `FileStorageException("Invalid filename, unable to build url for " + fileName, ex)`

**Exception types thrown:**
- `FileNotFoundException` (custom, `@ResponseStatus(HttpStatus.NOT_FOUND)`, extends `FileStorageException`)
- `FileStorageException` (custom, extends `RuntimeException`)

**Constants/fields used (inherited):**
- `imageStorageLocation` (type `Path`, set in `AbstractFileStorageService.initialize()`)

---

### 2. AbstractFileStorageService.java (parent — read for full context)
**File:** `src/main/java/com/journaldev/spring/jdbc/service/AbstractFileStorageService.java`
**Class:** `abstract AbstractFileStorageService implements FileStorageService`

| Method | Line | Signature |
|---|---|---|
| `initialize` | 43 | `@PostConstruct public void initialize()` |
| `saveImage` | 53 | `public String saveImage(InputStream inputStream)` |

**Exception types thrown in `saveImage`:**
- Catches `MimeTypeException | IOException` (lines 60-62) — logs warning, continues with default `.jpg`
- Catches `IOException` (lines 71-73) — throws `FileStorageException("Could not store file " + fileName + ". Please try again!", ex)`

**Constants/fields:**
- `uploadDir` (`@Value("${uploadDir}")`)
- `imageDir` (`@Value("${imageDir}")`)
- `imagePrefix` (`@Value("${imagePrefix}")`)
- `imageExt = ".jpg"` (default extension)

---

### 3. SaveFileInfo.java
**File:** `src/main/java/com/journaldev/spring/jdbc/service/SaveFileInfo.java`
**Class:** `SaveFileInfo implements Serializable`
**Annotations:** `@Data`, `@Builder`

| Member | Line | Type |
|---|---|---|
| `serialVersionUID` | 12 | `private static final long = 6183703080165788038L` |
| `fileName` | 14 | `private String` |
| `fileDownloadUri` | 15 | `private String` |
| `fileType` | 16 | `private String` |
| `size` | 17 | `private long` |

**Lombok-generated methods (implicit):**
- `getFileName()`, `setFileName(String)`
- `getFileDownloadUri()`, `setFileDownloadUri(String)`
- `getFileType()`, `setFileType(String)`
- `getSize()`, `setSize(long)`
- `equals(Object)`, `hashCode()`, `toString()`
- Builder: `SaveFileInfo.builder().fileName(...).fileDownloadUri(...).fileType(...).size(...).build()`

**No custom logic, no exception paths.**

---

### 4. UserDetailsServiceImpl.java
**File:** `src/main/java/com/journaldev/spring\jdbc/service/UserDetailsServiceImpl.java`
**Class:** `UserDetailsServiceImpl implements UserDetailsService`
**Annotation:** `@Service("userDetailsService")`
**Dependency:** `@Autowired UserDAO dao`

| Method | Line | Signature |
|---|---|---|
| `loadUserByUsername` | 26 | `@Transactional(readOnly=true) public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException, DataAccessException` |
| `buildUserFromUserEntity` | 34 | `private UserDetails buildUserFromUserEntity(User userEntity)` |

**Logic detail — `loadUserByUsername` (lines 26-32):**
- Line 29: `dao.findByName(username).orElseThrow(() -> new UsernameNotFoundException("user not found"))` — throws if user absent

**Logic detail — `buildUserFromUserEntity` (lines 34-51):**
- Line 36: `userEntity.getEmail()` — used as Spring Security username
- Line 37: `userEntity.getPassword()`
- Line 38: `enabled = true` — hard-coded, never false
- Line 40: `accountNonExpired = true` — hard-coded
- Line 41: `credentialsNonExpired = true` — hard-coded
- Line 42: `accountNonLocked = userEntity.isActive()` — only field drawn from `User`
- Lines 44-47: iterates `userEntity.getRoles()`, adds `SimpleGrantedAuthority(role.getAuthority())` for each
- Line 49: constructs `org.springframework.security.core.userdetails.User`

**Exception types:**
- `UsernameNotFoundException` (Spring Security) — thrown when DAO returns empty Optional
- `DataAccessException` (Spring) — declared in throws clause; propagated from DAO layer, not caught

**Flags/constants:**
- `enabled` = `true` (hard-coded boolean)
- `accountNonExpired` = `true` (hard-coded boolean)
- `credentialsNonExpired` = `true` (hard-coded boolean)

---

## Findings

---

### A29-1, Severity: CRITICAL
**No tests exist for `LocalFileStorageService`**

`LocalFileStorageService` and its parent `AbstractFileStorageService` have zero test coverage. The class is the sole concrete implementation of `FileStorageService` responsible for persisting and retrieving all user-uploaded image files. Neither the happy path nor any exception path is exercised by any test. The following branches are entirely uncovered:

- `loadImageAsResource` — file found path (returns `Resource`)
- `loadImageAsResource` — file not found path (throws `FileNotFoundException`)
- `loadImageAsResource` — malformed URL path (throws `FileStorageException`)
- `saveImage` — successful copy path
- `saveImage` — MIME detection failure path (falls back to `.jpg`)
- `saveImage` — `IOException` on `Files.copy` (throws `FileStorageException`)
- `initialize` — directory creation failure (throws `FileStorageException`)

---

### A29-2, Severity: CRITICAL
**No tests exist for `UserDetailsServiceImpl`**

`UserDetailsServiceImpl` is the Spring Security authentication entry point for the entire application. Every authenticated API call flows through `loadUserByUsername`. The class has zero test coverage. Uncovered paths include:

- `loadUserByUsername` — user found and returned successfully
- `loadUserByUsername` — user not found, `UsernameNotFoundException` thrown
- `loadUserByUsername` — DAO throws `DataAccessException` (database unavailable)
- `buildUserFromUserEntity` — user with zero roles (empty `GrantedAuthority` collection)
- `buildUserFromUserEntity` — user with multiple roles
- `buildUserFromUserEntity` — `isActive() == false` (account locked scenario)

---

### A29-3, Severity: HIGH
**No tests exist for `SaveFileInfo`**

`SaveFileInfo` is a Lombok `@Data @Builder` DTO used in file upload API responses. While Lombok generates the accessors, no test validates the serialization contract (correct `serialVersionUID`, round-trip `Serializable` behaviour), the builder pattern, or that `equals`/`hashCode`/`toString` operate correctly on each field. This is LOW risk for pure data objects but the complete absence of any validation is notable given the class is part of a public API contract.

---

### A29-4, Severity: HIGH
**`buildUserFromUserEntity` hard-codes security flags — untested and unverifiable**

Lines 38-41 of `UserDetailsServiceImpl` hard-code `enabled = true`, `accountNonExpired = true`, and `credentialsNonExpired = true` regardless of any user entity state. The only flag drawn from the database is `accountNonLocked` (via `isActive()`). This means:

- A disabled or expired user account cannot be signalled to Spring Security through this service.
- If the `User` model ever gains `enabled` or `expired` fields, the service will silently ignore them.
- Because there are no tests, this design decision is invisible and unverifiable by any automated check.

---

### A29-5, Severity: HIGH
**`DataAccessException` declared but never caught — database failures propagate to security filter chain**

`loadUserByUsername` declares `throws DataAccessException` but contains no `catch` block for it. If the database is unavailable, the uncaught `DataAccessException` will propagate up through Spring Security's `AbstractUserDetailsAuthenticationProvider`, potentially producing a 500 response rather than a controlled authentication failure. No test exercises this path.

---

### A29-6, Severity: HIGH
**`loadImageAsResource` path-traversal input not validated**

`AbstractFileStorageService.imageStorageLocation.resolve(fileName).normalize()` is called with the raw caller-supplied `fileName` string. While `normalize()` collapses `..` segments after resolution, a crafted `fileName` such as `../../etc/passwd` could still resolve outside the intended storage directory if `imageStorageLocation` is not verified as a prefix of the resulting path after normalisation. No test supplies adversarial filenames to validate that the boundary is enforced.

---

### A29-7, Severity: MEDIUM
**`APKUpdaterServiceTest` is entirely commented out — reduces effective test count to near zero**

`APKUpdaterServiceTest` contains two test methods (`getAvailablePackage`, `getAvailablePackageWhenAlreadyHaveLatest`) that are fully commented out with a block comment (lines 17-44). The class compiles and runs but executes nothing. This reduces the overall effective test count for the `service` package and suggests a pattern of abandoned tests rather than maintained coverage.

---

### A29-8, Severity: MEDIUM
**`saveImage` MIME detection failure is silently swallowed — no test validates fallback**

In `AbstractFileStorageService.saveImage` (lines 60-62), a catch block for `MimeTypeException | IOException` logs a warning and continues with the default `.jpg` extension. No test verifies:
- That the warning log is emitted.
- That the stored file actually receives the `.jpg` suffix when MIME detection fails.
- That the caller receives a filename with the fallback extension.

---

### A29-9, Severity: MEDIUM
**`buildUserFromUserEntity` uses `email` as the Spring Security username — not validated**

Line 36 of `UserDetailsServiceImpl` assigns `userEntity.getEmail()` as the Spring Security principal name. The `User` model permits `email` to be `null` (no `@NonNull` constraint). If a `User` row in the database has a null or blank email, the resulting `org.springframework.security.core.userdetails.User` constructor will either throw an `IllegalArgumentException` or produce an empty principal. No test covers a null-email user entity.

---

### A29-10, Severity: LOW
**`FileNotFoundException` has only a single-argument constructor — cause is lost**

`FileNotFoundException` (line 9) exposes only `FileNotFoundException(String message)` with no `FileNotFoundException(String message, Throwable cause)` variant. When caught and rethrown with a cause, the original exception is silently dropped. `LocalFileStorageService.loadImageAsResource` does not currently pass a cause to this constructor, so no information is lost today, but the class is structurally incomplete compared to its sibling `FileStorageException`, which does provide a two-argument constructor. This is a design gap with no test coverage to detect regressions if the constructor signature is later used incorrectly.

---

### A29-11, Severity: LOW
**`SaveFileInfo` `size` field typed as primitive `long` — serialization edge case untested**

The `size` field is `long` (primitive), not `Long` (boxed). When serialised over JSON (e.g. via Jackson) the default for an omitted field is `0L`, not `null`. This may produce unexpected behaviour if a caller omits `size` in a builder call. No test validates the JSON serialisation round-trip of `SaveFileInfo`.

---

## Summary Table

| ID | Severity | Area | Description |
|---|---|---|---|
| A29-1 | CRITICAL | LocalFileStorageService | Zero test coverage for all paths |
| A29-2 | CRITICAL | UserDetailsServiceImpl | Zero test coverage for auth entry point |
| A29-3 | HIGH | SaveFileInfo | No serialization or builder tests |
| A29-4 | HIGH | UserDetailsServiceImpl | Hard-coded security flags untestable |
| A29-5 | HIGH | UserDetailsServiceImpl | DataAccessException not caught, propagates uncontrolled |
| A29-6 | HIGH | LocalFileStorageService | Path traversal not validated in loadImageAsResource |
| A29-7 | MEDIUM | APKUpdaterServiceTest | All tests commented out |
| A29-8 | MEDIUM | AbstractFileStorageService | MIME fallback silently swallowed, no test |
| A29-9 | MEDIUM | UserDetailsServiceImpl | Null email not guarded in buildUserFromUserEntity |
| A29-10 | LOW | FileNotFoundException | No cause-chaining constructor |
| A29-11 | LOW | SaveFileInfo | Primitive long serialization edge case untested |
