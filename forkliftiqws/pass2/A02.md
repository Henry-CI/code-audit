# Pass 2 — Agent A02: Test Coverage

## Reading Evidence

### DriverDAO.java
- **Class/Interface:** `DriverDAO` (interface)
- **Methods:**
  - `isDriverExist(String email)` (line 12)
  - `findByID(int userId) throws EntityNotFoundException` (line 13)
  - `findAllByCompanyOwner(int ownerId)` (line 14)
  - `findAllTraining(int driverId)` (line 15)
  - `save(Driver user)` (line 16)
  - `update(Driver user) throws SQLException` (line 17)
  - `updateLastLoginTime(Driver driver) throws SQLException` (line 18)
  - `updatePassword(String email, String password) throws SQLException` (line 19)
  - `findByEmailAndPassword(String email, String password)` (line 22) — `@Deprecated`
- **Types/Errors/Constants:**
  - Throws: `EntityNotFoundException`, `SQLException`
  - Return types: `boolean`, `Driver`, `List<Driver>`, `List<DriverTraining>`, `int`, `Optional<Driver>`, `void`
  - Annotation: `@Deprecated` on `findByEmailAndPassword`

### DriverDAOImpl.java
- **Class/Interface:** `DriverDAOImpl` — `@Repository`, `@Slf4j`, extends `JdbcDaoSupport`, implements `DriverDAO`
- **Methods:**
  - `setDbDataSource(DataSource dataSource)` (line 35) — `@Autowired` `@Qualifier("dataSource")`
  - `isDriverExist(String email)` (line 40)
  - `save(Driver user)` (line 48)
  - `update(Driver driver) throws SQLException` (line 63)
  - `updateLastLoginTime(Driver driver) throws SQLException` (line 77)
  - `updatePassword(String email, String password) throws SQLException` (line 93)
  - `findByID(int userId) throws EntityNotFoundException` (line 102)
  - `findByEmailAndPassword(String email, String password)` (line 120) — `@Deprecated`
  - `findAllByCompanyOwner(int ownerId)` (line 138)
  - `findAllTraining(int driverId)` (line 151)
- **Types/Errors/Constants:**
  - Constants: `BASE_QUERY_DRIVER` (line 23, private static final String), `UPDATE_PASSWORD` (line 90, private static final String)
  - Throws: `SQLException` (update, updateLastLoginTime, updatePassword), `EntityNotFoundException` (findByID)
  - Catches: `EmptyResultDataAccessException` in `findByID` (rethrown as `EntityNotFoundException`) and `findByEmailAndPassword` (silenced, returns `Optional.empty`)
  - Dependencies: `Configuration` (autowired), `JdbcTemplate` (via `JdbcDaoSupport`)
  - SQL uses `md5()` for password hashing in `save` and `UPDATE_PASSWORD`
  - SQL uses `ilike` (case-insensitive) in `isDriverExist`

### EmailLayoutDAO.java
- **Class/Interface:** `EmailLayoutDAO` (concrete class, no Spring stereotype annotation)
- **Methods:**
  - `EmailLayoutDAO(DataSource dataSource)` (line 16) — constructor
  - `getEmailLayoutByType(String type)` (line 21)
- **Types/Errors/Constants:**
  - Fields: `jdbcTemplate` (JdbcTemplate, line 12), `logger` (Logger, line 13)
  - `getEmailLayoutByType` returns a new empty `EmailLayout` object without executing any query

---

## Findings

### A02-1 [CRITICAL] No test coverage exists for DriverDAO or DriverDAOImpl
**File:** `src/main/java/com/journaldev/spring/jdbc/DAO/DriverDAOImpl.java`
**Description:** A search of the entire `src/test/java` tree found zero references to `DriverDAO`, `DriverDAOImpl`, or any of their methods (`isDriverExist`, `findByID`, `findAllByCompanyOwner`, `findAllTraining`, `save`, `update`, `updateLastLoginTime`, `updatePassword`, `findByEmailAndPassword`). The only test files present are `PackageEntryTest.java`, `APKUpdaterServiceTest.java`, and `DateUtilTest.java`, none of which cover driver persistence logic. All ten methods in this class are completely untested.

### A02-2 [CRITICAL] No test coverage exists for EmailLayoutDAO
**File:** `src/main/java/com/journaldev/spring/jdbc/DAO/EmailLayoutDAO.java`
**Description:** A search of the entire `src/test/java` tree found zero references to `EmailLayoutDAO` or `getEmailLayoutByType`. Neither the constructor nor the only public method has any test coverage.

### A02-3 [CRITICAL] `getEmailLayoutByType` is a stub — always returns empty object, never queries the database
**File:** `src/main/java/com/journaldev/spring/jdbc/DAO/EmailLayoutDAO.java`, line 21–29
**Description:** `getEmailLayoutByType(String type)` instantiates a new empty `EmailLayout` and returns it immediately without executing any SQL or using `jdbcTemplate`. The `type` parameter is accepted but never used. The method is effectively dead code masquerading as a working DAO method. Any caller relying on this method to retrieve email layout data from the database will receive an empty object with all fields at their default values (`null`/`0`). There are no tests that would expose this regression.

### A02-4 [CRITICAL] `update` method uses wrong column name `iduser` — SQL bug, no test to catch it
**File:** `src/main/java/com/journaldev/spring\jdbc\DAO\DriverDAOImpl.java`, line 66–71
**Description:** The `update` SQL at line 66 uses `where iduser = ?`, but the table column name used everywhere else in the same class (e.g., `findByID`, `updateLastLoginTime`) is `id`. This mismatch means `getJdbcTemplate().update(...)` will return 0 rows affected for any valid driver, causing the method to always throw `SQLException("Unable to update driver detail for driver " + driver.getId())`. The absence of any test means this defect is undetected.

### A02-5 [HIGH] `findByEmailAndPassword` is `@Deprecated` but remains in the interface and implementation with no migration path or removal deadline
**File:** `src/main/java/com/journaldev/spring/jdbc/DAO/DriverDAO.java`, line 21–22; `DriverDAOImpl.java`, line 120–135
**Description:** The deprecated method is still part of the public interface contract. No test verifies the deprecation warning is observed, that callers have migrated away, or that the method behaves correctly in the interim (e.g., for an existing user, for a non-existent user, or for a null email/password). If the method is still called in production it silently returns `Optional.empty()` on any `EmptyResultDataAccessException` including database errors, which is indistinguishable from "driver not found."

### A02-6 [HIGH] `isDriverExist` not tested for null email, empty string, or SQL injection via `ilike`
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\DriverDAOImpl.java`, line 40–45
**Description:** `isDriverExist(String email)` passes `email` directly as a JDBC parameter to a `ilike ?` clause. There are no tests for: (1) `null` email — the JDBC driver will bind `NULL`, resulting in `count(*) = 0` rather than an error, silently indicating the driver does not exist; (2) empty string `""` — may match unexpected rows depending on collation; (3) very long strings. No test exists to confirm any of these edge cases.

### A02-7 [HIGH] `save` swallows sequence/insert failures with no error handling or test coverage
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\DriverDAOImpl.java`, line 48–60
**Description:** `save(Driver user)` calls `queryForObject` for the next sequence value and then `update` for the insert. Neither call is wrapped in exception handling. A `DataAccessException` (e.g., duplicate email, sequence exhaustion, constraint violation) will propagate as an unchecked exception with no meaningful message and no cleanup. No test covers the failure path or verifies the returned `uid` is consistent with the inserted row.

### A02-8 [HIGH] `updatePassword` uses MD5 hashing — no test verifies the hash is applied or that a null/empty password is rejected
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\DriverDAOImpl.java`, line 90–98
**Description:** `updatePassword` delegates password hashing to the SQL `md5(?)` function. There is no test verifying: (1) that a `null` password argument does not cause a silent null hash; (2) that an empty string `""` is rejected before reaching the database; (3) that the `row == 0` branch (driver email not found) is reachable and throws correctly. The same MD5 issue applies to `save` which also uses `md5(?)`.

### A02-9 [HIGH] `findAllByCompanyOwner` returns empty list silently for unknown `ownerId` — no test for this boundary
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\DriverDAOImpl.java`, line 138–147
**Description:** `findAllByCompanyOwner(int ownerId)` returns an empty `List<Driver>` when `ownerId` does not match any company. There is no test to confirm this contract, nor to verify behaviour when `ownerId` is zero or negative. The calling layer may treat an empty list as a valid result rather than detecting a bad owner ID.

### A02-10 [HIGH] `findAllTraining` log message is copy-paste error — no test would detect this diagnostic defect
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\DriverDAOImpl.java`, line 151–158
**Description:** `findAllTraining(int driverId)` logs `"Start findAllByCompanyOwner for ownerId : {}"` (line 152), which is copied from `findAllByCompanyOwner`. The logged method name and parameter label are incorrect. While not a functional defect, it will mislead debugging. No test exists to assert correct behaviour or to detect the confusing log output.

### A02-11 [MEDIUM] `findByID` passes `url` as the first positional parameter via deprecated `Object[]` vararg API — no test validates mapping
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\DriverDAOImpl.java`, line 110
**Description:** `findByID` uses `getJdbcTemplate().queryForObject(sql, new Object[]{url, userId}, new BeanPropertyRowMapper<>(Driver.class))`. The `Object[]` form of `queryForObject` is deprecated in Spring 5.3+. More importantly, no test verifies that the `url` is correctly substituted as the first `?` in `BASE_QUERY_DRIVER` and that `BeanPropertyRowMapper` correctly maps all fields (including `comp_id` aliased from `c.id`) to the `Driver` model. A mapping failure would surface only at runtime.

### A02-12 [MEDIUM] `EmailLayoutDAO` is not a Spring-managed bean — no `@Repository` or `@Component` annotation
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\EmailLayoutDAO.java`, line 11
**Description:** `EmailLayoutDAO` is a plain class with a constructor that accepts a `DataSource`. It has no Spring stereotype annotation (`@Repository`, `@Component`, etc.) and is not declared as a `@Bean` in any visible configuration. This means it cannot be autowired consistently; callers must manually construct it or it may already be wired incorrectly elsewhere. No test verifies construction or injection.

### A02-13 [MEDIUM] `updateLastLoginTime` throws `SQLException` on zero rows — no test for driver-not-found path
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\DriverDAOImpl.java`, line 77–88
**Description:** When `driver.getId()` does not match any row, `row == 0` and `SQLException` is thrown. No test exercises this path. Additionally, unlike `findByID` which checks `d.active = true`, `updateLastLoginTime` does not filter on active status — an inactive driver's login time could be updated without error, which may be unintended.

### A02-14 [LOW] `BASE_QUERY_DRIVER` duplicates `p.enabled = true` — join condition and WHERE clause both filter on enabled
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\DriverDAOImpl.java`, lines 23–28, 141–142
**Description:** `BASE_QUERY_DRIVER` already joins `permission` with `p.enabled = true` in the `inner join` condition (line 27). `findAllByCompanyOwner` then adds `p.enabled = true` again in the `WHERE` clause (line 142). This is a redundant predicate. No test would fail due to it, but it indicates the query was written without attention to the base query contract and could confuse future maintainers.

### A02-15 [LOW] `findByEmailAndPassword` silences `EmptyResultDataAccessException` but not other `DataAccessException` subtypes
**File:** `src/main/java/com/journaldev\spring\jdbc\DAO\DriverDAOImpl.java`, lines 129–133
**Description:** The catch block catches only `EmptyResultDataAccessException`. Any other `DataAccessException` (e.g., `BadSqlGrammarException`, connection failure) will propagate as an unchecked exception. Given the method is deprecated and has no tests, this divergence from the expected "return empty Optional on not found" contract is undetectable without test coverage.
