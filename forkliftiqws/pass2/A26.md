# Audit Report A26 — Pass 2: Test Coverage
**Date:** 2026-02-27
**Agent:** A26
**Scope:** BootstrapService, CognitoService, DriverAlreadyExistException

---

## Reading Evidence

### 1. BootstrapService.java
**File:** `src/main/java/com/journaldev/spring/jdbc/service/BootstrapService.java`

**Class/Interface:**
- `BootstrapService` (outer, `@Configuration`) — line 16
- `BootstrapService.FlywayBean` (inner public non-static class) — line 40

**Fields:**
- `DataSource dataSource` — `@Autowired`, line 19
- `boolean baseline` — `@Value("${flyway.baseline}")`, line 22
- `boolean enabled` — `@Value("${flyway.enabled}")`, line 25
- `Flyway flyway` (FlywayBean field) — line 42

**Methods:**

| Method | Class | Line | Signature |
|---|---|---|---|
| `getFlyway()` | `BootstrapService` | 28 | `public FlywayBean getFlyway()` — `@Bean(initMethod="migrate")` |
| `FlywayBean()` | `FlywayBean` | 44 | Default no-arg constructor |
| `FlywayBean(Flyway flyway)` | `FlywayBean` | 47 | Parameterized constructor |
| `migrate()` | `FlywayBean` | 51 | `public int migrate() throws FlywayException` |

**Types referenced:**
- `org.flywaydb.core.Flyway`
- `org.flywaydb.core.api.FlywayException`
- `javax.sql.DataSource`
- `org.springframework.context.annotation.Bean`
- `org.springframework.context.annotation.Configuration`
- `org.slf4j.Logger` / `LoggerFactory` (imported but never used)

**Errors/Exceptions declared:**
- `FlywayException` declared on `migrate()` signature

**Constants:** None

**Branches in `getFlyway()`:**
- Branch A: `this.enabled == true` → creates a real `Flyway` object, calls `setBaselineOnMigrate`, `setDataSource`, `setLocations`, returns `FlywayBean(flyway)` — line 29–34
- Branch B: `this.enabled == false` → returns `new FlywayBean()` (no-arg) — line 36

**Branches in `migrate()`:**
- Branch A: `flyway != null` → calls `flyway.migrate()` and returns its `int` result — line 52–53
- Branch B: `flyway == null` → prints to `System.out`, returns `0` — line 55–56

---

### 2. CognitoService.java
**File:** `src/main/java/com/journaldev/spring/jdbc/service/CognitoService.java`

**Class:** `CognitoService` (`@Service`, `@Slf4j`) — line 25

**Fields:**
- `Configuration configuration` — `@Autowired`, line 28

**Methods:**

| Method | Line | Signature |
|---|---|---|
| `getUser(String username)` | 30 | `public UserResponse getUser(String username)` |
| `authenticationRequest()` | 69 | `public AuthenticationResponse authenticationRequest()` |

**Types referenced:**
- `java.net.URI`
- `java.util.ArrayList`
- `org.springframework.http.HttpEntity`
- `org.springframework.http.HttpHeaders`
- `org.springframework.http.HttpMethod`
- `org.springframework.http.HttpStatus`
- `org.springframework.http.MediaType`
- `org.springframework.http.ResponseEntity`
- `org.springframework.web.client.RestTemplate`
- `com.journaldev.spring.jdbc.model.AuthenticationRequest`
- `com.journaldev.spring.jdbc.model.AuthenticationResponse`
- `com.journaldev.spring.jdbc.model.UserResponse`
- `com.journaldev.spring.jdbc.util.Configuration`

**Errors/Exceptions:**
- `Exception` (broad catch) in `getUser()` — line 60
- `Exception` (broad catch) in `authenticationRequest()` — line 99

**Constants:** None explicitly declared. Hardcoded strings:
- `"http://localhost:"` (base URL scheme) — lines 48, 89
- `"/auth/user?username="` — line 48
- `"&accessToken="` — line 48
- `"/auth"` — line 89

**Branches in `getUser()`:**
- Branch A: `HttpStatus.OK == result.getStatusCode()` → assigns body, logs success — line 51–54
- Branch B: HTTP status not OK → logs failure, `response` stays as empty `new UserResponse()` — line 57–58
- Branch C: `Exception` thrown → stack trace printed, error logged, empty `UserResponse` returned — line 60–64

**Branches in `authenticationRequest()`:**
- Branch A: `HttpStatus.OK == result.getStatusCode()` → assigns body, logs success — line 90–93
- Branch B: HTTP status not OK → logs failure, `response` stays as empty `new AuthenticationResponse()` — line 95–97
- Branch C: `Exception` thrown → stack trace printed, error logged, empty `AuthenticationResponse` returned — line 99–103

---

### 3. DriverAlreadyExistException.java
**File:** `src/main/java/com/journaldev/spring/jdbc/service/DriverAlreadyExistException.java`

**Class:** `DriverAlreadyExistException extends DriverServiceException extends RuntimeException` — line 3

**Methods (Constructors):**

| Method | Line | Signature |
|---|---|---|
| `DriverAlreadyExistException(String message)` | 5 | Single-arg constructor delegating to `super(message)` |
| `DriverAlreadyExistException(String message, Throwable cause)` | 9 | Two-arg constructor delegating to `super(message, cause)` |

**Types referenced:**
- `com.journaldev.spring.jdbc.service.DriverServiceException` (parent)

**Errors/Constants:** None

**Usage site (production):**
- Thrown in `DriverService.registerDriver()` at line 69 using the single-arg constructor only. The two-arg constructor (`message, Throwable`) is never called anywhere in production code.

---

## Test Coverage Search Results

**Test files found under `src/test/java/`:**
- `APKUpdaterServiceTest.java` — all `@Test` methods commented out; effectively zero executable tests
- `PackageEntryTest.java`
- `DateUtilTest.java`

**Grep results for each target class in test sources:**
- `BootstrapService` / `FlywayBean` — **0 matches**
- `CognitoService` / `cognitoService` — **0 matches**
- `DriverAlreadyExistException` / `DriverServiceException` — **0 matches**

None of the three source files under audit are referenced in any test file, directly or indirectly.

---

## Findings

---

### A26-1, Severity: CRITICAL

**BootstrapService and FlywayBean have zero test coverage.**

`BootstrapService.getFlyway()` is a `@Bean` method with an `initMethod = "migrate"` lifecycle hook. It contains a conditional branch on the `flyway.enabled` property. `FlywayBean.migrate()` contains a null-guard branch and can propagate `FlywayException` from Flyway itself. Neither the outer class nor the inner class appears in any test file. The `initMethod` is invoked automatically by the Spring container on startup, meaning a misconfiguration or regression in this code path can cause silent database migration failure or application startup failure with no automated detection.

**Untested paths:**
- `getFlyway()` with `enabled = true` (Flyway configured and migration invoked)
- `getFlyway()` with `enabled = false` (no-op FlywayBean returned)
- `migrate()` when `flyway != null` (delegates to `flyway.migrate()`, return value not verified)
- `migrate()` when `flyway == null` (disabled path, `System.out.println` side effect not asserted)
- `migrate()` propagating `FlywayException` (no test verifies the exception is allowed through)

---

### A26-2, Severity: CRITICAL

**CognitoService has zero test coverage.**

`CognitoService` is a `@Service` bean injected into `ImpactDAO` (confirmed at `ImpactDAO.java` line 66) and is therefore on a production alert-processing code path. Both public methods — `getUser()` and `authenticationRequest()` — make outbound HTTP calls via a raw `new RestTemplate()` (not injected), making them untestable without mocking the network layer. No test exercises these methods in any form.

**Untested paths:**
- `authenticationRequest()` with successful HTTP 200 response
- `authenticationRequest()` with non-200 HTTP status (silent empty-response return)
- `authenticationRequest()` with network exception (swallowed, empty response returned silently)
- `getUser()` with successful HTTP 200 response
- `getUser()` with non-200 HTTP status (silent empty-response return)
- `getUser()` with network exception (swallowed, empty response returned silently)
- `getUser()` when `authenticationRequest()` itself fails and returns an empty `AuthenticationResponse` whose `getSessionToken()` returns `null` (null token is appended to the URL string unchecked)

---

### A26-3, Severity: HIGH

**`RestTemplate` is constructed inline in CognitoService rather than injected, blocking unit testing.**

Both `getUser()` (line 36) and `authenticationRequest()` (line 77) call `new RestTemplate()` directly. Because `RestTemplate` is not injected as a bean or passed as a parameter, there is no seam to substitute a mock or a test-scoped HTTP client. Any unit test of these methods would make real network calls to `localhost`, making tests environment-dependent and fragile. This is both a testability defect and a design defect.

---

### A26-4, Severity: HIGH

**`DriverAlreadyExistException` two-arg constructor (`message, Throwable`) is never tested and never used in production.**

The single-arg constructor is exercised indirectly at `DriverService.registerDriver()` line 69, but only through manual or integration execution paths — no unit test covers this. The two-arg constructor (`DriverAlreadyExistException(String message, Throwable cause)`) is declared but has zero call sites anywhere in the codebase and has no test coverage. This constructor's behavior (cause chaining through to `RuntimeException`) is therefore entirely unverified.

**Untested paths:**
- Exception thrown with the single-arg constructor and caught/handled upstream
- Exception thrown with the two-arg constructor (dead code path)
- `getMessage()` content correctness from either constructor

---

### A26-5, Severity: HIGH

**CognitoService silently swallows all exceptions from both HTTP calls.**

In both `getUser()` (lines 60–64) and `authenticationRequest()` (lines 99–103) the catch block is `catch(Exception e)`. Upon any failure — network timeout, DNS resolution failure, HTTP 5xx, JSON deserialization error — the method calls `e.printStackTrace()` and returns an empty default-constructed response object (`new UserResponse()` or `new AuthenticationResponse()`). The caller in `ImpactDAO` receives a structurally valid but completely empty object with no indication that the call failed. No test verifies that the caller handles this degraded-response scenario. This is a silent data corruption risk on the impact alert pathway.

---

### A26-6, Severity: MEDIUM

**Null `sessionToken` from a failed `authenticationRequest()` is appended to the URL in `getUser()` without a null check.**

At `CognitoService.java` line 34, `authResponse.getSessionToken()` is assigned to `accessToken`. If `authenticationRequest()` returns an empty `AuthenticationResponse` (as it does on any failure), `getSessionToken()` returns `null`. At line 48 this null is concatenated into the URL string as the literal text `"null"`, producing a request to the Cognito API with `&accessToken=null`. This is a logic error with no null-guard, and no test exercises this path.

---

### A26-7, Severity: MEDIUM

**`BootstrapService` imports `Logger`/`LoggerFactory` but never uses them; `FlywayBean.migrate()` uses `System.out.println` instead of a logger.**

`BootstrapService.java` imports `org.slf4j.Logger` and `org.slf4j.LoggerFactory` at lines 5–6 but no logger field is declared or used. The disabled-Flyway message at line 55 uses `System.out.println`, bypassing the configured logging framework (`logback.xml` is present). No test verifies the output of the disabled code path. This is both an inconsistency and an observability gap — the message will not appear in log aggregation or monitoring systems.

---

### A26-8, Severity: MEDIUM

**`CognitoService` uses hardcoded `http://localhost` URLs rather than configurable values.**

Both `getUser()` (line 48) and `authenticationRequest()` (line 89) construct URLs using the scheme and host `"http://localhost:"`. Only the port is configurable via `${cognitoAPIPort}`. The protocol (HTTP, not HTTPS) and the host (`localhost`) are hardcoded, meaning:
- The service cannot connect to a remote Cognito proxy without a code change.
- All traffic to the Cognito API is plaintext HTTP; no test verifies or enforces TLS for this path.
- There is no test that validates the URL construction logic for correctness.

---

### A26-9, Severity: LOW

**`FlywayBean` is a non-static inner class of `BootstrapService`.**

`FlywayBean` is declared as `public class FlywayBean` (non-static) at line 40, making it implicitly hold a reference to its enclosing `BootstrapService` instance. For a Spring `@Bean`-managed object this is unnecessary and prevents `FlywayBean` from being instantiated independently for unit testing without first constructing a `BootstrapService` (which itself requires a `DataSource` and property bindings). Making `FlywayBean` a static nested class or a top-level class would improve testability.

---

### A26-10, Severity: LOW

**`DriverAlreadyExistException` has no `serialVersionUID`.**

`DriverAlreadyExistException` extends `DriverServiceException` which extends `RuntimeException`, a `Serializable` type. Neither `DriverAlreadyExistException` nor `DriverServiceException` declares a `serialVersionUID`. While not a runtime defect, any serialization of this exception (e.g., across distributed boundaries or in session storage) will use a JVM-computed UID that can change across recompilations, causing deserialization failures. No test verifies serialization/deserialization round-trips for either exception class.

---

## Summary Table

| ID | Severity | Class | Description |
|---|---|---|---|
| A26-1 | CRITICAL | BootstrapService / FlywayBean | Zero test coverage; all branches untested including `FlywayException` propagation |
| A26-2 | CRITICAL | CognitoService | Zero test coverage across both public methods and all HTTP response branches |
| A26-3 | HIGH | CognitoService | Inline `new RestTemplate()` construction blocks unit testing entirely |
| A26-4 | HIGH | DriverAlreadyExistException | Two-arg constructor is dead code; single-arg constructor has no unit test |
| A26-5 | HIGH | CognitoService | All exceptions silently swallowed; callers receive empty objects with no error signal |
| A26-6 | MEDIUM | CognitoService | Null `sessionToken` appended literally to URL when `authenticationRequest()` fails |
| A26-7 | MEDIUM | BootstrapService / FlywayBean | Unused Logger imports; disabled-path message written to `System.out` not SLF4J |
| A26-8 | MEDIUM | CognitoService | Hardcoded `http://localhost` scheme and host; URL construction logic untested |
| A26-9 | LOW | BootstrapService / FlywayBean | Non-static inner class prevents independent instantiation for unit tests |
| A26-10 | LOW | DriverAlreadyExistException | No `serialVersionUID`; no serialization test |
