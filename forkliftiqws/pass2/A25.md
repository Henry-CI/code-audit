# Audit Report A25 — Pass 2: Test Coverage
**Date:** 2026-02-27
**Agent:** A25
**Scope:** APKUpdaterService, AWSFileStorageService, AbstractFileStorageService

---

## Reading Evidence

### 1. APKUpdaterService.java
**File:** `src/main/java/com/journaldev/spring/jdbc/service/APKUpdaterService.java`
**Class:** `APKUpdaterService` (annotated `@Service`, package-private Spring bean)

| # | Member | Line | Notes |
|---|--------|------|-------|
| 1 | Field: `packageDir` | 22 | `@Value("${packageDir}")` — injected string path |
| 2 | Field: `pattern` | 25 | `Pattern.compile("(\\w*)-(\\d*\\.?\\d*?\\.?\\d*?\\.?-\\w*)\\.apk")` — filename regex |
| 3 | Method: `getAvailablePackage(String baseUrl, String pkgName, String currentVersion)` | 28 | Returns `Optional<PackageEntry>` |
| 4 | Method: `loadPackageAsResource(String pkgname, String version)` | 54 | Returns `Resource` |

**Types referenced:**
- `PackageEntry` (model, `@Builder`, `Comparable<PackageEntry>`)
- `Optional<PackageEntry>`
- `Resource`, `UrlResource` (Spring `core.io`)
- `Path`, `Paths`, `Files` (java.nio)
- `Matcher`, `Pattern` (java.util.regex)
- `Comparator`

**Exceptions thrown:**
- `APKUpdaterException("Unable to collect all available packages", e)` — catch of `IOException` in `getAvailablePackage` (line 50)
- `FileNotFoundException("Unable to find ...")` — resource does not exist branch in `loadPackageAsResource` (line 62)
- `APKUpdaterException("Unable to get resource for package ...")` — catch of `IOException` in `loadPackageAsResource` (line 66)

**Error/exit paths in `getAvailablePackage`:**
1. `IOException` from `Files.list(...)` → throws `APKUpdaterException`
2. File in directory does not match regex → lambda returns `null`, filtered out by `filter(p -> p != null ...)`
3. No file has a higher version than `currentEntry` → `Optional.empty()` returned from `max(...)`
4. File matches regex but name does not match requested package → filtered by `p.compareTo(currentEntry) > 0` (compareTo only uses major/minor/patch, not name — see A25-8)

**Error/exit paths in `loadPackageAsResource`:**
1. `resource.exists()` is false → throws `FileNotFoundException`
2. `IOException` from `UrlResource` construction → throws `APKUpdaterException`

---

### 2. AWSFileStorageService.java
**File:** `src/main/java/com/journaldev/spring/jdbc/service/AWSFileStorageService.java`
**Class:** `AWSFileStorageService` (annotated `@Service("awsFileStorage")`, `@Slf4j`, extends `AbstractFileStorageService`)

| # | Member | Line | Notes |
|---|--------|------|-------|
| 1 | Field: `cloudImagedDir` | 26 | `@Value("${cloudImagedDir}")` — S3 key path prefix |
| 2 | Field: `bucketName` | 29 | `@Value("${bucketName}")` — target S3 bucket name |
| 3 | Field: `credentials` | 31 | `static AWSCredentials` — **hardcoded access key and secret** |
| 4 | Method: `saveImage(InputStream inputStream)` | 38 | Override; calls `super.saveImage()` then `uploadObject(...)` |
| 5 | Method: `loadImageAsResource(String fileName)` | 45 | Override; stub — always returns `null` |
| 6 | Method: `connectAWSS3()` | 50 | Private; constructs `AmazonS3` client hardwired to `Regions.US_EAST_1` |
| 7 | Method: `uploadObject(String key_name, String file_path)` | 62 | Private; creates bucket if absent, uploads file with `PublicRead` ACL |

**Types referenced:**
- `AmazonS3`, `AmazonS3ClientBuilder`, `AWSCredentials`, `BasicAWSCredentials`, `AWSStaticCredentialsProvider`
- `Regions.US_EAST_1`
- `PutObjectRequest`, `CannedAccessControlList.PublicRead`
- `AmazonServiceException`
- `File`, `InputStream`
- `Resource` (Spring)

**Constants/literals:**
- Hardcoded AWS Access Key ID: `AKIA**REDACTED**` (line 32)
- Hardcoded AWS Secret Access Key: `****REDACTED****` (line 33)
- Region hardcoded: `Regions.US_EAST_1` (line 55)
- ACL hardcoded: `CannedAccessControlList.PublicRead` (line 74)

**Error/exit paths:**
1. `AmazonServiceException` from `s3client.putObject(...)` → logged via `log.error(e.getErrorMessage())` only — no re-throw, caller is not notified (line 75-77)
2. Any exception from `connectAWSS3()` → uncaught, propagates unhandled from `uploadObject`
3. `doesBucketExist(...)` or `createBucket(...)` throwing `AmazonServiceException` → uncaught, propagates unhandled

---

### 3. AbstractFileStorageService.java
**File:** `src/main/java/com/journaldev/spring/jdbc/service/AbstractFileStorageService.java`
**Class:** `AbstractFileStorageService` (package-private abstract class, `@Slf4j`, implements `FileStorageService`)

| # | Member | Line | Notes |
|---|--------|------|-------|
| 1 | Field: `uploadDir` | 26 | `@Value("${uploadDir}")` protected |
| 2 | Field: `imageDir` | 29 | `@Value("${imageDir}")` protected |
| 3 | Field: `imagePrefix` | 32 | `@Value("${imagePrefix}")` private |
| 4 | Field: `imageStorageLocation` | 34 | `protected Path` |
| 5 | Field: `targetLocation` | 36 | `protected Path` — written during `saveImage`, read by subclass |
| 6 | Field: `fileName` | 38 | `protected String` — written during `saveImage`, read by subclass |
| 7 | Field: `imageExt` | 40 | `protected String`, default `".jpg"` |
| 8 | Method: `initialize()` | 43 | `@PostConstruct`; creates upload directory via `Files.createDirectories` |
| 9 | Method: `saveImage(InputStream inputStream)` | 53 | Detects MIME, generates filename, copies stream to disk |

**Types referenced:**
- `FileStorageService` (interface: `saveImage`, `loadImageAsResource`)
- `URLConnection` (MIME sniffing)
- `MimeType`, `MimeTypeException`, `MimeTypes` (Apache Tika)
- `Files`, `Path`, `Paths`, `StandardCopyOption.REPLACE_EXISTING`
- `Util.generateRadomName()` (note: method name has typo — "Radom" instead of "Random")
- `PostConstruct` (javax.annotation)

**Error/exit paths:**
1. `initialize()`: `Exception` from `Files.createDirectories(...)` → throws `FileStorageException("Could not save the directory ...")` (line 48)
2. `saveImage()` block 1: `MimeTypeException | IOException` from content-type detection → logged as WARN, falls through to default `imageExt = ".jpg"` (line 60-62) — silently uses fallback
3. `saveImage()` block 2: `IOException` from `Files.copy(...)` → throws `FileStorageException("Could not store file ...")` (line 72)

**Exceptions thrown:**
- `FileStorageException` (extends `RuntimeException`, `serialVersionUID = 8988464861907090725L`)
- `FileNotFoundException` (extends `FileStorageService`, annotated `@ResponseStatus(HttpStatus.NOT_FOUND)`)
- `APKUpdaterException` (extends `RuntimeException`)

---

### 4. FileStorageService Interface
**File:** `src/main/java/com/journaldev/spring/jdbc/service/FileStorageService.java`

| # | Method | Notes |
|---|--------|-------|
| 1 | `saveImage(InputStream inputStream)` | Returns `String` |
| 2 | `loadImageAsResource(String fileName)` | Returns `Resource` |

---

### 5. APKUpdaterServiceTest.java
**File:** `src/test/java/com/journaldev/spring/jdbc/service/APKUpdaterServiceTest.java`
**Class:** `APKUpdaterServiceTest` (plain JUnit 4 test class, no runner annotation)

**State of tests:**
- `setUp()` method (lines 17-23): **entirely commented out** — `packageDir` is never injected
- `getAvailablePackage()` test (lines 25-36): **entirely commented out**
- `getAvailablePackageWhenAlreadyHaveLatest()` test (lines 38-43): **entirely commented out**

**Effective active test methods:** ZERO. The class compiles and is discovered by the test runner but executes no assertions and invokes no production code.

**Indirect coverage of AWSFileStorageService / AbstractFileStorageService:**
Grep of entire `src/test/java/` subtree found NO references to `AWSFileStorageService`, `AbstractFileStorageService`, `FileStorageService`, `saveImage`, `loadImageAsResource`, `uploadObject`, `connectAWSS3`, or `initialize`. These classes have zero test coverage, direct or indirect.

---

## Findings

---

### A25-1 — Severity: CRITICAL
**All APKUpdaterService tests are commented out; effective test count is zero.**

The single test class for `APKUpdaterService` (`APKUpdaterServiceTest.java`) contains a class body with no active `@Test` methods. The `@Before` setup block and both `@Test` methods (`getAvailablePackage`, `getAvailablePackageWhenAlreadyHaveLatest`) are wrapped in a block comment (`/* ... */`). The class instantiates `APKUpdaterService` at line 15 but never calls any method on it. The test runner discovers the class, runs it with zero test methods, and reports trivial success. Neither `getAvailablePackage` nor `loadPackageAsResource` is exercised by any test in the suite.

**Affected methods:**
- `APKUpdaterService.getAvailablePackage(String, String, String)` (line 28)
- `APKUpdaterService.loadPackageAsResource(String, String)` (line 54)

---

### A25-2 — Severity: CRITICAL
**AWSFileStorageService has zero test coverage — direct or indirect.**

No test file in `src/test/java/` references `AWSFileStorageService`, its parent `AbstractFileStorageService`, or any of the `FileStorageService` interface methods. The entire file-storage subsystem (`saveImage`, `loadImageAsResource`, `connectAWSS3`, `uploadObject`, `initialize`) is untested.

**Affected classes:**
- `AWSFileStorageService` (all 4 non-trivial members: `saveImage`, `loadImageAsResource`, `connectAWSS3`, `uploadObject`)
- `AbstractFileStorageService` (all 2 non-trivial members: `initialize`, `saveImage`)

---

### A25-3 — Severity: CRITICAL
**Hardcoded AWS credentials committed to source control.**

`AWSFileStorageService.java` lines 31-34 embed a static AWS Access Key ID (`AKIA**REDACTED**`) and Secret Access Key (`****REDACTED****`) directly in source code. These credentials are stored in version control history. Even if rotated, the IAM key format indicates a real credential that was once active. There is no test validating that credential loading uses environment variables or a secrets manager instead.

**Affected file:** `AWSFileStorageService.java` lines 31–34

---

### A25-4 — Severity: HIGH
**`loadPackageAsResource` IOException error path is untested and its error message is malformed.**

The catch block at line 65-67 in `APKUpdaterService.loadPackageAsResource` throws `APKUpdaterException("Unable to get resource for package " + pkgname + ", version" + version)`. The concatenation string is missing a space before `version`, producing messages like `"..., version1.0.0-local"`. No test exercises this catch block and no test validates the exception message content for either throw path (line 62 `FileNotFoundException` or line 66 `APKUpdaterException`).

**Affected method:** `APKUpdaterService.loadPackageAsResource` (line 66)

---

### A25-5 — Severity: HIGH
**`uploadObject` silently swallows `AmazonServiceException` on S3 put failure.**

In `AWSFileStorageService.uploadObject` (lines 71-77), when `s3client.putObject(...)` throws `AmazonServiceException`, the exception is caught and logged via `log.error(e.getErrorMessage())` but not re-thrown and not surfaced to the caller `saveImage`. The caller of `saveImage` therefore receives a filename as if the upload succeeded, when in fact it failed silently. No test verifies this failure path or asserts that the caller is notified of upload failures.

**Affected method:** `AWSFileStorageService.uploadObject` (lines 75-77)

---

### A25-6 — Severity: HIGH
**`loadImageAsResource` is a permanent stub returning `null`.**

`AWSFileStorageService.loadImageAsResource` (lines 45-47) unconditionally returns `null`. Any caller invoking this method will receive `null` and likely encounter a `NullPointerException` unless it performs an explicit null check. This violates the `FileStorageService` interface contract. No test documents or asserts this null-return behavior.

**Affected method:** `AWSFileStorageService.loadImageAsResource` (line 46)

---

### A25-7 — Severity: HIGH
**`APKUpdaterService.getAvailablePackage` IOException path is untested.**

The `catch (IOException e)` block at line 49-51, which wraps `Files.list(Paths.get(packageDir))` with a thrown `APKUpdaterException`, is never exercised. No test provides a non-existent or inaccessible `packageDir` to trigger this branch. The two-argument `APKUpdaterException(String, Throwable)` constructor is never called from any test.

**Affected method:** `APKUpdaterService.getAvailablePackage` (lines 49-51)

---

### A25-8 — Severity: MEDIUM
**Package-name filtering in `getAvailablePackage` relies on `compareTo` which ignores the `name` field.**

`PackageEntry.compareTo` (model line 57-68) compares only `major`, `minor`, and `patch` fields using `CompareToBuilder`. The `name` field is never included. `getAvailablePackage` filters with `p.compareTo(currentEntry) > 0`, which means a newer version of a *different* application package with a higher version number will pass the filter and be returned to the caller as if it is the correct package. No test covers a directory containing multiple packages with different names, where a newer version of the wrong package could be returned.

**Affected method:** `APKUpdaterService.getAvailablePackage` (line 47)

---

### A25-9 — Severity: MEDIUM
**`AbstractFileStorageService.saveImage` MIME detection silently falls back to `.jpg` on any error.**

When `URLConnection.guessContentTypeFromStream(inputStream)` returns `null` or throws, or when `MimeTypes.forName(contentType)` throws `MimeTypeException`, the exception is caught (lines 60-62) and a WARN is logged, but the method proceeds with `imageExt = ".jpg"`. There is no test for: (a) an input stream whose content type cannot be determined, (b) a non-image stream (e.g., a PDF or binary), or (c) a `null` content-type return. A corrupt or misidentified file will be silently stored with a `.jpg` extension.

**Affected method:** `AbstractFileStorageService.saveImage` (lines 60-62)

---

### A25-10 — Severity: MEDIUM
**`initialize()` `@PostConstruct` directory-creation failure path is untested.**

`AbstractFileStorageService.initialize()` (lines 43-49) throws `FileStorageException` if `Files.createDirectories` fails. No test triggers this path (e.g., by providing an invalid or read-only path for `uploadDir`). The exception message `"Could not save the directory where the uploaded files will be stored."` is also misleading — it says "save the directory" rather than "create the directory".

**Affected method:** `AbstractFileStorageService.initialize` (lines 47-49)

---

### A25-11 — Severity: MEDIUM
**`getAvailablePackage` returns empty `Optional` when the directory is empty — no test covers this.**

When `packageDir` contains no files, `Files.list(...)` returns an empty stream and `max(...)` returns `Optional.empty()`. While this is likely acceptable behavior, it is undocumented by any test. The commented-out test `getAvailablePackageWhenAlreadyHaveLatest` was intended to verify the already-at-latest case (same as empty result) but does not cover an actually empty directory.

**Affected method:** `APKUpdaterService.getAvailablePackage` (line 33)

---

### A25-12 — Severity: MEDIUM
**`connectAWSS3` and bucket-existence/creation paths in `uploadObject` are completely untested.**

`AWSFileStorageService.connectAWSS3()` (lines 50-56) and the `doesBucketExist` / `createBucket` branch in `uploadObject` (lines 67-70) have no test coverage. Failures in client construction (invalid credentials, network issues) or bucket creation propagate as uncaught runtime exceptions to `saveImage` callers. No mock-based test exercises the "bucket does not exist" branch.

**Affected methods:** `AWSFileStorageService.connectAWSS3` (line 50), `AWSFileStorageService.uploadObject` (lines 67-70)

---

### A25-13 — Severity: MEDIUM
**S3 upload uses a public-read ACL with no test asserting or flagging this behavior.**

`uploadObject` at line 74 sets `CannedAccessControlList.PublicRead` on every uploaded object, making all images publicly accessible on S3 by URL without authentication. No test asserts this policy is intentional, and there is no configuration switch to change the ACL. Combined with the hardcoded credentials (A25-3), this presents a significant data-exposure risk.

**Affected method:** `AWSFileStorageService.uploadObject` (line 74)

---

### A25-14 — Severity: MEDIUM
**Region is hardcoded to `US_EAST_1` with no test or configuration coverage.**

`connectAWSS3()` (line 55) hardcodes `Regions.US_EAST_1`. There is no `@Value` injection for region, no test verifying a different region can be configured, and no test confirming behavior if the target bucket is in a different region.

**Affected method:** `AWSFileStorageService.connectAWSS3` (line 55)

---

### A25-15 — Severity: LOW
**`getAvailablePackage` regex `pattern` matching edge cases are untested.**

The compiled regex `(\\w*)-(\\d*\\.?\\d*?\\.?\\d*?\\.?-\\w*)\\.apk` (line 25) is fully non-greedy and allows empty captures in both groups. Files with unusual names (e.g., `-1.0.0-local.apk`, `app-.apk`, `app-1.0.0.apk` with no env suffix) may match or not match in unexpected ways. The only tests that exercised this regex are commented out.

**Affected field:** `APKUpdaterService.pattern` (line 25)

---

### A25-16 — Severity: LOW
**`Util.generateRadomName()` typo in method name referenced in `AbstractFileStorageService`.**

`AbstractFileStorageService.saveImage` at line 65 calls `Util.generateRadomName()` — "Radom" is a misspelling of "Random". While this is a source-level name issue rather than a runtime failure, it is uncorrected and no test documents or verifies the generated filename format or randomness properties.

**Affected line:** `AbstractFileStorageService.saveImage` (line 65)

---

### A25-17 — Severity: LOW
**`targetLocation` field is shared mutable instance state in `AbstractFileStorageService`.**

`targetLocation` (line 36) is a protected instance field written by `saveImage` and read by `AWSFileStorageService.saveImage` (line 40: `uploadObject(cloudImagedDir + fileName, targetLocation.toString())`). Concurrent calls to `saveImage` on the same bean instance (Spring beans are singletons by default) can result in a race condition where `targetLocation` from one call is used in `uploadObject` of a different call. No test exercises concurrent invocations.

**Affected fields:** `AbstractFileStorageService.targetLocation` (line 36), `AbstractFileStorageService.fileName` (line 38)

---

## Summary Table

| ID | Severity | Description |
|----|----------|-------------|
| A25-1 | CRITICAL | All APKUpdaterService tests commented out — zero effective test coverage |
| A25-2 | CRITICAL | AWSFileStorageService and AbstractFileStorageService have zero test coverage |
| A25-3 | CRITICAL | AWS credentials hardcoded in source — untested configuration strategy |
| A25-4 | HIGH | `loadPackageAsResource` IOException path untested; error message has formatting defect |
| A25-5 | HIGH | `uploadObject` silently swallows AmazonServiceException; upload failures invisible to caller |
| A25-6 | HIGH | `loadImageAsResource` is a permanent null stub; violates interface contract; untested |
| A25-7 | HIGH | `getAvailablePackage` IOException (inaccessible directory) path untested |
| A25-8 | MEDIUM | Package-name not part of `compareTo`; wrong-name package can be returned; untested |
| A25-9 | MEDIUM | MIME detection silent fallback to `.jpg` on any detection error; untested |
| A25-10 | MEDIUM | `initialize()` directory creation failure path untested |
| A25-11 | MEDIUM | Empty directory (empty Optional) case untested |
| A25-12 | MEDIUM | `connectAWSS3`, bucket-not-exist, and bucket-creation paths untested |
| A25-13 | MEDIUM | Public-read ACL hardcoded on all S3 uploads; no test asserts or guards this |
| A25-14 | MEDIUM | AWS region hardcoded to US_EAST_1; not configurable; untested |
| A25-15 | LOW | Regex edge cases for filename matching untested |
| A25-16 | LOW | Typo `generateRadomName` in Util call; filename format untested |
| A25-17 | LOW | Shared mutable `targetLocation`/`fileName` fields; concurrent call race condition untested |
