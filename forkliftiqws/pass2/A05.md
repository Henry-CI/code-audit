# Audit Report A05 - Pass 2: Test Coverage
**Date:** 2026-02-27
**Agent:** A05
**Scope:** Controller layer - APKUpdaterController, CompanyController, ConfigurationController

---

## Reading Evidence

### File 1: APKUpdaterController.java
**Path:** `src/main/java/com/journaldev/spring/jdbc/controller/APKUpdaterController.java`

**Class:** `APKUpdaterController` (concrete `@Controller`, lines 20-69)

**Imports / Types Referenced:**
- `com.journaldev.spring.jdbc.model.PackageEntry`
- `com.journaldev.spring.jdbc.service.APKUpdaterService`
- `org.apache.commons.lang3.StringUtils`
- `org.springframework.core.io.Resource`
- `org.springframework.http.HttpHeaders`, `HttpStatus`, `MediaType`, `ResponseEntity`
- `javax.servlet.http.HttpServletRequest`
- `java.net.MalformedURLException`, `java.net.URL`
- Lombok `@Slf4j` (logger: `log`)

**Fields:**
- `APKUpdaterService apkUpdaterService` — `@Autowired`, line 25

**Methods:**

| Method | Visibility | Line | Return Type | Notes |
|---|---|---|---|---|
| `getURLBase(HttpServletRequest, String)` | `private` | 28 | `String` | Throws `MalformedURLException` |
| `getAvailablePackage(HttpServletRequest, String, String)` | `public` | 38 | `PackageEntry` | `@ResponseBody`, GET `/rest/apk/{pkgname}/update?version=` |
| `downloadPackage(String, String)` | `public` | 56 | `ResponseEntity<Resource>` | GET `/rest/apk/{pkgname}?version=` |

**Error / Exception Paths:**
- `MalformedURLException` caught in `getAvailablePackage` (lines 45-50): logs error, returns `null` — contains `// TODO Handle error`
- `APKUpdaterException` (unchecked) propagated from `apkUpdaterService.loadPackageAsResource()` — no catch in controller
- `FileNotFoundException` (unchecked, from service) propagated from `loadPackageAsResource()` — no catch in controller
- `NullPointerException` risk: `resource.getFilename()` at line 65 called without null guard; if service returns a non-readable resource with null filename the header value would be `null`

**Constants / Status Codes Used:**
- `HttpStatus.OK` (line 67)
- `MediaType` value: `"application/vnd.android.package-archive"` (line 64)

---

### File 2: CompanyController.java
**Path:** `src/main/java/com/journaldev/spring/jdbc/controller/CompanyController.java`

**Class:** `CompanyController` (concrete `@Controller`, extends `ConfigurationController`, lines 24-175)

**Imports / Types Referenced:**
- `com.journaldev.spring.jdbc.DAO.CompanyDAO`
- `com.journaldev.spring.jdbc.DAO.DriverDAO`
- `com.journaldev.spring.jdbc.model.*` (Company, Driver, Permissions, Results, RuntimeConfig)
- `com.journaldev.spring.jdbc.util.SendEmail`
- `org.springframework.jdbc.core.BeanPropertyRowMapper`
- `org.springframework.jdbc.core.JdbcTemplate`
- `org.springframework.http.HttpStatus`, `ResponseEntity`
- SLF4J `Logger` / `LoggerFactory`

**Fields:**
- `Logger logger` — static final, line 27
- `DriverDAO driverDAO` — `@Autowired`, line 30
- `CompanyDAO companyDAO` — `@Autowired`, line 33
- Inherited: `Configuration configuration`, `DataSource dataSource` (from `ConfigurationController`)

**Methods:**

| Method | Visibility | Line | Return Type | HTTP | URI Constant |
|---|---|---|---|---|---|
| `getCompany(Long)` | `public` | 37 | `List<Company>` | GET | `RestURIConstants.GET_COMPANY` = `/rest/company/get/{uid}` |
| `getCompanyDrivers(int)` | `public` | 44 | `List<Driver>` | GET | `RestURIConstants.GET_COMPANY_DRIVERS` = `/rest/company/owner/{uid}/drivers` |
| `searchCompany(String)` | `public` | 52 | `List<Company>` | GET | `RestURIConstants.SEARCH_COMPANY` = `/rest/company/search/{keyword}` |
| `addCompany(Permissions)` | `public` | 62 | `ResponseEntity<Permissions>` | POST | `RestURIConstants.ADD_COMPANY` = `/rest/company/add` |
| `companyAcceptWeb(String)` | `public` | 121 | `ResponseEntity<Results>` | GET | `RestURIConstants.COMPANY_ACCEPT_WEB` = `/rest/company/accept/web/{token}` |
| `companyAccept(int)` | `public` | 148 | `ResponseEntity<Results>` | PUT | `RestURIConstants.COMPANY_ACCEPT` = `/rest/company/accept/{pid}` |
| `companyDelete(int)` | `public` | 162 | `ResponseEntity<Results>` | PUT | `RestURIConstants.COMPANY_DELETE` = `/rest/company/delete/{pid}` |

**Error / Exception Paths and Branches:**
- `addCompany` — branch: `driver_id == comp_id` returns `HttpStatus.BAD_GATEWAY` (line 116)
- `addCompany` — branch: duplicate permission record (`total > 0`) returns `HttpStatus.BAD_GATEWAY` (line 112)
- `addCompany` — happy path: inserts, fetches driver name, conditionally sends email if `arrUsers.size() > 0` and email is non-null/non-empty (lines 88-107)
- `companyAcceptWeb` — branch: token not found or already enabled (`total == 0`) returns `HttpStatus.BAD_GATEWAY` with `MSGID_LOGICERRORR` / `ERRORMSG_LOGICERRORR` (lines 139-141)
- `companyAccept` — no existence check before update; always returns `HttpStatus.OK` even if `pid` does not exist (lines 154-158)
- `companyDelete` — no existence check before delete; always returns `HttpStatus.OK` even if `pid` does not exist (lines 169-173)
- No try/catch anywhere in `CompanyController`; any `DataAccessException` propagates unchecked to the container

**Constants / Status Codes Used:**
- `RuntimeConfig.MSGID_SUCCESS` = `"1"` (lines 134, 157, 172)
- `RuntimeConfig.MSGID_LOGICERRORR` = `"3"` (line 139)
- `RuntimeConfig.ERRORMSG_LOGICERRORR` = `"Result already exists."` (line 140)
- `HttpStatus.OK` (lines 109, 135, 158, 173)
- `HttpStatus.BAD_GATEWAY` (lines 112, 116, 141) — semantically inappropriate for business logic errors

**Inline SQL (raw JDBC, no parameterized DAO abstraction):**
- `addCompany` constructs and executes 5 distinct SQL statements inline (lines 68, 72, 75, 79, 84, 97)
- `companyAcceptWeb` constructs and executes 2 SQL statements inline (lines 127, 131)
- `companyAccept` executes 1 SQL statement inline (line 154)
- `companyDelete` executes 1 SQL statement inline (line 169)

---

### File 3: ConfigurationController.java
**Path:** `src/main/java/com/journaldev/spring/jdbc/controller/ConfigurationController.java`

**Class:** `ConfigurationController` (abstract `@Controller`, lines 17-26)

**Imports / Types Referenced:**
- `javax.sql.DataSource`
- `com.journaldev.spring.jdbc.util.Configuration`
- SLF4J Logger (import present but no field declared)

**Fields:**
- `Configuration configuration` — `@Autowired`, `protected`, line 20
- `DataSource dataSource` — `@Autowired`, `@Qualifier("dataSource")`, `protected`, line 23-24

**Methods:** None (no declared methods beyond implicit constructor)

**Purpose:** Shared injection base class for controllers that need `Configuration` and `DataSource` beans.

---

### Test Suite Inventory

**Test files found under `src/test/java/`:**

| Test File | Covers |
|---|---|
| `model/PackageEntryTest.java` | `PackageEntry.compareTo()` — model only |
| `service/APKUpdaterServiceTest.java` | `APKUpdaterService` — all `@Test` methods **commented out** |
| `util/DateUtilTest.java` | `DateUtil` — utility class only |

**Controller test coverage:**
- Grep for `APKUpdaterController`, `CompanyController`, `ConfigurationController` across all test sources: **0 matches**
- No Spring MockMvc, `@WebMvcTest`, `@SpringBootTest`, or integration test classes exist for any of the three audited controllers.

---

## Findings

---

### A05-1
**Severity:** CRITICAL
**Title:** Zero test coverage for all three audited controller classes

All three controllers — `APKUpdaterController`, `CompanyController`, and `ConfigurationController` — have no direct or indirect test coverage whatsoever. No unit tests, no MockMvc tests, no integration tests, and no Spring context tests reference these classes. The entire HTTP request-handling layer is unvalidated by automated tests.

**Evidence:**
- Grep across `src/test/java/` for class names returns 0 matches.
- Only 3 test files exist in the project: `PackageEntryTest`, `APKUpdaterServiceTest` (all tests commented out), and `DateUtilTest`. None touch controllers.

**Affected files:**
- `src/main/java/com/journaldev/spring/jdbc/controller/APKUpdaterController.java`
- `src/main/java/com/journaldev/spring/jdbc/controller/CompanyController.java`
- `src/main/java/com/journaldev/spring/jdbc/controller/ConfigurationController.java`

---

### A05-2
**Severity:** CRITICAL
**Title:** `APKUpdaterController.downloadPackage` propagates uncaught runtime exceptions to the container

`downloadPackage` (line 56) calls `apkUpdaterService.loadPackageAsResource()` which throws `APKUpdaterException` (unchecked) and `FileNotFoundException` (unchecked, declared as a custom exception in the service). Neither exception is caught in the controller. When a requested APK file is missing or the directory is inaccessible, the container will return a generic 500 error with no controlled response body. The `// TODO Handle error` comment on the analogous path in `getAvailablePackage` (line 48) suggests this was recognised but never resolved.

**Affected file:** `APKUpdaterController.java`, lines 56-68
**Untested path:** file-not-found scenario, I/O failure scenario for `loadPackageAsResource`

---

### A05-3
**Severity:** CRITICAL
**Title:** `APKUpdaterController.getAvailablePackage` returns `null` on `MalformedURLException` with no HTTP error signal

When a `MalformedURLException` is thrown (line 45), the controller logs and returns `null` (line 49). Spring will attempt to serialise `null` as the response body. The HTTP status code will be `200 OK`, misleading the client into believing the request succeeded. The comment `// TODO Handle error` (line 48) confirms this is a known unresolved deficiency.

**Affected file:** `APKUpdaterController.java`, lines 43-53
**Untested path:** malformed request URL path

---

### A05-4
**Severity:** HIGH
**Title:** `CompanyController.companyAccept` and `companyDelete` perform blind database mutations with no existence validation

`companyAccept` (line 148) and `companyDelete` (line 162) each execute a SQL `UPDATE` or `DELETE` against a `pid` path variable without first verifying that the record exists. Both always return `HttpStatus.OK` regardless of whether any rows were affected. Callers cannot distinguish between a successful operation and a no-op on a non-existent permission ID. There is no test covering the non-existent `pid` edge case.

**Affected file:** `CompanyController.java`, lines 148-174

---

### A05-5
**Severity:** HIGH
**Title:** `CompanyController` uses `HttpStatus.BAD_GATEWAY` (502) for business logic rejection responses

`addCompany` (lines 112, 116) and `companyAcceptWeb` (line 141) return `HttpStatus.BAD_GATEWAY` (502) for business-rule violations (duplicate association, self-association, already-accepted token). `BAD_GATEWAY` is an infrastructure-level status code indicating a proxy failure. The semantically correct code for a business rule rejection is `HttpStatus.CONFLICT` (409) or `HttpStatus.BAD_REQUEST` (400). No tests validate HTTP status semantics for any of these paths.

**Affected file:** `CompanyController.java`, lines 112, 116, 141

---

### A05-6
**Severity:** HIGH
**Title:** `CompanyController.addCompany` contains embedded raw SQL with no DAO abstraction or transaction boundary

`addCompany` (lines 61-118) constructs a new `JdbcTemplate` directly from `dataSource` (line 64) and executes five distinct SQL statements (count check, sequence fetch, insert, driver name lookup, company owner email lookup, MD5 token query) without any transaction wrapper. A failure at any step after the initial insert (e.g., the email-query at line 84 or the `SendEmail` call at line 104) will leave the database in a partially committed state. No rollback mechanism exists. No tests cover partial-failure paths.

**Affected file:** `CompanyController.java`, lines 62-118

---

### A05-7
**Severity:** HIGH
**Title:** All `APKUpdaterServiceTest` test methods are commented out; the service layer is effectively untested

`APKUpdaterServiceTest` (lines 17-44) defines two relevant tests (`getAvailablePackage` and `getAvailablePackageWhenAlreadyHaveLatest`) that are entirely wrapped in a block comment (`/* ... */`). The class compiles and runs but executes no assertions. Since `APKUpdaterController` depends directly on `APKUpdaterService`, service-level bugs are not caught before they surface through the controller layer.

**Affected file:** `src/test/java/com/journaldev/spring/jdbc/service/APKUpdaterServiceTest.java`, lines 17-44

---

### A05-8
**Severity:** HIGH
**Title:** `APKUpdaterController.downloadPackage` calls `resource.getFilename()` without a null guard

At line 65, `resource.getFilename()` is used to set the `Content-Disposition` header value. `Resource.getFilename()` can return `null` for certain `Resource` implementations. If `null` is returned, the header value becomes the string `"null"` or may trigger a `NullPointerException` depending on the HTTP library internals. No test exercises the header construction.

**Affected file:** `APKUpdaterController.java`, line 65

---

### A05-9
**Severity:** MEDIUM
**Title:** `CompanyController.addCompany` does not validate any fields of the `Permissions` request body

`addCompany` (line 62) accepts a `@RequestBody Permissions` object. No field validation (`@Valid`, `@NotNull`, null checks) is applied before the method body executes raw SQL queries using `permission.getDriver_id()` and `permission.getComp_id()` (lines 66, 69, 76). A request body with null or zero values for those fields will reach the database layer, potentially causing `DataAccessException` or inserting invalid data. The `getGsm_token()` value (line 76) is also inserted without validation. No tests cover any of these null/invalid-payload edge cases.

**Affected file:** `CompanyController.java`, lines 62-118

---

### A05-10
**Severity:** MEDIUM
**Title:** `CompanyController.searchCompany` accepts an unconstrained keyword path variable enabling excessive database load

`searchCompany` (line 52) passes the raw `{keyword}` path variable directly to `companyDAO.findAllByKeyword()`, which wraps it in `ilike '%keyword%'` on two columns. There is no length limit, no sanitisation, and no pagination. A single-character or wildcard keyword will cause a full table scan across both `company.name` and `company.email`. No tests verify boundary behaviour (empty string, very long string, SQL wildcard characters such as `%` or `_`).

**Affected file:** `CompanyController.java`, lines 52-59

---

### A05-11
**Severity:** MEDIUM
**Title:** `CompanyController.getCompany` and `getCompanyDrivers` have mismatched path variable types (`Long` vs `int`)

`getCompany` (line 37) binds `{uid}` to a `Long` parameter. `getCompanyDrivers` (line 44) binds the same `{uid}` path variable name to an `int` parameter. Using primitive `int` for a database ID that is derived from a PostgreSQL `bigint`/`bigserial` sequence creates an undetected truncation risk for IDs exceeding `Integer.MAX_VALUE` (2,147,483,647). The inconsistency itself indicates a defect that tests would normally surface. No tests exist for either endpoint.

**Affected file:** `CompanyController.java`, lines 37, 44

---

### A05-12
**Severity:** MEDIUM
**Title:** `ConfigurationController` is annotated `@Controller` on an abstract class, creating ambiguous Spring bean registration

`ConfigurationController` (line 17) is declared `abstract` and carries the `@Controller` stereotype annotation. Spring's component scan will attempt to register it as a Spring MVC controller bean. While Spring generally handles abstract `@Controller` classes without crashing (subclasses are the actual registrations), the annotation on the abstract class is misleading and non-standard. If the annotation is misunderstood, future developers may attempt to add `@RequestMapping` methods to this class expecting them to be accessible. No test validates the bean-registration behaviour.

**Affected file:** `ConfigurationController.java`, line 17

---

### A05-13
**Severity:** MEDIUM
**Title:** `CompanyController.addCompany` silently swallows email-send failures

The call to `SendEmail.sendMail()` at line 104 is made with no surrounding try/catch in `CompanyController`. `SendEmail.sendMail()` internally catches all exceptions and calls `printStackTrace()` (never returns an error signal). The caller (`addCompany`) therefore has no way to detect email delivery failure and always returns `HttpStatus.OK` regardless of whether the notification email was sent. No test validates this failure path.

**Affected file:** `CompanyController.java`, lines 103-105; `src/main/java/com/journaldev/spring/jdbc/util/SendEmail.java`, lines 32-53

---

### A05-14
**Severity:** LOW
**Title:** `APKUpdaterController.getURLBase` is `private` and never independently testable

`getURLBase` (line 28) is a private helper method responsible for constructing the base URL used by the service call. Its logic (port handling, path truncation via `StringUtils.substringBefore`) is non-trivial and can produce incorrect URLs if the request path does not contain the expected `"/{pkgName}/update"` suffix. Because it is private, it can only be exercised through `getAvailablePackage`. Since no tests exist for `getAvailablePackage`, the URL construction logic is entirely unvalidated.

**Affected file:** `APKUpdaterController.java`, lines 28-34

---

### A05-15
**Severity:** LOW
**Title:** `RuntimeConfig` hardcodes credentials and API keys as public static mutable fields; no test guards against mutation

`RuntimeConfig` (lines 13-30 of `RuntimeConfig.java`) declares API credentials (`GCMKEY`, `PASSWORD`, `API_ID`, `SMSFROM`), third-party API endpoints, and status message IDs as `public static` (non-final) mutable strings. Any code path can overwrite these values at runtime. `MSGID_LOGICERRORR = "3"` and `MSGID_CODEE_DUPLICATE_VEHICLE = "3"` share the same value, creating an ambiguous status ID that is used by `CompanyController`. No tests assert that these constants remain at their expected values or that the duplicate ID does not cause incorrect client-side interpretation.

**Affected file:** `src/main/java/com/journaldev/spring/jdbc/controller/RuntimeConfig.java`, lines 23-28; `CompanyController.java`, line 139

---

## Summary Table

| ID | Severity | Title |
|---|---|---|
| A05-1 | CRITICAL | Zero test coverage for all three audited controller classes |
| A05-2 | CRITICAL | `downloadPackage` propagates uncaught runtime exceptions |
| A05-3 | CRITICAL | `getAvailablePackage` returns `null` with HTTP 200 on `MalformedURLException` |
| A05-4 | HIGH | Blind DB mutations with no existence validation in `companyAccept` / `companyDelete` |
| A05-5 | HIGH | `HttpStatus.BAD_GATEWAY` (502) misused for business logic rejections |
| A05-6 | HIGH | `addCompany` has no transaction boundary across five SQL statements |
| A05-7 | HIGH | All `APKUpdaterServiceTest` tests are commented out |
| A05-8 | HIGH | `resource.getFilename()` called without null guard |
| A05-9 | MEDIUM | No input validation on `Permissions` request body in `addCompany` |
| A05-10 | MEDIUM | Unbounded keyword search path enables full table scan |
| A05-11 | MEDIUM | `Long` vs `int` type mismatch for `{uid}` path variable across sibling methods |
| A05-12 | MEDIUM | `@Controller` on abstract `ConfigurationController` is non-standard |
| A05-13 | MEDIUM | Email send failures are silently swallowed |
| A05-14 | LOW | Private `getURLBase` helper is non-testable and unvalidated |
| A05-15 | LOW | `RuntimeConfig` public static mutable fields with duplicate constant values |
