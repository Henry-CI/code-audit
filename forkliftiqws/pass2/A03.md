# A03 - Pass 2: Test Coverage
**Audit Date:** 2026-02-27
**Agent:** A03
**Scope:** EquipmentDAO.java, EquipmentDAOImpl.java, ImpactDAO.java

---

## Reading Evidence

### File 1: EquipmentDAO.java
`C:\Projects\cig-audit\repos\forkliftiqws\src\main\java\com\journaldev\spring\jdbc\DAO\EquipmentDAO.java`

- **Type:** `public interface EquipmentDAO`
- **Methods:**
  - `List<DriverEquipment> getEquipmentByUser(int userId)` — line 9
  - `Long getEquipmentIdByMacAddress(String macAddress)` — line 10
  - `Equipment getEquipmentByMacAddress(String macAddress)` — line 11
- **Imported types:** `DriverEquipment`, `Equipment`, `java.util.List`

---

### File 2: EquipmentDAOImpl.java
`C:\Projects\cig-audit\repos\forkliftiqws\src\main\java\com\journaldev\spring\jdbc\DAO\EquipmentDAOImpl.java`

- **Type:** `@Component("equipmentDAO") public class EquipmentDAOImpl extends JdbcDaoSupport implements EquipmentDAO`
- **Fields / Constants:**
  - `private static final Logger logger` — line 20 (SLF4J)
  - `private static final String QUERY_DRIVER_EQUIPMENT` — lines 22–32 (parameterized query, two bind params: systemImageURL, driver_id)
  - `private static final String QUERY_EQUIPMENT_ID_BY_MAC_ADDRESS` — line 34
  - `private static final String QUERY_EQUIPMENT_BY_MAC_ADDRESS` — line 36
  - `@Autowired private Configuration configuration` — line 39
- **Methods:**
  - `setDbDataSource(DataSource dataSource)` — line 43 (Spring lifecycle setter, @Qualifier("dataSource"))
  - `getEquipmentByUser(int uid)` — line 47; logs uid; calls `getJdbcTemplate().query(...)` with `BeanPropertyRowMapper<>(DriverEquipment.class)` and `configuration.getSystemImageURL()`
  - `getEquipmentIdByMacAddress(String macAddress)` — line 53; `queryForObject(...)` returning `Long.class`; uses deprecated `Object[]` API
  - `getEquipmentByMacAddress(String macAddress)` — line 58; `queryForObject(...)` returning `BeanPropertyRowMapper.newInstance(Equipment.class)`; uses deprecated `Object[]` API
- **Error types that can propagate (unhandled in this class):**
  - `EmptyResultDataAccessException` (Spring) — when mac address matches zero rows; thrown by `queryForObject`
  - `IncorrectResultSizeDataAccessException` — when mac address matches more than one active row
  - `DataAccessException` (general) — JDBC failures
- **Deprecation:** `Object[]` parameter form of `queryForObject` is deprecated since Spring 5.3

---

### File 3: ImpactDAO.java
`C:\Projects\cig-audit\repos\forkliftiqws\src\main\java\com\journaldev\spring\jdbc\DAO\ImpactDAO.java`

- **Type:** `@Repository public class ImpactDAO extends JdbcDaoSupport`
- **Fields / Constants:**
  - `@Autowired private Configuration configuration` — line 26
  - `@Autowired private CognitoService cognitoService` — line 35 (implicit logger from JdbcDaoSupport; also uses `logger` at lines 75, 77 — note: no explicit `logger` field declared in this class; reference is invalid — see finding A03-9)
  - `private static final String QUERY_FOR_EXISTING_IMPACT` — line 52
  - `private static final String QUERY_FOR_IMPACT_NOTIFICATIONS` — lines 57–63
- **Methods:**
  - `setDbDataSource(DataSource dataSource)` — line 30 (Spring lifecycle setter)
  - `save(Long equipmentId, Impact impact) throws SQLException` — line 37
    - Guard: `if (impactValue < 80000) return;` — line 39 (hard-coded threshold, silent discard)
    - `getJdbcTemplate().update(INSERT_SQL, ...)` — line 41
    - Error: throws `new SQLException(...)` if `rowUpdated == 0` — line 47
  - `isImpactRecorded(final Impact impact)` — line 53; `queryForObject(...)` with `Long.class`; uses deprecated `Object[]` API
  - `sendImpactNotification(Equipment equipment, Impact impact) throws SQLException` — line 64
    - Calls `cognitoService.getUser(notification.getEmail())` — line 66
    - Branch: `subscription_name.equalsIgnoreCase("Red Impact Alert")` — line 67; calls `SendEmail.sendMail(...)`
    - Branch: `subscription_name.equalsIgnoreCase("Red Impact SMS")` — line 79; checks `phoneNumber != null && !phoneNumber.equalsIgnoreCase("")`; creates `new SendMessage()` and calls `sendMessage.init(...)`
- **Error types that can propagate (unhandled in this method):**
  - `DataAccessException` from `getJdbcTemplate().update(...)` or `query(...)`
  - Any `RuntimeException` thrown by `cognitoService.getUser(...)`, `SendEmail.sendMail(...)`, or `SendMessage.init(...)` — these propagate unchecked through the `forEach` lambda and up to `ImpactController.saveImpactData`
- **Hard-coded magic number:** `80000` (impact threshold in `save`) — line 39

---

## Test Coverage Search Results

**Test directory searched:** `src/test/java/`

**Test files found (total 3):**
1. `PackageEntryTest.java` — tests `PackageEntry.compareTo()` only
2. `APKUpdaterServiceTest.java` — all test methods commented out; effectively zero executed tests
3. `DateUtilTest.java` — tests `DateUtil.parseDateIso` and `DateUtil.parseDateTimeIso` only

**Grep results for `EquipmentDAO`, `EquipmentDAOImpl` in test tree:** No matches found.
**Grep results for `ImpactDAO` in test tree:** No matches found.
**Grep results for `equipment`, `Equipment`, `impact`, `Impact`, `macAddress`, `mac_address`, `save`, `isImpact`, `sendImpact` in test tree:** No matches found.

**Conclusion:** Zero direct or indirect test coverage exists for any of the three source files under audit.

---

## Findings

### A03-1 — Severity: CRITICAL
**No test coverage for EquipmentDAOImpl or EquipmentDAO interface**

No test class, mock, or integration test references `EquipmentDAOImpl` or `EquipmentDAO` anywhere under `src/test/java/`. All three interface methods (`getEquipmentByUser`, `getEquipmentIdByMacAddress`, `getEquipmentByMacAddress`) are entirely untested. These methods are live production query paths called directly by `ImpactController.saveImpactData` and `EquipmentController`.

**Affected methods:**
- `EquipmentDAOImpl.getEquipmentByUser(int uid)` — line 47
- `EquipmentDAOImpl.getEquipmentIdByMacAddress(String macAddress)` — line 53
- `EquipmentDAOImpl.getEquipmentByMacAddress(String macAddress)` — line 58

---

### A03-2 — Severity: CRITICAL
**No test coverage for ImpactDAO**

No test class, mock, or integration test references `ImpactDAO` anywhere under `src/test/java/`. All three public methods (`save`, `isImpactRecorded`, `sendImpactNotification`) are entirely untested. These methods constitute the core business logic of the impact event recording and alerting pipeline.

**Affected methods:**
- `ImpactDAO.save(Long equipmentId, Impact impact)` — line 37
- `ImpactDAO.isImpactRecorded(final Impact impact)` — line 53
- `ImpactDAO.sendImpactNotification(Equipment equipment, Impact impact)` — line 64

---

### A03-3 — Severity: HIGH
**Unhandled EmptyResultDataAccessException in getEquipmentByMacAddress and getEquipmentIdByMacAddress**

Both `getEquipmentByMacAddress` (line 58) and `getEquipmentIdByMacAddress` (line 53) call `queryForObject(...)`. Spring's `queryForObject` throws `EmptyResultDataAccessException` when no row matches the given MAC address, and throws `IncorrectResultSizeDataAccessException` when more than one active row is found. Neither exception is caught within `EquipmentDAOImpl`. The caller (`ImpactController.saveImpactData`) only catches `IncorrectResultSizeDataAccessException` (line 181) and `IllegalArgumentException` (line 187); an `EmptyResultDataAccessException` for `getEquipmentIdByMacAddress` (which is not called in the controller but is still a public interface method) would be entirely unhandled at any call site.

There is no test verifying the behavior when a MAC address does not exist in the database.

---

### A03-4 — Severity: HIGH
**Untested hard-coded impact threshold guard in ImpactDAO.save**

`ImpactDAO.save` silently discards any impact event where `impact_value < 80000` (line 39) with a bare `return` and no logging. This silent discard is:
- Not documented in the interface contract
- Not tested for the boundary value (exactly 80000 should be saved; 79999 should be silently dropped)
- Not tested for the zero-value case
- Not tested for negative impact_value inputs

The value `80000` is a hard-coded magic number with no named constant, comment, or configuration property explaining its origin or meaning.

---

### A03-5 — Severity: HIGH
**Untested rowUpdated == 0 error path in ImpactDAO.save**

`ImpactDAO.save` throws a `new SQLException(...)` if the INSERT returns `rowUpdated == 0` (line 46–48). No test exercises this path. Because `save` is called from a `forEach` lambda in `ImpactController`, this `SQLException` must be caught and rethrown as an `IllegalArgumentException` (controller line 172), but the error message composition (`impact.getMac_address()` and `impact.getImpact_time()`) is also never validated. A null `impact_time` or `mac_address` at this point would cause a secondary failure with a misleading message.

---

### A03-6 — Severity: HIGH
**Untested dual-branch logic in ImpactDAO.sendImpactNotification**

`sendImpactNotification` contains two independent subscription-name branches:
1. `"Red Impact Alert"` — triggers email (line 67–78)
2. `"Red Impact SMS"` — triggers SMS (line 79–90)

No test covers either branch. Missing test scenarios include:
- A notification with subscription_name `"Red Impact Alert"` results in exactly one email being sent
- A notification with subscription_name `"Red Impact SMS"` and a valid non-empty phone number results in SMS dispatch
- A notification with subscription_name `"Red Impact SMS"` and a null phone number does NOT attempt SMS dispatch
- A notification with an unrecognized subscription_name is silently ignored (neither branch executes)
- Multiple notifications for the same impact event (one email, one SMS) are each processed independently

---

### A03-7 — Severity: HIGH
**CognitoService failure in sendImpactNotification silently swallows notifications**

`sendImpactNotification` calls `cognitoService.getUser(notification.getEmail())` (line 66) and immediately uses the returned `UserResponse` to build email/SMS content without any null check. If `CognitoService.getUser` fails (catches its own exception internally and returns an empty `UserResponse`), then `userResponse.getName()`, `userResponse.getLastname()`, `userResponse.getEmail()`, and `userResponse.getPhoneNumber()` will all be null, causing a `NullPointerException` in the string concatenation at line 68 or line 83. This exception propagates unchecked through the `forEach` lambda and terminates processing of all remaining notifications in the list. No test verifies this failure mode.

---

### A03-8 — Severity: MEDIUM
**getEquipmentByUser does not handle empty result list**

`getEquipmentByUser` (line 47) returns a `List<DriverEquipment>` via `query(...)`, which returns an empty list (not null) when no rows match. No test verifies this behavior. More importantly, no test verifies the COALESCE and CASE expression in `QUERY_DRIVER_EQUIPMENT` that converts null `serial_no`, `mac_address`, and `url` columns: a misconfigured `systemImageURL` (empty or null) returned by `configuration.getSystemImageURL()` would produce malformed URL values in every row, but there is no guard or test for this.

---

### A03-9 — Severity: MEDIUM
**Undeclared logger field referenced in ImpactDAO.sendImpactNotification**

`ImpactDAO.java` references `logger.info(...)` at lines 75 and 77 inside `sendImpactNotification`, but the class declares no `private static final Logger logger` field. `JdbcDaoSupport` does not expose a public `logger` field. The class is annotated with neither `@Slf4j` nor any equivalent. This code will fail to compile unless a `logger` variable is in scope via inheritance or an implicit import not visible in this file. No test would catch a compilation failure of this method in isolation. This should be verified as a latent compile-time defect.

---

### A03-10 — Severity: MEDIUM
**Deprecated Object[] API used in three queryForObject calls with no regression tests**

`EquipmentDAOImpl.getEquipmentIdByMacAddress` (line 54), `EquipmentDAOImpl.getEquipmentByMacAddress` (line 59), and `ImpactDAO.isImpactRecorded` (line 54) all use the `queryForObject(String sql, Object[] args, ...)` overload, which is deprecated as of Spring 5.3. Migration to the varargs form `queryForObject(String sql, Class/RowMapper, Object... args)` is required for Spring 6.x compatibility. Because there are no tests, a Spring version upgrade could silently break these query methods without any test failure to flag the regression.

---

### A03-11 — Severity: MEDIUM
**isImpactRecorded does not guard against null impact_time**

`ImpactDAO.isImpactRecorded` (line 54) passes `DateUtil.parseDateTimeIso(impact.getImpact_time())` as a query parameter. If `impact.getImpact_time()` is null, `DateUtil.parseDateTimeIso(null)` returns null (as confirmed by `DateUtilTest`). A null timestamp bind parameter in the `WHERE i.impact_time = ?` clause will cause the query to return zero matches regardless of actual database state (SQL NULL comparison semantics), meaning a duplicate impact event with a null timestamp will never be detected as a duplicate and will proceed to `save(...)`. No test covers this path.

---

### A03-12 — Severity: LOW
**getEquipmentIdByMacAddress is defined in the interface but never called in production code**

`EquipmentDAO.getEquipmentIdByMacAddress` (interface line 10, implemented at `EquipmentDAOImpl` line 53) is not invoked anywhere in the production codebase. The controller (`ImpactController`) uses `getEquipmentByMacAddress` to retrieve the full `Equipment` object and then calls `equipment.getId()` directly, making this method redundant. There are no tests for it. Dead code paths create maintenance burden and untested surface area without benefit.

---

### A03-13 — Severity: LOW
**Configuration.getSystemImageURL() not validated before use in query binding**

`EquipmentDAOImpl.getEquipmentByUser` (line 49) passes `configuration.getSystemImageURL()` as the first positional parameter to the SQL query. The `Configuration` class provides this value directly from a Spring `@Value("${systemImageURL}")` property. If this property is missing or blank in a deployment environment, the CASE expression in `QUERY_DRIVER_EQUIPMENT` will produce empty or malformed URL strings for every row. There is no null/empty guard in the DAO, and no test validates behavior under a missing or empty `systemImageURL` property.

---

## Summary Table

| ID     | Severity | Subject                                                               |
|--------|----------|-----------------------------------------------------------------------|
| A03-1  | CRITICAL | Zero test coverage for EquipmentDAO / EquipmentDAOImpl                |
| A03-2  | CRITICAL | Zero test coverage for ImpactDAO                                      |
| A03-3  | HIGH     | EmptyResultDataAccessException unhandled and untested                 |
| A03-4  | HIGH     | Hard-coded 80000 threshold guard silently discards events, untested   |
| A03-5  | HIGH     | rowUpdated == 0 SQLException path in save() untested                  |
| A03-6  | HIGH     | Dual notification branch logic in sendImpactNotification untested     |
| A03-7  | HIGH     | NPE on CognitoService failure inside sendImpactNotification untested  |
| A03-8  | MEDIUM   | Empty list return and null systemImageURL not tested in getEquipmentByUser |
| A03-9  | MEDIUM   | Undeclared logger reference in ImpactDAO (possible compile defect)    |
| A03-10 | MEDIUM   | Deprecated Object[] queryForObject API, no regression tests           |
| A03-11 | MEDIUM   | Null impact_time bypasses duplicate detection in isImpactRecorded     |
| A03-12 | LOW      | getEquipmentIdByMacAddress is dead code, untested                     |
| A03-13 | LOW      | systemImageURL not validated before query binding                     |
